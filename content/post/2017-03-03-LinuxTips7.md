+++
date = "2017-03-03T11:14:34+08:00"
categories = ["Linux"]
keywords = ["Linux"]
description = "Linux tips series 7"
title = "Linux Tips(7)"

+++
### 1. CloudStack Issue
On ubuntu1404/1604, the template should enable HVM.    
Its partition size should less than the primary storage size.    
Password reset issue: Ubuntu1604, failed.    

Ubuntu14.04 startup too slow, because of ntp, remove it `sudo update-rc.d -f ntp remove
`

### 2. Ubuntu16.04 cloudstack-pass issue
The reset-password script is located as
`/etc/init.d/cloud-set-guest-password`, then we could do following
configurations:    

Remove the services via:    

```
# update-rc.d -f cloud-set-guest-password remove
# cp /etc/init.d/cloud-setup-guest-password /usr/bin/
# chmod 777 /usr/bin/cloud-setup-guest-password
```
Before because you set `update-rc.d cloud-set-guest-password defaults 98`, so
first you should remove it.    

Then Create a systemd service as `/lib/systemd/system/cloudpassword.service`:    

```
[Unit]
Description=cloudpass container

[Service]
Type=idle
Restart=always
ExecStart=/usr/bin/cloud-set-guest-password
ExecStop=/usr/bin/echo hello

[Install]
WantedBy=multi-user.target

```
Enable the service via:    

```
# systemctl enable cloudpassword
```
After the network is online:    

```
# systemctl enable systemd-networkd-wait-online.service
```
The steps could refers to another article.    

### 3. XenServer Timezone
Switch to UTC time:    

```
# cp /usr/share/zoneinfo/UTC /etc/localtime
```

### 4. Gitbook serve ports
Listening on other ports:    

```
$ gitbook --port 14001 serve
```

### 5. Quickstart For ShadowSocks
Install and configuration steps are listed as following(Ubuntu16.04):    

```
# apt-get install pip
# pip install --upgrade pip
# pip install shadowsocks
# touch /etc/shadowsocks.json
{
"server":"1xx.xxx.xxx.xxx",
"server_port":19175,
"local_address":"127.0.0.1",
"local_port":1080,
"password":"XXXXXXXXXXXXXXXXXXXXXXx",
"timeout":300,
"method":"aes-256-cfb",
"fast_open":false
}
# vim /etc/rc.local
ssserver -c /etc/shadowsocks.json -d start
```
Now you could continue to configure your shadowsocks client side. 

### 6. MariaDB In Docker
Connect to existing `docker-composed` mariadb instance via following command:     

```
sudo docker run -it -v /var/download/sbt/lili:/var/lib/mysql --link mariadb:mymariadb --net lilimarleen_default mariadb:latest /bin/bash
root@5d7eadc81b9e:/# mysql -h172.18.0.3 -P3306 -uroot -pexample
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 35
Server version: 10.1.20-MariaDB-1~jessie mariadb.org binary distribution

Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> \q
Bye
```
`-v` is for using local volume for restoring aims.     
`--link` is for linking to existing instance.    
`-net` could be get via `docker net list`.    

### 7. cdn speedup
For speed-up my blog, I changed the fonts/css from the template's default
location to `http://www.bootcdn.cn/?`, this cdn's speed is pretty good, the
speed has been greatly improved.     

### 8. git diff
First use `git log` for getting all of the commit history, then you could get
the md5 for each commitment, `git diff md51 md52` you could easily get the
differences.   

### 9. qemu issue
When meeting `guest has not initialize the display (yet)`, do following:    

```
$ sudo qemu-system-x86_64 -net nic -net user,hostfwd=tcp::2222-:22 -hda ./test.qcow2 -boot d -cdrom /mnt/CentOS-7-x86_64-Everything-1611.iso -m 2048 --enable-kvm -vga virtio
```
`-vga virtio` solves this issue.    

### 10. bashrc execution
Run `bashrc` at ArchLinux:    

```
$ vim ~/.bash_profile
if [ -f ~/.bashrc ]; then
  . ~/.bashrc
fi
$ vim ~/.bashrc
```
Then all of the items in `.bashrc` could be executed.    

### 11. Shared bash history
Add following lines in to `~/.bashrc`:    

```
HISTSIZE=9000
HISTFILESIZE=$HISTSIZE
HISTCONTROL=ignorespace:ignoredups

history() {
  _bash_history_sync
  builtin history "$@"
}

_bash_history_sync() {
  builtin history -a         #1
  HISTFILESIZE=$HISTSIZE     #2
  builtin history -c         #3
  builtin history -r         #4
}

PROMPT_COMMAND=_bash_history_sync
```
### 12. ArchLinux virtual network start failed
Issue:    

```
when I start a virtual network named 'default' (created by libvirt), it occur that:
"Error starting network 'default': internal error: Failed to initialize a valid firewall backend".
```
Solution:    

```
$ sudo pacman -S  ebtables dnsmasq
$ sudo systemctl restart libvirtd
```
then you could get your libvirtd networking work properly.    

### 13. Network Manager Configuration
[https://fedoraproject.org/wiki/Networking/Bridging](https://fedoraproject.org/wiki/Networking/Bridging)

### 14. Enable vncserver in firewalld
Manually enable the vnc-server service, then you could use vncviewer for
connecting the vnc server in ArchLinux:    

```
# firewall-cmd --zone=public --add-service=vnc-server
```
Related commands:    

List services:    

```
# firewall-cmd --zone=public --list-services
```
Get all of the listed services:    

```
# firewall-cmd --get-services
```
Get all of the zones:    

```
# firewall-cmd --get-active-zones
# firewall-cmd --get-zones
# firewall-cmd --get-default-zone
```

### 15. Execute mysql command
Execute like following:    

```
mysql -u $user -p$passsword -Bse "command1;command2;....;commandn"
```

### 16. Generate the md5 encrypted passwd
Generate md5 encrypted passwd using passlib:    

```
$ sudo pip2 install passlib
$ python2 -c "from passlib.hash import sha512_crypt; import getpass; print sha512_crypt.encrypt(getpass.getpass())"
```

### 17. Quickly setup nginx
In archlinux, do following:    

```
$ sudo pacman -S nginx
$ sudo vim /etc/nginx/nginx.conf
        location / {
            root   /media/sdb;
            index  index.html index.htm;
	    autoindex on;
        }
$ sudo systemctl enable nginx
$ sudo systemctl start nginx
```
Then you could see the nginx running on your server.    

### 18. minikube quickstart on archlinux
Install and running minikube via:    

```
$ yaourt minikube
$ wget https://github.com/dhiltgen/docker-machine-kvm/releases/download/v0.7.0/docker-machine-driver-kvm
$ sudo mv docker-machine-driver-kvm /usr/local/bin
$ sudo chmod 777 /usr/local/bin/*
$ sudo minikube start --vm-driver kvm
$ curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.5.3/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/
```
Then  you could begin using minikube.    

### 19. Golang building
When using hugo for building, the travis-ci complains:    

```
enc.SetIndent undefined
```
Solved via edit the `.travis.yml` file    

```
go:
-    - 1.6
+    - 1.7
```
Dependency on golang 1.7 solves the problem.    
### 20. Auto start default gw
Start the default network for virsh via:    

```
$ sudo virsh net-start default
```

### 21. ArchLinux fonts
Install fonts via:    

```
$ sudo  pacman -S adobe-source-han-sans-cn-fonts adobe-source-han-sans-tw-fonts
```
And mac fonts via:    

```
$ yaourt ttf-mac-fonts
```

### 22. Detect Windows
Detect Windows via:    

```
$ sudo apt-get install os-prober
$ sudo os-prober
$ sudo update-grub
```

### 23. Upgrade Shadowsocks
UPgrade the shadowsocks, so you could get more powerful tools..    

```
$  pip install --upgrade pi
$ sudo pip install --upgrade shadowsocks
```

### 24. vagrant ssh
The configuration of vagrant ssh could be viewd via:    

```
$ vagrant ssh-config
```

### 25. k8s iptables issue
Add this service named `iptableslast.service`, enable and start the service,
then system will run iptables once for setup the rules.         

```
[Unit]
Description=iptables last rule

[Service]
Type=idle
Restart=on-failure
ExecStart=/sbin/iptables -P FORWARD ACCEPT
ExecStop=/usr/bin/echo hello

[Install]
WantedBy=multi-user.target

```

### 26. Install vagrant plugins(specified version)
Specified the version of plugins:   

```
vagrant plugin install --plugin-version  0.0.37 vagrant-libvirt
```

### 27. nested kvm in CentOS7
Enable it via following commands:    

```
[root@dlp ~]# vi /etc/modprobe.d/kvm-nested.conf
# create new
options kvm_intel nested=1
[root@dlp ~]# modprobe -r kvm_intel # unload
[root@dlp ~]# modprobe kvm_intel # reload again
[root@dlp ~]# cat /sys/module/kvm_intel/parameters/nested 
Y# just enabled
```
