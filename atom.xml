<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Dash]]></title>
  <link href="http://purplepalmdash.github.io/atom.xml" rel="self"/>
  <link href="http://purplepalmdash.github.io/"/>
  <updated>2015-05-26T21:48:31+08:00</updated>
  <id>http://purplepalmdash.github.io/</id>
  <author>
    <name><![CDATA[Dash]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Chef Setup]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/26/chef-setup/"/>
    <updated>2015-05-26T16:17:14+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/26/chef-setup</id>
    <content type="html"><![CDATA[<p>For automatically deploying OpenStack, I use Chef for deployment, following records the steps for setting up the whole environment.</p>

<h3>Machine Preparation</h3>

<p>Chef Server: 2-Core, 3G Memory, IP address: xxx.xxx.10.211, Ubuntu14.04.  <br/>
Chef Workstation: 4-Core, 8G Memory, a physical machine, IP address: xxx.xxx.0.119, Ubuntu14.04.</p>

<h3>Install Server</h3>

<p>Install the chef-server package, which downloaded from chef.io website, after installation, simply reconfigure it, this finishes the installation and configuration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo dpkg -i chef-server-core_12.0.8-1_amd64.deb
</span><span class='line'>$ sudo chef-server-ctl reconfigure</span></code></pre></td></tr></table></div></figure>


<p>Configure the permit file, also create the user and organization for the chef:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># sudo chef-server-ctl user-crate YourName FirstName LastName Email PassWord --filename YourPermitFileName
</span><span class='line'>$ sudo chef-server-ctl user-create youname YYYXXX Man xxxxxxx@163.com YOURPASSWORD --filename ~/youname.pem
</span><span class='line'># sudo chef-server-ctl org-create YourOrgName Your Company Name  --association_user YourUser --filename  YourOrgnizationPermitFile
</span><span class='line'>$ sudo chef-server-ctl org-create youname YYYXXX Software, Inc. --association_user youname --filename ~/youname_org.pem</span></code></pre></td></tr></table></div></figure>


<p>Install opscode-manager and reconfigure it via following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo dpkg -i opscode-manage_1.13.0-1_amd64.deb 
</span><span class='line'>$ sudo opscode-manage-ctl reconfigure</span></code></pre></td></tr></table></div></figure>


<p>Now visit the webiste to see the Chef Server UI.</p>

<p><a href="https://YourURL">https://YourURL</a></p>

<p><img src="http://purplepalmdash.github.io/images/2015_05_26_16_44_58_610x297.jpg" alt="/images/2015_05_26_16_44_58_610x297.jpg" /></p>

<h3>Chef Workstation</h3>

<p>I use the physical machine for Chef Workstation.</p>

<p>Install it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo dpkg -i chef_12.3.0-1_amd64.deb</span></code></pre></td></tr></table></div></figure>


<p>Fetch back the chef repository from github, configure it and add the ignore directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/opscode/chef-repo.git
</span><span class='line'>$ cd chef-repo 
</span><span class='line'>$ mkdir .chef
</span><span class='line'>$ echo ".chef"&gt;&gt;~/chef-repo/.gitignore
</span><span class='line'>$ git add .
</span><span class='line'>$ git commit -m "Exclude the ./.chef directory from version control"
</span><span class='line'>[master 64515ff] Exclude the ./.chef directory from version control
</span><span class='line'> 1 file changed, 1 insertion(+)</span></code></pre></td></tr></table></div></figure>


<p>Install the chefdk, and verify the chef, you should see all of the components OK, then you could continue for next step:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo dpkg -i chefdk_0.6.0-1_amd64.deb 
</span><span class='line'>$ chef verify</span></code></pre></td></tr></table></div></figure>


<p>Transfer all of the pem file from the ChefServer to ChefWorkstation, and put them under the folder of ~/chef-repo/.chef:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ scp xxx@xxxxx:/home/xxx/*.pem xxxx@ChefWorkstation:/home/xxxx/chef-repo/.chef</span></code></pre></td></tr></table></div></figure>


<p>Add following item under the Workstation&rsquo;s configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/hosts
</span><span class='line'>XXX.xxx.xxx.xxx  ChefServer</span></code></pre></td></tr></table></div></figure>


<p>Now configure the knife.rb and let your authentification be verified.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim ~/chef-repo/.chef/knife.rb
</span><span class='line'>current_dir = File.dirname(__FILE__)
</span><span class='line'>log_level                :info
</span><span class='line'>log_location             STDOUT
</span><span class='line'>node_name                "xxxxxxxxx"
</span><span class='line'>client_key               "#{current_dir}/xxxxxxxxx.pem"
</span><span class='line'>validation_client_name   "xxxxxxxxx_org"
</span><span class='line'>validation_key           "#{current_dir}/xxxxxxxxx_org.pem"
</span><span class='line'>chef_server_url          "https://ChefServer/organizations/xxxxxxxxx"
</span><span class='line'>syntax_check_cache_path  "#{ENV['HOME']}/.chef/syntaxcache"
</span><span class='line'>cookbook_path            ["#{current_dir}/../cookbooks"]
</span><span class='line'>$ knife ssl fetch
</span><span class='line'>WARNING: Certificates from ChefServer will be fetched and placed in your trusted_cert
</span><span class='line'>directory (/home/dash/chef-repo/.chef/trusted_certs).
</span><span class='line'>
</span><span class='line'>Knife has no means to verify these are the correct certificates. You should
</span><span class='line'>verify the authenticity of these certificates after downloading.
</span><span class='line'>
</span><span class='line'>Adding certificate for ChefServer in /home/xxxx/chef-repo/.chef/trusted_certs/ChefServer.crt
</span><span class='line'>$ knife ssl check
</span><span class='line'>Connecting to host ChefServer:443
</span><span class='line'>Successfully verified certificates from `ChefServer'</span></code></pre></td></tr></table></div></figure>


<p>Check how many clients has been added into the ChefServer, currently only one,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ knife client list
</span><span class='line'>xxxxxx-validator</span></code></pre></td></tr></table></div></figure>


<h3>Added Nodes</h3>

<p>In Client1, Install the</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo dpkg -i chef_12.3.0-1_amd64.deb </span></code></pre></td></tr></table></div></figure>


<p>Add the pem files to every nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># knife bootstrap Client1 -x xxxxxx -P XXXXXXXXXXXXX --sudo</span></code></pre></td></tr></table></div></figure>


<p>If above steps fail, you should manually specify the ssl verification.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># scp Server/xxx.pem /home/xxxxx
</span><span class='line'># cp /home/xxxx/xxx.pem /etc/chef/validation.pem
</span><span class='line'># sudo chef-client -l debug -S https://ChefServer/organizations/xxxxx -K /etc/chef/validation.pem
</span><span class='line'>##### OR
</span><span class='line'>#  sudo chef-client -l debug -S https://ChefServer/organizations/xxxxx  -K /home/xxxx/xxxxx.pem</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Bootstrap again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># knife bootstrap Client1  -N ChefClient1 -x xxxxx -P xxxxxx --sudo --use-sudo-password</span></code></pre></td></tr></table></div></figure>


<p>After bootstrap success, list all of the client:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@ChefWorkstation:~/chef-repo# knife client list
</span><span class='line'>ChefClient1                                                                                                                                
</span><span class='line'>xxxx-validator </span></code></pre></td></tr></table></div></figure>


<h3>Using Cook</h3>

<p>Create the Cookbook named <code>nginx</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@ChefWorkstation:~# cd chef-repo/
</span><span class='line'>root@ChefWorkstation:~/chef-repo# ls
</span><span class='line'>chefignore  cookbooks  data_bags  environments  LICENSE  README.md  roles
</span><span class='line'>root@ChefWorkstation:~/chef-repo# knife cookbook create nginx
</span><span class='line'>oot@ChefWorkstation:~/chef-repo/cookbooks/nginx# ls
</span><span class='line'>attributes  CHANGELOG.md  definitions  files  libraries  metadata.rb  providers  README.md  recipes  resources  templates</span></code></pre></td></tr></table></div></figure>


<p>Edit the cookbook:</p>

<p>Enable the installation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim recipes/default.rb
</span><span class='line'>package 'nginx' do
</span><span class='line'>  action :install
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Enable check the status:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service 'nginx' do
</span><span class='line'>  action [ :enable, :start ]
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Change the index.html file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cookbook_file "/usr/share/nginx/html/index.html" do
</span><span class='line'>  source "index.html"
</span><span class='line'>  mode "0644"
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Prepare the default index.html file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/chef-repo/cookbooks/nginx/files/default
</span><span class='line'>$ vim index.html
</span><span class='line'>&lt;html&gt;
</span><span class='line'>  &lt;head&gt;
</span><span class='line'>    &lt;title&gt;Hello there&lt;/title&gt;
</span><span class='line'>  &lt;/head&gt;
</span><span class='line'>  &lt;body&gt;
</span><span class='line'>    &lt;h1&gt;This is a test&lt;/h1&gt;
</span><span class='line'>    &lt;p&gt;Please work!&lt;/p&gt;
</span><span class='line'>  &lt;/body&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<p>Since the nginx need apt-get to achive the latest status, add another package named apt:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>knife cookbook create apt</span></code></pre></td></tr></table></div></figure>


<p>Edit the default rb file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim ~/chef-repo/cookbooks/apt/recipes/default.rb
</span><span class='line'>execute "apt-get update" do
</span><span class='line'>  command "apt-get update"
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Change the default rb file of the nginx:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+++ include_recipe "apt"
</span><span class='line'>
</span><span class='line'>package 'nginx' do
</span><span class='line'>  action :install
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Also add it to the metadata.rb file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim ~/chef-repo/cookbooks/nginx/metadata.rb
</span><span class='line'>
</span><span class='line'>long_description IO.read(File.join(File.dirname(__FILE__), 'README.md'))
</span><span class='line'>version          '0.1.0'
</span><span class='line'>
</span><span class='line'>+++  depends "apt"</span></code></pre></td></tr></table></div></figure>


<p>Add Cookbook to your nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>knife cookbook upload apt
</span><span class='line'>knife cookbook upload nginx</span></code></pre></td></tr></table></div></figure>


<p>Or</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>knife cookbook upload -a</span></code></pre></td></tr></table></div></figure>


<p>Edit the specified node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>knife node edit name_of_node
</span><span class='line'>
</span><span class='line'>{
</span><span class='line'>  "name": "client1",
</span><span class='line'>  "chef_environment": "_default",
</span><span class='line'>  "normal": {
</span><span class='line'>    "tags": [
</span><span class='line'>
</span><span class='line'>    ]
</span><span class='line'>  },
</span><span class='line'>  "run_list": [
</span><span class='line'>
</span><span class='line'>+++ "recipe[name_of_recipe1]", 
</span><span class='line'>+++ "recipe[name_of_recipe2]" 
</span><span class='line'>
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>In every want-to-deploy nodes, run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo chef-client</span></code></pre></td></tr></table></div></figure>


<h3>Use  Market</h3>

<p>Download and use the knife</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ knife cookbook site download learn_chef_apache2
</span><span class='line'>$ tar xzvf learn_chef_apache2-0.2.1.tar.gz -C cookbooks/
</span><span class='line'>$ knife upload -a </span></code></pre></td></tr></table></div></figure>


<p>Besure to edit the node&rsquo;s recipes.</p>

<p>Two tips:</p>

<p>Remove the cookbook from the server&rsquo;s list:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># knife cookbook delete learn_chef_apache2 0.2.1</span></code></pre></td></tr></table></div></figure>


<p>Directly remove the recipe from the node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># knife node run_list remove ChefClient1 recipe[nginx]
</span><span class='line'># knife node run_list remove ChefClient1 recipe[eclipse]</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tips on Deleteing Neutron Subnet and Router]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/25/tips-on-deleteing-neutron-subnet-and-router/"/>
    <updated>2015-05-25T21:44:54+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/25/tips-on-deleteing-neutron-subnet-and-router</id>
    <content type="html"><![CDATA[<p>Get the existing subnet:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# neutron subnet-list 
</span><span class='line'>+--------------------------------------+-------------+----------------+--------------------------------------------------+
</span><span class='line'>| id                                   | name        | cidr           | allocation_pools                                 |
</span><span class='line'>+--------------------------------------+-------------+----------------+--------------------------------------------------+
</span><span class='line'>| 98725e3a-7ee2-4e3f-83e3-eaca0236918f | demo-subnet | 192.168.1.0/24 | {"start": "192.168.1.2", "end": "192.168.1.254"} |
</span><span class='line'>+--------------------------------------+-------------+----------------+--------------------------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>Delete it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# neutron subnet-delete --name demo-subnet
</span><span class='line'>Unable to complete operation on subnet 98725e3a-7ee2-4e3f-83e3-eaca0236918f. One or more ports have an IP allocation from this subnet. (HTTP 409) (Request-ID: req-7d729bcc-ec50-4de6-83d9-5d2b98332127)</span></code></pre></td></tr></table></div></figure>


<p>Because we have the router, so we list the router via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# neutron router-list
</span><span class='line'>+--------------------------------------+-------------+-----------------------+
</span><span class='line'>| id                                   | name        | external_gateway_info |
</span><span class='line'>+--------------------------------------+-------------+-----------------------+
</span><span class='line'>| a745487e-8e7c-4cc2-aff7-a8423d0a6614 | demo-router | null                  |
</span><span class='line'>+--------------------------------------+-------------+-----------------------+</span></code></pre></td></tr></table></div></figure>


<p>Get the ports of this router:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# neutron router-port-list a745487e-8e7c-4cc2-aff7-a8423d0a6614
</span><span class='line'>+--------------------------------------+------+-------------------+------------------------------------------------------------------------------------+
</span><span class='line'>| id                                   | name | mac_address       | fixed_ips                                                                          |
</span><span class='line'>+--------------------------------------+------+-------------------+------------------------------------------------------------------------------------+
</span><span class='line'>| e56fe57e-e939-493b-8984-b5adfa64e2cc |      | fa:16:3e:b3:7b:e6 | {"subnet_id": "98725e3a-7ee2-4e3f-83e3-eaca0236918f", "ip_address": "192.168.1.1"} |
</span><span class='line'>+--------------------------------------+------+-------------------+------------------------------------------------------------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>So we remove the interface from this router via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# neutron router-interface-delete demo-router 98725e3a-7ee2-4e3f-83e3-eaca0236918f
</span><span class='line'>Removed interface from router demo-router.
</span><span class='line'>root@Controller:~# neutron router-port-list a745487e-8e7c-4cc2-aff7-a8423d0a6614</span></code></pre></td></tr></table></div></figure>


<p>Now we could remove the router and the subnet:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# neutron router-delete demo-router
</span><span class='line'>Deleted router: demo-router
</span><span class='line'>root@Controller:~# neutron subnet-delete demo-subnet
</span><span class='line'>Deleted subnet: demo-subnet</span></code></pre></td></tr></table></div></figure>


<p>From now on ,you could create another subnet and router.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[三节点搭建OpenStack Juno(4)]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/25/san-jie-dian-da-jian-openstack-juno-4/"/>
    <updated>2015-05-25T20:11:17+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/25/san-jie-dian-da-jian-openstack-juno-4</id>
    <content type="html"><![CDATA[<p>Neutron和nova-network的区别在于，nova-network可以让你在每个instance上部署一种网络类型，适合基本的网络功能。而Neutron则使得你可以在一个instance上部署多种网络类型，并且以插件的方式支持多种虚拟化网络。</p>

<p>详细的介绍，以后慢慢加，理解吃透了再加上来，这里单单提操作步骤。</p>

<h3>准备</h3>

<p>数据库准备如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# mysql -u root -p
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 39
</span><span class='line'>Server version: 5.5.43-MariaDB-1ubuntu0.14.04.2 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; CREATE DATABASE neutron;
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'xxxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'xxxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit;
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<h3>配置服务</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# source admin-openrc.sh
</span><span class='line'>root@Controller:~# keystone user-create --name neutron --pass xxxxx
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |                                  |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | a6d790e8e86749bba1d27972de8eaae2 |
</span><span class='line'>|   name   |             neutron              |
</span><span class='line'>| username |             neutron              |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>root@Controller:~# keystone user-role-add --user neutron --tenant service --role admin
</span><span class='line'>root@Controller:~# keystone service-create --name neutron --type network --description "OpenStack Networking"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |       OpenStack Networking       |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 2f6de710ec414797a4a639c2310c8249 |
</span><span class='line'>|     name    |             neutron              |
</span><span class='line'>|     type    |             network              |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>root@Controller:~# keystone endpoint-create --service-id $(keystone service-list | awk '/ network / {print $2}') --publicurl http://Controller:9696 --adminurl http://Controller:9696 --internalurl http://Controller:9696 --region regionOne
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   adminurl  |      http://Controller:9696      |
</span><span class='line'>|      id     | a23132fd0a824aa09f3b1ea72cbb97d2 |
</span><span class='line'>| internalurl |      http://Controller:9696      |
</span><span class='line'>|  publicurl  |      http://Controller:9696      |
</span><span class='line'>|    region   |            regionOne             |
</span><span class='line'>|  service_id | 2f6de710ec414797a4a639c2310c8249 |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h3>安装和配置网络组件</h3>

<p>安装下列包:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install neutron-server neutron-plugin-ml2 python-neutronclient</span></code></pre></td></tr></table></div></figure>


<p>在Controller节点上开始配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/neutron.conf
</span><span class='line'>[database]
</span><span class='line'>...
</span><span class='line'>connection = mysql://neutron:NEUTRON_DBPASS@Controller/neutron</span></code></pre></td></tr></table></div></figure>


<p>配置rabbitMQ认证方式:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>rpc_backend = rabbit
</span><span class='line'>rabbit_host = Controller
</span><span class='line'>rabbit_password = RABBIT_PASS</span></code></pre></td></tr></table></div></figure>


<p>配置keystone认证:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>
</span><span class='line'>#### 删除已有的keystone authtoken配置方式
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>...
</span><span class='line'>auth_uri = http://Controller:5000/v2.0
</span><span class='line'>identity_uri = http://Controller:35357
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = neutron
</span><span class='line'>admin_password = NEUTRON_PASS</span></code></pre></td></tr></table></div></figure>


<p>激活ML2插件(Modular Layer 2), router服务, 和overlapping IP地址:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>core_plugin = ml2
</span><span class='line'>service_plugins = router
</span><span class='line'>allow_overlapping_ips = True</span></code></pre></td></tr></table></div></figure>


<p>配置网络，以便在网络拓扑发生变化时告知Compute节点:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>notify_nova_on_port_status_changes = True
</span><span class='line'>notify_nova_on_port_data_changes = True
</span><span class='line'>nova_url = http://Controller:8774/v2
</span><span class='line'>nova_admin_auth_url = http://Controller:35357/v2.0
</span><span class='line'>nova_region_name = regionOne
</span><span class='line'>nova_admin_username = nova
</span><span class='line'>nova_admin_tenant_id = SERVICE_TENANT_ID
</span><span class='line'>nova_admin_password = NOVA_PASS</span></code></pre></td></tr></table></div></figure>


<p><code>SERVICE_TENANT_ID</code> 通过以下命令来获得:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ source admin-openrc.sh
</span><span class='line'>$ keystone tenant-get service
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |          Service Tenant          |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 08a675be93a04cca8a74159a3eefa288 |
</span><span class='line'>|     name    |             service              |
</span><span class='line'>+-------------+----------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>可以自定义打开verbose选项:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>verbose = True</span></code></pre></td></tr></table></div></figure>


<p>配置Modular Layer2(ML2)插件:</p>

<p>在[ml2]部分，激活flat and generic routing encapsulation(GRE) network类型驱动, GRE Tenant网络和OVS机制驱动:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/plugins/ml2/ml2_conf.ini
</span><span class='line'>[ml2]
</span><span class='line'>...
</span><span class='line'>type_drivers = flat,gre
</span><span class='line'>tenant_network_types = gre
</span><span class='line'>mechanism_drivers = openvswitch</span></code></pre></td></tr></table></div></figure>


<p><code>[ml2_type_gre]</code> 部分，配置tunnel identifier(id)范围:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ml2_type_gre]
</span><span class='line'>...
</span><span class='line'>tunnel_id_ranges = 1:1000</span></code></pre></td></tr></table></div></figure>


<p>配置securitygroup部分,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[securitygroup]
</span><span class='line'>...
</span><span class='line'>enable_security_group = True
</span><span class='line'>enable_ipset = True
</span><span class='line'>firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</span></code></pre></td></tr></table></div></figure>


<p>配置计算服务使用网络:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/nova/nova.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>network_api_class = nova.network.neutronv2.api.API
</span><span class='line'>security_group_api = neutron
</span><span class='line'>linuxnet_interface_driver = nova.network.linux_net.LinuxOVSInterfaceDriver
</span><span class='line'>firewall_driver = nova.virt.firewall.NoopFirewallDriver</span></code></pre></td></tr></table></div></figure>


<p>在<code>[neutron]</code>部分，配置访问参数:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[neutron]
</span><span class='line'>...
</span><span class='line'>url = http://Controller:9696
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>admin_auth_url = http://Controller:35357/v2.0
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_username = neutron
</span><span class='line'>admin_password = NEUTRON_PASS</span></code></pre></td></tr></table></div></figure>


<p>完成安装：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade juno" neutron
</span><span class='line'># service nova-api restart
</span><span class='line'># service nova-scheduler restart
</span><span class='line'># service nova-conductor restart
</span><span class='line'># service neutron-server restart
</span></code></pre></td></tr></table></div></figure>


<p>验证:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# source admin-openrc.sh
</span><span class='line'>root@Controller:~# neutron ext-list
</span><span class='line'>+-----------------------+-----------------------------------------------+
</span><span class='line'>| alias                 | name                                          |
</span><span class='line'>+-----------------------+-----------------------------------------------+
</span><span class='line'>| security-group        | security-group                                |
</span><span class='line'>| l3_agent_scheduler    | L3 Agent Scheduler                            |
</span><span class='line'>| ext-gw-mode           | Neutron L3 Configurable external gateway mode |
</span><span class='line'>| binding               | Port Binding                                  |
</span><span class='line'>| provider              | Provider Network                              |
</span><span class='line'>| agent                 | agent                                         |
</span><span class='line'>| quotas                | Quota management support                      |
</span><span class='line'>| dhcp_agent_scheduler  | DHCP Agent Scheduler                          |
</span><span class='line'>| l3-ha                 | HA Router extension                           |
</span><span class='line'>| multi-provider        | Multi Provider Network                        |
</span><span class='line'>| external-net          | Neutron external network                      |
</span><span class='line'>| router                | Neutron L3 Router                             |
</span><span class='line'>| allowed-address-pairs | Allowed Address Pairs                         |
</span><span class='line'>| extraroute            | Neutron Extra Route                           |
</span><span class='line'>| extra_dhcp_opt        | Neutron Extra DHCP opts                       |
</span><span class='line'>| dvr                   | Distributed Virtual Router                    |
</span><span class='line'>+-----------------------+-----------------------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h3>配置网络节点</h3>

<p>安装以下包:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install neutron-plugin-ml2 neutron-plugin-openvswitch-agent neutron-l3-agent neutron-dhcp-agent</span></code></pre></td></tr></table></div></figure>


<p>配置， 首先，删除<code>/etc/neutron/neutron.conf</code>里所有的database连接，因为网络节点不需要任何数据库连接。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/neutron.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>rpc_backend = rabbit
</span><span class='line'>rabbit_host = controller
</span><span class='line'>rabbit_password = RABBIT_PASS</span></code></pre></td></tr></table></div></figure>


<p>更改keystone认证方式:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>...
</span><span class='line'>auth_uri = http://controller:5000/v2.0
</span><span class='line'>identity_uri = http://controller:35357
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = neutron
</span><span class='line'>admin_password = NEUTRON_PASS</span></code></pre></td></tr></table></div></figure>


<p>有关<code>[ml2]</code>的配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>core_plugin = ml2
</span><span class='line'>service_plugins = router
</span><span class='line'>allow_overlapping_ips = True</span></code></pre></td></tr></table></div></figure>


<p>接着：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/plugins/ml2/ml2_conf
</span><span class='line'>[ml2]
</span><span class='line'>...
</span><span class='line'>type_drivers = flat,gre
</span><span class='line'>tenant_network_types = gre
</span><span class='line'>mechanism_drivers = openvswitch
</span><span class='line'>[ml2_type_flat]
</span><span class='line'>...
</span><span class='line'>flat_networks = external
</span><span class='line'>[ml2_type_gre]
</span><span class='line'>...
</span><span class='line'>tunnel_id_ranges = 1:1000
</span><span class='line'>[securitygroup]
</span><span class='line'>...
</span><span class='line'>enable_security_group = True
</span><span class='line'>enable_ipset = True
</span><span class='line'>firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
</span><span class='line'>[ovs]
</span><span class='line'>...
</span><span class='line'>local_ip = INSTANCE_TUNNELS_INTERFACE_IP_ADDRESS
</span><span class='line'>enable_tunneling = True
</span><span class='line'>bridge_mappings = external:br-ex
</span><span class='line'>[agent]
</span><span class='line'>...
</span><span class='line'>tunnel_types = gre</span></code></pre></td></tr></table></div></figure>


<p>配置Layer-3客户端:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/l3_agent.ini
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
</span><span class='line'>use_namespaces = True
</span><span class='line'>external_network_bridge = br-ex
</span><span class='line'>router_delete_namespaces = True
</span></code></pre></td></tr></table></div></figure>


<p>配置DHCP客户端：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/dhcp_agent.init
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
</span><span class='line'>dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
</span><span class='line'>use_namespaces = True
</span><span class='line'>dhcp_delete_namespaces = True
</span><span class='line'>
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>dnsmasq_config_file = /etc/neutron/dnsmasq-neutron.conf</span></code></pre></td></tr></table></div></figure>


<p>配置dnsmasq配置文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/dnsmasq_neutron.conf
</span><span class='line'>dhcp-option-force=26,1454
</span><span class='line'>$ sudo pkill dnsmasq</span></code></pre></td></tr></table></div></figure>


<p>配置metadata客户端:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/metadata_agent.ini
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>auth_url = http://controller:5000/v2.0
</span><span class='line'>auth_region = regionOne
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = neutron
</span><span class='line'>admin_password = NEUTRON_PASS
</span><span class='line'>
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>nova_metadata_ip = controller
</span><span class='line'>
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>metadata_proxy_shared_secret = METADATA_SECRET
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>对应的，在控制节点上，配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/nova/nova.conf
</span><span class='line'>[neutron]
</span><span class='line'>...
</span><span class='line'>service_metadata_proxy = True
</span><span class='line'>metadata_proxy_shared_secret = METADATA_SECRET
</span><span class='line'># service nova-api restart
</span></code></pre></td></tr></table></div></figure>


<p>配置Open vSwitch(OVS)服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service openvswitch-switch restart
</span><span class='line'># ovs-vsctl add-br br-ex
</span><span class='line'># ovs-vsctl add-port br-ex INTERFACE_NAME
</span><span class='line'># service neutron-plugin-openvswitch-agent restart
</span><span class='line'># service neutron-l3-agent restart
</span><span class='line'># service neutron-dhcp-agent restart
</span><span class='line'># service neutron-metadata-agent restart</span></code></pre></td></tr></table></div></figure>


<p>验证:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ source admin-openrc.sh
</span><span class='line'>$ neutron agent-list
</span></code></pre></td></tr></table></div></figure>


<h3>计算节点配置</h3>

<p>配置如下;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/sysctl.conf
</span><span class='line'>net.ipv4.conf.all.rp_filter=0
</span><span class='line'>net.ipv4.conf.default.rp_filter=0
</span><span class='line'># sysctl -p</span></code></pre></td></tr></table></div></figure>


<p>安装网络组件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install neutron-plugin-ml2 neutron-plugin-openvswitch-agent</span></code></pre></td></tr></table></div></figure>


<p>配置网络组件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/neutron.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>rpc_backend = rabbit
</span><span class='line'>rabbit_host = controller
</span><span class='line'>rabbit_password = RABBIT_PASS</span></code></pre></td></tr></table></div></figure>


<p>keystone组件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>...
</span><span class='line'>auth_uri = http://controller:5000/v2.0
</span><span class='line'>identity_uri = http://controller:35357
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = neutron
</span><span class='line'>admin_password = NEUTRON_PASS</span></code></pre></td></tr></table></div></figure>


<p><code>[ml2]</code>插件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/neutron.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>core_plugin = ml2
</span><span class='line'>service_plugins = router
</span><span class='line'>allow_overlapping_ips = True</span></code></pre></td></tr></table></div></figure>


<p>继续配置ml2插件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/neutron/plugins/ml2/ml2_conf.ini
</span><span class='line'>[ml2]
</span><span class='line'>...
</span><span class='line'>type_drivers = flat,gre
</span><span class='line'>tenant_network_types = gre
</span><span class='line'>mechanism_drivers = openvswitch
</span><span class='line'>
</span><span class='line'>[ml2_type_gre]
</span><span class='line'>...
</span><span class='line'>tunnel_id_ranges = 1:1000
</span><span class='line'>
</span><span class='line'>[securitygroup]
</span><span class='line'>...
</span><span class='line'>enable_security_group = True
</span><span class='line'>enable_ipset = True
</span><span class='line'>firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
</span><span class='line'>
</span><span class='line'>[ovs]
</span><span class='line'>...
</span><span class='line'>local_ip = INSTANCE_TUNNELS_INTERFACE_IP_ADDRESS
</span><span class='line'>enable_tunneling = True
</span><span class='line'>
</span><span class='line'>[agent]
</span><span class='line'>...
</span><span class='line'>tunnel_types = gre</span></code></pre></td></tr></table></div></figure>


<p>配置OVS服务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service openvswitch-switch restart
</span></code></pre></td></tr></table></div></figure>


<p>配置计算节点使用网络:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/nova/nova.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>network_api_class = nova.network.neutronv2.api.API
</span><span class='line'>security_group_api = neutron
</span><span class='line'>linuxnet_interface_driver = nova.network.linux_net.LinuxOVSInterfaceDriver
</span><span class='line'>firewall_driver = nova.virt.firewall.NoopFirewallDriver
</span><span class='line'>
</span><span class='line'>[neutron]
</span><span class='line'>...
</span><span class='line'>url = http://controller:9696
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>admin_auth_url = http://controller:35357/v2.0
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_username = neutron
</span><span class='line'>admin_password = NEUTRON_PASS</span></code></pre></td></tr></table></div></figure>


<p>完成安装:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service nova-compute restart
</span><span class='line'># service neutron-plugin-openvswitch-agent restart</span></code></pre></td></tr></table></div></figure>


<p>验证， 在Controller节点上:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ source admin-openrc.sh
</span><span class='line'>$ neutron agent-list</span></code></pre></td></tr></table></div></figure>


<h3>创建初始化网络</h3>

<p>步骤如下:  <br/>
创建外网:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># source admin-openrc.sh
</span><span class='line'># neutron net-create ext-net --router:external True \
</span><span class='line'>--provider:physical_network external --provider:network_type flat
</span><span class='line'># neutron subnet-create ext-net --name ext-subnet \
</span><span class='line'>--allocation-pool start=10.77.77.200,end=10.77.77.220 \
</span><span class='line'>--disable-dhcp --gateway 10.77.77.1 10.77.77.0/24</span></code></pre></td></tr></table></div></figure>


<p>租户网络:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ source demo-openrc.sh
</span><span class='line'>$ neutron net-create demo-net
</span><span class='line'>$ neutron subnet-create demo-net --name demo-subnet \
</span><span class='line'>--gateway 10.10.10.1 10.10.10.0/24
</span><span class='line'>$ neutron router-create demo-router
</span><span class='line'>$ neutron router-interface-add demo-router demo-subnet
</span><span class='line'>$ neutron router-gateway-set demo-router ext-net</span></code></pre></td></tr></table></div></figure>


<p>验证, 因为我们用了10.77.77.200~220作为外网的floating IP, 所以路由器外网的IP应该落在10.77.77.200上，在计算节点上直接ping, 看结果:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dash@PowerfulDash:~$ ping 10.77.77.200
</span><span class='line'>PING 10.77.77.200 (10.77.77.200) 56(84) bytes of data.
</span><span class='line'>64 bytes from 10.77.77.200: icmp_seq=1 ttl=64 time=0.323 ms
</span><span class='line'>64 bytes from 10.77.77.200: icmp_seq=2 ttl=64 time=0.177 ms
</span><span class='line'>64 bytes from 10.77.77.200: icmp_seq=3 ttl=64 time=0.141 ms</span></code></pre></td></tr></table></div></figure>


<p>其实上面的结果是在Host机器上Ping的，因host机器已经有了10.77.77.1地址，理论上，如果能Ping通10.77.77.200，证明Router工作正常。</p>

<h3>Horizon</h3>

<p>在控制节点上安装以下包 ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install openstack-dashboard apache2 libapache2-mod-wsgi memcached python-memcache</span></code></pre></td></tr></table></div></figure>


<p>配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/openstack-dashboard/local_settings.py
</span><span class='line'>OPENSTACK_HOST = "controller"
</span><span class='line'>ALLOWED_HOSTS = ['*']
</span><span class='line'>CACHES = {
</span><span class='line'>'default': {
</span><span class='line'>'BACKEND': 'django.core.cache.backends.memcached.
</span><span class='line'>MemcachedCache',
</span><span class='line'>'LOCATION': '127.0.0.1:11211',
</span><span class='line'>}
</span><span class='line'>}
</span><span class='line'>TIME_ZONE = "TIME_ZONE"
</span></code></pre></td></tr></table></div></figure>


<p>重启服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service apache2 restart
</span><span class='line'># service memcached restart</span></code></pre></td></tr></table></div></figure>


<p>最后访问:  <br/>
<a href="http://Controller/horizon">http://Controller/horizon</a> 来看到结果.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[三节点搭建OpenStack Juno(3)]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/25/san-jie-dian-da-jian-openstack-juno-3/"/>
    <updated>2015-05-25T16:51:01+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/25/san-jie-dian-da-jian-openstack-juno-3</id>
    <content type="html"><![CDATA[<h3>Nova</h3>

<h4>Nova数据库</h4>

<p>创建nova数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mysql -u root -p
</span><span class='line'>  CREATE DATABASE nova;
</span><span class='line'>  GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' \
</span><span class='line'>  IDENTIFIED BY 'NOVA_DBPASS';
</span><span class='line'>  GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' \
</span><span class='line'>  IDENTIFIED BY 'NOVA_DBPASS';
</span><span class='line'>  quit;</span></code></pre></td></tr></table></div></figure>


<p>创建nova用户:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># source /home/dash/admin-openrc.sh
</span><span class='line'>root@Controller:~# keystone user-create --name nova --pass xxxxxx
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |                                  |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | 4a3768e3f4754cd0b9d47c6fadb22c7e |
</span><span class='line'>|   name   |               nova               |
</span><span class='line'>| username |               nova               |
</span><span class='line'>+----------+----------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>为admin角色添加nova用户:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># keystone user-role-add --user nova --tenant service --role admin</span></code></pre></td></tr></table></div></figure>


<p>添加nova服务条目:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># keystone service-create --name nova --type compute --description "OpenStack Compute"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |        OpenStack Compute         |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 1587a46ee1e94402821398444175981f |
</span><span class='line'>|     name    |               nova               |
</span><span class='line'>|     type    |             compute              |
</span></code></pre></td></tr></table></div></figure>


<p>创建Compute服务的API endpoints:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># keystone endpoint-create --service-id $(keystone service-list | awk '/ compute / {print $2}') --publicurl http://Controller:8774/v2/%\(tenant_id\)s --internalurl http://Controller:8774/v2/%\(tenant_id\)s --adminurl http://Controller:8774/v2/%\(tenant_id\)s --region regionOne
</span><span class='line'>+-------------+-----------------------------------------+
</span><span class='line'>|   Property  |                  Value                  |
</span><span class='line'>+-------------+-----------------------------------------+
</span><span class='line'>|   adminurl  | http://Controller:8774/v2/%(tenant_id)s |
</span><span class='line'>|      id     |     bd439dc236c04956a11b353a7b74331c    |
</span><span class='line'>| internalurl | http://Controller:8774/v2/%(tenant_id)s |
</span><span class='line'>|  publicurl  | http://Controller:8774/v2/%(tenant_id)s |
</span><span class='line'>|    region   |                regionOne                |
</span><span class='line'>|  service_id |     1587a46ee1e94402821398444175981f    |
</span><span class='line'>+-------------+-----------------------------------------+</span></code></pre></td></tr></table></div></figure>


<h4>Nova安装及配置</h4>

<p>安装以下包:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install nova-api nova-cert nova-conductor nova-consoleauth nova-novncproxy nova-scheduler python-novaclient</span></code></pre></td></tr></table></div></figure>


<p>更改数据库链接:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/nova/nova.conf
</span><span class='line'>[database]
</span><span class='line'>...
</span><span class='line'>connection = mysql://nova:NOVA_DBPASS@controller/nova</span></code></pre></td></tr></table></div></figure>


<p>配置RabbitMQ访问:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>rpc_backend = rabbit
</span><span class='line'>rabbit_host = controller
</span><span class='line'>rabbit_password = RABBIT_PASS</span></code></pre></td></tr></table></div></figure>


<p>配置鉴权服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>...
</span><span class='line'>auth_uri = http://controller:5000/v2.0
</span><span class='line'>identity_uri = http://controller:35357
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = nova
</span><span class='line'>admin_password = NOVA_PASS</span></code></pre></td></tr></table></div></figure>


<p>更改<code>my_ip</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>my_ip = 10.55.55.2</span></code></pre></td></tr></table></div></figure>


<p>更改VNC侦听：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>vncserver_listen = 10.55.55.2
</span><span class='line'>vncserver_proxyclient_address = 10.55.55.2</span></code></pre></td></tr></table></div></figure>


<p>配置glance服务所在:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[glance]
</span><span class='line'>...
</span><span class='line'>host = controller</span></code></pre></td></tr></table></div></figure>


<p>现在开始配置数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># su -s /bin/sh -c "nova-manage db sync" nova</span></code></pre></td></tr></table></div></figure>


<p>重启服务以完成安装:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service nova-api restart
</span><span class='line'># service nova-cert restart
</span><span class='line'># service nova-consoleauth restart
</span><span class='line'># service nova-scheduler restart 
</span><span class='line'># service nova-conductor start
</span><span class='line'># service nova-conductor restart
</span><span class='line'># service nova-novncproxy
</span><span class='line'># service nova-novncproxy restart</span></code></pre></td></tr></table></div></figure>


<p>扫尾，删除不用的sqlite数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rm -f /var/lib/nova/nova.sqlite</span></code></pre></td></tr></table></div></figure>


<h3>安装和配置计算节点</h3>

<p>在计算节点上，安装以下包:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install nova-compute sysfsutils</span></code></pre></td></tr></table></div></figure>


<p>配置具体过程如下:  <br/>
配置RabbitMQ:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/nova/nova.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>rpc_backend = rabbit
</span><span class='line'>rabbit_host = controller
</span><span class='line'>rabbit_password = RABBIT_PASS</span></code></pre></td></tr></table></div></figure>


<p>配置鉴权服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>...
</span><span class='line'>auth_uri = http://Controller:5000/v2.0
</span><span class='line'>identity_uri = http://Controller:35357
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = nova
</span><span class='line'>admin_password = NOVA_PASS</span></code></pre></td></tr></table></div></figure>


<p>配置<code>my_ip</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>my_ip = 10.55.55.4</span></code></pre></td></tr></table></div></figure>


<p>配置允许远程终端访问:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>vnc_enabled = True
</span><span class='line'>vncserver_listen = 0.0.0.0
</span><span class='line'>vncserver_proxyclient_address = 10.55.55.4
</span><span class='line'>novncproxy_base_url = http://Controller:6080/vnc_auto.html
</span></code></pre></td></tr></table></div></figure>


<p>配置glance服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[glance]
</span><span class='line'>...
</span><span class='line'>host = Controller</span></code></pre></td></tr></table></div></figure>


<p>完成安装， 首先判断你的CPU是否支持硬件加速:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ egrep -c '(vmx|svm)' /proc/cpuinfo</span></code></pre></td></tr></table></div></figure>


<p>如果返回的值小于1, 则更改<code>/etc/nova/nova-compute.conf</code>配置中的[libvirt]选项，选用qemu而不是kvm:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/nova/nova-compute.conf
</span><span class='line'>[libvirt]
</span><span class='line'>...
</span><span class='line'>virt_type = qemu</span></code></pre></td></tr></table></div></figure>


<p>重启nova-compute服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service nova-compute restart</span></code></pre></td></tr></table></div></figure>


<p>扫尾，删除不用的nova.sqlite文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rm -f /var/lib/nova/nova.sqlite</span></code></pre></td></tr></table></div></figure>


<h3>验证</h3>

<p>具体步骤如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# source ~/admin-openrc.sh
</span><span class='line'>root@Controller:~# nova service-list
</span><span class='line'>+----+------------------+------------+----------+---------+-------+----------------------------+-----------------+
</span><span class='line'>| Id | Binary           | Host       | Zone     | Status  | State | Updated_at                 | Disabled Reason |
</span><span class='line'>+----+------------------+------------+----------+---------+-------+----------------------------+-----------------+
</span><span class='line'>| 1  | nova-cert        | Controller | internal | enabled | up    | 2015-05-25T12:00:20.000000 | -               |
</span><span class='line'>| 2  | nova-consoleauth | Controller | internal | enabled | up    | 2015-05-25T12:00:28.000000 | -               |
</span><span class='line'>| 3  | nova-scheduler   | Controller | internal | enabled | up    | 2015-05-25T12:00:23.000000 | -               |
</span><span class='line'>| 4  | nova-conductor   | Controller | internal | enabled | up    | 2015-05-25T12:00:25.000000 | -               |
</span><span class='line'>| 5  | nova-compute     | Compute    | nova     | enabled | up    | 2015-05-25T12:00:20.000000 | -               |
</span><span class='line'>+----+------------------+------------+----------+---------+-------+----------------------------+-----------------+
</span><span class='line'>root@Controller:~# nova image-list
</span><span class='line'>+--------------------------------------+---------------------+--------+--------+
</span><span class='line'>| ID                                   | Name                | Status | Server |
</span><span class='line'>+--------------------------------------+---------------------+--------+--------+
</span><span class='line'>| 3d45ea58-731c-4eb5-bf30-db1b4bfe4f57 | cirros-0.3.3-x86_64 | ACTIVE |        |
</span><span class='line'>+--------------------------------------+---------------------+--------+--------+
</span></code></pre></td></tr></table></div></figure>


<p>注意我们看到了compute节点已经被加入进来。这样我们完成了添加计算服务，接下来我们将开始添加网络组件，这可能是最难的一部分。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LXCize the KVM Machine]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/25/lxcize-the-kvm-machine/"/>
    <updated>2015-05-25T11:46:28+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/25/lxcize-the-kvm-machine</id>
    <content type="html"><![CDATA[<p>In order to make exsiting kvm based machine to be lxc container, following is the steps.    <br/>
Refers to:  <br/>
<a href="https://www.stgraber.org/2012/03/04/booting-an-ubuntu-12-04-virtual-machine-in-an-lxc-container/">https://www.stgraber.org/2012/03/04/booting-an-ubuntu-12-04-virtual-machine-in-an-lxc-container/</a></p>

<h3>Convert Disk Formats</h3>

<p>First we want to convert the qcow2 format image to raw format, by following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ qemu-img convert u12-debug-ui.qcow2 Contrail.raw</span></code></pre></td></tr></table></div></figure>


<p>This will take a very long time, because qcow2 file will expand to a whole images, like mine, the Contrail.raw in fact expands to 100G size.</p>

<h3>LXC the KVM</h3>

<p>Since we have the raw image file, we could create a new configuration file for starting the machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> myvm.conf
</span><span class='line'>lxc.network.type = veth
</span><span class='line'>lxc.network.flags = up
</span><span class='line'>lxc.network.link = br0
</span><span class='line'>lxc.network.name = eth0
</span><span class='line'>lxc.network.ipv4 = xxx.xxx.10.230/24
</span><span class='line'>lxc.network.ipv4.gateway = xxx.xxx.0.176
</span><span class='line'>#lxc.network.link = lxcbr0
</span><span class='line'>lxc.utsname = myvminlxc
</span><span class='line'>
</span><span class='line'>lxc.tty = 4
</span><span class='line'>lxc.pts = 1024
</span><span class='line'>lxc.rootfs = /dev/mapper/loop0p1
</span><span class='line'>lxc.arch = amd64
</span><span class='line'>lxc.cap.drop = sys_module mac_admin
</span><span class='line'>
</span><span class='line'>lxc.cgroup.devices.deny = a
</span><span class='line'># Allow any mknod (but not using the node)
</span><span class='line'>lxc.cgroup.devices.allow = c *:* m
</span><span class='line'>lxc.cgroup.devices.allow = b *:* m
</span><span class='line'># /dev/null and zero
</span><span class='line'>lxc.cgroup.devices.allow = c 1:3 rwm
</span><span class='line'>lxc.cgroup.devices.allow = c 1:5 rwm
</span><span class='line'># consoles
</span><span class='line'>lxc.cgroup.devices.allow = c 5:1 rwm
</span><span class='line'>lxc.cgroup.devices.allow = c 5:0 rwm
</span><span class='line'>#lxc.cgroup.devices.allow = c 4:0 rwm
</span><span class='line'>#lxc.cgroup.devices.allow = c 4:1 rwm
</span><span class='line'># /dev/{,u}random
</span><span class='line'>lxc.cgroup.devices.allow = c 1:9 rwm
</span><span class='line'>lxc.cgroup.devices.allow = c 1:8 rwm
</span><span class='line'>lxc.cgroup.devices.allow = c 136:* rwm
</span><span class='line'>lxc.cgroup.devices.allow = c 5:2 rwm
</span><span class='line'># rtc
</span><span class='line'>lxc.cgroup.devices.allow = c 254:0 rwm
</span><span class='line'>#fuse
</span><span class='line'>lxc.cgroup.devices.allow = c 10:229 rwm
</span><span class='line'>#tun
</span><span class='line'>lxc.cgroup.devices.allow = c 10:200 rwm
</span><span class='line'>#full
</span><span class='line'>lxc.cgroup.devices.allow = c 1:7 rwm
</span><span class='line'>#hpet
</span><span class='line'>lxc.cgroup.devices.allow = c 10:228 rwm
</span><span class='line'>#kvm
</span><span class='line'>lxc.cgroup.devices.allow = c 10:232 rwm</span></code></pre></td></tr></table></div></figure>


<p>Now setup the image file via, this will use the <code>/dev/mapper/loop0p1</code> as the root partition:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo kpartx -a Contrail.img</span></code></pre></td></tr></table></div></figure>


<p>Now start the machine via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo lxc-start -n myvminlxc -f ./myvm.conf</span></code></pre></td></tr></table></div></figure>


<p>Your machine will boot into the lxc, and its behavior is the same as the kvm based machine.</p>

<h3>TroubleShooting</h3>

<p>The root could not login into the lxc, because of the selinux enabled in the Ubuntu Host, simply disable it in <code>/etc/selinux/config</code> by:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/selinux/config
</span><span class='line'>#SELINUX=permissive
</span><span class='line'>SELINUX=disabled
</span></code></pre></td></tr></table></div></figure>


<p>Added it into the startup file in <code>/etc/rc.local</code>, it&rsquo;s ugly, and it will cause  the first tty died. But, first use it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kpartx -a /home/xxxxx/iso/Contrail.raw
</span><span class='line'>lxc-start -n myvminlxc -f /home/xxxxx/iso/myvm.conf
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[三节点搭建OpenStack Juno(2)]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno-2/"/>
    <updated>2015-05-24T22:37:28+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno-2</id>
    <content type="html"><![CDATA[<h3>MySQL数据库</h3>

<p>绝大多数的OpenStack服务使用SQL数据库来存储信息，一般情况下数据库运行在控制节点上，这里我们使用MariaDB或者MySQL来作为SQL数据库。</p>

<p>安装, 注意安装过程中需要输入密码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install mariadb-server python-mysqldb</span></code></pre></td></tr></table></div></figure>


<p>配置, 主要是更改了bind的地址，添加了一些有用选项，并支持UTF-8编码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/mysql/my.cnf
</span><span class='line'>[mysqld]
</span><span class='line'>...
</span><span class='line'>bind-address = 10.55.55.2
</span><span class='line'>...
</span><span class='line'>default-storage-engine = innodb
</span><span class='line'>innodb_file_per_table
</span><span class='line'>collation-server = utf8_general_ci
</span><span class='line'>init-connect = 'SET NAMES utf8'
</span><span class='line'>character-set-server = utf8</span></code></pre></td></tr></table></div></figure>


<p>完成安装，包括重启服务及加密数据库服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service mysql restart
</span><span class='line'># mysql_secure_installation </span></code></pre></td></tr></table></div></figure>


<h3>消息服务器</h3>

<p>OpenStack使用message broker用来在各种服务器之间调度操作和协调状态信息，通常情况下消息服务器也运行在控制节点上，OpenStack支持RabbitMQ, Qpid和ZeroMQ, 这里使用RabbitMQ.</p>

<p>安装:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install rabbitmq-server</span></code></pre></td></tr></table></div></figure>


<p>配置，首先我们需要设定rabbitMQ使用的密码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rabbitmqctl change_password guest RABBIT_PASS
</span><span class='line'>Changing password for user "guest" ...
</span><span class='line'>...done.</span></code></pre></td></tr></table></div></figure>


<p>如果是RabbitMQ 3.3.0或者更新的版本，则需要激活guest用户的远程访问权限。</p>

<p>检查RabbitMQ版本:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rabbitmqctl status | grep rabbit
</span><span class='line'>Status of node rabbit@Controller ...
</span><span class='line'> {running_applications,[{rabbit,"RabbitMQ","3.2.4"},</span></code></pre></td></tr></table></div></figure>


<p>这里我们的版本是3.2.4所以不需要做任何修改，直接重启RabbitMQ服务即可。若是3.3.0以后的版本，则需要参考官方文档作更为详细的配置。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service rabbitmq-server restart</span></code></pre></td></tr></table></div></figure>


<h3>鉴权(Identity)服务</h3>

<p>鉴权服务的作用主要有:   <br/>
1. 跟踪用户及其权限。   <br/>
2. 提供可用服务的服务类别及API endpoint.</p>

<p>详细的关于Identity的介绍可以参见OpenStack官方文档。只有理解了其理念后才能明了OpenStack架构中各种服务的角色和地位.</p>

<p>首先创建keystone所需要的数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mysql -u root -p
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 36
</span><span class='line'>Server version: 5.5.43-MariaDB-1ubuntu0.14.04.2 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; CREATE DATABASE keystone;
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \
</span><span class='line'>    -&gt; IDENTIFIED BY 'KEYSTONE_PASSWD';
</span><span class='line'>Query OK, 0 rows affected (0.01 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \
</span><span class='line'>    -&gt; IDENTIFIED BY 'KEYSTONE_PASSWD';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit;
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<p>创建一个随机值，用于管理token在初始化配置时使用:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># openssl rand -hex 10
</span><span class='line'>760bc221f4dc966693e5</span></code></pre></td></tr></table></div></figure>


<p>安装和配置组件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install keystone python-keystoneclient</span></code></pre></td></tr></table></div></figure>


<p>配置, 更改<code>admin_token</code>为刚才生成的随机数:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/keystone/keystone.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>admin_token = 760bc221f4dc966693e5
</span><span class='line'>...
</span><span class='line'>[database]
</span><span class='line'>...
</span><span class='line'>connection = mysql://keystone:KEYSTONE_DBPASS@Controller/keystone
</span><span class='line'>...
</span><span class='line'>[token]
</span><span class='line'>...
</span><span class='line'>provider = keystone.token.providers.uuid.Provider
</span><span class='line'>driver = keystone.token.persistence.backends.sql.Token
</span><span class='line'>...
</span><span class='line'>[revoke]
</span><span class='line'>...
</span><span class='line'>driver = keystone.contrib.revoke.backends.sql.Revoke
</span><span class='line'>...
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>verbose = True</span></code></pre></td></tr></table></div></figure>


<p>修改完毕后，使用以下命令来同步Identity服务数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># su -s /bin/sh -c "keystone-manage db_sync" keystone</span></code></pre></td></tr></table></div></figure>


<p>重启鉴权服务，删除Ubuntu使用的默认sqlite数据库, 并完成安装:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service keystone restart
</span><span class='line'># rm -f /var/lib/keystone/keystone.db </span></code></pre></td></tr></table></div></figure>


<p>使用下列命令来激活cron任务，以便每小时判断tokens的存活时间:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># (crontab -l -u keystone 2&gt;&1 | grep -q token_flush) || echo '@hourly /usr/bin/keystone-manage token_flush &gt;/var/log/keystone/keystone-tokenflush.log 2&gt;&1' &gt;&gt; /var/spool/cron/crontabs/keystone</span></code></pre></td></tr></table></div></figure>


<h4>创建tenants, users, roles</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># export OS_SERVICE_TOKEN=760bc221f4dc966693e5
</span><span class='line'># export OS_SERVICE_ENDPOINT=http://Controller:35357/v2.0
</span><span class='line'># keystone tenant-create --name admin --description "Admin Tenant"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |           Admin Tenant           |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 6f5f440aa9de4b2fa205f43df073ddfa |
</span><span class='line'>|     name    |              admin               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone user-create --name admin --pass XXXXXXXXX --email xxxxxxxx@gmail.com
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |        XXXXXXXX@gmail.com        |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | 7bc9be5493e345518a384383872ab274 |
</span><span class='line'>|   name   |              admin               |
</span><span class='line'>| username |              admin               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'># keystone role-create --name admin
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|    id    | 65b6ccaa3b434c848ccb757be43d6b41 |
</span><span class='line'>|   name   |              admin               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'># keystone user-role-add --user admin --tenant admin --role admin
</span><span class='line'># keystone tenant-create --name demo --description "Demo Tenant"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |           Demo Tenant            |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 459c25933274483fb01ce66d9514add6 |
</span><span class='line'>|     name    |               demo               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone user-create --name demo --tenant demo --pass xxxxx --email xxxxxxx@gmail.com
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |        xxxxxxx@gmail.com        |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | b2f3d8a239b34edfb50fa67c5aca8f83 |
</span><span class='line'>|   name   |               demo               |
</span><span class='line'>| tenantId | 459c25933274483fb01ce66d9514add6 |
</span><span class='line'>| username |               demo               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'># keystone tenant-create --name service --description "Service Tenant"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |          Service Tenant          |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 08a675be93a04cca8a74159a3eefa288 |
</span><span class='line'>|     name    |             service              |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone service-create --name keystone --type identity --description "OpenStack Identity"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |        OpenStack Identity        |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | bf7613d9563c47a9af80ecdb4f26f3f5 |
</span><span class='line'>|     name    |             keystone             |
</span><span class='line'>|     type    |             identity             |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone endpoint-create --service-id $(keystone service-list | awk '/ identity / {print $2}') --publicurl http://Controller:5000/v2.0 --internalurl http://Controller:5000/v2.0 --adminurl http://Controller:35357/v2.0 --region regionOne
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   adminurl  |   http://Controller:35357/v2.0   |
</span><span class='line'>|      id     | c2c7a6c24b1d411b996f2e30fefc70b6 |
</span><span class='line'>| internalurl |   http://Controller:5000/v2.0    |
</span><span class='line'>|  publicurl  |   http://Controller:5000/v2.0    |
</span><span class='line'>|    region   |            regionOne             |
</span><span class='line'>|  service_id | bf7613d9563c47a9af80ecdb4f26f3f5 |
</span><span class='line'>+-------------+----------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>验证, 详细的说明参见OpenStack官方文档:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># unset OS_SERVICE_TOKEN OS_SERVICE_ENDPOINT
</span><span class='line'># keystone --os-tenant-name admin --os-username admin --os-password xxxxx --os-auth-url http://Controller:35357/v2.0 token-get
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'>|  Property |              Value               |
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'>|  expires  |       2015-05-24T16:43:08Z       |
</span><span class='line'>|     id    | 612b529c9c754b87a153abd39284aff6 |
</span><span class='line'>| tenant_id | 6f5f440aa9de4b2fa205f43df073ddfa |
</span><span class='line'>|  user_id  | 7bc9be5493e345518a384383872ab274 |
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'># keystone --os-tenant-name admin --os-username admin --os-password xxxxx --os-auth-url http://Controller:35357/v2.0 tenant-list
</span><span class='line'>+----------------------------------+---------+---------+
</span><span class='line'>|                id                |   name  | enabled |
</span><span class='line'>+----------------------------------+---------+---------+
</span><span class='line'>| 6f5f440aa9de4b2fa205f43df073ddfa |  admin  |   True  |
</span><span class='line'>| 459c25933274483fb01ce66d9514add6 |   demo  |   True  |
</span><span class='line'>| 08a675be93a04cca8a74159a3eefa288 | service |   True  |
</span><span class='line'>+----------------------------------+---------+---------+
</span><span class='line'># keystone --os-tenant-name admin --os-username admin --os-password xxxxx --os-auth-url http://Controller:35357/v2.0 user-list
</span><span class='line'>+----------------------------------+-------+---------+--------------------+
</span><span class='line'>|                id                |  name | enabled |       email        |
</span><span class='line'>+----------------------------------+-------+---------+--------------------+
</span><span class='line'>| 7bc9be5493e345518a384383872ab274 | admin |   True  | xxxxxxx@gmail.com |
</span><span class='line'>| b2f3d8a239b34edfb50fa67c5aca8f83 |  demo |   True  | xxxxxxx@gmail.com |
</span><span class='line'>+----------------------------------+-------+---------+--------------------+
</span><span class='line'># keystone --os-tenant-name admin --os-username admin --os-password xxxxx --os-auth-url http://Controller:35357/v2.0 role-list
</span><span class='line'>+----------------------------------+----------+
</span><span class='line'>|                id                |   name   |
</span><span class='line'>+----------------------------------+----------+
</span><span class='line'>| 9fe2ff9ee4384b1894a90878d3e92bab | _member_ |
</span><span class='line'>| 65b6ccaa3b434c848ccb757be43d6b41 |  admin   |
</span><span class='line'>+----------------------------------+----------+
</span><span class='line'># keystone --os-tenant-name demo --os-username demo --os-password xxxxx --os-auth-url http://controller:35357/v2.0 token-get
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'>|  Property |              Value               |
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'>|  expires  |       2015-05-24T16:46:34Z       |
</span><span class='line'>|     id    | 0d8a9472b0f547dfabc62594b4fb146f |
</span><span class='line'>| tenant_id | 459c25933274483fb01ce66d9514add6 |
</span><span class='line'>|  user_id  | b2f3d8a239b34edfb50fa67c5aca8f83 |
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'># keystone --os-tenant-name demo --os-username demo --os-password xxxxx --os-auth-url http://controller:35357/v2.0 user-list
</span><span class='line'>You are not authorized to perform the requested action: admin_required (HTTP 403)
</span></code></pre></td></tr></table></div></figure>


<h3>创建脚本</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat admin-openrc.sh 
</span><span class='line'>export OS_TENANT_NAME=admin
</span><span class='line'>export OS_USERNAME=admin
</span><span class='line'>export OS_PASSWORD=xxxxx
</span><span class='line'>export OS_AUTH_URL=http://Controller:35357/v2.0
</span><span class='line'># cat demo-openrc.sh
</span><span class='line'>export OS_TENANT_NAME=demo
</span><span class='line'>export OS_USERNAME=demo
</span><span class='line'>export OS_PASSWORD=xxxxx
</span><span class='line'>export OS_AUTH_URL=http://Controller:5000/v2.0
</span></code></pre></td></tr></table></div></figure>


<p>下次使用时直接用<code>source admin-openrc.sh</code>或者<code>source demo-openrc.sh</code>即可。</p>

<h3>镜像服务</h3>

<p>添加镜像服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# mysql -u root -p
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 40
</span><span class='line'>Server version: 5.5.43-MariaDB-1ubuntu0.14.04.2 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; CREATE DATABASE glance;
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'xxxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'xxxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit;
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<p>创建glance用户:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># source  /home/dash/admin-openrc.sh
</span><span class='line'># keystone user-create --name glance --pass xxxxx
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |                                  |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | a3108e4267154acd809f3978d360e6cd |
</span><span class='line'>|   name   |              glance              |
</span><span class='line'>| username |              glance              |
</span><span class='line'>+----------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>赋予glance用户admin权限:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># keystone user-role-add --user glance --tenant service --role admin</span></code></pre></td></tr></table></div></figure>


<p>创建service entity和service end-point:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> keystone service-create --name glance --type image --description "OpenStack Image Service"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |     OpenStack Image Service      |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 8736ca50fdf741afb5fcc2d078b1cd9b |
</span><span class='line'>|     name    |              glance              |
</span><span class='line'>|     type    |              image               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone endpoint-create --service-id $(keystone service-list | awk '/ image / {print $2}') --publicurl http://Controller:9292 --internalurl http://Controller:9292 --adminurl http://Controller:9292 --region regionOne
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   adminurl  |      http://Controller:9292      |
</span><span class='line'>|      id     | 340f40f0558c4a5b8fa88089aee69767 |
</span><span class='line'>| internalurl |      http://Controller:9292      |
</span><span class='line'>|  publicurl  |      http://Controller:9292      |
</span><span class='line'>|    region   |            regionOne             |
</span><span class='line'>|  service_id | 8736ca50fdf741afb5fcc2d078b1cd9b |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>安装服务组件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install glance python-glanceclient</span></code></pre></td></tr></table></div></figure>


<p>配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/glance/glance-api.conf
</span><span class='line'>[database]
</span><span class='line'>...
</span><span class='line'>connection = mysql://glance:GLANCE_DBPASS@controller/glance
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>...
</span><span class='line'>auth_uri = http://controller:5000/v2.0
</span><span class='line'>identity_uri = http://controller:35357
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = glance
</span><span class='line'>admin_password = GLANCE_PASS
</span><span class='line'>[paste_deploy]
</span><span class='line'>...
</span><span class='line'>flavor = keystone
</span><span class='line'>[glance_store]
</span><span class='line'>...
</span><span class='line'>default_store = file
</span><span class='line'>filesystem_store_datadir = /var/lib/glance/images/
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>notification_driver = noop
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>verbose = True</span></code></pre></td></tr></table></div></figure>


<p>配置<code>/etc/glance/glance-registry.conf</code>文件，完成以下配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[database]
</span><span class='line'>...
</span><span class='line'>connection = mysql://glance:GLANCE_DBPASS@controller/glance
</span><span class='line'>
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>...
</span><span class='line'>auth_uri = http://controller:5000/v2.0
</span><span class='line'>identity_uri = http://controller:35357
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = glance
</span><span class='line'>admin_password = GLANCE_PASS
</span><span class='line'>[paste_deploy]
</span><span class='line'>...
</span><span class='line'>flavor = keystone
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>notification_driver = noop
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>notification_driver = noop</span></code></pre></td></tr></table></div></figure>


<p>同步数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># su -s /bin/sh -c "glance-manage db_sync" glance</span></code></pre></td></tr></table></div></figure>


<p>重启服务，删除默认的sqlite数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service glance-registry restart
</span><span class='line'># service glance-api restart
</span><span class='line'># rm -f /var/lib/glance/glance.sqlite
</span></code></pre></td></tr></table></div></figure>


<p>验证:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget http://download.cirros-cloud.net/0.3.3/cirros-0.3.3-x86_64-disk.img
</span><span class='line'># source ~/admin-openrc.sh
</span><span class='line'># glance image-create --name "cirros-0.3.3-x86_64" --file ~/cirros-0.3.3-x86_64-disk.img --disk-format qcow2 --container-format bare --is-public True --progress
</span><span class='line'>[=============================&gt;] 100%
</span><span class='line'>+------------------+--------------------------------------+
</span><span class='line'>| Property         | Value                                |
</span><span class='line'>+------------------+--------------------------------------+
</span><span class='line'>| checksum         | 133eae9fb1c98f45894a4e60d8736619     |
</span><span class='line'>| container_format | bare                                 |
</span><span class='line'>| created_at       | 2015-05-24T16:25:32                  |
</span><span class='line'>| deleted          | False                                |
</span><span class='line'>| deleted_at       | None                                 |
</span><span class='line'>| disk_format      | qcow2                                |
</span><span class='line'>| id               | 3d45ea58-731c-4eb5-bf30-db1b4bfe4f57 |
</span><span class='line'>| is_public        | True                                 |
</span><span class='line'>| min_disk         | 0                                    |
</span><span class='line'>| min_ram          | 0                                    |
</span><span class='line'>| name             | cirros-0.3.3-x86_64                  |
</span><span class='line'>| owner            | 6f5f440aa9de4b2fa205f43df073ddfa     |
</span><span class='line'>| protected        | False                                |
</span><span class='line'>| size             | 13200896                             |
</span><span class='line'>| status           | active                               |
</span><span class='line'>| updated_at       | 2015-05-24T16:25:32                  |
</span><span class='line'>| virtual_size     | None                                 |
</span><span class='line'>+------------------+--------------------------------------+
</span><span class='line'># glance image-list
</span><span class='line'>+--------------------------------------+---------------------+-------------+------------------+----------+--------+
</span><span class='line'>| ID                                   | Name                | Disk Format | Container Format | Size     | Status |
</span><span class='line'>+--------------------------------------+---------------------+-------------+------------------+----------+--------+
</span><span class='line'>| 3d45ea58-731c-4eb5-bf30-db1b4bfe4f57 | cirros-0.3.3-x86_64 | qcow2       | bare             | 13200896 | active |
</span><span class='line'>+--------------------------------------+---------------------+-------------+------------------+----------+--------+
</span></code></pre></td></tr></table></div></figure>


<p>控制节点基本上配置成功，明天继续。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[三节点搭建OpenStack Juno(1)]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno/"/>
    <updated>2015-05-24T14:36:34+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno</id>
    <content type="html"><![CDATA[<h3>目的</h3>

<p>最近在研究解耦OpenStack，以及OpenStack的各种网络模型，下面是一个最简单的用于搭建OpenStack Juno的过程。</p>

<h3>硬件及网络准备</h3>

<h4>物理服务器</h4>

<p>物理服务器:  i5-4460/32G 内存，128G SSD+3T IDE，事实上这个教程跑完你也用不到这么强悍的配置，理论上在8G的物理机器上就可以运行完本文。  <br/>
物理服务器操作系统: Ubuntu14.04</p>

<h4>虚拟机：</h4>

<p>虚拟机1, Controller: 1 processor, 2 GB memory, and 5 GB storage.  <br/>
虚拟机2, Network: 1 processor, 512 MB memory, and 5 GB storage.  <br/>
虚拟机3, Compute: 1 processor, 2 GB memory, and 10 GB storage.</p>

<h4>网络规划</h4>

<p>Management: 10.55.55.0/24, 只用于管理的网络，公网无法访问。简单来说，这个网络用于OpenStack各个组件之间的相互通信。      <br/>
Tunnel: 10.66.66.0/24, 用于计算节点和网络节点之间的通信。这个隧道使得虚拟机的实例可以和相互通信。  <br/>
External: 192.168.1.0/24, 用于虚拟机实例的Internet访问。 <br/>
当然我们可以添加额外的存储网络，这里为了简单起见我们不使用cinder服务，使用单纯的虚拟机镜像即可。</p>

<h4>节点网络名规划</h4>

<p>Controller节点:    controller.openstack.local, 10.55.55.2(管理网络), N/A, N/A.  <br/>
Network节点:    Network.openstack.local, 10.55.55.3(管理网络), 10.66.66.3(隧道网络), 192.168.1.3(Internet公网).
Compute节点:    Compute.openstack.local, 10.55.55.4(管理网络), 10.66.66.4(隧道网络).</p>

<p>一个参考的例图如下:  <br/>
<img src="http://purplepalmdash.github.io/images/2015_05_24_14_50_37_629x551.jpg" alt="/images/2015_05_24_14_50_37_629x551.jpg" /></p>

<p>按照上述的描述我们创建三台虚拟机，并进行初始化配置。</p>

<h3>虚拟机初始化配置</h3>

<p>下面罗列的代码是我在本机上的创建过程，仅供参考:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pwd
</span><span class='line'>/media/repo/Image/3NodeOpenStack
</span><span class='line'>$ qemu-img create -f qcow2 -b /media/repo/Image/UbuntuBase.qcow2 OpenStackController.qcow2
</span><span class='line'>Formatting 'OpenStackController.qcow2', fmt=qcow2 size=107374182400 backing_file='/media/repo/Image/UbuntuBase.qcow2' encryption=off cluster_size=65536 lazy_refcounts=off 
</span><span class='line'>$ qemu-img create -f qcow2 -b /media/repo/Image/UbuntuBase.qcow2 OpenStackNetwork.qcow2
</span><span class='line'>Formatting 'OpenStackNetwork.qcow2', fmt=qcow2 size=107374182400 backing_file='/media/repo/Image/UbuntuBase.qcow2' encryption=off cluster_size=65536 lazy_refcounts=off 
</span><span class='line'>$ qemu-img create -f qcow2 -b /media/repo/Image/UbuntuBase.qcow2 OpenStackCompute.qcow2
</span><span class='line'>Formatting 'OpenStackCompute.qcow2', fmt=qcow2 size=107374182400 backing_file='/media/repo/Image/UbuntuBase.qcow2' encryption=off cluster_size=65536 lazy_refcounts=off 
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>创建虚拟机的时候， OpenStackCompute节点需要把CPU的参数带下去，如下图所示:  <br/>
<img src="http://purplepalmdash.github.io/images/2015_05_24_15_00_07_517x483.jpg" alt="/images/2015_05_24_15_00_07_517x483.jpg" /></p>

<p>各个节点的network定义文件如下:</p>

<p>控制节点:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># The loopback network interface
</span><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'># The primary network interface
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet static
</span><span class='line'>address 10.55.55.2
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>gateway 10.55.55.1
</span><span class='line'>dns-nameservers 114.114.114.114</span></code></pre></td></tr></table></div></figure>


<p>网络节点:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># The loopback network interface
</span><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'># The primary network interface
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet static
</span><span class='line'>address 10.55.55.3
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>gateway 10.55.55.1
</span><span class='line'>dns-nameservers 114.114.114.114
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>auto eth1
</span><span class='line'>iface eth1 inet static
</span><span class='line'>address 10.66.66.3
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>
</span><span class='line'>auto eth2
</span><span class='line'>iface eth2 inet static
</span><span class='line'>address 192.168.1.3
</span><span class='line'>netmask 255.255.255.0</span></code></pre></td></tr></table></div></figure>


<p>计算节点:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'># The primary network interface
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet static
</span><span class='line'>address 10.55.55.4
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>gateway 10.55.55.1
</span><span class='line'>dns-nameservers 114.114.114.114
</span><span class='line'>
</span><span class='line'>auto eth1
</span><span class='line'>iface eth1 inet static
</span><span class='line'>address 10.66.66.4
</span><span class='line'>netmask 255.255.255.0
</span></code></pre></td></tr></table></div></figure>


<p>每个节点分别更改其<code>/etc/hostname</code>为对应的名字，而每台机器上的<code>/etc/hosts</code>也做对应的修改，例如Controlle节点上的例子如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/hosts
</span><span class='line'>127.0.0.1       localhost
</span><span class='line'>127.0.1.1       Controller
</span><span class='line'>10.55.55.2      Controller
</span><span class='line'>10.55.55.3      Network
</span><span class='line'>10.55.55.4      Compute
</span><span class='line'>......
</span><span class='line'>
</span><span class='line'>$ cat /etc/hostname
</span><span class='line'>Controller
</span></code></pre></td></tr></table></div></figure>


<p>网络配置完毕后，保证可以通过<code>ping Controller</code>等命令达到互通。</p>

<p>在进入到后续步骤前，更新所有节点到最新状态:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get update && sudo apt-get upgrade && sudo apt-get dist-upgrade && sudo reboot</span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>NTP 服务器/客户端配置</h3>

<p>使用NTP来保证各个节点之间的时间同步，对后续加入的各个节点，同样需要使用NTP来同步该节点时间。我们将Controller作为NTP服务器,在Controller上，安装和配置NTP服务器：</p>

<h4>NTP服务器</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get -y install ntp
</span><span class='line'># vim /etc/ntp.conf
</span><span class='line'>    # 修改成大陆时间
</span><span class='line'>    server 2.cn.pool.ntp.org
</span><span class='line'>    server 1.asia.pool.ntp.org
</span><span class='line'>    server 2.asia.pool.ntp.org
</span><span class='line'>    # 修改 restrict 設定
</span><span class='line'>    restrict -4 default kod notrap nomodify
</span><span class='line'>    restrict -6 default kod notrap nomodify
</span><span class='line'># service ntp restart</span></code></pre></td></tr></table></div></figure>


<h4>NTP客户端</h4>

<p>其他的节点上都需要安装NTP客户端并使用NTP服务器时间同步。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get -y install ntp
</span><span class='line'># vim /etc/ntp.conf
</span><span class='line'>    # 設定 controller 為參照的 time server
</span><span class='line'>    # 並將其他 server 開頭的設定進行註解
</span><span class='line'>    server 10.55.55.2 iburst
</span><span class='line'># service ntp restart</span></code></pre></td></tr></table></div></figure>


<p>检查结果是否正确:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# ntpq -c peers
</span><span class='line'>     remote           refid      st t when poll reach   delay   offset  jitter
</span><span class='line'>==============================================================================
</span><span class='line'> Controller  59.106.180.168   3 u    1   64    1    0.239  447024.   0.049</span></code></pre></td></tr></table></div></figure>


<p>接下来真正进入OpenStack的安装和配置过程。</p>

<h3>源设定</h3>

<p>Juno的源没有被包含在Ubuntu14.04的官方源中(官方源中版本为IceHouse)，所以通过下列命令添加OpenStack Juno源:   <br/>
所有节点上(Controller,Network,Compute):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install ubuntu-cloud-keyring
</span><span class='line'>$ sudo bash
</span><span class='line'># echo "deb http://ubuntu-cloud.archive.canonical.com/ubuntu" "trusty-updates/juno main" &gt; /etc/apt/sources.list.d/cloudarchive-juno.list
</span><span class='line'># apt-get update && apt-get -y dist-upgrade</span></code></pre></td></tr></table></div></figure>


<p>第一部分就先到这里。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Use Apt-cacher for Speeding Up Deployment]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/23/use-apt-cacher-for-speeding-up-deployment/"/>
    <updated>2015-05-23T08:27:55+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/23/use-apt-cacher-for-speeding-up-deployment</id>
    <content type="html"><![CDATA[<h3>Installation</h3>

<p>Install apt-cacher via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install apt-cacher</span></code></pre></td></tr></table></div></figure>


<p>Choose &ldquo;Daemon&rdquo; When you see following picture:</p>

<p><img src="http://purplepalmdash.github.io/images/2015_05_23_08_28_39_418x264.jpg" alt="/images/2015_05_23_08_28_39_418x264.jpg" /></p>

<h3>Configuration</h3>

<p>Make sure the configuration <code>AUTOSTART=1</code> in <code>/etc/default/apt-cacher</code>.</p>

<p>Enable <code>allowed_hosts=*</code> in <code>/etc/apt-cacher/apt-cacher.conf</code>.</p>

<p>Now restart the machine, and check the apt-cacher service via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ps -ef | grep apt
</span><span class='line'>www-data   825     1  0 20:34 ?        00:00:00 /usr/bin/perl /usr/sbin/apt-cacher -R 3 -d -p /var/run/apt-cacher.pid
</span><span class='line'>$ sudo netstat -anp | grep 3142
</span><span class='line'>tcp6       0      0 :::3142                 :::*                    LISTEN      825/perl</span></code></pre></td></tr></table></div></figure>


<p>Now when you setup the machines, point the http-proxy into this machine, it will automatically cache the packages.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Change Cobbler Profile for Using Local Repository]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/22/change-cobbler-profile-for-using-local-repository/"/>
    <updated>2015-05-22T14:12:58+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/22/change-cobbler-profile-for-using-local-repository</id>
    <content type="html"><![CDATA[<h3>Cobbler Profiles</h3>

<p>For getting the profiles and get the detailed information of the profile.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cobbler profile list
</span><span class='line'>   ubuntu1404-x86_64
</span><span class='line'># cobbler profile help
</span><span class='line'>usage
</span><span class='line'>=====
</span><span class='line'>cobbler profile add
</span><span class='line'>cobbler profile copy
</span><span class='line'>cobbler profile dumpvars
</span><span class='line'>cobbler profile edit
</span><span class='line'>cobbler profile find
</span><span class='line'>cobbler profile getks
</span><span class='line'>cobbler profile list
</span><span class='line'>cobbler profile remove
</span><span class='line'>cobbler profile rename
</span><span class='line'>cobbler profile report
</span><span class='line'># cobbler profile report ubuntu1404-x86_64
</span><span class='line'>......
</span><span class='line'>Kickstart                      : /var/lib/cobbler/kickstarts/sample.seed
</span><span class='line'>......
</span></code></pre></td></tr></table></div></figure>


<h3>Use Local Repository</h3>

<p>For adding the repository via following command, you could use your local repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo cobbler repo add --name=local-trusty --breed=apt --arch=x86_64 --mirror=http://xxxxxxxxxxxxxx/ubuntu --apt-components=main,restricted,universe,multiverse --apt-dists=trusty,trusty-updates,trusty-security
</span><span class='line'>$ sudo cobbler repo sync</span></code></pre></td></tr></table></div></figure>


<p>After syncing, the folder will contains all of the packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># pwd
</span><span class='line'>/var/www/cobbler/ks_mirror/ubuntu1404-x86_64
</span><span class='line'># ls
</span><span class='line'>boot  dists  doc  EFI  install  isolinux  md5sum.txt  pics  pool  preseed  README.diskdefines  ubuntu</span></code></pre></td></tr></table></div></figure>


<p>Edit the sample seed via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cp /var/lib/cobbler/kickstarts/sample.seed /var/lib/cobbler/kickstarts/local.seed
</span><span class='line'># vim /var/lib/cobbler/kickstarts/local.seed
</span><span class='line'>
</span><span class='line'>    d-i mirror/http/hostname string $http_server
</span><span class='line'>    # d-i mirror/http/directory string $install_source_directory
</span><span class='line'>    d-i mirror/http/directory string /cobbler/ks_mirror/ubuntu1404-x86_64/ubuntu/</span></code></pre></td></tr></table></div></figure>


<p>Then Modify the profile&rsquo;s kickstart via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#  cobbler profile edit --name=ubuntu1404-x86_64 --kickstart=/var/lib/cobbler/kickstarts/local.seed</span></code></pre></td></tr></table></div></figure>


<p>After modification, next time if you re-install the compute, it will directly get the packages from the local repository.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup CentOS6/7 Local Repository]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/20/setup-centos6-slash-7-local-repository/"/>
    <updated>2015-05-20T11:32:56+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/20/setup-centos6-slash-7-local-repository</id>
    <content type="html"><![CDATA[<p>For speeding up the deployment, I have to setup the local repository for CentOS6/7, following is the steps for setting up such two repositories.  <br/>
The steps are followed by following URL:  <br/>
<a href="https://support.opennodecloud.com/wiki/doku.php?id=usrdoc:os:repomirror">https://support.opennodecloud.com/wiki/doku.php?id=usrdoc:os:repomirror</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /etc/yum.repos.d/
</span><span class='line'># curl -O https://copr.fedoraproject.org/coprs/baurzhanm/mrepo/repo/epel-6/baurzhanm-mrepo-epel-6.repo
</span><span class='line'># vim baurzhanm-mrepo-epel-6.repo
</span><span class='line'># yum update
</span><span class='line'># yum -y install screen lftp httpd mrepo
</span><span class='line'># vim mrepo.conf
</span><span class='line'>    ### Configuration file for mrepo
</span><span class='line'>    
</span><span class='line'>    ### The [main] section allows to override mrepo's default settings
</span><span class='line'>    ### The mrepo-example.conf gives an overview of all the possible settings
</span><span class='line'>    [main]
</span><span class='line'>    srcdir = /var/mrepo
</span><span class='line'>    wwwdir = /var/www/mrepo
</span><span class='line'>    confdir = /etc/mrepo.conf.d
</span><span class='line'>    arch = x86_64
</span><span class='line'>    
</span><span class='line'>    mailto = root@localhost
</span><span class='line'>    smtp-server = localhost
</span><span class='line'>    
</span><span class='line'>    #rhnlogin = username:password
</span><span class='line'>    
</span><span class='line'>    ### Any other section is considered a definition for a distribution
</span><span class='line'>    ### You can put distribution sections in /etc/mrepo.conf.d/
</span><span class='line'>    ### Examples can be found in the documentation at:
</span><span class='line'>    ###     /usr/share/doc/mrepo-0.8.9/dists/.</span></code></pre></td></tr></table></div></figure>


<p>Add the configuration files for CentOS 6:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim  /etc/mrepo.conf.d/centos6.conf
</span><span class='line'>[centos6]
</span><span class='line'>name = CentOS $release ($arch)
</span><span class='line'>release = 6
</span><span class='line'>arch = x86_64
</span><span class='line'>metadata = yum repomd
</span><span class='line'>
</span><span class='line'>#iso = http://mirrors.aliyun.com/centos/$release/isos/$arch/CentOS-6.6-x86_64-bin-DVD?.iso
</span><span class='line'>#os = http://mirrors.aliyun.com/centos/$release/os/$arch/Packages/ 
</span><span class='line'>#updates = http://mirrors.aliyun.com/centos/$release/updates/$arch/Packages/
</span><span class='line'>extras = http://mirrors.aliyun.com/centos/$release/extras/$arch/Packages/
</span><span class='line'>epel = http://mirrors.aliyun.com/epel/$release/$arch/</span></code></pre></td></tr></table></div></figure>


<p>Add configuraiton files for CentOS 7:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim  /etc/mrepo.conf.d/centos7.conf
</span><span class='line'>[centos7]
</span><span class='line'>name = CentOS $release ($arch)
</span><span class='line'>release = 7
</span><span class='line'>arch = x86_64
</span><span class='line'>metadata = yum repomd
</span><span class='line'>
</span><span class='line'>#iso = http://mirrors.aliyun.com/centos/$release/isos/$arch/CentOS-7.0-1406-x86_64-DVD.iso
</span><span class='line'>#os = http://mirrors.aliyun.com/centos/$release/os/$arch/Packages/ 
</span><span class='line'>#updates = http://mirrors.aliyun.com/centos/$release/updates/$arch/Packages/
</span><span class='line'>#epel = http://mirrors.aliyun.com/epel/$release/$arch/
</span><span class='line'>extra=http://mirrors.aliyun.com/centos/$release/extras/$arch/Packages/</span></code></pre></td></tr></table></div></figure>


<p>Use following comands for initial sync, it will take a very~long~long~long time.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mrepo -g -u -vvv [centos6|centos7]</span></code></pre></td></tr></table></div></figure>


<p>After syncing, add definition into the apache&rsquo;s configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vi /etc/httpd/conf.d/mrepo.conf
</span><span class='line'>--- ADD ---
</span><span class='line'>AddDescription "CentOS 6 for x86" centos6-i386
</span><span class='line'>AddDescription "CentOS 6 for x86_64" centos6-x86_64
</span><span class='line'>AddDescription "CentOS 7 for x86" centos7-i386
</span><span class='line'>AddDescription "CentOS 7 for x86_64" centos7-x86_64
</span><span class='line'>--- ADD ---
</span><span class='line'># Add repofile for CentOS 6 mirror
</span><span class='line'>cat &lt;&lt; 'EOF' &gt; /var/www/mrepo/centos6-x86_64/CentOS-local-http.repo 
</span><span class='line'>#
</span><span class='line'># CentOS-local-http.repo
</span><span class='line'>#
</span><span class='line'> 
</span><span class='line'>[0-base]
</span><span class='line'>name=CentOS-local-base
</span><span class='line'>baseurl=http://mirror.local.int/mrepo/centos6-x86_64/RPMS.os/
</span><span class='line'>gpgcheck=0
</span><span class='line'> 
</span><span class='line'>[0-updates]
</span><span class='line'>name=CentOS-local-updates
</span><span class='line'>baseurl=http://mirror.local.int/mrepo/centos6-x86_64/RPMS.updates/
</span><span class='line'>gpgcheck=0
</span><span class='line'>EOF
</span><span class='line'> 
</span><span class='line'># Add repofile for CentOS 7 mirror
</span><span class='line'>cat &lt;&lt; 'EOF' &gt; /var/www/mrepo/centos7-x86_64/CentOS-local-http.repo 
</span><span class='line'>#
</span><span class='line'># CentOS-local-http.repo
</span><span class='line'>#
</span><span class='line'> 
</span><span class='line'>[0-base]
</span><span class='line'>name=CentOS-local-base
</span><span class='line'>baseurl=http://mirror.local.int/mrepo/centos7-x86_64/RPMS.os/
</span><span class='line'>gpgcheck=0
</span><span class='line'> 
</span><span class='line'>[0-updates]
</span><span class='line'>name=CentOS-local-updates
</span><span class='line'>baseurl=http://mirror.local.int/mrepo/centos7-x86_64/RPMS.updates/
</span><span class='line'>gpgcheck=0
</span><span class='line'>EOF
</span><span class='line'> 
</span><span class='line'># chkconfig httpd on
</span><span class='line'># service httpd restart
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup Local Repository]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/19/setup-local-repository/"/>
    <updated>2015-05-19T11:57:19+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/19/setup-local-repository</id>
    <content type="html"><![CDATA[<h3>Ubuntu</h3>

<p>After using apt-mirror syncing all of the packages from the repository website, setup a ftp site:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install -y proftpd
</span><span class='line'># cat conf.d/anonymous.conf 
</span><span class='line'>&lt;Anonymous ~ftp&gt;
</span><span class='line'>   User                    ftp
</span><span class='line'>   Group                nogroup
</span><span class='line'>   UserAlias         anonymous ftp
</span><span class='line'>   RequireValidShell        off
</span><span class='line'>#   MaxClients                   10
</span><span class='line'>   &lt;Directory *&gt;
</span><span class='line'>     &lt;Limit WRITE&gt;
</span><span class='line'>       DenyAll
</span><span class='line'>     &lt;/Limit&gt;
</span><span class='line'>   &lt;/Directory&gt;
</span><span class='line'> &lt;/Anonymous&gt;
</span><span class='line'>#  mount --bind /mnt/myrepo/mirror/mirrors.aliyun.com/ /srv/ftp/
</span><span class='line'># service proftpd restart</span></code></pre></td></tr></table></div></figure>


<p>Now Open your browser to <code>ftp://Your_URL/</code>, you will find the repository available.</p>

<h3>CentOS Proftpd</h3>

<p>Just remember the default directory is located at <code>/var/ftp</code>,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum install -y proftpd
</span><span class='line'># mount --bind /mirror/mirrors.aliyun.com/ /var/ftp/
</span><span class='line'># service proftpd restart</span></code></pre></td></tr></table></div></figure>


<h3>Client Configuration</h3>

<p>Replace the URL into your ftp url:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/apt/sources.list
</span><span class='line'>deb ftp://YourURL/ubuntu/ trusty main restricted universe multiverse
</span><span class='line'>deb ftp://YourURL/ubuntu/ trusty-security main restricted universe multiverse
</span><span class='line'>deb ftp://YourURL/ubuntu/ trusty-updates main restricted universe multiverse
</span><span class='line'>deb ftp://YourURL/ubuntu/ trusty-proposed main restricted universe multiverse
</span><span class='line'>deb ftp://YourURL/ubuntu/ trusty-backports main restricted universe multiverse
</span><span class='line'>deb-src ftp://YourURL/ubuntu/ trusty main restricted universe multiverse
</span><span class='line'>deb-src ftp://YourURL/ubuntu/ trusty-security main restricted universe multiverse
</span><span class='line'>deb-src ftp://YourURL/ubuntu/ trusty-updates main restricted universe multiverse
</span><span class='line'>deb-src ftp://YourURL/ubuntu/ trusty-proposed main restricted universe multiverse
</span><span class='line'>deb-src ftp://YourURL/ubuntu/ trusty-backports main restricted universe multiverse
</span><span class='line'># apt-get update && apt-get upgrade </span></code></pre></td></tr></table></div></figure>


<p>Using local repository will greately improve your development speed.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My Configuration on Cobbler for Deploying Ubuntu12.04]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/18/my-configuration-on-cobbler-for-deploying-ubuntu12-dot-04/"/>
    <updated>2015-05-18T18:15:47+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/18/my-configuration-on-cobbler-for-deploying-ubuntu12-dot-04</id>
    <content type="html"><![CDATA[<p>Configuration file for preseed, put it under: /var/lib/cobbler/kickstarts/autoinstall.seed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># BASIC
</span><span class='line'>d-i  debian-installer/locale    string en_US.UTF-8
</span><span class='line'>d-i  debian-installer/splash    boolean false
</span><span class='line'>d-i  console-setup/ask_detect   boolean false
</span><span class='line'>d-i  console-setup/layoutcode   string us
</span><span class='line'>d-i  console-setup/variantcode  string
</span><span class='line'>d-i  clock-setup/utc            boolean true
</span><span class='line'>d-i  clock-setup/ntp            boolean true
</span><span class='line'>
</span><span class='line'># DISKPART
</span><span class='line'>d-i  partman-auto/method                string regular
</span><span class='line'>d-i  partman-lvm/device_remove_lvm      boolean true
</span><span class='line'>d-i  partman-lvm/confirm                boolean true
</span><span class='line'>d-i  partman/confirm_write_new_label    boolean true
</span><span class='line'>d-i  partman/choose_partition           select Finish partitioning and write changes to disk
</span><span class='line'>d-i  partman/confirm                    boolean true
</span><span class='line'>d-i  partman/confirm_nooverwrite        boolean true
</span><span class='line'>d-i  partman/default_filesystem         string ext3
</span><span class='line'>
</span><span class='line'># SOFTWARE
</span><span class='line'># /var/www/cobbler/ks_mirror/Ubuntu12.04-x86_64/ubuntu/
</span><span class='line'>d-i  mirror/country             string manual
</span><span class='line'>d-i  mirror/http/hostname       string $http_server
</span><span class='line'>d-i  mirror/http/directory      string /cobbler/ks_mirror/Ubuntu12.04-x86_64/ubuntu
</span><span class='line'>d-i  mirror/http/proxy          string
</span><span class='line'>d-i  apt-setup/security_host    string $http_server
</span><span class='line'>d-i  apt-setup/security_path    string /cobbler/ks_mirror/Ubuntu12.04-x86_64/ubuntu
</span><span class='line'>d-i  apt-setup/services-select  multiselect none
</span><span class='line'>d-i  pkgsel/upgrade             select none
</span><span class='line'>d-i  pkgsel/language-packs      multiselect
</span><span class='line'>d-i  pkgsel/update-policy       select none
</span><span class='line'>d-i  pkgsel/updatedb            boolean true
</span><span class='line'>d-i  pkgsel/include             string openssh-server
</span><span class='line'>
</span><span class='line'># USER
</span><span class='line'>d-i  passwd/root-login                  boolean true
</span><span class='line'>d-i  passwd/make-user                   boolean false
</span><span class='line'>d-i  passwd/root-password               password root
</span><span class='line'>d-i  passwd/root-password-again         password root
</span><span class='line'>d-i  user-setup/allow-password-weak     boolean true
</span><span class='line'>
</span><span class='line'># FINISH
</span><span class='line'>d-i  grub-installer/skip                boolean false
</span><span class='line'>d-i  lilo-installer/skip                boolean false
</span><span class='line'>d-i  grub-installer/only_debian         boolean true
</span><span class='line'>d-i  grub-installer/with_other_os       boolean true
</span><span class='line'>d-i  finish-install/keep-consoles       boolean false
</span><span class='line'>d-i  finish-install/reboot_in_progress  note
</span><span class='line'>d-i  cdrom-detect/eject                 boolean true
</span><span class='line'>d-i  debian-installer/exit/halt         boolean false
</span><span class='line'>d-i  debian-installer/exit/poweroff     boolean false
</span><span class='line'>
</span><span class='line'># EXTRA
</span><span class='line'>d-i  preseed/late_command       string echo "UseDNS no" &gt;&gt; /target/etc/ssh/sshd_config
</span></code></pre></td></tr></table></div></figure>


<p>Edit the profile via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cobbler profile list
</span><span class='line'>$ cobbler profile edit --name=Ubuntu12.04-x86_64 --kickstart=/var/lib/cobbler/kickstarts/autoinstall.seed </span></code></pre></td></tr></table></div></figure>


<p>Now select the installation, your installation will use local repository.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Re-Orgnize Blog]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/16/re-orgnize-blog/"/>
    <updated>2015-05-16T10:53:00+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/16/re-orgnize-blog</id>
    <content type="html"><![CDATA[<p>Since my last blog touched something special, I have to delete the whole repository and re-orgnize the structure again. This time I also use Octopress, but the version has been upgraded to the 3.0, this article records the steps.</p>

<h3>Github Account</h3>

<p>Register a new account, and verrify the email, add your own ssh key, test it via ssh -T <a href="&#109;&#x61;&#x69;&#108;&#x74;&#111;&#58;&#x67;&#x69;&#x74;&#x40;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;">&#103;&#x69;&#116;&#x40;&#x67;&#x69;&#116;&#104;&#x75;&#x62;&#x2e;&#x63;&#x6f;&#x6d;</a></p>

<h3>Repository</h3>

<p>Get the latest repository via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/imathis/octopress.git
</span></code></pre></td></tr></table></div></figure>


<p>Configuration of the konsole, enable the <code>zsh -l</code> at the login shell.   Settings-> Edit Current Profile-> General -> Command(/bin/zsh -l)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rvm use 1.9.3
</span><span class='line'>$ ruby --version
</span><span class='line'>ruby 1.9.3p547 (2014-05-14 revision 45962) [x86_64-linux]
</span><span class='line'>$ gem install bundler
</span><span class='line'>$ vim Gemfile
</span><span class='line'>#source "https://rubygems.org"
</span><span class='line'>source "http://mirrors.aliyun.com/rubygems/"
</span><span class='line'>$ bundle install
</span><span class='line'>$ rake install
</span></code></pre></td></tr></table></div></figure>


<p>Now the basic configuration of the repository has been added.</p>

<h3>Plugins</h3>

<p>For adding videos:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/manojlds/octopress-plugins.git
</span><span class='line'>$ cd octopress
</span><span class='line'>$ cd plugins
</span><span class='line'>$ cp ../../octopress-plugins/youtube.rb ./
</span></code></pre></td></tr></table></div></figure>


<h3>Encryption</h3>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a More Intelligent OpenWRT Router]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/14/setup-a-more-intelligent-openwrt-router/"/>
    <updated>2015-05-14T21:01:00+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/14/setup-a-more-intelligent-openwrt-router</id>
    <content type="html"><![CDATA[<h3>Openssh-Server</h3>

<p>The default sshd is provided by dropbear, the functionality is not good, so I have to replace it with openssh-server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@OpenWrt:~# uci set dropbear.@dropbear[0].Port=2222
</span><span class='line'>root@OpenWrt:~# uci commit dropbear
</span><span class='line'>root@OpenWrt:~# /etc/init.d/dropbear restart
</span><span class='line'>root@OpenWrt:~# opkg install openssh-server
</span><span class='line'>root@OpenWrt:~# opkg install openssh-client
</span></code></pre></td></tr></table></div></figure>


<p>Configure the OpenSSH:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/init.d/sshd enable
</span><span class='line'># /etc/init.d/sshd start
</span><span class='line'># /etc/init.d/dropbear disable
</span><span class='line'># /etc/init.d/dropbear stop
</span></code></pre></td></tr></table></div></figure>


<p>The next time you login will ask you for changing your password, do it and continue for using ssh.</p>

<h3>ShadowSocks and DNS</h3>

<p>For ShadowSocks you could refer to my previous blogs. <br/>
DNS Server is for automatically analyze the dns in server, install it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo yum install dnsmasq
</span></code></pre></td></tr></table></div></figure>


<p>Configure it to another port rather than the default 53.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redsocks 翻墙
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup the Cobbler Server]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/14/setup-the-cobbler-server/"/>
    <updated>2015-05-14T09:38:00+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/14/setup-the-cobbler-server</id>
    <content type="html"><![CDATA[<p>The reference material is mainly from:  <br/>
<a href="http://www.cobblerd.org/manuals/quickstart/">http://www.cobblerd.org/manuals/quickstart/</a></p>

<h3>Prepartion</h3>

<p>First install the CentOS6.6, choose the basic server. <br/>
After installation, update to the latest system via <code>yum -y update</code>. <br/>
Disable the SELinux via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/selinux/config
</span><span class='line'>#SELINUX=enforcing                                                                                                                       │
</span><span class='line'>SELINUX=disabled 
</span></code></pre></td></tr></table></div></figure>


<p>Then restart the compute.  <br/>
Add epel repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
</span><span class='line'># yum update
</span><span class='line'># yum install -y cobbler cobbler-web
</span></code></pre></td></tr></table></div></figure>


<h3>Configuration</h3>

<p>Change the default password:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># openssl passwd -1                                                                                                     │
</span><span class='line'>Password:                                                                                                                                 │
</span><span class='line'>Verifying - Password:                                                                                                                     │
</span><span class='line'>igaowugoauwgoueougo
</span><span class='line'>[root@CobblerServer ~]# vim /etc/cobbler/settings          
</span><span class='line'>default_password_crypted: "agowuoguwoawoguwoe"
</span></code></pre></td></tr></table></div></figure>


<p>Set the Server and Next_Server to the specified IP Address, DO NOT use 0.0.0.0:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># default, localhost
</span><span class='line'>server: 10.3.3.3.
</span><span class='line'>
</span><span class='line'># default, localhost
</span><span class='line'>next_server: 10.3.3.3
</span></code></pre></td></tr></table></div></figure>


<p>Enable the dhcp managed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>manage_dhcp: 0
</span></code></pre></td></tr></table></div></figure>


<p>Edit the dhcp template via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vi /etc/cobbler/dhcp.template
</span><span class='line'>subnet 10.3.3.0 netmask 255.255.255.0 {
</span><span class='line'>     option routers             10.3.3.1;                                                                                                  
</span><span class='line'>     range dynamic-bootp        10.3.3.4 10.3.3.254;
</span><span class='line'>     option domain-name-servers 114.114.114.114, 8.8.8.8;     
</span><span class='line'>     option subnet-mask         255.255.255.0;         
</span><span class='line'>     filename                   "/pxelinux.0";       
</span><span class='line'>     default-lease-time         21600;           
</span><span class='line'>     max-lease-time             43200;      
</span><span class='line'>     next-server                $next_server; 
</span><span class='line'>}          
</span></code></pre></td></tr></table></div></figure>


<p>Start and check the service status:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@CobblerServer ~]# service cobblerd start                                                                                           
</span><span class='line'>Starting cobbler daemon:                                   [  OK  ]
</span><span class='line'>[root@CobblerServer ~]# chkconfig cobblerd on                     
</span><span class='line'>[root@CobblerServer ~]# chkconfig httpd on                     
</span><span class='line'>[root@CobblerServer ~]# service cobblerd status                  
</span><span class='line'>cobblerd (pid 1564) is running...     
</span></code></pre></td></tr></table></div></figure>


<p>Better you restart the machine and verify your installation via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@CobblerServer ~]# cobbler check
</span><span class='line'>The following are potential configuration items that you may want to fix:
</span><span class='line'>
</span><span class='line'>1 : dhcpd is not installed
</span><span class='line'>2 : some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run 'cobbler get-loaders' to download them, or, if you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The 'cobbler get-loaders' command is the easiest way to resolve these requirements.
</span><span class='line'>3 : change 'disable' to 'no' in /etc/xinetd.d/rsync
</span><span class='line'>4 : since iptables may be running, ensure 69, 80/443, and 25151 are unblocked
</span><span class='line'>5 : debmirror package is not installed, it will be required to manage debian deployments and repositories
</span><span class='line'>6 : ksvalidator was not found, install pykickstart
</span><span class='line'>7 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them
</span></code></pre></td></tr></table></div></figure>


<p>OOOOPs, so many errors, so first install dhcpd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum install -y dhcpd
</span><span class='line'># chkconfig dhcpd on
</span><span class='line'># chkconfig xinetd on
</span></code></pre></td></tr></table></div></figure>


<p>Manullly edit the dhcpd configuration file as in following files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@CobblerServer ~]# cat /etc/dhcp/dhcpd.conf 
</span><span class='line'>#
</span><span class='line'># DHCP Server Configuration file.
</span><span class='line'>#   see /usr/share/doc/dhcp*/dhcpd.conf.sample
</span><span class='line'>#   see 'man 5 dhcpd.conf'
</span><span class='line'>#
</span><span class='line'># create new
</span><span class='line'># specify domain name
</span><span class='line'>option domain-name "server.world";
</span><span class='line'># specify name server's hostname or IP address
</span><span class='line'>option domain-name-servers 114.114.114.114;
</span><span class='line'># default lease time
</span><span class='line'>default-lease-time 600;
</span><span class='line'># max lease time
</span><span class='line'>max-lease-time 7200;
</span><span class='line'># this DHCP server to be declared valid
</span><span class='line'>authoritative;
</span><span class='line'># specify network address and subnet mask
</span><span class='line'>subnet 10.3.3.0 netmask 255.255.255.0 {
</span><span class='line'>    # specify the range of lease IP address
</span><span class='line'>    range dynamic-bootp 10.3.3.4 10.3.3.254;
</span><span class='line'>    # specify broadcast address
</span><span class='line'>    option broadcast-address 10.3.3.255;
</span><span class='line'>    # specify default gateway
</span><span class='line'>    option routers 10.3.3.1;
</span><span class='line'>}
</span><span class='line'># service dhcpd restart
</span></code></pre></td></tr></table></div></figure>


<p>One trouble after another, solve them:  <br/>
Get Loaders:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@CobblerServer ~]# cobbler get-loaders
</span></code></pre></td></tr></table></div></figure>


<p>Enable the rsync configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  # vim /etc/xinetd.d/rsync 
</span><span class='line'>        disable = no
</span></code></pre></td></tr></table></div></figure>


<p>Add the following lines into the /etc/sysconfig/iptables:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:OUTPUT ACCEPT [0:0]
</span><span class='line'>-A INPUT -p udp -m multiport --dports 69,80,443,25151 -j ACCEPT 
</span><span class='line'>-A INPUT -p tcp -m multiport --dports 69,80,443,25151 -j ACCEPT 
</span><span class='line'>-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</span></code></pre></td></tr></table></div></figure>


<p>Or:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># iptables -I INPUT -p udp -m multiport --dports 69,80,443,25151 -j ACCEPT
</span><span class='line'># iptables -I INPUT -p tcp -m multiport --dports 69,80,443,25151 -j ACCEPT
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>The difference is the latter won&rsquo;t last for long once the machine got restarted.</p>

<p>Install following packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@CobblerServer ~]# yum install -y debmirror pykickstart cman
</span></code></pre></td></tr></table></div></figure>


<p>Now check again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cobbler check
</span><span class='line'>$ cobbler sync
</span></code></pre></td></tr></table></div></figure>


<h3>Import ISO</h3>

<p>I use the CentOS7 iso(CentOS-7-x86_64-Everything-1503-01.iso).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@CobblerServer ~]# mount -o loop -t iso9660 ./CentOS-7-x86_64-Everything-1503-01.iso  /mnt
</span><span class='line'>[root@CobblerServer ~]# cobbler import --name=CentOS-7 --arch=x86_64 --path=/mnt
</span><span class='line'>path=/mnt
</span><span class='line'>task started: 2015-05-14_035209_import
</span><span class='line'>task started (id=Media import, time=Thu May 14 03:52:09 2015)
</span><span class='line'>Found a candidate signature: breed=redhat, version=rhel6
</span><span class='line'>Found a candidate signature: breed=redhat, version=rhel7
</span><span class='line'>Found a matching signature: breed=redhat, version=rhel7
</span><span class='line'>Adding distros from path /var/www/cobbler/ks_mirror/CentOS-7-x86_64:
</span><span class='line'>creating new distro: CentOS-7-x86_64
</span><span class='line'>trying symlink: /var/www/cobbler/ks_mirror/CentOS-7-x86_64 -&gt; /var/www/cobbler/links/CentOS-7-x86_64
</span><span class='line'>creating new profile: CentOS-7-x86_64
</span><span class='line'>associating repos
</span><span class='line'>checking for rsync repo(s)
</span><span class='line'>checking for rhn repo(s)
</span><span class='line'>checking for yum repo(s)
</span><span class='line'>starting descent into /var/www/cobbler/ks_mirror/CentOS-7-x86_64 for CentOS-7-x86_64
</span><span class='line'>processing repo at : /var/www/cobbler/ks_mirror/CentOS-7-x86_64
</span><span class='line'>need to process repo/comps: /var/www/cobbler/ks_mirror/CentOS-7-x86_64
</span><span class='line'>looking for /var/www/cobbler/ks_mirror/CentOS-7-x86_64/repodata/*comps*.xml
</span><span class='line'>Keeping repodata as-is :/var/www/cobbler/ks_mirror/CentOS-7-x86_64/repodata
</span><span class='line'>*** TASK COMPLETE ***
</span></code></pre></td></tr></table></div></figure>


<p>Check it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@CobblerServer ~]# cobbler distro list
</span><span class='line'>   CentOS-7-x86_64
</span><span class='line'>[root@CobblerServer ~]# cobbler profile list
</span><span class='line'>   CentOS-7-x86_64
</span><span class='line'>[root@CobblerServer ~]# cobbler distro report --name=CentOS-7-x86_64
</span><span class='line'>Name                           : CentOS-7-x86_64
</span><span class='line'>Architecture                   : x86_64
</span><span class='line'>TFTP Boot Files                : {}
</span><span class='line'>Breed                          : redhat
</span><span class='line'>Comment                        : 
</span><span class='line'>Fetchable Files                : {}
</span><span class='line'>Initrd                         : /var/www/cobbler/ks_mirror/CentOS-7-x86_64/images/pxeboot/initrd.img
</span><span class='line'>Kernel                         : /var/www/cobbler/ks_mirror/CentOS-7-x86_64/images/pxeboot/vmlinuz
</span><span class='line'>Kernel Options                 : {}
</span><span class='line'>Kernel Options (Post Install)  : {}
</span><span class='line'>Kickstart Metadata             : {'tree': 'http://@@http_server@@/cblr/links/CentOS-7-x86_64'}
</span><span class='line'>Management Classes             : []
</span><span class='line'>OS Version                     : rhel7
</span><span class='line'>Owners                         : ['admin']
</span><span class='line'>Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;
</span><span class='line'>Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;
</span><span class='line'>Template Files                 : {}
</span></code></pre></td></tr></table></div></figure>


<h3>Installation</h3>

<p>Install the system, via setup a machine which boot from PXE in the same subnet, then this machine will hint you with installing the corresponding system. <br/>
The new system&rsquo;s username/password is the same as we set in the cobbler configuration file.</p>

<h3>Enable Web Interface</h3>

<p>Change the default password via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp /etc/cobbler/users.digest /etc/cobbler/users.digest.back
</span><span class='line'>$ htdigest /etc/cobbler/users.digest "Cobbler" cobbler
</span></code></pre></td></tr></table></div></figure>


<p>Now restart the cobblerd, you could visit following URL for visiting the Web Inteface:  <br/>
<a href="http://10.3.3.3/cobbler_web">http://10.3.3.3/cobbler_web</a></p>

<h3>Import Multiple ISOs</h3>

<p>Import the first iso as usual.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mount -o loop -t iso9660 ./CentOS-6.6-x86_64-bin-DVD1.iso  /mnt
</span><span class='line'># cobbler import --name=CentOS-6.6 --arch=x86_64 --path=/mnt
</span></code></pre></td></tr></table></div></figure>


<p>The Second iso first mount to /mnt1/ directory, then import with following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#  rsync -a '/mnt1/' /var/www/cobbler/ks_mirror/CentOS-6.6-x86_64/ --exclude-from=/etc/cobbler/rsync.exclude --progress
</span><span class='line'>#  COMPSXML=$(ls /var/www/cobbler/ks_mirror/CentOS-6.6-x86_64/repodata/*comps*.xml)
</span><span class='line'>#  createrepo -c cache -s sha --update --groupfile ${COMPSXML} /var/www/cobbler/ks_mirror/CentOS-6.6-x86_64
</span></code></pre></td></tr></table></div></figure>


<p>Verify it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cobbler distro list
</span><span class='line'># cobbler profile list
</span><span class='line'># cobbler distro report --name=CentOS-6.6-x86_64
</span></code></pre></td></tr></table></div></figure>


<p>Verify it via installing a new machine running CentOS6.6.</p>

<h3>Trouble-Shooting on fence</h3>

<p>Lacking of fence equipment.</p>

<p>Trouble shooting for controlling the Systems(which is the node information which added into cobbler system).   <br/>
For Power Management:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@CobblerServer ~]# cobbler system poweroff --name Node1
</span><span class='line'>task started: 2015-05-14_064600_power
</span><span class='line'>task started (id=Power management (off), time=Thu May 14 06:46:00 2015)
</span><span class='line'>cobbler power configuration is:
</span><span class='line'>      type   : virsh
</span><span class='line'>      address: qemu+ssh://root@10.3.3.1/system
</span><span class='line'>      user   : root
</span><span class='line'>      id     : CobblerTest
</span><span class='line'>running: /usr/sbin/fence_virsh
</span><span class='line'>received on stdout: 
</span><span class='line'>received on stderr: Unable to connect/login to fencing device
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tips for Setting Up CentOS Local Repository]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/11/tips-for-setting-up-centos-local-repository/"/>
    <updated>2015-05-11T20:48:00+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/11/tips-for-setting-up-centos-local-repository</id>
    <content type="html"><![CDATA[<p>The material is learned from:   <br/>
<a href="http://paulcodr.co/blog/2015/yumrepo-server-local/">http://paulcodr.co/blog/2015/yumrepo-server-local/</a></p>

<h3>Steps</h3>

<p>Local ISO Preparation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost ~]# mkdir isos bin
</span><span class='line'>[root@localhost ~]# ls isos
</span><span class='line'>CentOS-6.6-x86_64-bin-DVD1.iso  CentOS-6.6-x86_64-bin-DVD2.iso
</span></code></pre></td></tr></table></div></figure>


<p>Download the scripts:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd bin
</span><span class='line'># wget http://paulcodr.co/download/yum-scripts.zip
</span><span class='line'># unzip yum-scripts.zip 
</span><span class='line'>Archive:  yum-scripts.zip
</span><span class='line'>   creating: yum-scripts/
</span><span class='line'>  inflating: yum-scripts/yum-create-server-centos6.6.sh  
</span><span class='line'>  inflating: yum-scripts/yum-rsync-minimal-centos6.6.sh  
</span></code></pre></td></tr></table></div></figure>


<p>Change the priviledges:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost bin]# chown -R root:root /root/isos
</span><span class='line'>[root@localhost bin]# chmod 750 -R /root/bin
</span></code></pre></td></tr></table></div></figure>


<p>Execute the script:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost bin]# mv yum-scripts/* ./
</span><span class='line'>[root@localhost bin]# ls
</span><span class='line'>yum-create-server-centos6.6.sh  yum-rsync-minimal-centos6.6.sh  yum-scripts  yum-scripts.zip
</span><span class='line'>[root@localhost bin]# ./yum-create-server-centos6.6.sh 2&gt;&1 | tee createserver.log
</span></code></pre></td></tr></table></div></figure>


<p>Verify it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost bin]#  du -hs /data/www/yumrpms/centos6.6/6.6/os/x86_64
</span><span class='line'>5.6G    /data/www/yumrpms/centos6.6/6.6/os/x86_64
</span><span class='line'>[root@localhost bin]#  ls -lh /data/www/yumrpms/centos6.6/
</span><span class='line'>total 4.0K
</span><span class='line'>lrwxrwxrwx 1 apache apache    3 May 11 12:49 6 -&gt; 6.6
</span><span class='line'>drwxr-xr-x 3 apache apache 4.0K May 11 12:47 6.6
</span></code></pre></td></tr></table></div></figure>


<p>Verify it on another PC:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root:/home/juju/iso]# curl http://10.7.7.124/yumrpms/centos6.6/6/os/x86_64/
</span><span class='line'>.....
</span><span class='line'>&lt;/table&gt;
</span><span class='line'>&lt;address&gt;Apache/2.2.15 (CentOS) Server at 10.7.7.124 Port 80&lt;/address&gt;
</span><span class='line'>&lt;/body&gt;&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Change the rsync repository in yum-rsync-minimal-cent6.6.sh:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rsync://mirrors.yun-idc.com/centos/
</span></code></pre></td></tr></table></div></figure>


<p>Then:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@localhost bin]# ./yum-rsync-minimal-centos6.6.sh 2&gt;&1 | tee syncserver.log
</span></code></pre></td></tr></table></div></figure>


<p>Wait for rsync&hellip;&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Automatically Recover SSH Connection]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/11/automatically-recover-ssh-connection/"/>
    <updated>2015-05-11T19:53:00+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/11/automatically-recover-ssh-connection</id>
    <content type="html"><![CDATA[<p>Thanks for the Great File Wall, my ssh connection to my vps is not stable, so I use following scripts for automatically maintain the ssh conneciton, once the connection down, it will restart immediately.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim autokeepssh.sh 
</span><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>while [ '' == '' ]
</span><span class='line'>do
</span><span class='line'>        # Use ssh -R for reverse ssh
</span><span class='line'>        ssh_d_process_num=`ps aux|grep -E 'ssh -NfR' |grep -v grep |wc -l`
</span><span class='line'>        if [ "$ssh_d_process_num" == "0" ]; then
</span><span class='line'>                # Automatically start the ssh proxy 
</span><span class='line'>                echo "Autostart!"
</span><span class='line'>                ssh -NfR 4389:localhost:22 Trusty@xxx.xxx.xxx.xxx -p xxxx &
</span><span class='line'>        #else
</span><span class='line'>        #       echo 'ssh -d running'
</span><span class='line'>        fi
</span><span class='line'>
</span><span class='line'>        sleep 5
</span><span class='line'>done
</span></code></pre></td></tr></table></div></figure>


<p>-R means I started a reverse connection.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup PXE Server]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/11/setup-pxe-server/"/>
    <updated>2015-05-11T14:12:00+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/11/setup-pxe-server</id>
    <content type="html"><![CDATA[<p>This article record how to setup the pxe server and setup the CentOS quick installation repository, using it we could quickly setup the CentOS on new machine.</p>

<h3>Installation</h3>

<p>To install following packages for preparing the environment:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install dnsmasq tftpd-hpa apache2 system-config-kickstart
</span></code></pre></td></tr></table></div></figure>


<p>Configure the apache2&rsquo;s default configuration file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/apache2/sites-enabled/000-default.conf
</span><span class='line'>        DocumentRoot /var/www/
</span></code></pre></td></tr></table></div></figure>


<p>Configure the dnsmasq via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/dnsmasq.conf
</span><span class='line'>bogus-priv
</span><span class='line'>filterwin2k
</span><span class='line'>interface=eth0
</span><span class='line'>domain=nova.com
</span><span class='line'>dhcp-range=10.7.7.100,10.7.7.150,12h
</span><span class='line'>dhcp-option=3,10.7.7.1
</span><span class='line'>dhcp-option=6,114.114.114.114
</span><span class='line'>dhcp-option=121,10.7.7.0/24
</span><span class='line'>dhcp-boot=/var/tftproot/pxelinux.0
</span><span class='line'>enable-tftp
</span><span class='line'>tftp-root=/var/tftproot
</span><span class='line'>dhcp-authoritative
</span></code></pre></td></tr></table></div></figure>


<p>Copy the pxelinux.0 from an installed CentOS, and copy it to /var/tftproot/</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root:~]# scp /usr/share/syslinux/pxelinux.0 Trusty@10.7.7.2:/home/Trusty
</span><span class='line'>Trusty@WolfHunterPXE:~$ sudo cp /home/Trusty/pxelinux.0 /var/tftproot/
</span></code></pre></td></tr></table></div></figure>


<h3>Prepare the Repository</h3>

<p>We need to copy the installation media into the corresponding directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mkdir -p /var/www/CentOS
</span><span class='line'>$ sudo mount CentOS-6.3-x86_64-bin-DVD1.iso /mnt
</span><span class='line'>$ sudo cp -rf /mnt/* /var/www/CentOS
</span><span class='line'>$ sudo mkdir -p /mnt1
</span><span class='line'>$ sudo mount CentOS-6.3-x86_64-bin-DVD2.iso /mnt1
</span><span class='line'>$ sudo cp -rf /mnt1/Packages/* /var/www/CentOS/Packages/
</span></code></pre></td></tr></table></div></figure>


<p>Copy the CentOS&rsquo;s kernel and kernel-startup file into the /var/tftproot/CentOS directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mkdir -p /var/tftproot/CentOS
</span><span class='line'>$ sudo cp /mnt/images/pxeboot/initrd.img /var/tftproot/CentOS
</span><span class='line'>$ sudo cp /mnt/images/pxeboot/vmlinuz /var/tftproot/CentOS
</span></code></pre></td></tr></table></div></figure>


<p>Now your repository for installation is ready.</p>

<h3>Configuration</h3>

<p>Edit the boot.msg file for user choosen:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /var/tftproot/boot.msg
</span><span class='line'>### START INSTALLING ######
</span><span class='line'>Choose installation type(0/1/2),the DEFAULT is 100:
</span><span class='line'>0 CentOS-6.3-64-No-RAID-Basic
</span><span class='line'>1 CentOS-6.3-64-No-RAID-minidesktop-virtualization-for testing
</span></code></pre></td></tr></table></div></figure>


<p>When user choose the corresponding items, then /var/tftproot/pxelinux.cfg/default file will choose the correspoiding files.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Trusty@WolfHunterPXE:~$ sudo mkdir -p /var/tftproot/pxelinux.cfg
</span><span class='line'>Trusty@WolfHunterPXE:~$ sudo vim /var/tftproot/pxelinux.cfg/default
</span><span class='line'>default 100
</span><span class='line'>display boot.msg
</span><span class='line'>
</span><span class='line'># Label 100 , boot from hddisk
</span><span class='line'>LABEL 100
</span><span class='line'>localboot 0x80
</span><span class='line'>
</span><span class='line'>### Label 0, minimal CentOS
</span><span class='line'>label 0
</span><span class='line'>kernel CentOS/vmlinuz
</span><span class='line'>append ks=http://10.7.7.2/cfg/Centos-minibasic.cfg vga=normal initrd=CentOS/initrd.img devfs=nomount ramdisk_size=9216 nofb
</span><span class='line'>
</span><span class='line'>### Label 1, minimal-Desktop CentOS 
</span><span class='line'>label 1
</span><span class='line'>kernel CentOS/vmlinuz
</span><span class='line'>append ks=http://10.7.7.2/cfg/Centos-minidesktop.cfg vga=normal initrd=CentOS/initrd.img devfs=nomount ramdisk_size=9216 nofb
</span><span class='line'>
</span><span class='line'>prompt 1 
</span><span class='line'>timeout 900
</span></code></pre></td></tr></table></div></figure>


<h3>Get kickstart file</h3>

<p>In a installed CentOS Server, install system-config-kickstart via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo yum install system-config-kickstart
</span></code></pre></td></tr></table></div></figure>


<p>Run <code>sudo system-config-kickstart</code> for getting the graphical configuration window, like following:</p>

<p><img src="http://purplepalmdash.github.io/images/2015_05_11_14_50_05_931x572.jpg" alt="/images/2015_05_11_14_50_05_931x572.jpg" />   <br/>
Customize the partition:</p>

<p><img src="http://purplepalmdash.github.io/images/2015_05_11_14_52_09_842x576.jpg" alt="/images/2015_05_11_14_52_09_842x576.jpg" />   <br/>
Do other configurations, after everything is OK, save it.</p>

<p>An example cfg file is listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat minidesktop.cfg 
</span><span class='line'>#platform=x86, AMD64, or Intel EM64T
</span><span class='line'>#version=DEVEL
</span><span class='line'># Firewall configuration
</span><span class='line'>firewall --disabled
</span><span class='line'># Install OS instead of upgrade
</span><span class='line'>install
</span><span class='line'># Use network installation
</span><span class='line'>url --url="http://10.7.7.2/CentOS"
</span><span class='line'># Root password
</span><span class='line'>rootpw --iscrypted $1$aRvLvJNH$ElcmZ2Msl4MbD.fHdnos9.
</span><span class='line'># System authorization information
</span><span class='line'>auth  --useshadow  --passalgo=sha512
</span><span class='line'># Use graphical install
</span><span class='line'>graphical
</span><span class='line'>firstboot --disable
</span><span class='line'># System keyboard
</span><span class='line'>keyboard us
</span><span class='line'># System language
</span><span class='line'>lang en_US
</span><span class='line'># SELinux configuration
</span><span class='line'>selinux --disabled
</span><span class='line'># Installation logging level
</span><span class='line'>logging --level=info
</span><span class='line'>
</span><span class='line'># System timezone
</span><span class='line'>timezone  Asia/Hong_Kong
</span><span class='line'># System bootloader configuration
</span><span class='line'>bootloader --location=mbr
</span><span class='line'># Clear the Master Boot Record
</span><span class='line'>zerombr
</span><span class='line'># Partition clearing information
</span><span class='line'>clearpart --all  
</span><span class='line'># Disk partitioning information
</span><span class='line'>part swap --fstype="swap" --size=1024
</span><span class='line'>part / --asprimary --fstype="ext4" --grow --size=1
</span><span class='line'>
</span><span class='line'>%packages
</span><span class='line'>@basic-desktop
</span><span class='line'>@chinese-support
</span><span class='line'>@internet-browser
</span><span class='line'>@x11
</span><span class='line'>-ibus-table-cangjie
</span><span class='line'>-ibus-table-erbi
</span><span class='line'>-ibus-table-wubi
</span><span class='line'>
</span><span class='line'>%end
</span></code></pre></td></tr></table></div></figure>


<p>Copy it under the /var/www/cfg/CentOS-minidesktop.cfg.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Trusty@WolfHunterPXE:~$ sudo mkdir -p /var/www/cfg
</span><span class='line'>Trusty@WolfHunterPXE:~$ sudo cp minidesktop.cfg /var/www/cfg/CentOS-minidesktop.cfg
</span></code></pre></td></tr></table></div></figure>


<h3>Testing</h3>

<p>Now create a new machine , set its bootup to pxe-network.  <br/>
Trouble Shooting, only need for CentOS:  <br/>
<img src="http://purplepalmdash.github.io/images/2015_05_11_16_18_47_609x332.jpg" alt="/images/2015_05_11_16_18_47_609x332.jpg" /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- Ctrl+B
</span><span class='line'>- dhcp net0
</span><span class='line'>- config
</span><span class='line'>
</span><span class='line'>- Ctrl+X
</span><span class='line'>- autoboot
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用Fuel部署OpenContrail(6)]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/06/shi-yong-fuelbu-shu-opencontrail-6/"/>
    <updated>2015-05-06T15:27:00+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/06/shi-yong-fuelbu-shu-opencontrail-6</id>
    <content type="html"><![CDATA[<p>前面在HA类型的Fuel OpenStack基础上集成了OpenContrail，然而在实际的开发和测试中，用HA类型比较浪费硬件资源，因此这次我把部署节点从7个压缩到3个，做多节点上非HA类型的OpenStack集成OpenContrail.</p>

<h3>先决条件</h3>

<p>这次只用三台机器来做部署，分别为:  <br/>
2-Core, 3G内存, 100G硬盘, 用于安装OpenStack Controller.      <br/>
2-Core, 2G内存, 100G硬盘, 用于安装OpenStack Compute. 注意这台机器需要Copy Host CPU configuration, 以激活KVM。      <br/>
2-Core, 3G内存, 100G硬盘, 用于安装Contrail.  <br/>
创建出来的两个用于部署的OpenStack环境如下:  <br/>
<img src="http://purplepalmdash.github.io/images/2015_05_06_15_36_20_383x194.jpg" alt="/images/2015_05_06_15_36_20_383x194.jpg" /> <br/>
值得注意的是，在OpenStack的配置中，我们激活了Ceilometer，用于统计，所以需要额外增加一台2G内存大小的虚拟机。  <br/>
<img src="http://purplepalmdash.github.io/images/2015_05_06_09_40_34_608x385.jpg" alt="/images/2015_05_06_09_40_34_608x385.jpg" /></p>

<h3>安装</h3>

<p>安装过程和HA的过程大同小异，配置好网络以后，现在I3OpenStack中部署好OpenStack，而后用provision的方式将I3Contrail中的Contrail部署节点机器安装为Ubuntu的格式。    <br/>
这里的具体配置过程可以参考《使用Fuel部署OpenContrail(1)》到《使用Fuel部署OpenContrail(3)》.  <br/>
一切就绪后，我们进入到配置过程.</p>

<h3>配置</h3>

<p>详细配置如下:</p>

<h4>(Contrail) 配置Contrail部署节点</h4>

<p>删除不用的网络端口, 并配置ifccfg-eth4后重启:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /etc/network/interfaces.d/
</span><span class='line'># rm -f ifcfg-eth1 
</span><span class='line'># rm -f ifcfg-eth2 
</span><span class='line'># rm -f ifcfg-eth3
</span><span class='line'># vim ifcfg-eth4
</span><span class='line'>    auto eth4
</span><span class='line'>    iface eth4 inet static
</span><span class='line'>    
</span><span class='line'>    address 10.77.77.100
</span><span class='line'>    netmask 255.255.255.0
</span><span class='line'>    gateway 10.77.77.1
</span><span class='line'>    
</span><span class='line'>    post-up  ethtool  -K  eth4  gso off  gro off || true
</span><span class='line'># reboot
</span></code></pre></td></tr></table></div></figure>


<p>确保在Contrail部署节点上，可以ping通OpenStack Controller的10.55.55.0/24网络。   <br/>
配置本地安装源:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># echo 'deb http://10.20.0.2:8080/contrail/ /' &gt; /etc/apt/sources.list.d/contrail.list
</span><span class='line'># echo -e "Package: *\nPin: release l=Ubuntu\nPin-Priority: 100" &gt; /etc/apt/preferences
</span><span class='line'># &gt;/etc/apt/sources.list
</span><span class='line'># apt-get update
</span><span class='line'># apt-get install -y python-paramiko contrail-fabric-utils contrail-setup
</span><span class='line'># pip install --upgrade --no-deps --index-url=”” /opt/contrail/python_packages/Fabric-1.7.0.tar.gz
</span></code></pre></td></tr></table></div></figure>


<p>开始配置用于部署的testbed.py文件，可以看到，比起HA部署方式来看，我们减少了一些节点定义，去掉了HA有关的配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim  /opt/contrail/utils/fabfile/testbeds/testbed.py
</span><span class='line'>    from fabric.api import env
</span><span class='line'>    #Management ip addresses of hosts in the cluster
</span><span class='line'>    #os_ctrl01 = 'root@10.55.55.6'
</span><span class='line'>    #os_ctrl02 = 'root@10.55.55.7'
</span><span class='line'>    #os_ctrl03 = 'root@10.55.55.8'
</span><span class='line'>    os_ctrl01 = 'root@10.55.55.7'
</span><span class='line'>    
</span><span class='line'>    c_ctrl01 = 'root@10.77.77.100'
</span><span class='line'>    #c_ctrl02 = 'root@10.77.77.11'
</span><span class='line'>    #c_ctrl03 = 'root@10.77.77.12'
</span><span class='line'>    c_db01 = 'root@10.77.77.100'
</span><span class='line'>    #c_db02 = 'root@10.77.77.11'
</span><span class='line'>    #c_db03 = 'root@10.77.77.12'
</span><span class='line'>    #External routers
</span><span class='line'>    # ext_routers = [('gateway01', '&lt;Gateway_node1_LOOPBACK_ip&gt;'), ('gateway02', '&lt;Gateway_node2_LOOPBACK_ip&gt;')]
</span><span class='line'>    #Autonomous system number
</span><span class='line'>    router_asn = 64512
</span><span class='line'>    #Host from which the fab commands are triggered to install and provision
</span><span class='line'>    deploy_node = 'root@10.77.77.100'
</span><span class='line'>    #Role definition of the hosts.
</span><span class='line'>    env.roledefs = {
</span><span class='line'>    'all': [c_ctrl01, c_db01],
</span><span class='line'>    'cfgm': [c_ctrl01],
</span><span class='line'>    'openstack': [os_ctrl01],
</span><span class='line'>    'control': [c_ctrl01],
</span><span class='line'>    'compute': [],
</span><span class='line'>    'collector': [c_ctrl01],
</span><span class='line'>    'webui': [c_ctrl01],
</span><span class='line'>    'database': [c_db01],
</span><span class='line'>    'build': [deploy_node],
</span><span class='line'>    'storage-master': [],
</span><span class='line'>    'storage-compute': [],
</span><span class='line'>    }
</span><span class='line'>    #Openstack admin password
</span><span class='line'>    env.openstack_admin_password = 'admin'
</span><span class='line'>    env.password = 'r00tme'
</span><span class='line'>    #Passwords of each host
</span><span class='line'>    env.passwords = {
</span><span class='line'>    os_ctrl01: 'r00tme',
</span><span class='line'>    # os_ctrl02: 'r00tme',
</span><span class='line'>    # os_ctrl03: 'r00tme',
</span><span class='line'>    c_ctrl01: 'r00tme',
</span><span class='line'>    #c_ctrl02: 'r00tme',
</span><span class='line'>    #c_ctrl03: 'r00tme',
</span><span class='line'>    c_db01: 'r00tme',
</span><span class='line'>    # c_db02: 'r00tme',
</span><span class='line'>    # c_db03: 'r00tme',
</span><span class='line'>    deploy_node: 'r00tme',
</span><span class='line'>    }
</span><span class='line'>    #For reimage purpose
</span><span class='line'>    env.ostypes = {
</span><span class='line'>    os_ctrl01: 'ubuntu',
</span><span class='line'>    # os_ctrl02: 'ubuntu',
</span><span class='line'>    # os_ctrl03: 'ubuntu',
</span><span class='line'>    c_ctrl01: 'ubuntu',
</span><span class='line'>    # c_ctrl02: 'ubuntu',
</span><span class='line'>    # c_ctrl03: 'ubuntu',
</span><span class='line'>    c_db01: 'ubuntu',
</span><span class='line'>    # c_db02: 'ubuntu',
</span><span class='line'>    # c_db03: 'ubuntu',
</span><span class='line'>    deploy_node: 'ubuntu',
</span><span class='line'>    }
</span><span class='line'>    env.openstack = {
</span><span class='line'>    'service_token' : 'xqnCCCs2'
</span><span class='line'>    }
</span><span class='line'>    # env.ha = {
</span><span class='line'>    # 'internal_vip': '10.55.55.4',
</span><span class='line'>    # 'external_vip': '172.16.0.4',
</span><span class='line'>    # 'contrail_internal_vip': '10.77.77.9',
</span><span class='line'>    # 'contrail_external_vip': '10.77.77.9',
</span><span class='line'>    # }
</span><span class='line'>    env.keystone = {
</span><span class='line'>    'service_tenant': 'services',
</span><span class='line'>    'admin_token': 'xqnCCCs2',
</span><span class='line'>    }
</span><span class='line'>    multi_tenancy = True
</span></code></pre></td></tr></table></div></figure>


<p>从Fuel节点控制机上拷贝公钥文件，用于快速部署</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># scp 10.20.0.2:/root/.ssh/id_rsa /root/.ssh/id_rsa
</span><span class='line'># chmod 0600 /root/.ssh/id_rsa
</span></code></pre></td></tr></table></div></figure>


<p>在节点上部署仓库，安装必要包，同意SUN协议:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># fab -P -R control -w -- 'ls /etc/apt/preferences || echo -e "Package: *\nPin: release \
</span><span class='line'>l=Ubuntu\nPin-Priority: 100" &gt; /etc/apt/preferences'
</span><span class='line'># fab -P -R control -w -- 'DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes \
</span><span class='line'>--allow-unauthenticated install python-crypto python-netaddr python-paramiko \
</span><span class='line'>contrail-fabric-utils contrail-setup'
</span><span class='line'># fab -P -R control -w -- 'pip install --upgrade --no-deps --index-url="" \
</span><span class='line'>/opt/contrail/python_packages/ecdsa-0.10.tar.gz'
</span><span class='line'># fab -P -R control -w -- 'pip install --upgrade --no-deps --index-url="" \
</span><span class='line'>/opt/contrail/python_packages/Fabric-1.7.0.tar.gz'
</span><span class='line'># fab -P -R control -w -- 'echo "sun-java6-plugin shared/accepted-sun-dlj-v1-1 boolean \
</span><span class='line'>true" | /usr/bin/debconf-set-selections' && fab -P -R control -w -- 'echo "sun-java6-bin shared/accepted-sun-dlj-v1-1 boolean \
</span><span class='line'> true" | /usr/bin/debconf-set-selections' && fab -P -R control -w -- 'echo "debconf shared/accepted-oracle-license-v1-1 select \
</span><span class='line'>true" | sudo debconf-set-selections' && fab -P -R control -w -- 'echo "debconf shared/accepted-oracle-license-v1-1 seen \
</span><span class='line'> true" | sudo debconf-set-selections'
</span></code></pre></td></tr></table></div></figure>


<p>安装特定版本的tzdata， 安装和配置数据库，并检查状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># fab -P -R control -w -- 'DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes \
</span><span class='line'> --allow-unauthenticated install tzdata=2014e-0ubuntu0.12.04' && fab install_database && fab setup_database && fab -R database -w -- "contrail-status"
</span><span class='line'># nodetool status
</span></code></pre></td></tr></table></div></figure>


<p>安装和配置cfgm, control, collector, webui，keepalived等, 并配置tenant服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># fab install_cfgm && fab install_control && fab install_collector && fab install_webui && fab setup_contrail_keepalived
</span><span class='line'># fab -P -R control -w -- 'service keepalived restart'
</span><span class='line'># fab -P -R control -w -- "sed -i '49s/service/services/g' \
</span><span class='line'>/usr/local/lib/python2.7/dist-packages/contrail_provisioning/config/quantum_in_keystone_setup.py"
</span><span class='line'># fab setup_cfgm
</span><span class='line'># fab setup_control && fab setup_collector && fab setup_webui
</span></code></pre></td></tr></table></div></figure>


<p>(OpenStack Controller节点)检查neutron endpoint的方法，看是否有10.77.77.100的字段出现：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># keystone service-list
</span><span class='line'># keystone endpoint-list
</span></code></pre></td></tr></table></div></figure>


<p>(OpenStack Controller节点)顺便，我们要拿到rabbit_hosts的密码，供下面使用:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/rabbitmq/rabbitmq.config | grep default_pass
</span><span class='line'>    {default_pass,        &lt;&lt;"nFyBhsrP"&gt;&gt;},
</span></code></pre></td></tr></table></div></figure>


<p>配置rabbit:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># fab -P -R control -w -- 'openstack-config --del /etc/neutron/neutron.conf DEFAULT rabbit_host'
</span><span class='line'># fab -P -R control -w -- 'openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_hosts 10.55.55.7:5672'
</span><span class='line'># fab -P -R control -w -- 'openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_userid \
</span><span class='line'>   nova'
</span><span class='line'># fab -P -R control -w -- 'openstack-config --set /etc/neutron/neutron.conf DEFAULT \
</span><span class='line'>  rabbit_password nFyBhsrP'
</span><span class='line'># fab -P -R control -w -- 'service neutron-server restart'
</span></code></pre></td></tr></table></div></figure>


<p>配置contrail-api使用OpenStack Controller上的rabbit服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># fab -P -R control -w -- 'perl -pi -e \
</span><span class='line'> "s/rabbit_server.*$/rabbit_server=10.55.55.7/" /etc/contrail/contrail-api.conf'
</span><span class='line'># fab -P -R control -w -- 'perl -pi -e "s/rabbit_port.*$/rabbit_port=5672/" \
</span><span class='line'> /etc/contrail/contrail-api.conf'
</span><span class='line'># fab -R control -w -- "perl -pi -e 'print \"rabbit_password=nFyBhsrP\n\" \
</span><span class='line'> if \$_ =~ rabbit_port' /etc/contrail/contrail-api.conf"
</span><span class='line'># fab -P -R control -w -- "perl -pi -e 'print \"rabbit_user=nova\n\" if \$_ =~ rabbit_port' \
</span><span class='line'> /etc/contrail/contrail-api.conf"
</span><span class='line'># fab -P -R control -w -- "service contrail-api restart"
</span></code></pre></td></tr></table></div></figure>


<p>替换neutron的插件为OpenContrail：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cp -r contrail-repo/neutron_plugin_contrail/plugins/opencontrail /usr/share/pyshared/neutron_plugin_contrail/plugins/
</span><span class='line'># cd /opt/contrail/utils
</span><span class='line'># fab -P -R cfgm -w -- 'service neutron-server restart'
</span></code></pre></td></tr></table></div></figure>


<p>重启BGP,METADATA,ENCAPSULATION:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># fab prov_control_bgp && fab prov_metadata_services && fab prov_encap_type
</span></code></pre></td></tr></table></div></figure>


<p>验证:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># fab verify_cfgm
</span><span class='line'># fab verify_control
</span><span class='line'># fab verify_collector
</span><span class='line'># fab verify_webui
</span><span class='line'># fab -R control -w -- "contrail-status"
</span><span class='line'># fab -P -R control -w -- 'update-rc.d supervisor-support-service disable'
</span></code></pre></td></tr></table></div></figure>


<p>现在访问:     <br/>
<a href="https://10.77.77.100:8143">https://10.77.77.100:8143</a>    <br/>
Contrail的组件已经被配置完毕，接下来配置Compute节点，以引入Vrouter等。</p>

<h4>(OpenStack Controller节点)</h4>

<p>删除ifcfg-eth4的配置后重启OpenStack Controller节点, 修改nova.conf文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/nova/nova.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>network_api_class = nova.network.neutronv2.api.API
</span><span class='line'>neutron_url = http://10.77.77.100:9696
</span><span class='line'>neutron_admin_tenant_name = services
</span><span class='line'>neutron_admin_username = neutron
</span><span class='line'>neutron_admin_password = xqnCCCs2
</span><span class='line'>neutron_url_timeout = 300
</span><span class='line'>neutron_admin_auth_url = http://10.55.55.7:35357/v2.0/
</span><span class='line'>firewall_driver = nova.virt.firewall.NoopFirewallDriver
</span><span class='line'>enabled_apis = ec2,osapi_compute,metadata
</span><span class='line'>security_group_api = neutron
</span><span class='line'>service_neutron_metadata_proxy = True
</span></code></pre></td></tr></table></div></figure>


<p>重启服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service nova-api restart
</span><span class='line'># service nova-scheduler restart
</span><span class='line'># service nova-conductor restart
</span></code></pre></td></tr></table></div></figure>


<p>删除已注册的nova-network组件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># source ~/openrc
</span><span class='line'># for i in $(nova service-list|grep nova-network|awk '{print $2}'); \
</span><span class='line'>do nova service-delete $i;done
</span></code></pre></td></tr></table></div></figure>


<p>接下来配置Compute节点.</p>

<h4>(Compute节点)</h4>

<p>引入本地安装仓库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#  echo 'deb http://10.20.0.2:8080/contrail/ /' &gt;/etc/apt/sources.list.d/contrail.list
</span><span class='line'># echo -e "Package: *\nPin: release l=Ubuntu\nPin-Priority: 100" &gt; /etc/apt/preferences
</span><span class='line'># &gt;/etc/apt/sources.list
</span><span class='line'># apt-get update
</span></code></pre></td></tr></table></div></figure>


<p>删除已有的vswitch模块，并验证:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get purge -y openvswitch-switch nova-network nova-api
</span><span class='line'># apt-get purge -y  nova-network nova-api
</span><span class='line'># aptitude search -F '%p' '~i' | grep openvswitch
</span></code></pre></td></tr></table></div></figure>


<p>删除OVS内核模块:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># lsmod | grep openvswitch && rmmod openvswitch
</span></code></pre></td></tr></table></div></figure>


<p>删除virtual网络,即virbr0端口:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># virsh net-destroy default
</span><span class='line'># virsh net-undefine default
</span></code></pre></td></tr></table></div></figure>


<p>删除除ifcfg-eth4和ifcfg-eth0的其他端口，并重启，重启后用下列命令检查是否有iptables NAT规则存在，理论上应该是空的:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># iptables -L -t nat
</span></code></pre></td></tr></table></div></figure>


<p>安装vrouter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install -y contrail-openstack-vrouter
</span></code></pre></td></tr></table></div></figure>


<p>配置vhosts,vrouter需要使用这个端口,指定IP地址为10.77.77.101:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/network/interfaces.d/ifcfg-vhost0 
</span><span class='line'>auto vhost0
</span><span class='line'>iface vhost0 inet static
</span><span class='line'>    netmask 255.255.255.0
</span><span class='line'>    network_name application
</span><span class='line'>    address 10.77.77.101
</span><span class='line'>    gateway 10.77.77.1
</span><span class='line'>    mtu 1300
</span><span class='line'># vim /etc/network/interfaces.d/ifcfg-eth4 
</span><span class='line'>auto eth4
</span><span class='line'>iface eth4 inet manual
</span><span class='line'>
</span><span class='line'>up ip l set eth4 up
</span><span class='line'>down ip l set eth4 down
</span><span class='line'>
</span><span class='line'>post-up  ethtool  -K  eth4  gso off  gro off || true
</span></code></pre></td></tr></table></div></figure>


<p>创建agent-param文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mv /etc/contrail/agent_param.tmpl /etc/contrail/agent_param
</span><span class='line'># vim /etc/contrail/agent_param
</span><span class='line'>dev=eth4
</span></code></pre></td></tr></table></div></figure>


<p>设置vroute-agent配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/contrail/contrail-vrouter-agent.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>headless_mode=true
</span><span class='line'>[DISCOVERY]
</span><span class='line'>server=10.77.77.100
</span><span class='line'>max_control_nodes=1
</span><span class='line'>[HYPERVISOR]
</span><span class='line'>type=kvm
</span><span class='line'>[NETWORKS]
</span><span class='line'>control_network_ip=10.77.77.101
</span><span class='line'>[VIRTUAL-HOST-INTERFACE]
</span><span class='line'>name=vhost0
</span><span class='line'>ip=10.77.77.101/24
</span><span class='line'>gateway=10.77.77.1
</span><span class='line'>physical_interface=eth4
</span></code></pre></td></tr></table></div></figure>


<p>配置节点管理参数,地址指向Contrail控制器的IP:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/contrail/vrouter_nodemgr_param
</span><span class='line'>DISCOVERY=10.77.77.100
</span></code></pre></td></tr></table></div></figure>


<p>配置nova-compute:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> # openstack-config --set /etc/nova/nova.conf DEFAULT neutron_url http://10.77.77.100:9696
</span><span class='line'> # openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_auth_url http://10.55.55.7:35357/v2.0/
</span><span class='line'> # openstack-config --set /etc/nova/nova.conf DEFAULT network_api_class nova_contrail_vif.contrailvif.ContrailNetworkAPI
</span><span class='line'> # openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_tenant_name services
</span><span class='line'> # openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_username neutron
</span><span class='line'> # openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_password xqnCCCs2
</span><span class='line'> # openstack-config --set /etc/nova/nova.conf DEFAULT neutron_url_timeout 300
</span><span class='line'> # openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver
</span><span class='line'> # openstack-config --set /etc/nova/nova.conf DEFAULT security_group_api neutron
</span><span class='line'> # service supervisor-vrouter restart
</span></code></pre></td></tr></table></div></figure>


<p>验证所有的vrouter服务都是active状态的:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># contrail-status 
</span><span class='line'>== Contrail vRouter ==
</span><span class='line'>supervisor-vrouter:           active
</span><span class='line'>contrail-vrouter-agent        active              
</span><span class='line'>contrail-vrouter-nodemgr      active              
</span></code></pre></td></tr></table></div></figure>


<p>更改/etc/libvirt/qemu.confg中的cgroup_device_acl部分:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cgroup_device_acl = [
</span><span class='line'>"/dev/null", "/dev/full", "/dev/zero",
</span><span class='line'>"/dev/random", "/dev/urandom",
</span><span class='line'>"/dev/ptmx", "/dev/kvm", "/dev/kqemu",
</span><span class='line'>"/dev/rtc", "/dev/hpet","/dev/net/tun",
</span><span class='line'>]
</span></code></pre></td></tr></table></div></figure>


<p>在每个OpenStack Compute节点上，添加iptables规则如下并保存:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># iptables -I INPUT 1 -s 169.254.0.0/16 -i vhost0 -j ACCEPT -m comment --comment "metadata service"
</span><span class='line'># iptables -I INPUT 1 -p tcp -m multiport --destination-ports 2049,8085,9090,8102,33617,39704,44177,55970,60663 -j ACCEPT -m comment --comment "juniper contrail rules"
</span><span class='line'># iptables-save &gt; /etc/iptables/rules.v4
</span></code></pre></td></tr></table></div></figure>


<p>重启libvirt-bin和nova-compute服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service libvirt-bin restart
</span><span class='line'># service nova-compute restart
</span></code></pre></td></tr></table></div></figure>


<p>(Contrail Controller节点)更改vrouter的配置, ！！！注意，这是在Contrail Deploy的那个节点运行的！！！！, host_name的结果可以在compute节点上通过hostname命令来获得 ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># python /opt/contrail/utils/provision_vrouter.py --host_name node-18 --host_ip 10.77.77.101 --api_server_ip 10.77.77.100 --admin_user neutron --admin_password xqnCCCs2 --admin_tenant_name services --oper add
</span></code></pre></td></tr></table></div></figure>


<h4>VGW配置</h4>

<p>OpenContrail支持多种配置，例如Juniper vSRX, Juniper MX, Cisco ASR等，但这些都需要专有硬件的支持（路由器），我们仅仅采用软件路由器Vrouter, 这里我们配置VGW:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># export PYTHONPATH=/usr/lib/python2.7/dist-packages/contrail_vrouter_api/gen_py/instance_service
</span><span class='line'># python /opt/contrail/utils/provision_vgw_interface.py --oper create --interface vgw --subnets 10.88.88.0/24 --routes 0.0.0.0/0 --vrf default-domain:admin:ext:ext
</span></code></pre></td></tr></table></div></figure>


<p>更新/etc/contrail/contrail-vrouter-agent.con中的[GATEWAY-0]部分:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[GATEWAY-0]
</span><span class='line'>routing_instance=default-domain:admin:ext:ext
</span><span class='line'>interface=vgw
</span><span class='line'>ip_blocks=10.88.88.0/24
</span><span class='line'>routes=0.0.0.0/0
</span></code></pre></td></tr></table></div></figure>


<p>重新启动supervisor-vrouter进程:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service supervisor-vrouter restart
</span></code></pre></td></tr></table></div></figure>


<p>重启其他所有的encapsulation方法，除了MPLS On UDP:  <br/>
<img src="http://purplepalmdash.github.io/images/2015_04_27_22_45_01_799x306.jpg" alt="/images/2015_04_27_22_45_01_799x306.jpg" /></p>

<p>最后结果如下:   <br/>
<img src="http://purplepalmdash.github.io/images/2015_05_06_16_24_52_891x430.jpg" alt="/images/2015_05_06_16_24_52_891x430.jpg" /></p>

<h3>总结</h3>

<p>非HA方式部署，需要花费内存为:   <br/>
3+3+2+2=10G, 再加上Fuel Controller本身的3G,在16G的台式机上可以做到。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building ChromeOS Steps]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/05/05/building-chromeos-steps/"/>
    <updated>2015-05-05T11:43:00+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/05/05/building-chromeos-steps</id>
    <content type="html"><![CDATA[<p>My aim is for enable the bluetooth Networking in my Chromebook, AKA BNEP, so first I have to build out some experimentation platforms for investigation, following is the steps for building out the ChromeOS Images and let it run under kvm based virtual machine.</p>

<h3>Prerequistites</h3>

<p>I use a 6-Giga-Byte memory machine for building, first install following packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install git-core gitk git-gui subversion curl
</span></code></pre></td></tr></table></div></figure>


<p>Since I am in china mainland, the connection to googlesourcecode is blocked by Great Fire Wall(Fuck you!), I have to use proxychains for automatically convert my TCP/UDP flow to sock flow. That&rsquo;s why in some steps I use proxychains4 in front of the commands. If you are free to reach Internet, you should remove the proxychains4 in front of each command. <br/>
Then install <code>depot_tools</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dasdh@BuildMaasImage:~/Code$ pwd
</span><span class='line'>/home/dasdh/Code
</span><span class='line'>dasdh@BuildMaasImage:~/Code$ mkdir depot_tools
</span><span class='line'>dasdh@BuildMaasImage:~/Code$ proxychains4  git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
</span><span class='line'>$ export PATH=`pwd`/depot_tools:"$PATH"
</span><span class='line'>$ echo $PATH
</span><span class='line'>/home/dasdh/Code/depot_tools:/home/dasdh/Code/depot_tools:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
</span></code></pre></td></tr></table></div></figure>


<p>
Config git:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dasdh@BuildMaasImage:~/Code$ git config --global user.email "kkkttt@gmail.com"
</span><span class='line'>dasdh@BuildMaasImage:~/Code$ git config --global user.name "Dash"
</span></code></pre></td></tr></table></div></figure>


<p>Maybe in the future you will use github repository, better you use <code>ssh-keygen</code> to generate the public ssh key and upload it to github.    Make sure your architecture is x86_64, and add following into your ~/.bashrc:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dasdh@BuildMaasImage:~/Code$ uname -m
</span><span class='line'>x86_64
</span><span class='line'>dasdh@BuildMaasImage:~/Code$ cat ~/.bashrc | grep umask
</span><span class='line'>umask 022
</span></code></pre></td></tr></table></div></figure>


<h3>Get Source Code</h3>

<p>Get the code via following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dasdh@BuildMaasImage:~$ mkdir chromiumos
</span><span class='line'>dasdh@BuildMaasImage:~$ pwd
</span><span class='line'>/home/dasdh
</span></code></pre></td></tr></table></div></figure>


<p>Then get the credential for chromiumOS( go to <a href="https://chromium-review.googlesource.com/new-password">https://chromium-review.googlesource.com/new-password</a> for getting the commands):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$  touch ~/.gitcookies
</span><span class='line'>$  chmod 0600 ~/.gitcookies
</span><span class='line'>$  git config --global http.cookiefile ~/.gitcookies
</span><span class='line'>$  tr , \\t &lt;&lt;\__END__ &gt;&gt;~/.gitcookies
</span><span class='line'> .googlesource.com,TRUE,/,TRUE,2147483647,o,git-kkkttt.gmail.com=1/goeugoueogewoguoweugoawohouaohuowauhoaeuo
</span><span class='line'> __END__
</span><span class='line'>$  git config --global "url.https://chromium.googlesource.com/a/.insteadOf" "https://chromium.googlesource.com/"
</span><span class='line'>$  git config --global --add "url.https://chromium.googlesource.com/a/.insteadOf" "https://chromium.googlesource.com/a/"
</span><span class='line'>$  proxychains4 git ls-remote https://chromium.googlesource.com/a/chromiumos/manifest.git
</span></code></pre></td></tr></table></div></figure>


<p>The final output result should be a list of file. <br/>
Because the google source code use https connection, so we need to define the .netrc like following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ touch ~/.netrc
</span><span class='line'>$ chmod 0600 ~/.netrc
</span><span class='line'>$ vim ~/.netrc
</span><span class='line'>machine chromium.googlesource.com
</span><span class='line'>login git-kkkttt.gmail.com
</span><span class='line'>password agowugoweugowugouwoguoweugoeugo
</span><span class='line'>
</span><span class='line'>machine chromium-review.googlesource.com
</span><span class='line'>login git-kkkttt.gmail.com
</span><span class='line'>password agowugoweugowugouwoguoweugoeugo
</span></code></pre></td></tr></table></div></figure>


<p>Now your configuration is ready, initialize the repository via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ proxychains4 repo init -u https://chromium.googlesource.com/chromiumos/manifest.git --repo-url https://chromium.googlesource.com/external/repo.git
</span><span class='line'>$ proxychains4 repo sync 
</span></code></pre></td></tr></table></div></figure>


<p>repo sync will take a very long time for getting all of the source code down, and it will takes arount 8G disk size.</p>

<h3>Build Source Code</h3>

<p>After source code is avaiable, start building it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ proxychains cros_sdk
</span></code></pre></td></tr></table></div></figure>


<p>Since the proxychains failed, I&rsquo;ve enable the redsocks for crossing the GFW, in the last part of this article shows its installation and configuration.  <br/>
Using redsocks we could continue the building:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cros_sdk
</span><span class='line'>dasdh@BuildMaasImage ~/trunk/src/scripts $ 
</span></code></pre></td></tr></table></div></figure>


<p>Now start building via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#  export BOARD=amd64-generic
</span><span class='line'># ./setup_board --board=${BOARD}
</span><span class='line'># ./set_shared_user_password.sh
</span><span class='line'># ./build_packages --board=${BOARD}
</span><span class='line'># ./build_image --board=${BOARD} --noenable_rootfs_verification dev
</span></code></pre></td></tr></table></div></figure>


<p>If you met hostname error, make sure your hostname is added in <code>/etc/hosts</code>.</p>

<p>The building result is listed as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(cr) dasdh@BuildMaasImage ~/trunk/src/build/images/amd64-generic/R44-7040.0.2015_05_06_0543-a1 $ pwd
</span><span class='line'>/home/dasdh/trunk/src/build/images/amd64-generic/R44-7040.0.2015_05_06_0543-a1
</span><span class='line'>(cr) dasdh@BuildMaasImage ~/trunk/src/build/images/amd64-generic/R44-7040.0.2015_05_06_0543-a1 $ ls -l -h
</span><span class='line'>total 1.2G
</span><span class='line'>-rw-r--r-- 1 dasdh eng  399 May  6 05:52 boot.config
</span><span class='line'>-rw-r--r-- 1 dasdh eng  214 May  6 05:49 boot.desc
</span><span class='line'>-rw-r--r-- 1 dasdh eng 2.5G May  6 05:52 chromiumos_image.bin
</span><span class='line'>-rw-r--r-- 1 dasdh eng  586 May  6 05:52 config.txt
</span><span class='line'>drwxr-xr-x 2 dasdh eng 4.0K May  6 05:52 esp
</span><span class='line'>-rwxr-xr-x 1 dasdh eng 5.6K May  6 05:43 mount_image.sh
</span><span class='line'>-rwxr-xr-x 1 dasdh eng 4.8K May  6 05:43 pack_partitions.sh
</span><span class='line'>-rw-r--r-- 1 dasdh eng  12K May  6 05:43 partition_script.sh
</span><span class='line'>-rwxr-xr-x 1 dasdh eng 4.7K May  6 05:43 umount_image.sh
</span><span class='line'>-rwxr-xr-x 1 dasdh eng 5.0K May  6 05:43 unpack_partitions.sh
</span></code></pre></td></tr></table></div></figure>


<p>I think the chromiumos_image.bin is what we want.</p>

<h3>RedSocks</h3>

<p>Download the redsocks source code and compile it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /opt/src
</span><span class='line'># git clone https://github.com/darkk/redsocks.git
</span><span class='line'># cd redsocks
</span><span class='line'># apt-get install libevent-dev 
</span><span class='line'># make 
</span></code></pre></td></tr></table></div></figure>


<p>Write configuration files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat redsocks.sh
</span><span class='line'>#! /bin/sh
</span><span class='line'>
</span><span class='line'>case "$1" in
</span><span class='line'>  start|"")
</span><span class='line'>    cd /opt/src/redsocks
</span><span class='line'>    if [ -e redsocks.log ] ; then
</span><span class='line'>      rm redsocks.log
</span><span class='line'>    fi
</span><span class='line'>    ./redsocks -p /opt/src/redsocks/redsocks.pid #set daemon = on in config file
</span><span class='line'>    # start redirection
</span><span class='line'>    iptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to 12345
</span><span class='line'>    iptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to 12345
</span><span class='line'>    ;;
</span><span class='line'>
</span><span class='line'>  stop)
</span><span class='line'>    cd /opt/src/redsocks
</span><span class='line'>    if [ -e redsocks.pid ]; then
</span><span class='line'>      kill `cat redsocks.pid`
</span><span class='line'>      rm redsocks.pid
</span><span class='line'>    else
</span><span class='line'>      echo already killed, anyway, I will try killall
</span><span class='line'>      killall -9 redsocks
</span><span class='line'>    fi
</span><span class='line'>    # stop redirection
</span><span class='line'>    iptables -t nat -F OUTPUT
</span><span class='line'>    ;;
</span><span class='line'>
</span><span class='line'>  start_ssh)
</span><span class='line'>    #ssh -NfD 1234 user@example.cc #TODO: change it!!!
</span><span class='line'>    ssh -NfD 1234 544644af4382ec37bc0009da@weatherapp-kkkttt.rhcloud.com
</span><span class='line'>    ;;
</span><span class='line'>
</span><span class='line'>  stop_ssh)
</span><span class='line'>    ps aux|grep "ssh -NfD 1234"|awk '{print $2}'|xargs kill
</span><span class='line'>    ;;
</span><span class='line'>
</span><span class='line'>  clean_dns)
</span><span class='line'>    iptables -A INPUT -p udp --sport 53 -m state --state ESTABLISHED -m gfw -j DROP -m comment --comment "drop gfw dns hijacks"
</span><span class='line'>    ;;
</span><span class='line'>
</span><span class='line'>  *)
</span><span class='line'>    echo "Usage: redsocks start|stop|start_ssh|stop_ssh|clean_dns" &gt;&2
</span><span class='line'>    exit 3
</span><span class='line'>    ;;
</span><span class='line'>esac
</span><span class='line'># cat redsocks.conf
</span><span class='line'>base {
</span><span class='line'>        // debug: connection progress & client list on SIGUSR1
</span><span class='line'>        log_debug = on;
</span><span class='line'>
</span><span class='line'>        // info: start and end of client session
</span><span class='line'>        log_info = on;
</span><span class='line'>
</span><span class='line'>        /* possible `log' values are:
</span><span class='line'>         *   stderr
</span><span class='line'>         *   file:/path/to/file
</span><span class='line'>         *   syslog:FACILITY  facility is any of "daemon", "local0"..."local7"
</span><span class='line'>         */
</span><span class='line'>        log = stderr;
</span><span class='line'>
</span><span class='line'>        // detach from console
</span><span class='line'>        daemon = on;
</span><span class='line'>
</span><span class='line'>        /* Change uid, gid and root directory, these options require root
</span><span class='line'>         * privilegies on startup.
</span><span class='line'>         * Note, your chroot may requre /etc/localtime if you write log to syslog.
</span><span class='line'>         * Log is opened before chroot & uid changing.
</span><span class='line'>         */
</span><span class='line'>        // user = nobody;
</span><span class='line'>        // group = nobody;
</span><span class='line'>        // chroot = "/var/chroot";
</span><span class='line'>
</span><span class='line'>        /* possible `redirector' values are:
</span><span class='line'>         *   iptables   - for Linux
</span><span class='line'>         *   ipf        - for FreeBSD
</span><span class='line'>         *   pf         - for OpenBSD
</span><span class='line'>         *   generic    - some generic redirector that MAY work
</span><span class='line'>         */
</span><span class='line'>        redirector = iptables;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>redsocks {
</span><span class='line'>        /* `local_ip' defaults to 127.0.0.1 for security reasons,
</span><span class='line'>         * use 0.0.0.0 if you want to listen on every interface.
</span><span class='line'>         * `local_*' are used as port to redirect to.
</span><span class='line'>         */
</span><span class='line'>        local_ip = 127.0.0.1;
</span><span class='line'>        local_port = 12345;
</span><span class='line'>
</span><span class='line'>        // `ip' and `port' are IP and tcp-port of proxy-server
</span><span class='line'>        ip = 127.0.0.1;
</span><span class='line'>        port = 1234;
</span><span class='line'>
</span><span class='line'>        // known types: socks4, socks5, http-connect, http-relay
</span><span class='line'>        type = socks5;
</span><span class='line'>}
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>Everytime you use the redsocks, enable it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ./redsocks.sh start_ssh
</span><span class='line'># ./redsocks.sh start
</span></code></pre></td></tr></table></div></figure>


<p>Disable it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ./redsocks.sh stop
</span><span class='line'># ./redsocks.sh stop_ssh
</span></code></pre></td></tr></table></div></figure>


<h3>Run ChromeOS in kvm</h3>

<p>Now Transfer the image to image for vm:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export BOARD=amd64-generic
</span><span class='line'>(cr) dasdh@BuildMaasImage ~/trunk/src/build/images/amd64-generic/latest $ cd ~/trunk/src/scripts/
</span><span class='line'>(cr) ((df83602...)) dasdh@BuildMaasImage ~/trunk/src/scripts $ ./image_to_vm.sh --board=${BOARD}
</span><span class='line'>Resizing stateful partition to 3072MB
</span></code></pre></td></tr></table></div></figure>


<p>Verify if kvm is supported on your system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dasdh@BuildMaasImage:~/src/scripts$ kvm-ok
</span><span class='line'>INFO: /dev/kvm exists                                                                                                                          
</span><span class='line'>KVM acceleration can be used      
</span></code></pre></td></tr></table></div></figure>


<p>Now run via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/chromiumos/src/scripts
</span><span class='line'>$ ./bin/cros_start_vm --image_path=../build/images/${BOARD}/latest/chromiumos_qemu_image.bin
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
