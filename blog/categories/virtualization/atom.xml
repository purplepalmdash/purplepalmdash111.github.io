<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Virtualization | Dash]]></title>
  <link href="http://purplepalmdash.github.io/blog/categories/virtualization/atom.xml" rel="self"/>
  <link href="http://purplepalmdash.github.io/"/>
  <updated>2015-10-12T20:39:31+08:00</updated>
  <id>http://purplepalmdash.github.io/</id>
  <author>
    <name><![CDATA[Dash]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Tips on OZ]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/10/12/tips-on-oz/"/>
    <updated>2015-10-12T12:27:04+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/10/12/tips-on-oz</id>
    <content type="html"><![CDATA[<h3>Reference</h3>

<p>The reference URL is located at: <br/>
<a href="http://www.chenshake.com/oz-making-centos-mirror/">http://www.chenshake.com/oz-making-centos-mirror/</a></p>

<h3>Installation</h3>

<p>On CentOS 7, install oz via:</p>

<pre><code># yum install -y oz
# rpm -qa | grep oz-
oz-0.14.0-1.el7.noarch
</code></pre>

<h3>Configuration</h3>

<p>The configuration file for oz should be configured as:</p>

<pre><code># vim /etc/oz/oz.cfg 
[paths]
output_dir = /var/lib/libvirt/images
data_dir = /var/lib/oz
screenshot_dir = /var/lib/oz/screenshots
# sshprivkey = /etc/oz/id_rsa-icicle-gen

[libvirt]
uri = qemu:///system
#image_type = raw
image_type = qcow2
# type = kvm
bridge_name = virbr0
cpus = 1
memory = 1024
</code></pre>

<p>The configuration file for the oz should have one tdl file and one kickstart file:</p>

<pre><code># cat centos66.tdl 
&lt;template&gt;
   &lt;name&gt;centos_66_x86_64&lt;/name&gt;
   &lt;description&gt;CentOS 6.6 x86_64 template&lt;/description&gt;
   &lt;os&gt;
      &lt;name&gt;CentOS-6&lt;/name&gt;
      &lt;version&gt;6&lt;/version&gt;
      &lt;arch&gt;x86_64&lt;/arch&gt;
      &lt;install type='url'&gt;
         &lt;url&gt;http://192.168.0.79/ks_mirror/CentOS-6.6-x86_64&lt;/url&gt;
      &lt;/install&gt;
   &lt;/os&gt;
&lt;/template&gt;
</code></pre>

<p>Be sure the kickstart file should have the same url installtion location:</p>

<pre><code># cat centos6-oz.cfg 
text
skipx
install
url --url http://192.168.0.79/ks_mirror/CentOS-6.6-x86_64
repo --name=updates --baseurl=http://192.168.0.79/ks_mirror/CentOS-6.6-x86_64
lang en_US.UTF-8
</code></pre>

<h3>Build Image</h3>

<p>Build your own images via:</p>

<pre><code># oz-install -p -u -d1 -a centos6-oz.cfg centos66.tdl
</code></pre>

<p>Get the images via:</p>

<pre><code>[root@pc134 images]# pwd
/var/lib/libvirt/images
[root@pc134 images]# ls -l -h centos_66_x86_64.qcow2
-rw-rw-rw- 1 root root 1015M Oct 12 14:48 centos_66_x86_64.qcow2
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tips on Cloud-Init]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/10/12/tips-on-cloud-init/"/>
    <updated>2015-10-12T10:50:53+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/10/12/tips-on-cloud-init</id>
    <content type="html"><![CDATA[<h3>参考</h3>

<p>主要参考了  <br/>
<a href="http://huang-wei.github.io/programming/2013/12/23/run-cloud-init-in-local-kvm.html">http://huang-wei.github.io/programming/2013/12/23/run-cloud-init-in-local-kvm.html</a></p>

<p>这里主要记录的是操作步骤。</p>

<h3>介绍</h3>

<p>红帽介绍:   <br/>
 Cloud-Init 是一个用来自动配置虚拟机的初始设置（如主机名，网卡和密钥）的工具。它可以在
使用模板部署虚拟机时使用，从而达到避免网络冲突的目的。   <br/>
在使用这个工具前，cloud-init 软件包必须在虚拟机上被安装。安装后，Cloud-Init 服务会在系
统启动时搜索如何配置系统的信息。您可以使用只运行一次窗口来提供只需要配置一次的设置信息
；或在 新建虚拟机、编辑虚拟机和编辑模板窗口中输入虚拟机每次启动都需要的配置信息。</p>

<h3>cloud-init安装</h3>

<p>Ubuntu 14.04上可以通过以下命令来安装cloud-init:</p>

<pre><code>$ apt-cache search cloud-utils
cloud-utils - metapackage for installation of upstream cloud-utils source
$ sudo apt-get install cloud-utils
</code></pre>

<h3>镜像准备</h3>

<p>在<a href="http://cloud-images.ubuntu.com/releases/">http://cloud-images.ubuntu.com/releases/</a>
可以找到Ubuntu制作的ubuntu cloud image, image分版本, 这里使用14.04的image。</p>

<pre><code>$ wget http://cloud-images.ubuntu.com/releases/14.04.3/
release-20151008/ubuntu-14.04-server-cloudimg-amd64-disk1.img
</code></pre>

<p>取回来后的镜像可以直接使用，但解压开后读取速度会更快:</p>

<pre><code>$ qemu-img convert -O qcow2 ubuntu-14.04-server-cloudimg-amd64-disk1.img my_vm.img
</code></pre>

<p>对比两个镜像大小可以看到:</p>

<pre><code>$ qemu-img info ubuntu-14.04-server-cloudimg-amd64-disk1.img 
image: ubuntu-14.04-server-cloudimg-amd64-disk1.img
file format: qcow2
virtual size: 2.2G (2361393152 bytes)
disk size: 246M
cluster_size: 65536
Format specific information:
    compat: 0.10
$ qemu-img info my_vm.img 
image: my_vm.img
file format: qcow2
virtual size: 2.2G (2361393152 bytes)
disk size: 903M
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
</code></pre>

<h3>配置脚本内容</h3>

<p>my-user-data内容:</p>

<pre><code>$ cat my-user-data
#cloud-config
password: xxxxxx
chpasswd: { expire: False }
ssh_pwauth: True

ssh_authorized_keys:
 - ssh-rsa xxxxxx

timezone: Asia/Chongqing
</code></pre>

<p>通过my-user-data生成img文件:</p>

<pre><code>$ cloud-localds my-seed.img my-user-data
</code></pre>

<p>由之前的my_vm.img和my-seed.img文件启动虚拟机:</p>

<pre><code>$ qemu-system-x86_64 -net nic -net user,hostfwd=tcp::2222-:22 -hda my_vm.img -hdb my-seed.img -m 512
</code></pre>

<p>通过qemu的窗口或者ssh登录系统: <code>ssh -p 2222 ubuntu@localhost</code>.</p>

<h3>引入meta-data</h3>

<p>meta-data的内容与虚拟机的实例相关，只用来做初始化，虚拟机实例运行完一次以后就不需要修改
。但如果要引入更新，则重建一下instance-id即可。</p>

<p>更新my-meta-data文件内容:</p>

<pre><code>$ echo "instance-id: $(uuidgen || echo i-abcdefg)" &gt; my-meta-data
</code></pre>

<p>由my-meta-data和my-user-data生成my-seed.img文件:</p>

<pre><code>$ cloud-localds my-seed.img my-user-data my-meta-data
</code></pre>

<p>启动虚拟机:</p>

<pre><code>$ qemu-system-x86_64 -net nic -net user,hostfwd=tcp::2222-:22 -hda my_vm.img -hdb my-seed.img -m 512
</code></pre>

<h3>其他初始化行为</h3>

<p>需要初始化的脚本:</p>

<pre><code>$ cat hello_world.sh 
#!/bin/bash
echo "hello world!" &gt;&gt; /home/ubuntu/test
</code></pre>

<p>将初始化脚本和cloud config data合并:</p>

<pre><code>$ write-mime-multipart
--output=combined-userdata.txt hello_world.sh:text/x-shellscript my-user-data
</code></pre>

<p>由生成的combined-userdata.txt生成my-seed.img:</p>

<pre><code>$ echo "instance-id: $(uuidgen || echo i-abcdefg)" &gt; my-meta-data
$ cloud-localds my-seed.img combined-userdata.txt my-meta-data
</code></pre>

<p>重启后即可得到更新后的系统镜像.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Kickstarting Ubuntu in SpaceWalk]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/08/20/kickstarting-ubuntu-in-spacewalk/"/>
    <updated>2015-08-20T11:58:14+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/08/20/kickstarting-ubuntu-in-spacewalk</id>
    <content type="html"><![CDATA[<h3>Preparation</h3>

<p>You have to use apt-mirror for getting the packages to local repository, so that you
could directly install the system via http method. The configuration file for
apt-mirror is listed as following:</p>

<pre><code>$ cat /etc/apt/mirror.list
set base_path /mnt/myrepo
set nthreads     20
set _tilde 0
#################Trusty Repository Starts ########################
deb-amd64 http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse main/debian-installer restricted/debian-installer multiverse/debian-installer universe/debian-installer
deb-amd64 http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse main/debian-installer restricted/debian-installer universe/debian-installer
deb-amd64 http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse main/debian-installer restricted/debian-installer universe/debian-installer
deb-amd64 http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse
deb-amd64 http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse

deb-i386 http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse main/debian-installer restricted/debian-installer multiverse/debian-installer universe/debian-installer
deb-i386 http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse main/debian-installer restricted/debian-installer universe/debian-installer
deb-i386 http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse main/debian-installer restricted/debian-installer universe/debian-installer
deb-i386 http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse
deb-i386 http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse
#################Trusty Repository ends ########################

#################Precise Repository starts ########################
deb-amd64 http://mirrors.aliyun.com/ubuntu precise main main/debian-installer restricted restricted/debian-installer universe multiverse multiverse/debian-installer universe/debian-installer
deb-amd64 http://mirrors.aliyun.com/ubuntu precise-security main restricted universe multiverse main/debian-installer restricted/debian-installer universe/debian-installer
deb-amd64 http://mirrors.aliyun.com/ubuntu precise-updates main restricted universe multiverse main/debian-installer restricted/debian-installer universe/debian-installer
deb-amd64 http://mirrors.aliyun.com/ubuntu precise-proposed main restricted universe multiverse
deb-amd64 http://mirrors.aliyun.com/ubuntu precise-backports main restricted universe multiverse

deb-i386 http://mirrors.aliyun.com/ubuntu precise main main/debian-installer restricted restricted/debian-installer universe multiverse multiverse/debian-installer universe/debian-installer
deb-i386 http://mirrors.aliyun.com/ubuntu precise-security main restricted universe multiverse main/debian-installer restricted/debian-installer universe/debian-installer
deb-i386 http://mirrors.aliyun.com/ubuntu precise-updates main restricted universe multiverse main/debian-installer restricted/debian-installer universe/debian-installer
deb-i386 http://mirrors.aliyun.com/ubuntu precise-proposed main restricted universe multiverse
deb-i386 http://mirrors.aliyun.com/ubuntu precise-backports main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu precise-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu precise-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu precise-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu precise-backports main restricted universe multiverse
#################Precise Repository ends ########################
</code></pre>

<p>Sync your local repository via <code>apt-mirror</code>, the sync procedure could takes many days,
depends on your bandwidth.</p>

<h3>Make Your Own KickStart File</h3>

<p>You have to install <code>system-config-kickstart</code> for generating the kickstart file. But
the official program conflicts with hwdata, we manually downgrade it and install
specified version, then sytem-config-kickstart could be installed.</p>

<pre><code># apt-get remove hwda
# wget ftp://mirror.ovh.net/mirrors/ftp.debian.org/debian/pool/main/h/hwdata/hwdata_0.234-1_all.deb
# dpkg -i hwdata_0.267-1_all.deb
# sudo apt-get install system-config-kickstart
</code></pre>

<p>Run it and its effects is like following:</p>

<p><img src="/images/2015_08_20_12_07_59_637x562.jpg" alt="/images/2015_08_20_12_07_59_637x562.jpg" /></p>

<p>Select the installation method via:</p>

<p><img src="/images/2015_08_20_12_09_02_541x361.jpg" alt="/images/2015_08_20_12_09_02_541x361.jpg" /></p>

<p>Save your kickstart file, and save it into some webserver&rsquo;s directory, since PXE always
have the network connection, we could put it the reachable webserver.</p>

<h3>PXE Menu Configuration</h3>

<p>Just give out an example of the PXE Menu on SpaceWalk:</p>

<pre><code># cat /var/lib/tftpboot/pxelinux.cfg/default 
DEFAULT menu
PROMPT 0
MENU TITLE Cobbler | http://fedorahosted.org/cobbler
TIMEOUT 200
TOTALTIMEOUT 6000
ONTIMEOUT local

LABEL local
        MENU LABEL (local)
        MENU DEFAULT
        LOCALBOOT 0

LABEL precise-ia32:1:SpacewalkDefaultOrganization
        kernel /images/precise-ia32:1:SpacewalkDefaultOrganization/vmlinuz
        MENU LABEL precise-ia32:1:SpacewalkDefaultOrganization
        append ks=http://192.168.0.79/ubuntu1204kickstart1.cfg initrd=/images/precise-ia32:1:SpacewalkDefaultOrganization/initrd.gz ksdevice=eth0 --
        ipappend 2
MENU end
</code></pre>

<p>We use the kickstart file located in a webserver, using this we could install the
system unattendly.</p>

<p>An example of the this kickstart file is listed:</p>

<pre><code># cat ubuntu1204kickstart1.cfg  | more
#Generated by Kickstart Configurator
#platform=x86

#System language
lang en_US
#Language modules to install
langsupport en_US
#System keyboard
keyboard us
#System mouse
mouse
#System timezone
timezone Asia/Shanghai
#Root password
rootpw --iscrypted xxxxxxxxxxxxxxxxxxxxxxxxxxx
#Initial user
user xxxx --fullname "xxxx" --iscrypted --password xxxxxxxxxxxxxxxxxxxxxx
#Reboot after installation
reboot
#Use text mode install
text
#Install OS instead of upgrade
install
#Use Web installation
url --url http://192.168.0.79/ubuntu/
#System bootloader configuration
bootloader --location=mbr 
#Clear the Master Boot Record
zerombr yes
#Partition clearing information
clearpart --all --initlabel 
#Disk partitioning information
part swap --size 1024 
part / --fstype ext4 --size 1 --grow 
#System authorization infomation
auth  --useshadow  --enablemd5 
#Network information
network --bootproto=dhcp --device=eth0
#Firewall configuration
firewall --disabled 
#Do not configure the X Window System
skipx

%packages
ubuntu-minimal
openssh-server
screen
curl
wget

%post

# update fstab for the root partition
perl -pi -e 's/(errors=remount-ro)/noatime,nodiratime,$1,barrier=0/' /etc/fstab

# point sh to bash instead of dash
rm /bin/sh
ln -s /bin/bash /bin/sh

# add normal apt source list
(
cat &lt;&lt;'EOP'
deb http://192.168.0.79/ubuntu/ precise main restricted universe
deb http://192.168.0.79/ubuntu/ precise-security main restricted universe
deb http://192.168.0.79/ubuntu/ precise-updates main restricted universe
EOP
) &gt; /etc/apt/sources.list
apt-get update
apt-get upgrade -y

# install some additional packages
# apt-get install -y xenstore-utils

# set up xenserver automation scripts
# AUTOMATER_REPO=https://raw.github.com/krobertson/xenserver-automater
# curl $AUTOMATER_REPO/master/usr/sbin/xe-set-hostname &gt; /usr/sbin/xe-set-hostname
# curl $AUTOMATER_REPO/master/usr/sbin/xe-set-network &gt; /usr/sbin/xe-set-network
# curl $AUTOMATER_REPO/master/usr/sbin/generate-sshd-keys &gt; /usr/sbin/generate-sshd-keys
# curl $AUTOMATER_REPO/master/etc/init/xe-automator.conf &gt; /etc/init/xe-automator.conf
# chmod a+x /usr/sbin/xe-set-hostname
# chmod a+x /usr/sbin/xe-set-network
# chmod a+x /usr/sbin/generate-sshd-keys

# setup locales
locale-gen en_US.UTF-8
update-locale LANG="en_US.UTF-8"
echo 'LANG=en_US.UTF-8' &gt;&gt; /etc/environment
echo 'LC_ALL=en_US.UTF-8' &gt;&gt; /etc/environment

# install xe tools
# cd /tmp
# wget http://some/url/to/xe-guest-utilities_6.0.0-743_amd64.deb
# dpkg -i xe-guest-utilities_6.0.0-743_amd64.deb

# install paravirt kernel image
apt-get install -f -y linux-virtual
dpkg -l | grep generic | grep linux | awk '{print $2}' | xargs apt-get remove -y

# clean up some stuff
rm -f /etc/ssh/ssh_host_*
rm -f /var/cache/apt/archives/*.deb
rm -f /var/cache/apt/*cache.bin
rm -f /var/lib/apt/lists/*_Packages
</code></pre>

<h3>A Known Bug</h3>

<p>The initrd.gz file and vmlinuz file should be picked from the installation iso. While
the spacewalk uses a CentOS based initrd.gz file for starting the system. thus you will
met &ldquo;cdrom&rdquo; error.</p>

<pre><code>$ ls -l /var/lib/tftpboot/images/precise-ia32:1:SpacewalkDefaultOrganization/
total 31788
-r--r--r-- 1 root root 18434355 Aug 20 11:36 initrd.gz
-r--r--r-- 3 root root  8188836 Aug  7  2014 initrd.gz.back
-r--r--r-- 3 root root  5919280 Jul 29  2014 vmlinuz
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Automatically Create Virtual Machine]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/08/13/automatically-create-virtual-machine/"/>
    <updated>2015-08-13T16:21:23+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/08/13/automatically-create-virtual-machine</id>
    <content type="html"><![CDATA[<p>Just record the whole scripts for create/define/start the vm machine.</p>

<pre><code>#!/bin/sh
# $1: The name of the virtual machine. 

### 1. Check Input Parameters. 
if [ $# != 1 ]
then
  echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
  echo "!!         Parameters error       !!"
  echo "!! Example: ./createvm.sh name    !!"
  echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
  exit 1
fi

### 2. Create the qcow2 file in local directory. 
echo $1
qemu-img create -f qcow2 -b /home/juju/img/WolfHunter/SpaceWalk/Base/packer-ubuntu-1204-server-i386 $1.qcow2

### 3. Generate Random MAC Address.
printf -v macaddr "52:54:%02x:%02x:%02x:%02x" $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff )) $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff ))
# echo $macaddr
### 3.1 Check whether this MAC Address is in the host's existing items. 
declare maclist

### 3.2 Get the MAC Address List
for vm in $(virsh list --all | tail -n +3 |  awk '{print $2}')
do
        # Multiple NIC need this. 
    for mac_item in $(virsh dumpxml $vm | grep "mac address" | awk -F "'" '{print $2}')
                do
                        # echo $mac_item
                        maclist+=($mac_item)
                done
done

# echo ${maclist[*]} 
# echo ${#maclist[@]}

### 3.3 Processing possible duplicated problem. 
### We don't hope the generate random mac address to be duplicated, so write whatever you want to see under the while loop for debugging
### Judge if the generated random mac address duplicated. 
while [[ ${maclist[*]} =~ ${macaddr} ]]
do
        echo "yes, you entered while for changing the mac address!"
        printf -v macaddr "52:54:%02x:%02x:%02x:%02x" $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff )) $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff ))
        echo $macaddr
done

### 3.4 Only for debugging purpose, view result
### For debugging purpose
### if [[ ${maclist[*]} =~ ${macaddr} ]]
### then
###     echo "Yes, it's in the existing mac list"
### else
###     echo "Congratulations, it's safe to use this mac!"
### fi
### echo $macaddr

### 4. Create new xml file and modify the xml file.
### 4.1 Create the file
mkdir -p xml
cp ./Template.xml ./xml/$1.xml
### 4.2 Remove the uuid(Virt-manager will automatically generate it)
sed -i '/uuid/d' ./xml/$1.xml
### 4.3 Replace the MAC Address
sed -i -r "s/(.*)([a-zA-Z0-9]{2}:[a-zA-Z0-9]{2}:[a-zA-Z0-9]{2}:[a-zA-Z0-9]{2}:[a-zA-Z0-9]{2}:[a-zA-Z0-9]{2})(.*)/\1$macaddr\3/g" ./xml/$1.xml 
### 4.4 Replace the virt disk file
imagepath=($PWD/$1.qcow2)
echo $imagepath
sed -i "s#&lt;source file.*#&lt;source file='$imagepath'/&gt;#g"  ./xml/$1.xml

### 5. Change the VM Name
sed -i "s#&lt;name.*#&lt;name&gt;$1&lt;/name&gt;#g" ./xml/$1.xml

### 6. Define and Start VM Machine
virsh define $PWD/xml/$1.xml
virsh start $1
</code></pre>

<p>Steps for create the machine:</p>

<pre><code># ./createvm.sh zz_bee1
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Trouble Shooting on SpaceWalk OSAD on Ubuntu Clients]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/08/12/trouble-shooting-on-spacewalk-osad-on-ubuntu-clients/"/>
    <updated>2015-08-12T11:25:34+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/08/12/trouble-shooting-on-spacewalk-osad-on-ubuntu-clients</id>
    <content type="html"><![CDATA[<h3>Problem</h3>

<p>On Clients(Ubuntu nodes), you will see lots of the following message in
<code>/var/log/osad</code>:</p>

<pre><code>$ tail /var/log/osad
2015-08-11 19:31:14 jabber_lib.main: Unable to connect to jabber servers, sleeping 78 seconds
2015-08-11 19:32:32 jabber_lib.main: Unable to connect to jabber servers, sleeping 117 seconds
</code></pre>

<p>When restart the osda service you will see following error message:</p>

<pre><code># service osad restart
OSAD SpaceWalk Deamon osad                                                     Traceback (most recent call last):
  File "/usr/share/rhn/osad/jabber_lib.py", line 252, in setup_connection
    c = self._get_jabber_client(js)
  File "/usr/share/rhn/osad/jabber_lib.py", line 309, in _get_jabber_client
    c.connect()
  File "/usr/share/rhn/osad/jabber_lib.py", line 583, in connect
    self.disconnect()
  File "/usr/share/rhn/osad/jabber_lib.py", line 653, in disconnect
    jabber.Client.disconnect(self)
  File "/usr/lib/python2.7/dist-packages/jabber/jabber.py", line 432, in disconnect
    xmlstream.Client.disconnect(self)
  File "/usr/lib/python2.7/dist-packages/jabber/xmlstream.py", line 388, in disconnect
    while self.process(): pass
  File "/usr/share/rhn/osad/jabber_lib.py", line 1059, in process
    raise JabberError("Premature EOF")
JabberError: Premature EOF
</code></pre>

<p>Though seeing this error, your osad will start and running, but with errors.</p>

<h3>Trouble Shooting</h3>

<p>Make sure the port 5222 and 5269 of spacewalk server are telnet-able from client machine:</p>

<pre><code>adminubuntu@spacewalknode1:~$ telnet spacewalk 5222
Trying 10.11.11.3...
Connected to spacewalk.
Escape character is '^]'.
^]
telnet&gt; quit
Connection closed.
adminubuntu@spacewalknode1:~$ telnet spacewalk 5269
Trying 10.11.11.3...
Connected to spacewalk.
Escape character is '^]'.
^]
telnet&gt; 
</code></pre>

<p>Make sure you register yourself on client using FQDN but not the IP Address:</p>

<pre><code># rhnreg_ks --activationkey=1-precise --serverUrl=http://spacewalk/XMLRPC --force
# service osad restart
</code></pre>

<p>If by this you won&rsquo;t pass the osad check, you should setup the local dns server, which
enable name resolve of <code>spacewalk</code>, you could take following article for reference:  <br/>
<a href="http://purplepalmdash.github.io/blog/2015/08/05/enable-dhcp-slash-dns-server-for-spacewalker-server/">http://purplepalmdash.github.io/blog/2015/08/05/enable-dhcp-slash-dns-server-for-spacewalker-server/</a></p>

<p>For checking the dns resole, run following command on client:</p>

<pre><code>adminubuntu@spacewalknode1:~$ dig spacewalk

; &lt;&lt;&gt;&gt; DiG 9.8.1-P1 &lt;&lt;&gt;&gt; spacewalk
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 16045
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 0

;; QUESTION SECTION:
;spacewalk.                     IN      A

;; ANSWER SECTION:
spacewalk.              604800  IN      A       10.11.11.3

;; AUTHORITY SECTION:
spacewalk.              604800  IN      NS      spacewalk.

;; Query time: 2 msec
;; SERVER: 10.11.11.3#53(10.11.11.3)
;; WHEN: Wed Aug 12 03:34:18 2015
;; MSG SIZE  rcvd: 57
</code></pre>

<h3>Result</h3>

<p>After resolving this problem, your log should like this:</p>

<p>On Server:</p>

<pre><code>$ tail /var/log/message
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] [::ffff:10.11.11.100, port=45486] connect
Aug 12 10:34:50 spacewalk named[993]: error (network unreachable) resolving 'ns4.p27.dynect.net/A/IN': 2001:500:94::100#53
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] created user: user=osad-c942811c1c; realm=
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] registration succeeded, requesting user creation: jid=osad-c942811c1c@spacewalk
Aug 12 10:34:50 spacewalk jabberd/sm[1371]: created user: jid=osad-c942811c1c@spacewalk
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] legacy authentication succeeded: host=, username=osad-c942811c1c, resource=osad, TLS negotiated
Aug 12 10:34:50 spacewalk jabberd/c2s[1379]: [9] requesting session: jid=osad-c942811c1c@spacewalk/osad
Aug 12 10:34:50 spacewalk jabberd/sm[1371]: session started: jid=osad-c942811c1c@spacewalk/osad
</code></pre>

<p>In SpaceWalk backend you will see:</p>

<p><img src="/images/2015_08_12_11_37_48_538x222.jpg" alt="/images/2015_08_12_11_37_48_538x222.jpg" /> <br/>
Now you could direct <code>push</code> your modification to clients in SpaceWalk backend.</p>
]]></content>
  </entry>
  
</feed>
