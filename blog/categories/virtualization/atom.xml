<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Virtualization | Dash]]></title>
  <link href="http://purplepalmdash.github.io/blog/categories/virtualization/atom.xml" rel="self"/>
  <link href="http://purplepalmdash.github.io/"/>
  <updated>2015-12-27T23:06:31+08:00</updated>
  <id>http://purplepalmdash.github.io/</id>
  <author>
    <name><![CDATA[Dash]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[On Virtualbox Virtualized CS Env]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/12/27/on-virtualbox-virtualized-cs-env/"/>
    <updated>2015-12-27T10:07:39+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/12/27/on-virtualbox-virtualized-cs-env</id>
    <content type="html"><![CDATA[<p>Using Virtualbox for building the testing env of cloudstack together with
elastistor.</p>

<h3>Networking</h3>

<p>Host-only 1: 192.168.56.1/24, no DHCP.   <br/>
Host-only 2: 172.30.0.1/24, no DHCP.   <br/>
Host-only 3: 10.10.100.1/24, no DHCP.</p>

<h3>Virtual Machine</h3>

<h4>Machine 1</h4>

<p>For installing CentOS 6.7 based CloudStack 4.5.2.</p>

<pre><code>name: csman
Type: Linux
Version: Red Hat(64-bit) 
Memory: 4096 MB
Create  a virtual hard drive now
Choosing VDI
Choose Dynamically allocated
Select the size: adjusting to 80.00 GB
Setting: 
Adjust CPU Processor to 2
Storage: Choosing CentOS6.7 DVD 1. 
Controller: SATA, Choosing "Use Host I/O Cache", this will greatly improve the
speed.
Network, The Adpter 1, choosing NAT for default. 
Click Start for installing.   
Choosing Basic Server in installing, enable eth0 for dhcp.    
</code></pre>

<p>After installation, shutdown the VM, add the second adapter. <br/>
Configure the newly-added eth1:</p>

<pre><code># vim /etc/sysconfig/network-scripts/ifcfg-eth1 
DEVICE=eth1
TYPE=Ethernet
IPADDR=192.168.56.11
PREFIX=24
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=none
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME=MGMT
</code></pre>

<p>Shutdown the vm again , add the third adapter, Configure the newly-added eth2:</p>

<pre><code>[root@csman ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth2 
DEVICE=eth2
TYPE=Ethernet
IPADDR=172.30.0.11
PREFIX=24
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=none
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME=PUBLIC
</code></pre>

<p>Shutdown the vm again ,this time add eth3, and configure it:</p>

<pre><code>[root@csman ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth3
DEVICE=eth3
TYPE=Ethernet
IPADDR=10.10.100.11
PREFIX=24
NAME=STOR
BOOTPROTO=none
ONBOOT=yes
MTU=9000
VLAN=yes
USERCTL=no
MTU=9000
</code></pre>

<p>Comparing to the guideline, eth3 didn&rsquo;t add vlan tagged networking.</p>

<h4>Machine 2</h4>

<p>For installing Xenserver, which will connected to above cloudstack management
server.</p>

<pre><code>name: XenServer
Type: Linux
Version: Red Hat(64-bit)
Memory: 8192 MB(more than 3072 is OK)
Create a virtual hard drive now
Choosing VDI
Choose Dynamically allocated
Select the size: adjusting to 120.00 GB
Setting: 
Adjust CPU Processor to 4
Storage: Choosing XenServer-6.2.0-install-cd.iso
Controller: SATA, "Use Host I/O Cache"
Audio: Disable
Network: Adapter 1, choosing Host-only Adapter, Name choosing vboxnet,
Advanced choosing Promiscuous Mode: allow all. 
Click Start for installing.  
Networking: 192.168.56.101/255.255.255.0, gateway,192.168.56.1
Hostname: xenserver
DNS Server 1: 180.76.76.76
DNS Server 2: 223.5.5.5
DNS Server 3: 8.8.8.8
Timezone: Asia/Shanghai
NTP Server 1: 3.cn.pool.ntp.org
NTP Server 2: 3.asia.pool.ntp.org
NTP Server 3: cn.ntp.org.cn
</code></pre>

<p>After installation, shutdown, and add a new adapter, scan it in XenCenter.</p>

<h4>Machine 3</h4>

<p>Windows 7, for installing xen desktop management tool. Which could attaches to
host-only adatper 1, with a 192.168.56.0/24 address.</p>

<h4>Machine 4</h4>

<p>4G/2 Core, For installing the Elastistor.</p>

<h4>CloudStack(Machine 1)</h4>

<p>Selinux:</p>

<pre><code># sed -i "/SELINUX=enforcing/ c\SELINUX=permissive" /etc/selinux/config
</code></pre>

<p>Hostname, change <code>/etc/hosts</code> file:</p>

<pre><code>127.0.0.1 localhost localhost.cstack.local
192.168.56.11 csman.cstack.local csman
192.168.56.101 xenserver.cstack.local xenserver
</code></pre>

<p>NTP Installation:</p>

<pre><code># yum install -y ntp
# chkconfig ntpd on
# service ntpd start
</code></pre>

<p>Install cloudstack/mysql:</p>

<pre><code># yum install -y cloudstack-management mysql-server
</code></pre>

<p>NFS configuration:</p>

<pre><code># mkdir /exports
# mkdir -p /exports/primary
# mkdir -p /exports/secondary
# chmod 777 -R /exports
# echo "/exports/primary 10.10.100.0/24(rw,async,no_root_squash)" &gt; /etc/exports
# echo "/exports/secondary 10.10.100.0/24(rw,async,no_root_squash)" &gt;&gt; /etc/exports
# exportfs -a
</code></pre>

<p>sysconfig for nfs:</p>

<pre><code># sed -i -e '/#MOUNTD_NFS_V3="no"/ c\MOUNTD_NFS_V3="yes"' -e '/#RQUOTAD_PORT=875/ c\RQUOTAD_PORT=875' -e '/#LOCKD_TCPPORT=32803/ c\LOCKD_TCPPORT=32803' -e '/#LOCKD_UDPPORT=32769/ c\LOCKD_UDPPORT=32769' -e '/#MOUNTD_PORT=892/ c\MOUNTD_PORT=892' -e '/#STATD_PORT=662/ c\STATD_PORT=662' -e '/#STATD_OUTGOING_PORT=2020/ c\STATD_OUTGOING_PORT=2020' /etc/sysconfig/nfs
</code></pre>

<p>Iptables configuration:</p>

<pre><code>sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 111 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 111 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 2049 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 2049 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 2020 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 32803 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 32769 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 892 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 892 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 875 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 875 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 662 -j ACCEPT" /etc/sysconfig/iptables
sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 662 -j ACCEPT" /etc/sysconfig/iptables
service iptables restart
</code></pre>

<p>nfs service:</p>

<pre><code># chkconfig nfs on
# service nfs start
</code></pre>

<p>MySQL Server Configuration:</p>

<pre><code># sed -i -e '/datadir/ a\innodb_rollback_on_timeout=1' -e '/datadir/ a\innodb_lock_wait_timeout=600' -e '/datadir/ a\max_connections=350' -e '/datadir/ a\log-bin=mysql-bin' -e "/datadir/ a\binlog-format = 'ROW'" -e "/datadir/ a\bind-address = 0.0.0.0" /etc/my.cnf
# chkconfig mysqld on
# service mysqld start
# mysql_secure_installation
# mysql -u root -p  (enter password when prompted)
mysql&gt; GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;
mysql&gt; quit
</code></pre>

<p>Setup Database:</p>

<pre><code># cloudstack-setup-databases cloud:&lt;password&gt;@127.0.0.1 --deploy-as=root:&lt;password&gt;
# cloudstack-setup-management
</code></pre>

<p>vhd-util:</p>

<pre><code># cd /usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver/
# wget http://download.cloud.com.s3.amazonaws.com/tools/vhd-util
# chmod 755 /usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver/vhd-util
</code></pre>

<p>System VM template:</p>

<pre><code># /usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /exports/secondary/ -u http://192.168.177.13/systemvm64template-4.5-xen.vhd.bz2 -h xenserver -F
</code></pre>

<h3>Customization</h3>

<p>Don&rsquo;t check hvm for xenserver:</p>

<pre><code># mysql -p&lt;YOURPASSWORD&gt; cloud -e \ "INSERT INTO cloud.configuration (category, instance, component, name, value, description) VALUES ('Advanced', 'DEFAULT', 'management-server', 'xen.check.hvm', 'false', 'Shoud we allow only the XenServers support HVM');"
</code></pre>

<p>Install cloudstack-usage:</p>

<pre><code># yum install cloudstack-usage -y
# service cloudstack-usage start
</code></pre>

<p>Disable the HVM:</p>

<pre><code># mysql -p&lt;password&gt; cloud -e \ "INSERT INTO cloud.configuration (category, instance, component, name, value, description) VALUES ('Advanced', 'DEFAULT', 'management-server', 'xen.check.hvm', 'false', 'Shoud we allow only the XenServers support HVM');"
</code></pre>

<p>Global Setting:</p>

<pre><code>mysql -u cloud -p&lt;password&gt;
UPDATE cloud.configuration SET value='8096' WHERE name='integration.api.port';
UPDATE cloud.configuration SET value='60' WHERE name='expunge.delay';
UPDATE cloud.configuration SET value='60' WHERE name='expunge.interval';
UPDATE cloud.configuration SET value='60' WHERE name='account.cleanup.interval';
UPDATE cloud.configuration SET value='60' WHERE name='capacity.skipcounting.hours';
UPDATE cloud.configuration SET value='0.99' WHERE name='cluster.cpu.allocated.capacity.disablethreshold';
UPDATE cloud.configuration SET value='0.99' WHERE name='cluster.memory.allocated.capacity.disablethreshold';
UPDATE cloud.configuration SET value='0.99' WHERE name='pool.storage.capacity.disablethreshold';
UPDATE cloud.configuration SET value='0.99' WHERE name='pool.storage.allocated.capacity.disablethreshold';
UPDATE cloud.configuration SET value='60000' WHERE name='capacity.check.period';
UPDATE cloud.configuration SET value='1' WHERE name='event.purge.delay';
UPDATE cloud.configuration SET value='60' WHERE name='network.gc.interval';
UPDATE cloud.configuration SET value='60' WHERE name='network.gc.wait';
UPDATE cloud.configuration SET value='600' WHERE name='vm.op.cleanup.interval';
UPDATE cloud.configuration SET value='60' WHERE name='vm.op.cleanup.wait';
UPDATE cloud.configuration SET value='600' WHERE name='vm.tranisition.wait.interval';
UPDATE cloud.configuration SET value='60' WHERE name='vpc.cleanup.interval';
UPDATE cloud.configuration SET value='4' WHERE name='cpu.overprovisioning.factor';
UPDATE cloud.configuration SET value='8' WHERE name='storage.overprovisioning.factor';
UPDATE cloud.configuration SET value='192.168.56.11/32' WHERE name='secstorage.allowed.internal.sites';
UPDATE cloud.configuration SET value='192.168.56.0/24' WHERE name='management.network.cidr';
UPDATE cloud.configuration SET value='192.168.56.11' WHERE name='host';
UPDATE cloud.configuration SET value='false' WHERE name='check.pod.cidrs';
UPDATE cloud.configuration SET value='0' WHERE name='network.throttling.rate';
UPDATE cloud.configuration SET value='0' WHERE name='vm.network.throttling.rate';
UPDATE cloud.configuration SET value='GMT' WHERE name='usage.execution.timezone';
UPDATE cloud.configuration SET value='16:00' WHERE name='usage.stats.job.exec.time';
UPDATE cloud.configuration SET value='true' WHERE name='enable.dynamic.scale.vm';
UPDATE cloud.configuration SET value='9000' WHERE name='secstorage.vm.mtu.size';
UPDATE cloud.configuration SET value='60' WHERE name='alert.wait';
UPDATE cloud.service_offering SET ram_size='128', speed='128' WHERE vm_type='domainrouter';
UPDATE cloud.service_offering SET ram_size='128', speed='128' WHERE vm_type='elasticloadbalancervm';
UPDATE cloud.service_offering SET ram_size='128', speed='128' WHERE vm_type='secondarystoragevm';
UPDATE cloud.service_offering SET ram_size='128', speed='128' WHERE vm_type='internalloadbalancervm';
UPDATE cloud.service_offering SET ram_size='128', speed='128' WHERE vm_type='consoleproxy';
UPDATE cloud.vm_template SET removed=now() WHERE id='2';
UPDATE cloud.vm_template SET url='http://192.168.56.11/centos56-x86_64.vhd.bz2' WHERE unique_name='centos56-x86_64-xen';
quit

service cloudstack-management restart
</code></pre>

<p>Add iptables rules and restart:</p>

<pre><code># sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 8096 -j ACCEPT" /etc/sysconfig/iptables
# service iptables restart
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CloudStack Dev Env Setup]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/12/26/cloudstack-dev-env-setup/"/>
    <updated>2015-12-26T09:24:22+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/12/26/cloudstack-dev-env-setup</id>
    <content type="html"><![CDATA[<h3>Hypervisor Preparation</h3>

<p>Use Virtualbox for setting up the development env, the configuration of the
networking are lisetd as following:</p>

<pre><code>Host-Only 1: 192.168.56.1/255.255.255.0
Host-Only 2: 172.30.0.1/255.255.255.0
Host-Only 3: none
NAT network: 10.0.2.0/24
</code></pre>

<p>Host-Only 1:  <br/>
<img src="/images/2015_12_26_09_23_32_460x220.jpg" alt="/images/2015_12_26_09_23_32_460x220.jpg" />  <br/>
Host-Only 2:  <br/>
<img src="/images/2015_12_26_09_23_50_450x226.jpg" alt="/images/2015_12_26_09_23_50_450x226.jpg" />  <br/>
Host-Only 3:  <br/>
<img src="/images/2015_12_26_09_24_02_459x255.jpg" alt="/images/2015_12_26_09_24_02_459x255.jpg" />  <br/>
NAT:  <br/>
<img src="/images/2015_12_26_09_27_57_500x288.jpg" alt="/images/2015_12_26_09_27_57_500x288.jpg" /></p>

<h3>Virtual Machine</h3>

<p>Install CentOS6.7, the network configuration is listed as:</p>

<pre><code>eth0 -&gt; Host-Only 1
eth1 -&gt; NAT
eth2 -&gt; Host-Only 2
eth3 -&gt; Host-Only 3
</code></pre>

<p>The configuration files for NAT working is listed as:</p>

<pre><code>[root@CSMAN yum.repos.d]# cat /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
TYPE=Ethernet
UUID=fc709b6b-54c0-4181-97cc-d91f14228fdc
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=none
HWADDR=08:00:27:CC:35:D9
IPADDR=192.168.56.11
PREFIX=24
GATEWAY=192.168.56.1
#DNS1=223.5.5.5
#DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth0"
[root@CSMAN yum.repos.d]# cat /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1 
TYPE=Ethernet 
#IPADDR=10.0.2.11 
#GATEWAY=10.0.2.22 
PREFIX=24 
ONBOOT=yes 
NM_CONTROLLED=no 
BOOTPROTO=dhcp
DEFROUTE=yes 
PEERROUTES=yes 
IPV4_FAILURE_FATAL=yes 
IPV6INIT=no 
NAME=NAT 
DNS1=180.76.76.76
[root@CSMAN yum.repos.d]# cat /etc/sysconfig/network-scripts/ifcfg-eth2
DEVICE=eth2 
TYPE=Ethernet 
IPADDR=172.30.0.11 
PREFIX=24 
ONBOOT=yes 
NM_CONTROLLED=no 
BOOTPROTO=none 
IPV4_FAILURE_FATAL=yes 
IPV6INIT=no 
NAME=PUBLIC 
[root@CSMAN yum.repos.d]# cat /etc/sysconfig/network-scripts/ifcfg-eth3
CE=eth3 
TYPE=Ethernet 
BOOTPROTO=none 
ONBOOT=yes 
MTU=9000 
VLAN=yes 
USERCTL=no 
MTU=9000 
[root@CSMAN yum.repos.d]# cat /etc/sysconfig/network-scripts/ifcfg-eth3.100
DEVICE=eth3.100 
TYPE=Ethernet 
IPADDR=10.10.100.11 
PREFIX=24 
ONBOOT=yes 
BOOTPROTO=none 
NAME=PRI-STOR 
VLAN=yes 
USERCTL=no 
MTU=9000 
[root@CSMAN yum.repos.d]# cat /etc/sysconfig/network-scripts/ifcfg-eth3.101
DEVICE=eth3.101 
TYPE=Ethernet 
IPADDR=10.10.101.11 
PREFIX=24 
ONBOOT=yes 
BOOTPROTO=none 
NAME=SEC-STOR 
VLAN=yes 
USERCTL=no 
MTU=9000 
</code></pre>

<p>Be notice the networking of eth1 should changes to following, for NatNetwork
won&rsquo;t give us the priviledge of accessing internet.</p>

<p><img src="/images/2015_12_26_13_23_34_509x313.jpg" alt="/images/2015_12_26_13_23_34_509x313.jpg" /></p>

<h3>CloudStack Configuration</h3>

<h4>SELinux</h4>

<p>Change selinux to permissive:</p>

<pre><code>[root@csman ~]# cat /etc/selinux/config 

SELINUX=permissive
[root@csman ~]# reboot
</code></pre>

<h4>Hostname</h4>

<pre><code>[root@csman ~]# cat /etc/sysconfig/network
NETWORKING=yes
HOSTNAME=csman
GATEWAY=192.168.56.1
[root@csman ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
localhost.cstack.local
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.56.11   csman.cstack.local      csman
192.168.56.101  xenserver.cstack.local  xenserver
</code></pre>

<h4>NTP</h4>

<p>Install ntp service via:</p>

<pre><code>[root@csman ~]# yum install -y ntp
[root@csman ~]# service ntpd start
Starting ntpd:                                             [  OK  ]
[root@csman ~]# chkconfig ntpd on
</code></pre>

<h4>Necessary Packages</h4>

<p>Install them via following command, for these tools will be useful during
installation.</p>

<pre><code># yum install -y python-pip wget nethogs
</code></pre>

<h4>MySQL</h4>

<p>Install and configure:</p>

<pre><code># yum install -y mysql-server MySQL-python
# vim /etc/my.cnf
    + # CloudStack MySQL settings
    + innodb_rollback_on_timeout=1
    + innodb_lock_wait_timeout=600
    + max_connections=700
    + log-bin=mysql-bin
    + binlog-format = 'ROW'
    + bind-address=0.0.0.0

    [mysqld_safe]
</code></pre>

<p>Save the service and start it:</p>

<pre><code># service mysqld start
# chkconfig mysqld on
</code></pre>

<p>Drop the anonymous user and test database:</p>

<pre><code>[root@csman ~]# mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.1.73-log Source distribution

Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; drop user ''@'csman';
Query OK, 0 rows affected (0.00 sec)

mysql&gt; drop user ''@'localhost';
Query OK, 0 rows affected (0.00 sec)

mysql&gt; select user,host,password from mysql.user;
+------+-----------+----------+
| user | host      | password |
+------+-----------+----------+
| root | localhost |          |
| root | csman     |          |
| root | 127.0.0.1 |          |
+------+-----------+----------+
3 rows in set (0.00 sec)

mysql&gt; delete from mysql.db where db like 'test%';
Query OK, 2 rows affected (0.00 sec)

mysql&gt; select * from mysql.db;
Empty set (0.01 sec)

mysql&gt; drop database test;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; \q
Bye
</code></pre>

<p>Run <code>mysql_secure_installation</code> to set the user password, and remove anonymous
uses.</p>

<h4>CloudStack-Management</h4>

<p>Install via:</p>

<pre><code># yum install -y cloudstack-management
</code></pre>

<h4>cloudmonkey</h4>

<p>Install it via:</p>

<pre><code>$ pip install cloudmonkey
</code></pre>

<p>But the installed cloudmonkey won&rsquo;t be used, later will be fixed.</p>

<h4>Configure database</h4>

<pre><code>[root@csman ~]# cloudstack-setup-databases cloud:engine123@127.0.0.1  --deploy-as root:engine123
[root@csman ~]# cloudstack-setup-management
</code></pre>

<h4>NFS</h4>

<p>Create the nfs related folders and configuration files.</p>

<pre><code>[root@csman ~]# mkdir /exports
[root@csman ~]# mkdir -p /exports/secondary
[root@csman ~]# mkdir -p /exports/primary
[root@csman ~]# echo "/exports/primary 10.10.100.0/24(rw,async,no_root_squash)"&gt;/etc/exports
[root@csman ~]# echo "/exports/primary 10.10.101.0/24(rw,async,no_root_squash)"&gt;&gt;/etc/exports
[root@csman ~]# cat /etc/exports 
/exports/primary 10.10.100.0/24(rw,async,no_root_squash)
/exports/primary 10.10.101.0/24(rw,async,no_root_squash)
# service nfs start
# exportfs -a
# chkconfig nfs on
# chkconfig rpcbind on
# chmod 777 -R /exports/
</code></pre>

<p>update the configuration of /etc/sysconfig/nfs:</p>

<pre><code># sed -i -e '/#MOUNTD_NFS_V3="no"/ c\MOUNTD_NFS_V3="yes"' -e '/#RQUOTAD_PORT=875/ c\RQUOTAD_PORT=875' -e '/#LOCKD_TCPPORT=32803/ c\LOCKD_TCPPORT=32803' -e '/#LOCKD_UDPPORT=32769/ c\LOCKD_UDPPORT=32769' -e '/#MOUNTD_PORT=892/ c\MOUNTD_PORT=892' -e '/#STATD_PORT=662/ c\STATD_PORT=662' -e '/#STATD_OUTGOING_PORT=2020/ c\STATD_OUTGOING_PORT=2020' /etc/sysconfig/nfs
</code></pre>

<h4>Iptables</h4>

<p>Add following configuraitons:</p>

<pre><code># sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 111 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 111 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 2049 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 2049 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 2020 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 32803 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 32769 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 892 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 892 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 875 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 875 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 662 -j ACCEPT" /etc/sysconfig/iptables
# sed -i -e "/:OUTPUT/ a\-A INPUT -p udp -m udp --dport 662 -j ACCEPT" /etc/sysconfig/iptables
</code></pre>

<p>Restart the iptables restart:</p>

<pre><code># service iptables restart
# servcie nfs restart
</code></pre>

<h4>nginx</h4>

<p>Install nginx via:</p>

<pre><code># echo "[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/\$releasever/\$basearch/
gpgcheck=0
enabled=1" &gt; /etc/yum.repos.d/nginx.repo
# yum install nginx -y
# sed -i -e "/:OUTPUT/ a\-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT" /etc/sysconfig/iptables
# service iptables restart
# cd /usr/share/nginx/html/
# scp dash@192.168.177.11:/home/dash/Downloads/centos56-x86_64.vhd.bz2 ./
</code></pre>

<h4>vhd-util</h4>

<p>Download the vhd-util, cause we want to use xenserver:</p>

<pre><code># cd /usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver/
# wget http://download.cloud.com.s3.amazonaws.com/tools/vhd-util
# chmod 777 vhd-util 
</code></pre>

<h4>Cloudstack Usage Server</h4>

<pre><code># yum install cloudstack-usage -y
# service cloudstack-usage start
</code></pre>

<h4>System VM</h4>

<pre><code>#  /usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /exports/secondary -u http://192.168.177.13/systemvm64template-4.5-xen.vhd.bz2 -h xenserver -F
</code></pre>

<h4>HVM Configuration</h4>

<p>Configure the management-server&rsquo;s configuration for xenserver&rsquo;s checking hvm to false:</p>

<pre><code>[root@csman ~]# mysql -pengine123 cloud -e \ "INSERT INTO cloud.configuration (category, instance, component, name, value, description) VALUES ('Advanced', 'DEFAULT', 'management-server', 'xen.check.hvm', 'false', 'Shoud we allow only the XenServers support HVM');"
</code></pre>

<h3>XenServer</h3>

<p>Install it in virtualbox:</p>

<p><img src="/images/2015_12_26_16_28_02_719x443.jpg" alt="/images/2015_12_26_16_28_02_719x443.jpg" /></p>

<p>Usage of the disk:  <br/>
<img src="/images/2015_12_26_16_29_55_722x406.jpg" alt="/images/2015_12_26_16_29_55_722x406.jpg" /></p>

<p><img src="/images/2015_12_26_16_31_36_717x401.jpg" alt="/images/2015_12_26_16_31_36_717x401.jpg" /></p>

<p>IP Address:</p>

<p><img src="/images/2015_12_26_16_33_27_719x403.jpg" alt="/images/2015_12_26_16_33_27_719x403.jpg" /></p>

<p>Network:</p>

<p><img src="/images/2015_12_26_16_34_39_444x261.jpg" alt="/images/2015_12_26_16_34_39_444x261.jpg" /></p>

<p>Change the timezone to <code>Asia/Shanghai</code>, and configure the ntp:</p>

<p><img src="/images/2015_12_26_16_36_39_535x239.jpg" alt="/images/2015_12_26_16_36_39_535x239.jpg" /></p>

<p>Click continue and run installation.</p>

<p>Skip the Supplemental Package:</p>

<p><img src="/images/2015_12_26_16_40_20_436x213.jpg" alt="/images/2015_12_26_16_40_20_436x213.jpg" /></p>

<p>After installation, the vm become like this:</p>

<p><img src="/images/2015_12_26_16_50_36_639x403.jpg" alt="/images/2015_12_26_16_50_36_639x403.jpg" /></p>

<h3>XenServer Plugin</h3>

<p>Configure the memory Usage:</p>

<pre><code>[root@xenserver ~]# /opt/xensource/libexec/xen-cmdline --set-xen dom0_mem=400M,max:2248M
</code></pre>

<p>First without patch, adding to the cloudstack management server.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[集成elastistor到CloudStack中]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/12/25/ji-cheng-elastistordao-cloudstackzhong/"/>
    <updated>2015-12-25T15:43:34+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/12/25/ji-cheng-elastistordao-cloudstackzhong</id>
    <content type="html"><![CDATA[<h3>先决条件</h3>

<p>Cloudstack版本， 4.5.2:</p>

<p><img src="/images/2015_12_25_15_44_05_330x190.jpg" alt="/images/2015_12_25_15_44_05_330x190.jpg" /></p>

<p>CloudByte Elastistor已经搭建好。</p>

<p>下载Elastistor插件包:</p>

<pre><code># wget www.cloudbyte.com/cbftp/cloudStack.zip
# unzip cloudStack.zip 
# ls
system.js   docs.js     install.sh
</code></pre>

<h3>移动javascript文件</h3>

<p>在安装插件前，移动下列文件:</p>

<pre><code># mv /usr/share/cloudstack-management/webapps/client/scripts/system.js.gz \ 
/usr/share/cloudstack-management/webapps/client/
# mv /usr/share/cloudstack-management/webapps/client/scripts/docs.js.gz  \
/usr/share/cloudstack-management/webapps/client/
</code></pre>

<h3>安装插件</h3>

<p>安装步骤如下:</p>

<pre><code>[root@csmgmt ~]# chmod 777 install.sh 
[root@csmgmt ~]# ./install.sh 
creating a backup dir @ /usr/share/cloudstack-management/backup
taking backup of old js files : system.js and docs.js
copying cloudbyte given system.js and docs.js
restart cloudstack management server
Starting to configure CloudStack Management Server:
Configure sudoers ...         [OK]
Configure Firewall ...        [OK]
Configure CloudStack Management Server ...[OK]
CloudStack Management Server setup is Done!
</code></pre>

<h3>编辑属性文件</h3>

<p>添加下列定义到文件结尾:</p>

<pre><code>[root@csmgmt ~]# vim /usr/share/cloudstack-management/webapps/client/WEB-INF/classes/commands.properties 
        changeVolumeProperties=15
        listElastistorPool=15
        listElastistorVolume=15
        listElastistorInterface=15
</code></pre>

<h3>添加API KEY</h3>

<p>生成API KEY：</p>

<p><img src="/images/2015_12_25_15_57_27_885x323.jpg" alt="/images/2015_12_25_15_57_27_885x323.jpg" /></p>

<p>填入API KEY, 在Global Settings选项下搜索cloudbyte即可得到:</p>

<p><img src="/images/2015_12_25_15_59_00_744x233.jpg" alt="/images/2015_12_25_15_59_00_744x233.jpg" /></p>

<p>添加一个Domain:</p>

<p><img src="/images/2015_12_25_16_02_54_388x251.jpg" alt="/images/2015_12_25_16_02_54_388x251.jpg" /></p>

<p><img src="/images/2015_12_25_16_04_03_425x266.jpg" alt="/images/2015_12_25_16_04_03_425x266.jpg" /></p>

<p>添加主存储，会出现问题，VSM可以创建成功，但是无法mount到NFS。登录到elastistor上，看不到
volume的创建。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ElastiStor与CloudStack集成]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/12/23/elastistoryu-cloudstackji-cheng/"/>
    <updated>2015-12-23T17:25:55+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/12/23/elastistoryu-cloudstackji-cheng</id>
    <content type="html"><![CDATA[<h3>安装ElastiStor</h3>

<p>建立虚拟机，4G内存， 2核，插入光盘后，进入到以下界面:</p>

<p><img src="/images/2015_12_23_17_25_15_759x415.jpg" alt="/images/2015_12_23_17_25_15_759x415.jpg" /></p>

<p>选择<code>both Center and Node</code>, 进入到以下界面后，配置网络相关信息:</p>

<p><img src="/images/2015_12_23_17_28_36_720x396.jpg" alt="/images/2015_12_23_17_28_36_720x396.jpg" /></p>

<p>search domain这一项配置如下， 随便添加某个域名，例如www.baidu.com:</p>

<p>安装过程:</p>

<p><img src="/images/2015_12_23_17_33_29_644x327.jpg" alt="/images/2015_12_23_17_33_29_644x327.jpg" /></p>

<p>选择时区：</p>

<p><img src="/images/2015_12_23_17_36_34_712x398.jpg" alt="/images/2015_12_23_17_36_34_712x398.jpg" /></p>

<p>安装完毕后，进入到登录界面:</p>

<p><img src="/images/2015_12_23_17_38_40_539x422.jpg" alt="/images/2015_12_23_17_38_40_539x422.jpg" /></p>

<p>默认密码就是我们在前面设置的，默认用户名是root.</p>

<h3>登录</h3>

<p>首次登录会遇到问题的解决:</p>

<p><img src="/images/2015_12_23_18_11_05_844x186.jpg" alt="/images/2015_12_23_18_11_05_844x186.jpg" /></p>

<p>以及:</p>

<p><img src="/images/2015_12_23_18_12_25_866x213.jpg" alt="/images/2015_12_23_18_12_25_866x213.jpg" /></p>

<p><img src="/images/2015_12_23_18_15_43_647x176.jpg" alt="images/2015_12_23_18_15_43_647x176.jpg" /></p>

<p>现在可以访问登录界面, 默认用户名/密码为admin/password.</p>

<p><a href="/images/2015_12_23_18_15_49_678x413.jpg">/images/2015_12_23_18_15_49_678x413.jpg</a></p>

<h3>配置</h3>

<p>后台可以可视化来配置， 从site-> HA Group-> Node， 添加完毕后我们可以看到以下界面：</p>

<p><img src="/images/2015_12_23_19_32_13_819x326.jpg" alt="/images/2015_12_23_19_32_13_819x326.jpg" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CloudMonkey Issue]]></title>
    <link href="http://purplepalmdash.github.io/blog/2015/12/22/cloudmonkey-issue/"/>
    <updated>2015-12-22T21:18:21+08:00</updated>
    <id>http://purplepalmdash.github.io/blog/2015/12/22/cloudmonkey-issue</id>
    <content type="html"><![CDATA[<h3>Could not start cloudmonkey</h3>

<p>After installing cloudstack, cloudmonkey couldnot be used, the reason is
listed as following:</p>

<pre><code>% cloudmonkey
Traceback (most recent call last):
  File "/usr/local/bin/cloudmonkey", line 5, in &lt;module&gt;
    from pkg_resources import load_entry_point
  File "/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/pkg_resources.py", line 2603, in &lt;module&gt;
    working_set.require(__requires__)
  File "/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/pkg_resources.py", line 666, in require
    needed = self.resolve(parse_requirements(requirements))
  File "/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/pkg_resources.py", line 565, in resolve
    raise DistributionNotFound(req)  # XXX put more info here
pkg_resources.DistributionNotFound: requests
</code></pre>

<p>The solution is via:</p>

<pre><code># easy_install --upgrade pip
# pip install --upgrade setuptools
# pip install --upgrade distribute
# wget https://bitbucket.org/pypa/setuptools/raw/bootstrap/ez_setup.py -O - | python
</code></pre>

<p>So Now you could use cloudstack.</p>

<h3>Use Ansible Together With Cloudmonkey</h3>

<p>I think because my cloudstack agent didn&rsquo;t use a bridge, so the cloudmonkey runs failed.</p>

<h3>Cloudmonkey tips</h3>

<p>Configure the secstorage download address for local usage.</p>

<pre><code># cloudmonkey update configuration name=secstorage.allowed.internal.sites
 value=192.168.0.0/16
</code></pre>

<p>Create a new service offering:</p>

<pre><code># cloudmonkey create serviceoffering cpunumber=1 cpuspeed=500 displaytext=monkeyking
memory=256 name=monkeyking
</code></pre>

<p>Register the new template:</p>

<pre><code>cloudmonkey register template hypervisor=kvm zoneid=2ee04a60-499c-bcc6-c3ba92624b35 format=qcow2 name=tinycore displaytext=tinycoretemplate ispublic=true ostypeid=11 url=http://192.168.0.79/tiny.qcow2
</code></pre>

<p>The ostypeid could be adjusted in the graphical interface, while the ostypeid for
<code>other Linux(64-bit)</code> is</p>

<pre><code>ostypeid = ff2564a4-a91e-11e5-9855-52540048638c
</code></pre>

<p>Start an instance via cloudmonkey, refers to following command:</p>

<pre><code>$ Deploy VirtualMachine ZoneID=&lt;zoneid&gt; ServiceOfferingID=&lt;serviceofferingid&gt; TemplateID=&lt;templateid&gt; StartVM=false IPAddress=192.168.30.10 Name=My-VirtualMachine DisplayName=“My Virtual Machine”
</code></pre>
]]></content>
  </entry>
  
</feed>
