
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Programming in C of FC Tutorial 4 - Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="Full Circle C 6 Using valgrid for memory check See www.valgrind.org for more information for using the valgrind available tools. memcheck is the main &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/blog/2014/04/08/programming-in-c-of-fc-tutorial-4">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.useso.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Programming in C of FC Tutorial 4</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-08T16:01:06+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:01 pm</span></time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3>Full Circle C 6</h3>

<h4>Using valgrid for memory check</h4>

<p>See <a href="www.valgrind.org">www.valgrind.org</a> for more information for using the valgrind available tools.   <br/>
memcheck is the main topic in this chapter.   <br/>
this tool override libc calls that deal with handling memory. And it will do some bookkeeping. is all memory given back to the system, and is all the allocated memory still reachable?</p>

<figure class='code'><figcaption><span>leak.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">leak</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;malloc(10) points to: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>                <span class="n">leak</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;malloc(15) in main: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){}</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result shows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>valgrind --leak-check<span class="o">=</span>full --show-reachable<span class="o">=</span>yes ./memleak
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> Memcheck, a memory error detector.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2002-2006, and GNU GPL<span class="s1">&#39;d, by Julian Seward et al.</span>
</span><span class='line'><span class="s1">==2144== Using LibVEX rev 1658, a library for dynamic binary translation.</span>
</span><span class='line'><span class="s1">==2144== Copyright (C) 2004-2006, and GNU GPL&#39;</span>d, by OpenWorks LLP.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> Using valgrind-3.2.1, a dynamic binary instrumentation framework.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2000-2006, and GNU GPL<span class="err">&#39;</span>d, by Julian Seward et al.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> For more details, rerun with: -v
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022028
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022068
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40220a8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40220e8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022128
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022168
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40221a8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40221e8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022228
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022268
</span><span class='line'>malloc<span class="o">(</span>15<span class="o">)</span> in main: <span class="nv">0x40222a8</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> ERROR SUMMARY: <span class="m">0</span> errors from <span class="m">0</span> contexts <span class="o">(</span>suppressed: <span class="m">12</span> from 1<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> malloc/free: in use at <span class="nb">exit</span>: <span class="m">115</span> bytes in <span class="m">11</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> malloc/free: <span class="m">11</span> allocs, <span class="m">0</span> frees, <span class="m">115</span> bytes allocated.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> For counts of detected errors, rerun with: -v
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> searching <span class="k">for</span> pointers to <span class="m">11</span> not-freed blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> checked 46,792 bytes.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> <span class="m">15</span> bytes in <span class="m">1</span> blocks are still reachable in loss record <span class="m">1</span> of <span class="nv">2</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>    at 0x40053C0: malloc <span class="o">(</span>vg_replace_malloc.c:149<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>    by 0x8048419: main <span class="o">(</span>leak.c:17<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> <span class="m">100</span> bytes in <span class="m">10</span> blocks are definitely lost in loss record <span class="m">2</span> of <span class="nv">2</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>    at 0x40053C0: malloc <span class="o">(</span>vg_replace_malloc.c:149<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>    by 0x80483C5: leak <span class="o">(</span>leak.c:6<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>    by 0x8048403: main <span class="o">(</span>leak.c:15<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span> LEAK SUMMARY:
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>    definitely lost: <span class="m">100</span> bytes in <span class="m">10</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>      possibly lost: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>    still reachable: <span class="m">15</span> bytes in <span class="m">1</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2144</span><span class="o">==</span>         suppressed: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span></code></pre></td></tr></table></div></figure>


<p>If we change the code into following, this means valgrid won&rsquo;t interpret the output, so this will let the tracked memory add 10</p>

<figure class='code'><figcaption><span>leak1.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">leak</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;malloc(10) points to: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>                <span class="n">leak</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;malloc(15) in main: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//while(1){}</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compile and verify:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>gcc -Wall -g leak1.c -o memleak1
</span><span class='line'>View the valgrind result:
</span><span class='line'>valgrind --leak-check<span class="o">=</span>full --show-reachable<span class="o">=</span>yes ./memleak1
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> Memcheck, a memory error detector.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2002-2006, and GNU GPL<span class="s1">&#39;d, by Julian Seward et al.</span>
</span><span class='line'><span class="s1">==2190== Using LibVEX rev 1658, a library for dynamic binary translation.</span>
</span><span class='line'><span class="s1">==2190== Copyright (C) 2004-2006, and GNU GPL&#39;</span>d, by OpenWorks LLP.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> Using valgrind-3.2.1, a dynamic binary instrumentation framework.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2000-2006, and GNU GPL<span class="err">&#39;</span>d, by Julian Seward et al.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> For more details, rerun with: -v
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022028
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022068
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40220a8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40220e8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022128
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022168
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40221a8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40221e8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022228
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022268
</span><span class='line'>malloc<span class="o">(</span>15<span class="o">)</span> in main: <span class="nv">0x40222a8</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> ERROR SUMMARY: <span class="m">0</span> errors from <span class="m">0</span> contexts <span class="o">(</span>suppressed: <span class="m">12</span> from 1<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> malloc/free: in use at <span class="nb">exit</span>: <span class="m">115</span> bytes in <span class="m">11</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> malloc/free: <span class="m">11</span> allocs, <span class="m">0</span> frees, <span class="m">115</span> bytes allocated.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> For counts of detected errors, rerun with: -v
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> searching <span class="k">for</span> pointers to <span class="m">11</span> not-freed blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> checked 46,796 bytes.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> <span class="m">15</span> bytes in <span class="m">1</span> blocks are definitely lost in loss record <span class="m">1</span> of <span class="nv">2</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>    at 0x40053C0: malloc <span class="o">(</span>vg_replace_malloc.c:149<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>    by 0x8048419: main <span class="o">(</span>leak1.c:17<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> <span class="m">100</span> bytes in <span class="m">10</span> blocks are definitely lost in loss record <span class="m">2</span> of <span class="nv">2</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>    at 0x40053C0: malloc <span class="o">(</span>vg_replace_malloc.c:149<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>    by 0x80483C5: leak <span class="o">(</span>leak1.c:6<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>    by 0x8048403: main <span class="o">(</span>leak1.c:15<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span> LEAK SUMMARY:
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>    definitely lost: <span class="m">115</span> bytes in <span class="m">11</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>      possibly lost: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>    still reachable: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2190</span><span class="o">==</span>         suppressed: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span></code></pre></td></tr></table></div></figure>


<h4>exercise 1:</h4>

<p>vmstat is a tool which report system usage statistics, use strace to figure out which /proc/file(s) it uses to generate its output</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>execve<span class="o">(</span><span class="s2">&quot;/usr/bin/vmstat&quot;</span>, <span class="o">[</span><span class="s2">&quot;vmstat&quot;</span><span class="o">]</span>, <span class="o">[</span>/* <span class="m">29</span> vars */<span class="o">])</span> <span class="o">=</span> 0
</span><span class='line'>brk<span class="o">(</span>0<span class="o">)</span>                                  <span class="o">=</span> 0x96b7000
</span><span class='line'>access<span class="o">(</span><span class="s2">&quot;/etc/ld.so.preload&quot;</span>, R_OK<span class="o">)</span>      <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY<span class="o">)</span>      <span class="o">=</span> 3
</span><span class='line'>fstat64<span class="o">(</span>3, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0644, <span class="nv">st_size</span><span class="o">=</span>95416, ...<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>mmap2<span class="o">(</span>NULL, 95416, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0xb7f80000
</span><span class='line'>close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> 0
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;/lib/libproc-3.2.7.so&quot;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> 3
</span><span class='line'><span class="nb">read</span><span class="o">(</span>3, <span class="s2">&quot;\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0\320c\304\0004\0\0\0&quot;</span>..., 512<span class="o">)</span> <span class="o">=</span> 512
</span><span class='line'>fstat64<span class="o">(</span>3, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0755, <span class="nv">st_size</span><span class="o">=</span>54212, ...<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>mmap2<span class="o">(</span>NULL, 4096, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0xb7f7f000
</span><span class='line'>mmap2<span class="o">(</span>0xc44000, 133592, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0xc44000
</span><span class='line'>mmap2<span class="o">(</span>0xc51000, 4096, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0xc<span class="o">)</span> <span class="o">=</span> 0xc51000
</span><span class='line'>mmap2<span class="o">(</span>0xc52000, 76248, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0xc52000
</span><span class='line'>close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> 0
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;/lib/libc.so.6&quot;</span>, O_RDONLY<span class="o">)</span>        <span class="o">=</span> 3
</span><span class='line'><span class="nb">read</span><span class="o">(</span>3, <span class="s2">&quot;\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0\320?\261\0004\0\0\0&quot;</span>..., 512<span class="o">)</span> <span class="o">=</span> 512
</span><span class='line'>fstat64<span class="o">(</span>3, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0755, <span class="nv">st_size</span><span class="o">=</span>1606808, ...<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>mmap2<span class="o">(</span>0xafe000, 1324452, PROT_READ<span class="p">|</span>PROT_EXEC, MAP_PRIVATE<span class="p">|</span>MAP_DENYWRITE, 3, 0<span class="o">)</span> <span class="o">=</span> 0xafe000
</span><span class='line'>mmap2<span class="o">(</span>0xc3c000, 12288, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_DENYWRITE, 3, 0x13e<span class="o">)</span> <span class="o">=</span> 0xc3c000
</span><span class='line'>mmap2<span class="o">(</span>0xc3f000, 9636, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_FIXED<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0xc3f000
</span><span class='line'>close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> 0
</span><span class='line'>mmap2<span class="o">(</span>NULL, 4096, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0xb7f7e000
</span><span class='line'>set_thread_area<span class="o">({</span>entry_number:-1 -&gt; 6, base_addr:0xb7f7e6c0, limit:1048575, seg_32bit:1, contents:0, read_exec_only:0, limit_in_pages:1, seg_not_present:0, useable:1<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>mprotect<span class="o">(</span>0xc3c000, 8192, PROT_READ<span class="o">)</span>     <span class="o">=</span> 0
</span><span class='line'>mprotect<span class="o">(</span>0xaf5000, 4096, PROT_READ<span class="o">)</span>     <span class="o">=</span> 0
</span><span class='line'>munmap<span class="o">(</span>0xb7f80000, 95416<span class="o">)</span>               <span class="o">=</span> 0
</span><span class='line'>uname<span class="o">({</span><span class="nv">sys</span><span class="o">=</span><span class="s2">&quot;Linux&quot;</span>, <span class="nv">node</span><span class="o">=</span><span class="s2">&quot;localhost.localdomain&quot;</span>, ...<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>brk<span class="o">(</span>0<span class="o">)</span>                                  <span class="o">=</span> 0x96b7000
</span><span class='line'>brk<span class="o">(</span>0x96d8000<span class="o">)</span>                          <span class="o">=</span> 0x96d8000
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;/proc/stat&quot;</span>, O_RDONLY<span class="o">)</span>            <span class="o">=</span> 3
</span><span class='line'>fstat64<span class="o">(</span>3, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0444, <span class="nv">st_size</span><span class="o">=</span>0, ...<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>mmap2<span class="o">(</span>NULL, 4096, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0xb7f97000
</span><span class='line'><span class="nb">read</span><span class="o">(</span>3, <span class="s2">&quot;cpu  14886 15300 97152 608490 41&quot;</span>..., 4096<span class="o">)</span> <span class="o">=</span> 693
</span><span class='line'><span class="nb">read</span><span class="o">(</span>3, <span class="s2">&quot;&quot;</span>, 4096<span class="o">)</span>                       <span class="o">=</span> 0
</span><span class='line'>close<span class="o">(</span>3<span class="o">)</span>                                <span class="o">=</span> 0
</span><span class='line'>munmap<span class="o">(</span>0xb7f97000, 4096<span class="o">)</span>                <span class="o">=</span> 0
</span><span class='line'>ioctl<span class="o">(</span>1, TIOCGWINSZ, <span class="o">{</span><span class="nv">ws_row</span><span class="o">=</span>36, <span class="nv">ws_col</span><span class="o">=</span>115, <span class="nv">ws_xpixel</span><span class="o">=</span>0, <span class="nv">ws_ypixel</span><span class="o">=</span>0<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>fstat64<span class="o">(</span>1, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFCHR<span class="p">|</span>0620, <span class="nv">st_rdev</span><span class="o">=</span>makedev<span class="o">(</span>136, 4<span class="o">)</span>, ...<span class="o">})</span> <span class="o">=</span> 0
</span><span class='line'>mmap2<span class="o">(</span>NULL, 4096, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, 0<span class="o">)</span> <span class="o">=</span> 0xb7f97000
</span><span class='line'>write<span class="o">(</span>1, <span class="s2">&quot;procs -----------memory---------&quot;</span>..., 82procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------
</span><span class='line'><span class="o">)</span> <span class="o">=</span> 82
</span><span class='line'>write<span class="o">(</span>1, <span class="s2">&quot; r  b   swpd   free   buff  cach&quot;</span>..., <span class="m">81</span> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
</span><span class='line'><span class="o">)</span> <span class="o">=</span> 81
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;/proc/meminfo&quot;</span>, O_RDONLY<span class="o">)</span>         <span class="o">=</span> 3
</span><span class='line'>lseek<span class="o">(</span>3, 0, SEEK_SET<span class="o">)</span>                   <span class="o">=</span> 0
</span><span class='line'><span class="nb">read</span><span class="o">(</span>3, <span class="s2">&quot;MemTotal:       897068 kB\nMemFre&quot;</span>..., 1023<span class="o">)</span> <span class="o">=</span> 771
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;/proc/stat&quot;</span>, O_RDONLY<span class="o">)</span>            <span class="o">=</span> 4
</span><span class='line'><span class="nb">read</span><span class="o">(</span>4, <span class="s2">&quot;cpu  14886 15300 97153 608490 41&quot;</span>..., 65535<span class="o">)</span> <span class="o">=</span> 693
</span><span class='line'>open<span class="o">(</span><span class="s2">&quot;/proc/vmstat&quot;</span>, O_RDONLY<span class="o">)</span>          <span class="o">=</span> 5
</span><span class='line'>lseek<span class="o">(</span>5, 0, SEEK_SET<span class="o">)</span>                   <span class="o">=</span> 0
</span><span class='line'><span class="nb">read</span><span class="o">(</span>5, <span class="s2">&quot;nr_anon_pages 29682\nnr_mapped 13&quot;</span>..., 1023<span class="o">)</span> <span class="o">=</span> 803
</span><span class='line'>write<span class="o">(</span>1, <span class="s2">&quot; 0  0    120  16980  32852 67407&quot;</span>..., <span class="m">81</span> <span class="m">0</span>  <span class="m">0</span>    <span class="m">120</span>  <span class="m">16980</span>  <span class="m">32852</span> <span class="m">674076</span>    <span class="m">0</span>    <span class="m">0</span>   <span class="m">228</span>   <span class="m">223</span> <span class="m">1040</span>  <span class="m">432</span>  <span class="m">4</span> <span class="m">13</span> <span class="m">78</span>  <span class="m">5</span>  0
</span><span class='line'><span class="o">)</span> <span class="o">=</span> 81
</span><span class='line'>exit_group<span class="o">(</span>0<span class="o">)</span>                           <span class="o">=</span> ?
</span></code></pre></td></tr></table></div></figure>


<p>From the above output, we can see, it access /proc/stat and /proc/vmstat for output message.</p>

<h4>exercise 2</h4>

<p>Repeat the ltrace /strace example on wget with ivalid URL, TBD</p>

<h4>exercise 3</h4>

<p>Does valgrind automatically trace child process?</p>

<figure class='code'><figcaption><span>fork.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* For using fork() */</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Using errono */</span>
</span><span class='line'><span class="cp">#include &lt;errno.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">leak</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;malloc(10) points to: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">pid_t</span> <span class="n">child</span><span class="p">;</span>
</span><span class='line'>        <span class="cm">/* Parent do leak() */</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>                <span class="n">leak</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Now fork a child process */</span>
</span><span class='line'>        <span class="k">if</span><span class="p">((</span><span class="n">child</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;fork of child failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'>                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Now its in child process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// parent will exit immediately !</span>
</span><span class='line'>                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Parent will exit!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Only Child comes here</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Only child comes here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>                <span class="n">leak</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We use following command for tracing the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>root@localhost code<span class="o">]</span><span class="c"># valgrind --leak-check=full --show-reachable=yes ./memleak_fork</span>
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> Memcheck, a memory error detector.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2002-2006, and GNU GPL<span class="s1">&#39;d, by Julian Seward et al.</span>
</span><span class='line'><span class="s1">==2561== Using LibVEX rev 1658, a library for dynamic binary translation.</span>
</span><span class='line'><span class="s1">==2561== Copyright (C) 2004-2006, and GNU GPL&#39;</span>d, by OpenWorks LLP.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> Using valgrind-3.2.1, a dynamic binary instrumentation framework.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2000-2006, and GNU GPL<span class="err">&#39;</span>d, by Julian Seward et al.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> For more details, rerun with: -v
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022028
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022068
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40220a8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40220e8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022128
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022168
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40221a8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40221e8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022228
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022268
</span><span class='line'>Now its in child process
</span><span class='line'>Parent will <span class="nb">exit</span>!
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> ERROR SUMMARY: <span class="m">0</span> errors from <span class="m">0</span> contexts <span class="o">(</span>suppressed: <span class="m">12</span> from 1<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> malloc/free: in use at <span class="nb">exit</span>: <span class="m">100</span> bytes in <span class="m">10</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> malloc/free: <span class="m">10</span> allocs, <span class="m">0</span> frees, <span class="m">100</span> bytes allocated.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> For counts of detected errors, rerun with: -v
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> searching <span class="k">for</span> pointers to <span class="m">10</span> not-freed blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> checked 46,796 bytes.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> <span class="m">100</span> bytes in <span class="m">10</span> blocks are definitely lost in loss record <span class="m">1</span> of <span class="nv">1</span>
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>    at 0x40053C0: malloc <span class="o">(</span>vg_replace_malloc.c:149<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>    by 0x8048515: leak <span class="o">(</span>fork.c:15<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>    by 0x8048553: main <span class="o">(</span>fork.c:26<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span> LEAK SUMMARY:
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>    definitely lost: <span class="m">100</span> bytes in <span class="m">10</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>      possibly lost: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>    still reachable: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2561</span><span class="o">==</span>         suppressed: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span><span class='line'><span class="o">[</span>root@localhost code<span class="o">]</span><span class="c"># Only child comes here!</span>
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40222a8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40222e8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022328
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022368
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40223a8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40223e8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022428
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x4022468
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: 0x40224a8
</span><span class='line'>malloc<span class="o">(</span>10<span class="o">)</span> points to: <span class="nv">0x40224e8</span>
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span> ERROR SUMMARY: <span class="m">0</span> errors from <span class="m">0</span> contexts <span class="o">(</span>suppressed: <span class="m">12</span> from 1<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span> malloc/free: in use at <span class="nb">exit</span>: <span class="m">200</span> bytes in <span class="m">20</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span> malloc/free: <span class="m">20</span> allocs, <span class="m">0</span> frees, <span class="m">200</span> bytes allocated.
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span> For counts of detected errors, rerun with: -v
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span> searching <span class="k">for</span> pointers to <span class="m">20</span> not-freed blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span> checked 46,796 bytes.
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span> <span class="m">200</span> bytes in <span class="m">20</span> blocks are definitely lost in loss record <span class="m">1</span> of <span class="nv">1</span>
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>    at 0x40053C0: malloc <span class="o">(</span>vg_replace_malloc.c:149<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>    by 0x8048515: leak <span class="o">(</span>fork.c:15<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>    by 0x8048553: main <span class="o">(</span>fork.c:26<span class="o">)</span>
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span> LEAK SUMMARY:
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>    definitely lost: <span class="m">200</span> bytes in <span class="m">20</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>      possibly lost: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>    still reachable: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span><span class='line'><span class="o">==</span><span class="nv">2562</span><span class="o">==</span>         suppressed: <span class="m">0</span> bytes in <span class="m">0</span> blocks.
</span></code></pre></td></tr></table></div></figure>


<p>From the above output, we can see valgrid also tracked the child process&rsquo;s memory usage.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Dash</span></span>

           




<time class='entry-date' datetime='2014-04-08T16:01:06+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:01 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/fc/'>fc</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <br />
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/04/08/programming-in-c-of-fc-tutorial-3/" title="Previous Post: Programming in C of FC tutorial 3">&laquo; Programming in C of FC tutorial 3</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/04/08/programming-in-c-of-fc-tutorial-5/" title="Next Post: Programming in C of FC tutorial 5">Programming in C of FC tutorial 5 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/05/use-chef-for-deploying-cloudstack-management-node/">Use Chef for Deploying CloudStack Management Node</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/03/tips-on-using-vagrant-and-chefdk/">Tips on Using Vagrant and Chefdk</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/02/chef-trouble-shooting/">Chef Trouble-Shooting</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/01/chef-for-deploying-openstack/">Chef for Deploying OpenStack</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/26/chef-setup/">Chef Setup</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://purplepalmdash.github.io/blog/2014/04/08/programming-in-c-of-fc-tutorial-4/';
        var disqus_url = 'http://purplepalmdash.github.io/blog/2014/04/08/programming-in-c-of-fc-tutorial-4/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
