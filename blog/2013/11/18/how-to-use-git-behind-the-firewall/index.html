
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How to Use Git Behind the Firewall - Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="Tips: 1
2
3
4
5
6
7
wget http://www.meadowy.org/~gotoh/ssh/connect.c
gcc -o connect connect.c
chmod 777 connect && mv connect /bin/
http-proxy-gw &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/blog/2013/11/18/how-to-use-git-behind-the-firewall">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//fonts.googleapis.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How to Use Git Behind the Firewall</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-11-18T16:49:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>4:49 pm</span></time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3>Tips:</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://www.meadowy.org/~gotoh/ssh/connect.c
</span><span class='line'>gcc -o connect connect.c
</span><span class='line'>chmod 777 connect && mv connect /bin/
</span><span class='line'>http-proxy-gw content:
</span><span class='line'>/bin/connect -H http://10.0.0.221:9001 $@
</span><span class='line'>git config --global core.gitproxy "http-proxy-gw for *.*"
</span><span class='line'>echo "export GIT_PROXY_COMMAND=/bin/http-proxy-gw" &gt;&gt; ~/.bashrc
</span></code></pre></td></tr></table></div></figure>


<h3>C source code:</h3>

<figure class='code'><figcaption><span>connect.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
<span class='line-number'>531</span>
<span class='line-number'>532</span>
<span class='line-number'>533</span>
<span class='line-number'>534</span>
<span class='line-number'>535</span>
<span class='line-number'>536</span>
<span class='line-number'>537</span>
<span class='line-number'>538</span>
<span class='line-number'>539</span>
<span class='line-number'>540</span>
<span class='line-number'>541</span>
<span class='line-number'>542</span>
<span class='line-number'>543</span>
<span class='line-number'>544</span>
<span class='line-number'>545</span>
<span class='line-number'>546</span>
<span class='line-number'>547</span>
<span class='line-number'>548</span>
<span class='line-number'>549</span>
<span class='line-number'>550</span>
<span class='line-number'>551</span>
<span class='line-number'>552</span>
<span class='line-number'>553</span>
<span class='line-number'>554</span>
<span class='line-number'>555</span>
<span class='line-number'>556</span>
<span class='line-number'>557</span>
<span class='line-number'>558</span>
<span class='line-number'>559</span>
<span class='line-number'>560</span>
<span class='line-number'>561</span>
<span class='line-number'>562</span>
<span class='line-number'>563</span>
<span class='line-number'>564</span>
<span class='line-number'>565</span>
<span class='line-number'>566</span>
<span class='line-number'>567</span>
<span class='line-number'>568</span>
<span class='line-number'>569</span>
<span class='line-number'>570</span>
<span class='line-number'>571</span>
<span class='line-number'>572</span>
<span class='line-number'>573</span>
<span class='line-number'>574</span>
<span class='line-number'>575</span>
<span class='line-number'>576</span>
<span class='line-number'>577</span>
<span class='line-number'>578</span>
<span class='line-number'>579</span>
<span class='line-number'>580</span>
<span class='line-number'>581</span>
<span class='line-number'>582</span>
<span class='line-number'>583</span>
<span class='line-number'>584</span>
<span class='line-number'>585</span>
<span class='line-number'>586</span>
<span class='line-number'>587</span>
<span class='line-number'>588</span>
<span class='line-number'>589</span>
<span class='line-number'>590</span>
<span class='line-number'>591</span>
<span class='line-number'>592</span>
<span class='line-number'>593</span>
<span class='line-number'>594</span>
<span class='line-number'>595</span>
<span class='line-number'>596</span>
<span class='line-number'>597</span>
<span class='line-number'>598</span>
<span class='line-number'>599</span>
<span class='line-number'>600</span>
<span class='line-number'>601</span>
<span class='line-number'>602</span>
<span class='line-number'>603</span>
<span class='line-number'>604</span>
<span class='line-number'>605</span>
<span class='line-number'>606</span>
<span class='line-number'>607</span>
<span class='line-number'>608</span>
<span class='line-number'>609</span>
<span class='line-number'>610</span>
<span class='line-number'>611</span>
<span class='line-number'>612</span>
<span class='line-number'>613</span>
<span class='line-number'>614</span>
<span class='line-number'>615</span>
<span class='line-number'>616</span>
<span class='line-number'>617</span>
<span class='line-number'>618</span>
<span class='line-number'>619</span>
<span class='line-number'>620</span>
<span class='line-number'>621</span>
<span class='line-number'>622</span>
<span class='line-number'>623</span>
<span class='line-number'>624</span>
<span class='line-number'>625</span>
<span class='line-number'>626</span>
<span class='line-number'>627</span>
<span class='line-number'>628</span>
<span class='line-number'>629</span>
<span class='line-number'>630</span>
<span class='line-number'>631</span>
<span class='line-number'>632</span>
<span class='line-number'>633</span>
<span class='line-number'>634</span>
<span class='line-number'>635</span>
<span class='line-number'>636</span>
<span class='line-number'>637</span>
<span class='line-number'>638</span>
<span class='line-number'>639</span>
<span class='line-number'>640</span>
<span class='line-number'>641</span>
<span class='line-number'>642</span>
<span class='line-number'>643</span>
<span class='line-number'>644</span>
<span class='line-number'>645</span>
<span class='line-number'>646</span>
<span class='line-number'>647</span>
<span class='line-number'>648</span>
<span class='line-number'>649</span>
<span class='line-number'>650</span>
<span class='line-number'>651</span>
<span class='line-number'>652</span>
<span class='line-number'>653</span>
<span class='line-number'>654</span>
<span class='line-number'>655</span>
<span class='line-number'>656</span>
<span class='line-number'>657</span>
<span class='line-number'>658</span>
<span class='line-number'>659</span>
<span class='line-number'>660</span>
<span class='line-number'>661</span>
<span class='line-number'>662</span>
<span class='line-number'>663</span>
<span class='line-number'>664</span>
<span class='line-number'>665</span>
<span class='line-number'>666</span>
<span class='line-number'>667</span>
<span class='line-number'>668</span>
<span class='line-number'>669</span>
<span class='line-number'>670</span>
<span class='line-number'>671</span>
<span class='line-number'>672</span>
<span class='line-number'>673</span>
<span class='line-number'>674</span>
<span class='line-number'>675</span>
<span class='line-number'>676</span>
<span class='line-number'>677</span>
<span class='line-number'>678</span>
<span class='line-number'>679</span>
<span class='line-number'>680</span>
<span class='line-number'>681</span>
<span class='line-number'>682</span>
<span class='line-number'>683</span>
<span class='line-number'>684</span>
<span class='line-number'>685</span>
<span class='line-number'>686</span>
<span class='line-number'>687</span>
<span class='line-number'>688</span>
<span class='line-number'>689</span>
<span class='line-number'>690</span>
<span class='line-number'>691</span>
<span class='line-number'>692</span>
<span class='line-number'>693</span>
<span class='line-number'>694</span>
<span class='line-number'>695</span>
<span class='line-number'>696</span>
<span class='line-number'>697</span>
<span class='line-number'>698</span>
<span class='line-number'>699</span>
<span class='line-number'>700</span>
<span class='line-number'>701</span>
<span class='line-number'>702</span>
<span class='line-number'>703</span>
<span class='line-number'>704</span>
<span class='line-number'>705</span>
<span class='line-number'>706</span>
<span class='line-number'>707</span>
<span class='line-number'>708</span>
<span class='line-number'>709</span>
<span class='line-number'>710</span>
<span class='line-number'>711</span>
<span class='line-number'>712</span>
<span class='line-number'>713</span>
<span class='line-number'>714</span>
<span class='line-number'>715</span>
<span class='line-number'>716</span>
<span class='line-number'>717</span>
<span class='line-number'>718</span>
<span class='line-number'>719</span>
<span class='line-number'>720</span>
<span class='line-number'>721</span>
<span class='line-number'>722</span>
<span class='line-number'>723</span>
<span class='line-number'>724</span>
<span class='line-number'>725</span>
<span class='line-number'>726</span>
<span class='line-number'>727</span>
<span class='line-number'>728</span>
<span class='line-number'>729</span>
<span class='line-number'>730</span>
<span class='line-number'>731</span>
<span class='line-number'>732</span>
<span class='line-number'>733</span>
<span class='line-number'>734</span>
<span class='line-number'>735</span>
<span class='line-number'>736</span>
<span class='line-number'>737</span>
<span class='line-number'>738</span>
<span class='line-number'>739</span>
<span class='line-number'>740</span>
<span class='line-number'>741</span>
<span class='line-number'>742</span>
<span class='line-number'>743</span>
<span class='line-number'>744</span>
<span class='line-number'>745</span>
<span class='line-number'>746</span>
<span class='line-number'>747</span>
<span class='line-number'>748</span>
<span class='line-number'>749</span>
<span class='line-number'>750</span>
<span class='line-number'>751</span>
<span class='line-number'>752</span>
<span class='line-number'>753</span>
<span class='line-number'>754</span>
<span class='line-number'>755</span>
<span class='line-number'>756</span>
<span class='line-number'>757</span>
<span class='line-number'>758</span>
<span class='line-number'>759</span>
<span class='line-number'>760</span>
<span class='line-number'>761</span>
<span class='line-number'>762</span>
<span class='line-number'>763</span>
<span class='line-number'>764</span>
<span class='line-number'>765</span>
<span class='line-number'>766</span>
<span class='line-number'>767</span>
<span class='line-number'>768</span>
<span class='line-number'>769</span>
<span class='line-number'>770</span>
<span class='line-number'>771</span>
<span class='line-number'>772</span>
<span class='line-number'>773</span>
<span class='line-number'>774</span>
<span class='line-number'>775</span>
<span class='line-number'>776</span>
<span class='line-number'>777</span>
<span class='line-number'>778</span>
<span class='line-number'>779</span>
<span class='line-number'>780</span>
<span class='line-number'>781</span>
<span class='line-number'>782</span>
<span class='line-number'>783</span>
<span class='line-number'>784</span>
<span class='line-number'>785</span>
<span class='line-number'>786</span>
<span class='line-number'>787</span>
<span class='line-number'>788</span>
<span class='line-number'>789</span>
<span class='line-number'>790</span>
<span class='line-number'>791</span>
<span class='line-number'>792</span>
<span class='line-number'>793</span>
<span class='line-number'>794</span>
<span class='line-number'>795</span>
<span class='line-number'>796</span>
<span class='line-number'>797</span>
<span class='line-number'>798</span>
<span class='line-number'>799</span>
<span class='line-number'>800</span>
<span class='line-number'>801</span>
<span class='line-number'>802</span>
<span class='line-number'>803</span>
<span class='line-number'>804</span>
<span class='line-number'>805</span>
<span class='line-number'>806</span>
<span class='line-number'>807</span>
<span class='line-number'>808</span>
<span class='line-number'>809</span>
<span class='line-number'>810</span>
<span class='line-number'>811</span>
<span class='line-number'>812</span>
<span class='line-number'>813</span>
<span class='line-number'>814</span>
<span class='line-number'>815</span>
<span class='line-number'>816</span>
<span class='line-number'>817</span>
<span class='line-number'>818</span>
<span class='line-number'>819</span>
<span class='line-number'>820</span>
<span class='line-number'>821</span>
<span class='line-number'>822</span>
<span class='line-number'>823</span>
<span class='line-number'>824</span>
<span class='line-number'>825</span>
<span class='line-number'>826</span>
<span class='line-number'>827</span>
<span class='line-number'>828</span>
<span class='line-number'>829</span>
<span class='line-number'>830</span>
<span class='line-number'>831</span>
<span class='line-number'>832</span>
<span class='line-number'>833</span>
<span class='line-number'>834</span>
<span class='line-number'>835</span>
<span class='line-number'>836</span>
<span class='line-number'>837</span>
<span class='line-number'>838</span>
<span class='line-number'>839</span>
<span class='line-number'>840</span>
<span class='line-number'>841</span>
<span class='line-number'>842</span>
<span class='line-number'>843</span>
<span class='line-number'>844</span>
<span class='line-number'>845</span>
<span class='line-number'>846</span>
<span class='line-number'>847</span>
<span class='line-number'>848</span>
<span class='line-number'>849</span>
<span class='line-number'>850</span>
<span class='line-number'>851</span>
<span class='line-number'>852</span>
<span class='line-number'>853</span>
<span class='line-number'>854</span>
<span class='line-number'>855</span>
<span class='line-number'>856</span>
<span class='line-number'>857</span>
<span class='line-number'>858</span>
<span class='line-number'>859</span>
<span class='line-number'>860</span>
<span class='line-number'>861</span>
<span class='line-number'>862</span>
<span class='line-number'>863</span>
<span class='line-number'>864</span>
<span class='line-number'>865</span>
<span class='line-number'>866</span>
<span class='line-number'>867</span>
<span class='line-number'>868</span>
<span class='line-number'>869</span>
<span class='line-number'>870</span>
<span class='line-number'>871</span>
<span class='line-number'>872</span>
<span class='line-number'>873</span>
<span class='line-number'>874</span>
<span class='line-number'>875</span>
<span class='line-number'>876</span>
<span class='line-number'>877</span>
<span class='line-number'>878</span>
<span class='line-number'>879</span>
<span class='line-number'>880</span>
<span class='line-number'>881</span>
<span class='line-number'>882</span>
<span class='line-number'>883</span>
<span class='line-number'>884</span>
<span class='line-number'>885</span>
<span class='line-number'>886</span>
<span class='line-number'>887</span>
<span class='line-number'>888</span>
<span class='line-number'>889</span>
<span class='line-number'>890</span>
<span class='line-number'>891</span>
<span class='line-number'>892</span>
<span class='line-number'>893</span>
<span class='line-number'>894</span>
<span class='line-number'>895</span>
<span class='line-number'>896</span>
<span class='line-number'>897</span>
<span class='line-number'>898</span>
<span class='line-number'>899</span>
<span class='line-number'>900</span>
<span class='line-number'>901</span>
<span class='line-number'>902</span>
<span class='line-number'>903</span>
<span class='line-number'>904</span>
<span class='line-number'>905</span>
<span class='line-number'>906</span>
<span class='line-number'>907</span>
<span class='line-number'>908</span>
<span class='line-number'>909</span>
<span class='line-number'>910</span>
<span class='line-number'>911</span>
<span class='line-number'>912</span>
<span class='line-number'>913</span>
<span class='line-number'>914</span>
<span class='line-number'>915</span>
<span class='line-number'>916</span>
<span class='line-number'>917</span>
<span class='line-number'>918</span>
<span class='line-number'>919</span>
<span class='line-number'>920</span>
<span class='line-number'>921</span>
<span class='line-number'>922</span>
<span class='line-number'>923</span>
<span class='line-number'>924</span>
<span class='line-number'>925</span>
<span class='line-number'>926</span>
<span class='line-number'>927</span>
<span class='line-number'>928</span>
<span class='line-number'>929</span>
<span class='line-number'>930</span>
<span class='line-number'>931</span>
<span class='line-number'>932</span>
<span class='line-number'>933</span>
<span class='line-number'>934</span>
<span class='line-number'>935</span>
<span class='line-number'>936</span>
<span class='line-number'>937</span>
<span class='line-number'>938</span>
<span class='line-number'>939</span>
<span class='line-number'>940</span>
<span class='line-number'>941</span>
<span class='line-number'>942</span>
<span class='line-number'>943</span>
<span class='line-number'>944</span>
<span class='line-number'>945</span>
<span class='line-number'>946</span>
<span class='line-number'>947</span>
<span class='line-number'>948</span>
<span class='line-number'>949</span>
<span class='line-number'>950</span>
<span class='line-number'>951</span>
<span class='line-number'>952</span>
<span class='line-number'>953</span>
<span class='line-number'>954</span>
<span class='line-number'>955</span>
<span class='line-number'>956</span>
<span class='line-number'>957</span>
<span class='line-number'>958</span>
<span class='line-number'>959</span>
<span class='line-number'>960</span>
<span class='line-number'>961</span>
<span class='line-number'>962</span>
<span class='line-number'>963</span>
<span class='line-number'>964</span>
<span class='line-number'>965</span>
<span class='line-number'>966</span>
<span class='line-number'>967</span>
<span class='line-number'>968</span>
<span class='line-number'>969</span>
<span class='line-number'>970</span>
<span class='line-number'>971</span>
<span class='line-number'>972</span>
<span class='line-number'>973</span>
<span class='line-number'>974</span>
<span class='line-number'>975</span>
<span class='line-number'>976</span>
<span class='line-number'>977</span>
<span class='line-number'>978</span>
<span class='line-number'>979</span>
<span class='line-number'>980</span>
<span class='line-number'>981</span>
<span class='line-number'>982</span>
<span class='line-number'>983</span>
<span class='line-number'>984</span>
<span class='line-number'>985</span>
<span class='line-number'>986</span>
<span class='line-number'>987</span>
<span class='line-number'>988</span>
<span class='line-number'>989</span>
<span class='line-number'>990</span>
<span class='line-number'>991</span>
<span class='line-number'>992</span>
<span class='line-number'>993</span>
<span class='line-number'>994</span>
<span class='line-number'>995</span>
<span class='line-number'>996</span>
<span class='line-number'>997</span>
<span class='line-number'>998</span>
<span class='line-number'>999</span>
<span class='line-number'>1000</span>
<span class='line-number'>1001</span>
<span class='line-number'>1002</span>
<span class='line-number'>1003</span>
<span class='line-number'>1004</span>
<span class='line-number'>1005</span>
<span class='line-number'>1006</span>
<span class='line-number'>1007</span>
<span class='line-number'>1008</span>
<span class='line-number'>1009</span>
<span class='line-number'>1010</span>
<span class='line-number'>1011</span>
<span class='line-number'>1012</span>
<span class='line-number'>1013</span>
<span class='line-number'>1014</span>
<span class='line-number'>1015</span>
<span class='line-number'>1016</span>
<span class='line-number'>1017</span>
<span class='line-number'>1018</span>
<span class='line-number'>1019</span>
<span class='line-number'>1020</span>
<span class='line-number'>1021</span>
<span class='line-number'>1022</span>
<span class='line-number'>1023</span>
<span class='line-number'>1024</span>
<span class='line-number'>1025</span>
<span class='line-number'>1026</span>
<span class='line-number'>1027</span>
<span class='line-number'>1028</span>
<span class='line-number'>1029</span>
<span class='line-number'>1030</span>
<span class='line-number'>1031</span>
<span class='line-number'>1032</span>
<span class='line-number'>1033</span>
<span class='line-number'>1034</span>
<span class='line-number'>1035</span>
<span class='line-number'>1036</span>
<span class='line-number'>1037</span>
<span class='line-number'>1038</span>
<span class='line-number'>1039</span>
<span class='line-number'>1040</span>
<span class='line-number'>1041</span>
<span class='line-number'>1042</span>
<span class='line-number'>1043</span>
<span class='line-number'>1044</span>
<span class='line-number'>1045</span>
<span class='line-number'>1046</span>
<span class='line-number'>1047</span>
<span class='line-number'>1048</span>
<span class='line-number'>1049</span>
<span class='line-number'>1050</span>
<span class='line-number'>1051</span>
<span class='line-number'>1052</span>
<span class='line-number'>1053</span>
<span class='line-number'>1054</span>
<span class='line-number'>1055</span>
<span class='line-number'>1056</span>
<span class='line-number'>1057</span>
<span class='line-number'>1058</span>
<span class='line-number'>1059</span>
<span class='line-number'>1060</span>
<span class='line-number'>1061</span>
<span class='line-number'>1062</span>
<span class='line-number'>1063</span>
<span class='line-number'>1064</span>
<span class='line-number'>1065</span>
<span class='line-number'>1066</span>
<span class='line-number'>1067</span>
<span class='line-number'>1068</span>
<span class='line-number'>1069</span>
<span class='line-number'>1070</span>
<span class='line-number'>1071</span>
<span class='line-number'>1072</span>
<span class='line-number'>1073</span>
<span class='line-number'>1074</span>
<span class='line-number'>1075</span>
<span class='line-number'>1076</span>
<span class='line-number'>1077</span>
<span class='line-number'>1078</span>
<span class='line-number'>1079</span>
<span class='line-number'>1080</span>
<span class='line-number'>1081</span>
<span class='line-number'>1082</span>
<span class='line-number'>1083</span>
<span class='line-number'>1084</span>
<span class='line-number'>1085</span>
<span class='line-number'>1086</span>
<span class='line-number'>1087</span>
<span class='line-number'>1088</span>
<span class='line-number'>1089</span>
<span class='line-number'>1090</span>
<span class='line-number'>1091</span>
<span class='line-number'>1092</span>
<span class='line-number'>1093</span>
<span class='line-number'>1094</span>
<span class='line-number'>1095</span>
<span class='line-number'>1096</span>
<span class='line-number'>1097</span>
<span class='line-number'>1098</span>
<span class='line-number'>1099</span>
<span class='line-number'>1100</span>
<span class='line-number'>1101</span>
<span class='line-number'>1102</span>
<span class='line-number'>1103</span>
<span class='line-number'>1104</span>
<span class='line-number'>1105</span>
<span class='line-number'>1106</span>
<span class='line-number'>1107</span>
<span class='line-number'>1108</span>
<span class='line-number'>1109</span>
<span class='line-number'>1110</span>
<span class='line-number'>1111</span>
<span class='line-number'>1112</span>
<span class='line-number'>1113</span>
<span class='line-number'>1114</span>
<span class='line-number'>1115</span>
<span class='line-number'>1116</span>
<span class='line-number'>1117</span>
<span class='line-number'>1118</span>
<span class='line-number'>1119</span>
<span class='line-number'>1120</span>
<span class='line-number'>1121</span>
<span class='line-number'>1122</span>
<span class='line-number'>1123</span>
<span class='line-number'>1124</span>
<span class='line-number'>1125</span>
<span class='line-number'>1126</span>
<span class='line-number'>1127</span>
<span class='line-number'>1128</span>
<span class='line-number'>1129</span>
<span class='line-number'>1130</span>
<span class='line-number'>1131</span>
<span class='line-number'>1132</span>
<span class='line-number'>1133</span>
<span class='line-number'>1134</span>
<span class='line-number'>1135</span>
<span class='line-number'>1136</span>
<span class='line-number'>1137</span>
<span class='line-number'>1138</span>
<span class='line-number'>1139</span>
<span class='line-number'>1140</span>
<span class='line-number'>1141</span>
<span class='line-number'>1142</span>
<span class='line-number'>1143</span>
<span class='line-number'>1144</span>
<span class='line-number'>1145</span>
<span class='line-number'>1146</span>
<span class='line-number'>1147</span>
<span class='line-number'>1148</span>
<span class='line-number'>1149</span>
<span class='line-number'>1150</span>
<span class='line-number'>1151</span>
<span class='line-number'>1152</span>
<span class='line-number'>1153</span>
<span class='line-number'>1154</span>
<span class='line-number'>1155</span>
<span class='line-number'>1156</span>
<span class='line-number'>1157</span>
<span class='line-number'>1158</span>
<span class='line-number'>1159</span>
<span class='line-number'>1160</span>
<span class='line-number'>1161</span>
<span class='line-number'>1162</span>
<span class='line-number'>1163</span>
<span class='line-number'>1164</span>
<span class='line-number'>1165</span>
<span class='line-number'>1166</span>
<span class='line-number'>1167</span>
<span class='line-number'>1168</span>
<span class='line-number'>1169</span>
<span class='line-number'>1170</span>
<span class='line-number'>1171</span>
<span class='line-number'>1172</span>
<span class='line-number'>1173</span>
<span class='line-number'>1174</span>
<span class='line-number'>1175</span>
<span class='line-number'>1176</span>
<span class='line-number'>1177</span>
<span class='line-number'>1178</span>
<span class='line-number'>1179</span>
<span class='line-number'>1180</span>
<span class='line-number'>1181</span>
<span class='line-number'>1182</span>
<span class='line-number'>1183</span>
<span class='line-number'>1184</span>
<span class='line-number'>1185</span>
<span class='line-number'>1186</span>
<span class='line-number'>1187</span>
<span class='line-number'>1188</span>
<span class='line-number'>1189</span>
<span class='line-number'>1190</span>
<span class='line-number'>1191</span>
<span class='line-number'>1192</span>
<span class='line-number'>1193</span>
<span class='line-number'>1194</span>
<span class='line-number'>1195</span>
<span class='line-number'>1196</span>
<span class='line-number'>1197</span>
<span class='line-number'>1198</span>
<span class='line-number'>1199</span>
<span class='line-number'>1200</span>
<span class='line-number'>1201</span>
<span class='line-number'>1202</span>
<span class='line-number'>1203</span>
<span class='line-number'>1204</span>
<span class='line-number'>1205</span>
<span class='line-number'>1206</span>
<span class='line-number'>1207</span>
<span class='line-number'>1208</span>
<span class='line-number'>1209</span>
<span class='line-number'>1210</span>
<span class='line-number'>1211</span>
<span class='line-number'>1212</span>
<span class='line-number'>1213</span>
<span class='line-number'>1214</span>
<span class='line-number'>1215</span>
<span class='line-number'>1216</span>
<span class='line-number'>1217</span>
<span class='line-number'>1218</span>
<span class='line-number'>1219</span>
<span class='line-number'>1220</span>
<span class='line-number'>1221</span>
<span class='line-number'>1222</span>
<span class='line-number'>1223</span>
<span class='line-number'>1224</span>
<span class='line-number'>1225</span>
<span class='line-number'>1226</span>
<span class='line-number'>1227</span>
<span class='line-number'>1228</span>
<span class='line-number'>1229</span>
<span class='line-number'>1230</span>
<span class='line-number'>1231</span>
<span class='line-number'>1232</span>
<span class='line-number'>1233</span>
<span class='line-number'>1234</span>
<span class='line-number'>1235</span>
<span class='line-number'>1236</span>
<span class='line-number'>1237</span>
<span class='line-number'>1238</span>
<span class='line-number'>1239</span>
<span class='line-number'>1240</span>
<span class='line-number'>1241</span>
<span class='line-number'>1242</span>
<span class='line-number'>1243</span>
<span class='line-number'>1244</span>
<span class='line-number'>1245</span>
<span class='line-number'>1246</span>
<span class='line-number'>1247</span>
<span class='line-number'>1248</span>
<span class='line-number'>1249</span>
<span class='line-number'>1250</span>
<span class='line-number'>1251</span>
<span class='line-number'>1252</span>
<span class='line-number'>1253</span>
<span class='line-number'>1254</span>
<span class='line-number'>1255</span>
<span class='line-number'>1256</span>
<span class='line-number'>1257</span>
<span class='line-number'>1258</span>
<span class='line-number'>1259</span>
<span class='line-number'>1260</span>
<span class='line-number'>1261</span>
<span class='line-number'>1262</span>
<span class='line-number'>1263</span>
<span class='line-number'>1264</span>
<span class='line-number'>1265</span>
<span class='line-number'>1266</span>
<span class='line-number'>1267</span>
<span class='line-number'>1268</span>
<span class='line-number'>1269</span>
<span class='line-number'>1270</span>
<span class='line-number'>1271</span>
<span class='line-number'>1272</span>
<span class='line-number'>1273</span>
<span class='line-number'>1274</span>
<span class='line-number'>1275</span>
<span class='line-number'>1276</span>
<span class='line-number'>1277</span>
<span class='line-number'>1278</span>
<span class='line-number'>1279</span>
<span class='line-number'>1280</span>
<span class='line-number'>1281</span>
<span class='line-number'>1282</span>
<span class='line-number'>1283</span>
<span class='line-number'>1284</span>
<span class='line-number'>1285</span>
<span class='line-number'>1286</span>
<span class='line-number'>1287</span>
<span class='line-number'>1288</span>
<span class='line-number'>1289</span>
<span class='line-number'>1290</span>
<span class='line-number'>1291</span>
<span class='line-number'>1292</span>
<span class='line-number'>1293</span>
<span class='line-number'>1294</span>
<span class='line-number'>1295</span>
<span class='line-number'>1296</span>
<span class='line-number'>1297</span>
<span class='line-number'>1298</span>
<span class='line-number'>1299</span>
<span class='line-number'>1300</span>
<span class='line-number'>1301</span>
<span class='line-number'>1302</span>
<span class='line-number'>1303</span>
<span class='line-number'>1304</span>
<span class='line-number'>1305</span>
<span class='line-number'>1306</span>
<span class='line-number'>1307</span>
<span class='line-number'>1308</span>
<span class='line-number'>1309</span>
<span class='line-number'>1310</span>
<span class='line-number'>1311</span>
<span class='line-number'>1312</span>
<span class='line-number'>1313</span>
<span class='line-number'>1314</span>
<span class='line-number'>1315</span>
<span class='line-number'>1316</span>
<span class='line-number'>1317</span>
<span class='line-number'>1318</span>
<span class='line-number'>1319</span>
<span class='line-number'>1320</span>
<span class='line-number'>1321</span>
<span class='line-number'>1322</span>
<span class='line-number'>1323</span>
<span class='line-number'>1324</span>
<span class='line-number'>1325</span>
<span class='line-number'>1326</span>
<span class='line-number'>1327</span>
<span class='line-number'>1328</span>
<span class='line-number'>1329</span>
<span class='line-number'>1330</span>
<span class='line-number'>1331</span>
<span class='line-number'>1332</span>
<span class='line-number'>1333</span>
<span class='line-number'>1334</span>
<span class='line-number'>1335</span>
<span class='line-number'>1336</span>
<span class='line-number'>1337</span>
<span class='line-number'>1338</span>
<span class='line-number'>1339</span>
<span class='line-number'>1340</span>
<span class='line-number'>1341</span>
<span class='line-number'>1342</span>
<span class='line-number'>1343</span>
<span class='line-number'>1344</span>
<span class='line-number'>1345</span>
<span class='line-number'>1346</span>
<span class='line-number'>1347</span>
<span class='line-number'>1348</span>
<span class='line-number'>1349</span>
<span class='line-number'>1350</span>
<span class='line-number'>1351</span>
<span class='line-number'>1352</span>
<span class='line-number'>1353</span>
<span class='line-number'>1354</span>
<span class='line-number'>1355</span>
<span class='line-number'>1356</span>
<span class='line-number'>1357</span>
<span class='line-number'>1358</span>
<span class='line-number'>1359</span>
<span class='line-number'>1360</span>
<span class='line-number'>1361</span>
<span class='line-number'>1362</span>
<span class='line-number'>1363</span>
<span class='line-number'>1364</span>
<span class='line-number'>1365</span>
<span class='line-number'>1366</span>
<span class='line-number'>1367</span>
<span class='line-number'>1368</span>
<span class='line-number'>1369</span>
<span class='line-number'>1370</span>
<span class='line-number'>1371</span>
<span class='line-number'>1372</span>
<span class='line-number'>1373</span>
<span class='line-number'>1374</span>
<span class='line-number'>1375</span>
<span class='line-number'>1376</span>
<span class='line-number'>1377</span>
<span class='line-number'>1378</span>
<span class='line-number'>1379</span>
<span class='line-number'>1380</span>
<span class='line-number'>1381</span>
<span class='line-number'>1382</span>
<span class='line-number'>1383</span>
<span class='line-number'>1384</span>
<span class='line-number'>1385</span>
<span class='line-number'>1386</span>
<span class='line-number'>1387</span>
<span class='line-number'>1388</span>
<span class='line-number'>1389</span>
<span class='line-number'>1390</span>
<span class='line-number'>1391</span>
<span class='line-number'>1392</span>
<span class='line-number'>1393</span>
<span class='line-number'>1394</span>
<span class='line-number'>1395</span>
<span class='line-number'>1396</span>
<span class='line-number'>1397</span>
<span class='line-number'>1398</span>
<span class='line-number'>1399</span>
<span class='line-number'>1400</span>
<span class='line-number'>1401</span>
<span class='line-number'>1402</span>
<span class='line-number'>1403</span>
<span class='line-number'>1404</span>
<span class='line-number'>1405</span>
<span class='line-number'>1406</span>
<span class='line-number'>1407</span>
<span class='line-number'>1408</span>
<span class='line-number'>1409</span>
<span class='line-number'>1410</span>
<span class='line-number'>1411</span>
<span class='line-number'>1412</span>
<span class='line-number'>1413</span>
<span class='line-number'>1414</span>
<span class='line-number'>1415</span>
<span class='line-number'>1416</span>
<span class='line-number'>1417</span>
<span class='line-number'>1418</span>
<span class='line-number'>1419</span>
<span class='line-number'>1420</span>
<span class='line-number'>1421</span>
<span class='line-number'>1422</span>
<span class='line-number'>1423</span>
<span class='line-number'>1424</span>
<span class='line-number'>1425</span>
<span class='line-number'>1426</span>
<span class='line-number'>1427</span>
<span class='line-number'>1428</span>
<span class='line-number'>1429</span>
<span class='line-number'>1430</span>
<span class='line-number'>1431</span>
<span class='line-number'>1432</span>
<span class='line-number'>1433</span>
<span class='line-number'>1434</span>
<span class='line-number'>1435</span>
<span class='line-number'>1436</span>
<span class='line-number'>1437</span>
<span class='line-number'>1438</span>
<span class='line-number'>1439</span>
<span class='line-number'>1440</span>
<span class='line-number'>1441</span>
<span class='line-number'>1442</span>
<span class='line-number'>1443</span>
<span class='line-number'>1444</span>
<span class='line-number'>1445</span>
<span class='line-number'>1446</span>
<span class='line-number'>1447</span>
<span class='line-number'>1448</span>
<span class='line-number'>1449</span>
<span class='line-number'>1450</span>
<span class='line-number'>1451</span>
<span class='line-number'>1452</span>
<span class='line-number'>1453</span>
<span class='line-number'>1454</span>
<span class='line-number'>1455</span>
<span class='line-number'>1456</span>
<span class='line-number'>1457</span>
<span class='line-number'>1458</span>
<span class='line-number'>1459</span>
<span class='line-number'>1460</span>
<span class='line-number'>1461</span>
<span class='line-number'>1462</span>
<span class='line-number'>1463</span>
<span class='line-number'>1464</span>
<span class='line-number'>1465</span>
<span class='line-number'>1466</span>
<span class='line-number'>1467</span>
<span class='line-number'>1468</span>
<span class='line-number'>1469</span>
<span class='line-number'>1470</span>
<span class='line-number'>1471</span>
<span class='line-number'>1472</span>
<span class='line-number'>1473</span>
<span class='line-number'>1474</span>
<span class='line-number'>1475</span>
<span class='line-number'>1476</span>
<span class='line-number'>1477</span>
<span class='line-number'>1478</span>
<span class='line-number'>1479</span>
<span class='line-number'>1480</span>
<span class='line-number'>1481</span>
<span class='line-number'>1482</span>
<span class='line-number'>1483</span>
<span class='line-number'>1484</span>
<span class='line-number'>1485</span>
<span class='line-number'>1486</span>
<span class='line-number'>1487</span>
<span class='line-number'>1488</span>
<span class='line-number'>1489</span>
<span class='line-number'>1490</span>
<span class='line-number'>1491</span>
<span class='line-number'>1492</span>
<span class='line-number'>1493</span>
<span class='line-number'>1494</span>
<span class='line-number'>1495</span>
<span class='line-number'>1496</span>
<span class='line-number'>1497</span>
<span class='line-number'>1498</span>
<span class='line-number'>1499</span>
<span class='line-number'>1500</span>
<span class='line-number'>1501</span>
<span class='line-number'>1502</span>
<span class='line-number'>1503</span>
<span class='line-number'>1504</span>
<span class='line-number'>1505</span>
<span class='line-number'>1506</span>
<span class='line-number'>1507</span>
<span class='line-number'>1508</span>
<span class='line-number'>1509</span>
<span class='line-number'>1510</span>
<span class='line-number'>1511</span>
<span class='line-number'>1512</span>
<span class='line-number'>1513</span>
<span class='line-number'>1514</span>
<span class='line-number'>1515</span>
<span class='line-number'>1516</span>
<span class='line-number'>1517</span>
<span class='line-number'>1518</span>
<span class='line-number'>1519</span>
<span class='line-number'>1520</span>
<span class='line-number'>1521</span>
<span class='line-number'>1522</span>
<span class='line-number'>1523</span>
<span class='line-number'>1524</span>
<span class='line-number'>1525</span>
<span class='line-number'>1526</span>
<span class='line-number'>1527</span>
<span class='line-number'>1528</span>
<span class='line-number'>1529</span>
<span class='line-number'>1530</span>
<span class='line-number'>1531</span>
<span class='line-number'>1532</span>
<span class='line-number'>1533</span>
<span class='line-number'>1534</span>
<span class='line-number'>1535</span>
<span class='line-number'>1536</span>
<span class='line-number'>1537</span>
<span class='line-number'>1538</span>
<span class='line-number'>1539</span>
<span class='line-number'>1540</span>
<span class='line-number'>1541</span>
<span class='line-number'>1542</span>
<span class='line-number'>1543</span>
<span class='line-number'>1544</span>
<span class='line-number'>1545</span>
<span class='line-number'>1546</span>
<span class='line-number'>1547</span>
<span class='line-number'>1548</span>
<span class='line-number'>1549</span>
<span class='line-number'>1550</span>
<span class='line-number'>1551</span>
<span class='line-number'>1552</span>
<span class='line-number'>1553</span>
<span class='line-number'>1554</span>
<span class='line-number'>1555</span>
<span class='line-number'>1556</span>
<span class='line-number'>1557</span>
<span class='line-number'>1558</span>
<span class='line-number'>1559</span>
<span class='line-number'>1560</span>
<span class='line-number'>1561</span>
<span class='line-number'>1562</span>
<span class='line-number'>1563</span>
<span class='line-number'>1564</span>
<span class='line-number'>1565</span>
<span class='line-number'>1566</span>
<span class='line-number'>1567</span>
<span class='line-number'>1568</span>
<span class='line-number'>1569</span>
<span class='line-number'>1570</span>
<span class='line-number'>1571</span>
<span class='line-number'>1572</span>
<span class='line-number'>1573</span>
<span class='line-number'>1574</span>
<span class='line-number'>1575</span>
<span class='line-number'>1576</span>
<span class='line-number'>1577</span>
<span class='line-number'>1578</span>
<span class='line-number'>1579</span>
<span class='line-number'>1580</span>
<span class='line-number'>1581</span>
<span class='line-number'>1582</span>
<span class='line-number'>1583</span>
<span class='line-number'>1584</span>
<span class='line-number'>1585</span>
<span class='line-number'>1586</span>
<span class='line-number'>1587</span>
<span class='line-number'>1588</span>
<span class='line-number'>1589</span>
<span class='line-number'>1590</span>
<span class='line-number'>1591</span>
<span class='line-number'>1592</span>
<span class='line-number'>1593</span>
<span class='line-number'>1594</span>
<span class='line-number'>1595</span>
<span class='line-number'>1596</span>
<span class='line-number'>1597</span>
<span class='line-number'>1598</span>
<span class='line-number'>1599</span>
<span class='line-number'>1600</span>
<span class='line-number'>1601</span>
<span class='line-number'>1602</span>
<span class='line-number'>1603</span>
<span class='line-number'>1604</span>
<span class='line-number'>1605</span>
<span class='line-number'>1606</span>
<span class='line-number'>1607</span>
<span class='line-number'>1608</span>
<span class='line-number'>1609</span>
<span class='line-number'>1610</span>
<span class='line-number'>1611</span>
<span class='line-number'>1612</span>
<span class='line-number'>1613</span>
<span class='line-number'>1614</span>
<span class='line-number'>1615</span>
<span class='line-number'>1616</span>
<span class='line-number'>1617</span>
<span class='line-number'>1618</span>
<span class='line-number'>1619</span>
<span class='line-number'>1620</span>
<span class='line-number'>1621</span>
<span class='line-number'>1622</span>
<span class='line-number'>1623</span>
<span class='line-number'>1624</span>
<span class='line-number'>1625</span>
<span class='line-number'>1626</span>
<span class='line-number'>1627</span>
<span class='line-number'>1628</span>
<span class='line-number'>1629</span>
<span class='line-number'>1630</span>
<span class='line-number'>1631</span>
<span class='line-number'>1632</span>
<span class='line-number'>1633</span>
<span class='line-number'>1634</span>
<span class='line-number'>1635</span>
<span class='line-number'>1636</span>
<span class='line-number'>1637</span>
<span class='line-number'>1638</span>
<span class='line-number'>1639</span>
<span class='line-number'>1640</span>
<span class='line-number'>1641</span>
<span class='line-number'>1642</span>
<span class='line-number'>1643</span>
<span class='line-number'>1644</span>
<span class='line-number'>1645</span>
<span class='line-number'>1646</span>
<span class='line-number'>1647</span>
<span class='line-number'>1648</span>
<span class='line-number'>1649</span>
<span class='line-number'>1650</span>
<span class='line-number'>1651</span>
<span class='line-number'>1652</span>
<span class='line-number'>1653</span>
<span class='line-number'>1654</span>
<span class='line-number'>1655</span>
<span class='line-number'>1656</span>
<span class='line-number'>1657</span>
<span class='line-number'>1658</span>
<span class='line-number'>1659</span>
<span class='line-number'>1660</span>
<span class='line-number'>1661</span>
<span class='line-number'>1662</span>
<span class='line-number'>1663</span>
<span class='line-number'>1664</span>
<span class='line-number'>1665</span>
<span class='line-number'>1666</span>
<span class='line-number'>1667</span>
<span class='line-number'>1668</span>
<span class='line-number'>1669</span>
<span class='line-number'>1670</span>
<span class='line-number'>1671</span>
<span class='line-number'>1672</span>
<span class='line-number'>1673</span>
<span class='line-number'>1674</span>
<span class='line-number'>1675</span>
<span class='line-number'>1676</span>
<span class='line-number'>1677</span>
<span class='line-number'>1678</span>
<span class='line-number'>1679</span>
<span class='line-number'>1680</span>
<span class='line-number'>1681</span>
<span class='line-number'>1682</span>
<span class='line-number'>1683</span>
<span class='line-number'>1684</span>
<span class='line-number'>1685</span>
<span class='line-number'>1686</span>
<span class='line-number'>1687</span>
<span class='line-number'>1688</span>
<span class='line-number'>1689</span>
<span class='line-number'>1690</span>
<span class='line-number'>1691</span>
<span class='line-number'>1692</span>
<span class='line-number'>1693</span>
<span class='line-number'>1694</span>
<span class='line-number'>1695</span>
<span class='line-number'>1696</span>
<span class='line-number'>1697</span>
<span class='line-number'>1698</span>
<span class='line-number'>1699</span>
<span class='line-number'>1700</span>
<span class='line-number'>1701</span>
<span class='line-number'>1702</span>
<span class='line-number'>1703</span>
<span class='line-number'>1704</span>
<span class='line-number'>1705</span>
<span class='line-number'>1706</span>
<span class='line-number'>1707</span>
<span class='line-number'>1708</span>
<span class='line-number'>1709</span>
<span class='line-number'>1710</span>
<span class='line-number'>1711</span>
<span class='line-number'>1712</span>
<span class='line-number'>1713</span>
<span class='line-number'>1714</span>
<span class='line-number'>1715</span>
<span class='line-number'>1716</span>
<span class='line-number'>1717</span>
<span class='line-number'>1718</span>
<span class='line-number'>1719</span>
<span class='line-number'>1720</span>
<span class='line-number'>1721</span>
<span class='line-number'>1722</span>
<span class='line-number'>1723</span>
<span class='line-number'>1724</span>
<span class='line-number'>1725</span>
<span class='line-number'>1726</span>
<span class='line-number'>1727</span>
<span class='line-number'>1728</span>
<span class='line-number'>1729</span>
<span class='line-number'>1730</span>
<span class='line-number'>1731</span>
<span class='line-number'>1732</span>
<span class='line-number'>1733</span>
<span class='line-number'>1734</span>
<span class='line-number'>1735</span>
<span class='line-number'>1736</span>
<span class='line-number'>1737</span>
<span class='line-number'>1738</span>
<span class='line-number'>1739</span>
<span class='line-number'>1740</span>
<span class='line-number'>1741</span>
<span class='line-number'>1742</span>
<span class='line-number'>1743</span>
<span class='line-number'>1744</span>
<span class='line-number'>1745</span>
<span class='line-number'>1746</span>
<span class='line-number'>1747</span>
<span class='line-number'>1748</span>
<span class='line-number'>1749</span>
<span class='line-number'>1750</span>
<span class='line-number'>1751</span>
<span class='line-number'>1752</span>
<span class='line-number'>1753</span>
<span class='line-number'>1754</span>
<span class='line-number'>1755</span>
<span class='line-number'>1756</span>
<span class='line-number'>1757</span>
<span class='line-number'>1758</span>
<span class='line-number'>1759</span>
<span class='line-number'>1760</span>
<span class='line-number'>1761</span>
<span class='line-number'>1762</span>
<span class='line-number'>1763</span>
<span class='line-number'>1764</span>
<span class='line-number'>1765</span>
<span class='line-number'>1766</span>
<span class='line-number'>1767</span>
<span class='line-number'>1768</span>
<span class='line-number'>1769</span>
<span class='line-number'>1770</span>
<span class='line-number'>1771</span>
<span class='line-number'>1772</span>
<span class='line-number'>1773</span>
<span class='line-number'>1774</span>
<span class='line-number'>1775</span>
<span class='line-number'>1776</span>
<span class='line-number'>1777</span>
<span class='line-number'>1778</span>
<span class='line-number'>1779</span>
<span class='line-number'>1780</span>
<span class='line-number'>1781</span>
<span class='line-number'>1782</span>
<span class='line-number'>1783</span>
<span class='line-number'>1784</span>
<span class='line-number'>1785</span>
<span class='line-number'>1786</span>
<span class='line-number'>1787</span>
<span class='line-number'>1788</span>
<span class='line-number'>1789</span>
<span class='line-number'>1790</span>
<span class='line-number'>1791</span>
<span class='line-number'>1792</span>
<span class='line-number'>1793</span>
<span class='line-number'>1794</span>
<span class='line-number'>1795</span>
<span class='line-number'>1796</span>
<span class='line-number'>1797</span>
<span class='line-number'>1798</span>
<span class='line-number'>1799</span>
<span class='line-number'>1800</span>
<span class='line-number'>1801</span>
<span class='line-number'>1802</span>
<span class='line-number'>1803</span>
<span class='line-number'>1804</span>
<span class='line-number'>1805</span>
<span class='line-number'>1806</span>
<span class='line-number'>1807</span>
<span class='line-number'>1808</span>
<span class='line-number'>1809</span>
<span class='line-number'>1810</span>
<span class='line-number'>1811</span>
<span class='line-number'>1812</span>
<span class='line-number'>1813</span>
<span class='line-number'>1814</span>
<span class='line-number'>1815</span>
<span class='line-number'>1816</span>
<span class='line-number'>1817</span>
<span class='line-number'>1818</span>
<span class='line-number'>1819</span>
<span class='line-number'>1820</span>
<span class='line-number'>1821</span>
<span class='line-number'>1822</span>
<span class='line-number'>1823</span>
<span class='line-number'>1824</span>
<span class='line-number'>1825</span>
<span class='line-number'>1826</span>
<span class='line-number'>1827</span>
<span class='line-number'>1828</span>
<span class='line-number'>1829</span>
<span class='line-number'>1830</span>
<span class='line-number'>1831</span>
<span class='line-number'>1832</span>
<span class='line-number'>1833</span>
<span class='line-number'>1834</span>
<span class='line-number'>1835</span>
<span class='line-number'>1836</span>
<span class='line-number'>1837</span>
<span class='line-number'>1838</span>
<span class='line-number'>1839</span>
<span class='line-number'>1840</span>
<span class='line-number'>1841</span>
<span class='line-number'>1842</span>
<span class='line-number'>1843</span>
<span class='line-number'>1844</span>
<span class='line-number'>1845</span>
<span class='line-number'>1846</span>
<span class='line-number'>1847</span>
<span class='line-number'>1848</span>
<span class='line-number'>1849</span>
<span class='line-number'>1850</span>
<span class='line-number'>1851</span>
<span class='line-number'>1852</span>
<span class='line-number'>1853</span>
<span class='line-number'>1854</span>
<span class='line-number'>1855</span>
<span class='line-number'>1856</span>
<span class='line-number'>1857</span>
<span class='line-number'>1858</span>
<span class='line-number'>1859</span>
<span class='line-number'>1860</span>
<span class='line-number'>1861</span>
<span class='line-number'>1862</span>
<span class='line-number'>1863</span>
<span class='line-number'>1864</span>
<span class='line-number'>1865</span>
<span class='line-number'>1866</span>
<span class='line-number'>1867</span>
<span class='line-number'>1868</span>
<span class='line-number'>1869</span>
<span class='line-number'>1870</span>
<span class='line-number'>1871</span>
<span class='line-number'>1872</span>
<span class='line-number'>1873</span>
<span class='line-number'>1874</span>
<span class='line-number'>1875</span>
<span class='line-number'>1876</span>
<span class='line-number'>1877</span>
<span class='line-number'>1878</span>
<span class='line-number'>1879</span>
<span class='line-number'>1880</span>
<span class='line-number'>1881</span>
<span class='line-number'>1882</span>
<span class='line-number'>1883</span>
<span class='line-number'>1884</span>
<span class='line-number'>1885</span>
<span class='line-number'>1886</span>
<span class='line-number'>1887</span>
<span class='line-number'>1888</span>
<span class='line-number'>1889</span>
<span class='line-number'>1890</span>
<span class='line-number'>1891</span>
<span class='line-number'>1892</span>
<span class='line-number'>1893</span>
<span class='line-number'>1894</span>
<span class='line-number'>1895</span>
<span class='line-number'>1896</span>
<span class='line-number'>1897</span>
<span class='line-number'>1898</span>
<span class='line-number'>1899</span>
<span class='line-number'>1900</span>
<span class='line-number'>1901</span>
<span class='line-number'>1902</span>
<span class='line-number'>1903</span>
<span class='line-number'>1904</span>
<span class='line-number'>1905</span>
<span class='line-number'>1906</span>
<span class='line-number'>1907</span>
<span class='line-number'>1908</span>
<span class='line-number'>1909</span>
<span class='line-number'>1910</span>
<span class='line-number'>1911</span>
<span class='line-number'>1912</span>
<span class='line-number'>1913</span>
<span class='line-number'>1914</span>
<span class='line-number'>1915</span>
<span class='line-number'>1916</span>
<span class='line-number'>1917</span>
<span class='line-number'>1918</span>
<span class='line-number'>1919</span>
<span class='line-number'>1920</span>
<span class='line-number'>1921</span>
<span class='line-number'>1922</span>
<span class='line-number'>1923</span>
<span class='line-number'>1924</span>
<span class='line-number'>1925</span>
<span class='line-number'>1926</span>
<span class='line-number'>1927</span>
<span class='line-number'>1928</span>
<span class='line-number'>1929</span>
<span class='line-number'>1930</span>
<span class='line-number'>1931</span>
<span class='line-number'>1932</span>
<span class='line-number'>1933</span>
<span class='line-number'>1934</span>
<span class='line-number'>1935</span>
<span class='line-number'>1936</span>
<span class='line-number'>1937</span>
<span class='line-number'>1938</span>
<span class='line-number'>1939</span>
<span class='line-number'>1940</span>
<span class='line-number'>1941</span>
<span class='line-number'>1942</span>
<span class='line-number'>1943</span>
<span class='line-number'>1944</span>
<span class='line-number'>1945</span>
<span class='line-number'>1946</span>
<span class='line-number'>1947</span>
<span class='line-number'>1948</span>
<span class='line-number'>1949</span>
<span class='line-number'>1950</span>
<span class='line-number'>1951</span>
<span class='line-number'>1952</span>
<span class='line-number'>1953</span>
<span class='line-number'>1954</span>
<span class='line-number'>1955</span>
<span class='line-number'>1956</span>
<span class='line-number'>1957</span>
<span class='line-number'>1958</span>
<span class='line-number'>1959</span>
<span class='line-number'>1960</span>
<span class='line-number'>1961</span>
<span class='line-number'>1962</span>
<span class='line-number'>1963</span>
<span class='line-number'>1964</span>
<span class='line-number'>1965</span>
<span class='line-number'>1966</span>
<span class='line-number'>1967</span>
<span class='line-number'>1968</span>
<span class='line-number'>1969</span>
<span class='line-number'>1970</span>
<span class='line-number'>1971</span>
<span class='line-number'>1972</span>
<span class='line-number'>1973</span>
<span class='line-number'>1974</span>
<span class='line-number'>1975</span>
<span class='line-number'>1976</span>
<span class='line-number'>1977</span>
<span class='line-number'>1978</span>
<span class='line-number'>1979</span>
<span class='line-number'>1980</span>
<span class='line-number'>1981</span>
<span class='line-number'>1982</span>
<span class='line-number'>1983</span>
<span class='line-number'>1984</span>
<span class='line-number'>1985</span>
<span class='line-number'>1986</span>
<span class='line-number'>1987</span>
<span class='line-number'>1988</span>
<span class='line-number'>1989</span>
<span class='line-number'>1990</span>
<span class='line-number'>1991</span>
<span class='line-number'>1992</span>
<span class='line-number'>1993</span>
<span class='line-number'>1994</span>
<span class='line-number'>1995</span>
<span class='line-number'>1996</span>
<span class='line-number'>1997</span>
<span class='line-number'>1998</span>
<span class='line-number'>1999</span>
<span class='line-number'>2000</span>
<span class='line-number'>2001</span>
<span class='line-number'>2002</span>
<span class='line-number'>2003</span>
<span class='line-number'>2004</span>
<span class='line-number'>2005</span>
<span class='line-number'>2006</span>
<span class='line-number'>2007</span>
<span class='line-number'>2008</span>
<span class='line-number'>2009</span>
<span class='line-number'>2010</span>
<span class='line-number'>2011</span>
<span class='line-number'>2012</span>
<span class='line-number'>2013</span>
<span class='line-number'>2014</span>
<span class='line-number'>2015</span>
<span class='line-number'>2016</span>
<span class='line-number'>2017</span>
<span class='line-number'>2018</span>
<span class='line-number'>2019</span>
<span class='line-number'>2020</span>
<span class='line-number'>2021</span>
<span class='line-number'>2022</span>
<span class='line-number'>2023</span>
<span class='line-number'>2024</span>
<span class='line-number'>2025</span>
<span class='line-number'>2026</span>
<span class='line-number'>2027</span>
<span class='line-number'>2028</span>
<span class='line-number'>2029</span>
<span class='line-number'>2030</span>
<span class='line-number'>2031</span>
<span class='line-number'>2032</span>
<span class='line-number'>2033</span>
<span class='line-number'>2034</span>
<span class='line-number'>2035</span>
<span class='line-number'>2036</span>
<span class='line-number'>2037</span>
<span class='line-number'>2038</span>
<span class='line-number'>2039</span>
<span class='line-number'>2040</span>
<span class='line-number'>2041</span>
<span class='line-number'>2042</span>
<span class='line-number'>2043</span>
<span class='line-number'>2044</span>
<span class='line-number'>2045</span>
<span class='line-number'>2046</span>
<span class='line-number'>2047</span>
<span class='line-number'>2048</span>
<span class='line-number'>2049</span>
<span class='line-number'>2050</span>
<span class='line-number'>2051</span>
<span class='line-number'>2052</span>
<span class='line-number'>2053</span>
<span class='line-number'>2054</span>
<span class='line-number'>2055</span>
<span class='line-number'>2056</span>
<span class='line-number'>2057</span>
<span class='line-number'>2058</span>
<span class='line-number'>2059</span>
<span class='line-number'>2060</span>
<span class='line-number'>2061</span>
<span class='line-number'>2062</span>
<span class='line-number'>2063</span>
<span class='line-number'>2064</span>
<span class='line-number'>2065</span>
<span class='line-number'>2066</span>
<span class='line-number'>2067</span>
<span class='line-number'>2068</span>
<span class='line-number'>2069</span>
<span class='line-number'>2070</span>
<span class='line-number'>2071</span>
<span class='line-number'>2072</span>
<span class='line-number'>2073</span>
<span class='line-number'>2074</span>
<span class='line-number'>2075</span>
<span class='line-number'>2076</span>
<span class='line-number'>2077</span>
<span class='line-number'>2078</span>
<span class='line-number'>2079</span>
<span class='line-number'>2080</span>
<span class='line-number'>2081</span>
<span class='line-number'>2082</span>
<span class='line-number'>2083</span>
<span class='line-number'>2084</span>
<span class='line-number'>2085</span>
<span class='line-number'>2086</span>
<span class='line-number'>2087</span>
<span class='line-number'>2088</span>
<span class='line-number'>2089</span>
<span class='line-number'>2090</span>
<span class='line-number'>2091</span>
<span class='line-number'>2092</span>
<span class='line-number'>2093</span>
<span class='line-number'>2094</span>
<span class='line-number'>2095</span>
<span class='line-number'>2096</span>
<span class='line-number'>2097</span>
<span class='line-number'>2098</span>
<span class='line-number'>2099</span>
<span class='line-number'>2100</span>
<span class='line-number'>2101</span>
<span class='line-number'>2102</span>
<span class='line-number'>2103</span>
<span class='line-number'>2104</span>
<span class='line-number'>2105</span>
<span class='line-number'>2106</span>
<span class='line-number'>2107</span>
<span class='line-number'>2108</span>
<span class='line-number'>2109</span>
<span class='line-number'>2110</span>
<span class='line-number'>2111</span>
<span class='line-number'>2112</span>
<span class='line-number'>2113</span>
<span class='line-number'>2114</span>
<span class='line-number'>2115</span>
<span class='line-number'>2116</span>
<span class='line-number'>2117</span>
<span class='line-number'>2118</span>
<span class='line-number'>2119</span>
<span class='line-number'>2120</span>
<span class='line-number'>2121</span>
<span class='line-number'>2122</span>
<span class='line-number'>2123</span>
<span class='line-number'>2124</span>
<span class='line-number'>2125</span>
<span class='line-number'>2126</span>
<span class='line-number'>2127</span>
<span class='line-number'>2128</span>
<span class='line-number'>2129</span>
<span class='line-number'>2130</span>
<span class='line-number'>2131</span>
<span class='line-number'>2132</span>
<span class='line-number'>2133</span>
<span class='line-number'>2134</span>
<span class='line-number'>2135</span>
<span class='line-number'>2136</span>
<span class='line-number'>2137</span>
<span class='line-number'>2138</span>
<span class='line-number'>2139</span>
<span class='line-number'>2140</span>
<span class='line-number'>2141</span>
<span class='line-number'>2142</span>
<span class='line-number'>2143</span>
<span class='line-number'>2144</span>
<span class='line-number'>2145</span>
<span class='line-number'>2146</span>
<span class='line-number'>2147</span>
<span class='line-number'>2148</span>
<span class='line-number'>2149</span>
<span class='line-number'>2150</span>
<span class='line-number'>2151</span>
<span class='line-number'>2152</span>
<span class='line-number'>2153</span>
<span class='line-number'>2154</span>
<span class='line-number'>2155</span>
<span class='line-number'>2156</span>
<span class='line-number'>2157</span>
<span class='line-number'>2158</span>
<span class='line-number'>2159</span>
<span class='line-number'>2160</span>
<span class='line-number'>2161</span>
<span class='line-number'>2162</span>
<span class='line-number'>2163</span>
<span class='line-number'>2164</span>
<span class='line-number'>2165</span>
<span class='line-number'>2166</span>
<span class='line-number'>2167</span>
<span class='line-number'>2168</span>
<span class='line-number'>2169</span>
<span class='line-number'>2170</span>
<span class='line-number'>2171</span>
<span class='line-number'>2172</span>
<span class='line-number'>2173</span>
<span class='line-number'>2174</span>
<span class='line-number'>2175</span>
<span class='line-number'>2176</span>
<span class='line-number'>2177</span>
<span class='line-number'>2178</span>
<span class='line-number'>2179</span>
<span class='line-number'>2180</span>
<span class='line-number'>2181</span>
<span class='line-number'>2182</span>
<span class='line-number'>2183</span>
<span class='line-number'>2184</span>
<span class='line-number'>2185</span>
<span class='line-number'>2186</span>
<span class='line-number'>2187</span>
<span class='line-number'>2188</span>
<span class='line-number'>2189</span>
<span class='line-number'>2190</span>
<span class='line-number'>2191</span>
<span class='line-number'>2192</span>
<span class='line-number'>2193</span>
<span class='line-number'>2194</span>
<span class='line-number'>2195</span>
<span class='line-number'>2196</span>
<span class='line-number'>2197</span>
<span class='line-number'>2198</span>
<span class='line-number'>2199</span>
<span class='line-number'>2200</span>
<span class='line-number'>2201</span>
<span class='line-number'>2202</span>
<span class='line-number'>2203</span>
<span class='line-number'>2204</span>
<span class='line-number'>2205</span>
<span class='line-number'>2206</span>
<span class='line-number'>2207</span>
<span class='line-number'>2208</span>
<span class='line-number'>2209</span>
<span class='line-number'>2210</span>
<span class='line-number'>2211</span>
<span class='line-number'>2212</span>
<span class='line-number'>2213</span>
<span class='line-number'>2214</span>
<span class='line-number'>2215</span>
<span class='line-number'>2216</span>
<span class='line-number'>2217</span>
<span class='line-number'>2218</span>
<span class='line-number'>2219</span>
<span class='line-number'>2220</span>
<span class='line-number'>2221</span>
<span class='line-number'>2222</span>
<span class='line-number'>2223</span>
<span class='line-number'>2224</span>
<span class='line-number'>2225</span>
<span class='line-number'>2226</span>
<span class='line-number'>2227</span>
<span class='line-number'>2228</span>
<span class='line-number'>2229</span>
<span class='line-number'>2230</span>
<span class='line-number'>2231</span>
<span class='line-number'>2232</span>
<span class='line-number'>2233</span>
<span class='line-number'>2234</span>
<span class='line-number'>2235</span>
<span class='line-number'>2236</span>
<span class='line-number'>2237</span>
<span class='line-number'>2238</span>
<span class='line-number'>2239</span>
<span class='line-number'>2240</span>
<span class='line-number'>2241</span>
<span class='line-number'>2242</span>
<span class='line-number'>2243</span>
<span class='line-number'>2244</span>
<span class='line-number'>2245</span>
<span class='line-number'>2246</span>
<span class='line-number'>2247</span>
<span class='line-number'>2248</span>
<span class='line-number'>2249</span>
<span class='line-number'>2250</span>
<span class='line-number'>2251</span>
<span class='line-number'>2252</span>
<span class='line-number'>2253</span>
<span class='line-number'>2254</span>
<span class='line-number'>2255</span>
<span class='line-number'>2256</span>
<span class='line-number'>2257</span>
<span class='line-number'>2258</span>
<span class='line-number'>2259</span>
<span class='line-number'>2260</span>
<span class='line-number'>2261</span>
<span class='line-number'>2262</span>
<span class='line-number'>2263</span>
<span class='line-number'>2264</span>
<span class='line-number'>2265</span>
<span class='line-number'>2266</span>
<span class='line-number'>2267</span>
<span class='line-number'>2268</span>
<span class='line-number'>2269</span>
<span class='line-number'>2270</span>
<span class='line-number'>2271</span>
<span class='line-number'>2272</span>
<span class='line-number'>2273</span>
<span class='line-number'>2274</span>
<span class='line-number'>2275</span>
<span class='line-number'>2276</span>
<span class='line-number'>2277</span>
<span class='line-number'>2278</span>
<span class='line-number'>2279</span>
<span class='line-number'>2280</span>
<span class='line-number'>2281</span>
<span class='line-number'>2282</span>
<span class='line-number'>2283</span>
<span class='line-number'>2284</span>
<span class='line-number'>2285</span>
<span class='line-number'>2286</span>
<span class='line-number'>2287</span>
<span class='line-number'>2288</span>
<span class='line-number'>2289</span>
<span class='line-number'>2290</span>
<span class='line-number'>2291</span>
<span class='line-number'>2292</span>
<span class='line-number'>2293</span>
<span class='line-number'>2294</span>
<span class='line-number'>2295</span>
<span class='line-number'>2296</span>
<span class='line-number'>2297</span>
<span class='line-number'>2298</span>
<span class='line-number'>2299</span>
<span class='line-number'>2300</span>
<span class='line-number'>2301</span>
<span class='line-number'>2302</span>
<span class='line-number'>2303</span>
<span class='line-number'>2304</span>
<span class='line-number'>2305</span>
<span class='line-number'>2306</span>
<span class='line-number'>2307</span>
<span class='line-number'>2308</span>
<span class='line-number'>2309</span>
<span class='line-number'>2310</span>
<span class='line-number'>2311</span>
<span class='line-number'>2312</span>
<span class='line-number'>2313</span>
<span class='line-number'>2314</span>
<span class='line-number'>2315</span>
<span class='line-number'>2316</span>
<span class='line-number'>2317</span>
<span class='line-number'>2318</span>
<span class='line-number'>2319</span>
<span class='line-number'>2320</span>
<span class='line-number'>2321</span>
<span class='line-number'>2322</span>
<span class='line-number'>2323</span>
<span class='line-number'>2324</span>
<span class='line-number'>2325</span>
<span class='line-number'>2326</span>
<span class='line-number'>2327</span>
<span class='line-number'>2328</span>
<span class='line-number'>2329</span>
<span class='line-number'>2330</span>
<span class='line-number'>2331</span>
<span class='line-number'>2332</span>
<span class='line-number'>2333</span>
<span class='line-number'>2334</span>
<span class='line-number'>2335</span>
<span class='line-number'>2336</span>
<span class='line-number'>2337</span>
<span class='line-number'>2338</span>
<span class='line-number'>2339</span>
<span class='line-number'>2340</span>
<span class='line-number'>2341</span>
<span class='line-number'>2342</span>
<span class='line-number'>2343</span>
<span class='line-number'>2344</span>
<span class='line-number'>2345</span>
<span class='line-number'>2346</span>
<span class='line-number'>2347</span>
<span class='line-number'>2348</span>
<span class='line-number'>2349</span>
<span class='line-number'>2350</span>
<span class='line-number'>2351</span>
<span class='line-number'>2352</span>
<span class='line-number'>2353</span>
<span class='line-number'>2354</span>
<span class='line-number'>2355</span>
<span class='line-number'>2356</span>
<span class='line-number'>2357</span>
<span class='line-number'>2358</span>
<span class='line-number'>2359</span>
<span class='line-number'>2360</span>
<span class='line-number'>2361</span>
<span class='line-number'>2362</span>
<span class='line-number'>2363</span>
<span class='line-number'>2364</span>
<span class='line-number'>2365</span>
<span class='line-number'>2366</span>
<span class='line-number'>2367</span>
<span class='line-number'>2368</span>
<span class='line-number'>2369</span>
<span class='line-number'>2370</span>
<span class='line-number'>2371</span>
<span class='line-number'>2372</span>
<span class='line-number'>2373</span>
<span class='line-number'>2374</span>
<span class='line-number'>2375</span>
<span class='line-number'>2376</span>
<span class='line-number'>2377</span>
<span class='line-number'>2378</span>
<span class='line-number'>2379</span>
<span class='line-number'>2380</span>
<span class='line-number'>2381</span>
<span class='line-number'>2382</span>
<span class='line-number'>2383</span>
<span class='line-number'>2384</span>
<span class='line-number'>2385</span>
<span class='line-number'>2386</span>
<span class='line-number'>2387</span>
<span class='line-number'>2388</span>
<span class='line-number'>2389</span>
<span class='line-number'>2390</span>
<span class='line-number'>2391</span>
<span class='line-number'>2392</span>
<span class='line-number'>2393</span>
<span class='line-number'>2394</span>
<span class='line-number'>2395</span>
<span class='line-number'>2396</span>
<span class='line-number'>2397</span>
<span class='line-number'>2398</span>
<span class='line-number'>2399</span>
<span class='line-number'>2400</span>
<span class='line-number'>2401</span>
<span class='line-number'>2402</span>
<span class='line-number'>2403</span>
<span class='line-number'>2404</span>
<span class='line-number'>2405</span>
<span class='line-number'>2406</span>
<span class='line-number'>2407</span>
<span class='line-number'>2408</span>
<span class='line-number'>2409</span>
<span class='line-number'>2410</span>
<span class='line-number'>2411</span>
<span class='line-number'>2412</span>
<span class='line-number'>2413</span>
<span class='line-number'>2414</span>
<span class='line-number'>2415</span>
<span class='line-number'>2416</span>
<span class='line-number'>2417</span>
<span class='line-number'>2418</span>
<span class='line-number'>2419</span>
<span class='line-number'>2420</span>
<span class='line-number'>2421</span>
<span class='line-number'>2422</span>
<span class='line-number'>2423</span>
<span class='line-number'>2424</span>
<span class='line-number'>2425</span>
<span class='line-number'>2426</span>
<span class='line-number'>2427</span>
<span class='line-number'>2428</span>
<span class='line-number'>2429</span>
<span class='line-number'>2430</span>
<span class='line-number'>2431</span>
<span class='line-number'>2432</span>
<span class='line-number'>2433</span>
<span class='line-number'>2434</span>
<span class='line-number'>2435</span>
<span class='line-number'>2436</span>
<span class='line-number'>2437</span>
<span class='line-number'>2438</span>
<span class='line-number'>2439</span>
<span class='line-number'>2440</span>
<span class='line-number'>2441</span>
<span class='line-number'>2442</span>
<span class='line-number'>2443</span>
<span class='line-number'>2444</span>
<span class='line-number'>2445</span>
<span class='line-number'>2446</span>
<span class='line-number'>2447</span>
<span class='line-number'>2448</span>
<span class='line-number'>2449</span>
<span class='line-number'>2450</span>
<span class='line-number'>2451</span>
<span class='line-number'>2452</span>
<span class='line-number'>2453</span>
<span class='line-number'>2454</span>
<span class='line-number'>2455</span>
<span class='line-number'>2456</span>
<span class='line-number'>2457</span>
<span class='line-number'>2458</span>
<span class='line-number'>2459</span>
<span class='line-number'>2460</span>
<span class='line-number'>2461</span>
<span class='line-number'>2462</span>
<span class='line-number'>2463</span>
<span class='line-number'>2464</span>
<span class='line-number'>2465</span>
<span class='line-number'>2466</span>
<span class='line-number'>2467</span>
<span class='line-number'>2468</span>
<span class='line-number'>2469</span>
<span class='line-number'>2470</span>
<span class='line-number'>2471</span>
<span class='line-number'>2472</span>
<span class='line-number'>2473</span>
<span class='line-number'>2474</span>
<span class='line-number'>2475</span>
<span class='line-number'>2476</span>
<span class='line-number'>2477</span>
<span class='line-number'>2478</span>
<span class='line-number'>2479</span>
<span class='line-number'>2480</span>
<span class='line-number'>2481</span>
<span class='line-number'>2482</span>
<span class='line-number'>2483</span>
<span class='line-number'>2484</span>
<span class='line-number'>2485</span>
<span class='line-number'>2486</span>
<span class='line-number'>2487</span>
<span class='line-number'>2488</span>
<span class='line-number'>2489</span>
<span class='line-number'>2490</span>
<span class='line-number'>2491</span>
<span class='line-number'>2492</span>
<span class='line-number'>2493</span>
<span class='line-number'>2494</span>
<span class='line-number'>2495</span>
<span class='line-number'>2496</span>
<span class='line-number'>2497</span>
<span class='line-number'>2498</span>
<span class='line-number'>2499</span>
<span class='line-number'>2500</span>
<span class='line-number'>2501</span>
<span class='line-number'>2502</span>
<span class='line-number'>2503</span>
<span class='line-number'>2504</span>
<span class='line-number'>2505</span>
<span class='line-number'>2506</span>
<span class='line-number'>2507</span>
<span class='line-number'>2508</span>
<span class='line-number'>2509</span>
<span class='line-number'>2510</span>
<span class='line-number'>2511</span>
<span class='line-number'>2512</span>
<span class='line-number'>2513</span>
<span class='line-number'>2514</span>
<span class='line-number'>2515</span>
<span class='line-number'>2516</span>
<span class='line-number'>2517</span>
<span class='line-number'>2518</span>
<span class='line-number'>2519</span>
<span class='line-number'>2520</span>
<span class='line-number'>2521</span>
<span class='line-number'>2522</span>
<span class='line-number'>2523</span>
<span class='line-number'>2524</span>
<span class='line-number'>2525</span>
<span class='line-number'>2526</span>
<span class='line-number'>2527</span>
<span class='line-number'>2528</span>
<span class='line-number'>2529</span>
<span class='line-number'>2530</span>
<span class='line-number'>2531</span>
<span class='line-number'>2532</span>
<span class='line-number'>2533</span>
<span class='line-number'>2534</span>
<span class='line-number'>2535</span>
<span class='line-number'>2536</span>
<span class='line-number'>2537</span>
<span class='line-number'>2538</span>
<span class='line-number'>2539</span>
<span class='line-number'>2540</span>
<span class='line-number'>2541</span>
<span class='line-number'>2542</span>
<span class='line-number'>2543</span>
<span class='line-number'>2544</span>
<span class='line-number'>2545</span>
<span class='line-number'>2546</span>
<span class='line-number'>2547</span>
<span class='line-number'>2548</span>
<span class='line-number'>2549</span>
<span class='line-number'>2550</span>
<span class='line-number'>2551</span>
<span class='line-number'>2552</span>
<span class='line-number'>2553</span>
<span class='line-number'>2554</span>
<span class='line-number'>2555</span>
<span class='line-number'>2556</span>
<span class='line-number'>2557</span>
<span class='line-number'>2558</span>
<span class='line-number'>2559</span>
<span class='line-number'>2560</span>
<span class='line-number'>2561</span>
<span class='line-number'>2562</span>
<span class='line-number'>2563</span>
<span class='line-number'>2564</span>
<span class='line-number'>2565</span>
<span class='line-number'>2566</span>
<span class='line-number'>2567</span>
<span class='line-number'>2568</span>
<span class='line-number'>2569</span>
<span class='line-number'>2570</span>
<span class='line-number'>2571</span>
<span class='line-number'>2572</span>
<span class='line-number'>2573</span>
<span class='line-number'>2574</span>
<span class='line-number'>2575</span>
<span class='line-number'>2576</span>
<span class='line-number'>2577</span>
<span class='line-number'>2578</span>
<span class='line-number'>2579</span>
<span class='line-number'>2580</span>
<span class='line-number'>2581</span>
<span class='line-number'>2582</span>
<span class='line-number'>2583</span>
<span class='line-number'>2584</span>
<span class='line-number'>2585</span>
<span class='line-number'>2586</span>
<span class='line-number'>2587</span>
<span class='line-number'>2588</span>
<span class='line-number'>2589</span>
<span class='line-number'>2590</span>
<span class='line-number'>2591</span>
<span class='line-number'>2592</span>
<span class='line-number'>2593</span>
<span class='line-number'>2594</span>
<span class='line-number'>2595</span>
<span class='line-number'>2596</span>
<span class='line-number'>2597</span>
<span class='line-number'>2598</span>
<span class='line-number'>2599</span>
<span class='line-number'>2600</span>
<span class='line-number'>2601</span>
<span class='line-number'>2602</span>
<span class='line-number'>2603</span>
<span class='line-number'>2604</span>
<span class='line-number'>2605</span>
<span class='line-number'>2606</span>
<span class='line-number'>2607</span>
<span class='line-number'>2608</span>
<span class='line-number'>2609</span>
<span class='line-number'>2610</span>
<span class='line-number'>2611</span>
<span class='line-number'>2612</span>
<span class='line-number'>2613</span>
<span class='line-number'>2614</span>
<span class='line-number'>2615</span>
<span class='line-number'>2616</span>
<span class='line-number'>2617</span>
<span class='line-number'>2618</span>
<span class='line-number'>2619</span>
<span class='line-number'>2620</span>
<span class='line-number'>2621</span>
<span class='line-number'>2622</span>
<span class='line-number'>2623</span>
<span class='line-number'>2624</span>
<span class='line-number'>2625</span>
<span class='line-number'>2626</span>
<span class='line-number'>2627</span>
<span class='line-number'>2628</span>
<span class='line-number'>2629</span>
<span class='line-number'>2630</span>
<span class='line-number'>2631</span>
<span class='line-number'>2632</span>
<span class='line-number'>2633</span>
<span class='line-number'>2634</span>
<span class='line-number'>2635</span>
<span class='line-number'>2636</span>
<span class='line-number'>2637</span>
<span class='line-number'>2638</span>
<span class='line-number'>2639</span>
<span class='line-number'>2640</span>
<span class='line-number'>2641</span>
<span class='line-number'>2642</span>
<span class='line-number'>2643</span>
<span class='line-number'>2644</span>
<span class='line-number'>2645</span>
<span class='line-number'>2646</span>
<span class='line-number'>2647</span>
<span class='line-number'>2648</span>
<span class='line-number'>2649</span>
<span class='line-number'>2650</span>
<span class='line-number'>2651</span>
<span class='line-number'>2652</span>
<span class='line-number'>2653</span>
<span class='line-number'>2654</span>
<span class='line-number'>2655</span>
<span class='line-number'>2656</span>
<span class='line-number'>2657</span>
<span class='line-number'>2658</span>
<span class='line-number'>2659</span>
<span class='line-number'>2660</span>
<span class='line-number'>2661</span>
<span class='line-number'>2662</span>
<span class='line-number'>2663</span>
<span class='line-number'>2664</span>
<span class='line-number'>2665</span>
<span class='line-number'>2666</span>
<span class='line-number'>2667</span>
<span class='line-number'>2668</span>
<span class='line-number'>2669</span>
<span class='line-number'>2670</span>
<span class='line-number'>2671</span>
<span class='line-number'>2672</span>
<span class='line-number'>2673</span>
<span class='line-number'>2674</span>
<span class='line-number'>2675</span>
<span class='line-number'>2676</span>
<span class='line-number'>2677</span>
<span class='line-number'>2678</span>
<span class='line-number'>2679</span>
<span class='line-number'>2680</span>
<span class='line-number'>2681</span>
<span class='line-number'>2682</span>
<span class='line-number'>2683</span>
<span class='line-number'>2684</span>
<span class='line-number'>2685</span>
<span class='line-number'>2686</span>
<span class='line-number'>2687</span>
<span class='line-number'>2688</span>
<span class='line-number'>2689</span>
<span class='line-number'>2690</span>
<span class='line-number'>2691</span>
<span class='line-number'>2692</span>
<span class='line-number'>2693</span>
<span class='line-number'>2694</span>
<span class='line-number'>2695</span>
<span class='line-number'>2696</span>
<span class='line-number'>2697</span>
<span class='line-number'>2698</span>
<span class='line-number'>2699</span>
<span class='line-number'>2700</span>
<span class='line-number'>2701</span>
<span class='line-number'>2702</span>
<span class='line-number'>2703</span>
<span class='line-number'>2704</span>
<span class='line-number'>2705</span>
<span class='line-number'>2706</span>
<span class='line-number'>2707</span>
<span class='line-number'>2708</span>
<span class='line-number'>2709</span>
<span class='line-number'>2710</span>
<span class='line-number'>2711</span>
<span class='line-number'>2712</span>
<span class='line-number'>2713</span>
<span class='line-number'>2714</span>
<span class='line-number'>2715</span>
<span class='line-number'>2716</span>
<span class='line-number'>2717</span>
<span class='line-number'>2718</span>
<span class='line-number'>2719</span>
<span class='line-number'>2720</span>
<span class='line-number'>2721</span>
<span class='line-number'>2722</span>
<span class='line-number'>2723</span>
<span class='line-number'>2724</span>
<span class='line-number'>2725</span>
<span class='line-number'>2726</span>
<span class='line-number'>2727</span>
<span class='line-number'>2728</span>
<span class='line-number'>2729</span>
<span class='line-number'>2730</span>
<span class='line-number'>2731</span>
<span class='line-number'>2732</span>
<span class='line-number'>2733</span>
<span class='line-number'>2734</span>
<span class='line-number'>2735</span>
<span class='line-number'>2736</span>
<span class='line-number'>2737</span>
<span class='line-number'>2738</span>
<span class='line-number'>2739</span>
<span class='line-number'>2740</span>
<span class='line-number'>2741</span>
<span class='line-number'>2742</span>
<span class='line-number'>2743</span>
<span class='line-number'>2744</span>
<span class='line-number'>2745</span>
<span class='line-number'>2746</span>
<span class='line-number'>2747</span>
<span class='line-number'>2748</span>
<span class='line-number'>2749</span>
<span class='line-number'>2750</span>
<span class='line-number'>2751</span>
<span class='line-number'>2752</span>
<span class='line-number'>2753</span>
<span class='line-number'>2754</span>
<span class='line-number'>2755</span>
<span class='line-number'>2756</span>
<span class='line-number'>2757</span>
<span class='line-number'>2758</span>
<span class='line-number'>2759</span>
<span class='line-number'>2760</span>
<span class='line-number'>2761</span>
<span class='line-number'>2762</span>
<span class='line-number'>2763</span>
<span class='line-number'>2764</span>
<span class='line-number'>2765</span>
<span class='line-number'>2766</span>
<span class='line-number'>2767</span>
<span class='line-number'>2768</span>
<span class='line-number'>2769</span>
<span class='line-number'>2770</span>
<span class='line-number'>2771</span>
<span class='line-number'>2772</span>
<span class='line-number'>2773</span>
<span class='line-number'>2774</span>
<span class='line-number'>2775</span>
<span class='line-number'>2776</span>
<span class='line-number'>2777</span>
<span class='line-number'>2778</span>
<span class='line-number'>2779</span>
<span class='line-number'>2780</span>
<span class='line-number'>2781</span>
<span class='line-number'>2782</span>
<span class='line-number'>2783</span>
<span class='line-number'>2784</span>
<span class='line-number'>2785</span>
<span class='line-number'>2786</span>
<span class='line-number'>2787</span>
<span class='line-number'>2788</span>
<span class='line-number'>2789</span>
<span class='line-number'>2790</span>
<span class='line-number'>2791</span>
<span class='line-number'>2792</span>
<span class='line-number'>2793</span>
<span class='line-number'>2794</span>
<span class='line-number'>2795</span>
<span class='line-number'>2796</span>
<span class='line-number'>2797</span>
<span class='line-number'>2798</span>
<span class='line-number'>2799</span>
<span class='line-number'>2800</span>
<span class='line-number'>2801</span>
<span class='line-number'>2802</span>
<span class='line-number'>2803</span>
<span class='line-number'>2804</span>
<span class='line-number'>2805</span>
<span class='line-number'>2806</span>
<span class='line-number'>2807</span>
<span class='line-number'>2808</span>
<span class='line-number'>2809</span>
<span class='line-number'>2810</span>
<span class='line-number'>2811</span>
<span class='line-number'>2812</span>
<span class='line-number'>2813</span>
<span class='line-number'>2814</span>
<span class='line-number'>2815</span>
<span class='line-number'>2816</span>
<span class='line-number'>2817</span>
<span class='line-number'>2818</span>
<span class='line-number'>2819</span>
<span class='line-number'>2820</span>
<span class='line-number'>2821</span>
<span class='line-number'>2822</span>
<span class='line-number'>2823</span>
<span class='line-number'>2824</span>
<span class='line-number'>2825</span>
<span class='line-number'>2826</span>
<span class='line-number'>2827</span>
<span class='line-number'>2828</span>
<span class='line-number'>2829</span>
<span class='line-number'>2830</span>
<span class='line-number'>2831</span>
<span class='line-number'>2832</span>
<span class='line-number'>2833</span>
<span class='line-number'>2834</span>
<span class='line-number'>2835</span>
<span class='line-number'>2836</span>
<span class='line-number'>2837</span>
<span class='line-number'>2838</span>
<span class='line-number'>2839</span>
<span class='line-number'>2840</span>
<span class='line-number'>2841</span>
<span class='line-number'>2842</span>
<span class='line-number'>2843</span>
<span class='line-number'>2844</span>
<span class='line-number'>2845</span>
<span class='line-number'>2846</span>
<span class='line-number'>2847</span>
<span class='line-number'>2848</span>
<span class='line-number'>2849</span>
<span class='line-number'>2850</span>
<span class='line-number'>2851</span>
<span class='line-number'>2852</span>
<span class='line-number'>2853</span>
<span class='line-number'>2854</span>
<span class='line-number'>2855</span>
<span class='line-number'>2856</span>
<span class='line-number'>2857</span>
<span class='line-number'>2858</span>
<span class='line-number'>2859</span>
<span class='line-number'>2860</span>
<span class='line-number'>2861</span>
<span class='line-number'>2862</span>
<span class='line-number'>2863</span>
<span class='line-number'>2864</span>
<span class='line-number'>2865</span>
<span class='line-number'>2866</span>
<span class='line-number'>2867</span>
<span class='line-number'>2868</span>
<span class='line-number'>2869</span>
<span class='line-number'>2870</span>
<span class='line-number'>2871</span>
<span class='line-number'>2872</span>
<span class='line-number'>2873</span>
<span class='line-number'>2874</span>
<span class='line-number'>2875</span>
<span class='line-number'>2876</span>
<span class='line-number'>2877</span>
<span class='line-number'>2878</span>
<span class='line-number'>2879</span>
<span class='line-number'>2880</span>
<span class='line-number'>2881</span>
<span class='line-number'>2882</span>
<span class='line-number'>2883</span>
<span class='line-number'>2884</span>
<span class='line-number'>2885</span>
<span class='line-number'>2886</span>
<span class='line-number'>2887</span>
<span class='line-number'>2888</span>
<span class='line-number'>2889</span>
<span class='line-number'>2890</span>
<span class='line-number'>2891</span>
<span class='line-number'>2892</span>
<span class='line-number'>2893</span>
<span class='line-number'>2894</span>
<span class='line-number'>2895</span>
<span class='line-number'>2896</span>
<span class='line-number'>2897</span>
<span class='line-number'>2898</span>
<span class='line-number'>2899</span>
<span class='line-number'>2900</span>
<span class='line-number'>2901</span>
<span class='line-number'>2902</span>
<span class='line-number'>2903</span>
<span class='line-number'>2904</span>
<span class='line-number'>2905</span>
<span class='line-number'>2906</span>
<span class='line-number'>2907</span>
<span class='line-number'>2908</span>
<span class='line-number'>2909</span>
<span class='line-number'>2910</span>
<span class='line-number'>2911</span>
<span class='line-number'>2912</span>
<span class='line-number'>2913</span>
<span class='line-number'>2914</span>
<span class='line-number'>2915</span>
<span class='line-number'>2916</span>
<span class='line-number'>2917</span>
<span class='line-number'>2918</span>
<span class='line-number'>2919</span>
<span class='line-number'>2920</span>
<span class='line-number'>2921</span>
<span class='line-number'>2922</span>
<span class='line-number'>2923</span>
<span class='line-number'>2924</span>
<span class='line-number'>2925</span>
<span class='line-number'>2926</span>
<span class='line-number'>2927</span>
<span class='line-number'>2928</span>
<span class='line-number'>2929</span>
<span class='line-number'>2930</span>
<span class='line-number'>2931</span>
<span class='line-number'>2932</span>
<span class='line-number'>2933</span>
<span class='line-number'>2934</span>
<span class='line-number'>2935</span>
<span class='line-number'>2936</span>
<span class='line-number'>2937</span>
<span class='line-number'>2938</span>
<span class='line-number'>2939</span>
<span class='line-number'>2940</span>
<span class='line-number'>2941</span>
<span class='line-number'>2942</span>
<span class='line-number'>2943</span>
<span class='line-number'>2944</span>
<span class='line-number'>2945</span>
<span class='line-number'>2946</span>
<span class='line-number'>2947</span>
<span class='line-number'>2948</span>
<span class='line-number'>2949</span>
<span class='line-number'>2950</span>
<span class='line-number'>2951</span>
<span class='line-number'>2952</span>
<span class='line-number'>2953</span>
<span class='line-number'>2954</span>
<span class='line-number'>2955</span>
<span class='line-number'>2956</span>
<span class='line-number'>2957</span>
<span class='line-number'>2958</span>
<span class='line-number'>2959</span>
<span class='line-number'>2960</span>
<span class='line-number'>2961</span>
<span class='line-number'>2962</span>
<span class='line-number'>2963</span>
<span class='line-number'>2964</span>
<span class='line-number'>2965</span>
<span class='line-number'>2966</span>
<span class='line-number'>2967</span>
<span class='line-number'>2968</span>
<span class='line-number'>2969</span>
<span class='line-number'>2970</span>
<span class='line-number'>2971</span>
<span class='line-number'>2972</span>
<span class='line-number'>2973</span>
<span class='line-number'>2974</span>
<span class='line-number'>2975</span>
<span class='line-number'>2976</span>
<span class='line-number'>2977</span>
<span class='line-number'>2978</span>
<span class='line-number'>2979</span>
<span class='line-number'>2980</span>
<span class='line-number'>2981</span>
<span class='line-number'>2982</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/***********************************************************************</span>
</span><span class='line'><span class="cm"> * connect.c -- Make socket connection using SOCKS4/5 and HTTP tunnel.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Copyright (c) 2000-2006 Shun-ichi Goto</span>
</span><span class='line'><span class="cm"> * Copyright (c) 2002, J. Grant (English Corrections)</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * This program is free software; you can redistribute it and/or</span>
</span><span class='line'><span class="cm"> * modify it under the terms of the GNU General Public License</span>
</span><span class='line'><span class="cm"> * as published by the Free Software Foundation; either version 2</span>
</span><span class='line'><span class="cm"> * of the License, or (at your option) any later version.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
</span><span class='line'><span class="cm"> * GNU General Public License for more details.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="cm"> * along with this program; if not, write to the Free Software</span>
</span><span class='line'><span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * ---------------------------------------------------------</span>
</span><span class='line'><span class="cm"> * PROJECT:  My Test Program</span>
</span><span class='line'><span class="cm"> * AUTHOR:   Shun-ichi GOTO &lt;gotoh@taiyo.co.jp&gt;</span>
</span><span class='line'><span class="cm"> * CREATE:   Wed Jun 21, 2000</span>
</span><span class='line'><span class="cm"> * REVISION: $Revision: 100 $</span>
</span><span class='line'><span class="cm"> * ---------------------------------------------------------</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Getting Source</span>
</span><span class='line'><span class="cm"> * ==============</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   Recent version of &#39;connect.c&#39; is available from</span>
</span><span class='line'><span class="cm"> *     http://www.taiyo.co.jp/~gotoh/ssh/connect.c</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   Related tool, ssh-askpass.exe (alternative ssh-askpass on UNIX)</span>
</span><span class='line'><span class="cm"> *   is available:</span>
</span><span class='line'><span class="cm"> *     http://www.taiyo.co.jp/~gotoh/ssh/ssh-askpass.exe.gz</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   See more detail:</span>
</span><span class='line'><span class="cm"> *     http://www.taiyo.co.jp/~gotoh/ssh/connect.html</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * How To Compile</span>
</span><span class='line'><span class="cm"> * ==============</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *  On UNIX environment:</span>
</span><span class='line'><span class="cm"> *      $ gcc connect.c -o connect</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *  On SOLARIS:</span>
</span><span class='line'><span class="cm"> *      $ gcc -o connect -lresolv -lsocket -lnsl connect.c</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *  on Win32 environment:</span>
</span><span class='line'><span class="cm"> *      $ cl connect.c wsock32.lib advapi32.lib</span>
</span><span class='line'><span class="cm"> *    or</span>
</span><span class='line'><span class="cm"> *      $ bcc32 connect.c wsock32.lib advapi32.lib</span>
</span><span class='line'><span class="cm"> *    or</span>
</span><span class='line'><span class="cm"> *      $ gcc connect.c -o connect</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *  on Mac OS X environment:</span>
</span><span class='line'><span class="cm"> *      $ gcc connect.c -o connect -lresolv</span>
</span><span class='line'><span class="cm"> *    or</span>
</span><span class='line'><span class="cm"> *      $ gcc connect.c -o connect -DBIND_8_COMPAT=1</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * How To Use</span>
</span><span class='line'><span class="cm"> * ==========</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   You can specify proxy method in an environment variable or in a</span>
</span><span class='line'><span class="cm"> *   command line option.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   usage:  connect [-dnhst45] [-R resolve] [-p local-port] [-w sec]</span>
</span><span class='line'><span class="cm"> *                   [-H [user@]proxy-server[:port]]</span>
</span><span class='line'><span class="cm"> *                   [-S [user@]socks-server[:port]]</span>
</span><span class='line'><span class="cm"> *                   [-T proxy-server[:port]]</span>
</span><span class='line'><span class="cm"> *                   [-c telnet proxy command]</span>
</span><span class='line'><span class="cm"> *                   host port</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   &quot;host&quot; and &quot;port&quot; is for the target hostname and port-number to</span>
</span><span class='line'><span class="cm"> *   connect to.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   The -H option specifys a hostname and port number of the http proxy</span>
</span><span class='line'><span class="cm"> *   server to relay. If port is omitted, 80 is used. You can specify this</span>
</span><span class='line'><span class="cm"> *   value in the environment variable HTTP_PROXY and pass the -h option</span>
</span><span class='line'><span class="cm"> *   to use it.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   The -S option specifys the hostname and port number of the SOCKS</span>
</span><span class='line'><span class="cm"> *   server to relay.  Like -H, port number can be omitted and the default</span>
</span><span class='line'><span class="cm"> *   is 1080. You can also specify this value pair in the environment</span>
</span><span class='line'><span class="cm"> *   variable SOCKS5_SERVER and give the -s option to use it.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   The &#39;-4&#39; and the &#39;-5&#39; options are for specifying SOCKS relaying and</span>
</span><span class='line'><span class="cm"> *   indicates protocol version to use. It is valid only when used with</span>
</span><span class='line'><span class="cm"> *   &#39;-s&#39; or &#39;-S&#39;. Default is &#39;-5&#39; (protocol version 5)</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   The &#39;-R&#39; option is for specifying method to resolve the</span>
</span><span class='line'><span class="cm"> *   hostname. Three keywords (&quot;local&quot;, &quot;remote&quot;, &quot;both&quot;) or dot-notation</span>
</span><span class='line'><span class="cm"> *   IP address are acceptable.  The keyword &quot;both&quot; means, &quot;Try local</span>
</span><span class='line'><span class="cm"> *   first, then remote&quot;. If a dot-notation IP address is specified, use</span>
</span><span class='line'><span class="cm"> *   this host as nameserver. The default is &quot;remote&quot; for SOCKS5 or</span>
</span><span class='line'><span class="cm"> *   &quot;local&quot; for others. On SOCKS4 protocol, remote resolving method</span>
</span><span class='line'><span class="cm"> *   (&quot;remote&quot; and &quot;both&quot;) requires protocol 4a supported server.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   The &#39;-p&#39; option will forward a local TCP port instead of using the</span>
</span><span class='line'><span class="cm"> *   standard input and output.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   The &#39;-P&#39; option is same to &#39;-p&#39; except keep remote session. The</span>
</span><span class='line'><span class="cm"> *   program repeats waiting the port with holding remote session without</span>
</span><span class='line'><span class="cm"> *   disconnecting. To disconnect the remote session, send EOF to stdin or</span>
</span><span class='line'><span class="cm"> *   kill the program.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   The &#39;-w&#39; option specifys timeout seconds for making connection with</span>
</span><span class='line'><span class="cm"> *   TARGET host.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   The &#39;-d&#39; option is used for debug. If you fail to connect, use this</span>
</span><span class='line'><span class="cm"> *   and check request to and response from server.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   You can omit the &quot;port&quot; argument when program name is special format</span>
</span><span class='line'><span class="cm"> *   containing port number itself. For example,</span>
</span><span class='line'><span class="cm"> *     $ ln -s connect connect-25</span>
</span><span class='line'><span class="cm"> *   means this connect-25 command is spcifying port number 25 already</span>
</span><span class='line'><span class="cm"> *   so you need not 2nd argument (and ignored if specified).</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   To use proxy, this example is for SOCKS5 connection to connect to</span>
</span><span class='line'><span class="cm"> *   &#39;host&#39; at port 25 via SOCKS5 server on &#39;firewall&#39; host.</span>
</span><span class='line'><span class="cm"> *     $ connect -S firewall  host 25</span>
</span><span class='line'><span class="cm"> *   or</span>
</span><span class='line'><span class="cm"> *     $ SOCKS5_SERVER=firewall; export SOCKS5_SERVER</span>
</span><span class='line'><span class="cm"> *     $ connect -s host 25</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   For a HTTP-PROXY connection:</span>
</span><span class='line'><span class="cm"> *     $ connect -H proxy-server:8080  host 25</span>
</span><span class='line'><span class="cm"> *   or</span>
</span><span class='line'><span class="cm"> *     $ HTTP_PROXY=proxy-server:8080; export HTTP_PROXY</span>
</span><span class='line'><span class="cm"> *     $ connect -h host 25</span>
</span><span class='line'><span class="cm"> *   To forward a local port, for example to use ssh:</span>
</span><span class='line'><span class="cm"> *     $ connect -p 5550 -H proxy-server:8080  host 22</span>
</span><span class='line'><span class="cm"> *    ($ ssh -l user -p 5550 localhost )</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * TIPS</span>
</span><span class='line'><span class="cm"> * ====</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   Connect.c doesn&#39;t have any configuration to specify the SOCKS server.</span>
</span><span class='line'><span class="cm"> *   If you are a mobile user, this limitation might bother you.  However,</span>
</span><span class='line'><span class="cm"> *   You can compile connect.c and link with other standard SOCKS library</span>
</span><span class='line'><span class="cm"> *   like the NEC SOCKS5 library or Dante. This means connect.c is</span>
</span><span class='line'><span class="cm"> *   socksified and uses a configration file like to other SOCKSified</span>
</span><span class='line'><span class="cm"> *   network commands and you can switch configuration file any time</span>
</span><span class='line'><span class="cm"> *   (ex. when ppp startup) that brings you switching of SOCKS server for</span>
</span><span class='line'><span class="cm"> *   connect.c in same way with other commands. For this case, you can</span>
</span><span class='line'><span class="cm"> *   write ~/.ssh/config like this:</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *     ProxyCommand connect -n %h %p</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * SOCKS5 authentication</span>
</span><span class='line'><span class="cm"> * =====================</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   Only USER/PASS authentication is supported.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Proxy authentication</span>
</span><span class='line'><span class="cm"> * ====================</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   Only BASIC scheme is supported.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Authentication informations</span>
</span><span class='line'><span class="cm"> * ===========================</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   User name for authentication is specifed by an environment variable</span>
</span><span class='line'><span class="cm"> *   or system login name.  And password is specified from environment</span>
</span><span class='line'><span class="cm"> *   variable or external program (specified in $SSH_ASKPASS) or tty.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   Following environment variable is used for specifying user name.</span>
</span><span class='line'><span class="cm"> *     SOCKS: $SOCKS5_USER, $LOGNAME, $USER</span>
</span><span class='line'><span class="cm"> *     HTTP Proxy: $HTTP_PROXY_USER, $LOGNAME, $USER</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * ssh-askpass support</span>
</span><span class='line'><span class="cm"> * ===================</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm"> *   You can use ssh-askpass (came from OpenSSH or else) to specify</span>
</span><span class='line'><span class="cm"> *   password on graphical environment (X-Window or MS Windows). To use</span>
</span><span class='line'><span class="cm"> *   this, set program name to environment variable SSH_ASKPASS. On UNIX,</span>
</span><span class='line'><span class="cm"> *   X-Window must be required, so $DISPLAY environment variable is also</span>
</span><span class='line'><span class="cm"> *   needed.  On Win32 environment, $DISPLAY is not mentioned.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Related Informations</span>
</span><span class='line'><span class="cm"> * ====================</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   SOCKS5 -- RFC 1928, RFC 1929, RFC 1961</span>
</span><span class='line'><span class="cm"> *             NEC SOCKS Reference Implementation is available from:</span>
</span><span class='line'><span class="cm"> *               http://www.socks.nec.com</span>
</span><span class='line'><span class="cm"> *             DeleGate version 5 or earlier can be SOCKS4 server,</span>
</span><span class='line'><span class="cm"> *             and version 6 can be SOCKS5 and SOCKS4 server.</span>
</span><span class='line'><span class="cm"> *             and version 7.7.0 or later can be SOCKS5 and SOCKS4a server.</span>
</span><span class='line'><span class="cm"> *               http://www.delegate.org/delegate/</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *   HTTP-Proxy --</span>
</span><span class='line'><span class="cm"> *             Many http proxy servers supports this, but https should</span>
</span><span class='line'><span class="cm"> *             be allowed as configuration on your host.</span>
</span><span class='line'><span class="cm"> *             For example on DeleGate, you should add &quot;https&quot; to the</span>
</span><span class='line'><span class="cm"> *             &quot;REMITTABLE&quot; parameter to allow HTTP-Proxy like this:</span>
</span><span class='line'><span class="cm"> *               delegated -Pxxxx ...... REMITTABLE=&quot;+,https&quot; ...</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *  Hypertext Transfer Protocol -- HTTP/1.1  -- RFC 2616</span>
</span><span class='line'><span class="cm"> *  HTTP Authentication: Basic and Digest Access Authentication -- RFC 2617</span>
</span><span class='line'><span class="cm"> *             For proxy authentication, refer these documents.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> ***********************************************************************/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;ctype.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;memory.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;errno.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;assert.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdarg.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;fcntl.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;signal.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef __CYGWIN32__</span>
</span><span class='line'><span class="cp">#undef _WIN32</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'><span class="cp">#include &lt;windows.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;winsock.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/stat.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;io.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;conio.h&gt;</span>
</span><span class='line'><span class="cp">#else </span><span class="cm">/* !_WIN32 */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;pwd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;termios.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/time.h&gt;</span>
</span><span class='line'><span class="cp">#ifndef __hpux</span>
</span><span class='line'><span class="cp">#include &lt;sys/select.h&gt;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* __hpux */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#include &lt;sys/socket.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;netinet/in.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;arpa/inet.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;netdb.h&gt;</span>
</span><span class='line'><span class="cp">#if !defined(_WIN32) &amp;&amp; !defined(__CYGWIN32__)</span>
</span><span class='line'><span class="cp">#define WITH_RESOLVER 1</span>
</span><span class='line'><span class="cp">#include &lt;arpa/nameser.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;resolv.h&gt;</span>
</span><span class='line'><span class="cp">#else  </span><span class="cm">/* not ( not _WIN32 &amp;&amp; not __CYGWIN32__) */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#undef WITH_RESOLVER</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not ( not _WIN32 &amp;&amp; not __CYGWIN32__) */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* !_WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'><span class="cp">#define ECONNRESET WSAECONNRESET</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* _WI32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef LINT</span>
</span><span class='line'><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vcid</span> <span class="o">=</span> <span class="s">&quot;$Id: connect.c 100 2007-07-03 10:48:26Z gotoh $&quot;</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Microsoft Visual C/C++ has _snprintf() and _vsnprintf() */</span>
</span><span class='line'><span class="cp">#ifdef _MSC_VER</span>
</span><span class='line'><span class="cp">#define snprintf _snprintf</span>
</span><span class='line'><span class="cp">#define vsnprintf _vsnprintf</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* consider Borland C */</span>
</span><span class='line'><span class="cp">#ifdef __BORLANDC__</span>
</span><span class='line'><span class="cp">#define _kbhit kbhit</span>
</span><span class='line'><span class="cp">#define _setmode setmode</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* help message.</span>
</span><span class='line'><span class="cm">   Win32 environment does not support -R option (vc and cygwin)</span>
</span><span class='line'><span class="cm">   Win32 native compilers does not support -w option, yet (vc)</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">usage</span> <span class="o">=</span> <span class="s">&quot;usage: %s [-dnhst45] [-p local-port]&quot;</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'><span class="cp">#ifdef __CYGWIN32__</span>
</span><span class='line'><span class="s">&quot;[-w timeout] </span><span class="se">\n</span><span class="s">&quot;</span>                               <span class="cm">/* cygwin cannot -R */</span>
</span><span class='line'><span class="cp">#else  </span><span class="cm">/* not __CYGWIN32__ */</span><span class="cp"></span>
</span><span class='line'><span class="s">&quot; </span><span class="se">\n</span><span class="s">&quot;</span>                                           <span class="cm">/* VC cannot -w nor -R  */</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not __CYGWIN32__ */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#else  </span><span class="cm">/* not _WIN32 */</span><span class="cp"></span>
</span><span class='line'><span class="cm">/* help message for UNIX */</span>
</span><span class='line'><span class="s">&quot;[-R resolve] [-w timeout] </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not _WIN32 */</span><span class="cp"></span>
</span><span class='line'><span class="s">&quot;          [-H proxy-server[:port]] [-S [user@]socks-server[:port]] </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;          [-T proxy-server[:port]]</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;          [-c telnet-proxy-command]</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;          host port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* name of this program */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">progname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">progdesc</span> <span class="o">=</span> <span class="s">&quot;connect --- simple relaying command via proxy.&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">rcs_revstr</span> <span class="o">=</span> <span class="s">&quot;$Revision: 100 $&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">revstr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">major_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">minor_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* set of character for strspn() */</span>
</span><span class='line'><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">digits</span>    <span class="o">=</span> <span class="s">&quot;0123456789&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dotdigits</span> <span class="o">=</span> <span class="s">&quot;0123456789.&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* options */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">f_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* report flag to hide secure information */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">f_report</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">connect_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* local input type */</span>
</span><span class='line'><span class="cp">#define LOCAL_STDIO     0</span>
</span><span class='line'><span class="cp">#define LOCAL_SOCKET    1</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">local_type_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;stdio&quot;</span><span class="p">,</span> <span class="s">&quot;socket&quot;</span> <span class="p">};</span>
</span><span class='line'><span class="kt">int</span>   <span class="n">local_type</span> <span class="o">=</span> <span class="n">LOCAL_STDIO</span><span class="p">;</span>
</span><span class='line'><span class="n">u_short</span> <span class="n">local_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                         <span class="cm">/* option &#39;p&#39; */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">f_hold_session</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                         <span class="cm">/* option &#39;P&#39; */</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">telnet_command</span> <span class="o">=</span> <span class="s">&quot;telnet %h %p&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* utiity types, pair holder of number and string */</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">LOOKUP_ITEM</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* relay method, server and port */</span>
</span><span class='line'><span class="cp">#define METHOD_UNDECIDED 0</span>
</span><span class='line'><span class="cp">#define METHOD_DIRECT    1</span>
</span><span class='line'><span class="cp">#define METHOD_SOCKS     2</span>
</span><span class='line'><span class="cp">#define METHOD_HTTP      3</span>
</span><span class='line'><span class="cp">#define METHOD_TELNET    4</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">method_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;UNDECIDED&quot;</span><span class="p">,</span> <span class="s">&quot;DIRECT&quot;</span><span class="p">,</span> <span class="s">&quot;SOCKS&quot;</span><span class="p">,</span> <span class="s">&quot;HTTP&quot;</span><span class="p">,</span> <span class="s">&quot;TELNET&quot;</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>   <span class="n">relay_method</span> <span class="o">=</span> <span class="n">METHOD_UNDECIDED</span><span class="p">;</span>          <span class="cm">/* relaying method */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">relay_host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>                        <span class="cm">/* hostname of relay server */</span>
</span><span class='line'><span class="n">u_short</span> <span class="n">relay_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                         <span class="cm">/* port of relay server */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">relay_user</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>                        <span class="cm">/* user name for auth */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* destination target host and port */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">dest_host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">dest_addr</span><span class="p">;</span>
</span><span class='line'><span class="n">u_short</span> <span class="n">dest_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* informations for SOCKS */</span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_SUCCEEDED    0x00    </span><span class="cm">/* succeeded */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_FAIL         0x01    </span><span class="cm">/* general SOCKS serer failure */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_NALLOWED     0x02    </span><span class="cm">/* connection not allowed by ruleset */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_NUNREACH     0x03    </span><span class="cm">/* Network unreachable */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_HUNREACH     0x04    </span><span class="cm">/* Host unreachable */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_REFUSED      0x05    </span><span class="cm">/* connection refused */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_EXPIRED      0x06    </span><span class="cm">/* TTL expired */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_CNOTSUP      0x07    </span><span class="cm">/* Command not supported */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_ANOTSUP      0x08    </span><span class="cm">/* Address not supported */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_REP_INVADDR      0x09    </span><span class="cm">/* Inalid address */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="n">LOOKUP_ITEM</span> <span class="n">socks5_rep_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_SUCCEEDED</span><span class="p">,</span> <span class="s">&quot;succeeded&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_FAIL</span><span class="p">,</span>      <span class="s">&quot;general SOCKS server failure&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_NALLOWED</span><span class="p">,</span>  <span class="s">&quot;connection not allowed by ruleset&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_NUNREACH</span><span class="p">,</span>  <span class="s">&quot;Network unreachable&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_HUNREACH</span><span class="p">,</span>  <span class="s">&quot;Host unreachable&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_REFUSED</span><span class="p">,</span>   <span class="s">&quot;connection refused&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_EXPIRED</span><span class="p">,</span>   <span class="s">&quot;TTL expired&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_CNOTSUP</span><span class="p">,</span>   <span class="s">&quot;Command not supported&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_ANOTSUP</span><span class="p">,</span>   <span class="s">&quot;Address not supported&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS5_REP_INVADDR</span><span class="p">,</span>   <span class="s">&quot;Invalid address&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* SOCKS5 authentication methods */</span>
</span><span class='line'><span class="cp">#define SOCKS5_AUTH_REJECT      0xFF    </span><span class="cm">/* No acceptable auth method */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_AUTH_NOAUTH      0x00    </span><span class="cm">/* without authentication */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_AUTH_GSSAPI      0x01    </span><span class="cm">/* GSSAPI */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_AUTH_USERPASS    0x02    </span><span class="cm">/* User/Password */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_AUTH_CHAP        0x03    </span><span class="cm">/* Challenge-Handshake Auth Proto. */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_AUTH_EAP         0x05    </span><span class="cm">/* Extensible Authentication Proto. */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS5_AUTH_MAF         0x08    </span><span class="cm">/* Multi-Authentication Framework */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define SOCKS4_REP_SUCCEEDED    90      </span><span class="cm">/* rquest granted (succeeded) */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS4_REP_REJECTED     91      </span><span class="cm">/* request rejected or failed */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS4_REP_IDENT_FAIL   92      </span><span class="cm">/* cannot connect identd */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define SOCKS4_REP_USERID       93      </span><span class="cm">/* user id not matched */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="n">LOOKUP_ITEM</span> <span class="n">socks4_rep_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS4_REP_SUCCEEDED</span><span class="p">,</span>  <span class="s">&quot;request granted (succeeded)&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS4_REP_REJECTED</span><span class="p">,</span>   <span class="s">&quot;request rejected or failed&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS4_REP_IDENT_FAIL</span><span class="p">,</span> <span class="s">&quot;cannot connect identd&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">SOCKS4_REP_USERID</span><span class="p">,</span>     <span class="s">&quot;user id not matched&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define RESOLVE_UNKNOWN 0</span>
</span><span class='line'><span class="cp">#define RESOLVE_LOCAL   1</span>
</span><span class='line'><span class="cp">#define RESOLVE_REMOTE  2</span>
</span><span class='line'><span class="cp">#define RESOLVE_BOTH    3</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">resolve_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">,</span> <span class="s">&quot;LOCAL&quot;</span><span class="p">,</span> <span class="s">&quot;REMOTE&quot;</span><span class="p">,</span> <span class="s">&quot;BOTH&quot;</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">socks_version</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>                          <span class="cm">/* SOCKS protocol version */</span>
</span><span class='line'><span class="kt">int</span> <span class="n">socks_resolve</span> <span class="o">=</span> <span class="n">RESOLVE_UNKNOWN</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">socks_ns</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">socks5_auth</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Environment variable names */</span>
</span><span class='line'><span class="cp">#define ENV_SOCKS_SERVER  &quot;SOCKS_SERVER&quot;        </span><span class="cm">/* SOCKS server */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_SOCKS5_SERVER &quot;SOCKS5_SERVER&quot;</span>
</span><span class='line'><span class="cp">#define ENV_SOCKS4_SERVER &quot;SOCKS4_SERVER&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define ENV_SOCKS_RESOLVE  &quot;SOCKS_RESOLVE&quot;      </span><span class="cm">/* resolve method */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_SOCKS5_RESOLVE &quot;SOCKS5_RESOLVE&quot;</span>
</span><span class='line'><span class="cp">#define ENV_SOCKS4_RESOLVE &quot;SOCKS4_RESOLVE&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define ENV_SOCKS5_USER     &quot;SOCKS5_USER&quot;       </span><span class="cm">/* auth user for SOCKS5 */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_SOCKS4_USER     &quot;SOCKS4_USER&quot;       </span><span class="cm">/* auth user for SOCKS4 */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_SOCKS_USER      &quot;SOCKS_USER&quot;        </span><span class="cm">/* auth user for SOCKS */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_SOCKS5_PASSWD   &quot;SOCKS5_PASSWD&quot;     </span><span class="cm">/* auth password for SOCKS5 */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_SOCKS5_PASSWORD &quot;SOCKS5_PASSWORD&quot;   </span><span class="cm">/* old style */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define ENV_HTTP_PROXY          &quot;HTTP_PROXY&quot;    </span><span class="cm">/* common env var */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_HTTP_PROXY_USER     &quot;HTTP_PROXY_USER&quot; </span><span class="cm">/* auth user */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_HTTP_PROXY_PASSWORD &quot;HTTP_PROXY_PASSWORD&quot; </span><span class="cm">/* auth password */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define ENV_TELNET_PROXY          &quot;TELNET_PROXY&quot;    </span><span class="cm">/* common env var */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define ENV_CONNECT_USER     &quot;CONNECT_USER&quot;     </span><span class="cm">/* default auth user name */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_CONNECT_PASSWORD &quot;CONNECT_PASSWORD&quot; </span><span class="cm">/* default auth password */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define ENV_SOCKS_DIRECT   &quot;SOCKS_DIRECT&quot;       </span><span class="cm">/* addr-list for non-proxy */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define ENV_SOCKS5_DIRECT  &quot;SOCKS5_DIRECT&quot;</span>
</span><span class='line'><span class="cp">#define ENV_SOCKS4_DIRECT  &quot;SOCKS4_DIRECT&quot;</span>
</span><span class='line'><span class="cp">#define ENV_HTTP_DIRECT    &quot;HTTP_DIRECT&quot;</span>
</span><span class='line'><span class="cp">#define ENV_CONNECT_DIRECT &quot;CONNECT_DIRECT&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define ENV_SOCKS5_AUTH &quot;SOCKS5_AUTH&quot;</span>
</span><span class='line'><span class="cp">#define ENV_SSH_ASKPASS &quot;SSH_ASKPASS&quot;           </span><span class="cm">/* askpass program */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Prefix string of HTTP_PROXY */</span>
</span><span class='line'><span class="cp">#define HTTP_PROXY_PREFIX &quot;http:</span><span class="c1">//&quot;</span>
</span><span class='line'><span class="cp">#define PROXY_AUTH_NONE 0</span>
</span><span class='line'><span class="cp">#define PROXY_AUTH_BASIC 1</span>
</span><span class='line'><span class="cp">#define PROXY_AUTH_DIGEST 2</span>
</span><span class='line'><span class="kt">int</span> <span class="n">proxy_auth_type</span> <span class="o">=</span> <span class="n">PROXY_AUTH_NONE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* reason of end repeating */</span>
</span><span class='line'><span class="cp">#define REASON_UNK              -2</span>
</span><span class='line'><span class="cp">#define REASON_ERROR            -1</span>
</span><span class='line'><span class="cp">#define REASON_CLOSED_BY_LOCAL  0</span>
</span><span class='line'><span class="cp">#define REASON_CLOSED_BY_REMOTE 1</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* return value of relay start function. */</span>
</span><span class='line'><span class="cp">#define START_ERROR -1</span>
</span><span class='line'><span class="cp">#define START_OK     0</span>
</span><span class='line'><span class="cp">#define START_RETRY  1</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* socket related definitions */</span>
</span><span class='line'><span class="cp">#ifndef _WIN32</span>
</span><span class='line'><span class="cp">#define SOCKET int</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#ifndef SOCKET_ERROR</span>
</span><span class='line'><span class="cp">#define SOCKET_ERROR -1</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'><span class="cp">#define socket_errno() WSAGetLastError()</span>
</span><span class='line'><span class="cp">#else </span><span class="cm">/* !_WIN32 */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define closesocket close</span>
</span><span class='line'><span class="cp">#define socket_errno() (errno)</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* !_WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'><span class="cp">#define popen _popen</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* packet operation macro */</span>
</span><span class='line'><span class="cp">#define PUT_BYTE(ptr,data) (*(unsigned char*)ptr = data)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* debug message output */</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">debug</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">f_debug</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">fmt</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;DEBUG: &quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">vfprintf</span><span class="p">(</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">va_end</span><span class="p">(</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">debug_</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...</span> <span class="p">)</span>                  <span class="cm">/* without prefix */</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">f_debug</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">fmt</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">vfprintf</span><span class="p">(</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">va_end</span><span class="p">(</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* error message output */</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">error</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">fmt</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;ERROR: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vfprintf</span><span class="p">(</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">va_end</span><span class="p">(</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">fatal</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">fmt</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;FATAL: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vfprintf</span><span class="p">(</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">va_end</span><span class="p">(</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="o">*</span>
</span><span class='line'><span class="nf">xmalloc</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>  <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Cannot allocate memory: %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">downcase</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="o">*</span><span class="n">buf</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">isupper</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>            <span class="o">*</span><span class="n">buf</span> <span class="o">+=</span> <span class="sc">&#39;a&#39;</span><span class="o">-</span><span class="sc">&#39;A&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">buf</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">str</span><span class="p">;</span>                                 <span class="cm">/* return converted arg */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">expand_host_and_port</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
</span><span class='line'>    <span class="n">buf</span> <span class="o">=</span> <span class="n">xmalloc</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="n">src</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">switch</span> <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
</span><span class='line'>      <span class="n">strcpy</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
</span><span class='line'>      <span class="n">src</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="sc">&#39;p&#39;</span><span class="o">:</span>
</span><span class='line'>      <span class="n">snprintf</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span><span class='line'>      <span class="n">src</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">default</span><span class="o">:</span>
</span><span class='line'>      <span class="n">src</span> <span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">switch</span> <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="sc">&#39;r&#39;</span><span class="o">:</span>             <span class="cm">/* CR */</span>
</span><span class='line'>      <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\r&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">src</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>             <span class="cm">/* LF */</span>
</span><span class='line'>      <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">src</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>             <span class="cm">/* TAB */</span>
</span><span class='line'>      <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\t&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">src</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">default</span><span class="o">:</span>
</span><span class='line'>      <span class="n">src</span> <span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/* usual */</span>
</span><span class='line'>      <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">lookup_resolve</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span> <span class="n">str</span> <span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">downcase</span><span class="p">(</span> <span class="n">buf</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&quot;both&quot;</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">RESOLVE_BOTH</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&quot;remote&quot;</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">RESOLVE_REMOTE</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&quot;local&quot;</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">RESOLVE_LOCAL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">strspn</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dotdigits</span><span class="p">)</span> <span class="o">==</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#ifndef WITH_RESOLVER</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Sorry, you can&#39;t specify to resolve the hostname with the -R option on Win32 environment.&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not WITH_RESOLVER */</span><span class="cp"></span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">RESOLVE_LOCAL</span><span class="p">;</span>                    <span class="cm">/* this case is also &#39;local&#39; */</span>
</span><span class='line'>        <span class="n">socks_ns</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>        <span class="n">socks_ns</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">RESOLVE_UNKNOWN</span><span class="p">;</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">getusername</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>    <span class="n">DWORD</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">GetUserName</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'><span class="cp">#else  </span><span class="cm">/* not _WIN32 */</span><span class="cp"></span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">passwd</span> <span class="o">*</span><span class="n">pw</span> <span class="o">=</span> <span class="n">getpwuid</span><span class="p">(</span><span class="n">getuid</span><span class="p">());</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">pw</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;getpwuid() failed for uid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">getuid</span><span class="p">());</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_name</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not _WIN32 */</span><span class="cp"></span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* expect</span>
</span><span class='line'><span class="cm">   check STR is begin with substr with case-ignored comparison.</span>
</span><span class='line'><span class="cm">   Return 1 if matched, otherwise 0.</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">expect</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">substr</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">substr</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">--</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="o">!=</span> <span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">substr</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                           <span class="cm">/* not matched */</span>
</span><span class='line'>        <span class="n">str</span><span class="o">++</span><span class="p">,</span> <span class="n">substr</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>                   <span class="cm">/* good, matched */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/** PARAMETER operation **/</span>
</span><span class='line'><span class="cp">#define PARAMETER_FILE &quot;/etc/connectrc&quot;</span>
</span><span class='line'><span class="cp">#define PARAMETER_DOTFILE &quot;.connectrc&quot;</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">PARAMETER_ITEM</span><span class="p">;</span>
</span><span class='line'><span class="n">PARAMETER_ITEM</span> <span class="n">parameter_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS_SERVER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS5_SERVER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS4_SERVER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS_RESOLVE</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS5_RESOLVE</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS4_RESOLVE</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS5_USER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS5_PASSWD</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS5_PASSWORD</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_HTTP_PROXY</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_HTTP_PROXY_USER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_HTTP_PROXY_PASSWORD</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_CONNECT_USER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_CONNECT_PASSWORD</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SSH_ASKPASS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS5_DIRECT</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS4_DIRECT</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS_DIRECT</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_HTTP_DIRECT</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_CONNECT_DIRECT</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">ENV_SOCKS5_AUTH</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">PARAMETER_ITEM</span><span class="o">*</span>
</span><span class='line'><span class="nf">find_parameter_item</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">parameter_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">){</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parameter_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">&amp;</span><span class="n">parameter_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">read_parameter_file_1</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">FILE</span><span class="o">*</span> <span class="n">f</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">line</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">lbuf</span><span class="p">[</span><span class="mi">1025</span><span class="p">];</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="n">f</span> <span class="p">){</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Reading parameter file(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">fgets</span><span class="p">(</span><span class="n">lbuf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span> <span class="n">line</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'>            <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">lbuf</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>                <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;%s:%d: buffer overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
</span><span class='line'>            <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">lbuf</span><span class="p">,</span> <span class="sc">&#39;#&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">p</span> <span class="p">)</span>
</span><span class='line'>                <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span> <span class="n">p</span> <span class="o">=</span> <span class="n">lbuf</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span> <span class="p">)</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;\t&#39;</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>            <span class="n">param</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>            <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">error</span><span class="p">(</span><span class="s">&quot;%s:%d: missing equal sign</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
</span><span class='line'>                <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span> <span class="n">q</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="n">lbuf</span><span class="p">;</span> <span class="n">q</span><span class="o">--</span> <span class="p">)</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">q</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">q</span> <span class="o">!=</span> <span class="sc">&#39;\t&#39;</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="o">*++</span><span class="n">q</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span> <span class="o">++</span><span class="n">p</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span> <span class="p">)</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;\t&#39;</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="n">value</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span> <span class="p">);</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span> <span class="n">p</span><span class="o">--</span><span class="p">;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="n">lbuf</span><span class="p">;</span> <span class="n">p</span><span class="o">--</span> <span class="p">)</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;\t&#39;</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="o">*++</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">param</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">PARAMETER_ITEM</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
</span><span class='line'>                <span class="n">item</span> <span class="o">=</span> <span class="n">find_parameter_item</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="n">item</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">error</span><span class="p">(</span><span class="s">&quot;%s:%d: unknown parameter `%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
</span><span class='line'>                    <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">item</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>                <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Parameter `%s&#39; is set to `%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">read_parameter_file</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="cp">#if !defined(_WIN32) || defined(cygwin)</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">passwd</span> <span class="o">*</span><span class="n">pw</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">read_parameter_file_1</span><span class="p">(</span><span class="n">PARAMETER_FILE</span><span class="p">);</span>
</span><span class='line'><span class="cp">#if !defined(_WIN32) || defined(cygwin)</span>
</span><span class='line'>    <span class="n">pw</span> <span class="o">=</span> <span class="n">getpwuid</span><span class="p">(</span><span class="n">getuid</span><span class="p">());</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">pw</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;getpwuid() failed for uid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">getuid</span><span class="p">());</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_dir</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">PARAMETER_DOTFILE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_dir</span><span class="p">);</span>
</span><span class='line'>    <span class="n">strcat</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;/&quot;</span> <span class="n">PARAMETER_DOTFILE</span><span class="p">);</span>
</span><span class='line'>    <span class="n">read_parameter_file_1</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* _WIN32 */</span><span class="cp"></span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span><span class="o">*</span>
</span><span class='line'><span class="nf">getparam</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">value</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">){</span>
</span><span class='line'>        <span class="n">PARAMETER_ITEM</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">find_parameter_item</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">item</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/** DIRECT connection **/</span>
</span><span class='line'><span class="cp">#define MAX_DIRECT_ADDR_LIST 256</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">ADDRPAIR</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">mask</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">negative</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">ADDRPAIR</span> <span class="n">direct_addr_list</span><span class="p">[</span><span class="n">MAX_DIRECT_ADDR_LIST</span><span class="p">];</span>
</span><span class='line'><span class="kt">int</span> <span class="n">n_direct_addr_list</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">mask_addr</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>    <span class="n">m</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">addrlen</span><span class="o">--</span> <span class="p">)</span>
</span><span class='line'>        <span class="o">*</span><span class="n">a</span><span class="o">++</span> <span class="o">&amp;=</span> <span class="o">*</span><span class="n">m</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">add_direct_addr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">negative</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">iaddr</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">MAX_DIRECT_ADDR_LIST</span> <span class="o">&lt;=</span> <span class="n">n_direct_addr_list</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;direct address table is full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">iaddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span><span class='line'>    <span class="n">mask_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iaddr</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iaddr</span><span class="p">));</span>
</span><span class='line'>    <span class="n">s</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">iaddr</span><span class="p">));</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;adding direct addr entry: %s%s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">negative</span><span class="o">?</span> <span class="s">&quot;!&quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">));</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>    <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">direct_addr_list</span><span class="p">[</span><span class="n">n_direct_addr_list</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
</span><span class='line'>            <span class="o">&amp;</span><span class="n">iaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iaddr</span><span class="p">));</span>
</span><span class='line'>    <span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">direct_addr_list</span><span class="p">[</span><span class="n">n_direct_addr_list</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span>
</span><span class='line'>            <span class="n">mask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">));</span>
</span><span class='line'>    <span class="n">direct_addr_list</span><span class="p">[</span><span class="n">n_direct_addr_list</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">direct_addr_list</span><span class="p">[</span><span class="n">n_direct_addr_list</span><span class="p">].</span><span class="n">negative</span> <span class="o">=</span> <span class="n">negative</span><span class="p">;</span>
</span><span class='line'>    <span class="n">n_direct_addr_list</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/* add domain/host name entry to direct name table */</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">add_direct_host</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">negative</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">MAX_DIRECT_ADDR_LIST</span> <span class="o">&lt;=</span> <span class="n">n_direct_addr_list</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;direct address table is full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">name</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">name</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;adding direct name entry: %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">negative</span><span class="o">?</span> <span class="s">&quot;!&quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="n">direct_addr_list</span><span class="p">[</span><span class="n">n_direct_addr_list</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">downcase</span><span class="p">(</span><span class="n">strdup</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
</span><span class='line'>    <span class="n">direct_addr_list</span><span class="p">[</span><span class="n">n_direct_addr_list</span><span class="p">].</span><span class="n">negative</span> <span class="o">=</span> <span class="n">negative</span><span class="p">;</span>
</span><span class='line'>    <span class="n">n_direct_addr_list</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">parse_addr_pair</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* NOTE: */</span>
</span><span class='line'>    <span class="cm">/* Assume already be splitted by separator</span>
</span><span class='line'><span class="cm">       and formatted as folowing:</span>
</span><span class='line'><span class="cm">       1)  12.34.56.789/255.255.255.0</span>
</span><span class='line'><span class="cm">       2)  12.34.56.789/24</span>
</span><span class='line'><span class="cm">       3)  12.34.56.</span>
</span><span class='line'><span class="cm">       All above generates same addr/mask pair 12.34.56.0 and 255.255.255.0</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>    <span class="n">u_char</span> <span class="o">*</span><span class="n">dsta</span><span class="p">,</span> <span class="o">*</span><span class="n">dstm</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span> <span class="n">str</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">addr</span><span class="o">-&gt;</span><span class="n">s_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">mask</span><span class="o">-&gt;</span><span class="n">s_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dsta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">s_addr</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dstm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">s_addr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>              <span class="cm">/* case of format #3 */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>          <span class="cm">/* format error: */</span>
</span><span class='line'>        <span class="o">*</span><span class="n">dsta</span><span class="o">++</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span> <span class="n">ptr</span> <span class="p">);</span>
</span><span class='line'>        <span class="o">*</span><span class="n">dstm</span><span class="o">++</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>          <span class="cm">/* automatic mask for format #3 */</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span> <span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">)</span> <span class="cm">/* skip digits */</span>
</span><span class='line'>            <span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/* At this point, *ptr points &#39;/&#39; or EOS (&#39;\0&#39;) */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                       <span class="cm">/* complete as format #3 */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                      <span class="cm">/* format error */</span>
</span><span class='line'>    <span class="cm">/* Now parse mask for format #1 or #2 */</span>
</span><span class='line'>    <span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="n">mask</span><span class="o">-&gt;</span><span class="n">s_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="cm">/* clear automatic mask */</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">strchr</span><span class="p">(</span> <span class="n">ptr</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* case of format #1 */</span>
</span><span class='line'>        <span class="n">dstm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">s_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>              <span class="cm">/* format error: */</span>
</span><span class='line'>            <span class="o">*</span><span class="n">dstm</span><span class="o">++</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>            <span class="k">while</span> <span class="p">(</span> <span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">)</span>     <span class="cm">/* skip digits */</span>
</span><span class='line'>                <span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span> <span class="p">)</span>
</span><span class='line'>                <span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>                  <span class="cm">/* from for loop */</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="cm">/* complete as format #1 */</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* case of format #2 */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                  <span class="cm">/* format error: */</span>
</span><span class='line'>        <span class="n">n</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">n</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="mi">32</span><span class="o">&lt;</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                  <span class="cm">/* format error */</span>
</span><span class='line'>        <span class="n">mask</span><span class="o">-&gt;</span><span class="n">s_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span><span class="o">:</span> <span class="n">htonl</span><span class="p">(((</span><span class="n">u_long</span><span class="p">)</span><span class="mh">0xFFFFFFFF</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="n">n</span><span class="p">));</span>
</span><span class='line'>        <span class="cm">/* complete as format #1 */</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">initialize_direct_addr</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">negative</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">n_entries</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">env</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">beg</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">envkey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_SOCKS</span> <span class="p">){</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">socks_version</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">envkey</span> <span class="o">=</span> <span class="n">ENV_SOCKS5_DIRECT</span><span class="p">;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">envkey</span> <span class="o">=</span> <span class="n">ENV_SOCKS4_DIRECT</span><span class="p">;</span>
</span><span class='line'>        <span class="n">env</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">envkey</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">env</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">env</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS_DIRECT</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_HTTP</span> <span class="p">){</span>
</span><span class='line'>        <span class="n">env</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_HTTP_DIRECT</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">env</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">env</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_CONNECT_DIRECT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">env</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>                 <span class="cm">/* no entry */</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;making direct addr list from: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>
</span><span class='line'>    <span class="n">env</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span> <span class="n">env</span> <span class="p">);</span>        <span class="cm">/* reallocate to modify */</span>
</span><span class='line'>    <span class="n">beg</span> <span class="o">=</span> <span class="n">next</span> <span class="o">=</span> <span class="n">env</span><span class="p">;</span>
</span><span class='line'>    <span class="n">n_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">MAX_DIRECT_ADDR_LIST</span> <span class="o">&lt;=</span> <span class="n">n_entries</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">error</span><span class="p">(</span><span class="s">&quot;too many entries in %s&quot;</span><span class="p">,</span> <span class="n">envkey</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>              <span class="cm">/* from do loop */</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">next</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span> <span class="n">beg</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="o">*</span><span class="n">next</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">mask</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">beg</span> <span class="o">==</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">negative</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="n">beg</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>            <span class="n">negative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">parse_addr_pair</span><span class="p">(</span> <span class="n">beg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">add_direct_addr</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">negative</span> <span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">add_direct_host</span><span class="p">(</span> <span class="n">beg</span><span class="p">,</span> <span class="n">negative</span> <span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">beg</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span> <span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span> <span class="n">env</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">cmp_addr</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr1</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">,</span> <span class="n">addrlen</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">is_direct_address</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">addr</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">neg</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">iaddr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Note: assume IPV4 address !! */</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n_direct_addr_list</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">direct_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>                           <span class="cm">/* it&#39;s name entry */</span>
</span><span class='line'>        <span class="n">neg</span> <span class="o">=</span> <span class="n">direct_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">negative</span><span class="p">;</span>
</span><span class='line'>        <span class="n">iaddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>        <span class="n">mask_addr</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">iaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">direct_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span>
</span><span class='line'>                   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">));</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">cmp_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">direct_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
</span><span class='line'>                     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
</span><span class='line'>            <span class="n">a</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">direct_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">));</span>
</span><span class='line'>            <span class="n">m</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">direct_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">));</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;match with: %s/%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">neg</span><span class="o">?</span> <span class="s">&quot; (negative)&quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>            <span class="n">free</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">!</span><span class="n">neg</span><span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;not matched, addr to be relayed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                   <span class="cm">/* not direct */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/* check s1 is ends with s2.</span>
</span><span class='line'><span class="cm">   return 1 if exact match or domain part match.</span>
</span><span class='line'><span class="cm">   return 0 if s1 is shorter than s2 or partial match.</span>
</span><span class='line'><span class="cm">   For example, </span>
</span><span class='line'><span class="cm">    ends_with(&quot;bar.com&quot;, &quot;bar.com&quot;)        =&gt; 1 (exact match)</span>
</span><span class='line'><span class="cm">    ends_with(&quot;foo.bar.com&quot;, &quot;bar.com&quot;)    =&gt; 1 (domain match)</span>
</span><span class='line'><span class="cm">    ends_with(&quot;foo.beebar.com&quot;, &quot;bar.com&quot;) =&gt; 0 (partial match)</span>
</span><span class='line'><span class="cm">    ends_with(&quot;bar&quot;, &quot;bar.com&quot;)            =&gt; 0 (shorter)</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="n">domain_match</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s2</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">len1</span><span class="p">,</span> <span class="n">len2</span><span class="p">;</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tail1</span><span class="p">,</span> <span class="o">*</span><span class="n">tail2</span><span class="p">;</span>
</span><span class='line'>    <span class="n">len1</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">len2</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s2</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">len1</span> <span class="o">&lt;</span> <span class="n">len2</span> <span class="o">||</span> <span class="n">len1</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">len2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                               <span class="cm">/* not match */</span>
</span><span class='line'>    <span class="n">tail1</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">len1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">tail2</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">+</span> <span class="n">len2</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">len1</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">len2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">*--</span><span class="n">tail1</span> <span class="o">!=</span> <span class="o">*--</span><span class="n">tail2</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>                              <span class="cm">/* not match */</span>
</span><span class='line'>        <span class="n">len1</span><span class="o">--</span><span class="p">,</span> <span class="n">len2</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">len2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                               <span class="cm">/* not match */</span>
</span><span class='line'>    <span class="cm">/* Now exact match, domain match or partial match.</span>
</span><span class='line'><span class="cm">       Return true if exact or domain match.</span>
</span><span class='line'><span class="cm">       Or continue checking. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">tail1</span> <span class="o">==</span> <span class="n">s1</span> <span class="o">||</span> <span class="n">tail1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>                               <span class="cm">/* match! */</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                                   <span class="cm">/* not match */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Check given NAME is ends with one of </span>
</span><span class='line'><span class="cm">   registered direct name entry.</span>
</span><span class='line'><span class="cm">   Return 1 if matched, or 0.</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="n">is_direct_name</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;checking %s is for direct?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=</span> <span class="n">downcase</span><span class="p">(</span><span class="n">strdup</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
</span><span class='line'>    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                               <span class="cm">/* false */</span>
</span><span class='line'>    <span class="n">tail</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n_direct_addr_list</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">neg</span><span class="p">;</span>
</span><span class='line'>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dname</span><span class="p">;</span>
</span><span class='line'>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
</span><span class='line'>        <span class="n">dname</span> <span class="o">=</span> <span class="n">direct_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">dname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>                           <span class="cm">/* it&#39;s addr/mask entry */</span>
</span><span class='line'>        <span class="n">neg</span> <span class="o">=</span> <span class="n">direct_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">negative</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">domain_match</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dname</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;match with: %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dname</span><span class="p">,</span> <span class="n">neg</span><span class="o">?</span> <span class="s">&quot; (negative)&quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">neg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>       <span class="cm">/* not direct */</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>       <span class="cm">/* direct*/</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                                   <span class="cm">/* not matched */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* check to connect to HOST directyly?</span>
</span><span class='line'><span class="cm">   return 1 if to be direct, 0 for else. */</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="n">check_direct</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>    <span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span> <span class="n">INADDR_NONE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* case of IP address */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">is_direct_address</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s is for direct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>                           <span class="cm">/* true */</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* case of hostname */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">is_direct_name</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s is for direct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>                           <span class="cm">/* true */</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s is for not direct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                                    <span class="cm">/* false */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/** TTY operation **/</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">intr_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef _WIN32</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">intr_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">tty_change_echo</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">struct</span> <span class="n">termios</span> <span class="n">ntio</span><span class="p">,</span> <span class="n">otio</span><span class="p">;</span>           <span class="cm">/* new/old termios */</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">sigset_t</span> <span class="n">nset</span><span class="p">,</span> <span class="n">oset</span><span class="p">;</span>                 <span class="cm">/* new/old sigset */</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">nsa</span><span class="p">,</span> <span class="n">osa</span><span class="p">;</span>           <span class="cm">/* new/old sigaction */</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">int</span> <span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">disabled</span> <span class="o">&amp;&amp;</span> <span class="n">enable</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* enable echo */</span>
</span><span class='line'>        <span class="n">tcsetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">otio</span><span class="p">);</span>
</span><span class='line'>        <span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="cm">/* resotore sigaction */</span>
</span><span class='line'>        <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osa</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">intr_flag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/* re-generate signal  */</span>
</span><span class='line'>            <span class="n">kill</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">SIGINT</span><span class="p">);</span>
</span><span class='line'>            <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nset</span><span class="p">);</span>
</span><span class='line'>            <span class="n">sigsuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nset</span><span class="p">);</span>
</span><span class='line'>            <span class="n">intr_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* set SIGINTR handler and break syscall on singal */</span>
</span><span class='line'>        <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nset</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nset</span><span class="p">,</span> <span class="n">SIGTSTP</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oset</span><span class="p">);</span>
</span><span class='line'>        <span class="n">intr_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nsa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nsa</span><span class="p">));</span>
</span><span class='line'>        <span class="n">nsa</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">intr_handler</span><span class="p">;</span>
</span><span class='line'>        <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nsa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osa</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/* disable echo */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">otio</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">otio</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">ECHO</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ntio</span> <span class="o">=</span> <span class="n">otio</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ntio</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">ECHOE</span> <span class="o">|</span> <span class="n">ECHOK</span> <span class="o">|</span> <span class="n">ECHONL</span><span class="p">);</span>
</span><span class='line'>            <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">tcsetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ntio</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define TTY_NAME &quot;/dev/tty&quot;</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">tty_readpass</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">tty</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">tty</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TTY_NAME</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">tty</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;Unable to open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TTY_NAME</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                              <span class="cm">/* can&#39;t open tty */</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                              <span class="cm">/* no room */</span>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">prompt</span><span class="p">));</span>
</span><span class='line'>    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">tty_change_echo</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                    <span class="cm">/* disable echo */</span>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">tty_change_echo</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>                    <span class="cm">/* restore */</span>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>                        <span class="cm">/* new line */</span>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span>  <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">ret</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">buf</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#else  </span><span class="cm">/* _WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="n">BOOL</span> <span class="kr">__stdcall</span>
</span><span class='line'><span class="nf">w32_intr_handler</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwCtrlType</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">dwCtrlType</span> <span class="o">==</span> <span class="n">CTRL_C_EVENT</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">intr_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define tty_readpass w32_tty_readpass</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">w32_tty_readpass</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">HANDLE</span> <span class="n">in</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="s">&quot;CONIN$&quot;</span><span class="p">,</span> <span class="n">GENERIC_READ</span><span class="o">|</span><span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span><span class='line'>                           <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">HANDLE</span> <span class="n">out</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="s">&quot;CONOUT$&quot;</span><span class="p">,</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span><span class='line'>                            <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">DWORD</span> <span class="n">mode</span><span class="p">;</span>
</span><span class='line'>    <span class="n">DWORD</span> <span class="n">ret</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">in</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">out</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Cannot open console. (errno=%d)&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">WriteFile</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">prompt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SetConsoleCtrlHandler</span><span class="p">(</span><span class="n">w32_intr_handler</span><span class="p">,</span> <span class="n">TRUE</span> <span class="p">);</span> <span class="cm">/* add handler */</span>
</span><span class='line'>    <span class="n">GetConsoleMode</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SetConsoleMode</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">mode</span><span class="o">&amp;~</span><span class="n">ENABLE_ECHO_INPUT</span><span class="p">);</span> <span class="cm">/* disable echo */</span>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="n">ReadFile</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SetConsoleMode</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>                   <span class="cm">/* enable echo */</span>
</span><span class='line'>    <span class="n">SetConsoleCtrlHandler</span><span class="p">(</span> <span class="n">w32_intr_handler</span><span class="p">,</span> <span class="n">FALSE</span> <span class="p">);</span> <span class="cm">/* remove handler */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">intr_flag</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">GenerateConsoleCtrlEvent</span><span class="p">(</span><span class="n">CTRL_C_EVENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* re-signal */</span>
</span><span class='line'>    <span class="n">WriteFile</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* _WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*** User / Password ***/</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* SOCKS5 and HTTP Proxy authentication may requires username and</span>
</span><span class='line'><span class="cm">   password. We ll give it via environment variable or tty.</span>
</span><span class='line'><span class="cm">   Username and password for authentication are decided by</span>
</span><span class='line'><span class="cm">   following rules:</span>
</span><span class='line'>
</span><span class='line'><span class="cm">   Username is taken from</span>
</span><span class='line'><span class="cm">     1) server location spec (i.e. user@host:port)</span>
</span><span class='line'><span class="cm">     2) environment variables (see tables.1)</span>
</span><span class='line'><span class="cm">     3) system account name currently logged in.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">     Table.1 Order of environment variables for username</span>
</span><span class='line'>
</span><span class='line'><span class="cm">        |  SOCKS v5   |  SOCKS v4   |   HTTP proxy    |</span>
</span><span class='line'><span class="cm">      --+-------------+-------------+-----------------+</span>
</span><span class='line'><span class="cm">      1 | SOCKS45_USER | SOCKS4_USER | HTTP_PROXY_USER |</span>
</span><span class='line'><span class="cm">      --+-------------+-------------+                 |</span>
</span><span class='line'><span class="cm">      2 |        SOCKS_USER         |                 |</span>
</span><span class='line'><span class="cm">      --+---------------------------+-----------------+</span>
</span><span class='line'><span class="cm">      3 |              CONNECT_USER                   |</span>
</span><span class='line'><span class="cm">      --+---------------------------------------------+</span>
</span><span class='line'>
</span><span class='line'><span class="cm">   Password is taken from</span>
</span><span class='line'><span class="cm">     1) by environment variables (see table.2)</span>
</span><span class='line'><span class="cm">     2) by entering from tty.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">     Table.2 Order of environment variables for password</span>
</span><span class='line'>
</span><span class='line'><span class="cm">        |    SOCKS v5     |     HTTP proxy      |</span>
</span><span class='line'><span class="cm">      --+-----------------+---------------------+</span>
</span><span class='line'><span class="cm">      1 | SOCKS5_PASSWD   |                     |</span>
</span><span class='line'><span class="cm">      --+-----------------+ HTTP_PROXY_PASSWORD |</span>
</span><span class='line'><span class="cm">      2 | SOCKS5_PASSWORD |                     |</span>
</span><span class='line'><span class="cm">      --+-----------------+---------------------+</span>
</span><span class='line'><span class="cm">      3 |           CONNECT_PASSWORD            |</span>
</span><span class='line'><span class="cm">      --+---------------------------------------+</span>
</span><span class='line'>
</span><span class='line'><span class="cm">      Note: SOCKS5_PASSWD which is added in rev. 1.79</span>
</span><span class='line'><span class="cm">            to share value with NEC SOCKS implementation.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">determine_relay_user</span> <span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">user</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* get username from environment variable, or system. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_SOCKS</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">socks_version</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'>            <span class="n">user</span> <span class="o">=</span> <span class="n">getparam</span> <span class="p">(</span><span class="n">ENV_SOCKS5_USER</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">socks_version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>            <span class="n">user</span> <span class="o">=</span> <span class="n">getparam</span> <span class="p">(</span><span class="n">ENV_SOCKS4_USER</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>            <span class="n">user</span> <span class="o">=</span> <span class="n">getparam</span> <span class="p">(</span><span class="n">ENV_SOCKS_USER</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_HTTP</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>            <span class="n">user</span> <span class="o">=</span> <span class="n">getparam</span> <span class="p">(</span><span class="n">ENV_HTTP_PROXY_USER</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">user</span> <span class="o">=</span> <span class="n">getparam</span> <span class="p">(</span><span class="n">ENV_CONNECT_USER</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/* determine relay user by system call if not yet. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">user</span> <span class="o">=</span> <span class="n">getusername</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">user</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">determine_relay_password</span> <span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">pass</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_HTTP</span><span class="p">)</span>
</span><span class='line'>        <span class="n">pass</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_HTTP_PROXY_PASSWORD</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_SOCKS</span><span class="p">)</span>
</span><span class='line'>        <span class="n">pass</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS5_PASSWD</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_SOCKS</span><span class="p">)</span>
</span><span class='line'>        <span class="n">pass</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS5_PASSWORD</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">pass</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_CONNECT_PASSWORD</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pass</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/*** network operations ***/</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/* set_relay()</span>
</span><span class='line'><span class="cm">   Determine relay informations:</span>
</span><span class='line'><span class="cm">   method, host, port, and username.</span>
</span><span class='line'><span class="cm">   1st arg, METHOD should be METHOD_xxx.</span>
</span><span class='line'><span class="cm">   2nd arg, SPEC is hostname or hostname:port or user@hostame:port.</span>
</span><span class='line'><span class="cm">   hostname is domain name or dot notation.</span>
</span><span class='line'><span class="cm">   If port is omitted, use 80 for METHOD_HTTP method,</span>
</span><span class='line'><span class="cm">   use 1080 for METHOD_SOCKS method.</span>
</span><span class='line'><span class="cm">   Username is also able to given by 3rd. format.</span>
</span><span class='line'><span class="cm">   2nd argument SPEC can be NULL. if NULL, use environment variable.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">set_relay</span><span class="p">(</span> <span class="kt">int</span> <span class="n">method</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spec</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">sep</span><span class="p">,</span> <span class="o">*</span><span class="n">resolve</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">relay_method</span> <span class="o">=</span> <span class="n">method</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">read_parameter_file</span><span class="p">();</span>
</span><span class='line'>    <span class="n">initialize_direct_addr</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">n_direct_addr_list</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;No direct address are specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%d direct address entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n_direct_addr_list</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span> <span class="n">method</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">METHOD_DIRECT</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                              <span class="cm">/* nothing to do */</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="nl">METHOD_SOCKS</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">switch</span> <span class="p">(</span> <span class="n">socks_version</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
</span><span class='line'>                <span class="n">spec</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS5_SERVER</span><span class="p">);</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span><span class='line'>                <span class="n">spec</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS4_SERVER</span><span class="p">);</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">spec</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS_SERVER</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Failed to determine SOCKS server.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">relay_port</span> <span class="o">=</span> <span class="mi">1080</span><span class="p">;</span>                      <span class="cm">/* set default first */</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* determine resolve method */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">socks_resolve</span> <span class="o">==</span> <span class="n">RESOLVE_UNKNOWN</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">socks_version</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="p">((</span><span class="n">resolve</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS5_RESOLVE</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">||</span>
</span><span class='line'>                 <span class="p">((</span><span class="n">socks_version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="p">((</span><span class="n">resolve</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS4_RESOLVE</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">||</span>
</span><span class='line'>                 <span class="p">((</span><span class="n">resolve</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS_RESOLVE</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">socks_resolve</span> <span class="o">=</span> <span class="n">lookup_resolve</span><span class="p">(</span> <span class="n">resolve</span> <span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="n">socks_resolve</span> <span class="o">==</span> <span class="n">RESOLVE_UNKNOWN</span> <span class="p">)</span>
</span><span class='line'>                    <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Invalid resolve method: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resolve</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* default */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="n">socks_version</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
</span><span class='line'>                    <span class="n">socks_resolve</span> <span class="o">=</span> <span class="n">RESOLVE_REMOTE</span><span class="p">;</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                    <span class="n">socks_resolve</span> <span class="o">=</span> <span class="n">RESOLVE_LOCAL</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="nl">METHOD_HTTP</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">spec</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_HTTP_PROXY</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;You must specify http proxy server</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">relay_port</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>                        <span class="cm">/* set default first */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">METHOD_TELNET</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">spec</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_TELNET_PROXY</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">spec</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;You must specify telnet proxy server</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">relay_port</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>                        <span class="cm">/* set default first */</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">expect</span><span class="p">(</span> <span class="n">spec</span><span class="p">,</span> <span class="n">HTTP_PROXY_PREFIX</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* URL format like: &quot;http://server:port/&quot; */</span>
</span><span class='line'>        <span class="cm">/* extract server:port part */</span>
</span><span class='line'>        <span class="n">buf</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span> <span class="n">spec</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">HTTP_PROXY_PREFIX</span><span class="p">));</span>
</span><span class='line'>        <span class="n">buf</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* assume spec is aready &quot;server:port&quot; format */</span>
</span><span class='line'>        <span class="n">buf</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span> <span class="n">spec</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">spec</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* check username in spec */</span>
</span><span class='line'>    <span class="n">sep</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span> <span class="n">spec</span><span class="p">,</span> <span class="sc">&#39;@&#39;</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">sep</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">*</span><span class="n">sep</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">relay_user</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span> <span class="n">spec</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">spec</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">relay_user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">relay_user</span> <span class="o">=</span> <span class="n">determine_relay_user</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* split out hostname and port number from spec */</span>
</span><span class='line'>    <span class="n">sep</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span><span class="sc">&#39;:&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">sep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* hostname only, port is already set as default */</span>
</span><span class='line'>        <span class="n">relay_host</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span> <span class="n">spec</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* hostname and port */</span>
</span><span class='line'>        <span class="n">relay_port</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">sep</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="o">*</span><span class="n">sep</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">relay_host</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span> <span class="n">spec</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">u_short</span>
</span><span class='line'><span class="nf">resolve_port</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">service</span><span class="p">[</span><span class="n">strspn</span> <span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">digits</span><span class="p">)]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span>  <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* all digits, port number */</span>
</span><span class='line'>        <span class="n">port</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* treat as service name */</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">servent</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
</span><span class='line'>        <span class="n">ent</span> <span class="o">=</span> <span class="n">getservbyname</span><span class="p">(</span> <span class="n">service</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">ent</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Unknown service, &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
</span><span class='line'>            <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">s_port</span><span class="p">);</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;service: %s =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">make_revstr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">rcs_revstr</span><span class="p">,</span> <span class="s">&quot;: &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">revstr</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="s">&quot;unknown&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* assume subversion&#39;s keyword expansion like &quot;Revision: 96&quot;. */</span>
</span><span class='line'>    <span class="n">minor_version</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>    <span class="n">revstr</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</span><span class='line'>    <span class="n">snprintf</span><span class="p">(</span><span class="n">revstr</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;%d.%d&quot;</span><span class="p">,</span> <span class="n">major_version</span><span class="p">,</span> <span class="n">minor_version</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">getarg</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD_DIRECT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">progname</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
</span><span class='line'>    <span class="n">argc</span><span class="o">--</span><span class="p">,</span> <span class="n">argv</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* check optinos */</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">**</span><span class="n">argv</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span> <span class="o">*</span><span class="n">ptr</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">switch</span> <span class="p">(</span> <span class="o">*</span><span class="n">ptr</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;s&#39;</span><span class="o">:</span>                           <span class="cm">/* use SOCKS */</span>
</span><span class='line'>                <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD_SOCKS</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>                           <span class="cm">/* no proxy */</span>
</span><span class='line'>                <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD_DIRECT</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>                           <span class="cm">/* use http-proxy */</span>
</span><span class='line'>                <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD_HTTP</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD_TELNET</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;S&#39;</span><span class="o">:</span>                           <span class="cm">/* specify SOCKS server */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">argc</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD_SOCKS</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">server</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">error</span><span class="p">(</span><span class="s">&quot;option &#39;-%c&#39; needs argument.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;H&#39;</span><span class="o">:</span>                           <span class="cm">/* specify http-proxy server */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">argc</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD_HTTP</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">server</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">error</span><span class="p">(</span><span class="s">&quot;option &#39;-%c&#39; needs argument.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;T&#39;</span><span class="o">:</span>                           <span class="cm">/* specify telnet proxy server */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">argc</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">method</span> <span class="o">=</span> <span class="n">METHOD_TELNET</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">server</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">error</span><span class="p">(</span><span class="s">&quot;option &#39;-%c&#39; needs argument.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;c&#39;</span><span class="o">:</span>
</span><span class='line'>                 <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                      <span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">argc</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>                      <span class="n">telnet_command</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
</span><span class='line'>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                      <span class="n">error</span><span class="p">(</span><span class="s">&quot;option &#39;%c&#39; needs argument.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                 <span class="p">}</span>
</span><span class='line'>                 <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;P&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="n">f_hold_session</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="cm">/* without break */</span>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;p&#39;</span><span class="o">:</span>                          <span class="cm">/* specify port to forward */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">argc</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">local_type</span> <span class="o">=</span> <span class="n">LOCAL_SOCKET</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">local_port</span> <span class="o">=</span> <span class="n">resolve_port</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">error</span><span class="p">(</span><span class="s">&quot;option &#39;-%c&#39; needs argument.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef _WIN32</span>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;w&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">argc</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">connect_timeout</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">error</span><span class="p">(</span><span class="s">&quot;option &#39;-%c&#39; needs argument.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not _WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;4&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="n">socks_version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;5&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="n">socks_version</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;a&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">argc</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">socks5_auth</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">error</span><span class="p">(</span><span class="s">&quot;option &#39;-%c&#39; needs argument.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;R&#39;</span><span class="o">:</span>                           <span class="cm">/* specify resolve method */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">argc</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">socks_resolve</span> <span class="o">=</span> <span class="n">lookup_resolve</span><span class="p">(</span> <span class="o">*</span><span class="n">argv</span> <span class="p">);</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">error</span><span class="p">(</span><span class="s">&quot;option &#39;-%c&#39; needs argument.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;V&#39;</span><span class="o">:</span>                           <span class="cm">/* print version */</span>
</span><span class='line'>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">Version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">progdesc</span><span class="p">,</span> <span class="n">revstr</span><span class="p">);</span>
</span><span class='line'>                <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>                           <span class="cm">/* debug mode */</span>
</span><span class='line'>                <span class="n">f_debug</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">default</span><span class="o">:</span>
</span><span class='line'>                <span class="n">error</span><span class="p">(</span><span class="s">&quot;unknown option &#39;-%c&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>                <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">argc</span><span class="o">--</span><span class="p">,</span> <span class="n">argv</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* check error */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">err</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">quit</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">set_relay</span><span class="p">(</span> <span class="n">method</span><span class="p">,</span> <span class="n">server</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* check destination HOST (MUST) */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span>  <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">Version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">progdesc</span><span class="p">,</span> <span class="n">revstr</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">progname</span><span class="p">);</span>
</span><span class='line'>        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">dest_host</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="cm">/* decide port or service name from programname or argument */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">ptr</span><span class="o">=</span><span class="n">strrchr</span><span class="p">(</span> <span class="n">progname</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span> <span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>         <span class="p">((</span><span class="n">ptr</span><span class="o">=</span><span class="n">strchr</span><span class="p">(</span> <span class="n">progname</span><span class="p">,</span> <span class="sc">&#39;\\&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="n">ptr</span> <span class="o">=</span> <span class="n">progname</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">dest_port</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* accept only if -P is not specified. */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/* get port number from argument (prior to progname) */</span>
</span><span class='line'>            <span class="cm">/* NOTE: This way is for cvs ext method. */</span>
</span><span class='line'>            <span class="n">dest_port</span> <span class="o">=</span> <span class="n">resolve_port</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">strncmp</span><span class="p">(</span> <span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;connect-&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/* decide port number from program name */</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span> <span class="n">ptr</span><span class="o">+</span><span class="mi">8</span> <span class="p">);</span>
</span><span class='line'>            <span class="n">str</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span> <span class="n">str</span><span class="p">,</span> <span class="s">&quot;.&quot;</span> <span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="n">dest_port</span> <span class="o">=</span> <span class="n">resolve_port</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'>            <span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/* check port number */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">dest_port</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span> <span class="s">&quot;You must specify the destination port correctly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">quit</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">relay_method</span> <span class="o">!=</span> <span class="n">METHOD_DIRECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">relay_port</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;Invalid relay port: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_port</span><span class="p">);</span>
</span><span class='line'>        <span class="n">err</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">quit</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nl">quit</span><span class="p">:</span>
</span><span class='line'>    <span class="cm">/* report for debugging */</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;relay_method = %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">method_names</span><span class="p">[</span><span class="n">relay_method</span><span class="p">],</span> <span class="n">relay_method</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">relay_method</span> <span class="o">!=</span> <span class="n">METHOD_DIRECT</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;relay_host=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">relay_host</span><span class="p">);</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;relay_port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">relay_port</span><span class="p">);</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;relay_user=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">relay_user</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_SOCKS</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;socks_version=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socks_version</span><span class="p">);</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;socks_resolve=%s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">resolve_names</span><span class="p">[</span><span class="n">socks_resolve</span><span class="p">],</span> <span class="n">socks_resolve</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;local_type=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local_type_names</span><span class="p">[</span><span class="n">local_type</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">local_type</span> <span class="o">==</span> <span class="n">LOCAL_SOCKET</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;local_port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local_port</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">f_hold_session</span><span class="p">)</span>
</span><span class='line'>            <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;  with holding remote session.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;dest_host=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_host</span><span class="p">);</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;dest_port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_port</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">err</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">progname</span><span class="p">);</span>
</span><span class='line'>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef _WIN32</span>
</span><span class='line'><span class="cm">/* Time-out feature is not allowed for Win32 native compilers. */</span>
</span><span class='line'><span class="cm">/* MSVC and Borland C cannot but Cygwin and UNIXes can. */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* timeout signal hander */</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">sig_timeout</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">signal</span><span class="p">(</span> <span class="n">SIGALRM</span><span class="p">,</span> <span class="n">SIG_IGN</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">alarm</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">error</span><span class="p">(</span> <span class="s">&quot;timed out</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* set timeout param = seconds, 0 clears */</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">set_timeout</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* This feature is allowed for UNIX or cygwin environments, currently */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span> <span class="s">&quot;clearing timeout</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">signal</span><span class="p">(</span> <span class="n">SIGALRM</span><span class="p">,</span> <span class="n">SIG_IGN</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">alarm</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span> <span class="s">&quot;setting timeout: %d seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">signal</span><span class="p">(</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sig_timeout</span><span class="p">);</span>
</span><span class='line'>        <span class="n">alarm</span><span class="p">(</span> <span class="n">timeout</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if !defined(_WIN32) &amp;&amp; !defined(__CYGWIN32__)</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">switch_ns</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">res_init</span><span class="p">();</span>
</span><span class='line'>    <span class="n">memcpy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_res</span><span class="p">.</span><span class="n">nsaddr_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ns</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ns</span><span class="p">));</span>
</span><span class='line'>    <span class="n">_res</span><span class="p">.</span><span class="n">nscount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Using nameserver at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* !_WIN32 &amp;&amp; !__CYGWIN32__ */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* TODO: IPv6</span>
</span><span class='line'><span class="cm">   TODO: fallback if askpass execution failed.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">local_resolve</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">strspn</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">dotdigits</span><span class="p">)</span> <span class="o">==</span> <span class="n">strlen</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* given by IPv4 address */</span>
</span><span class='line'>        <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>        <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;resolving host by name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ent</span> <span class="o">=</span> <span class="n">gethostbyname</span> <span class="p">(</span><span class="n">host</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">ent</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">memcpy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">h_addr</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">h_length</span><span class="p">);</span>
</span><span class='line'>            <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">h_addrtype</span><span class="p">;</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;resolved: %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">host</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;failed to resolve locally.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                          <span class="cm">/* failed */</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                                   <span class="cm">/* good */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">open_connection</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">port</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">SOCKET</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">saddr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* resolve address of proxy or direct target */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">local_resolve</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saddr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;can&#39;t resolve hostname: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">SOCKET_ERROR</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;connecting to %s:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="n">port</span><span class="p">);</span>
</span><span class='line'>    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span> <span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">connect</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">saddr</span><span class="p">))</span>
</span><span class='line'>         <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span> <span class="s">&quot;connect() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">SOCKET_ERROR</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">report_text</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">char</span> <span class="n">work</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">f_debug</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">f_report</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>                                 <span class="cm">/* don&#39;t report */</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s </span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="o">*</span><span class="n">buf</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">memset</span><span class="p">(</span> <span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">work</span><span class="p">));</span>
</span><span class='line'>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">work</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span> <span class="o">*</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tmp</span><span class="o">-</span><span class="n">work</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">work</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">switch</span> <span class="p">(</span> <span class="o">*</span><span class="n">buf</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;\t&#39;</span><span class="o">:</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;t&#39;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;\r&#39;</span><span class="o">:</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;r&#39;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;\n&#39;</span><span class="o">:</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="sc">&#39;\\&#39;</span><span class="o">:</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">default</span><span class="o">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="n">isprint</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">consumed</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">work</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">snprintf</span><span class="p">(</span> <span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">work</span><span class="p">)</span><span class="o">-</span><span class="n">consumed</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;</span><span class="se">\\</span><span class="s">x%02X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">tmp</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">buf</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">debug_</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">debug_</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">report_bytes</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="n">f_debug</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">prefix</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>        <span class="n">buf</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="n">len</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">atomic_out</span><span class="p">(</span> <span class="n">SOCKET</span> <span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span> <span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span> <span class="mi">0</span><span class="o">&lt;=</span><span class="n">size</span> <span class="p">);</span>
</span><span class='line'>    <span class="cm">/* do atomic out */</span>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">len</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;atomic_out() failed to send(), %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>        <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f_report</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;atomic_out()  [some bytes]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt; xx xx xx xx ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;atomic_out()  [%d bytes]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>        <span class="n">report_bytes</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">atomic_in</span><span class="p">(</span> <span class="n">SOCKET</span> <span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span> <span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span> <span class="mi">0</span><span class="o">&lt;=</span><span class="n">size</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* do atomic in */</span>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">len</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;atomic_in() failed to recv(), %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span> <span class="s">&quot;Connection closed by peer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>        <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f_report</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;atomic_in()  [some bytes]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt; xx xx xx xx ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;atomic_in() [%d bytes]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>        <span class="n">report_bytes</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">line_input</span><span class="p">(</span> <span class="n">SOCKET</span> <span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                               <span class="cm">/* no error */</span>
</span><span class='line'>    <span class="n">size</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">switch</span> <span class="p">(</span> <span class="n">recv</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>        <span class="cm">/* recv one-by-one */</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">SOCKET_ERROR</span><span class="p">:</span>
</span><span class='line'>            <span class="n">error</span><span class="p">(</span><span class="s">&quot;recv() error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                          <span class="cm">/* error */</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>            <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                           <span class="cm">/* end of stream */</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="k">default</span><span class="o">:</span>
</span><span class='line'>            <span class="cm">/* continue reading until last 1 char is EOL? */</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">dst</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* finished */</span>
</span><span class='line'>                <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* more... */</span>
</span><span class='line'>                <span class="n">size</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">dst</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">report_text</span><span class="p">(</span> <span class="s">&quot;&lt;&lt;&lt;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* cut_token()</span>
</span><span class='line'><span class="cm">   Span token in given string STR until char in DELIM is appeared.</span>
</span><span class='line'><span class="cm">   Then replace contiguous DELIMS with &#39;\0&#39; for string termination</span>
</span><span class='line'><span class="cm">   and returns next pointer.</span>
</span><span class='line'><span class="cm">   If no next token, return NULL.</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">cut_token</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">delim</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">str</span> <span class="o">+</span> <span class="n">strcspn</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">delim</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">strspn</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">delim</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">ptr</span> <span class="o">==</span> <span class="n">str</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="p">)</span>
</span><span class='line'>        <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">lookup</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">LOOKUP_ITEM</span> <span class="o">*</span><span class="n">items</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">;</span>
</span><span class='line'>        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;(unknown)&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* readpass()</span>
</span><span class='line'><span class="cm">   password input routine</span>
</span><span class='line'><span class="cm">   Use ssh-askpass (same mechanism to OpenSSH)</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">readpass</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">prompt</span><span class="p">,</span> <span class="p">...)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>                      <span class="cm">/* XXX, don&#39;t be fix length */</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">prompt</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SSH_ASKPASS</span><span class="p">)</span>
</span><span class='line'><span class="cp">#if !defined(_WIN32) &amp;&amp; !defined(__CYGWIN32__)</span>
</span><span class='line'>         <span class="o">&amp;&amp;</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;DISPLAY&quot;</span><span class="p">)</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not _WIN32 &amp;&amp; not __CYGWIN32__ */</span><span class="cp"></span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* use ssh-askpass to get password */</span>
</span><span class='line'>        <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">askpass</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SSH_ASKPASS</span><span class="p">),</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">cmd_size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">askpass</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span> <span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">cmd</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">cmd_size</span><span class="p">);</span>
</span><span class='line'>        <span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_size</span><span class="p">,</span> <span class="s">&quot;%s </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">askpass</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fp</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>                        <span class="cm">/* fail */</span>
</span><span class='line'>        <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>                        <span class="cm">/* fail */</span>
</span><span class='line'>        <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">tty_readpass</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">buf</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">socks5_do_auth_userpass</span><span class="p">(</span> <span class="kt">int</span> <span class="n">s</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">],</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">pass</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* do User/Password authentication. */</span>
</span><span class='line'>    <span class="cm">/* This feature requires username and password from</span>
</span><span class='line'><span class="cm">       command line argument or environment variable,</span>
</span><span class='line'><span class="cm">       or terminal. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">relay_user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;cannot determine user name.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* get password from environment variable if exists. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">pass</span><span class="o">=</span><span class="n">determine_relay_password</span><span class="p">())</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>        <span class="p">(</span><span class="n">pass</span><span class="o">=</span><span class="n">readpass</span><span class="p">(</span><span class="s">&quot;Enter SOCKS5 password for %s@%s: &quot;</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">relay_user</span><span class="p">,</span> <span class="n">relay_host</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Cannot get password for user: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">relay_user</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* make authentication packet */</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>                       <span class="cm">/* subnegotiation ver.: 1 */</span>
</span><span class='line'>    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">relay_user</span> <span class="p">);</span>                 <span class="cm">/* ULEN and UNAME */</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">len</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">relay_user</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">pass</span> <span class="p">);</span>                       <span class="cm">/* PLEN and PASSWD */</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pass</span><span class="p">));</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">pass</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="n">memset</span> <span class="p">(</span><span class="n">pass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pass</span><span class="p">));</span>             <span class="cm">/* erase password */</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* send it and get answer */</span>
</span><span class='line'>    <span class="n">f_report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">atomic_out</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-</span><span class="n">buf</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">f_report</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">atomic_in</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* check status */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                               <span class="cm">/* success */</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                              <span class="cm">/* fail */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">socks5_getauthname</span><span class="p">(</span> <span class="kt">int</span> <span class="n">auth</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span> <span class="n">auth</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_REJECT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;REJECTED&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_NOAUTH</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;NO-AUTH&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_GSSAPI</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GSSAPI&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_USERPASS</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;USERPASS&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_CHAP</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;CHAP&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_EAP</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;EAP&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_MAF</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;MAF&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="s">&quot;(unknown)&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">auth</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">AUTH_METHOD_ITEM</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">AUTH_METHOD_ITEM</span> <span class="n">socks5_auth_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="n">SOCKS5_AUTH_NOAUTH</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;gssapi&quot;</span><span class="p">,</span> <span class="n">SOCKS5_AUTH_GSSAPI</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;userpass&quot;</span><span class="p">,</span> <span class="n">SOCKS5_AUTH_USERPASS</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;chap&quot;</span><span class="p">,</span> <span class="n">SOCKS5_AUTH_CHAP</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">socks5_auth_parse_1</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span> <span class="n">start</span><span class="o">++</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">start</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">start</span> <span class="o">!=</span> <span class="sc">&#39;\t&#39;</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="n">end</span><span class="o">--</span><span class="p">;</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">;</span> <span class="n">end</span><span class="o">--</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">end</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">end</span> <span class="o">!=</span> <span class="sc">&#39;\t&#39;</span><span class="p">){</span>
</span><span class='line'>            <span class="n">end</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">len</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">socks5_auth_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">){</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">socks5_auth_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">socks5_auth_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">auth</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Unknown auth method: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">socks5_auth_parse</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">auth_list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_auth</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_auth</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">auth_list</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">socks5_auth_parse_1</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
</span><span class='line'>            <span class="n">start</span> <span class="o">=</span> <span class="o">++</span><span class="n">end</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_auth</span> <span class="p">)</span> <span class="p">){</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span> <span class="n">end</span><span class="o">++</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">auth_list</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">socks5_auth_parse_1</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Too much auth method.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* begin SOCKS5 relaying</span>
</span><span class='line'><span class="cm">   And no authentication is supported.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">begin_socks5_relay</span><span class="p">(</span> <span class="n">SOCKET</span> <span class="n">s</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">env</span> <span class="o">=</span> <span class="n">socks5_auth</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">n_auth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">auth_list</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">auth_method</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">auth_result</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span> <span class="s">&quot;begin_socks_relay()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* request authentication */</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>                        <span class="cm">/* SOCKS version (5) */</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">env</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">env</span> <span class="o">=</span> <span class="n">getparam</span><span class="p">(</span><span class="n">ENV_SOCKS5_AUTH</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">env</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* add no-auth authentication */</span>
</span><span class='line'>        <span class="n">auth_list</span><span class="p">[</span><span class="n">n_auth</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SOCKS5_AUTH_NOAUTH</span><span class="p">;</span>
</span><span class='line'>        <span class="cm">/* add user/pass authentication */</span>
</span><span class='line'>        <span class="n">auth_list</span><span class="p">[</span><span class="n">n_auth</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SOCKS5_AUTH_USERPASS</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">n_auth</span> <span class="o">=</span> <span class="n">socks5_auth_parse</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">auth_list</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">n_auth</span><span class="p">);</span>                   <span class="cm">/* num auth */</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n_auth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;available auth method[%d] = %s (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">i</span><span class="p">,</span> <span class="n">socks5_getauthname</span><span class="p">(</span><span class="n">auth_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">auth_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">auth_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>         <span class="cm">/* authentications */</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">atomic_out</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-</span><span class="n">buf</span> <span class="p">);</span>              <span class="cm">/* send requst */</span>
</span><span class='line'>    <span class="n">atomic_in</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>                     <span class="cm">/* recv response */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span>                       <span class="cm">/* ver5 response */</span>
</span><span class='line'>         <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>                   <span class="cm">/* check auth method */</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;No auth method accepted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">auth_method</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;auth method: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socks5_getauthname</span><span class="p">(</span><span class="n">auth_method</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span> <span class="n">auth_method</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_REJECT</span><span class="p">:</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;No acceptable authentication method</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                              <span class="cm">/* fail */</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_NOAUTH</span><span class="p">:</span>
</span><span class='line'>        <span class="cm">/* nothing to do */</span>
</span><span class='line'>        <span class="n">auth_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOCKS5_AUTH_USERPASS</span><span class="p">:</span>
</span><span class='line'>        <span class="n">auth_result</span> <span class="o">=</span> <span class="n">socks5_do_auth_userpass</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">default</span><span class="o">:</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;Unsupported authentication method: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">socks5_getauthname</span><span class="p">(</span> <span class="n">auth_method</span> <span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                              <span class="cm">/* fail */</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">auth_result</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;Authentication failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/* request to connect */</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>                        <span class="cm">/* SOCKS version (5) */</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>                        <span class="cm">/* CMD: CONNECT */</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                        <span class="cm">/* FLG: 0 */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* resolved by SOCKS server */</span>
</span><span class='line'>        <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>                    <span class="cm">/* ATYP: DOMAINNAME */</span>
</span><span class='line'>        <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dest_host</span><span class="p">);</span>
</span><span class='line'>        <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>                  <span class="cm">/* DST.ADDR (len) */</span>
</span><span class='line'>        <span class="n">memcpy</span><span class="p">(</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">dest_host</span><span class="p">,</span> <span class="n">len</span> <span class="p">);</span>          <span class="cm">/* (hostname) */</span>
</span><span class='line'>        <span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* resolved localy */</span>
</span><span class='line'>        <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>                   <span class="cm">/* ATYP: IPv4 */</span>
</span><span class='line'>        <span class="n">memcpy</span><span class="p">(</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">));</span>
</span><span class='line'>        <span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">dest_port</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>     <span class="cm">/* DST.PORT */</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">dest_port</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">);</span>
</span><span class='line'>    <span class="n">atomic_out</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-</span><span class="n">buf</span><span class="p">);</span>               <span class="cm">/* send request */</span>
</span><span class='line'>    <span class="n">atomic_in</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span> <span class="p">);</span>                     <span class="cm">/* recv response */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SOCKS5_REP_SUCCEEDED</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>   <span class="cm">/* check reply code */</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;Got error response from SOCKS server: %d (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lookup</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">socks5_rep_names</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>                         <span class="cm">/* case by ATYP */</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>                                     <span class="cm">/* IP v4 ADDR*/</span>
</span><span class='line'>        <span class="n">atomic_in</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="o">+</span><span class="mi">2</span> <span class="p">);</span>               <span class="cm">/* recv IPv4 addr and port */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>                                     <span class="cm">/* DOMAINNAME */</span>
</span><span class='line'>        <span class="n">atomic_in</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>                 <span class="cm">/* recv name and port */</span>
</span><span class='line'>        <span class="n">atomic_in</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>                                     <span class="cm">/* IP v6 ADDR */</span>
</span><span class='line'>        <span class="n">atomic_in</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">16</span><span class="o">+</span><span class="mi">2</span> <span class="p">);</span>              <span class="cm">/* recv IPv6 addr and port */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Conguraturation, connected via SOCKS5 server! */</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* begin SOCKS protocol 4 relaying</span>
</span><span class='line'><span class="cm">   And no authentication is supported.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">   There&#39;s SOCKS protocol version 4 and 4a. Protocol version</span>
</span><span class='line'><span class="cm">   4a has capability to resolve hostname by SOCKS server, so</span>
</span><span class='line'><span class="cm">   we don&#39;t need resolving IP address of destination host on</span>
</span><span class='line'><span class="cm">   local machine.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">   Environment variable SOCKS_RESOLVE directs how to resolve</span>
</span><span class='line'><span class="cm">   IP addess. There&#39;s 3 keywords allowed; &quot;local&quot;, &quot;remote&quot;</span>
</span><span class='line'><span class="cm">   and &quot;both&quot; (case insensitive). Keyword &quot;local&quot; means taht</span>
</span><span class='line'><span class="cm">   target host name is resolved by localhost resolver</span>
</span><span class='line'><span class="cm">   (usualy with gethostbyname()), &quot;remote&quot; means by remote</span>
</span><span class='line'><span class="cm">   SOCKS server, &quot;both&quot; means to try resolving by localhost</span>
</span><span class='line'><span class="cm">   then remote.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">   SOCKS4 protocol and authentication of SOCKS5 protocol</span>
</span><span class='line'><span class="cm">   requires user name on connect request.</span>
</span><span class='line'><span class="cm">   User name is determined by following method.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">   1. If server spec has user@hostname:port format then</span>
</span><span class='line'><span class="cm">      user part is used for this SOCKS server.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">   2. Get user name from environment variable LOGNAME, USER</span>
</span><span class='line'><span class="cm">      (in this order).</span>
</span><span class='line'>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">begin_socks4_relay</span><span class="p">(</span> <span class="n">SOCKET</span> <span class="n">s</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span> <span class="s">&quot;begin_socks_relay()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* make connect request packet</span>
</span><span class='line'><span class="cm">       protocol v4:</span>
</span><span class='line'><span class="cm">         VN:1, CD:1, PORT:2, ADDR:4, USER:n, NULL:1</span>
</span><span class='line'><span class="cm">       protocol v4a:</span>
</span><span class='line'><span class="cm">         VN:1, CD:1, PORT:2, DUMMY:4, USER:n, NULL:1, HOSTNAME:n, NULL:1</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>                        <span class="cm">/* protocol version (4) */</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>                        <span class="cm">/* CONNECT command */</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">dest_port</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>     <span class="cm">/* destination Port */</span>
</span><span class='line'>    <span class="n">PUT_BYTE</span><span class="p">(</span> <span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">dest_port</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">);</span>
</span><span class='line'>    <span class="cm">/* destination IP */</span>
</span><span class='line'>    <span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">));</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>        <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                           <span class="cm">/* fake, protocol 4a */</span>
</span><span class='line'>    <span class="cm">/* username */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">relay_user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span> <span class="s">&quot;Cannot determine user name.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">relay_user</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">relay_user</span> <span class="p">)</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* destination host name (for protocol 4a) */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">socks_version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">strcpy</span><span class="p">(</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">dest_host</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">dest_host</span> <span class="p">)</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/* send command and get response</span>
</span><span class='line'><span class="cm">       response is: VN:1, CD:1, PORT:2, ADDR:4 */</span>
</span><span class='line'>    <span class="n">atomic_out</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-</span><span class="n">buf</span><span class="p">);</span>               <span class="cm">/* send request */</span>
</span><span class='line'>    <span class="n">atomic_in</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8</span> <span class="p">);</span>                     <span class="cm">/* recv response */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SOCKS4_REP_SUCCEEDED</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>   <span class="cm">/* check reply code */</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;Got error response: %d: &#39;%s&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lookup</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">socks4_rep_names</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                              <span class="cm">/* failed */</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Conguraturation, connected via SOCKS4 server! */</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">sendf</span><span class="p">(</span><span class="n">SOCKET</span> <span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,...)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10240</span><span class="p">];</span>                     <span class="cm">/* xxx, enough? */</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">va_start</span><span class="p">(</span> <span class="n">args</span><span class="p">,</span> <span class="n">fmt</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">vsnprintf</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">va_end</span><span class="p">(</span> <span class="n">args</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">report_text</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;failed to send http request. errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base64_table</span> <span class="o">=</span>
</span><span class='line'><span class="s">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">make_base64_string</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">src_len</span><span class="p">,</span> <span class="n">dst_len</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* make base64 string */</span>
</span><span class='line'>    <span class="n">src_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dst_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_len</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
</span><span class='line'>    <span class="n">buf</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">dst_len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">bits</span> <span class="o">=</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="n">dst_len</span><span class="o">--</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">bits</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
</span><span class='line'>            <span class="n">bits</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>                <span class="n">src</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">base64_table</span><span class="p">[</span><span class="mh">0x3F</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">6</span><span class="p">))];</span>
</span><span class='line'>        <span class="n">bits</span> <span class="o">-=</span> <span class="mi">6</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* fix-up tail padding */</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span> <span class="n">src_len</span><span class="o">%</span><span class="mi">3</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>        <span class="o">*--</span><span class="n">dst</span> <span class="o">=</span> <span class="sc">&#39;=&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>        <span class="o">*--</span><span class="n">dst</span> <span class="o">=</span> <span class="sc">&#39;=&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">basic_auth</span> <span class="p">(</span><span class="n">SOCKET</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">userpass</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">user</span> <span class="o">=</span> <span class="n">relay_user</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">pass</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Get username/password for authentication */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Cannot decide username for proxy authentication.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">pass</span> <span class="o">=</span> <span class="n">determine_relay_password</span> <span class="p">())</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>        <span class="p">(</span><span class="n">pass</span> <span class="o">=</span> <span class="n">readpass</span><span class="p">(</span><span class="s">&quot;Enter proxy authentication password for %s@%s: &quot;</span><span class="p">,</span>
</span><span class='line'>                         <span class="n">relay_user</span><span class="p">,</span> <span class="n">relay_host</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Cannot decide password for proxy authentication.&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">pass</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">userpass</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">snprintf</span><span class="p">(</span><span class="n">userpass</span><span class="p">,</span> <span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
</span><span class='line'>    <span class="n">memset</span> <span class="p">(</span><span class="n">pass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pass</span><span class="p">));</span>
</span><span class='line'>    <span class="n">cred</span> <span class="o">=</span> <span class="n">make_base64_string</span><span class="p">(</span><span class="n">userpass</span><span class="p">);</span>
</span><span class='line'>    <span class="n">memset</span> <span class="p">(</span><span class="n">userpass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">f_report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                               <span class="cm">/* don&#39;t report for security */</span>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="n">sendf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Proxy-Authorization: Basic %s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cred</span><span class="p">);</span>
</span><span class='line'>    <span class="n">f_report</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">report_text</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;Proxy-Authorization: Basic xxxxx</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cred</span><span class="p">));</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* begin relaying via HTTP proxy</span>
</span><span class='line'><span class="cm">   Directs CONNECT method to proxy server to connect to</span>
</span><span class='line'><span class="cm">   destination host (and port). It may not be allowed on your</span>
</span><span class='line'><span class="cm">   proxy server.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">begin_http_relay</span><span class="p">(</span> <span class="n">SOCKET</span> <span class="n">s</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">auth_what</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;begin_http_relay()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">sendf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&quot;CONNECT %s:%d HTTP/1.0</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_host</span><span class="p">,</span> <span class="n">dest_port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">proxy_auth_type</span> <span class="o">==</span> <span class="n">PROXY_AUTH_BASIC</span> <span class="o">&amp;&amp;</span> <span class="n">basic_auth</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">sendf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* get response */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">line_input</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;failed to read http response.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* check status */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">error</span> <span class="p">(</span><span class="s">&quot;Unexpected http response: &#39;%s&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span> <span class="n">result</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">200</span><span class="o">:</span>
</span><span class='line'>        <span class="cm">/* Conguraturation, connected via http proxy server! */</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;connected, start user session.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">302</span><span class="o">:</span>                                   <span class="cm">/* redirect */</span>
</span><span class='line'>        <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">line_input</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="n">downcase</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">expect</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Location: &quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">relay_host</span> <span class="o">=</span> <span class="n">cut_token</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;//&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="n">cut_token</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="n">relay_port</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">cut_token</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">));</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">START_RETRY</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* We handle both 401 and 407 codes here: 401 is WWW-Authenticate, which</span>
</span><span class='line'><span class="cm">     * not strictly the correct response, but some proxies do send this (e.g.</span>
</span><span class='line'><span class="cm">     * Symantec&#39;s Raptor firewall) */</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">401</span><span class="o">:</span>                                   <span class="cm">/* WWW-Auth required */</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">407</span><span class="o">:</span>                                   <span class="cm">/* Proxy-Auth required */</span>
</span><span class='line'>        <span class="cm">/** NOTE: As easy implementation, we support only BASIC scheme</span>
</span><span class='line'><span class="cm">            and ignore realm. */</span>
</span><span class='line'>        <span class="cm">/* If proxy_auth_type is PROXY_AUTH_BASIC and get</span>
</span><span class='line'><span class="cm">         this result code, authentication was failed. */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">proxy_auth_type</span> <span class="o">!=</span> <span class="n">PROXY_AUTH_NONE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">error</span><span class="p">(</span><span class="s">&quot;Authentication failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">auth_what</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">401</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;WWW-Authenticate:&quot;</span> <span class="o">:</span> <span class="s">&quot;Proxy-Authenticate:&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">line_input</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">downcase</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">expect</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">auth_what</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* parse type and realm */</span>
</span><span class='line'>                <span class="kt">char</span> <span class="o">*</span><span class="n">scheme</span><span class="p">,</span> <span class="o">*</span><span class="n">realm</span><span class="p">;</span>
</span><span class='line'>                <span class="n">scheme</span> <span class="o">=</span> <span class="n">cut_token</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="n">realm</span> <span class="o">=</span> <span class="n">cut_token</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="n">scheme</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">realm</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Invalid format of %s field.&quot;</span><span class="p">,</span> <span class="n">auth_what</span><span class="p">);</span>
</span><span class='line'>                    <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>         <span class="cm">/* fail */</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="cm">/* check supported auth type */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">expect</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="s">&quot;basic&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">proxy_auth_type</span> <span class="o">=</span> <span class="n">PROXY_AUTH_BASIC</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Unsupported authentication type: %s&quot;</span><span class="p">,</span> <span class="n">scheme</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">proxy_auth_type</span> <span class="o">==</span> <span class="n">PROXY_AUTH_NONE</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Can&#39;t find %s in response header.&quot;</span><span class="p">,</span> <span class="n">auth_what</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">START_RETRY</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">default</span><span class="o">:</span>
</span><span class='line'>        <span class="cm">/* Not allowed */</span>
</span><span class='line'>        <span class="n">debug</span><span class="p">(</span><span class="s">&quot;http proxy is not allowed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/* skip to end of response header */</span>
</span><span class='line'>    <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">line_input</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Can&#39;t skip response headers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">START_OK</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* begin relaying via TELNET proxy.</span>
</span><span class='line'><span class="cm">   Sends string specified by telnet_command (-c option) with</span>
</span><span class='line'><span class="cm">   replacing host name and port number to the socket.  */</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">begin_telnet_relay</span><span class="p">(</span> <span class="n">SOCKET</span> <span class="n">s</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">good_phrase</span> <span class="o">=</span> <span class="s">&quot;connected to&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">bad_phrase_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s">&quot; failed&quot;</span><span class="p">,</span> <span class="s">&quot; refused&quot;</span><span class="p">,</span> <span class="s">&quot; rejected&quot;</span><span class="p">,</span> <span class="s">&quot; closed&quot;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">sep</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;begin_telnet_relay()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* report phrase */</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;good phrase: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">good_phrase</span><span class="p">);</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;bad phrases&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sep</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">bad_phrase_list</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">debug_</span><span class="p">(</span><span class="s">&quot;%c &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">bad_phrase_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">sep</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">debug_</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* make request string with replacing %h by destination hostname</span>
</span><span class='line'><span class="cm">       and %p by port number, etc. */</span>
</span><span class='line'>    <span class="n">cmd</span> <span class="o">=</span> <span class="n">expand_host_and_port</span><span class="p">(</span><span class="n">telnet_command</span><span class="p">,</span> <span class="n">dest_host</span><span class="p">,</span> <span class="n">dest_port</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Sorry, we send request string now without waiting a prompt. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">sendf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">free</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Process answer from proxy until good or bad phrase is detected.  We</span>
</span><span class='line'><span class="cm">       assume that the good phrase should be appeared only in the final</span>
</span><span class='line'><span class="cm">       line of proxy responses. Bad keywods in the line causes operation</span>
</span><span class='line'><span class="cm">       fail. First checks a good phrase, then checks bad phrases.</span>
</span><span class='line'><span class="cm">       If no match, continue reading line from proxy. */</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">line_input</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">downcase</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>  <span class="cm">/* first, check good phrase */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">good_phrase</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">debug</span><span class="p">(</span><span class="s">&quot;good phrase is detected: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">good_phrase</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">START_OK</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>  <span class="cm">/* then, check bad phrase */</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">bad_phrase_list</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bad_phrase_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">debug</span><span class="p">(</span><span class="s">&quot;bad phrase is detected: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bad_phrase_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;error reading from telnet proxy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">START_ERROR</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'><span class="cm">/* ddatalen()</span>
</span><span class='line'><span class="cm">   Returns 1 if data is available, otherwise return 0</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">stdindatalen</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">DWORD</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fstat</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">_S_IFIFO</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* in case of PIPE */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">PeekNamedPipe</span><span class="p">(</span> <span class="n">GetStdHandle</span><span class="p">(</span><span class="n">STD_INPUT_HANDLE</span><span class="p">),</span>
</span><span class='line'>                             <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">GetLastError</span><span class="p">()</span> <span class="o">==</span> <span class="n">ERROR_BROKEN_PIPE</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* PIPE source is closed */</span>
</span><span class='line'>                <span class="cm">/* read() will detects EOF */</span>
</span><span class='line'>                <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;PeekNamedPipe() failed, errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">GetLastError</span><span class="p">());</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">_S_IFREG</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* in case of regular file (redirected) */</span>
</span><span class='line'>        <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                        <span class="cm">/* always data ready */</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">_kbhit</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* in case of console */</span>
</span><span class='line'>        <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* _WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* relay byte from stdin to socket and fro socket to stdout.</span>
</span><span class='line'><span class="cm">   returns reason of termination */</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">do_repeater</span><span class="p">(</span> <span class="n">SOCKET</span> <span class="n">local_in</span><span class="p">,</span> <span class="n">SOCKET</span> <span class="n">local_out</span><span class="p">,</span> <span class="n">SOCKET</span> <span class="n">remote</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/** vars for local input data **/</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">lbuf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>                            <span class="cm">/* local input buffer */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">lbuf_len</span><span class="p">;</span>                               <span class="cm">/* available data in lbuf */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">f_local</span><span class="p">;</span>                                <span class="cm">/* read local input more? */</span>
</span><span class='line'>    <span class="cm">/** vars for remote input data **/</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>                            <span class="cm">/* remote input buffer */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">rbuf_len</span><span class="p">;</span>                               <span class="cm">/* available data in rbuf */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">f_remote</span><span class="p">;</span>                               <span class="cm">/* read remote input more? */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">close_reason</span> <span class="o">=</span> <span class="n">REASON_UNK</span><span class="p">;</span>              <span class="cm">/* reason of end repeating */</span>
</span><span class='line'>    <span class="cm">/** other variables **/</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">nfds</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fd_set</span> <span class="n">ifds</span><span class="p">,</span> <span class="n">ofds</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tmo</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">win32_tmo</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* _WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* repeater between stdin/out and socket  */</span>
</span><span class='line'>    <span class="n">nfds</span> <span class="o">=</span> <span class="p">((</span><span class="n">local_in</span><span class="o">&lt;</span><span class="n">remote</span><span class="p">)</span><span class="o">?</span> <span class="nl">remote</span><span class="p">:</span> <span class="n">local_in</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">f_local</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                                <span class="cm">/* yes, read from local */</span>
</span><span class='line'>    <span class="n">f_remote</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                               <span class="cm">/* yes, read from remote */</span>
</span><span class='line'>    <span class="n">lbuf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">rbuf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span> <span class="n">f_local</span> <span class="o">||</span> <span class="n">f_remote</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifds</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofds</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">tmo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/** prepare for reading local input **/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">f_local</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lbuf_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">lbuf</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">local_type</span> <span class="o">!=</span> <span class="n">LOCAL_SOCKET</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* select() on Winsock is not accept standard handle.</span>
</span><span class='line'><span class="cm">                   So use select() with short timeout and checking data</span>
</span><span class='line'><span class="cm">                   in stdin by another method. */</span>
</span><span class='line'>                <span class="n">win32_tmo</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                <span class="n">win32_tmo</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>    <span class="cm">/* 10 ms */</span>
</span><span class='line'>                <span class="n">tmo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_tmo</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* !_WIN32 */</span><span class="cp"></span>
</span><span class='line'>            <span class="n">FD_SET</span><span class="p">(</span> <span class="n">local_in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span> <span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/** prepare for reading remote input **/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">f_remote</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rbuf_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rbuf</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">FD_SET</span><span class="p">(</span> <span class="n">remote</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span> <span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* FD_SET( local_out, ofds ); */</span>
</span><span class='line'>        <span class="cm">/* FD_SET( remote, ofds ); */</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">select</span><span class="p">(</span> <span class="n">nfds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ofds</span><span class="p">,</span> <span class="p">(</span><span class="n">fd_set</span><span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">tmo</span> <span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/* some error */</span>
</span><span class='line'>            <span class="n">error</span><span class="p">(</span> <span class="s">&quot;select() failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">REASON_ERROR</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'>        <span class="cm">/* fake ifds if local is stdio handle because</span>
</span><span class='line'><span class="cm">           select() of Winsock does not accept stdio</span>
</span><span class='line'><span class="cm">           handle. */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">f_local</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">local_type</span><span class="o">!=</span><span class="n">LOCAL_SOCKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;</span><span class="n">stdindatalen</span><span class="p">()))</span>
</span><span class='line'>            <span class="n">FD_SET</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ifds</span><span class="p">);</span>            <span class="cm">/* data ready */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* remote =&gt; local */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">FD_ISSET</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rbuf_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rbuf</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">len</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span> <span class="n">remote</span><span class="p">,</span> <span class="n">rbuf</span> <span class="o">+</span> <span class="n">rbuf_len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rbuf</span><span class="p">)</span><span class="o">-</span><span class="n">rbuf_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">socket_errno</span><span class="p">()</span> <span class="o">==</span> <span class="n">ECONNRESET</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">debug</span><span class="p">(</span><span class="s">&quot;connection %s by peer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="p">(</span><span class="n">len</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span> <span class="s">&quot;closed&quot;</span><span class="o">:</span> <span class="s">&quot;reset&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="n">close_reason</span> <span class="o">=</span> <span class="n">REASON_CLOSED_BY_REMOTE</span><span class="p">;</span>
</span><span class='line'>                <span class="n">f_remote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                   <span class="cm">/* no more read from socket */</span>
</span><span class='line'>                <span class="n">f_local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* error */</span>
</span><span class='line'>                <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;recv() failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">debug</span><span class="p">(</span><span class="s">&quot;recv %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">f_debug</span> <span class="p">)</span>              <span class="cm">/* more verbose */</span>
</span><span class='line'>                    <span class="n">report_bytes</span><span class="p">(</span> <span class="s">&quot;&lt;&lt;&lt;&quot;</span><span class="p">,</span> <span class="n">rbuf</span><span class="o">+</span><span class="n">rbuf_len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>                <span class="n">rbuf_len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* local =&gt; remote */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">FD_ISSET</span><span class="p">(</span><span class="n">local_in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lbuf_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">lbuf</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">local_type</span> <span class="o">==</span> <span class="n">LOCAL_SOCKET</span><span class="p">)</span>
</span><span class='line'>                <span class="n">len</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">local_in</span><span class="p">,</span> <span class="n">lbuf</span> <span class="o">+</span> <span class="n">lbuf_len</span><span class="p">,</span>
</span><span class='line'>                           <span class="k">sizeof</span><span class="p">(</span><span class="n">lbuf</span><span class="p">)</span><span class="o">-</span><span class="n">lbuf_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="n">len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">local_in</span><span class="p">,</span> <span class="n">lbuf</span> <span class="o">+</span> <span class="n">lbuf_len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lbuf</span><span class="p">)</span><span class="o">-</span><span class="n">lbuf_len</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* stdin is EOF */</span>
</span><span class='line'>                <span class="n">debug</span><span class="p">(</span><span class="s">&quot;local input is EOF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f_hold_session</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">shutdown</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>        <span class="cm">/* no-more writing */</span>
</span><span class='line'>                <span class="n">f_local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                <span class="n">close_reason</span> <span class="o">=</span> <span class="n">REASON_CLOSED_BY_LOCAL</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* error on reading from stdin */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">f_hold_session</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;failed to read from local</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">f_local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">close_reason</span> <span class="o">=</span> <span class="n">REASON_CLOSED_BY_LOCAL</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>                    <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;recv() failed, errno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* repeat */</span>
</span><span class='line'>                <span class="n">lbuf_len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* flush data in buffer to socket */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">lbuf_len</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">len</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">lbuf</span><span class="p">,</span> <span class="n">lbuf_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;send() failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">f_debug</span> <span class="p">)</span>              <span class="cm">/* more verbose */</span>
</span><span class='line'>                    <span class="n">report_bytes</span><span class="p">(</span> <span class="s">&quot;&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">lbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>                <span class="cm">/* move data on to top of buffer */</span>
</span><span class='line'>                <span class="n">debug</span><span class="p">(</span><span class="s">&quot;sent %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>                <span class="n">lbuf_len</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">lbuf_len</span> <span class="p">)</span>
</span><span class='line'>                    <span class="n">memcpy</span><span class="p">(</span> <span class="n">lbuf</span><span class="p">,</span> <span class="n">lbuf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">lbuf_len</span> <span class="p">);</span>
</span><span class='line'>                <span class="n">assert</span><span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">lbuf_len</span> <span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* flush data in buffer to local output */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">rbuf_len</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">local_type</span> <span class="o">==</span> <span class="n">LOCAL_SOCKET</span><span class="p">)</span>
</span><span class='line'>                <span class="n">len</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span> <span class="n">local_out</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rbuf_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="n">len</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span> <span class="n">local_out</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rbuf_len</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;output (local) failed, errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">rbuf_len</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">rbuf_len</span> <span class="p">)</span>
</span><span class='line'>                <span class="n">memcpy</span><span class="p">(</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rbuf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">rbuf_len</span> <span class="p">);</span>
</span><span class='line'>            <span class="n">assert</span><span class="p">(</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">rbuf_len</span> <span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">f_local</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">f_hold_session</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;closing local port without disconnecting from remote</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">f_remote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">shutdown</span> <span class="p">(</span><span class="n">local_out</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>            <span class="n">close</span> <span class="p">(</span><span class="n">local_out</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">close_reason</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">accept_connection</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">port</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">connection</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">name</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">client</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">socklen</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fd_set</span> <span class="n">ifds</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">nfds</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">sockopt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Create the socket. */</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Creating source port to forward.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span> <span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;socket() failed, errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>    <span class="n">sockopt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">setsockopt</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span>
</span><span class='line'>                <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sockopt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sockopt</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Give the socket a name. */</span>
</span><span class='line'>    <span class="n">name</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>    <span class="n">name</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span> <span class="p">(</span><span class="n">port</span><span class="p">);</span>
</span><span class='line'>    <span class="n">name</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span> <span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span> <span class="p">(</span><span class="s">&quot;bind() failed, errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span> <span class="p">(</span><span class="s">&quot;listen() failed, errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* wait for new connection with watching EOF of stdin. */</span>
</span><span class='line'>    <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;waiting new connection at port %d (socket=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
</span><span class='line'>    <span class="n">nfds</span> <span class="o">=</span> <span class="n">sock</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">ptmo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tmo</span><span class="p">;</span>
</span><span class='line'>        <span class="n">tmo</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">tmo</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>                 <span class="cm">/* On Windows, 100ms timeout */</span>
</span><span class='line'>        <span class="n">ptmo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmo</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* _WIN32 */</span><span class="cp"></span>
</span><span class='line'>        <span class="n">FD_ZERO</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ifds</span><span class="p">);</span>
</span><span class='line'>        <span class="n">FD_SET</span> <span class="p">((</span><span class="n">SOCKET</span><span class="p">)</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span><span class="p">);</span>
</span><span class='line'><span class="cp">#ifndef _WIN32</span>
</span><span class='line'>        <span class="n">FD_SET</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span><span class="p">);</span>                      <span class="cm">/* watch stdin */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>        <span class="n">n</span> <span class="o">=</span> <span class="n">select</span> <span class="p">(</span><span class="n">nfds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ptmo</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fatal</span> <span class="p">(</span><span class="s">&quot;select() failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>            <span class="n">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">stdindatalen</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">FD_SET</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span><span class="p">);</span>          <span class="cm">/* fake */</span>
</span><span class='line'>            <span class="n">n</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">getchar</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* EOF */</span>
</span><span class='line'>                <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;Give-up waiting port because stdin is closed.&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifds</span><span class="p">))</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>                          <span class="cm">/* socket is stimulated */</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">socklen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span class='line'>    <span class="n">connection</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span> <span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socklen</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">connection</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">fatal</span> <span class="p">(</span><span class="s">&quot;accept() failed, errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">connection</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/** Main of program **/</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">remote</span><span class="p">;</span>                                 <span class="cm">/* socket */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">local_in</span><span class="p">;</span>                               <span class="cm">/* Local input */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">local_out</span><span class="p">;</span>                              <span class="cm">/* Local output */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">reason</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'>    <span class="n">WSADATA</span> <span class="n">wsadata</span><span class="p">;</span>
</span><span class='line'>    <span class="n">WSAStartup</span><span class="p">(</span> <span class="mh">0x101</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsadata</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* _WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* initialization */</span>
</span><span class='line'>    <span class="n">make_revstr</span><span class="p">();</span>
</span><span class='line'>    <span class="n">getarg</span><span class="p">(</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Program is $Revision: 100 $</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Open local_in and local_out if forwarding a port */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">local_type</span> <span class="o">==</span> <span class="n">LOCAL_SOCKET</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* Relay between local port and destination */</span>
</span><span class='line'>        <span class="n">local_in</span> <span class="o">=</span> <span class="n">local_out</span> <span class="o">=</span> <span class="n">accept_connection</span><span class="p">(</span> <span class="n">local_port</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* Relay between stdin/stdout and desteination */</span>
</span><span class='line'>        <span class="n">local_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">local_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'>        <span class="n">_setmode</span><span class="p">(</span><span class="n">local_in</span><span class="p">,</span> <span class="n">O_BINARY</span><span class="p">);</span>
</span><span class='line'>        <span class="n">_setmode</span><span class="p">(</span><span class="n">local_out</span><span class="p">,</span> <span class="n">O_BINARY</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nl">retry</span><span class="p">:</span>
</span><span class='line'><span class="cp">#ifndef _WIN32</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">connect_timeout</span><span class="p">)</span>
</span><span class='line'>        <span class="n">set_timeout</span> <span class="p">(</span><span class="n">connect_timeout</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not _WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">check_direct</span><span class="p">(</span><span class="n">dest_host</span><span class="p">))</span>
</span><span class='line'>        <span class="n">relay_method</span> <span class="o">=</span> <span class="n">METHOD_DIRECT</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* make connection */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_DIRECT</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">remote</span> <span class="o">=</span> <span class="n">open_connection</span> <span class="p">(</span><span class="n">dest_host</span><span class="p">,</span> <span class="n">dest_port</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">remote</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span> <span class="s">&quot;Unable to connect to destination host, errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">remote</span> <span class="o">=</span> <span class="n">open_connection</span> <span class="p">(</span><span class="n">relay_host</span><span class="p">,</span> <span class="n">relay_port</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">remote</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span> <span class="s">&quot;Unable to connect to relay host, errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">socket_errno</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** resolve destination host (SOCKS) **/</span>
</span><span class='line'><span class="cp">#if !defined(_WIN32) &amp;&amp; !defined(__CYGWIN32__)</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">socks_ns</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">switch_ns</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">socks_ns</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not _WIN32 &amp;&amp; not __CYGWIN32__ */</span><span class="cp"></span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">relay_method</span> <span class="o">==</span> <span class="n">METHOD_SOCKS</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>        <span class="n">socks_resolve</span> <span class="o">==</span> <span class="n">RESOLVE_LOCAL</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>        <span class="n">local_resolve</span> <span class="p">(</span><span class="n">dest_host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest_addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Unknown host: %s&quot;</span><span class="p">,</span> <span class="n">dest_host</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** relay negociation **/</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span> <span class="n">relay_method</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">METHOD_SOCKS</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">socks_version</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">begin_socks5_relay</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
</span><span class='line'>             <span class="p">((</span><span class="n">socks_version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">begin_socks4_relay</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span> <span class="s">&quot;failed to begin relaying via SOCKS.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="nl">METHOD_HTTP</span><span class="p">:</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">begin_http_relay</span><span class="p">(</span><span class="n">remote</span><span class="p">);</span>
</span><span class='line'>        <span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">START_ERROR</span><span class="p">:</span>
</span><span class='line'>            <span class="n">close</span> <span class="p">(</span><span class="n">remote</span><span class="p">);</span>
</span><span class='line'>            <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;failed to begin relaying via HTTP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">START_OK</span><span class="p">:</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">START_RETRY</span><span class="p">:</span>
</span><span class='line'>            <span class="cm">/* retry with authentication */</span>
</span><span class='line'>            <span class="n">close</span> <span class="p">(</span><span class="n">remote</span><span class="p">);</span>
</span><span class='line'>            <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">METHOD_TELNET</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">begin_telnet_relay</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>             <span class="n">fatal</span><span class="p">(</span><span class="s">&quot;failed to begin relaying via telnet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef _WIN32</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">connect_timeout</span><span class="p">)</span>
</span><span class='line'>        <span class="n">set_timeout</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* not _WIN32 */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* main loop */</span>
</span><span class='line'>    <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;start relaying.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nl">do_repeater</span><span class="p">:</span>
</span><span class='line'>    <span class="n">reason</span> <span class="o">=</span> <span class="n">do_repeater</span><span class="p">(</span><span class="n">local_in</span><span class="p">,</span> <span class="n">local_out</span><span class="p">,</span> <span class="n">remote</span><span class="p">);</span>
</span><span class='line'>    <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;relaying done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">local_type</span> <span class="o">==</span> <span class="n">LOCAL_SOCKET</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>        <span class="n">reason</span> <span class="o">==</span> <span class="n">REASON_CLOSED_BY_LOCAL</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>        <span class="n">f_hold_session</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* re-wait at local port without closing remote session */</span>
</span><span class='line'>        <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;re-waiting at local port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local_port</span><span class="p">);</span>
</span><span class='line'>        <span class="n">local_in</span> <span class="o">=</span> <span class="n">local_out</span> <span class="o">=</span> <span class="n">accept_connection</span><span class="p">(</span> <span class="n">local_port</span> <span class="p">);</span>
</span><span class='line'>        <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;re-start relaying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">do_repeater</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">closesocket</span><span class="p">(</span><span class="n">remote</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">local_type</span> <span class="o">==</span> <span class="n">LOCAL_SOCKET</span><span class="p">)</span>
</span><span class='line'>        <span class="n">closesocket</span><span class="p">(</span><span class="n">local_in</span><span class="p">);</span>
</span><span class='line'><span class="cp">#ifdef _WIN32</span>
</span><span class='line'>    <span class="n">WSACleanup</span><span class="p">();</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* _WIN32 */</span><span class="cp"></span>
</span><span class='line'>    <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;that&#39;s all, bye.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* ------------------------------------------------------------</span>
</span><span class='line'><span class="cm">   Local Variables:</span>
</span><span class='line'><span class="cm">   compile-command: &quot;cc connect.c -o connect&quot;</span>
</span><span class='line'><span class="cm">   tab-width: 8</span>
</span><span class='line'><span class="cm">   fill-column: 74</span>
</span><span class='line'><span class="cm">   comment-column: 48</span>
</span><span class='line'><span class="cm">   End:</span>
</span><span class='line'><span class="cm">   ------------------------------------------------------------ */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*** end of connect.c ***/</span>
</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Dash</span></span>

           




<time class='entry-date' datetime='2013-11-18T16:49:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>4:49 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/linux/'>linux</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <div class="jiathis_style_24x24" style="text-indent: 0px; margin: 0px; padding: 0px; border-style: none; float: none; line-height: normal; font-size: 1px; vertical-align: baseline; display: inline-block;  background: transparent;">
    <a class="jiathis_button_weixin"></a>
    <a class="jiathis_button_tsina"></a>
  </div>
  
  
  
  
</div>

    
    <br />
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/11/18/using-hmc5883l-to-control-servo/" title="Previous Post: Using HMC5883L to control Servo">&laquo; Using HMC5883L to control Servo</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/11/18/use-reverse-ssh-for-across-something/" title="Next Post: Use Reverse SSH for Across Something">Use Reverse SSH for Across Something &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/05/18/working-tips-on-ansible-cobbler-3/">Working Tips on Ansible-cobbler(3)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/12/tips-on-maas-2-dot-0/">Tips on Maas 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/11/setup-lxd-on-ubuntu1604/">Setup LXD on Ubuntu1604</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/10/tips-on-lxc/">Tips on Lxc</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/09/working-tips-on-mesos-slash-ansible/">Working Tips on Mesos/Ansible</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://purplepalmdash.github.io/blog/2013/11/18/how-to-use-git-behind-the-firewall/';
        var disqus_url = 'http://purplepalmdash.github.io/blog/2013/11/18/how-to-use-git-behind-the-firewall/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>









<div style="display:none">
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2101056" charset="utf-8"></script>
</div>





</body>
</html>
