
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>三节点搭建OpenStack Juno(2) - Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="MySQL数据库 绝大多数的OpenStack服务使用SQL数据库来存储信息，一般情况下数据库运行在控制节点上，这里我们使用MariaDB或者MySQL来作为SQL数据库。 安装, 注意安装过程中需要输入密码: 1
# apt-get install mariadb-server python- &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno-2">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.useso.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">三节点搭建OpenStack Juno(2)</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-24T22:37:28+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:37 pm</span></time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3>MySQL数据库</h3>

<p>绝大多数的OpenStack服务使用SQL数据库来存储信息，一般情况下数据库运行在控制节点上，这里我们使用MariaDB或者MySQL来作为SQL数据库。</p>

<p>安装, 注意安装过程中需要输入密码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install mariadb-server python-mysqldb</span></code></pre></td></tr></table></div></figure>


<p>配置, 主要是更改了bind的地址，添加了一些有用选项，并支持UTF-8编码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/mysql/my.cnf
</span><span class='line'>[mysqld]
</span><span class='line'>...
</span><span class='line'>bind-address = 10.55.55.2
</span><span class='line'>...
</span><span class='line'>default-storage-engine = innodb
</span><span class='line'>innodb_file_per_table
</span><span class='line'>collation-server = utf8_general_ci
</span><span class='line'>init-connect = 'SET NAMES utf8'
</span><span class='line'>character-set-server = utf8</span></code></pre></td></tr></table></div></figure>


<p>完成安装，包括重启服务及加密数据库服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service mysql restart
</span><span class='line'># mysql_secure_installation </span></code></pre></td></tr></table></div></figure>


<h3>消息服务器</h3>

<p>OpenStack使用message broker用来在各种服务器之间调度操作和协调状态信息，通常情况下消息服务器也运行在控制节点上，OpenStack支持RabbitMQ, Qpid和ZeroMQ, 这里使用RabbitMQ.</p>

<p>安装:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install rabbitmq-server</span></code></pre></td></tr></table></div></figure>


<p>配置，首先我们需要设定rabbitMQ使用的密码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rabbitmqctl change_password guest RABBIT_PASS
</span><span class='line'>Changing password for user "guest" ...
</span><span class='line'>...done.</span></code></pre></td></tr></table></div></figure>


<p>如果是RabbitMQ 3.3.0或者更新的版本，则需要激活guest用户的远程访问权限。</p>

<p>检查RabbitMQ版本:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rabbitmqctl status | grep rabbit
</span><span class='line'>Status of node rabbit@Controller ...
</span><span class='line'> {running_applications,[{rabbit,"RabbitMQ","3.2.4"},</span></code></pre></td></tr></table></div></figure>


<p>这里我们的版本是3.2.4所以不需要做任何修改，直接重启RabbitMQ服务即可。若是3.3.0以后的版本，则需要参考官方文档作更为详细的配置。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service rabbitmq-server restart</span></code></pre></td></tr></table></div></figure>


<h3>鉴权(Identity)服务</h3>

<p>鉴权服务的作用主要有:   <br/>
1. 跟踪用户及其权限。   <br/>
2. 提供可用服务的服务类别及API endpoint.</p>

<p>详细的关于Identity的介绍可以参见OpenStack官方文档。只有理解了其理念后才能明了OpenStack架构中各种服务的角色和地位.</p>

<p>首先创建keystone所需要的数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mysql -u root -p
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 36
</span><span class='line'>Server version: 5.5.43-MariaDB-1ubuntu0.14.04.2 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; CREATE DATABASE keystone;
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \
</span><span class='line'>    -&gt; IDENTIFIED BY 'KEYSTONE_PASSWD';
</span><span class='line'>Query OK, 0 rows affected (0.01 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \
</span><span class='line'>    -&gt; IDENTIFIED BY 'KEYSTONE_PASSWD';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit;
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<p>创建一个随机值，用于管理token在初始化配置时使用:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># openssl rand -hex 10
</span><span class='line'>760bc221f4dc966693e5</span></code></pre></td></tr></table></div></figure>


<p>安装和配置组件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install keystone python-keystoneclient</span></code></pre></td></tr></table></div></figure>


<p>配置, 更改<code>admin_token</code>为刚才生成的随机数:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/keystone/keystone.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>admin_token = 760bc221f4dc966693e5
</span><span class='line'>...
</span><span class='line'>[database]
</span><span class='line'>...
</span><span class='line'>connection = mysql://keystone:KEYSTONE_DBPASS@Controller/keystone
</span><span class='line'>...
</span><span class='line'>[token]
</span><span class='line'>...
</span><span class='line'>provider = keystone.token.providers.uuid.Provider
</span><span class='line'>driver = keystone.token.persistence.backends.sql.Token
</span><span class='line'>...
</span><span class='line'>[revoke]
</span><span class='line'>...
</span><span class='line'>driver = keystone.contrib.revoke.backends.sql.Revoke
</span><span class='line'>...
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>verbose = True</span></code></pre></td></tr></table></div></figure>


<p>修改完毕后，使用以下命令来同步Identity服务数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># su -s /bin/sh -c "keystone-manage db_sync" keystone</span></code></pre></td></tr></table></div></figure>


<p>重启鉴权服务，删除Ubuntu使用的默认sqlite数据库, 并完成安装:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service keystone restart
</span><span class='line'># rm -f /var/lib/keystone/keystone.db </span></code></pre></td></tr></table></div></figure>


<p>使用下列命令来激活cron任务，以便每小时判断tokens的存活时间:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># (crontab -l -u keystone 2&gt;&1 | grep -q token_flush) || echo '@hourly /usr/bin/keystone-manage token_flush &gt;/var/log/keystone/keystone-tokenflush.log 2&gt;&1' &gt;&gt; /var/spool/cron/crontabs/keystone</span></code></pre></td></tr></table></div></figure>


<h4>创建tenants, users, roles</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># export OS_SERVICE_TOKEN=760bc221f4dc966693e5
</span><span class='line'># export OS_SERVICE_ENDPOINT=http://Controller:35357/v2.0
</span><span class='line'># keystone tenant-create --name admin --description "Admin Tenant"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |           Admin Tenant           |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 6f5f440aa9de4b2fa205f43df073ddfa |
</span><span class='line'>|     name    |              admin               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone user-create --name admin --pass XXXXXXXXX --email xxxxxxxx@gmail.com
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |        XXXXXXXX@gmail.com        |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | 7bc9be5493e345518a384383872ab274 |
</span><span class='line'>|   name   |              admin               |
</span><span class='line'>| username |              admin               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'># keystone role-create --name admin
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|    id    | 65b6ccaa3b434c848ccb757be43d6b41 |
</span><span class='line'>|   name   |              admin               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'># keystone user-role-add --user admin --tenant admin --role admin
</span><span class='line'># keystone tenant-create --name demo --description "Demo Tenant"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |           Demo Tenant            |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 459c25933274483fb01ce66d9514add6 |
</span><span class='line'>|     name    |               demo               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone user-create --name demo --tenant demo --pass xxxxx --email xxxxxxx@gmail.com
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |        xxxxxxx@gmail.com        |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | b2f3d8a239b34edfb50fa67c5aca8f83 |
</span><span class='line'>|   name   |               demo               |
</span><span class='line'>| tenantId | 459c25933274483fb01ce66d9514add6 |
</span><span class='line'>| username |               demo               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'># keystone tenant-create --name service --description "Service Tenant"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |          Service Tenant          |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 08a675be93a04cca8a74159a3eefa288 |
</span><span class='line'>|     name    |             service              |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone service-create --name keystone --type identity --description "OpenStack Identity"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |        OpenStack Identity        |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | bf7613d9563c47a9af80ecdb4f26f3f5 |
</span><span class='line'>|     name    |             keystone             |
</span><span class='line'>|     type    |             identity             |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone endpoint-create --service-id $(keystone service-list | awk '/ identity / {print $2}') --publicurl http://Controller:5000/v2.0 --internalurl http://Controller:5000/v2.0 --adminurl http://Controller:35357/v2.0 --region regionOne
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   adminurl  |   http://Controller:35357/v2.0   |
</span><span class='line'>|      id     | c2c7a6c24b1d411b996f2e30fefc70b6 |
</span><span class='line'>| internalurl |   http://Controller:5000/v2.0    |
</span><span class='line'>|  publicurl  |   http://Controller:5000/v2.0    |
</span><span class='line'>|    region   |            regionOne             |
</span><span class='line'>|  service_id | bf7613d9563c47a9af80ecdb4f26f3f5 |
</span><span class='line'>+-------------+----------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>验证, 详细的说明参见OpenStack官方文档:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># unset OS_SERVICE_TOKEN OS_SERVICE_ENDPOINT
</span><span class='line'># keystone --os-tenant-name admin --os-username admin --os-password xxxxx --os-auth-url http://Controller:35357/v2.0 token-get
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'>|  Property |              Value               |
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'>|  expires  |       2015-05-24T16:43:08Z       |
</span><span class='line'>|     id    | 612b529c9c754b87a153abd39284aff6 |
</span><span class='line'>| tenant_id | 6f5f440aa9de4b2fa205f43df073ddfa |
</span><span class='line'>|  user_id  | 7bc9be5493e345518a384383872ab274 |
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'># keystone --os-tenant-name admin --os-username admin --os-password xxxxx --os-auth-url http://Controller:35357/v2.0 tenant-list
</span><span class='line'>+----------------------------------+---------+---------+
</span><span class='line'>|                id                |   name  | enabled |
</span><span class='line'>+----------------------------------+---------+---------+
</span><span class='line'>| 6f5f440aa9de4b2fa205f43df073ddfa |  admin  |   True  |
</span><span class='line'>| 459c25933274483fb01ce66d9514add6 |   demo  |   True  |
</span><span class='line'>| 08a675be93a04cca8a74159a3eefa288 | service |   True  |
</span><span class='line'>+----------------------------------+---------+---------+
</span><span class='line'># keystone --os-tenant-name admin --os-username admin --os-password xxxxx --os-auth-url http://Controller:35357/v2.0 user-list
</span><span class='line'>+----------------------------------+-------+---------+--------------------+
</span><span class='line'>|                id                |  name | enabled |       email        |
</span><span class='line'>+----------------------------------+-------+---------+--------------------+
</span><span class='line'>| 7bc9be5493e345518a384383872ab274 | admin |   True  | xxxxxxx@gmail.com |
</span><span class='line'>| b2f3d8a239b34edfb50fa67c5aca8f83 |  demo |   True  | xxxxxxx@gmail.com |
</span><span class='line'>+----------------------------------+-------+---------+--------------------+
</span><span class='line'># keystone --os-tenant-name admin --os-username admin --os-password xxxxx --os-auth-url http://Controller:35357/v2.0 role-list
</span><span class='line'>+----------------------------------+----------+
</span><span class='line'>|                id                |   name   |
</span><span class='line'>+----------------------------------+----------+
</span><span class='line'>| 9fe2ff9ee4384b1894a90878d3e92bab | _member_ |
</span><span class='line'>| 65b6ccaa3b434c848ccb757be43d6b41 |  admin   |
</span><span class='line'>+----------------------------------+----------+
</span><span class='line'># keystone --os-tenant-name demo --os-username demo --os-password xxxxx --os-auth-url http://controller:35357/v2.0 token-get
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'>|  Property |              Value               |
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'>|  expires  |       2015-05-24T16:46:34Z       |
</span><span class='line'>|     id    | 0d8a9472b0f547dfabc62594b4fb146f |
</span><span class='line'>| tenant_id | 459c25933274483fb01ce66d9514add6 |
</span><span class='line'>|  user_id  | b2f3d8a239b34edfb50fa67c5aca8f83 |
</span><span class='line'>+-----------+----------------------------------+
</span><span class='line'># keystone --os-tenant-name demo --os-username demo --os-password xxxxx --os-auth-url http://controller:35357/v2.0 user-list
</span><span class='line'>You are not authorized to perform the requested action: admin_required (HTTP 403)
</span></code></pre></td></tr></table></div></figure>


<h3>创建脚本</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat admin-openrc.sh 
</span><span class='line'>export OS_TENANT_NAME=admin
</span><span class='line'>export OS_USERNAME=admin
</span><span class='line'>export OS_PASSWORD=xxxxx
</span><span class='line'>export OS_AUTH_URL=http://Controller:35357/v2.0
</span><span class='line'># cat demo-openrc.sh
</span><span class='line'>export OS_TENANT_NAME=demo
</span><span class='line'>export OS_USERNAME=demo
</span><span class='line'>export OS_PASSWORD=xxxxx
</span><span class='line'>export OS_AUTH_URL=http://Controller:5000/v2.0
</span></code></pre></td></tr></table></div></figure>


<p>下次使用时直接用<code>source admin-openrc.sh</code>或者<code>source demo-openrc.sh</code>即可。</p>

<h3>镜像服务</h3>

<p>添加镜像服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@Controller:~# mysql -u root -p
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 40
</span><span class='line'>Server version: 5.5.43-MariaDB-1ubuntu0.14.04.2 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; CREATE DATABASE glance;
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'xxxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'xxxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit;
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<p>创建glance用户:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># source  /home/dash/admin-openrc.sh
</span><span class='line'># keystone user-create --name glance --pass xxxxx
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |                                  |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | a3108e4267154acd809f3978d360e6cd |
</span><span class='line'>|   name   |              glance              |
</span><span class='line'>| username |              glance              |
</span><span class='line'>+----------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>赋予glance用户admin权限:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># keystone user-role-add --user glance --tenant service --role admin</span></code></pre></td></tr></table></div></figure>


<p>创建service entity和service end-point:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> keystone service-create --name glance --type image --description "OpenStack Image Service"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |     OpenStack Image Service      |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 8736ca50fdf741afb5fcc2d078b1cd9b |
</span><span class='line'>|     name    |              glance              |
</span><span class='line'>|     type    |              image               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'># keystone endpoint-create --service-id $(keystone service-list | awk '/ image / {print $2}') --publicurl http://Controller:9292 --internalurl http://Controller:9292 --adminurl http://Controller:9292 --region regionOne
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   adminurl  |      http://Controller:9292      |
</span><span class='line'>|      id     | 340f40f0558c4a5b8fa88089aee69767 |
</span><span class='line'>| internalurl |      http://Controller:9292      |
</span><span class='line'>|  publicurl  |      http://Controller:9292      |
</span><span class='line'>|    region   |            regionOne             |
</span><span class='line'>|  service_id | 8736ca50fdf741afb5fcc2d078b1cd9b |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>安装服务组件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install glance python-glanceclient</span></code></pre></td></tr></table></div></figure>


<p>配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/glance/glance-api.conf
</span><span class='line'>[database]
</span><span class='line'>...
</span><span class='line'>connection = mysql://glance:GLANCE_DBPASS@controller/glance
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>...
</span><span class='line'>auth_uri = http://controller:5000/v2.0
</span><span class='line'>identity_uri = http://controller:35357
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = glance
</span><span class='line'>admin_password = GLANCE_PASS
</span><span class='line'>[paste_deploy]
</span><span class='line'>...
</span><span class='line'>flavor = keystone
</span><span class='line'>[glance_store]
</span><span class='line'>...
</span><span class='line'>default_store = file
</span><span class='line'>filesystem_store_datadir = /var/lib/glance/images/
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>notification_driver = noop
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>verbose = True</span></code></pre></td></tr></table></div></figure>


<p>配置<code>/etc/glance/glance-registry.conf</code>文件，完成以下配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[database]
</span><span class='line'>...
</span><span class='line'>connection = mysql://glance:GLANCE_DBPASS@controller/glance
</span><span class='line'>
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>...
</span><span class='line'>auth_uri = http://controller:5000/v2.0
</span><span class='line'>identity_uri = http://controller:35357
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = glance
</span><span class='line'>admin_password = GLANCE_PASS
</span><span class='line'>[paste_deploy]
</span><span class='line'>...
</span><span class='line'>flavor = keystone
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>notification_driver = noop
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>notification_driver = noop</span></code></pre></td></tr></table></div></figure>


<p>同步数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># su -s /bin/sh -c "glance-manage db_sync" glance</span></code></pre></td></tr></table></div></figure>


<p>重启服务，删除默认的sqlite数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service glance-registry restart
</span><span class='line'># service glance-api restart
</span><span class='line'># rm -f /var/lib/glance/glance.sqlite
</span></code></pre></td></tr></table></div></figure>


<p>验证:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget http://download.cirros-cloud.net/0.3.3/cirros-0.3.3-x86_64-disk.img
</span><span class='line'># source ~/admin-openrc.sh
</span><span class='line'># glance image-create --name "cirros-0.3.3-x86_64" --file ~/cirros-0.3.3-x86_64-disk.img --disk-format qcow2 --container-format bare --is-public True --progress
</span><span class='line'>[=============================&gt;] 100%
</span><span class='line'>+------------------+--------------------------------------+
</span><span class='line'>| Property         | Value                                |
</span><span class='line'>+------------------+--------------------------------------+
</span><span class='line'>| checksum         | 133eae9fb1c98f45894a4e60d8736619     |
</span><span class='line'>| container_format | bare                                 |
</span><span class='line'>| created_at       | 2015-05-24T16:25:32                  |
</span><span class='line'>| deleted          | False                                |
</span><span class='line'>| deleted_at       | None                                 |
</span><span class='line'>| disk_format      | qcow2                                |
</span><span class='line'>| id               | 3d45ea58-731c-4eb5-bf30-db1b4bfe4f57 |
</span><span class='line'>| is_public        | True                                 |
</span><span class='line'>| min_disk         | 0                                    |
</span><span class='line'>| min_ram          | 0                                    |
</span><span class='line'>| name             | cirros-0.3.3-x86_64                  |
</span><span class='line'>| owner            | 6f5f440aa9de4b2fa205f43df073ddfa     |
</span><span class='line'>| protected        | False                                |
</span><span class='line'>| size             | 13200896                             |
</span><span class='line'>| status           | active                               |
</span><span class='line'>| updated_at       | 2015-05-24T16:25:32                  |
</span><span class='line'>| virtual_size     | None                                 |
</span><span class='line'>+------------------+--------------------------------------+
</span><span class='line'># glance image-list
</span><span class='line'>+--------------------------------------+---------------------+-------------+------------------+----------+--------+
</span><span class='line'>| ID                                   | Name                | Disk Format | Container Format | Size     | Status |
</span><span class='line'>+--------------------------------------+---------------------+-------------+------------------+----------+--------+
</span><span class='line'>| 3d45ea58-731c-4eb5-bf30-db1b4bfe4f57 | cirros-0.3.3-x86_64 | qcow2       | bare             | 13200896 | active |
</span><span class='line'>+--------------------------------------+---------------------+-------------+------------------+----------+--------+
</span></code></pre></td></tr></table></div></figure>


<p>控制节点基本上配置成功，明天继续。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Dash</span></span>

           




<time class='entry-date' datetime='2015-05-24T22:37:28+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:37 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/virtualization/'>virtualization</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <br />
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno/" title="Previous Post: 三节点搭建OpenStack Juno(1)">&laquo; 三节点搭建OpenStack Juno(1)</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/05/25/lxcize-the-kvm-machine/" title="Next Post: LXCize the KVM machine">LXCize the KVM machine &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/25/tips-on-deleteing-neutron-subnet-and-router/">Tips on Deleteing Neutron Subnet and Router</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/25/san-jie-dian-da-jian-openstack-juno-4/">三节点搭建OpenStack Juno(4)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/25/san-jie-dian-da-jian-openstack-juno-3/">三节点搭建OpenStack Juno(3)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/25/lxcize-the-kvm-machine/">LXCize the KVM Machine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno-2/">三节点搭建OpenStack Juno(2)</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://purplepalmdash.github.io/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno-2/';
        var disqus_url = 'http://purplepalmdash.github.io/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
