
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="Get the timstamp of the record ObjectID could automatically store the insert timestamp, see following command: 1
2
3
4
5
6
7
&gt; db.usercollection. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/posts/29">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.useso.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/12/porting-weather-app-into-node-dot-js-3/">Porting Weather APP Into Node.js(3)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-12T16:19:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:19 pm</span></time>
        
         | <a href="/blog/2014/07/12/porting-weather-app-into-node-dot-js-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Get the timstamp of the record</h3>

<p>ObjectID could automatically store the insert timestamp, see following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; db.usercollection.find().pretty()
</span><span class='line'>........
</span><span class='line'>........
</span><span class='line'>&gt; ObjectId("53be4e7eb5ca215e38c5f651").getTimestamp()
</span><span class='line'>ISODate("2014-07-10T08:27:42Z")
</span><span class='line'>&gt; ObjectId("53be4e7cb5ca215e38c5f650").getTimestamp()
</span><span class='line'>ISODate("2014-07-10T08:27:40Z")
</span></code></pre></td></tr></table></div></figure>


<h3>Time Format</h3>

<p>Run following commands to get the timestamp since 1970:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; day=new Date()
</span><span class='line'>Sat Jul 12 2014 21:15:10 GMT+0800 (CST)
</span><span class='line'>&gt; day
</span><span class='line'>Sat Jul 12 2014 21:15:10 GMT+0800 (CST)
</span><span class='line'>&gt; day.getTime()
</span><span class='line'>1405170910049
</span></code></pre></td></tr></table></div></figure>


<p>The date which we fetched should be multiply 1000.  <br/>
And write a for loop for getting out the real date:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  // helper function
</span><span class='line'>  function getDate(d) {
</span><span class='line'>      return new Date(d);
</span><span class='line'>  }
</span><span class='line'>  console.log("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@");
</span><span class='line'>  // Refers to 1405170910049
</span><span class='line'>  // WhatWeGet 1405170047
</span><span class='line'>  // Should multiply 1000, Print out all of the timestamp
</span><span class='line'>  for ( kk = 1; kk &lt; 24; kk++)
</span><span class='line'>  {
</span><span class='line'>     console.log(getDate(date_data[kk]*1000));
</span><span class='line'>  }
</span></code></pre></td></tr></table></div></figure>


<p>Print the type of the variable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>console.log(typeof (#{weatherlist[3].Temperature}));
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/12/hightlight-jade-file/">Hightlight Jade File</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-12T14:36:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:36 pm</span></time>
        
         | <a href="/blog/2014/07/12/hightlight-jade-file/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Install <code>vim-jade</code> via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Bundle 'digitaltoad/vim-jade'
</span></code></pre></td></tr></table></div></figure>


<p>Then in vim type <code>:BundleInstall</code> this will automatically install the plugin of vim-jade.   <br/>
Enable the Highlight of jade file via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>au BufNewFile,BufRead,BufReadPost *.jade set filetype=jade
</span></code></pre></td></tr></table></div></figure>


<p>Now everytime you open jade file, it will be automatically be highlighted.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/09/porting-weather-app-into-node-dot-js-2/">Porting Weather APP Into Node.js(2)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-09T10:34:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:34 am</span></time>
        
         | <a href="/blog/2014/07/09/porting-weather-app-into-node-dot-js-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Add packages dependencies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  "dependencies": {
</span><span class='line'>    "express": "^4.5.1",
</span><span class='line'>    "logfmt": "^1.1.2",
</span><span class='line'>    "static-favicon": "~1.0.0",
</span><span class='line'>    "morgan": "~1.0.0",
</span><span class='line'>    "cookie-parser": "~1.0.1",
</span><span class='line'>    "body-parser": "~1.0.0",
</span><span class='line'>    "debug": "~0.7.4",
</span><span class='line'>    "jade": "~1.3.0", 
</span><span class='line'>    "mongodb": "*",
</span><span class='line'>    "monk": "*"
</span><span class='line'>  },
</span></code></pre></td></tr></table></div></figure>


<p>Then <code>npm install</code> to install the dependencies.</p>

<p>Install the package and save the version in package.json:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>npm install forecast --save
</span><span class='line'>npm install cron --save
</span><span class='line'>npm install http --save
</span><span class='line'>npm install cheerio --save
</span></code></pre></td></tr></table></div></figure>


<p>Merge the TestNanjing.js and web.js file, let the fetch to be a function, or to be module.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/07/porting-weather-app-into-node-dot-js/">Porting Weather APP Into Node.js</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-07T18:36:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:36 pm</span></time>
        
         | <a href="/blog/2014/07/07/porting-weather-app-into-node-dot-js/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Website Design</h3>

<p>Use express for generating the whole website.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pwd 
</span><span class='line'>/home/Trusty/code/nodejs/weather
</span><span class='line'>[Trusty@~/code/nodejs/weather]$ express weather
</span></code></pre></td></tr></table></div></figure>


<p>The express framework will be generated.</p>

<p>Add following dependencies into the weather/package.json:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"jade": "~1.3.0", 
</span><span class='line'>"mongodb": "*",
</span><span class='line'>"monk": "*"
</span></code></pre></td></tr></table></div></figure>


<p>Install packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd weather
</span><span class='line'>$ npm install
</span></code></pre></td></tr></table></div></figure>


<p><code>mkdir data</code>, this command will create a directory named <code>data</code> which is used for holding our mongodb.  <br/>
Now visit <a href="http://localhost:3000/">http://localhost:3000/</a> you will see the demo html website.</p>

<p>This website should have the inteface for operating the database(MongoDB), so I will add some sub-pages for handling the request for insert and query the database.</p>

<h4>Insert Records Into MongoDB</h4>

<p>Design database in MongoDB:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mongo
</span><span class='line'>$ show dbs
</span><span class='line'>admin       (empty)
</span><span class='line'>local       0.078GB
</span><span class='line'>my-website  0.078GB
</span><span class='line'>mydb        0.078GB
</span><span class='line'>nodetest1   0.078GB
</span><span class='line'>test        (empty)
</span><span class='line'>$ use weathertest
</span></code></pre></td></tr></table></div></figure>


<p>The DataSet should be designed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>    "_id" : 1234,
</span><span class='line'>    "AQI" : "70",
</span><span class='line'>    "Level" : "良", 
</span><span class='line'>    "FirstPollution" : "臭氧1小时", 
</span><span class='line'>    "PM2_5" : "51", 
</span><span class='line'>    "PM10" : "70", 
</span><span class='line'>    "CO" : "0.148", 
</span><span class='line'>    "NO2" : "31", 
</span><span class='line'>    "O3_1hour" : "168", 
</span><span class='line'>    "O3_8hour" : "68", 
</span><span class='line'>    "S02" : "13" 
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>So the insert sentense should be like following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>db.usercollection.insert({ "AQI" : "70", "Level" : "良", "FirstPollution" : "臭氧1小时", "PM2_5" : "51", "PM10" : "70", "CO" : "0.148", "NO2" : "31", "O3_1hour" : "168", "O3_8hour" : "68", "SO2" :"13"})
</span></code></pre></td></tr></table></div></figure>


<p>Verify the insert result via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; db.usercollection.find().pretty()
</span><span class='line'>{
</span><span class='line'>  "_id" : ObjectId("53ba7e137346b7523d951084"),
</span><span class='line'>  "AQI" : "70",
</span><span class='line'>  "Level" : "良",
</span><span class='line'>  "FirstPollution" : "臭氧1小时",
</span><span class='line'>  "PM2_5" : "51",
</span><span class='line'>  "PM10" : "70",
</span><span class='line'>  "CO" : "0.148",
</span><span class='line'>  "NO2" : "31",
</span><span class='line'>  "O3_1hour" : "168",
</span><span class='line'>  "O3_8hour" : "68",
</span><span class='line'>  "SO2" : "13"
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Should add more informations into the database, for example the temperature/humidity, which could also be fetched via npm package.  <br/>
First delete the inserted item via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; db.usercollection.remove({"_id" : ObjectId("53ba7e137346b7523d951084")});
</span><span class='line'>WriteResult({ "nRemoved" : 1 })
</span><span class='line'>&gt; db.usercollection.find().pretty()
</span></code></pre></td></tr></table></div></figure>


<p>Then insert a new organized records and verify the insertion :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>db.usercollection.insert({ "Temperature" : "21.9", "DewPoint" : "19.93", "Humidity" : "0.89", "Pressure" : "1004.85", "Ozeone" : "289.03",  "AQI" : "70", "Level" : "良", "FirstPollution" : "臭氧1小时", "PM2_5" : "51", "PM10" : "70", "CO" : "0.148", "NO2" : "31", "O3_1hour" : "168", "O3_8hour" : "68", "SO2" :"13", "CurrentTime": "ISODate()"})
</span><span class='line'>&gt; db.usercollection.find().pretty()
</span><span class='line'>{
</span><span class='line'>  "_id" : ObjectId("53ba82f97346b7523d951085"),
</span><span class='line'>  "Temperature" : "21.9",
</span><span class='line'>  "DewPoint" : "19.93",
</span><span class='line'>  "Humidity" : "0.89",
</span><span class='line'>  "Pressure" : "1004.85",
</span><span class='line'>  "Ozeone" : "289.03",
</span><span class='line'>  "AQI" : "70",
</span><span class='line'>  "Level" : "良",
</span><span class='line'>  "FirstPollution" : "臭氧1小时",
</span><span class='line'>  "PM2_5" : "51",
</span><span class='line'>  "PM10" : "70",
</span><span class='line'>  "CO" : "0.148",
</span><span class='line'>  "NO2" : "31",
</span><span class='line'>  "O3_1hour" : "168",
</span><span class='line'>  "O3_8hour" : "68",
</span><span class='line'>  "SO2" : "13"
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>We will insert many many records into the database, how to distinguish them? By Timestamp!!!</p>

<p>In MongoDB we have the built-in Function Date():</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; Date()
</span><span class='line'>Mon Jul 07 2014 19:29:36 GMT+0800 (CST)
</span></code></pre></td></tr></table></div></figure>


<p>Each inserted Dataset&rsquo;s timestamp could be fetched out via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; ObjectId("53ba876d7346b7523d951088").getTimestamp()
</span><span class='line'>ISODate("2014-07-07T11:41:33Z")
</span></code></pre></td></tr></table></div></figure>


<p>Next step is using node.js api for processing the dataset.</p>

<h4>Display The Inserted Records</h4>

<p>We want to display the result like following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;ul&gt;
</span><span class='line'>    &lt;li&gt;Temperature: 21.9, DewPoint: 19.93, Humidity: 0.89, Pressure: 1004.85, Ozeone: 289.03, AQI: 70, Level: 良, FirstPollution: 臭氧1小时, PM2.5: 51, PM10: 70, CO: 0.148, NO2: 31, O3一小时： 168, O3八小时： 68, So2: 13。 &lt;/li&gt;
</span><span class='line'>    &lt;li&gt;Temperature: 21.9, DewPoint: 19.93, Humidity: 0.89, Pressure: 1004.85, Ozeone: 289.03, AQI: 70, Level: 良, FirstPollution: 臭氧1小时, PM2.5: 51, PM10: 70, CO: 0.148, NO2: 31, O3一小时： 168, O3八小时： 68, So2: 13。 &lt;/li&gt;
</span><span class='line'>    &lt;li&gt;Temperature: 21.9, DewPoint: 19.93, Humidity: 0.89, Pressure: 1004.85, Ozeone: 289.03, AQI: 70, Level: 良, FirstPollution: 臭氧1小时, PM2.5: 51, PM10: 70, CO: 0.148, NO2: 31, O3一小时： 168, O3八小时： 68, So2: 13。 &lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Change the router/index.js, add following lines:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* GET weatherlist page. */
</span><span class='line'>router.get('/weatherlist', function(req, res) {
</span><span class='line'>    var db = req.db;
</span><span class='line'>    var collection = db.get('usercollection');
</span><span class='line'>    collection.find({},{},function(e,docs){
</span><span class='line'>        res.render('weatherlist', {
</span><span class='line'>            "weatherlist" : docs
</span><span class='line'>        });
</span><span class='line'>    });
</span><span class='line'>});
</span></code></pre></td></tr></table></div></figure>


<p>Add the new file named <code>weatherlist.jade</code> under views/ folder:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>block content
</span><span class='line'>    h1.
</span><span class='line'>        Weather List
</span><span class='line'>    ul
</span><span class='line'>        each weather, i in weatherlist
</span><span class='line'>            li
</span><span class='line'>                首要污染物: #{weather.FirstPollution}, &lt;br /&gt;级别: #{weather.Level},&lt;br /&gt;AQI: #{weather.AQI},&lt;br /&gt;PM2.5: #{weather.PM2_5},&lt;br /&gt;PM10: #{weather.PM10}, &lt;br /&gt;一氧化碳: #{weather.CO}, &lt;br /&gt;二氧化氮: #{weather.NO2}, &lt;br /&gt;臭氧一小时浓度: #{weather.O3_1hour}, &lt;br /&gt;臭氧八小时浓度: #{weather.O3_8hour}, &lt;br /&gt;二氧化硫: #{weather.SO2}, &lt;br /&gt;温度: #{weather.Temperature}, &lt;br /&gt;露点: #{weather.DewPoint}, &lt;br /&gt;湿度: #{weather.Humidity}, &lt;br /&gt;气压: #{weather.Pressure}, &lt;br /&gt;Ozeone: #{weather.Ozeone}
</span></code></pre></td></tr></table></div></figure>


<p>Now visit <a href="http://localhost:3000/weatherlist">http://localhost:3000/weatherlist</a> we could see the record has been listed on the page.</p>

<h4>Insert Records In Nodejs</h4>

<p>We should use a crontab task for inserting the record once we fetched the data.  <br/>
The fetching process could be seperated from the web frame, or we could put the script into the directory, and let cron run it, it&rsquo;s OK.</p>

<p>Following is a sample code for inserting record into mongoDB:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* 
</span><span class='line'>* This example uses the node MongoDB module to connect to the local
</span><span class='line'>* mongodb database on this virtual machine
</span><span class='line'>*
</span><span class='line'>* More here: http://mongodb.github.io/node-mongodb-native/markdown-docs/insert.html
</span><span class='line'>*/
</span><span class='line'>
</span><span class='line'>//require node modules (see package.json)
</span><span class='line'>var MongoClient = require('mongodb').MongoClient
</span><span class='line'>    , format = require('util').format;
</span><span class='line'>
</span><span class='line'>//connect away
</span><span class='line'>MongoClient.connect('mongodb://127.0.0.1:27017/test', function(err, db) {
</span><span class='line'>  if (err) throw err;
</span><span class='line'>  console.log("Connected to Database");
</span><span class='line'>
</span><span class='line'>  //simple json record
</span><span class='line'>  var document = {name:"David1", title:"About MongoDB1"};
</span><span class='line'>  
</span><span class='line'>  //insert record
</span><span class='line'>  db.collection('test').insert(document, function(err, records) {
</span><span class='line'>      if (err) throw err;
</span><span class='line'>      console.log("Record added as "+records[0]._id);
</span><span class='line'>      //After insertion, close it.
</span><span class='line'>      db.close();
</span><span class='line'>      return;
</span><span class='line'>  });
</span><span class='line'>});
</span></code></pre></td></tr></table></div></figure>


<p>Once fetched, insert into the weathertest Database.</p>

<h4>Display How Many Items</h4>

<p>It should fetch the latest 24 items from the database, thus we should modify the code for fetching out 24 items.</p>

<p>Edit routes/index.js:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* GET weatherlist page. */
</span><span class='line'>router.get('/weatherlist', function(req, res) {
</span><span class='line'>    var db = req.db;
</span><span class='line'>    var collection = db.get('usercollection');
</span><span class='line'>
</span><span class='line'>    collection.find({},{limit:24},function(e,docs){
</span><span class='line'>        res.render('weatherlist', {
</span><span class='line'>            "weatherlist" : docs
</span><span class='line'>        });
</span><span class='line'>    });
</span><span class='line'>
</span><span class='line'>});
</span></code></pre></td></tr></table></div></figure>


<h4>Deploy it on heroku</h4>

<p>Via following commands we could setup a brand new APP on heroku:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku login
</span><span class='line'>$ cat web.js
</span><span class='line'>// web.js
</span><span class='line'>var express = require("express");
</span><span class='line'>var logfmt = require("logfmt");
</span><span class='line'>var app = express();
</span><span class='line'>
</span><span class='line'>app.use(logfmt.requestLogger());
</span><span class='line'>
</span><span class='line'>app.get('/', function(req, res) {
</span><span class='line'>  res.send('Hello World!');
</span><span class='line'>});
</span><span class='line'>
</span><span class='line'>var port = Number(process.env.PORT || 5000);
</span><span class='line'>app.listen(port, function() {
</span><span class='line'>  console.log("Listening on " + port);
</span><span class='line'>});
</span><span class='line'>$ npm init
</span><span class='line'>$ npm install express logfmt --save
</span><span class='line'>$ cat package.json
</span><span class='line'>  "engines": {
</span><span class='line'>    "node": "0.10.x"
</span><span class='line'>  }
</span><span class='line'>$ cat Procfile 
</span><span class='line'>web: node web.js
</span><span class='line'>$ foreman start
</span><span class='line'>$ chromium http://localhost:5000
</span><span class='line'>$ git init
</span><span class='line'>$ git add .
</span><span class='line'>$ git commit -m "init"
</span><span class='line'>$ git remote add heroku git@heroku.com:node-weather-app.git
</span><span class='line'>$ git push heroku master
</span></code></pre></td></tr></table></div></figure>


<p>Now visit <a href="http://node-weather-app.herokuapp.com">http://node-weather-app.herokuapp.com</a> you can see &ldquo;Hello World!&rdquo;.</p>

<p>When adding MongoDB add-ons, it says failed with following information:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku addons:add mongolab
</span><span class='line'>Adding mongolab on node-weather-app... failed
</span><span class='line'> !    Please verify your account to install this add-on plan
</span><span class='line'> !    For more information, see https://devcenter.heroku.com/categories/billing
</span><span class='line'> !    Verify now at https://heroku.com/verify
</span></code></pre></td></tr></table></div></figure>


<p>Apply the free account at<a href="https://www.mongosoup.de/">https://www.mongosoup.de/</a>, then login and create a new database plan, Next time if you want to view your database, simply open your browser and go to <a href="https://controlpanel.mongosoup.de/">https://controlpanel.mongosoup.de/</a>.   <br/>
Click the Databases, and select the database, then <code>show password</code>, it will shows you with the Database info, something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Connection string:   mongodb://############:###########@dbs004.mongosoup.de/cc_KNoBTXxNbHhS
</span></code></pre></td></tr></table></div></figure>


<p>It seems the account failed, so I create a new account using another email, xxxxxxxxxx.  <br/>
This time the app&rsquo;s name is named nodeweatherapp
git@heroku.com:nodeweatherapp.git   <br/>
And this time we will use root account for uploading.</p>

<pre><code>    Git URL: git@heroku.com:nodeweather.gi
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/07/my-translator-in-archlinux-3/">My Translator in ArchLinux(3)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-07T14:15:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:15 pm</span></time>
        
         | <a href="/blog/2014/07/07/my-translator-in-archlinux-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Using radis for cache the dictionary.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># In C, it's simple to use do...while(), but in python, we need to judge the input, 
</span><span class='line'># Fortunately, the input is very simple, because get infos from RedisQue is blocking.
</span><span class='line'># Forever Listening...
</span><span class='line'>while True:
</span><span class='line'>    # Key in RedisQueue is 'dic', and we simply get its content:
</span><span class='line'>    q = RedisQueue('dic')
</span><span class='line'>    # cmdargs = q.get()
</span><span class='line'>    # cmdargs = str(sys.argv) ## args
</span><span class='line'>    to_be_refer_word = q.get()
</span><span class='line'>    try:
</span><span class='line'>        result = my_dict_reader.get_dict_by_word(str(to_be_refer_word))  ## Using args[1] for querying
</span><span class='line'>        print result[0].values()[0]       ## output result in terminal
</span><span class='line'>        result_str = "\'&lt;span color=\"green\" size=\"14000\"&gt;"+result[0].values()[0]+"&lt;/span&gt;\'"  ## Build the command line for notify-send
</span><span class='line'>        call(["notify-send", to_be_refer_word, result_str])       ## Call notify-send to print on screen, last for 5 seconds
</span><span class='line'>    except Exception, e:
</span><span class='line'>        print "Not Find!"
</span></code></pre></td></tr></table></div></figure>


<p>Then we write the query file named <code>refer.py</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/python2
</span><span class='line'># -*- coding: utf-8 -*-
</span><span class='line'># For using RedisQueue to fetch the refer words 
</span><span class='line'>import sys
</span><span class='line'>from RedisQueue import RedisQueue
</span><span class='line'>
</span><span class='line'>q = RedisQueue('dic')
</span><span class='line'>q.put(str(sys.argv[1]))
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>Add the following lines as <code>/usr/bin/mydic</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Using redis
</span><span class='line'>python2 /home/Trusty/code/python/mypython/stardict/refer.py $@
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>This will greatly improve the refer time, you could get the real-time result via <code>mydic New_Words</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/04/proto-thread-in-arduino/">Proto Thread in Arduino</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-04T19:09:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:09 pm</span></time>
        
         | <a href="/blog/2014/07/04/proto-thread-in-arduino/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I want to use RTOS on Arduino, but after reading the material I find it&rsquo;s not so easy to run another &ldquo;OS&rdquo; on Arduino. But I found this library which named &ldquo;Proto Thread&rdquo; which could afford me thread-like operation. Following is the steps for using this library for controlling 2 different threads.</p>

<h3>Installation of Proto Thread</h3>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/03/turn-joggler-into-a-real-digital-picture-frame/">Turn Joggler Into a Real Digital Picture Frame</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-03T14:26:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>2:26 pm</span></time>
        
         | <a href="/blog/2014/07/03/turn-joggler-into-a-real-digital-picture-frame/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In fact Joggler initially is released as a digital picture frame, but I turned it into a linux server. Now It&rsquo;s time to turn this server back.</p>

<h3>Change RunLevel</h3>

<p>Edit the gdm.conf file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/init/gdm.conf
</span><span class='line'># gdm - GNOME Display Manager
</span><span class='line'>#
</span><span class='line'># The display manager service manages the X servers running on the
</span><span class='line'># system, providing login and auto-login services
</span><span class='line'>
</span><span class='line'>description     "GNOME Display Manager"
</span><span class='line'>author          "William Jon McCann &lt;mccann@jhu.edu&gt;"
</span><span class='line'>
</span><span class='line'>start on ((filesystem
</span><span class='line'>           and runlevel [!06]
</span><span class='line'>           # Without 03, assume our default level is 03
</span><span class='line'>           #and runlevel [!03]
</span></code></pre></td></tr></table></div></figure>


<p>To known your default run level, type:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># runlevel
</span><span class='line'>N 3
</span></code></pre></td></tr></table></div></figure>


<p>Then reboot the joggler, to see if you could get the gdm window.</p>

<p>Disable auto-logon via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/init/tty1.conf
</span><span class='line'>respawn
</span><span class='line'>#exec /sbin/mingetty -8 38400 tty1 Trusty -8 38400 tty1
</span><span class='line'>exec /sbin/getty -8 38400 tty1
</span></code></pre></td></tr></table></div></figure>


<p>Install lightdm via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install lightdm
</span><span class='line'>$ sudo dpkg-reconfigure lightdm
</span></code></pre></td></tr></table></div></figure>


<p>Enable auto-login to lightdm:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/lightdm/lightdm.conf 
</span><span class='line'>[SeatDefaults]
</span><span class='line'>autologin-user=Trusty
</span><span class='line'>autologin-user-timeout=0
</span><span class='line'>greeter-session=lightdm-gtk-greeter
</span><span class='line'>user-session=xubuntu
</span></code></pre></td></tr></table></div></figure>


<h3>Enable SlideShow</h3>

<p>Find out the resolution via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ xrandr | grep '*'
</span><span class='line'>   800x480        60.0* 
</span></code></pre></td></tr></table></div></figure>


<p>Install essential software:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install feh
</span><span class='line'>$ sudo apt-get install unclutter
</span></code></pre></td></tr></table></div></figure>


<p>In fact using feh is not good enough for setting the screenSaver, at last I use xscreensaver, it has a mode of glslideshow, you can specify your own directory.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/03/smtp-problem-solving/">SMTP Problem Solving</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-03T10:30:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>10:30 am</span></time>
        
         | <a href="/blog/2014/07/03/smtp-problem-solving/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I&rsquo;ve set up a ticket system, OTRS, which uses smtp for sending out email. It works well in my virtual machine, and in my own server. But when deploying it onto the lab PC, it cannot send out email via smtp. Following is the solving procedure for this problem.</p>

<h3>SMTP Server</h3>

<p>When Login into the server, following is how to using smtp for sending out email.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ telnet localhost 25
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to localhost.
</span><span class='line'>Escape character is '^]'.
</span><span class='line'>220 nxxxxx.xxx.fukcfuck-fugkock.com ESMTP Sendmail 8.14.5+Sun/8.13.3; Thu, 26 Jun 2014 06:43:37 -0500 (CDT)
</span><span class='line'>ehlo localhost
</span><span class='line'>250-nxxxxx.xxx.fukcfuck-fugkock.com Hello localhost [127.0.0.1], pleased to meet you
</span><span class='line'>250-ENHANCEDSTATUSCODES
</span><span class='line'>250-PIPELINING
</span><span class='line'>250-EXPN
</span><span class='line'>250-VERB
</span><span class='line'>250-8BITMIME
</span><span class='line'>250-SIZE
</span><span class='line'>250-DSN
</span><span class='line'>250-ETRN
</span><span class='line'>250-DELIVERBY
</span><span class='line'>250 HELP
</span><span class='line'>mail from: kkkkk@xxxxxx.xx.fugkock.com
</span><span class='line'>250 2.1.0 kkkkk@xxxxxx.xx.fugkock.com... Sender ok
</span><span class='line'>rcpt to:xxx_xxx.mao@fukcfuck-fugkock.com
</span><span class='line'>250 2.1.5 xxx_xxx.mao@fukcfuck-fugkock.com... Recipient ok
</span><span class='line'>data
</span><span class='line'>Subjet:354 Enter mail, end with "." on a line by itself
</span><span class='line'>Hi,
</span><span class='line'>Are you there?
</span><span class='line'>regards,
</span><span class='line'>Admin
</span><span class='line'>.
</span><span class='line'>250 2.0.0 s5QBhbEu014970 Message accepted for delivery
</span><span class='line'>quit
</span><span class='line'>221 2.0.0 xxxxxx.xxx.fukcfuck-fugkock.com closing connection
</span><span class='line'>Connection to localhost closed by foreign host.
</span></code></pre></td></tr></table></div></figure>


<h3>Error message</h3>

<p>When sending out the /var/log/messages will record the failure message, like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Jul  1 00:57:10 Linux01 OTRS-CGI-37[2757]: [Info][Kernel::System::CustomerUser::DB::CustomerUserAdd] CustomerUser: '9988@qq.com' created successfully (1)!
</span><span class='line'>Jul  1 00:57:10 Linux01 OTRS-CGI-37[2757]: [Notice][Kernel::System::CustomerUser::DB::SetPassword] CustomerUser: '9988@qq.com' changed password successfully!
</span><span class='line'>Jul  1 00:57:12 Linux01 OTRS-CGI-37[2757]: [Error][Kernel::System::Email::SMTP::Send][Line:139]: Can't send to '9988@qq.com': 5505.7.1 &lt;9988@qq.com&gt;... Relaying denied. IP name lookup failed [104.xxx.xxx.53]#012! Enable Net::SMTP debug for more info!
</span><span class='line'>Jul  1 00:57:12 Linux01 OTRS-CGI-37[2757]: [Info][Kernel::System::Email::Send] Error sending message
</span></code></pre></td></tr></table></div></figure>


<p>It says the IP name lookup failed.</p>

<h3>Bug Shooting</h3>

<p>Use tcpdump for capturing the package, comparing to the normal package.  <br/>
It indicates the message &ldquo;IP name lookup failed [104.xxx.xxx.53]&rdquo;, so I guess this may caused by reverse refer of smtp server.</p>

<p>Use dnslookup for the correct record:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Trusty@Linux01 ~]$ nslookup 104.xxx.xxx.53
</span><span class='line'>Server:        104.xxx.xxx.xxx
</span><span class='line'>Address:    104.xxx.xxx.xxx#53
</span><span class='line'>
</span><span class='line'>** server can't find 53.xxx.xxx.104.in-addr.arpa.: NXDOMAIN
</span><span class='line'>
</span><span class='line'>=============================================================
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[Trusty@Linux01 ~]$ nslookup 104.xxx.xxx.240
</span><span class='line'>Server:        104.xxx.xxx.xxx
</span><span class='line'>Address:    104.xxx.xxx.xxx#53
</span><span class='line'>
</span><span class='line'>Non-authoritative answer:
</span><span class='line'>240.xxx.xxx.104.in-addr.arpa    name = xxxxxxxx.xx.fukcfuck-fugkock.com.
</span></code></pre></td></tr></table></div></figure>


<p>So the solution is quite clear: If we give 104.xxx.xxx.140 a name, we could easily reached this machine from smtp server, thus the problem may be solved.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/29/otrs-on-ubuntu/">OTRS on Ubuntu</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-29T16:00:00+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:00 pm</span></time>
        
         | <a href="/blog/2014/06/29/otrs-on-ubuntu/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>First get the source code from official website, and untar it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo tar xjvf otrs-3.3.8.tar.bz2 -C /opt/
</span><span class='line'>$ cd /opt
</span><span class='line'>$ sudo mv otrs-3.3.8/ otrs
</span></code></pre></td></tr></table></div></figure>


<p>Check the modules :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ /opt/otrs/bin/otrs.CheckModules.pl
</span></code></pre></td></tr></table></div></figure>


<p>Install following packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install liblwp-useragent-determined-perl libapache2-mod-perl2 libnet-dns-perl libnet-smtp-ssl-perl libnet-smtp-tls-butmaintained-perl libyaml-perl
</span><span class='line'>$ sudo apt-get install libgd-text-perl libjson-xs-perl libpdf-api2-perl libtext-csv-xs-perl libxml-parser-perl
</span></code></pre></td></tr></table></div></figure>


<p>Add corresponding users and group:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo useradd -d /opt/otrs/ -c 'OTRS user' otrs
</span><span class='line'>$ sudo usermod -G www-data otrs
</span></code></pre></td></tr></table></div></figure>


<p>Create the OTRS Config Files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pwd
</span><span class='line'>/opt/otrs
</span><span class='line'>$ sudo cp Kernel/Config.pm.dist Kernel/Config.pm
</span><span class='line'>$ sudo cp Kernel/Config/GenericAgent.pm.dist Kernel/Config/GenericAgent.pm
</span></code></pre></td></tr></table></div></figure>


<p>Check dependencies via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ perl -cw /opt/otrs/bin/cgi-bin/index.pl
</span><span class='line'>/opt/otrs/bin/cgi-bin/index.pl syntax OK
</span><span class='line'>$ perl -cw /opt/otrs/bin/cgi-bin/customer.pl
</span><span class='line'>/opt/otrs/bin/cgi-bin/customer.pl syntax OK
</span><span class='line'>$ perl -cw /opt/otrs/bin/otrs.PostMaster.pl
</span><span class='line'>/opt/otrs/bin/otrs.PostMaster.pl syntax OK
</span></code></pre></td></tr></table></div></figure>


<p>Set permission:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo bin/otrs.SetPermissions.pl --otrs-user=otrs --web-user=www-data --otrs-group=www-data --web-group=www-data /opt/otrs
</span></code></pre></td></tr></table></div></figure>


<p>Now Set the conf file for apache2:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo cp /opt/otrs/scripts/apache2-httpd.include.conf /etc/apache2/sites-available/otrs
</span><span class='line'>$ sudo ln -s /etc/apache2/sites-available/otrs.conf  /etc/apache2/sites-enabled/otrs
</span><span class='line'>$ sudo a2ensite otrs
</span><span class='line'>$ sudo service apache2 restart
</span></code></pre></td></tr></table></div></figure>


<p>Now go to following URL for installation:  <br/>
<a href="http://joggler.xxx.xxxx&lt;F2>.com/otrs/installer.pl">http://joggler.xxx.xxx..com/otrs/installer.pl</a></p>

<p>After installation, restart mysql and httpd, or you will meet <code>OTRS - Access denied for user otrs@localhost</code></p>

<p>Add crontab tasks via following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># su otrs
</span><span class='line'>$ cd /opt/otrs/var/cron
</span><span class='line'>$ pwd
</span><span class='line'>/opt/otrs/var/cron
</span><span class='line'>$ for foo in *.dist; do cp $foo `basename $foo .dist`; done
</span><span class='line'>$ /opt/otrs/bin/Cron.sh start
</span><span class='line'>/opt/otrs/var/cron
</span><span class='line'>Cron.sh - start/stop OTRS cronjobs
</span><span class='line'>Copyright (C) 2001-2012 OTRS AG, http://otrs.org/
</span><span class='line'>(using /opt/otrs) done
</span><span class='line'>$ crontab -l
</span></code></pre></td></tr></table></div></figure>


<p>Now everything goes OK, visit <a href="joggler.xxx.xxx.com/otrs/customer.pl">joggler.xxx.xxx..com/otrs/customer.pl</a> for visit the customer panel.</p>

<p>Change the password for root@localhost:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ./otrs.SetPassword.pl root@localhost PLATFORM
</span><span class='line'>Set password for user 'root@localhost'.
</span><span class='line'>Done.
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/28/install-and-configure-otrs-on-centos/">Install and Configure Otrs on CentOS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-28T19:10:00+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:10 pm</span></time>
        
         | <a href="/blog/2014/06/28/install-and-configure-otrs-on-centos/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Prerequisite</h3>

<p>Install following Packages under CentOS:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo yum install wget mysql-server mysql php-mysql httpd perl-URI perl-Net-DNS perl-IO-Socket-SSL perl-XML-Parser mod_perl perl-TimeDate perl-Net-DNS procmail perl perl-LDAP perl-Crypt-SSLeay
</span></code></pre></td></tr></table></div></figure>


<p>Now configure the mysqld via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo chkconfig --levels 235 mysqld on
</span><span class='line'>$ sudo service mysqld start
</span><span class='line'>$ sudo /usr/bin/mysql_secure_installation
</span><span class='line'>$ sudo chkconfig --levels 235 httpd on
</span></code></pre></td></tr></table></div></figure>


<h3>Install otrs</h3>

<p>Download the otrs from Official website, I downloaed the rpm package for CentOS, then install it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo rpm -ivh otrs-3.3.8-01.noarch.rpm 
</span></code></pre></td></tr></table></div></figure>


<p>As root do following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /etc/httpd/conf.d/
</span><span class='line'># cp zzz_otrs.conf otrs.conf
</span><span class='line'># service httpd start
</span></code></pre></td></tr></table></div></figure>


<p>We have to disable SELinux and delete all of the iptables rules:  <br/>
Close the SELinux via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/sysconfig/selinux
</span><span class='line'># This file controls the state of SELinux on the system.
</span><span class='line'># SELINUX= can take one of these three values:
</span><span class='line'>#       enforcing - SELinux security policy is enforced.
</span><span class='line'>#       permissive - SELinux prints warnings instead of enforcing.
</span><span class='line'>#       disabled - SELinux is fully disabled.
</span><span class='line'># SELINUX=permissive
</span><span class='line'>SELINUX=disabled
</span></code></pre></td></tr></table></div></figure>


<p>If you don&rsquo;t disable SELINUX, then you may meet following error message:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>消息: Kernel/Config.pm isn't writable!
</span><span class='line'>If you want to use the installer, set the Kernel/Config.pm writable for the webserver user!
</span></code></pre></td></tr></table></div></figure>


<p>After disable the SELINUX, Restart the computer.   <br/>
Flush all of the pre-defined iptables rules:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># iptables -F
</span><span class='line'># service iptables save
</span></code></pre></td></tr></table></div></figure>


<p>Now open the browser visit:
<a href="http://Your_Server/ostr/installer.pl">http://Your_Server/ostr/installer.pl</a></p>

<p>When Configurating the database, in the second step, the machine should be selected as <code>localhost</code>.</p>

<p>If you want to delete the otrs database, or if the installation step tells you otrs database exists, you can using following command for drop this database:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@CentOS conf.d]# mysqladmin -u root -p  drop otrs
</span><span class='line'>Enter password: 
</span><span class='line'>Dropping the database is potentially a very bad thing to do.
</span><span class='line'>Any data stored in the database will be destroyed.
</span><span class='line'>
</span><span class='line'>Do you really want to drop the 'otrs' database [y/N] y
</span><span class='line'>Database "otrs" dropped
</span></code></pre></td></tr></table></div></figure>


<h3>Configuration of otrs</h3>

<p>The start page at:  <br/>
<a href="http://Your_Machine/otrs/index.pl">http://Your_Machine/otrs/index.pl</a></p>

<p>Customer Start page:   <br/>
<a href="http://Your_Machine/otrs/customer.pl">http://Your_Machine/otrs/customer.pl</a></p>

<p>Enable the crons tasks(mandantory):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ su root
</span><span class='line'># su -m otrs -c 'cd /opt/otrs/bin/ && ./Cron.sh start'
</span><span class='line'># crontab -l -u otrs
</span></code></pre></td></tr></table></div></figure>


<p>Add dynamic field via:  <br/>
系统管理->工单设置->动态字段， at the field of &ldquo;工单&rdquo;, click it and then you can add the customized field.  This will affect customer&rsquo;s submitted ticket forms.</p>

<p>Change smtp configuration:  <br/>
系统管理->系统配置-> 搜索<code>smtp</code>, you will meet Core::Sendmail, define the corresponding field and types, then you can use smtp for sending emails.</p>

<h3>Uninstall otrs</h3>

<p>Finally the team didn&rsquo;t use otrs, but its email annoyed me for a long time. Finally I found it&rsquo;s this machine who runs otrs. so I just login to 53, and run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rpm -e otrs
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>Also remove the crontab jobs and etc.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># su -m otrs 
</span><span class='line'>bash: /root/.bashrc: Permission denied
</span><span class='line'>bash-4.1$ ./Cron.sh stop
</span><span class='line'>/opt/otrs/bin
</span><span class='line'>Cron.sh - start/stop OTRS cronjobs
</span><span class='line'>Copyright (C) 2001-2012 OTRS AG, http://otrs.org/
</span><span class='line'>done
</span><span class='line'>[root@Linux01 conf.d]# crontab -l -u otrs
</span><span class='line'>no crontab for otrs
</span></code></pre></td></tr></table></div></figure>


<p>Also remove the configuration file under /etc/httpd/conf.d/otrs.conf, then restart the httpd server.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/30">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/28">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/10/09/20151009bei-zhu/">20151009备注</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/08/20151008bei-zhu/">20151008备注</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/08/dockerize-markdown-written-cv/">Dockerize Markdown Written CV</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/22/sharing-mouse-slash-keyboard-among-3-nodes/">Sharing Mouse/Keyboard Among 3 Nodes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/10/trouble-shooting-on-chromeoss-crouton-updating/">Trouble-Shooting on ChromeOS's Crouton Updating</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
