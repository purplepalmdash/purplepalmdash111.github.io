
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="Neutron Database Follow following steps for create the database: 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
root@ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/posts/12">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.useso.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-5/">安装Icehouse@Ubuntu14.04(5)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-13T19:17:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:17 pm</span></time>
        
         | <a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-5/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Neutron Database</h3>

<p>Follow following steps for create the database:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# mysql -u root -p
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 58
</span><span class='line'>Server version: 5.5.41-MariaDB-1ubuntu0.14.04.1 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2014, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; CREATE DATABASE neutron;
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'xxxxx'
</span><span class='line'>    -&gt; ;
</span><span class='line'>Query OK, 0 rows affected (0.01 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'xxxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; flush privileges;
</span><span class='line'>Query OK, 0 rows affected (0.01 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<h3>Keystone items</h3>

<p>创建用户:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# source ~/openstack/admin-openrc.sh
</span><span class='line'>root@JunoController:~# keystone user-create --name neutron --pass xxxxx
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |                                  |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | a4cbae42a2164c6e9a4c05c3f6835782 |
</span><span class='line'>|   name   |             neutron              |
</span><span class='line'>| username |             neutron              |
</span><span class='line'>+----------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>更改权限，服务为tenant, 角色是admin:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone user-role-add --user neutron --tenant service --role admin
</span></code></pre></td></tr></table></div></figure>


<p>创建服务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone service-create --name neutron --type network --description "OpenStack Networking"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |       OpenStack Networking       |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 1142b316e4e04061bb676b73d0cf6f68 |
</span><span class='line'>|     name    |             neutron              |
</span><span class='line'>|     type    |             network              |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>创建服务的end-point:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone endpoint-create --service-id $(keystone service-list | awk '/ network / {print $2}') --publicurl http://10.17.17.211:9696 --adminurl http://10.17.17.211:9696 --internalurl http://10.17.17.211:9696 --region regionOne
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   adminurl  |     http://10.17.17.211:9696     |
</span><span class='line'>|      id     | 77bb946d42dc4d099875ecc377510937 |
</span><span class='line'>| internalurl |     http://10.17.17.211:9696     |
</span><span class='line'>|  publicurl  |     http://10.17.17.211:9696     |
</span><span class='line'>|    region   |            regionOne             |
</span><span class='line'>|  service_id | 1142b316e4e04061bb676b73d0cf6f68 |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h3>安装组件</h3>

<p>在Controller端安装:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~#  apt-get -y install neutron-server neutron-plugin-ml2 python-neutronclient
</span></code></pre></td></tr></table></div></figure>


<p>取得tenant service id:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# source ~/openstack/admin-openrc.sh
</span><span class='line'>root@JunoController:~# keystone tenant-get service
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |          Service Tenant          |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 4b22bf4e6a68419aa91da6e0ffaca2dc |
</span><span class='line'>|     name    |             service              |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>编辑nova配置文件，修改如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# vim /etc/neutron/neutron.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>rpc_backend = neutron.openstack.common.rpc.impl_kombu
</span><span class='line'>rabbit_host = 10.17.17.211
</span><span class='line'>rabbit_password = xxxxx
</span><span class='line'>
</span><span class='line'>notify_nova_on_port_status_changes = True
</span><span class='line'>notify_nova_on_port_data_changes = True
</span><span class='line'>nova_url = http://10.17.17.211:8774/v2
</span><span class='line'>nova_admin_username = nova
</span><span class='line'>nova_admin_tenant_id = 4b22bf4e6a68419aa91da6e0ffaca2dc
</span><span class='line'>nova_admin_password = xxxxx
</span><span class='line'>nova_admin_auth_url = http://10.17.17.211:35357/v2.0
</span><span class='line'>
</span><span class='line'>core_plugin = ml2
</span><span class='line'>service_plugins = router
</span><span class='line'>allow_overlapping_ips = True
</span><span class='line'>
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>auth_uri = http://10.17.17.211:5000
</span><span class='line'>auth_host = 10.17.17.211
</span><span class='line'>auth_port = 35357
</span><span class='line'>auth_protocol = http
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = neutron
</span><span class='line'>admin_password = xxxxx
</span><span class='line'>signing_dir = $state_path/keystone-signing
</span><span class='line'>[database]
</span><span class='line'>connection = mysql://neutron:xxxxx@10.17.17.211/neutron
</span></code></pre></td></tr></table></div></figure>


<p>编辑ML2(Modular Layer2)插件， 在控制节点上：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# vim /etc/neutron/plugins/ml2/ml2_conf.ini | more
</span><span class='line'>[ml2]
</span><span class='line'>type_drivers = gre
</span><span class='line'>tenant_network_types = gre
</span><span class='line'>mechanism_drivers = openvswitch
</span><span class='line'>
</span><span class='line'>[ml2_type_gre]
</span><span class='line'>tunnel_id_ranges = 1:1000
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[securitygroup]
</span><span class='line'># Controls if neutron security group is enabled or not.
</span><span class='line'># It should be false when you use nova security group.
</span><span class='line'># enable_security_group = True
</span><span class='line'>firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
</span><span class='line'>enable_security_group = True
</span></code></pre></td></tr></table></div></figure>


<p>调整Compute Service使用Neutron服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/nova/nova.conf
</span><span class='line'>network_api_class = nova.network.neutronv2.api.API
</span><span class='line'>neutron_url = http://10.17.17.211:9696
</span><span class='line'>neutron_auth_strategy = keystone
</span><span class='line'>neutron_admin_tenant_name = service
</span><span class='line'>neutron_admin_username = neutron
</span><span class='line'>neutron_admin_password = xxxxx
</span><span class='line'>neutron_admin_auth_url = http://10.17.17.211:35357/v2.0
</span><span class='line'>linuxnet_interface_driver = nova.network.linux_net.LinuxOVSInterfaceDriver
</span><span class='line'>firewall_driver = nova.virt.firewall.NoopFirewallDriver
</span><span class='line'>security_group_api = neutron
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>重启服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service nova-api restart
</span><span class='line'># service nova-scheduler restart
</span><span class='line'># service nova-conductor restart
</span></code></pre></td></tr></table></div></figure>


<p>重启网络服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service neutron-server restart
</span></code></pre></td></tr></table></div></figure>


<p>检查是否完成的命令:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# neutron ext-list
</span><span class='line'>+-----------------------+-----------------------------------------------+
</span><span class='line'>| alias                 | name                                          |
</span><span class='line'>+-----------------------+-----------------------------------------------+
</span><span class='line'>| security-group        | security-group                                |
</span><span class='line'>| l3_agent_scheduler    | L3 Agent Scheduler                            |
</span><span class='line'>| ext-gw-mode           | Neutron L3 Configurable external gateway mode |
</span><span class='line'>| binding               | Port Binding                                  |
</span><span class='line'>| provider              | Provider Network                              |
</span><span class='line'>| agent                 | agent                                         |
</span><span class='line'>| quotas                | Quota management support                      |
</span><span class='line'>| dhcp_agent_scheduler  | DHCP Agent Scheduler                          |
</span><span class='line'>| multi-provider        | Multi Provider Network                        |
</span><span class='line'>| external-net          | Neutron external network                      |
</span><span class='line'>| router                | Neutron L3 Router                             |
</span><span class='line'>| allowed-address-pairs | Allowed Address Pairs                         |
</span><span class='line'>| extra_dhcp_opt        | Neutron Extra DHCP opts                       |
</span><span class='line'>| extraroute            | Neutron Extra Route                           |
</span><span class='line'>+-----------------------+-----------------------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h3>配置网络节点</h3>

<p>激活以下选项:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# vim /etc/sysctl.conf
</span><span class='line'>net.ipv4.ip_forward=1
</span><span class='line'>net.ipv4.conf.all.rp_filter=0
</span><span class='line'>net.ipv4.conf.default.rp_filter=0
</span><span class='line'>net.bridge.bridge-nf-call-arptables=1
</span><span class='line'>net.bridge.bridge-nf-call-iptables=1
</span><span class='line'>net.bridge.bridge-nf-call-ip6tables=1
</span></code></pre></td></tr></table></div></figure>


<p>提交更改(这里有错误):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# sysctl -p
</span><span class='line'>net.ipv4.ip_forward = 1
</span><span class='line'>net.ipv4.conf.all.rp_filter = 0
</span><span class='line'>net.ipv4.conf.default.rp_filter = 0
</span><span class='line'>sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-arptables: No such file or directory
</span><span class='line'>sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory
</span><span class='line'>sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory
</span></code></pre></td></tr></table></div></figure>


<p>安装网络组件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# apt-get install neutron-plugin-ml2 neutron-plugin-openvswitch-agent neutron-l3-agent neutron-dhcp-agent
</span></code></pre></td></tr></table></div></figure>


<p>配置通用组件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/neutron/neutron.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>rpc_backend = neutron.openstack.common.rpc.impl_kombu
</span><span class='line'>rabbit_host = 10.17.17.211
</span><span class='line'>rabbit_password = xxxxx
</span><span class='line'>core_plugin = ml2
</span><span class='line'>service_plugins = router
</span><span class='line'>allow_overlapping_ips = True
</span><span class='line'>verbose = True
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>auth_uri = http://10.17.17.211:5000
</span><span class='line'>auth_host = 10.17.17.211
</span><span class='line'>auth_port = 35357
</span><span class='line'>auth_protocol = http
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = neutron
</span><span class='line'>admin_password = xxxxx
</span></code></pre></td></tr></table></div></figure>


<p>编辑L3 agent:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/neutron/l3_agent.ini
</span><span class='line'>[DEFAULT]
</span><span class='line'>interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
</span><span class='line'>use_namespaces = True
</span><span class='line'>verbose = True
</span></code></pre></td></tr></table></div></figure>


<p>编辑DHCP插件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/neutron/dhcp_agent.ini
</span><span class='line'> [DEFAULT]
</span><span class='line'>interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
</span><span class='line'>dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
</span><span class='line'>use_namespaces = True
</span></code></pre></td></tr></table></div></figure>


<p>配置DHCP：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# vim /etc/neutron/dhcp_agent.ini
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>dnsmasq_config_file = /etc/neutron/dnsmasq-neutron.conf
</span><span class='line'>root@JunoNetwork:~# vim /etc/neutron/dnsmasp-neutron.conf
</span><span class='line'>dhcp-option-force=26,1454
</span></code></pre></td></tr></table></div></figure>


<p>配置metadata agent:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# vim /etc/neutron/metadata_agent.ini
</span><span class='line'>[DEFAULT]
</span><span class='line'>auth_url = http://10.17.17.211:5000/v2.0
</span><span class='line'>auth_region = regionOne
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = neutron
</span><span class='line'>admin_password = xxxxx
</span><span class='line'>nova_metadata_ip = 10.17.17.211
</span><span class='line'>metadata_proxy_shared_secret = xxxxx
</span></code></pre></td></tr></table></div></figure>


<p>回到controller节点，编辑:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/nova/nova.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>...
</span><span class='line'>service_neutron_metadata_proxy = true
</span><span class='line'>neutron_metadata_proxy_shared_secret = xxxxx
</span></code></pre></td></tr></table></div></figure>


<p>重启compute api服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># service nva-api restart
</span></code></pre></td></tr></table></div></figure>


<p>配置 ml2:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# vim /etc/neutron/plugins/ml2/ml2_conf.ini 
</span><span class='line'>[ml2]
</span><span class='line'>type_drivers = gre
</span><span class='line'>tenant_network_types = gre
</span><span class='line'>mechanism_drivers = openvswitch
</span><span class='line'>[ml2_type_gre]
</span><span class='line'>tunnel_id_ranges = 1:1000
</span><span class='line'>[ovs]
</span><span class='line'>local_ip = 10.19.19.212
</span><span class='line'>tunnel_type = gre
</span><span class='line'>enable_tunneling = True
</span><span class='line'>[securitygroup]
</span><span class='line'>firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
</span><span class='line'>enable_security_group = True
</span></code></pre></td></tr></table></div></figure>


<p>重启openvswitch 服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# service openvswitch-switch restart
</span></code></pre></td></tr></table></div></figure>


<p>增加bridge配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# ovs-vsctl add-br br-ex
</span><span class='line'>root@JunoNetwork:~# cat /etc/network/interfaces
</span><span class='line'>auto eth2
</span><span class='line'>iface eth2 inet manual
</span><span class='line'>
</span><span class='line'>iface br-ex inet static
</span><span class='line'>address 10.22.22.212
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>gateway 10.22.22.1
</span><span class='line'>bridge_ports eth2
</span><span class='line'>bridge_stp off
</span><span class='line'>auto br-ex
</span></code></pre></td></tr></table></div></figure>


<p>增加桥接端口，并且重启机器:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# ovs-vsctl add-port br-ex eth2
</span><span class='line'>root@JunoNetwork:~# reboot
</span></code></pre></td></tr></table></div></figure>


<h3>计算节点配置</h3>

<p>更改sysctl配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~# vim /etc/sysctl.conf
</span><span class='line'>net.ipv4.conf.all.rp_filter=0
</span><span class='line'>net.ipv4.conf.default.rp_filter=0
</span><span class='line'>net.bridge.bridge-nf-call-arptables=1
</span><span class='line'>net.bridge.bridge-nf-call-iptables=1
</span><span class='line'>net.bridge.bridge-nf-call-ip6tables=1
</span><span class='line'>root@JunoCompute:~# sysctl -p 
</span><span class='line'>net.ipv4.conf.all.rp_filter = 0
</span><span class='line'>net.ipv4.conf.default.rp_filter = 0
</span><span class='line'>net.bridge.bridge-nf-call-arptables = 1
</span><span class='line'>net.bridge.bridge-nf-call-iptables = 1
</span><span class='line'>net.bridge.bridge-nf-call-ip6tables = 1
</span></code></pre></td></tr></table></div></figure>


<p>安装下列包:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install neutron-common neutron-plugin-ml2 neutron-plugin-openvswitch-agent openvswitch-datapath-dkms
</span></code></pre></td></tr></table></div></figure>


<p>配置compute节点上的网络通用组件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~# vim /etc/neutron/neutron.conf
</span><span class='line'>    [DEFAULT]
</span><span class='line'>    auth_strategy = keystone
</span><span class='line'>    rpc_backend = neutron.openstack.common.rpc.impl_kombu
</span><span class='line'>    rabbit_host = controller
</span><span class='line'>    rabbit_password = xxxx
</span><span class='line'>    core_plugin = ml2
</span><span class='line'>    service_plugins = router
</span><span class='line'>    allow_overlapping_ips = True
</span><span class='line'>    verbose = True
</span><span class='line'>    [keystone_authtoken]
</span><span class='line'>    auth_uri = http://10.17.17.211:5000
</span><span class='line'>    auth_host = 10.17.17.211
</span><span class='line'>    auth_port = 35357
</span><span class='line'>    auth_protocol = http
</span><span class='line'>    admin_tenant_name = service
</span><span class='line'>    admin_user = neutron
</span><span class='line'>    admin_password = xxxx
</span><span class='line'>    signing_dir = $state_path/keystone-signing
</span><span class='line'>    [database]
</span><span class='line'>root@JunoCompute:~# vim /etc/neutron/plugins/ml2/ml2_conf.ini 
</span><span class='line'>    [DEFAULT]
</span><span class='line'>    ...
</span><span class='line'>    core_plugin = ml2
</span><span class='line'>    service_plugins = router
</span><span class='line'>    allow_overlapping_ips = True
</span><span class='line'>    [ml2]
</span><span class='line'>    ...
</span><span class='line'>    type_drivers = gre
</span><span class='line'>    tenant_network_types = gre
</span><span class='line'>    mechanism_drivers = openvswitch
</span><span class='line'>    [ml2_type_gre]
</span><span class='line'>    ...
</span><span class='line'>    tunnel_id_ranges = 1:1000
</span><span class='line'>    [ovs]
</span><span class='line'>    ...
</span><span class='line'>    local_ip = 10.19.19.213
</span><span class='line'>    tunnel_type = gre
</span><span class='line'>    enable_tunneling = True
</span><span class='line'>    [securitygroup]
</span><span class='line'>    ...
</span><span class='line'>    firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
</span><span class='line'>    enable_security_group = True
</span><span class='line'>root@JunoCompute:~# service openvswitch-switch restart
</span><span class='line'>root@JunoCompute:~# service nova-compute restart
</span><span class='line'>root@JunoCompute:~# service neutron-plugin-openvswitch-agent restart
</span></code></pre></td></tr></table></div></figure>


<p>接下来我们配置Compute节点上的nova,让它使用neutron作为网络管理器.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~# vim /etc/nova/nova.conf 
</span><span class='line'>[DEFAULT]
</span><span class='line'>network_api_class = nova.network.neutronv2.api.API
</span><span class='line'>neutron_url = http://10.17.17.211:9696
</span><span class='line'>neutron_auth_strategy = keystone
</span><span class='line'>neutron_admin_tenant_name = service
</span><span class='line'>neutron_admin_username = neutron
</span><span class='line'>neutron_admin_password = xxxx
</span><span class='line'>neutron_admin_auth_url = http://10.17.17.211:35357/v2.0
</span><span class='line'>linuxnet_interface_driver = nova.network.linux_net.LinuxOVSInterfaceDriver
</span><span class='line'>firewall_driver = nova.virt.firewall.NoopFirewallDriver
</span><span class='line'>security_group_api = neutron
</span></code></pre></td></tr></table></div></figure>


<p>修改完毕后，重启Compute节点上的服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~# service nova-compute restart
</span><span class='line'>nova-compute stop/waiting
</span><span class='line'>nova-compute start/running, process 2266
</span><span class='line'>root@JunoCompute:~# service neutron-plugin-openvswitch-agent restart
</span><span class='line'>stop: Unknown instance: 
</span><span class='line'>neutron-plugin-openvswitch-agent start/running, process 2303
</span></code></pre></td></tr></table></div></figure>


<p>配置Network节点的网络，因为我们需要br-ex作为对外网络的接口。  <br/>
配置网络如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ovs-vsctl add-br br-ex
</span><span class='line'># ovs-vsctl add-port br-ex eth2
</span><span class='line'># cat /etc/network/interfaces
</span><span class='line'># 
</span><span class='line'>auto eth2
</span><span class='line'>iface eth2 inet manual
</span><span class='line'>
</span><span class='line'>iface br-ex inet static
</span><span class='line'>address 10.22.22.212
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>gateway 10.22.22.1
</span><span class='line'>bridge_ports eth2
</span><span class='line'>bridge_stp off
</span><span class='line'>auto br-ex
</span><span class='line'># reboot
</span></code></pre></td></tr></table></div></figure>


<p>增加ext-net:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# neutron net-create ext-net --shared --router:external=True
</span><span class='line'>Created a new network:
</span><span class='line'>+---------------------------+--------------------------------------+
</span><span class='line'>| Field                     | Value                                |
</span><span class='line'>+---------------------------+--------------------------------------+
</span><span class='line'>| admin_state_up            | True                                 |
</span><span class='line'>| id                        | d879d5b1-f16e-4e28-beda-eb2b433e1f39 |
</span><span class='line'>| name                      | ext-net                              |
</span><span class='line'>| provider:network_type     | gre                                  |
</span><span class='line'>| provider:physical_network |                                      |
</span><span class='line'>| provider:segmentation_id  | 1                                    |
</span><span class='line'>| router:external           | True                                 |
</span><span class='line'>| shared                    | True                                 |
</span><span class='line'>| status                    | ACTIVE                               |
</span><span class='line'>| subnets                   |                                      |
</span><span class='line'>| tenant_id                 | ea1f0a6b15dc4796958f087c38756ed1     |
</span><span class='line'>+---------------------------+--------------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>外部子网：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# neutron subnet-create ext-net --name ext-subnet --allocation-pool start=10.22.22.10,end=10.22.22.50 --disable-dhcp --gateway 10.22.22.1 --gateway 10.22.22.1 10.22.22.10/24
</span><span class='line'>Created a new subnet:
</span><span class='line'>+------------------+------------------------------------------------+
</span><span class='line'>| Field            | Value                                          |
</span><span class='line'>+------------------+------------------------------------------------+
</span><span class='line'>| allocation_pools | {"start": "10.22.22.10", "end": "10.22.22.50"} |
</span><span class='line'>| cidr             | 10.22.22.0/24                                  |
</span><span class='line'>| dns_nameservers  |                                                |
</span><span class='line'>| enable_dhcp      | False                                          |
</span><span class='line'>| gateway_ip       | 10.22.22.1                                     |
</span><span class='line'>| host_routes      |                                                |
</span><span class='line'>| id               | 3c7e2224-0979-4eb6-b95f-16401ecbfef0           |
</span><span class='line'>| ip_version       | 4                                              |
</span><span class='line'>| name             | ext-subnet                                     |
</span><span class='line'>| network_id       | d879d5b1-f16e-4e28-beda-eb2b433e1f39           |
</span><span class='line'>| tenant_id        | ea1f0a6b15dc4796958f087c38756ed1               |
</span><span class='line'>+------------------+------------------------------------------------+
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# source openstack/demo-openrc.sh 
</span><span class='line'>root@JunoController:~# neutron net-create demo-net
</span><span class='line'>Created a new network:
</span><span class='line'>+----------------+--------------------------------------+
</span><span class='line'>| Field          | Value                                |
</span><span class='line'>+----------------+--------------------------------------+
</span><span class='line'>| admin_state_up | True                                 |
</span><span class='line'>| id             | 01c966ce-88cf-43a2-a7b7-2ebf6d6b6d60 |
</span><span class='line'>| name           | demo-net                             |
</span><span class='line'>| shared         | False                                |
</span><span class='line'>| status         | ACTIVE                               |
</span><span class='line'>| subnets        |                                      |
</span><span class='line'>| tenant_id      | 2ac9cae777014d3d94458f521b013e94     |
</span><span class='line'>+----------------+--------------------------------------+
</span><span class='line'>root@JunoController:~# neutron subnet-create demo-net --name demo-subnet --gateway 10.44.44.1 10.44.44.0/24
</span><span class='line'>Created a new subnet:
</span><span class='line'>+------------------+------------------------------------------------+
</span><span class='line'>| Field            | Value                                          |
</span><span class='line'>+------------------+------------------------------------------------+
</span><span class='line'>| allocation_pools | {"start": "10.44.44.2", "end": "10.44.44.254"} |
</span><span class='line'>| cidr             | 10.44.44.0/24                                  |
</span><span class='line'>| dns_nameservers  |                                                |
</span><span class='line'>| enable_dhcp      | True                                           |
</span><span class='line'>| gateway_ip       | 10.44.44.1                                     |
</span><span class='line'>| host_routes      |                                                |
</span><span class='line'>| id               | c6181123-f729-4ad2-bddc-93cfc761d0e1           |
</span><span class='line'>| ip_version       | 4                                              |
</span><span class='line'>| name             | demo-subnet                                    |
</span><span class='line'>| network_id       | 01c966ce-88cf-43a2-a7b7-2ebf6d6b6d60           |
</span><span class='line'>| tenant_id        | 2ac9cae777014d3d94458f521b013e94               |
</span><span class='line'>+------------------+------------------------------------------------+
</span><span class='line'>
</span><span class='line'>root@JunoController:~# neutron router-create demo-router
</span><span class='line'>Created a new router:
</span><span class='line'>+-----------------------+--------------------------------------+
</span><span class='line'>| Field                 | Value                                |
</span><span class='line'>+-----------------------+--------------------------------------+
</span><span class='line'>| admin_state_up        | True                                 |
</span><span class='line'>| external_gateway_info |                                      |
</span><span class='line'>| id                    | e5a010ba-371c-43d2-b3fb-a30e0dc5302b |
</span><span class='line'>| name                  | demo-router                          |
</span><span class='line'>| status                | ACTIVE                               |
</span><span class='line'>| tenant_id             | 2ac9cae777014d3d94458f521b013e94     |
</span><span class='line'>+-----------------------+--------------------------------------+
</span><span class='line'>
</span><span class='line'>root@JunoController:~# neutron router-interface-add demo-router demo-subnet
</span><span class='line'>Added interface c862f772-a1ef-4401-9a3b-2bdf5444e41b to router demo-router.
</span><span class='line'>
</span><span class='line'>root@JunoController:~# neutron router-gateway-set demo-router ext-net
</span><span class='line'>Set gateway for router demo-router
</span></code></pre></td></tr></table></div></figure>


<p>检查，在外网上ping 10.22.22.10这个地址，因为路由器占用了一个地址，所以如果能ping通这个地址，说明我们创建的网络是好的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root:~]# ping 10.22.22.212                                                                                                                    
</span><span class='line'>PING 10.22.22.212 (10.22.22.212) 56(84) bytes of data.                                                                                         
</span><span class='line'>64 bytes from 10.22.22.212: icmp_seq=1 ttl=64 time=0.152 ms                                                                                    
</span><span class='line'>64 bytes from 10.22.22.212: icmp_seq=2 ttl=64 time=0.136 ms    
</span></code></pre></td></tr></table></div></figure>


<p>检查agent状态:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# neutron agent-list
</span><span class='line'>+--------------------------------------+--------------------+-------------+-------+----------------+
</span><span class='line'>| id                                   | agent_type         | host        | alive | admin_state_up |
</span><span class='line'>+--------------------------------------+--------------------+-------------+-------+----------------+
</span><span class='line'>| 0b7191e1-ecd2-4808-b87a-f616d0a3bc7b | Metadata agent     | JunoNetwork | :-)   | True           |
</span><span class='line'>| 34511134-8392-44a9-a889-0ff03d85a995 | Open vSwitch agent | JunoCompute | :-)   | True           |
</span><span class='line'>| 474065d1-a50a-4d11-89d3-37c7a88e449c | DHCP agent         | JunoNetwork | :-)   | True           |
</span><span class='line'>| 5569c590-df83-4ee1-a073-15c908ef8d20 | L3 agent           | JunoNetwork | :-)   | True           |
</span><span class='line'>| a22c6e2a-7af0-4404-9e5b-46996b370672 | Open vSwitch agent | JunoNetwork | :-)   | True           |
</span><span class='line'>+--------------------------------------+--------------------+-------------+-------+----------------+
</span></code></pre></td></tr></table></div></figure>


<p>在 Compute Node 上的 OVS agent出现后，才能代表我们的网络配置成功。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-4/">安装Icehouse@Ubuntu14.04(4)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-13T17:34:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:34 pm</span></time>
        
         | <a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-4/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这里将配置计算节点。计算节点我们使用了一台2G内存的虚拟机，并使用了嵌套虚拟化，可以通过<code>lscpu</code>来看到CPU的VMX/VT-X标志都已经被下发到虚拟机中。</p>

<h3>数据库准备</h3>

<p>使用下列命令来创建nova所需数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# mysql -u root -p
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 35
</span><span class='line'>Server version: 5.5.41-MariaDB-1ubuntu0.14.04.1 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2014, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; CREATE DATABASE nova;
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' IDENTIFIED BY 'xxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' IDENTIFIED BY 'xxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; flush privileges;
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<h3>nova用户</h3>

<p>创建nova用户:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# source ~/openstack/admin-openrc.sh
</span><span class='line'>root@JunoController:~# keystone user-create --name nova --pass xxxx
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |                                  |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | 845c22d1a781458a8b28ba54534b73dd |
</span><span class='line'>|   name   |               nova               |
</span><span class='line'>| username |               nova               |
</span><span class='line'>+----------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>制定nova属于service tenant, 并赋予admin权限:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone user-role-add --user nova --tenant service --role admin
</span></code></pre></td></tr></table></div></figure>


<p>在keystone注册nova:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone service-create --name nova --type compute --description "OpenStack Compute"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |        OpenStack Compute         |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 8733caba0b9742a39ee9ac53ad4d8e27 |
</span><span class='line'>|     name    |               nova               |
</span><span class='line'>|     type    |             compute              |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>在keystone注册nova end-point:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone endpoint-create --service-id $(keystone service-list | awk '/ compute / {print $2}') --publicurl http://10.17.17.211:8774/v2/%\(tenant_id\)s --internalurl http://10.17.17.211:8774/v2/%\(tenant_id\)s --adminurl http://10.17.17.211:8774/v2/%\(tenant_id\)s --region regionOne
</span><span class='line'>+-------------+-------------------------------------------+
</span><span class='line'>|   Property  |                   Value                   |
</span><span class='line'>+-------------+-------------------------------------------+
</span><span class='line'>|   adminurl  | http://10.17.17.211:8774/v2/%(tenant_id)s |
</span><span class='line'>|      id     |      d16c91bfacf2474ebee36314535a146f     |
</span><span class='line'>| internalurl | http://10.17.17.211:8774/v2/%(tenant_id)s |
</span><span class='line'>|  publicurl  | http://10.17.17.211:8774/v2/%(tenant_id)s |
</span><span class='line'>|    region   |                 regionOne                 |
</span><span class='line'>|  service_id |      8733caba0b9742a39ee9ac53ad4d8e27     |
</span><span class='line'>+-------------+-------------------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h3>Compute服务安装</h3>

<h4>Controller节点配置</h4>

<p>在Controller节点上，安装以下包:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# apt-get -y install nova-api nova-cert nova-conductor nova-consoleauth nova-novncproxy nova-scheduler python-novaclient
</span></code></pre></td></tr></table></div></figure>


<p>配置nova所需的配置文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/nova/nova.conf
</span><span class='line'>[database]
</span><span class='line'>connection = mysql://nova:xxxxx@10.17.17.211/nova
</span><span class='line'>
</span><span class='line'>[DEFAULT]
</span><span class='line'>....
</span><span class='line'>rpc_backend = rabbit
</span><span class='line'>rabbit_host = 10.17.17.211
</span><span class='line'>rabbit_password = xxxxxx
</span><span class='line'>my_ip=10.17.17.211
</span><span class='line'>vncserver_listen = 0.0.0.0
</span><span class='line'>vncserver_proxyclient_address = 10.17.17.211
</span><span class='line'>auth_strategy = keystone 
</span><span class='line'>
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>auth_uri = http://10.17.17.211:5000
</span><span class='line'>auth_host = 10.17.17.211
</span><span class='line'>auth_port = 35357
</span><span class='line'>auth_protocol = http
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = nova
</span><span class='line'>admin_password = xxxx
</span><span class='line'>[glance]
</span><span class='line'>host=10.17.17.211
</span></code></pre></td></tr></table></div></figure>


<p>删除sqlite3数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# rm /var/lib/nova/nova.sqlite 
</span></code></pre></td></tr></table></div></figure>


<p>创建数据库：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# su -s /bin/sh -c "nova-manage db sync" nova
</span></code></pre></td></tr></table></div></figure>


<p>重启服务，使用nova检查本机可用镜像情况:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# service nova-api restart
</span><span class='line'>root@JunoController:~# service nova-cert restart
</span><span class='line'>root@JunoController:~#  service nova-consoleauth restart
</span><span class='line'>root@JunoController:~# service nova-scheduler restart
</span><span class='line'>root@JunoController:~# service nova-conductor restart
</span><span class='line'>root@JunoController:~# service nova-novncproxy restart
</span><span class='line'>root@JunoController:~# nova image-list
</span><span class='line'>+--------------------------------------+---------------------+--------+--------+
</span><span class='line'>| ID                                   | Name                | Status | Server |
</span><span class='line'>+--------------------------------------+---------------------+--------+--------+
</span><span class='line'>| 68f14900-8b25-4329-ad56-8fbd497c6812 | cirros-0.3.3-x86_64 | ACTIVE |        |
</span><span class='line'>+--------------------------------------+---------------------+--------+--------+
</span></code></pre></td></tr></table></div></figure>


<h4>Compute节点安装</h4>

<p>安装下列包:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~#  apt-get -y install nova-compute sysfsutils
</span></code></pre></td></tr></table></div></figure>


<p>配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~# vim /etc/nova/nova.conf 
</span><span class='line'>[DEFAULT]
</span><span class='line'>......
</span><span class='line'>auth_strategy = keystone
</span><span class='line'>rpc_backend = rabbit
</span><span class='line'>rabbit_host = 10.17.17.211
</span><span class='line'>rabbit_password = xxxx
</span><span class='line'>my_ip = 10.17.17.213
</span><span class='line'>vnc_enabled = True
</span><span class='line'>vncserver_listen = 0.0.0.0
</span><span class='line'>vncserver_proxyclient_address = 10.17.17.213
</span><span class='line'>novncproxy_base_url = http://10.17.17.211:6080/vnc_auto.html
</span><span class='line'>glance_host = 10.17.17.211
</span><span class='line'>
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>auth_uri = http://10.17.17.211:5000
</span><span class='line'>auth_host = 10.17.17.211
</span><span class='line'>auth_port = 35357
</span><span class='line'>auth_protocol = http
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = nova
</span><span class='line'>admin_password = xxxx
</span><span class='line'>
</span><span class='line'>[database]
</span><span class='line'>#The SQLAlchemy connection string used to connect to the database
</span><span class='line'>connection = mysql://nova:xxxx@10.17.17.211/nova
</span><span class='line'>[glance]
</span><span class='line'>host=10.17.17.211
</span></code></pre></td></tr></table></div></figure>


<p>看cpu硬件是否支持硬件加速:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~# egrep -c '(vmx|svm)' /proc/cpuinfo
</span><span class='line'>2
</span></code></pre></td></tr></table></div></figure>


<p>如果支持加速，则配置nova-compute.conf为:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~# cat /etc/nova/nova-compute.conf
</span><span class='line'>[libvirt]
</span><span class='line'>virt_type=kvm
</span></code></pre></td></tr></table></div></figure>


<p>删除不需要的nova.sqlite文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~# rm -f /var/lib/nova/nova.sqlite 
</span></code></pre></td></tr></table></div></figure>


<p>重起nova服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoCompute:~# service nova-compute restart
</span></code></pre></td></tr></table></div></figure>


<h3>验证</h3>

<p>在控制节点上,列出所有的service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# nova service-list
</span><span class='line'>+------------------+----------------+----------+---------+-------+----------------------------+-----------------+
</span><span class='line'>| Binary           | Host           | Zone     | Status  | State | Updated_at                 | Disabled Reason |
</span><span class='line'>+------------------+----------------+----------+---------+-------+----------------------------+-----------------+
</span><span class='line'>| nova-cert        | JunoController | internal | enabled | up    | 2015-04-13T10:16:10.000000 | -               |
</span><span class='line'>| nova-consoleauth | JunoController | internal | enabled | up    | 2015-04-13T10:16:12.000000 | -               |
</span><span class='line'>| nova-scheduler   | JunoController | internal | enabled | up    | 2015-04-13T10:16:05.000000 | -               |
</span><span class='line'>| nova-conductor   | JunoController | internal | enabled | up    | 2015-04-13T10:16:08.000000 | -               |
</span><span class='line'>| nova-compute     | JunoCompute    | nova     | enabled | up    | 2015-04-13T10:16:09.000000 | -               |
</span><span class='line'>+------------------+----------------+----------+---------+-------+----------------------------+-----------------+
</span></code></pre></td></tr></table></div></figure>


<p>现在compute节点已经配置完了，接下来可以配置网络节点。配置完网络节点后，就可以启动虚拟机了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-3/">安装Icehouse@Ubuntu14.04(3)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-13T16:54:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:54 pm</span></time>
        
         | <a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Image Service 用于提供给用户用于快速启动虚拟机的镜像文件，这样的服务称为glance服务。</p>

<h3>Glance服务数据库设定</h3>

<p>在mysql中创建glance数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~#  mysql -u root -p
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 33
</span><span class='line'>Server version: 5.5.41-MariaDB-1ubuntu0.14.04.1 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2014, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; CREATE DATABASE glance;
</span><span class='line'>Query OK, 1 row affected (0.01 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'xxxx'
</span><span class='line'>    -&gt; ;
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'xxxx';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; flush privileges;
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit;
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<h3>创建Glance的user/role/tenant权限</h3>

<p>用admin的权限，创建以下权限：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~#  source ~/openstack/admin-openrc.sh
</span></code></pre></td></tr></table></div></figure>


<p>创建glance用户:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone user-create --name glance --pass engine
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |                                  |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | c706febbcc8843fb97383c9fdfba6214 |
</span><span class='line'>|   name   |              glance              |
</span><span class='line'>| username |              glance              |
</span><span class='line'>+----------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>用户glance属于admin角色，使用service tanant:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>keystone user-role-add --user glance --tenant service --role admin
</span></code></pre></td></tr></table></div></figure>


<p>在keystone注册glance服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone service-create --name glance --type image --description "OpenStack Image Service"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |     OpenStack Image Service      |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 3d52d2992b9f423eb9868304e4405fab |
</span><span class='line'>|     name    |              glance              |
</span><span class='line'>|     type    |              image               |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>在keystone创建服务的end-point:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone endpoint-create --service-id $(keystone service-list | awk '/ image / {print $2}') --publicurl http://10.17.17.211:9292 --internalurl http://10.17.17.211:9292 --adminurl http://10.17.17.211:9292 --region regionOne
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   adminurl  |     http://10.17.17.211:9292     |
</span><span class='line'>|      id     | f44400bebc07408d8e0f4e70a0d18475 |
</span><span class='line'>| internalurl |     http://10.17.17.211:9292     |
</span><span class='line'>|  publicurl  |     http://10.17.17.211:9292     |
</span><span class='line'>|    region   |            regionOne             |
</span><span class='line'>|  service_id | 3d52d2992b9f423eb9868304e4405fab |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h3>安装Glance服务</h3>

<p>安装:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apt-get -y install glance python-glanceclient
</span></code></pre></td></tr></table></div></figure>


<p>配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/glance/glance-api.conf
</span><span class='line'>[database]
</span><span class='line'># sqlite_db = /var/lib/glance/glance.sqlite
</span><span class='line'>backend = sqlalchemy
</span><span class='line'>connection = mysql://glance:engine@10.17.17.211/glance
</span><span class='line'>
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>auth_uri = http://10.17.17.211:5000
</span><span class='line'>auth_host = 10.17.17.211
</span><span class='line'>auth_port = 35357
</span><span class='line'>auth_protocol = http
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = glance
</span><span class='line'>admin_password = engine
</span><span class='line'>#  vim /etc/glance/glance-registry.conf
</span><span class='line'>[database]
</span><span class='line'># The file name to use with SQLite (string value)
</span><span class='line'>#sqlite_db = /var/lib/glance/glance.sqlite
</span><span class='line'>backend = sqlalchemy
</span><span class='line'>connection = mysql://glance:engine@10.17.17.211/glance
</span><span class='line'>
</span><span class='line'>[keystone_authtoken]
</span><span class='line'>auth_uri = http://10.17.17.211:5000
</span><span class='line'>auth_host = 10.17.17.211
</span><span class='line'>auth_port = 35357
</span><span class='line'>auth_protocol = http
</span><span class='line'>admin_tenant_name = service
</span><span class='line'>admin_user = glance
</span><span class='line'>admin_password = engine
</span><span class='line'># rm -f /var/lib/glance/glance.sqlite
</span><span class='line'># su -s /bin/sh -c "glance-manage db_sync" glance
</span></code></pre></td></tr></table></div></figure>


<p>这里会碰到一个问题，解决方案如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# su -s /bin/sh -c "glance-manage db_sync" glance
</span><span class='line'>2015-04-13 17:20:22.637 9455 CRITICAL glance [-] ValueError: Tables "migrate_version" have non utf8 collation, please make sure all tables are CHARSET=utf8
</span><span class='line'>
</span><span class='line'>root@JunoController:~# mysql -u root -p glance
</span><span class='line'>Enter password: 
</span><span class='line'>Reading table information for completion of table and column names
</span><span class='line'>You can turn off this feature to get a quicker startup with -A
</span><span class='line'>
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 29
</span><span class='line'>Server version: 5.5.41-MariaDB-1ubuntu0.14.04.1 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2014, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [glance]&gt; alter table migrate_version convert to character set utf8 collate utf8_unicode_ci;
</span><span class='line'>Query OK, 1 row affected (0.09 sec)                
</span><span class='line'>Records: 1  Duplicates: 0  Warnings: 0
</span><span class='line'>
</span><span class='line'>MariaDB [glance]&gt; flush privileges;
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [glance]&gt; quit;
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<p>重启服务，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# service glance-registry restart
</span><span class='line'>root@JunoController:~# service glance-api restart
</span></code></pre></td></tr></table></div></figure>


<h3>验证Glance服务</h3>

<p>首先下载镜像:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget http://cdn.download.cirros-cloud.net/0.3.3/cirros-0.3.3-x86_64-disk.img
</span></code></pre></td></tr></table></div></figure>


<p>创建Glance可见镜像:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># glance image-create --name "cirros-0.3.3-x86_64" --file cirros-0.3.3-x86_64-disk.img --disk-format qcow2 --container-format bare --is-public True --progress
</span><span class='line'>[=============================&gt;] 100%
</span><span class='line'>+------------------+--------------------------------------+
</span><span class='line'>| Property         | Value                                |
</span><span class='line'>+------------------+--------------------------------------+
</span><span class='line'>| checksum         | 133eae9fb1c98f45894a4e60d8736619     |
</span><span class='line'>| container_format | bare                                 |
</span><span class='line'>| created_at       | 2015-04-13T09:27:54                  |
</span><span class='line'>| deleted          | False                                |
</span><span class='line'>| deleted_at       | None                                 |
</span><span class='line'>| disk_format      | qcow2                                |
</span><span class='line'>| id               | 68f14900-8b25-4329-ad56-8fbd497c6812 |
</span><span class='line'>| is_public        | True                                 |
</span><span class='line'>| min_disk         | 0                                    |
</span><span class='line'>| min_ram          | 0                                    |
</span><span class='line'>| name             | cirros-0.3.3-x86_64                  |
</span><span class='line'>| owner            | ea1f0a6b15dc4796958f087c38756ed1     |
</span><span class='line'>| protected        | False                                |
</span><span class='line'>| size             | 13200896                             |
</span><span class='line'>| status           | active                               |
</span><span class='line'>| updated_at       | 2015-04-13T09:27:54                  |
</span><span class='line'>| virtual_size     | None                                 |
</span><span class='line'>+------------------+--------------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>检查镜像:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# ls /var/lib/glance/images/
</span><span class='line'>68f14900-8b25-4329-ad56-8fbd497c6812
</span></code></pre></td></tr></table></div></figure>


<p>列出可用镜像:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# glance image-list
</span><span class='line'>+--------------------------------------+---------------------+-------------+------------------+----------+--------+
</span><span class='line'>| ID                                   | Name                | Disk Format | Container Format | Size     | Status |
</span><span class='line'>+--------------------------------------+---------------------+-------------+------------------+----------+--------+
</span><span class='line'>| 68f14900-8b25-4329-ad56-8fbd497c6812 | cirros-0.3.3-x86_64 | qcow2       | bare             | 13200896 | active |
</span><span class='line'>+--------------------------------------+---------------------+-------------+------------------+----------+--------+
</span></code></pre></td></tr></table></div></figure>


<p>好了，现在glance服务可以使用了，接下来将创建compute节点和网络节点。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-2/">安装Icehouse@Ubuntu14.04(2)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-13T16:08:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:08 pm</span></time>
        
         | <a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>安装Identity服务</h3>

<p>首先创建keystone所需数据库:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# mysql -u root -p
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 28
</span><span class='line'>Server version: 5.5.41-MariaDB-1ubuntu0.14.04.1 (Ubuntu)
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2014, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; CREATE DATABASE keystone;
</span><span class='line'>Query OK, 1 row affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'KEYSTONE_PASS';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'KEYSTONE_PASS';
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; flush privileges;
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; exit;
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<p>安装keystone相关套件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# apt-get -y install keystone python-keystoneclient
</span></code></pre></td></tr></table></div></figure>


<p>创建一个admin token用于做初始化配置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# openssl rand -hex 10
</span><span class='line'>5c3b5cd66a7dfa8e33e5
</span></code></pre></td></tr></table></div></figure>


<p>使用上面取得的admin token和mysql设置用于更新/etc/keystone.conf文件，更改如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# vim /etc/keystone/keystone.conf 
</span><span class='line'>[DEFAULT]
</span><span class='line'>admin_token=5c3b5cd66a7dfa8e33e5
</span><span class='line'>verbose=True
</span><span class='line'>log_dir = /var/log/keystone
</span><span class='line'>
</span><span class='line'>[database]
</span><span class='line'>connection=mysql://keystone:KEYSTONE_DBPASS@10.17.17.211/keystone
</span><span class='line'>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>部署数据库并重新启动Keystone服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# su -s /bin/sh -c "keystone-manage db_sync" keystone
</span><span class='line'>root@JunoController:~# service keystone restart
</span></code></pre></td></tr></table></div></figure>


<p>删除不需要的sqlite数据库, 并设定crontab任务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# rm -f /var/lib/keystone/keystone.db
</span><span class='line'>root@JunoController:~# (crontab -l -u keystone 2&gt;&1 | grep -q token_flush) || echo '@hourly /usr/bin/keystone-manage token_flush &gt;/var/log/keystone/keystone-tokenflush.log 2&gt;&1' &gt;&gt; /var/spool/cron/crontabs/keystone
</span></code></pre></td></tr></table></div></figure>


<h3>建立 user / role / tenant</h3>

<p>环境变量设置:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# export OS_SERVICE_TOKEN=5c3b5cd66a7dfa8e33e5
</span><span class='line'>root@JunoController:~# export OS_SERVICE_ENDPOINT=http://10.17.17.211:35357/v2.0
</span></code></pre></td></tr></table></div></figure>


<h4>tenant创建</h4>

<p>创建admin tenant:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~#  keystone tenant-create --name admin --description "Admin Tenant"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |           Admin Tenant           |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | ea1f0a6b15dc4796958f087c38756ed1 |
</span><span class='line'>|     name    |              admin               |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>创建demo tenant:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone tenant-create --name demo --description "Demo Tenant"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |           Demo Tenant            |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 2ac9cae777014d3d94458f521b013e94 |
</span><span class='line'>|     name    |               demo               |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h4>建立user</h4>

<p>建立admin用户:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone user-create --name admin --pass xxxx --email kkkttt@gmail.com
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |        kkkttt@gmail.com        |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | 055dd9b7b1564df5bf9e9c511f32978b |
</span><span class='line'>|   name   |              admin               |
</span><span class='line'>| username |              admin               |
</span><span class='line'>+----------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>在demo tenant下建立demo用户:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone user-create --name demo --tenant demo --pass engine --email kkkttt@gmail.com
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|  email   |        kkkttt@gmail.com        |
</span><span class='line'>| enabled  |               True               |
</span><span class='line'>|    id    | e8f2c2bdaee34f3895147f26a924e010 |
</span><span class='line'>|   name   |               demo               |
</span><span class='line'>| tenantId | 2ac9cae777014d3d94458f521b013e94 |
</span><span class='line'>| username |               demo               |
</span><span class='line'>+----------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h4>admin role</h4>

<p>建立admin role:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone role-create --name admin
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>| Property |              Value               |
</span><span class='line'>+----------+----------------------------------+
</span><span class='line'>|    id    | 4af914913e154a599deb1b78a0751c1a |
</span><span class='line'>|   name   |              admin               |
</span><span class='line'>+----------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h4>链接user/role/tenant</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone user-role-add --user admin --tenant admin --role admin
</span></code></pre></td></tr></table></div></figure>


<h4>创建一个Service Tenant</h4>

<p>先建立Service Tenant:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone tenant-create --name service --description "Service Tenant"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |          Service Tenant          |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 4b22bf4e6a68419aa91da6e0ffaca2dc |
</span><span class='line'>|     name    |             service              |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<h4>定义services &amp; API 服务挂载点</h4>

<p>所有安装好的服务都需要向Identity Service注册，甚至是Identity Service本身，都需要先注册上才可以被使用:  <br/>
首先注册Identity Service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone service-create --name keystone --type identity --description "OpenStack Identity"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |        OpenStack Identity        |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 27bf7f70deac429d8d28623d99939ae6 |
</span><span class='line'>|     name    |             keystone             |
</span><span class='line'>|     type    |             identity             |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>而后，设定Identity Service的服务端点:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone endpoint-create --service-id $(keystone service-list | awk '/ identity / {print $2}') --publicurl http://10.17.17.211:5000/v2.0 --internalurl http://10.17.17.211:5000/v2.0 --adminurl http://10.17.17.211:35357/v2.0 --region regionOne                      
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   adminurl  |  http://10.17.17.211:35357/v2.0  |
</span><span class='line'>|      id     | fb4c17d5c1414a7e852c6f7db552dd89 |
</span><span class='line'>| internalurl |  http://10.17.17.211:5000/v2.0   |
</span><span class='line'>|  publicurl  |  http://10.17.17.211:5000/v2.0   |
</span><span class='line'>|    region   |            regionOne             |
</span><span class='line'>|  service_id | 27bf7f70deac429d8d28623d99939ae6 |
</span><span class='line'>+-------------+----------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>验证Identity服务是否安装成功,首先，unset环境变量:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# unset OS_SERVICE_TOKEN OS_SERVICE_ENDPOINT
</span></code></pre></td></tr></table></div></figure>


<p>以 tenant(admin) &amp; user(admin) 的身份取得 token:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>keystone --os-tenant-name admin --os-username admin --os-password ADMIN_PASS --os-auth-url http://10.17.17.211:35357/v2.0 token-get
</span></code></pre></td></tr></table></div></figure>


<p>以 tenant(admin) &amp; user(admin) 的身分查詢 tenant 清單:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># keystone --os-tenant-name admin --os-username admin --os-password  xxxxxx --os-auth-url http://10.17.17.211:35357/v2.0 tenant-list
</span><span class='line'>+----------------------------------+---------+---------+
</span><span class='line'>|                id                |   name  | enabled |
</span><span class='line'>+----------------------------------+---------+---------+
</span><span class='line'>| ea1f0a6b15dc4796958f087c38756ed1 |  admin  |   True  |
</span><span class='line'>| 2ac9cae777014d3d94458f521b013e94 |   demo  |   True  |
</span><span class='line'>| 4b22bf4e6a68419aa91da6e0ffaca2dc | service |   True  |
</span><span class='line'>+----------------------------------+---------+---------+
</span></code></pre></td></tr></table></div></figure>


<p>查询user清单：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone --os-tenant-name admin --os-username admin --os-password xxxx --os-auth-url http://10.17.17.211:35357/v2.0 user-list
</span><span class='line'>+----------------------------------+-------+---------+--------------------+
</span><span class='line'>|                id                |  name | enabled |       email        |
</span><span class='line'>+----------------------------------+-------+---------+--------------------+
</span><span class='line'>| 055dd9b7b1564df5bf9e9c511f32978b | admin |   True  | kkkttt@gmail.com |
</span><span class='line'>| e8f2c2bdaee34f3895147f26a924e010 |  demo |   True  | kkkttt@gmail.com |
</span><span class='line'>+----------------------------------+-------+---------+--------------------+
</span></code></pre></td></tr></table></div></figure>


<p>查询role清单:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone --os-tenant-name admin --os-username admin --os-password xxxx --os-auth-url http://10.17.17.211:35357/v2.0 role-list
</span><span class='line'>+----------------------------------+----------+
</span><span class='line'>|                id                |   name   |
</span><span class='line'>+----------------------------------+----------+
</span><span class='line'>| 9fe2ff9ee4384b1894a90878d3e92bab | _member_ |
</span><span class='line'>| 4af914913e154a599deb1b78a0751c1a |  admin   |
</span><span class='line'>+----------------------------------+----------+
</span></code></pre></td></tr></table></div></figure>


<p>以demo用户身份去的token</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@controller:~# keystone --os-tenant-name demo --os-username demo --os-password DEMO_PASS --os-auth-url http://10.17.17.211:35357/v2.0 token-get
</span></code></pre></td></tr></table></div></figure>


<p>以demo身份取得用户清单会被提示权限不足:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# keystone --os-tenant-name demo --os-username demo --os-password xxxx --os-auth-url http://10.17.17.211:35357/v2.0 user-list
</span><span class='line'>You are not authorized to perform the requested action, admin_required. (HTTP 403)
</span></code></pre></td></tr></table></div></figure>


<p>现在keystone服务已经挂载完毕了，接下来就是逐个挂载组件。</p>

<h3>快速切换脚本</h3>

<p>快速切换脚本如下，记得加上执行权限:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# cat openstack/admin-openrc.sh
</span><span class='line'>export OS_TENANT_NAME=admin
</span><span class='line'>export OS_USERNAME=admin
</span><span class='line'>export OS_PASSWORD=xxxx
</span><span class='line'>export OS_AUTH_URL=http://10.17.17.211:35357/v2.0
</span><span class='line'>root@JunoController:~# cat openstack/demo-openrc.sh 
</span><span class='line'>export OS_TENANT_NAME=demo
</span><span class='line'>export OS_USERNAME=demo
</span><span class='line'>export OS_PASSWORD=xxxx
</span><span class='line'>export OS_AUTH_URL=http://10.17.17.211:5000/v2.0
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-1/">安装Icehouse@Ubuntu14.04(1)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-13T11:29:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:29 am</span></time>
        
         | <a href="/blog/2015/04/13/an-zhuang-icehouse-at-ubuntu14-dot-04-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>项目的需要，手动基于多台Ubuntu虚拟机部署OpenStack Icehouse, 然后在部署好的Icehouse的基础上，部署OpenContrail, 最终达到OpenContrail解耦的过程。</p>

<h3>环境准备</h3>

<p>物理机: i7-3770/24G Memory/CentOS 6.6   <br/>
软件: virt-manager/qemu等  <br/>
节点机(虚拟机):  <br/>
节点机1: 控制节点(JunoController), 2 CPU+3G内存+单网卡(管理网络,10.17.17.211).  <br/>
节点机2: 网络节点(JunoNetwork), 1 CPU+1G内存+3 网卡(管理网络:10.17.17.212, GRE Tunnel网络:10.19.19.212, 外部网络:10.22.22.212).  <br/>
节点机3: 计算节点(JunoCompute), 2 CPU(Nested)+2G内存+2 网卡(管理网络:10.17.17.213, GRE Tunnel网络:10.19.19.213).  <br/>
网络配置:  <br/>
Virt-manager里需要配置三个网络，一个是管理网络10.17.17.0/24, 另一个GRE Tunnel网络10.19.19.0/24, 外部网络为10.22.22.0/24.  <br/>
参考资料:  <br/>
不错的指南文件:<a href="http://godleon.github.io/blog/2015/02/10/install-openstack-juno-in-ubuntu-basic-environment-setting/">http://godleon.github.io/blog/2015/02/10/install-openstack-juno-in-ubuntu-basic-environment-setting/</a>  <br/>
官方文档:<a href="http://docs.openstack.org/icehouse/install-guide/install/apt/content/">http://docs.openstack.org/icehouse/install-guide/install/apt/content/</a></p>

<h3>虚拟机准备</h3>

<p>用以下命令创建三台虚拟机的磁盘，而后按照上面的节点机配置完毕后，启动三台虚拟机。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># pwd
</span><span class='line'>/home/juju/img/OpenStack
</span><span class='line'># qemu-img create -f qcow2 -b ./UbuntuBase1404.qcow2 JunoController.qcow2
</span><span class='line'># qemu-img create -f qcow2 -b ./UbuntuBase1404.qcow2 JunoNetwork.qcow2
</span><span class='line'># qemu-img create -f qcow2 -b ./UbuntuBase1404.qcow2 JunoCompute.qcow2
</span></code></pre></td></tr></table></div></figure>


<p>更改节点机的/etc/hostname文件，更改各自的名字为JunoController, JunoNetwork和JunoCompute.  <br/>
每台机器的/etc/network/interfaces文件配置如下:  <br/>
JunoController:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># The loopback network interface
</span><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'># The primary network interface
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet static
</span><span class='line'>address 10.17.17.211
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>gateway 10.17.17.1
</span><span class='line'>dns-nameservers 114.114.114.114
</span></code></pre></td></tr></table></div></figure>


<p>JunoNetwork:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># The loopback network interface
</span><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'># The primary network interface
</span><span class='line'># auto eth0
</span><span class='line'># iface eth0 inet dhcp
</span><span class='line'>
</span><span class='line'># The primary network interface
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet static
</span><span class='line'>address 10.17.17.212
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>#gateway 10.17.17.1
</span><span class='line'>dns-nameservers 114.114.114.114
</span><span class='line'>
</span><span class='line'># Network, have the tunnel, which locates at the 10.19.19.0/24
</span><span class='line'>auto eth1
</span><span class='line'>iface eth1 inet static
</span><span class='line'>address 10.19.19.212
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>up route add -net 10.19.19.0/24 dev eth1
</span><span class='line'>
</span><span class='line'># Directly to internet, used for ovs
</span><span class='line'>auto eth2
</span><span class='line'>iface eth2 inet dhcp
</span></code></pre></td></tr></table></div></figure>


<p>JunoCompute:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># The loopback network interface
</span><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'># The primary network interface
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet static
</span><span class='line'>address 10.17.17.213
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>gateway 10.17.17.1
</span><span class='line'>dns-nameservers 114.114.114.114
</span><span class='line'>
</span><span class='line'># Network, have the tunnel, which locates at the 10.19.19.0/24
</span><span class='line'>auto eth1
</span><span class='line'>iface eth1 inet static
</span><span class='line'>address 10.19.19.213
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>up route add -net 10.19.19.0/24 dev eth1
</span></code></pre></td></tr></table></div></figure>


<p>把下列条目添加到各台节点机的 /etc/hosts文件中:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>10.17.17.211    JunoController
</span><span class='line'>10.17.17.212    JunoNetwork
</span><span class='line'>10.17.17.213    JunoCompute
</span></code></pre></td></tr></table></div></figure>


<h3>NTP服务部署</h3>

<h4>NTP 服务器</h4>

<p>使用NTP来保证各个节点之间的时间同步，对后续加入的各个节点，同样需要使用NTP来同步该节点时间。我们将JunoController作为NTP服务器,在JunoController上，安装和配置NTP服务器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# apt-get -y install ntp
</span><span class='line'>root@JunoController:~# vim /etc/ntp.conf
</span><span class='line'>    # 修改成大陆时间
</span><span class='line'>    server 2.cn.pool.ntp.org
</span><span class='line'>    server 1.asia.pool.ntp.org
</span><span class='line'>    server 2.asia.pool.ntp.org
</span><span class='line'>    # 修改 restrict 設定
</span><span class='line'>    restrict -4 default kod notrap nomodify
</span><span class='line'>    restrict -6 default kod notrap nomodify
</span><span class='line'>root@JunoController:~# service ntp restart
</span></code></pre></td></tr></table></div></figure>


<h4>NTP客户端</h4>

<p>其他的节点上都需要安装NTP客户端并使用NTP服务器时间同步。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get -y install ntp
</span><span class='line'># vim /etc/ntp.conf
</span><span class='line'>    # 設定 controller 為參照的 time server
</span><span class='line'>    # 並將其他 server 開頭的設定進行註解
</span><span class='line'>    server 10.17.17.211 iburst
</span><span class='line'># service ntp restart
</span></code></pre></td></tr></table></div></figure>


<p>检查结果是否正确:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoNetwork:~# ntpq -c peers
</span><span class='line'>     remote           refid      st t when poll reach   delay   offset  jitter
</span><span class='line'>==============================================================================
</span><span class='line'> JunoController  59.106.180.168   3 u    1   64    1    0.239  447024.   0.049
</span></code></pre></td></tr></table></div></figure>


<h3>添加软件仓库</h3>

<p>官方文档中说icehouse已经在14.04的官方仓库中了，所以下面的步骤并不是必须的。   <br/>
在所有节点上，执行以下操作:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install python-software-properties
</span><span class='line'># add-apt-repository cloud-archive:icehouse
</span><span class='line'># apt-get update && apt-get -y dist-upgrade && reboot
</span></code></pre></td></tr></table></div></figure>


<h3>安装/配置数据库</h3>

<p>OpenStack需要一个数据库用于存储相关数据，一般情况下采用MySQL. &ldquo;你问我支持不支持MySQL？我说不支持，我就明确告诉你，你们呀，我感觉你们开源界也要学习，你们非常熟悉MYSQL被Oracle这一套的，你们毕竟是Too Young，明白这意思吗？&rdquo;&mdash;-所以装一个MariaDB来代替它.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# apt-get -y install mariadb-server python-mysqldb
</span><span class='line'>root@JunoController:~# vim /etc/mysql/my.cnf 
</span><span class='line'>    [mysqld]
</span><span class='line'>    # 修改 bind-address 設定
</span><span class='line'>    bind-address = 10.17.17.211
</span><span class='line'>    
</span><span class='line'>    # 加入以下 UTF-8 的相關設定
</span><span class='line'>    default-storage-engine = innodb
</span><span class='line'>    innodb_file_per_table
</span><span class='line'>    collation-server = utf8_general_ci
</span><span class='line'>    init-connect = 'SET NAMES utf8'
</span><span class='line'>    character-set-server = utf8
</span></code></pre></td></tr></table></div></figure>


<p>重启服务:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# service mysql restart
</span></code></pre></td></tr></table></div></figure>


<h3>安装消息服务器</h3>

<p>同样在控制节点上安装，OpenStack使用rabbitmq作为消息服务器：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# apt-get install -y rabbitmq-server
</span></code></pre></td></tr></table></div></figure>


<p>修改初始化guest密码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@JunoController:~# rabbitmqctl change_password guest RABBITMQ_PASSWD
</span></code></pre></td></tr></table></div></figure>


<p>第一部分跑完，这里我们完成了OpenStack创建的基本设定，接下来就可以挨个搭建OpenStack的服务了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/07/deploy-opencontrail-on-centos-with-docker/">Deploy OpenContrail on CentOS With Docker as Hypervisor</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-07T16:50:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:50 pm</span></time>
        
         | <a href="/blog/2015/04/07/deploy-opencontrail-on-centos-with-docker/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Reference:  <br/>
<a href="https://software.intel.com/en-us/blogs/2014/12/28/experimenting-with-openstack-sahara-on-docker-containers">https://software.intel.com/en-us/blogs/2014/12/28/experimenting-with-openstack-sahara-on-docker-containers</a>  <br/>
I wanna enable the docker as hypervisor then it would greatly save the resources, and benefit with docker&rsquo;s rich resources. Following is the steps:</p>

<h3>Preparation</h3>

<p>First create the image file via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># qemu-img create -f qcow2 CentOSOpenContrail.qcow2 100G
</span><span class='line'>Formatting 'CentOSOpenContrail.qcow2', fmt=qcow2 size=107374182400 encryption=off cluster_size=65536 
</span><span class='line'>[root:/home/juju/img/CentOSOpenContrail]# pwd
</span><span class='line'>/home/juju/img/CentOSOpenContrail
</span></code></pre></td></tr></table></div></figure>


<p>Then create a virtual machine based on KVM, allocate 8G Memory, 4-core, which copies the host CPU configuration.</p>

<h3>Installation</h3>

<p>After installation, update the installed software via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup   
</span><span class='line'>$ wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo 
</span><span class='line'>$ sudo yum makecache
</span><span class='line'>$ sudo yum update -y
</span><span class='line'>$ sudo reboot
</span></code></pre></td></tr></table></div></figure>


<p>Install following packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget https://repos.fedorapeople.org/repos/openstack/openstack-juno/rdo-release-juno-1.noarch.rpm
</span><span class='line'># rpm -ivh rdo-release-juno-1.noarch.rpm 
</span><span class='line'># yum install –y https://rdo.fedorapeople.org/rdo-release.rpm
</span><span class='line'># yum install openstack-packstack
</span></code></pre></td></tr></table></div></figure>


<p>Now you could use packstack for installing the packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># packstack --gen-answer-file=/root/answer.txt
</span><span class='line'># packstack --answer-file=/root/answer.txt
</span></code></pre></td></tr></table></div></figure>


<p>Install openstack-sahara via following command, the python-tox enable tox for generating the configuration files for sahara:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum install openstack-sahara 
</span><span class='line'># yum install python-tox
</span></code></pre></td></tr></table></div></figure>


<p>Create the username and password for sahara to use:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@10-17-17-183 etc]# mysql
</span><span class='line'>MariaDB [(none)]&gt; create user 'sahara'@'localhost' identified by 'saharapass';
</span><span class='line'>Query OK, 0 rows affected (0.07 sec)
</span><span class='line'>MariaDB [(none)]&gt; show databases;
</span><span class='line'>+--------------------+
</span><span class='line'>| Database           |
</span><span class='line'>+--------------------+
</span><span class='line'>| information_schema |
</span><span class='line'>| cinder             |
</span><span class='line'>| glance             |
</span><span class='line'>| keystone           |
</span><span class='line'>| mysql              |
</span><span class='line'>| neutron            |
</span><span class='line'>| nova               |
</span><span class='line'>| performance_schema |
</span><span class='line'>| test               |
</span><span class='line'>+--------------------+
</span><span class='line'>9 rows in set (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; use mysql
</span><span class='line'>MariaDB [mysql]&gt; show tables;
</span><span class='line'>MariaDB [mysql]&gt; select * from user;
</span><span class='line'>+-----------+----------------+-----------------------------------
</span></code></pre></td></tr></table></div></figure>


<p>How to get all of the password configuration information of packstack?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /etc/
</span><span class='line'>$ grep -i "sql://" ./ -r
</span></code></pre></td></tr></table></div></figure>


<p>Create a database named &lsquo;saharaDB" and grant it to user sahra:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MariaDB [(none)]&gt; create database saharaDB;
</span><span class='line'>MariaDB [(none)]&gt; grant all on saharaDB.* to 'sahara'@'localhost';
</span><span class='line'>Query OK, 0 rows affected (0.02 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit;
</span><span class='line'>[root@10-17-17-183 etc]# mysql -h 127.0.0.1 -u sahara -p saharaDB
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 1481
</span><span class='line'>Server version: 5.5.40-MariaDB-wsrep MariaDB Server, wsrep_25.11.r4026
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2014, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [saharaDB]&gt; 
</span></code></pre></td></tr></table></div></figure>


<p>So the syntax for sahara to use is like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/sahara/sahara.conf
</span><span class='line'>connection = mysql://sahara:saharapass@127.0.0.1/saharaDB
</span><span class='line'>use_neutron=true
</span><span class='line'>
</span><span class='line'># sahara-db-manage --config-file /etc/sahara/sahara.conf upgrade head
</span><span class='line'>INFO  [alembic.migration] Context impl MySQLImpl.
</span><span class='line'>INFO  [alembic.migration] Will assume non-transactional DDL.
</span><span class='line'>INFO  [alembic.migration] Running upgrade None -&gt; 001, Icehouse release
</span><span class='line'>INFO  [alembic.migration] Running upgrade 001 -&gt; 002, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 002 -&gt; 003, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 003 -&gt; 004, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 004 -&gt; 005, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 005 -&gt; 006, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 006 -&gt; 007, convert clusters.status_description to LongText
</span><span class='line'>INFO  [alembic.migration] Running upgrade 007 -&gt; 008, add security_groups field to node groups
</span><span class='line'>INFO  [alembic.migration] Running upgrade 008 -&gt; 009, add rollback info to cluster
</span><span class='line'>INFO  [alembic.migration] Running upgrade 009 -&gt; 010, add auto_security_groups flag to node group
</span><span class='line'>INFO  [alembic.migration] Running upgrade 010 -&gt; 011, add Sahara settings info to cluster
</span></code></pre></td></tr></table></div></figure>


<p>REgister the service and specify the endpoint:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@10-17-17-183 etc]# cat ./nagios/keystonerc_admin                                                                                         
</span><span class='line'>export OS_USERNAME=admin                                                                                                                       
</span><span class='line'>export OS_TENANT_NAME=admin                                                                                                                    
</span><span class='line'>export OS_PASSWORD=5d4e62e79d314477                                                                                                            
</span><span class='line'>export OS_AUTH_URL=http://10.17.17.183:35357/v2.0/ 
</span><span class='line'>[root@10-17-17-183 etc]# pwd                                                                
</span><span class='line'>/etc  
</span><span class='line'># keystone service-create --name sahara --type data_processing --description "Data processing service"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |     Data processing service      |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 5f711f0d42754b349931349bd0c325d1 |
</span><span class='line'>|     name    |              sahara              |
</span><span class='line'>|     type    |         data_processing          |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>[root@10-17-17-183 ~]# keystone endpoint-create --service-id $(keystone service-list | awk '/ sahara / {print $2}') --publicurl http://127.0.0.1:8386/v1.1/%\(tenant_id\)s --internalurl http://127.0.0.1:8386/v1.1/%\(tenant_id\)s --adminurl http://127.0.0.1:8386/v1.1/%\(tenant_id\)s --region regionOne
</span><span class='line'>+-------------+------------------------------------------+
</span><span class='line'>|   Property  |                  Value                   |
</span><span class='line'>+-------------+------------------------------------------+
</span><span class='line'>|   adminurl  | http://127.0.0.1:8386/v1.1/%(tenant_id)s |
</span><span class='line'>|      id     |     b2115bab8bd743f589b1ed68eef69b4c     |
</span><span class='line'>| internalurl | http://127.0.0.1:8386/v1.1/%(tenant_id)s |
</span><span class='line'>|  publicurl  | http://127.0.0.1:8386/v1.1/%(tenant_id)s |
</span><span class='line'>|    region   |                regionOne                 |
</span><span class='line'>|  service_id |     5f711f0d42754b349931349bd0c325d1     |
</span><span class='line'>+-------------+------------------------------------------+
</span><span class='line'>[root@10-17-17-183 ~]# systemctl start openstack-sahara-all
</span><span class='line'>[root@10-17-17-183 ~]# systemctl enable openstack-sahara-all
</span><span class='line'>ln -s '/usr/lib/systemd/system/openstack-sahara-all.service' '/etc/systemd/system/multi-user.target.wants/openstack-sahara-all.service'
</span><span class='line'>[root@10-17-17-183 ~]# systemctl status openstack-sahara-all.service
</span></code></pre></td></tr></table></div></figure>


<p>More detailed info could be fetched from:   <br/>
<a href="http://docs.openstack.org/juno/install-guide/install/apt/content/sahara-install.html">http://docs.openstack.org/juno/install-guide/install/apt/content/sahara-install.html</a>  <br/>
Now login to the <a href="http://10.17.17.183">http://10.17.17.183</a> then you could visit the Trustyboard. The password is the one we used in the <code>OS_PASSWORD</code>.  <br/>
Install docker:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$  yum install docker
</span><span class='line'>Or
</span><span class='line'>$  wget https://get.docker.com/builds/Linux/x86_64/docker-latest -O docker
</span><span class='line'>$  docker --version
</span><span class='line'>[root@10-17-17-183 ~]#  usermod -G dockerroot nova
</span><span class='line'>[root@10-17-17-183 ~]# service openstack-nova-compute restart
</span><span class='line'>Redirecting to /bin/systemctl restart  openstack-nova-compute.service
</span><span class='line'># systemctl restart docker
</span><span class='line'># systemctl enable docker
</span></code></pre></td></tr></table></div></figure>


<p>Install nova-docker support:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$  yum install python-pip
</span><span class='line'>$  pip install -e git+https://github.com/stackforge/nova-docker#egg=novadocker
</span><span class='line'>$  cd src/novadocker/
</span><span class='line'>$  python setup.py install
</span><span class='line'>$ vim /etc/nova/nova.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>compute_driver = novadocker.virt.docker.DockerDriver
</span></code></pre></td></tr></table></div></figure>


<p>Edit the nova&rsquo;s rootwrap like following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@10-17-17-183 nova]# mkdir rootwrap.d
</span><span class='line'>[root@10-17-17-183 nova]# cd rootwrap.d/
</span><span class='line'>[root@10-17-17-183 rootwrap.d]# touch docker.filters
</span><span class='line'>[root@10-17-17-183 rootwrap.d]# vim docker.filters 
</span><span class='line'>[Filters]
</span><span class='line'># nova/virt/docker/driver.py:'ln', '-sf', '/var/run/netns/.*'
</span><span class='line'>ln: CommandFilter, /bin/ln, root
</span><span class='line'>[root@10-17-17-183 rootwrap.d]# vim /etc/nova/rootwrap.conf 
</span><span class='line'>[root@10-17-17-183 rootwrap.d]# pwd
</span><span class='line'>/etc/nova/rootwrap.d
</span></code></pre></td></tr></table></div></figure>


<p>Edit the glance-api.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@10-17-17-183 glance]# vim ./glance-api.conf 
</span><span class='line'>[DEFAULT]
</span><span class='line'>container_formats = ami,ari,aki,bare,ovf,docker
</span><span class='line'>[root@10-17-17-183 glance]# pwd
</span><span class='line'>/etc/glance
</span></code></pre></td></tr></table></div></figure>


<p>Create the ubuntu Container images via following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker pull ubuntu
</span><span class='line'>$ docker save ubuntu | glance image-create --is-public=True --container-format=docker --disk-format=raw --name ubuntu_container
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/01/build-qemu-for-supporting-glustfs/">Build Qemu for Supporting Glustfs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-01T16:56:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>4:56 pm</span></time>
        
         | <a href="/blog/2015/04/01/build-qemu-for-supporting-glustfs/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Following is the build procedure.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get build-dep qemu
</span><span class='line'>$ sudo apt-get install libvde-dev libvdeplug2-dev libcap-ng-dev libattr1-dev
</span><span class='line'>$ wget http://wiki.qemu-project.org/download/qemu-2.0.2.tar.bz2
</span><span class='line'>$ tar xjvf qemu-2.0.2.tar.bz2
</span><span class='line'>$ cd qemu-2.0.2/
</span><span class='line'>$ mkdir -p bin/debug/native
</span><span class='line'>$ cd bin/debug/native
</span><span class='line'>$ sudo apt-get install libjpeg-turbo8-dev
</span><span class='line'>$ sudo apt-get install glusterfs-common
</span><span class='line'> ../../../configure --enable-sdl --audio-drv-list=alsa,oss --enable-curses --enable-vnc-jpeg --enable-curl --enable-fdt --enable-kvm --enable-tcg-interpreter --enable-system --enable-user \\n --enable-linux-user --enable-guest-base --enable-pie --enable-uuid --enable-vde --enable-linux-aio --enable-cap-ng --enable-attr --enable-docs --enable-vhost-net --enable-rbd \\n --enable-guest-agent --enable-glusterfs --target-list=x86_64-softmmu,i386-softmmu
</span><span class='line'> ./qemu-img -h
</span><span class='line'> $ make -j2
</span></code></pre></td></tr></table></div></figure>


<p>Before, Found qemu-img:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ qemu-img -h
</span><span class='line'>Supported formats: vvfat vpc vmdk vhdx vdi sheepdog sheepdog sheepdog rbd raw host_cdrom host_floppy host_device file qed qcow2 qcow parallels nbd nbd nbd dmg tftp ftps ftp https http cow cloop bochs blkverify blkdebug
</span></code></pre></td></tr></table></div></figure>


<p>After, qemu-img:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Supported formats: vvfat vpc vmdk vhdx vdi sheepdog sheepdog sheepdog rbd raw host_cdrom host_floppy host_device file qed qcow2 qcow parallels nbd nbd nbd gluster gluster gluster gluster dmg tftp ftps ftp https http cow cloop bochs blkverify blkdebug
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/30/whole-process-for-deploying-contrail/">Whole Process for Deploying Contrail</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-30T18:20:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:20 pm</span></time>
        
         | <a href="/blog/2015/03/30/whole-process-for-deploying-contrail/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Following are the steps, enjoy them:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># First bootstrap the environment.   
</span><span class='line'>juju bootstrap --metadata-source ~/.juju/metadata --upload-tools -v --show-log --constraints="mem=3G"
</span><span class='line'>
</span><span class='line'>#####################################################
</span><span class='line'># Machine 0, hold 9 services. 3G mem. trusty
</span><span class='line'># Memory: 3G
</span><span class='line'># Service: 10
</span><span class='line'>#####################################################
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># Since machine 0 is ready for using, deploy services to this node via following commands:     
</span><span class='line'># Juju-gui is for monitoring the status and the components
</span><span class='line'># 1. juju-gui
</span><span class='line'>juju deploy --to 0 --repository=/home/Trusty/charms/ local:trusty/juju-gui
</span><span class='line'># 2. rabbitmq-server
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/charms/ local:trusty/rabbitmq-server
</span><span class='line'># 3. mysql
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/charms/ local:trusty/mysql
</span><span class='line'># 4. keystone
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/keystone
</span><span class='line'># 5. openstack-Trustyboard
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/openstack-Trustyboard
</span><span class='line'>
</span><span class='line'># 6. nova-cloud-controller
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/nova-cloud-controller --config=/home/Trusty/Code/deploy/nova-cloud-controller-config.yaml 
</span><span class='line'># 7. glance to lxc:0
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/glance
</span><span class='line'># 8. contrail-configuration to lxc:0
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/contrail-configuration
</span><span class='line'># 9. control-control to lxc:0
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/contrail-control
</span><span class='line'># 10. neutron-api to lxc:0
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/neutron-api --config=/home/Trusty/Code/deploy/neutron-api.yaml
</span><span class='line'>
</span><span class='line'># Now add the first node for nova-compute.   
</span><span class='line'>juju set-constraints "mem=900M"
</span><span class='line'>#####################################################
</span><span class='line'># Machine 1, hold nova-compute service, 2G with nested CPU, trusty
</span><span class='line'># Memory: 2G
</span><span class='line'># Service: 1
</span><span class='line'>#####################################################
</span><span class='line'>
</span><span class='line'># Add name specified machine, which memory is 2048M, with cpu nested for kvm
</span><span class='line'>juju add-machine MaasOpenContrail4
</span><span class='line'># Machine 1 will be added into the Juju environment, deploy nova-compute into this node
</span><span class='line'>juju deploy --to 1 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/nova-compute
</span><span class='line'>
</span><span class='line'>#####################################################
</span><span class='line'># Machine 2, hold neutron-gateway service, 1G , trusty
</span><span class='line'># Memory: 1G
</span><span class='line'># Service: 1
</span><span class='line'>#####################################################
</span><span class='line'># Add neutron-gateway to 1G based machine , it may fail, so you could remove-machine, and re-add again. via `juju destroy-machine 2 --force`  
</span><span class='line'>juju add-machine MaasOpenContrail7
</span><span class='line'>juju deploy --to 4 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/quantum-gateway neutron-gateway
</span><span class='line'>
</span><span class='line'>#####################################################
</span><span class='line'># Machine 3, hold cassandra and zookeeper serivce, 4G, precise.
</span><span class='line'># Memory: 4G
</span><span class='line'># Service: 2
</span><span class='line'>#####################################################
</span><span class='line'># First we should change the default deployed system version to precise. 
</span><span class='line'>juju set-environment default-series=precise
</span><span class='line'># Add new machine, whose memory is 4G.
</span><span class='line'>juju add-machine MaasOpenContrail5
</span><span class='line'># Deploy cassandra to 4G Node
</span><span class='line'>juju deploy --to 5 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:precise/cassandra --config=/home/Trusty/Code/deploy/cassandra.yaml
</span><span class='line'># Also use this machine for deploy a lxc based service, zookeeper, which is also based on precise.
</span><span class='line'>juju deploy --to lxc:5 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:precise/zookeeper
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># Well, set the default environment from precise to trusty
</span><span class='line'>juju set-environment default-series=trusty
</span><span class='line'>
</span><span class='line'># Finally deploy  neutron-contrail
</span><span class='line'>juju deploy --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/neutron-contrail
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#####################################################
</span><span class='line'>#####################################################
</span><span class='line'># Well the deploy is finished, then add relationship
</span><span class='line'>#####################################################
</span><span class='line'>#####################################################
</span><span class='line'>juju add-relation keystone mysql
</span><span class='line'>juju add-relation nova-cloud-controller mysql
</span><span class='line'>juju add-relation nova-cloud-controller rabbitmq-server
</span><span class='line'>juju add-relation nova-cloud-controller glance
</span><span class='line'>juju add-relation nova-cloud-controller keystone
</span><span class='line'>juju add-relation neutron-gateway mysql
</span><span class='line'>juju add-relation neutron-gateway:amqp rabbitmq-server:amqp
</span><span class='line'>juju add-relation neutron-gateway nova-cloud-controller
</span><span class='line'>juju add-relation nova-compute:shared-db mysql:shared-db
</span><span class='line'>juju add-relation nova-compute:amqp rabbitmq-server:amqp
</span><span class='line'>juju add-relation nova-compute glance
</span><span class='line'>juju add-relation nova-compute nova-cloud-controller
</span><span class='line'>juju add-relation glance mysql
</span><span class='line'>juju add-relation glance keystone
</span><span class='line'>juju add-relation openstack-Trustyboard keystone
</span><span class='line'>juju add-relation neutron-api mysql
</span><span class='line'>juju add-relation neutron-api rabbitmq-server
</span><span class='line'>juju add-relation neutron-api nova-cloud-controller
</span><span class='line'>juju add-relation neutron-api:identity-service keystone:identity-service
</span><span class='line'>juju add-relation neutron-api:identity-admin keystone:identity-admin
</span><span class='line'>juju add-relation contrail-configuration:cassandra cassandra:database
</span><span class='line'>juju add-relation contrail-configuration zookeeper
</span><span class='line'>juju add-relation contrail-configuration rabbitmq-server
</span><span class='line'>juju add-relation contrail-configuration keystone
</span><span class='line'>juju add-relation contrail-configuration neutron-gateway
</span><span class='line'>juju add-relation neutron-api contrail-configuration
</span><span class='line'>juju add-relation contrail-control contrail-configuration
</span><span class='line'>juju add-relation nova-compute neutron-contrail
</span><span class='line'>juju add-relation neutron-contrail contrail-control
</span><span class='line'>juju add-relation neutron-contrail neutron-gateway
</span><span class='line'>juju add-relation neutron-contrail contrail-configuration
</span><span class='line'>juju add-relation neutron-contrail keystone
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># change the passwd of OpenStack:    
</span><span class='line'>juju set keystone admin-password="helloworld"
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/27/add-sbh-bluetooth-to-linux/">Add SBH BlueTooth to Linux</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-27T10:05:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:05 am</span></time>
        
         | <a href="/blog/2015/03/27/add-sbh-bluetooth-to-linux/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I bought a SBH Sony Bluetooth headset, following is the steps for adding it to system.</p>

<h3>Add Device</h3>

<p>Use Blueman for adding the equiment, first click the SBH headset to let it enter discover mode, also in blueman we enable the discover mode too, when setup the equipment, the code you have to enter is 0000.  <br/>
The device kindle is not headset, but the a2dp?</p>

<h3>Add Configuration for ALSA</h3>

<p>Edit the /etc/asound.conf, my configuration file is listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pcm.btheadset {
</span><span class='line'>   type plug
</span><span class='line'>   slave {
</span><span class='line'>       pcm {
</span><span class='line'>           type bluetooth
</span><span class='line'>           device xxx.xxx.xxx.xxx
</span><span class='line'>           profile "auto"
</span><span class='line'>       }   
</span><span class='line'>   }   
</span><span class='line'>   hint {
</span><span class='line'>       show on
</span><span class='line'>       description "BT Headset"
</span><span class='line'>   }   
</span><span class='line'>}
</span><span class='line'>ctl.btheadset {
</span><span class='line'>  type bluetooth
</span><span class='line'>}  
</span><span class='line'>pcm.sbhbtheadset {
</span><span class='line'>   type plug
</span><span class='line'>   slave {
</span><span class='line'>       pcm {
</span><span class='line'>           type bluetooth
</span><span class='line'>           device xxx.xxx.xxx.xxx
</span><span class='line'>           profile "auto"
</span><span class='line'>       }   
</span><span class='line'>   }   
</span><span class='line'>   hint {
</span><span class='line'>       show on
</span><span class='line'>       description "SBH BT Headset"
</span><span class='line'>   }   
</span><span class='line'>}
</span><span class='line'>ctl.sbhbtheadset {
</span><span class='line'>  type bluetooth
</span><span class='line'>}  
</span></code></pre></td></tr></table></div></figure>


<p>The first equipment is another bluetooth headset. We define our SDH to sdhbtheadset.  <br/>
Examine our added equipment via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aplay -L
</span><span class='line'>default
</span><span class='line'>    Playback/recording through the PulseAudio sound server
</span><span class='line'>null
</span><span class='line'>    Discard all samples (playback) or generate zero samples (capture)
</span><span class='line'>pulse
</span><span class='line'>    PulseAudio Sound Server
</span><span class='line'>btheadset
</span><span class='line'>    BT Headset
</span><span class='line'>sbhbtheadset
</span><span class='line'>    SBH BT Headset
</span></code></pre></td></tr></table></div></figure>


<h3>Send Sound</h3>

<p>The commands are listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pactl load-module module-alsa-sink device=sbhbtheadset
</span><span class='line'>17
</span><span class='line'>[Trusty@~]$ pacmd load_module module-bluetooth-discover
</span><span class='line'>Welcome to PulseAudio! Use "help" for usage information.
</span><span class='line'>&gt;&gt;&gt; Unknown command: load_module module-bluetooth-discover
</span><span class='line'>&gt;&gt;&gt; %                                                             
</span><span class='line'>[Trusty@~]$ pactl list sinks short
</span><span class='line'>1       alsa_output.sbhbtheadset        module-alsa-sink.c      s16le 2ch 44100Hz      SUSPENDED
</span><span class='line'>[Trusty@~]$ pacmd set-default-sink 1
</span><span class='line'>Welcome to PulseAudio! Use "help" for usage information.
</span><span class='line'>&gt;&gt;&gt; &gt;&gt;&gt; %                  
</span></code></pre></td></tr></table></div></figure>


<p>Now you are ready for listening Music via bluetooth headset, enjoy it.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/26/juju-tips/">Juju Tips</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-26T11:43:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:43 am</span></time>
        
         | <a href="/blog/2015/03/26/juju-tips/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Add Specified Machine</h3>

<p>We could add the specified name of the machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju add-machine MaasOpenContrail6.maas
</span></code></pre></td></tr></table></div></figure>


<p>While the name of <code>MaasOpenContrail6.maas</code> is the  name which we could get from the MAAS webUI.</p>

<h3>Get/Set Constraints</h3>

<p>We could dynamically set constraints for adding/removing new machines or unit, get/set it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju get-constraints
</span><span class='line'>mem=3072M
</span><span class='line'>$ juju set-constraints "mem=1024M"
</span><span class='line'>$ juju get-constraints
</span><span class='line'>mem=1024M
</span></code></pre></td></tr></table></div></figure>


<h3>Tags</h3>

<p>Sometimes we need to add tags to specified maas units, the following webpage is for reference:   <br/>
<a href="http://en.community.dell.com/techcenter/os-applications/w/wiki/7432.using-tags-with-maas-and-juju-in-ubuntu-server-14-04-lts">http://en.community.dell.com/techcenter/os-applications/w/wiki/7432.using-tags-with-maas-and-juju-in-ubuntu-server-14-04-lts</a>  <br/>
<a href="https://maas.ubuntu.com/docs/tags.html">https://maas.ubuntu.com/docs/tags.html</a></p>

<h3>Remove specified service</h3>

<p>Get the status of the specified service via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju status neutron-api
</span><span class='line'>services:
</span><span class='line'>  neutron-api:
</span><span class='line'>    charm: cs:trusty/neutron-api-9
</span><span class='line'>    exposed: false
</span><span class='line'>    life: dying
</span><span class='line'>    units:
</span><span class='line'>      neutron-api/0:
</span><span class='line'>        agent-state: error
</span><span class='line'>        agent-state-info: 'hook failed: "install"'
</span><span class='line'>        agent-version: 1.21.3.1
</span><span class='line'>        life: dying
</span><span class='line'>        machine: "6"
</span><span class='line'>        public-address: MaasOpenContrail7.maas
</span><span class='line'>networks:
</span><span class='line'>  maas-eth0:
</span><span class='line'>    provider-id: maas-eth0
</span><span class='line'>    cidr: 10.17.17.0/24
</span></code></pre></td></tr></table></div></figure>


<p>Resolved this service&rsquo;s located units first:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Trusty@MassController:~/Code/deploy$ juju resolved neutron-api/0
</span></code></pre></td></tr></table></div></figure>


<p>Now remove the service via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Trusty@MassController:~/Code/deploy$ juju remove-service neutron-api
</span></code></pre></td></tr></table></div></figure>


<p>Sometimes you need to type in resolved the unit for several times.  <br/>
Finally, if your machine runs into error state, you could destroy it forcely via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju destroy-machine x --force
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/13">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/11">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/10/12/tips-on-oz/">Tips on OZ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/12/tips-on-cloud-init/">Tips on Cloud-Init</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/09/20151009bei-zhu/">20151009备注</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/08/20151008bei-zhu/">20151008备注</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/08/dockerize-markdown-written-cv/">Dockerize Markdown Written CV</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
