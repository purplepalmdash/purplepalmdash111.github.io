
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="AIM For sharing the internet connection from working PC to Surface Pro. Setup And Configuration SurfacePro Install bluez/bluez-libs/bluez-utils: 1
$ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/posts/9">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//fonts.googleapis.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/04/on-bluetooth-pan/">On Bluetooth PAN</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-04T10:51:10+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:51 am</span></time>
        
         | <a href="/blog/2015/12/04/on-bluetooth-pan/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>AIM</h3>

<p>For sharing the internet connection from working PC to Surface Pro.</p>

<h3>Setup And Configuration</h3>

<h4>SurfacePro</h4>

<p>Install bluez/bluez-libs/bluez-utils:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S bluez bluez-utils bluez-libs</span></code></pre></td></tr></table></div></figure>


<p>Modprobe the bnep kernel module:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@surfacepro ~]# modprobe bnep
</span><span class='line'>[root@surfacepro ~]# lsmod | grep bnep
</span><span class='line'>bnep                   20480  0
</span><span class='line'>bluetooth             450560  6 bnep,btbcm,btrtl,btusb,btintel
</span><span class='line'>[root@surfacepro ~]# modprobe btusb</span></code></pre></td></tr></table></div></figure>


<p>Start the bluetooth.service via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo systemctl start bluetooth.service</span></code></pre></td></tr></table></div></figure>


<p><code>bluetoothctl</code> will give access for configurating bluetooth equipment, following steps
shows how to connect to a bluetooth keyboard:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@surfacepro ~]# bluetoothctl 
</span><span class='line'>[NEW] Controller xx:xx:xx:xx:xx:xx surfacepro [default]
</span><span class='line'>[bluetooth]#
</span><span class='line'>[bluetooth]# agent KeyboardOnly 
</span><span class='line'>Agent registered
</span><span class='line'>[bluetooth]# default-agent      
</span><span class='line'>Default agent request successful
</span><span class='line'>[bluetooth]# power on
</span><span class='line'>[CHG] Controller xx:xx:xx:xx:xx:xx Class: 0x00011c
</span><span class='line'>Changing power on succeeded
</span><span class='line'>[CHG] Controller xx:XX:XX:XX:XX:XX Powered: yes
</span><span class='line'>[bluetooth]# scan on
</span><span class='line'>Discovery started
</span><span class='line'>[bluetooth]# pair D0:13:1E:11:F5:45
</span><span class='line'>Attempting to pair with D0:13:1E:11:F5:45
</span><span class='line'>[bluetooth]# connect D0:13:1E:11:F5:45</span></code></pre></td></tr></table></div></figure>


<p>Now try to connect to the keyboard, yes you could use keyboard for typing.</p>

<h4>PAN</h4>

<p>Network Aggregation Point - NAP</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/03/customize-surfacepro-kernel/">Customize SurfacePro Kernel</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-03T17:44:32+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>5:44 pm</span></time>
        
         | <a href="/blog/2015/12/03/customize-surfacepro-kernel/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Preparation</h3>

<p>Get the kernel and patch file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>To be Written</span></code></pre></td></tr></table></div></figure>


<h3>Build</h3>

<p>Prepare for compiliation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ make mrproper</span></code></pre></td></tr></table></div></figure>


<p>Get the current running configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ zcat /proc/config.gz &gt; .config
</span><span class='line'>$ make menuconfig
</span><span class='line'>$ make -j3
</span><span class='line'>$ make modules_install</span></code></pre></td></tr></table></div></figure>


<p>Install Kernel, you newly generated kernel will be named as
<code>vmlinuz-4.1.13-surfacepro3</code>(Though surfacepro, surfacepro3 will remains its name) :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo cp -v arch/x86/boot/bzImage /boot/vmlinuz-4.1.13-surfacepro3</span></code></pre></td></tr></table></div></figure>


<p>Generate the initial RAM disk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mkinitcpio -k 4.1.13-surfacepro3 -c /etc/mkinitcpio.conf -g  \ 
</span><span class='line'>/boot/initramfs-4.1.13-surfacepro3.img</span></code></pre></td></tr></table></div></figure>


<p>Copy System.map, it contains a list of kernel symbols.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo cp System.map /boot/System.map-4.1.13-surfacepro3
</span><span class='line'>$ sudo ln -sf /boot/System.map-4.1.13-surfacepro3 /boot/System.map</span></code></pre></td></tr></table></div></figure>


<p>Install the grub&rsquo;s configuration into grub.cfg:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/default/grub
</span><span class='line'>Edit with the name specified
</span><span class='line'>$ sudo grub-mkconfig -o /boot/grub/grub.cfg</span></code></pre></td></tr></table></div></figure>


<p>But still this modification didn&rsquo;t solve surfacepro&rsquo;s wireless problem. finally I have
to fall back to using yaourt&rsquo;s surfac pro kernel.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/25/awesomes-battery-indicator/">Awesome's Battery Indicator</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-25T12:18:29+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:18 pm</span></time>
        
         | <a href="/blog/2015/11/25/awesomes-battery-indicator/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Background</h3>

<p>I installed ArchLinux+Awesome On my SurfacePro, while the charger of Surface Pro is not
so tight to the pad. Thus I have to use a battery indicator in Awesome.</p>

<h3>Software</h3>

<p>Refers to:</p>

<p><a href="http://www.everythingisvoid.com/uncategorized/simple-battery-status-indicator-awesome-window-manager">http://www.everythingisvoid.com/uncategorized/simple-battery-status-indicator-awesome-window-manager</a></p>

<p>Install steps on ArchLinux:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S luarocks5.1 gobject-introspection acpi
</span><span class='line'>$ sudo luarocks-5.1 install battery_status</span></code></pre></td></tr></table></div></figure>


<p>You could manually run <code>show_battery_status</code> or add it into your own rc.lua file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim ~/.config/awesome/rc.lua
</span><span class='line'>----.....................
</span><span class='line'>autorunApps =
</span><span class='line'>{
</span><span class='line'>--.........
</span><span class='line'>"synergyc 192.168.0.119",
</span><span class='line'>"sudo echo 1240&gt;/sys/class/backlight/intel_backlight/brightness", 
</span><span class='line'>"fcitx",
</span><span class='line'>"show_battery_status", 
</span><span class='line'>----.....................</span></code></pre></td></tr></table></div></figure>


<p>Now restart the awesome you could see the battery indicator.</p>

<h3>Add Charging Indicator</h3>

<p>First download the source code from github:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/svarogg/battery_status</span></code></pre></td></tr></table></div></figure>


<p>Debug with luarocks loader:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rocks-5.1   lua5.1 -lluarocks.loader
</span><span class='line'>Lua 5.1.5  Copyright (C) 1994-2012 Lua.org, PUC-Rio
</span><span class='line'>&gt; require("rex_posix")
</span><span class='line'>&gt; rex = require("rex_posix")
</span><span class='line'>&gt; battery_rex = rex.new([[([^,]{1,3})%]])
</span><span class='line'>&gt; rex=require("rex_posix")
</span><span class='line'>&gt; battery_rex=rex.new([[([^,]{1,3})%]])
</span><span class='line'>&gt; acpi=io.popen('acpi 2&gt;&1')
</span><span class='line'>&gt; acpi_res = acpi:read("*line")
</span><span class='line'>&gt; acpi:close()
</span><span class='line'>&gt; print (acpi_res)
</span><span class='line'>Battery 0: Full, 100%
</span><span class='line'>&gt; percentage=battery_rex:match(acpi_res)
</span><span class='line'>&gt; print (percentage)
</span><span class='line'>100
</span><span class='line'>&gt; print(type(percentage))
</span><span class='line'>string
</span><span class='line'>&gt; print(type(tonumber(percentage)))
</span><span class='line'>number
</span><span class='line'>&gt; adapter = io.popen('acpi -a 2&gt;&1')
</span><span class='line'>&gt; adapter_res = adapter:read("*line")
</span><span class='line'>&gt; adapter:close()
</span><span class='line'>&gt; print(adapter_res)
</span><span class='line'>Adapter 0: on-line
</span><span class='line'>&gt; charge_rex = rex.new([[(on|off)]])
</span><span class='line'>&gt; print(charge_rex:match(adapter_res))
</span><span class='line'>on</span></code></pre></td></tr></table></div></figure>


<p>We get the status of the charge, then update the corresponding icon to the systray.</p>

<p>The modified repository could be fetched from:</p>

<p><a href="https://github.com/purplepalmdash/Awesome-Battery-Indicator">https://github.com/purplepalmdash/Awesome-Battery-Indicator</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/18/tips-on-archlinux-on-ssd-for-surfacepro/">Tips on ArchLinux on SSD for SurfacePro</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-18T16:59:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:59 pm</span></time>
        
         | <a href="/blog/2015/11/18/tips-on-archlinux-on-ssd-for-surfacepro/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Hardware</h3>

<p>Surface Pro, KingShare 128G SSD(USB).</p>

<p>Picture will be updated after successfully installed.</p>

<h3>Virtualbox Way</h3>

<p>Make a vmdk file which actually points to the USB Disk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo VBoxManage internalcommands createrawvmdk -filename ./rawusb1.vmdk -rawdisk \ 
</span><span class='line'>/dev/disk/by-id/usb-KINGSHAR_KS-CUTS25W_123456789010-0:0
</span><span class='line'>$ sudo chown -R YourName rawusb1.vmdk</span></code></pre></td></tr></table></div></figure>


<p>Now using this rawdisk for starting the VirtualBox based machine.</p>

<p><img src="/images/2015_11_18_17_10_46_645x529.jpg" alt="/images/2015_11_18_17_10_46_645x529.jpg" /></p>

<h3>Installation</h3>

<p>The system installation is refers to following links:</p>

<p><a href="https://wiki.archlinux.org/index.php/Microsoft_Surface_Pro_3">https://wiki.archlinux.org/index.php/Microsoft_Surface_Pro_3</a></p>

<p><a href="https://wiki.archlinux.org/index.php/Installing_Arch_Linux_on_a_USB_key">https://wiki.archlinux.org/index.php/Installing_Arch_Linux_on_a_USB_key</a></p>

<h3>Updated Configuration</h3>

<p>Finally I installed the surface pro by using a usb dongle which burned the archlinux
installation iso, put it into the surface pro and startup the machine pressing power
key and volume down key, it will goes into the installtion steps.</p>

<p>Install the system on the SSD, the main steps are available at:</p>

<p><a href="http://purplepalmdash.github.io/blog/2014/06/16/archlinux-on-surface-pro/">http://purplepalmdash.github.io/blog/2014/06/16/archlinux-on-surface-pro/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@archiso ~ # mount /dev/sdb2 /mnt
</span><span class='line'>root@archiso ~ # mount /dev/sdb1 /mnt/boot/EFI 
</span><span class='line'>root@archiso ~ # arch-chroot /mnt /bin/bash
</span><span class='line'>[root@archiso /]# grub-install --target=x86_64-efi --efi-directory=/boot/EFI \ 
</span><span class='line'>--bootloader-id=arch_grub --recheck
</span><span class='line'>[root@archiso /]# grub-mkconfig -o /boot/grub/grub.cfg</span></code></pre></td></tr></table></div></figure>


<p>Because I frequently change the installtion media(I have SSD and Harddisk), so
everytime I change the installtion media, I have to run above steps again.</p>

<h3>Kernel Configuration</h3>

<p>Install the kernel from yaourt, you could get the surfacepro3 compatiable linux kernel,
install it on surface pro will also be OK:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ yaourt surfacepro
</span><span class='line'>1 aur/linux-surfacepro3 4.3-1 [installed] (5)
</span><span class='line'>    The Linux-surfacepro3 kernel and modules
</span><span class='line'>2 aur/linux-surfacepro3-docs 4.3-1 (5)
</span><span class='line'>    Kernel hackers manual - HTML documentation that comes with the Linux-surfacepro3
</span><span class='line'>kernel
</span><span class='line'>3 aur/linux-surfacepro3-headers 4.3-1 (5)
</span><span class='line'>    Header files and scripts for building modules for Linux-surfacepro3 kernel</span></code></pre></td></tr></table></div></figure>


<p>After installation, you have to manually generate the grub items:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo grub-mkconfig -o /boot/grub/grub.cfg</span></code></pre></td></tr></table></div></figure>


<p>Now reboot the surface pro, you could view the kernel has been upgraded to our newly
installed version:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>➜  ~  uname -a
</span><span class='line'>Linux surfacepro 4.3.0-1-surfacepro3 #1 SMP PREEMPT Fri Nov 20 05:47:41 CST 2015 x86_64
</span><span class='line'>GNU/Linux</span></code></pre></td></tr></table></div></figure>


<p>With the new version of kernel, you won&rsquo;t face too much problems, my problem is when
using the official kernel, my wifi will get stucked, sometimes the machine will be
dead.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/16/spice-client/">Spice Client</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-16T21:20:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:20 pm</span></time>
        
         | <a href="/blog/2015/11/16/spice-client/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Image Conversion</h3>

<p>Convert the vdi files into qcow2 file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ qemu-img convert -f vdi -O qcow2 Windows81.vdi Windows81.qcow2</span></code></pre></td></tr></table></div></figure>


<p>Then continue to create the virtual machine via importing the img.</p>

<h3>Spice Client</h3>

<p>Using virtviewer for view the remote machine.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S virtviewer
</span><span class='line'>$ remote-viewer spice://localhost:5900</span></code></pre></td></tr></table></div></figure>


<p>Or you could view the desktop via <code>spicec</code>.</p>

<p>The listening port could be view via <code>netstat -anp | grep 5900</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/13/win10-tips-for-using-xshell/">Win10 Tips for Using Xshell</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-13T15:59:16+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:59 pm</span></time>
        
         | <a href="/blog/2015/11/13/win10-tips-for-using-xshell/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Won&rsquo;t change the size of the window when you disable the window size:</p>

<p><img src="/images/Xshell_1.jpg" alt="/images/Xshell_1.jpg" /></p>

<p>When using vim, the wrappered module should be disable, thus won&rsquo;t cause you
mis-editing the content of the file:</p>

<p><img src="/images/Xshell_2.jpg" alt="/images/Xshell_2.jpg" /></p>

<p>The configuration should be applied to each session.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/13/variety/">Variety</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-13T11:05:05+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:05 am</span></time>
        
         | <a href="/blog/2015/11/13/variety/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>参考</h3>

<p><a href="http://peterlevi.com/variety/how-to-install/">http://peterlevi.com/variety/how-to-install/</a></p>

<h3>安装</h3>

<p>Ubuntu上，从ppa安装:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo add-apt-repository ppa:peterlevi/ppa
</span><span class='line'>$ sudo apt-get update
</span><span class='line'>$ sudo apt-get install variety</span></code></pre></td></tr></table></div></figure>


<h3>配置</h3>

<p>安装完毕后，在终端下键入<code>variety</code>即可开始配置该软件，第一次会询问是否创建一个用于多终端
主机之间同步桌面壁纸的账户:</p>

<p><img src="/images/2015_11_13_11_10_35_755x507.jpg" alt="/images/2015_11_13_11_10_35_755x507.jpg" /></p>

<p>这一步是可选的，我们在这里先注册上. 需要注意的是，用翻墙后的浏览器完成注册.</p>

<p>一般情况下这里就能使用了，但是awesome桌面环境下需要增加一下这行:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /home/XXXXXXX/.config/variety/scripts/set_wallpaper
</span><span class='line'>### Finally we comes to awesome!  
</span><span class='line'>awsetbg "$WP" 2&gt; /dev/null</span></code></pre></td></tr></table></div></figure>


<p>Or: if you use newer version of awesome, awsetbg won&rsquo;t take effect, use feh instead:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>feh --bg-scale "$WP" 2&gt;/dev/null</span></code></pre></td></tr></table></div></figure>


<h3>进一步美化</h3>

<p>Awesome下就只能换换壁纸，本身终端也不支持透明度的配置，如果是gnome之类的桌面环境，可以
把terminal emulator的透明度打开，能获得很好的视觉效果。</p>

<p>默认的更新频率是5分钟更新一次，当然在配置界面下可以更改为更短/更长的时限。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/05/good-material/">Good Material</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-05T10:41:22+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:41 am</span></time>
        
         | <a href="/blog/2015/11/05/good-material/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Movie</h3>

<p>Sorted by director:  <br/>
<a href="http://pan.baidu.com/share/home?uk=72456331&amp;view=share#category/type=0">http://pan.baidu.com/share/home?uk=72456331&amp;view=share#category/type=0</a></p>

<h3>Good BookMark Of Zhihu</h3>

<p><a href="http://www.zhihu.com/collection/38938285?page=2">http://www.zhihu.com/collection/38938285?page=2</a></p>

<h3>Linux Wondering</h3>

<p><a href="http://i.linuxtoy.org/docs/guide/index.html">http://i.linuxtoy.org/docs/guide/index.html</a></p>

<h3>Oh My Zsh</h3>

<p><a href="https://github.com/robbyrussell/oh-my-zsh">https://github.com/robbyrussell/oh-my-zsh</a></p>

<p><a href="http://www.kafeitu.me/shell/2012/03/25/oh-my-zsh.html">http://www.kafeitu.me/shell/2012/03/25/oh-my-zsh.html</a></p>

<p><a href="https://github.com/robbyrussell/oh-my-zsh/wiki/themes">https://github.com/robbyrussell/oh-my-zsh/wiki/themes</a></p>

<p><a href="http://segmentfault.com/a/1190000002658335">http://segmentfault.com/a/1190000002658335</a></p>

<h3>Wondering In Guangzhou</h3>

<p><a href="http://www.zhihu.com/question/36159147">http://www.zhihu.com/question/36159147</a></p>

<h3>Impress.js</h3>

<p>Use this javascript for writing the PPT. <br/>
<a href="https://github.com/impress/impress.js">https://github.com/impress/impress.js</a></p>

<h3>Programming On Dialog</h3>

<p><a href="http://www.cyberciti.biz/tips/spice-up-your-unix-linux-shell-scripts.html">http://www.cyberciti.biz/tips/spice-up-your-unix-linux-shell-scripts.html</a></p>

<p><a href="https://techbase.kde.org/Development/Tutorials/Shell_Scripting_with_KDE_Dialogs">https://techbase.kde.org/Development/Tutorials/Shell_Scripting_with_KDE_Dialogs</a></p>

<h3>Remote Control Of Arduino</h3>

<p><a href="http://www.geek-workshop.com/thread-25230-1-1.html">http://www.geek-workshop.com/thread-25230-1-1.html</a></p>

<h3>Processing</h3>

<p><a href="http://open.sina.com.cn/course/id_300/lesson_4094/">http://open.sina.com.cn/course/id_300/lesson_4094/</a></p>

<h3>KVM Hardware</h3>

<p><a href="http://www.cnblogs.com/sammyliu/p/4548194.html">http://www.cnblogs.com/sammyliu/p/4548194.html</a></p>

<h3>OVS Howto</h3>

<p><a href="http://roan.logdown.com/posts/191801-set-openvswitch">http://roan.logdown.com/posts/191801-set-openvswitch</a> <br/>
<a href="http://openvswitch.org/support/config-cookbooks/vlan-configuration-cookbook/">http://openvswitch.org/support/config-cookbooks/vlan-configuration-cookbook/</a> <br/>
<a href="http://notes.yuwh.net/%E5%9C%A8centos7%E4%B8%8A%E9%85%8D%E7%BD%AEopen-vswitch%E5%92%8Cvxlan/">http://notes.yuwh.net/%E5%9C%A8centos7%E4%B8%8A%E9%85%8D%E7%BD%AEopen-vswitch%E5%92%8Cvxlan/</a></p>

<h3>Good Books</h3>

<p><a href="http://pan.baidu.com/share/home?uk=2704770694&amp;view=share#category/type=0">http://pan.baidu.com/share/home?uk=2704770694&amp;view=share#category/type=0</a></p>

<p><a href="http://www.hi-pda.com/forum/viewthread.php?tid=1774264&amp;extra=page%3D1">http://www.hi-pda.com/forum/viewthread.php?tid=1774264&amp;extra=page%3D1</a></p>

<h3>TOP 5 NEW python module</h3>

<p><a href="blog.rtwilson.com/my-top-5-new-python-modules-of-2015">blog.rtwilson.com/my-top-5-new-python-modules-of-2015</a></p>

<h3>NSX</h3>

<p><a href="http://182.92.228.21:8080/chat/ZhibOrDianb?videoNu=video2015_12_02&amp;userId=#rd&amp;sukey=7f8f3cb2e9b0da45ed3acfb7ec91e76ac7b569b3d3190e352be587f5c2a9299faa83829a51886d2e5093f49a8ea542db">http://182.92.228.21:8080/chat/ZhibOrDianb?videoNu=video2015_12_02&amp;userId=#rd&amp;sukey=7f8f3cb2e9b0da45ed3acfb7ec91e76ac7b569b3d3190e352be587f5c2a9299faa83829a51886d2e5093f49a8ea542db</a></p>

<p><a href="http://blog.remibergsma.com/2015/04/04/adding-a-kvm-cluster-with-nsx-networking-to-cloudstack/">http://blog.remibergsma.com/2015/04/04/adding-a-kvm-cluster-with-nsx-networking-to-cloudstack/</a></p>

<p><a href="http://dailyhypervisor.com/blog-posts/">http://dailyhypervisor.com/blog-posts/</a></p>

<h3>Improve VM Performance</h3>

<p><a href="http://download.techtarget.com.cn//guide/2014/11/improvevmperformance.pdf">http://download.techtarget.com.cn//guide/2014/11/improvevmperformance.pdf</a></p>

<h3>Top 10 Projects</h3>

<p><a href="https://linux.cn/article-6911-1.html?utm_source=weibo&amp;utm_medium=weibo">https://linux.cn/article-6911-1.html?utm_source=weibo&amp;utm_medium=weibo</a></p>

<h3>Using docker building images</h3>

<p><a href="https://github.com/ContainerTribe/diskimage-builder-dockerfile">https://github.com/ContainerTribe/diskimage-builder-dockerfile</a></p>

<h3>Things to be done</h3>

<ol>
<li>Mirgration from hard-disk to USB disk.</li>
<li>Hacking into the mouse.</li>
<li>bootstrap themes.
<a href="http://startbootstrap.com/template-categories/all/">http://startbootstrap.com/template-categories/all/</a></li>
</ol>


<h3>Around opengl</h3>

<p><a href="http://www.oschina.net/news/69978/linux-kernel-4-4-lts#0-tsina-1-39202-397232819ff9a47a7b7e80a40613cfe1">http://www.oschina.net/news/69978/linux-kernel-4-4-lts#0-tsina-1-39202-397232819ff9a47a7b7e80a40613cfe1</a></p>

<h3>Life Quality</h3>

<p><a href="https://www.zhihu.com/question/26522007">https://www.zhihu.com/question/26522007</a></p>

<h3>Necklace</h3>

<p><a href="http://search.smzdm.com/?c=faxian&amp;s=%E9%A1%B9%E9%93%BE+%E7%9B%B4%E9%82%AE&amp;p=2">http://search.smzdm.com/?c=faxian&amp;s=%E9%A1%B9%E9%93%BE+%E7%9B%B4%E9%82%AE&amp;p=2</a></p>

<h3>Game Dev 101</h3>

<p><a href="https://blog.openshift.com/game-development-101-with-openshift/">https://blog.openshift.com/game-development-101-with-openshift/</a></p>

<h3>Good Shop</h3>

<p><a href="http://i.biopatent.cn/">http://i.biopatent.cn/</a></p>

<h3>LED DIY</h3>

<p><a href="http://www.geek-workshop.com/thread-25319-1-1.html">http://www.geek-workshop.com/thread-25319-1-1.html</a></p>

<h3>python new book</h3>

<p>python爱好者  <br/>
新书推荐《data Wrangling with Python Tips and Tools to Make Your Life Easier》</p>

<h3>Web Torrent</h3>

<p><a href="https://webtorrent.io/desktop">https://webtorrent.io/desktop</a></p>

<h3>Online IDE</h3>

<p><a href="http://www.tutorialspoint.com/compile_java_online.php">http://www.tutorialspoint.com/compile_java_online.php</a> <br/>
nitrous.io</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/05/frdm-kl02z-tips-1/">FRDM-KL02Z Tips(1)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-05T09:53:38+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:53 am</span></time>
        
         | <a href="/blog/2015/11/05/frdm-kl02z-tips-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Reference Material: <br/>
<a href="http://www.freescale.com/zh-Hans/products/arm-processors/kinetis-cortex-m/l-series/freedom-development-platform-for-the-kinetis-kl02-family:FRDM-KL02Z?tab=In-Depth_Tab">http://www.freescale.com/zh-Hans/products/arm-processors/kinetis-cortex-m/l-series/freedom-development-platform-for-the-kinetis-kl02-family:FRDM-KL02Z?tab=In-Depth_Tab</a></p>

<h3>Minicom</h3>

<p>115200/data-bit: 8/ no parity/stop bit 1.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/04/cloudstack-vrlian-jie-shu/">CloudStack VR连接数</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-04T10:56:12+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:56 am</span></time>
        
         | <a href="/blog/2015/11/04/cloudstack-vrlian-jie-shu/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>All-In-One VR性能测试</h2>

<h3>测试环境</h3>

<h4>硬件</h4>

<p><strong>CPU</strong>: Intel&reg; Core&trade; i7-3770 CPU @ 3.40GHz, 四核八线程。 <br/>
<strong>内存</strong>: 24 G。</p>

<h4>虚拟机网络</h4>

<p><strong>虚拟机网络</strong>: 新建网段为10.82.89.0/24, DHCP范围设置如下，NAT转发外网: <br/>
<img src="/images/2015_11_04_09_24_37_479x293.jpg" alt="/images/2015_11_04_09_24_37_479x293.jpg" /></p>

<h4>All-In-One 虚拟机</h4>

<p><strong>CPU</strong>: 6 Core, Copy Host CPU Configuration。     <br/>
<strong>内存</strong>: 8 G。
<strong>硬盘</strong>: 200 G。
<strong>系统</strong>: Ubuntu 14.04 x86_64。  <br/>
<strong>CloudStack版本</strong>: 4.5.2。</p>

<h4>CloudStack环境</h4>

<p><strong>Zone</strong>: Advance Zone(PerfZone)。 <br/>
<strong>IP</strong>: 取10.82.89.0/24中DHCP尚未使用的IP地址。    <br/>
<strong>测试机模板</strong>: ubuntu64perftest.qcow2(<a href="http://192.168.0.79/ubuntu64perftest.qcow2">http://192.168.0.79/ubuntu64perftest.qcow2</a>) <br/>
<strong>测试机套餐</strong>: 2 Core, 内存3G。</p>

<h4>拓扑图及说明</h4>

<p><img src="/images/allinone.jpeg" alt="/images/allinone.jpeg" /></p>

<p>IP地址说明:</p>

<p><strong>All-In-One</strong>:  10.82.89.89   <br/>
<strong>Test Server</strong>: CloudStack实例，NAT后的10.82.89.0/24地址  <br/>
<strong>VR</strong>: CloudStack自动分配的10.82.89.0/24地址  <br/>
<strong>KVM</strong>: All-In-One上运行的虚拟机，绑定8个IP地址, 10.82.89.11/10.82.89.254~10.82.89.247</p>

<h3>测试方法</h3>

<p>Test Server上运行一个可支持多用户长时间在线的服务端程序，并可统计同时在线人数，接受外部
客户端发来的服务请求。</p>

<p>Test Client上运行一个快速发起并保持连接的客户端程序，服务端地址指向Test Server, 服务端
口即Test Server上服务端程序监听的端口。</p>

<p>单个IP最多支持6万多个活动连接，为了提升单台机器能支持的同时在线人数，需要在Test Client
上同时绑定多个网卡，kvm最多支持8个网卡，60000*8=500000, 单台机可以发起并保持的连接数超
过50万。</p>

<p>Server端代码下载地址:  <br/>
<a href="https://gist.github.com/yongboy/5318930/raw/ccf8dc236da30fcf4f89567d567eaf295b363d47/server.c">https://gist.github.com/yongboy/5318930/raw/ccf8dc236da30fcf4f89567d567eaf295b363d47/server.c</a></p>

<p>Client端代码下载地址:</p>

<p><a href="https://gist.github.com/yongboy/5324779/raw/f29c964fcd67fefc3ce66e487a44298ced611cdc/client2.c">https://gist.github.com/yongboy/5324779/raw/f29c964fcd67fefc3ce66e487a44298ced611cdc/client2.c</a></p>

<h3>打开各节点限制</h3>

<p>在All-In-One机器/Test Server/Test Client上，均需要打开以下限制:</p>

<h4>最大文件句柄数</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/security/limits.conf
</span><span class='line'>
</span><span class='line'>* soft nofile 104857
</span><span class='line'>* hard nofile 104857</span></code></pre></td></tr></table></div></figure>


<h4>最大文件数限制</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/sysctl.conf
</span><span class='line'>fs.file-max=1048576
</span><span class='line'># sudo sysctl -p /etc/sysctl.conf</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>conntrack最大连接数</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/sysctl.conf
</span><span class='line'>net.netfilter.nf_conntrack_max = 6553500
</span><span class='line'># sysctl -p /etc/sysctl.conf</span></code></pre></td></tr></table></div></figure>


<h4>可用端口数</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /etc/sysctl.conf
</span><span class='line'>    net.ipv4.ip_local_port_range= 1024 65535
</span><span class='line'># sysctl -p /etc/sysctl.conf</span></code></pre></td></tr></table></div></figure>


<p>更改完毕后，需要重新启动机器生效，为了使sysctl的配置每次都生效，可以考虑将命令加到启动
项中。</p>

<h3>测试过程</h3>

<h4>启动Server端：</h4>

<p>Server端启动后将监听服务器端的8000端口：</p>

<p><img src="/images/2015_11_04_10_25_54_816x191.jpg" alt="/images/2015_11_04_10_25_54_816x191.jpg" /></p>

<h4>启动Client端：</h4>

<p>单机多网卡</p>

<p>在All-In-One机器上，由下面的命令启动qemu实例,则可以得到8块网卡的虚拟机, 内存大小<code>-m
5120</code>可以调小，一般1024～2048就够:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo qemu-system-x86_64 -net nic,model=virtio,macaddr=52:54:00:12:34:56,vlan=1
</span><span class='line'>-net tap,vlan=1 -net nic,model=virtio,macaddr=52:54:00:12:34:57,vlan=2 -net
</span><span class='line'>tap,vlan=2 -net nic,model=virtio,macaddr=52:54:00:12:34:58,vlan=3 -net
</span><span class='line'>tap,vlan=3 -net nic,model=virtio,macaddr=52:54:00:12:34:59,vlan=4 -net
</span><span class='line'>tap,vlan=4 -net nic,model=virtio,macaddr=52:54:00:12:34:60,vlan=5 -net
</span><span class='line'>tap,vlan=5 -net nic,model=virtio,macaddr=52:54:00:12:34:61,vlan=6 -net
</span><span class='line'>tap,vlan=6 -net nic,model=virtio,macaddr=52:54:00:12:34:62,vlan=7 -net
</span><span class='line'>tap,vlan=7 -net nic,model=virtio,macaddr=52:54:00:12:34:63,vlan=8 -net
</span><span class='line'>tap,vlan=8 -hda ./ubuntu64perftest.qcow2 -m 5120 --enable-kvm</span></code></pre></td></tr></table></div></figure>


<p>启动虚拟机后, 在虚拟机里设置地址(默认只从eth0得到dhcp地址):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat ./ethernet.sh
</span><span class='line'>ifconfig eth1 up
</span><span class='line'>ifconfig eth1 192.168.1.254
</span><span class='line'>ifconfig eth2 up
</span><span class='line'>ifconfig eth2 192.168.1.253
</span><span class='line'>ifconfig eth3 up
</span><span class='line'>ifconfig eth3 192.168.1.252
</span><span class='line'>ifconfig eth4 up
</span><span class='line'>ifconfig eth4 192.168.1.251
</span><span class='line'>ifconfig eth5 up
</span><span class='line'>ifconfig eth5 192.168.1.250
</span><span class='line'>ifconfig eth6 up
</span><span class='line'>ifconfig eth6 192.168.1.249
</span><span class='line'>ifconfig eth7 up
</span><span class='line'>ifconfig eth7 192.168.1.248</span></code></pre></td></tr></table></div></figure>


<p>客户端中，发起海量连接的脚本:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> cat startbomb.sh 
</span><span class='line'>#!/bin/sh
</span><span class='line'>./client2 -h 192.168.1.109 -p 8000 -m 64000 -o
</span><span class='line'>192.168.1.16,192.168.1.254,192.168.1.253,192.168.1.252, 
</span><span class='line'>192.168.1.251,192.168.1.250,192.168.1.249,192.168.1.248</span></code></pre></td></tr></table></div></figure>


<p>调用<code>./startbomb.sh</code>即可开始对Server端发起大量在线连接</p>

<h3>测试截图</h3>

<p>这里记录一次完整的VR因为过多连接数造成内存耗尽自动重启的过程。</p>

<p>在CloudStack的实例上运行server端程序, 此时的输出如下:</p>

<p>VR的<code>top</code>输出:</p>

<p><img src="/images/2015_11_02_21_11_06_810x293.jpg" alt="/images/2015_11_02_21_11_06_810x293.jpg" /></p>

<p>Server输出:</p>

<p><img src="/images/2015_11_02_21_13_37_788x205.jpg" alt="/images/2015_11_02_21_13_37_788x205.jpg" /></p>

<p>客户端开始发包连接的过程中:</p>

<p>10W:</p>

<p><img src="/images/2015_11_02_21_15_11_794x589.jpg" alt="/images/2015_11_02_21_15_11_794x589.jpg" /></p>

<p>20W:</p>

<p><img src="/images/2015_11_02_21_15_53_841x563.jpg" alt="/images/2015_11_02_21_15_53_841x563.jpg" /></p>

<p>30W:</p>

<p><img src="/images/2015_11_02_21_16_35_902x622.jpg" alt="/images/2015_11_02_21_16_35_902x622.jpg" /></p>

<p>40W:</p>

<p><img src="/images/2015_11_02_21_17_19_869x654.jpg" alt="/images/2015_11_02_21_17_19_869x654.jpg" /></p>

<p>44W, VR轰挂:</p>

<p><img src="/images/2015_11_02_21_18_06_813x689.jpg" alt="/images/2015_11_02_21_18_06_813x689.jpg" /></p>

<p>此时查看VR的重启时间:</p>

<p><img src="/images/2015_11_02_21_18_56_665x149.jpg" alt="/images/2015_11_02_21_18_56_665x149.jpg" /></p>

<p>可以看到VR启动时间很短，这证明VR由于内存耗尽已经自动重启了。</p>

<h3>应对策略</h3>

<h4>暂时应对</h4>

<p>在VR上对每个进/出 虚拟路由器的IP作连接数限制，TCP/UDP都需要设置。ICMP暂时未作限定:</p>

<p>Iptables规则如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-A PREROUTING -i eth0 -p tcp  -m connlimit --connlimit-above 1000 --connlimit-mask 32 
</span><span class='line'>--connlimit-saddr -j DROP
</span><span class='line'>-A PREROUTING -i eth2 -p tcp  -m connlimit --connlimit-above 1000 --connlimit-mask 32
</span><span class='line'>--connlimit-saddr -j DROP
</span><span class='line'>-A PREROUTING -i eth0 -p udp  -m connlimit --connlimit-above 1000 --connlimit-mask 32
</span><span class='line'>--connlimit-saddr -j DROP
</span><span class='line'>-A PREROUTING -i eth2 -p udp  -m connlimit --connlimit-above 1000 --connlimit-mask 32
</span><span class='line'>--connlimit-saddr -j DROP</span></code></pre></td></tr></table></div></figure>


<p>添加完此规则后，Test Server最多可接受1000个同时在线连接。这时在Client端发起大量连接超过
1000的都会被VR的iptables规则链丢弃。</p>

<h4>潜在问题</h4>

<p>对于过多过快的攻击性连接，VR匹配iptables会造成VR CPU占用率过高。建议采用硬件防火墙来阻
挡这类
攻击。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/10">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/8">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/05/18/working-tips-on-ansible-cobbler-3/">Working Tips on Ansible-cobbler(3)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/12/tips-on-maas-2-dot-0/">Tips on Maas 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/11/setup-lxd-on-ubuntu1604/">Setup LXD on Ubuntu1604</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/10/tips-on-lxc/">Tips on Lxc</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/09/working-tips-on-mesos-slash-ansible/">Working Tips on Mesos/Ansible</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
