
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="Reference: https://software.intel.com/en-us/blogs/2014/12/28/experimenting-with-openstack-sahara-on-docker-containers I wanna enable the docker as &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/posts/5">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.useso.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/07/deploy-opencontrail-on-centos-with-docker/">Deploy OpenContrail on CentOS With Docker as Hypervisor</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-07T16:50:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>4:50 pm</span></time>
        
         | <a href="/blog/2015/04/07/deploy-opencontrail-on-centos-with-docker/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Reference:  <br/>
<a href="https://software.intel.com/en-us/blogs/2014/12/28/experimenting-with-openstack-sahara-on-docker-containers">https://software.intel.com/en-us/blogs/2014/12/28/experimenting-with-openstack-sahara-on-docker-containers</a>  <br/>
I wanna enable the docker as hypervisor then it would greatly save the resources, and benefit with docker&rsquo;s rich resources. Following is the steps:</p>

<h3>Preparation</h3>

<p>First create the image file via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># qemu-img create -f qcow2 CentOSOpenContrail.qcow2 100G
</span><span class='line'>Formatting 'CentOSOpenContrail.qcow2', fmt=qcow2 size=107374182400 encryption=off cluster_size=65536 
</span><span class='line'>[root:/home/juju/img/CentOSOpenContrail]# pwd
</span><span class='line'>/home/juju/img/CentOSOpenContrail
</span></code></pre></td></tr></table></div></figure>


<p>Then create a virtual machine based on KVM, allocate 8G Memory, 4-core, which copies the host CPU configuration.</p>

<h3>Installation</h3>

<p>After installation, update the installed software via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup   
</span><span class='line'>$ wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo 
</span><span class='line'>$ sudo yum makecache
</span><span class='line'>$ sudo yum update -y
</span><span class='line'>$ sudo reboot
</span></code></pre></td></tr></table></div></figure>


<p>Install following packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wget https://repos.fedorapeople.org/repos/openstack/openstack-juno/rdo-release-juno-1.noarch.rpm
</span><span class='line'># rpm -ivh rdo-release-juno-1.noarch.rpm 
</span><span class='line'># yum install â€“y https://rdo.fedorapeople.org/rdo-release.rpm
</span><span class='line'># yum install openstack-packstack
</span></code></pre></td></tr></table></div></figure>


<p>Now you could use packstack for installing the packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># packstack --gen-answer-file=/root/answer.txt
</span><span class='line'># packstack --answer-file=/root/answer.txt
</span></code></pre></td></tr></table></div></figure>


<p>Install openstack-sahara via following command, the python-tox enable tox for generating the configuration files for sahara:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># yum install openstack-sahara 
</span><span class='line'># yum install python-tox
</span></code></pre></td></tr></table></div></figure>


<p>Create the username and password for sahara to use:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@10-17-17-183 etc]# mysql
</span><span class='line'>MariaDB [(none)]&gt; create user 'sahara'@'localhost' identified by 'saharapass';
</span><span class='line'>Query OK, 0 rows affected (0.07 sec)
</span><span class='line'>MariaDB [(none)]&gt; show databases;
</span><span class='line'>+--------------------+
</span><span class='line'>| Database           |
</span><span class='line'>+--------------------+
</span><span class='line'>| information_schema |
</span><span class='line'>| cinder             |
</span><span class='line'>| glance             |
</span><span class='line'>| keystone           |
</span><span class='line'>| mysql              |
</span><span class='line'>| neutron            |
</span><span class='line'>| nova               |
</span><span class='line'>| performance_schema |
</span><span class='line'>| test               |
</span><span class='line'>+--------------------+
</span><span class='line'>9 rows in set (0.00 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; use mysql
</span><span class='line'>MariaDB [mysql]&gt; show tables;
</span><span class='line'>MariaDB [mysql]&gt; select * from user;
</span><span class='line'>+-----------+----------------+-----------------------------------
</span></code></pre></td></tr></table></div></figure>


<p>How to get all of the password configuration information of packstack?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /etc/
</span><span class='line'>$ grep -i "sql://" ./ -r
</span></code></pre></td></tr></table></div></figure>


<p>Create a database named &lsquo;saharaDB" and grant it to user sahra:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MariaDB [(none)]&gt; create database saharaDB;
</span><span class='line'>MariaDB [(none)]&gt; grant all on saharaDB.* to 'sahara'@'localhost';
</span><span class='line'>Query OK, 0 rows affected (0.02 sec)
</span><span class='line'>
</span><span class='line'>MariaDB [(none)]&gt; quit;
</span><span class='line'>[root@10-17-17-183 etc]# mysql -h 127.0.0.1 -u sahara -p saharaDB
</span><span class='line'>Enter password: 
</span><span class='line'>Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span><span class='line'>Your MariaDB connection id is 1481
</span><span class='line'>Server version: 5.5.40-MariaDB-wsrep MariaDB Server, wsrep_25.11.r4026
</span><span class='line'>
</span><span class='line'>Copyright (c) 2000, 2014, Oracle, MariaDB Corporation Ab and others.
</span><span class='line'>
</span><span class='line'>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
</span><span class='line'>
</span><span class='line'>MariaDB [saharaDB]&gt; 
</span></code></pre></td></tr></table></div></figure>


<p>So the syntax for sahara to use is like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/sahara/sahara.conf
</span><span class='line'>connection = mysql://sahara:saharapass@127.0.0.1/saharaDB
</span><span class='line'>use_neutron=true
</span><span class='line'>
</span><span class='line'># sahara-db-manage --config-file /etc/sahara/sahara.conf upgrade head
</span><span class='line'>INFO  [alembic.migration] Context impl MySQLImpl.
</span><span class='line'>INFO  [alembic.migration] Will assume non-transactional DDL.
</span><span class='line'>INFO  [alembic.migration] Running upgrade None -&gt; 001, Icehouse release
</span><span class='line'>INFO  [alembic.migration] Running upgrade 001 -&gt; 002, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 002 -&gt; 003, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 003 -&gt; 004, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 004 -&gt; 005, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 005 -&gt; 006, placeholder
</span><span class='line'>INFO  [alembic.migration] Running upgrade 006 -&gt; 007, convert clusters.status_description to LongText
</span><span class='line'>INFO  [alembic.migration] Running upgrade 007 -&gt; 008, add security_groups field to node groups
</span><span class='line'>INFO  [alembic.migration] Running upgrade 008 -&gt; 009, add rollback info to cluster
</span><span class='line'>INFO  [alembic.migration] Running upgrade 009 -&gt; 010, add auto_security_groups flag to node group
</span><span class='line'>INFO  [alembic.migration] Running upgrade 010 -&gt; 011, add Sahara settings info to cluster
</span></code></pre></td></tr></table></div></figure>


<p>REgister the service and specify the endpoint:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@10-17-17-183 etc]# cat ./nagios/keystonerc_admin                                                                                         
</span><span class='line'>export OS_USERNAME=admin                                                                                                                       
</span><span class='line'>export OS_TENANT_NAME=admin                                                                                                                    
</span><span class='line'>export OS_PASSWORD=5d4e62e79d314477                                                                                                            
</span><span class='line'>export OS_AUTH_URL=http://10.17.17.183:35357/v2.0/ 
</span><span class='line'>[root@10-17-17-183 etc]# pwd                                                                
</span><span class='line'>/etc  
</span><span class='line'># keystone service-create --name sahara --type data_processing --description "Data processing service"
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>|   Property  |              Value               |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>| description |     Data processing service      |
</span><span class='line'>|   enabled   |               True               |
</span><span class='line'>|      id     | 5f711f0d42754b349931349bd0c325d1 |
</span><span class='line'>|     name    |              sahara              |
</span><span class='line'>|     type    |         data_processing          |
</span><span class='line'>+-------------+----------------------------------+
</span><span class='line'>[root@10-17-17-183 ~]# keystone endpoint-create --service-id $(keystone service-list | awk '/ sahara / {print $2}') --publicurl http://127.0.0.1:8386/v1.1/%\(tenant_id\)s --internalurl http://127.0.0.1:8386/v1.1/%\(tenant_id\)s --adminurl http://127.0.0.1:8386/v1.1/%\(tenant_id\)s --region regionOne
</span><span class='line'>+-------------+------------------------------------------+
</span><span class='line'>|   Property  |                  Value                   |
</span><span class='line'>+-------------+------------------------------------------+
</span><span class='line'>|   adminurl  | http://127.0.0.1:8386/v1.1/%(tenant_id)s |
</span><span class='line'>|      id     |     b2115bab8bd743f589b1ed68eef69b4c     |
</span><span class='line'>| internalurl | http://127.0.0.1:8386/v1.1/%(tenant_id)s |
</span><span class='line'>|  publicurl  | http://127.0.0.1:8386/v1.1/%(tenant_id)s |
</span><span class='line'>|    region   |                regionOne                 |
</span><span class='line'>|  service_id |     5f711f0d42754b349931349bd0c325d1     |
</span><span class='line'>+-------------+------------------------------------------+
</span><span class='line'>[root@10-17-17-183 ~]# systemctl start openstack-sahara-all
</span><span class='line'>[root@10-17-17-183 ~]# systemctl enable openstack-sahara-all
</span><span class='line'>ln -s '/usr/lib/systemd/system/openstack-sahara-all.service' '/etc/systemd/system/multi-user.target.wants/openstack-sahara-all.service'
</span><span class='line'>[root@10-17-17-183 ~]# systemctl status openstack-sahara-all.service
</span></code></pre></td></tr></table></div></figure>


<p>More detailed info could be fetched from:   <br/>
<a href="http://docs.openstack.org/juno/install-guide/install/apt/content/sahara-install.html">http://docs.openstack.org/juno/install-guide/install/apt/content/sahara-install.html</a>  <br/>
Now login to the <a href="http://10.17.17.183">http://10.17.17.183</a> then you could visit the Trustyboard. The password is the one we used in the <code>OS_PASSWORD</code>.  <br/>
Install docker:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$  yum install docker
</span><span class='line'>Or
</span><span class='line'>$  wget https://get.docker.com/builds/Linux/x86_64/docker-latest -O docker
</span><span class='line'>$  docker --version
</span><span class='line'>[root@10-17-17-183 ~]#  usermod -G dockerroot nova
</span><span class='line'>[root@10-17-17-183 ~]# service openstack-nova-compute restart
</span><span class='line'>Redirecting to /bin/systemctl restart  openstack-nova-compute.service
</span><span class='line'># systemctl restart docker
</span><span class='line'># systemctl enable docker
</span></code></pre></td></tr></table></div></figure>


<p>Install nova-docker support:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$  yum install python-pip
</span><span class='line'>$  pip install -e git+https://github.com/stackforge/nova-docker#egg=novadocker
</span><span class='line'>$  cd src/novadocker/
</span><span class='line'>$  python setup.py install
</span><span class='line'>$ vim /etc/nova/nova.conf
</span><span class='line'>[DEFAULT]
</span><span class='line'>compute_driver = novadocker.virt.docker.DockerDriver
</span></code></pre></td></tr></table></div></figure>


<p>Edit the nova&rsquo;s rootwrap like following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@10-17-17-183 nova]# mkdir rootwrap.d
</span><span class='line'>[root@10-17-17-183 nova]# cd rootwrap.d/
</span><span class='line'>[root@10-17-17-183 rootwrap.d]# touch docker.filters
</span><span class='line'>[root@10-17-17-183 rootwrap.d]# vim docker.filters 
</span><span class='line'>[Filters]
</span><span class='line'># nova/virt/docker/driver.py:'ln', '-sf', '/var/run/netns/.*'
</span><span class='line'>ln: CommandFilter, /bin/ln, root
</span><span class='line'>[root@10-17-17-183 rootwrap.d]# vim /etc/nova/rootwrap.conf 
</span><span class='line'>[root@10-17-17-183 rootwrap.d]# pwd
</span><span class='line'>/etc/nova/rootwrap.d
</span></code></pre></td></tr></table></div></figure>


<p>Edit the glance-api.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@10-17-17-183 glance]# vim ./glance-api.conf 
</span><span class='line'>[DEFAULT]
</span><span class='line'>container_formats = ami,ari,aki,bare,ovf,docker
</span><span class='line'>[root@10-17-17-183 glance]# pwd
</span><span class='line'>/etc/glance
</span></code></pre></td></tr></table></div></figure>


<p>Create the ubuntu Container images via following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker pull ubuntu
</span><span class='line'>$ docker save ubuntu | glance image-create --is-public=True --container-format=docker --disk-format=raw --name ubuntu_container
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/01/build-qemu-for-supporting-glustfs/">Build Qemu for Supporting Glustfs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-01T16:56:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>4:56 pm</span></time>
        
         | <a href="/blog/2015/04/01/build-qemu-for-supporting-glustfs/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Following is the build procedure.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get build-dep qemu
</span><span class='line'>$ sudo apt-get install libvde-dev libvdeplug2-dev libcap-ng-dev libattr1-dev
</span><span class='line'>$ wget http://wiki.qemu-project.org/download/qemu-2.0.2.tar.bz2
</span><span class='line'>$ tar xjvf qemu-2.0.2.tar.bz2
</span><span class='line'>$ cd qemu-2.0.2/
</span><span class='line'>$ mkdir -p bin/debug/native
</span><span class='line'>$ cd bin/debug/native
</span><span class='line'>$ sudo apt-get install libjpeg-turbo8-dev
</span><span class='line'>$ sudo apt-get install glusterfs-common
</span><span class='line'> ../../../configure --enable-sdl --audio-drv-list=alsa,oss --enable-curses --enable-vnc-jpeg --enable-curl --enable-fdt --enable-kvm --enable-tcg-interpreter --enable-system --enable-user \\n --enable-linux-user --enable-guest-base --enable-pie --enable-uuid --enable-vde --enable-linux-aio --enable-cap-ng --enable-attr --enable-docs --enable-vhost-net --enable-rbd \\n --enable-guest-agent --enable-glusterfs --target-list=x86_64-softmmu,i386-softmmu
</span><span class='line'> ./qemu-img -h
</span><span class='line'> $ make -j2
</span></code></pre></td></tr></table></div></figure>


<p>Before, Found qemu-img:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ qemu-img -h
</span><span class='line'>Supported formats: vvfat vpc vmdk vhdx vdi sheepdog sheepdog sheepdog rbd raw host_cdrom host_floppy host_device file qed qcow2 qcow parallels nbd nbd nbd dmg tftp ftps ftp https http cow cloop bochs blkverify blkdebug
</span></code></pre></td></tr></table></div></figure>


<p>After, qemu-img:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Supported formats: vvfat vpc vmdk vhdx vdi sheepdog sheepdog sheepdog rbd raw host_cdrom host_floppy host_device file qed qcow2 qcow parallels nbd nbd nbd gluster gluster gluster gluster dmg tftp ftps ftp https http cow cloop bochs blkverify blkdebug
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/30/whole-process-for-deploying-contrail/">Whole Process for Deploying Contrail</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-30T18:20:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>6:20 pm</span></time>
        
         | <a href="/blog/2015/03/30/whole-process-for-deploying-contrail/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Following are the steps, enjoy them:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># First bootstrap the environment.   
</span><span class='line'>juju bootstrap --metadata-source ~/.juju/metadata --upload-tools -v --show-log --constraints="mem=3G"
</span><span class='line'>
</span><span class='line'>#####################################################
</span><span class='line'># Machine 0, hold 9 services. 3G mem. trusty
</span><span class='line'># Memory: 3G
</span><span class='line'># Service: 10
</span><span class='line'>#####################################################
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># Since machine 0 is ready for using, deploy services to this node via following commands:     
</span><span class='line'># Juju-gui is for monitoring the status and the components
</span><span class='line'># 1. juju-gui
</span><span class='line'>juju deploy --to 0 --repository=/home/Trusty/charms/ local:trusty/juju-gui
</span><span class='line'># 2. rabbitmq-server
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/charms/ local:trusty/rabbitmq-server
</span><span class='line'># 3. mysql
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/charms/ local:trusty/mysql
</span><span class='line'># 4. keystone
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/keystone
</span><span class='line'># 5. openstack-Trustyboard
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/openstack-Trustyboard
</span><span class='line'>
</span><span class='line'># 6. nova-cloud-controller
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/nova-cloud-controller --config=/home/Trusty/Code/deploy/nova-cloud-controller-config.yaml 
</span><span class='line'># 7. glance to lxc:0
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/glance
</span><span class='line'># 8. contrail-configuration to lxc:0
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/contrail-configuration
</span><span class='line'># 9. control-control to lxc:0
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/contrail-control
</span><span class='line'># 10. neutron-api to lxc:0
</span><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/neutron-api --config=/home/Trusty/Code/deploy/neutron-api.yaml
</span><span class='line'>
</span><span class='line'># Now add the first node for nova-compute.   
</span><span class='line'>juju set-constraints "mem=900M"
</span><span class='line'>#####################################################
</span><span class='line'># Machine 1, hold nova-compute service, 2G with nested CPU, trusty
</span><span class='line'># Memory: 2G
</span><span class='line'># Service: 1
</span><span class='line'>#####################################################
</span><span class='line'>
</span><span class='line'># Add name specified machine, which memory is 2048M, with cpu nested for kvm
</span><span class='line'>juju add-machine MaasOpenContrail4
</span><span class='line'># Machine 1 will be added into the Juju environment, deploy nova-compute into this node
</span><span class='line'>juju deploy --to 1 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/nova-compute
</span><span class='line'>
</span><span class='line'>#####################################################
</span><span class='line'># Machine 2, hold neutron-gateway service, 1G , trusty
</span><span class='line'># Memory: 1G
</span><span class='line'># Service: 1
</span><span class='line'>#####################################################
</span><span class='line'># Add neutron-gateway to 1G based machine , it may fail, so you could remove-machine, and re-add again. via `juju destroy-machine 2 --force`  
</span><span class='line'>juju add-machine MaasOpenContrail7
</span><span class='line'>juju deploy --to 4 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/quantum-gateway neutron-gateway
</span><span class='line'>
</span><span class='line'>#####################################################
</span><span class='line'># Machine 3, hold cassandra and zookeeper serivce, 4G, precise.
</span><span class='line'># Memory: 4G
</span><span class='line'># Service: 2
</span><span class='line'>#####################################################
</span><span class='line'># First we should change the default deployed system version to precise. 
</span><span class='line'>juju set-environment default-series=precise
</span><span class='line'># Add new machine, whose memory is 4G.
</span><span class='line'>juju add-machine MaasOpenContrail5
</span><span class='line'># Deploy cassandra to 4G Node
</span><span class='line'>juju deploy --to 5 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:precise/cassandra --config=/home/Trusty/Code/deploy/cassandra.yaml
</span><span class='line'># Also use this machine for deploy a lxc based service, zookeeper, which is also based on precise.
</span><span class='line'>juju deploy --to lxc:5 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:precise/zookeeper
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># Well, set the default environment from precise to trusty
</span><span class='line'>juju set-environment default-series=trusty
</span><span class='line'>
</span><span class='line'># Finally deploy  neutron-contrail
</span><span class='line'>juju deploy --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms/ local:trusty/neutron-contrail
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#####################################################
</span><span class='line'>#####################################################
</span><span class='line'># Well the deploy is finished, then add relationship
</span><span class='line'>#####################################################
</span><span class='line'>#####################################################
</span><span class='line'>juju add-relation keystone mysql
</span><span class='line'>juju add-relation nova-cloud-controller mysql
</span><span class='line'>juju add-relation nova-cloud-controller rabbitmq-server
</span><span class='line'>juju add-relation nova-cloud-controller glance
</span><span class='line'>juju add-relation nova-cloud-controller keystone
</span><span class='line'>juju add-relation neutron-gateway mysql
</span><span class='line'>juju add-relation neutron-gateway:amqp rabbitmq-server:amqp
</span><span class='line'>juju add-relation neutron-gateway nova-cloud-controller
</span><span class='line'>juju add-relation nova-compute:shared-db mysql:shared-db
</span><span class='line'>juju add-relation nova-compute:amqp rabbitmq-server:amqp
</span><span class='line'>juju add-relation nova-compute glance
</span><span class='line'>juju add-relation nova-compute nova-cloud-controller
</span><span class='line'>juju add-relation glance mysql
</span><span class='line'>juju add-relation glance keystone
</span><span class='line'>juju add-relation openstack-Trustyboard keystone
</span><span class='line'>juju add-relation neutron-api mysql
</span><span class='line'>juju add-relation neutron-api rabbitmq-server
</span><span class='line'>juju add-relation neutron-api nova-cloud-controller
</span><span class='line'>juju add-relation neutron-api:identity-service keystone:identity-service
</span><span class='line'>juju add-relation neutron-api:identity-admin keystone:identity-admin
</span><span class='line'>juju add-relation contrail-configuration:cassandra cassandra:database
</span><span class='line'>juju add-relation contrail-configuration zookeeper
</span><span class='line'>juju add-relation contrail-configuration rabbitmq-server
</span><span class='line'>juju add-relation contrail-configuration keystone
</span><span class='line'>juju add-relation contrail-configuration neutron-gateway
</span><span class='line'>juju add-relation neutron-api contrail-configuration
</span><span class='line'>juju add-relation contrail-control contrail-configuration
</span><span class='line'>juju add-relation nova-compute neutron-contrail
</span><span class='line'>juju add-relation neutron-contrail contrail-control
</span><span class='line'>juju add-relation neutron-contrail neutron-gateway
</span><span class='line'>juju add-relation neutron-contrail contrail-configuration
</span><span class='line'>juju add-relation neutron-contrail keystone
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># change the passwd of OpenStack:    
</span><span class='line'>juju set keystone admin-password="helloworld"
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/27/add-sbh-bluetooth-to-linux/">Add SBH BlueTooth to Linux</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-27T10:05:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:05 am</span></time>
        
         | <a href="/blog/2015/03/27/add-sbh-bluetooth-to-linux/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I bought a SBH Sony Bluetooth headset, following is the steps for adding it to system.</p>

<h3>Add Device</h3>

<p>Use Blueman for adding the equiment, first click the SBH headset to let it enter discover mode, also in blueman we enable the discover mode too, when setup the equipment, the code you have to enter is 0000.  <br/>
The device kindle is not headset, but the a2dp?</p>

<h3>Add Configuration for ALSA</h3>

<p>Edit the /etc/asound.conf, my configuration file is listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pcm.btheadset {
</span><span class='line'>   type plug
</span><span class='line'>   slave {
</span><span class='line'>       pcm {
</span><span class='line'>           type bluetooth
</span><span class='line'>           device xxx.xxx.xxx.xxx
</span><span class='line'>           profile "auto"
</span><span class='line'>       }   
</span><span class='line'>   }   
</span><span class='line'>   hint {
</span><span class='line'>       show on
</span><span class='line'>       description "BT Headset"
</span><span class='line'>   }   
</span><span class='line'>}
</span><span class='line'>ctl.btheadset {
</span><span class='line'>  type bluetooth
</span><span class='line'>}  
</span><span class='line'>pcm.sbhbtheadset {
</span><span class='line'>   type plug
</span><span class='line'>   slave {
</span><span class='line'>       pcm {
</span><span class='line'>           type bluetooth
</span><span class='line'>           device xxx.xxx.xxx.xxx
</span><span class='line'>           profile "auto"
</span><span class='line'>       }   
</span><span class='line'>   }   
</span><span class='line'>   hint {
</span><span class='line'>       show on
</span><span class='line'>       description "SBH BT Headset"
</span><span class='line'>   }   
</span><span class='line'>}
</span><span class='line'>ctl.sbhbtheadset {
</span><span class='line'>  type bluetooth
</span><span class='line'>}  
</span></code></pre></td></tr></table></div></figure>


<p>The first equipment is another bluetooth headset. We define our SDH to sdhbtheadset.  <br/>
Examine our added equipment via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aplay -L
</span><span class='line'>default
</span><span class='line'>    Playback/recording through the PulseAudio sound server
</span><span class='line'>null
</span><span class='line'>    Discard all samples (playback) or generate zero samples (capture)
</span><span class='line'>pulse
</span><span class='line'>    PulseAudio Sound Server
</span><span class='line'>btheadset
</span><span class='line'>    BT Headset
</span><span class='line'>sbhbtheadset
</span><span class='line'>    SBH BT Headset
</span></code></pre></td></tr></table></div></figure>


<h3>Send Sound</h3>

<p>The commands are listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pactl load-module module-alsa-sink device=sbhbtheadset
</span><span class='line'>17
</span><span class='line'>[Trusty@~]$ pacmd load_module module-bluetooth-discover
</span><span class='line'>Welcome to PulseAudio! Use "help" for usage information.
</span><span class='line'>&gt;&gt;&gt; Unknown command: load_module module-bluetooth-discover
</span><span class='line'>&gt;&gt;&gt; %                                                             
</span><span class='line'>[Trusty@~]$ pactl list sinks short
</span><span class='line'>1       alsa_output.sbhbtheadset        module-alsa-sink.c      s16le 2ch 44100Hz      SUSPENDED
</span><span class='line'>[Trusty@~]$ pacmd set-default-sink 1
</span><span class='line'>Welcome to PulseAudio! Use "help" for usage information.
</span><span class='line'>&gt;&gt;&gt; &gt;&gt;&gt; %                  
</span></code></pre></td></tr></table></div></figure>


<p>Now you are ready for listening Music via bluetooth headset, enjoy it.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/26/juju-tips/">Juju Tips</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-26T11:43:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:43 am</span></time>
        
         | <a href="/blog/2015/03/26/juju-tips/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Add Specified Machine</h3>

<p>We could add the specified name of the machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju add-machine MaasOpenContrail6.maas
</span></code></pre></td></tr></table></div></figure>


<p>While the name of <code>MaasOpenContrail6.maas</code> is the  name which we could get from the MAAS webUI.</p>

<h3>Get/Set Constraints</h3>

<p>We could dynamically set constraints for adding/removing new machines or unit, get/set it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju get-constraints
</span><span class='line'>mem=3072M
</span><span class='line'>$ juju set-constraints "mem=1024M"
</span><span class='line'>$ juju get-constraints
</span><span class='line'>mem=1024M
</span></code></pre></td></tr></table></div></figure>


<h3>Tags</h3>

<p>Sometimes we need to add tags to specified maas units, the following webpage is for reference:   <br/>
<a href="http://en.community.dell.com/techcenter/os-applications/w/wiki/7432.using-tags-with-maas-and-juju-in-ubuntu-server-14-04-lts">http://en.community.dell.com/techcenter/os-applications/w/wiki/7432.using-tags-with-maas-and-juju-in-ubuntu-server-14-04-lts</a>  <br/>
<a href="https://maas.ubuntu.com/docs/tags.html">https://maas.ubuntu.com/docs/tags.html</a></p>

<h3>Remove specified service</h3>

<p>Get the status of the specified service via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju status neutron-api
</span><span class='line'>services:
</span><span class='line'>  neutron-api:
</span><span class='line'>    charm: cs:trusty/neutron-api-9
</span><span class='line'>    exposed: false
</span><span class='line'>    life: dying
</span><span class='line'>    units:
</span><span class='line'>      neutron-api/0:
</span><span class='line'>        agent-state: error
</span><span class='line'>        agent-state-info: 'hook failed: "install"'
</span><span class='line'>        agent-version: 1.21.3.1
</span><span class='line'>        life: dying
</span><span class='line'>        machine: "6"
</span><span class='line'>        public-address: MaasOpenContrail7.maas
</span><span class='line'>networks:
</span><span class='line'>  maas-eth0:
</span><span class='line'>    provider-id: maas-eth0
</span><span class='line'>    cidr: 10.17.17.0/24
</span></code></pre></td></tr></table></div></figure>


<p>Resolved this service&rsquo;s located units first:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Trusty@MassController:~/Code/deploy$ juju resolved neutron-api/0
</span></code></pre></td></tr></table></div></figure>


<p>Now remove the service via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Trusty@MassController:~/Code/deploy$ juju remove-service neutron-api
</span></code></pre></td></tr></table></div></figure>


<p>Sometimes you need to type in resolved the unit for several times.  <br/>
Finally, if your machine runs into error state, you could destroy it forcely via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju destroy-machine x --force
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/24/deploy-maas-11/">Deploy MAAS(11)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-24T09:14:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:14 am</span></time>
        
         | <a href="/blog/2015/03/24/deploy-maas-11/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since the deployment meets some problem, I have to consider doing some tricks in the MAAS controller, to let the deployment much more easier and time-saving, following is the steps for setting up such environment.</p>

<h3>Resize Maas Controller Disk</h3>

<p>Since the Mass Controller machine only have 40G size harddisk, it will be not enough if we enable the repository cache for guest machines, thus we have to resize the disk.  <br/>
First shutdown the virtual machine.   <br/>
Resize the qcow2 file via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># virsh dumpxml MassController | grep qcow2
</span><span class='line'>      &lt;driver name='qemu' type='qcow2' cache='none'/&gt;
</span><span class='line'>      &lt;source file='/home/juju/img/MassController.qcow2'/&gt;
</span><span class='line'># qemu-img resize /home/juju/img/MassController.qcow2 +40GB
</span><span class='line'>Image resized.
</span><span class='line'># qemu-img info /home/juju/img/MassController.qcow2
</span><span class='line'>image: /home/juju/img/MassController.qcow2
</span><span class='line'>file format: qcow2
</span><span class='line'>virtual size: 80G (85899345920 bytes)
</span><span class='line'>disk size: 9.4G
</span><span class='line'>cluster_size: 65536
</span><span class='line'># virsh start MassController
</span></code></pre></td></tr></table></div></figure>


<p>Now use a liveCD for startup the machine, this will bootup the machine into a iso booted environment.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget http://downloads.sourceforge.net/gparted/gparted-live-0.21.0-1-i586.iso
</span></code></pre></td></tr></table></div></figure>


<p>Bootup the machine and resize like following:  <br/>
<img src="/images/2015_03_24_10_28_21_791x423.jpg" alt="/images/2015_03_24_10_28_21_791x423.jpg" /></p>

<h3>squid-deb-proxy</h3>

<p>In Mass Controller machine, install following packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install squid-deb-proxy avahi-utils
</span><span class='line'>$ sudo start squid-deb-proxy
</span></code></pre></td></tr></table></div></figure>


<p>Every client should install following package:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install squid-deb-proxy-client
</span></code></pre></td></tr></table></div></figure>


<p>Don&rsquo;t install squid-deb-proxy, because it will cause maas to be removed.</p>

<p>In fact MAAS manages its own squid, named maas-proxy, which could be examined via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ps -ef | grep squid
</span><span class='line'>proxy      763     1  0 Mar23 ?        00:00:07 /usr/sbin/squid3 -N -f /etc/maas/maas-proxy.conf
</span><span class='line'>Trusty      3892  3861  0 00:13 pts/5    00:00:00 grep --color=auto squid
</span></code></pre></td></tr></table></div></figure>


<p>This may cause all of the packages, or images be cached in squid, but it will be very helpful if we want to speedup the installation speed. <br/>
configure the squide&rsquo;s cache directory size via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/maas/maas-proxy.conf
</span><span class='line'>
</span><span class='line'>cache_dir ufs /var/spool/squid 100 16 256
</span><span class='line'>By default, the cache_dir directory may be commented.
</span><span class='line'>
</span><span class='line'>/var/spool/squid â€“ This is the directory folder where squid will use to swap cache your server web files
</span><span class='line'>100 â€“ The amount of disk space to use in MB for your caching directory
</span><span class='line'>16 â€“ the first-level subdirectories which will be created in your cache directory
</span><span class='line'>256 â€“ The number of second-level subdirectories which will be created under each first level directory
</span></code></pre></td></tr></table></div></figure>


<p>
We should add following configuration under the configure.yaml of the .juju/:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>maas-server: http://10.17.17.200/MAAS
</span><span class='line'>http-proxy: http://10.17.17.200:8000
</span><span class='line'>#https-proxy: http://10.17.17.200:3128
</span><span class='line'>no-proxy: localhost,10.17.17.0/24
</span><span class='line'>apt-http-proxy: http://10.17.17.200:8000
</span><span class='line'>#apt-https-proxy: http://10.17.17.200:3128
</span><span class='line'>apt-ftp-proxy: http://10.17.17.200:8000
</span><span class='line'>type: maas
</span></code></pre></td></tr></table></div></figure>


<p>After configuration, the bootstrap and add-machine will succesfully deployed.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/23/using-juju-for-deploying-opencontrail/">Using Juju for Deploying OpenContrail</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-23T11:37:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>11:37 am</span></time>
        
         | <a href="/blog/2015/03/23/using-juju-for-deploying-opencontrail/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Preparation</h3>

<p>First we have to create 4 images which will hold our own opearating system.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> 1016  qemu-img create -f qcow2 OpenContrail0.qcow2 40G
</span><span class='line'> 1017  qemu-img create -f qcow2 OpenContrail1.qcow2 40G
</span><span class='line'> 1018  qemu-img create -f qcow2 OpenContrail3.qcow2 40G
</span><span class='line'> 1019  qemu-img create -f qcow2 OpenContrail2.qcow2 40G
</span><span class='line'> 1020  ls
</span><span class='line'> 1021  history
</span><span class='line'># pwd
</span><span class='line'>/home/juju/img/OpenContrail
</span><span class='line'># qemu-img create -f qcow2 OpenContrail0.qcow2 40G
</span><span class='line'># qemu-img create -f qcow2 OpenContrail1.qcow2 40G
</span><span class='line'># qemu-img create -f qcow2 OpenContrail3.qcow2 40G
</span><span class='line'># qemu-img create -f qcow2 OpenContrail2.qcow2 40G
</span><span class='line'># ls
</span><span class='line'>OpenContrail0.qcow2  OpenContrail1.qcow2  OpenContrail2.qcow2  OpenContrail3.qcow2
</span></code></pre></td></tr></table></div></figure>


<p>Second, we create the four nodes in the virt-manager, each of them have 3G Memory, and have the cpu copied. Their network deployed to the newly added isolated network. <br/>
<img src="/images/2015_03_23_11_55_12_711x170.jpg" alt="/images/2015_03_23_11_55_12_711x170.jpg" />  <br/>
After commission, the status should be &ldquo;ready&rdquo;.</p>

<h3>Juju</h3>

<p>Copy the new environment named OpenContrail:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.juju/environments.yaml 
</span><span class='line'># This file has been generated by juju quickstart v2.0.1
</span><span class='line'># at 2015-03-19 06:36:40 UTC.
</span><span class='line'>
</span><span class='line'>default: maas
</span><span class='line'>environments:
</span><span class='line'>  maas:
</span><span class='line'>    admin-secret: xxxx
</span><span class='line'>    default-series: trusty
</span><span class='line'>    maas-oauth: u8HmYg24sUxerux4N8:kcYJ8mJdePBSe4DfxD:H4qFjEpLP86Lw6xnxjHG5qrHY3abPYzZ
</span><span class='line'>    maas-server: http://10.17.17.200/MAAS
</span><span class='line'>    type: maas
</span><span class='line'>  OpenContrail:
</span><span class='line'>    admin-secret: xxxx
</span><span class='line'>    default-series: trusty
</span><span class='line'>    maas-oauth: u8HmYg24sUxerux4N8:kcYJ8mJdePBSe4DfxD:H4qFjEpLP86Lw6xnxjHG5qrHY3abPYzZ
</span><span class='line'>    maas-server: http://10.17.17.200/MAAS
</span><span class='line'>    type: maas
</span></code></pre></td></tr></table></div></figure>


<p>
Then <code>juju switch</code> and examine you are currently operate at OpenContrail via <code>juju switch -l</code>, the result should be OpenContrail. <br/>
Bootstrap the environment via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju bootstrap --metadata-source ~/.juju/metadata --upload-tools -v --show-log --constraints="mem=3G"
</span></code></pre></td></tr></table></div></figure>


<p>
Use <code>juju show-log</code> will display the logs for juju.</p>

<p>Deploy from local repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export JUJU_REPOSITORY=/home/Trusty/Code/deployOpenContrail/contrail-deployer/charms
</span><span class='line'>$ juju deploy --to 0 juju-gui
</span><span class='line'>$ juju deploy --to lxc:0 mysql
</span><span class='line'>$ juju deploy --to lxc:0 keystone
</span><span class='line'>$ juju deploy --to lxc:0 nova-cloud-controller
</span><span class='line'>$ juju deploy --to lxc:0 glance
</span><span class='line'>$ juju deploy --to lxc:0 rabbitmq-server
</span><span class='line'>$ juju deploy --to lxc:0 openstack-Trustyboard
</span><span class='line'>$ juju deploy --to lxc:0 cinder 
</span><span class='line'>$ juju deploy --to lxc:0 neutron-api
</span><span class='line'>$ juju deploy --to lxc:0 quantum-gateway
</span></code></pre></td></tr></table></div></figure>


<h3>HomeWorking</h3>

<p>First I created the local charm repository, and then start deploying.   <br/>
Problem is lxc template download is too time-wasting, thus I have to manually download the images and let it run as if the cache image is available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@MassOpenContrail2:/var/cache/lxc/cloud-trusty# du -hs *
</span><span class='line'>178M    ubuntu-14.04-server-cloudimg-amd64-root.tar.gz
</span><span class='line'>root@MassOpenContrail2:/var/cache/lxc/cloud-trusty# pwd
</span><span class='line'>/var/cache/lxc/cloud-trusty
</span></code></pre></td></tr></table></div></figure>


<p>Use local repository for deploying other version&rsquo;s container, then run a cassandra:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms local:precise/cassandra
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/23/deploy-local-service-using-juju/">Deploy Local Service Using Juju</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-23T09:11:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>9:11 am</span></time>
        
         | <a href="/blog/2015/03/23/deploy-local-service-using-juju/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since the OpenContrail deploy is using local deployment, that means, directly deploy to local machine. But the lab lack of the environment of the local ubuntu based machine, so I want to deploy a service to local first, then transform the whole project from local deployment to MAAS deployment. <br/>
In a Ubuntu14.04 machine, do following steps.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo add-apt-repository ppa:juju/stable 
</span><span class='line'>$ sudo vim /etc/apt/source.list
</span><span class='line'># This is for juju
</span><span class='line'>deb http://ppa.launchpad.net/juju/stable/ubuntu trusty main 
</span><span class='line'>deb-src http://ppa.launchpad.net/juju/stable/ubuntu trusty main 
</span><span class='line'>$ sudo apt-get install juju juju-core juju-local juju-quickstart
</span><span class='line'>$ sudo apt-get install charm-tools
</span><span class='line'>$ sudo apt-get install uvtool-libvirt uvtool
</span></code></pre></td></tr></table></div></figure>


<p>Configure the juju for using local:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/juju/plugins.git ~/.juju-plugins
</span><span class='line'>$ vim ~/.zshrc
</span><span class='line'># Add juju_plugins to global path
</span><span class='line'>PATH=$PATH:$HOME/.juju-plugin
</span><span class='line'>$ source ~/.zshrc
</span><span class='line'>$ juju init
</span><span class='line'>$ vim ~/.juju/environments.yaml
</span><span class='line'>local:
</span><span class='line'> type: local
</span><span class='line'>
</span><span class='line'> # &lt;Commented Section&gt;
</span><span class='line'>
</span><span class='line'> # The default series to deploy the state-server and charms on.
</span><span class='line'> #
</span><span class='line'> default-series: precise
</span><span class='line'> #
</span><span class='line'> ## ** add these lines to support KVM and LXC deployment **
</span><span class='line'> lxc-use-clone: true
</span><span class='line'> container: kvm
</span></code></pre></td></tr></table></div></figure>


<p>Start the machine via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju bootstrap --debug
</span></code></pre></td></tr></table></div></figure>


<p>Add the machines via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Trusty@~]$  juju set-constraints mem=512M
</span><span class='line'>[Trusty@~]$  juju add-machine --constraints "root-disk=16G mem=1G"
</span><span class='line'>created machine 1
</span><span class='line'>[Trusty@~]$ juju status
</span><span class='line'>environment: local
</span><span class='line'>machines:
</span><span class='line'>  "0":
</span><span class='line'>    agent-state: started
</span><span class='line'>    agent-version: 1.21.3.1
</span><span class='line'>    dns-name: localhost
</span><span class='line'>    instance-id: localhost
</span><span class='line'>    series: trusty
</span><span class='line'>    state-server-member-status: has-vote
</span><span class='line'>  "1":
</span><span class='line'>    instance-id: pending
</span><span class='line'>    series: precise
</span><span class='line'>services: {}
</span></code></pre></td></tr></table></div></figure>


<p>After a long wait, it will boot a machine which have 1G and 1 Core, and let it running.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/19/deploy-maas-10/">Deploy MAAS(10)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-19T10:17:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:17 am</span></time>
        
         | <a href="/blog/2015/03/19/deploy-maas-10/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Continue to deploy OpenContrail based on OpenStack.    <br/>
First we install the bzr for fetching back the charms:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install bzr
</span></code></pre></td></tr></table></div></figure>


<p>Clone the repository to local Mass Controller Machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bzr branch lp:~robert-ayres/+junk/contrail-deployer
</span></code></pre></td></tr></table></div></figure>


<p>Install juju-deployer for deploying:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install juju-deployer
</span></code></pre></td></tr></table></div></figure>


<p>Change the memory size.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/18/migration-of-opencontril/">Migration of OpenContril</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-18T11:38:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:38 am</span></time>
        
         | <a href="/blog/2015/03/18/migration-of-opencontril/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This article is not for opencontril itself, but for migration of the existing environment to local machines.</p>

<h3>Environment</h3>

<p>Machine configuration is listed as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.10.233 u12-control
</span><span class='line'>192.168.10.234 u12-compute1
</span><span class='line'>192.168.10.235 u12-compute2
</span><span class='line'>
</span><span class='line'>192.168.1.79   s179
</span></code></pre></td></tr></table></div></figure>


<p>The control node and 2 compute nodes are running in machine s179, the tasks for me to do is for moving them from s179 to 2 physical machine.</p>

<h3>Use Remote KVM Server</h3>

<p>First we copy our ssh-key to the remote s179 machine, so next time we won&rsquo;t enter any passwd for accessing the remote libvirtd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh-copy-id root@192.168.1.79
</span></code></pre></td></tr></table></div></figure>


<p>In our own machine, we listed remote&rsquo;s machines via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virsh -c qemu+ssh://root@192.168.1.79/system list --all
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> 14    u14-ui                         running
</span><span class='line'> 16    u14-compute2                   running
</span><span class='line'> 22    u14-compute1                   running
</span><span class='line'> 39    de1-contro                     running
</span><span class='line'> -     centos6.4-management-01        shut off
</span><span class='line'> -     centos6.4-management-02        shut off
</span></code></pre></td></tr></table></div></figure>


<p>Add connection via: <code>File-&gt; Add New Connection</code>, then configure like following:   <br/>
<img src="/images/2015_03_18_11_53_11_380x432.jpg" alt="/images/2015_03_18_11_53_11_380x432.jpg" /></p>

<h3>Migration(Static)</h3>

<p>First scp the image file to to destination machine, this will take a while. <br/>
Dump the xml via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virsh dumpxml xxxxx&gt;xxxx.xml
</span></code></pre></td></tr></table></div></figure>


<p>Scp the xml file to destination machine and move to <code>/etc/libvirt/qemu/</code>, change the priviledge of the file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo chmod 777 /home/clouder/iso/Ubuntu1404-Newly-Installed-with-Update.img
</span></code></pre></td></tr></table></div></figure>


<p>   <br/>
Edit the corresponding configuration in the xml file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/libvirt/qemu/xxxx.xml
</span><span class='line'>.....
</span><span class='line'>&lt;source file='/home/clouder/iso/Ubuntu1404-Newly-Installed-with-Update.img'/&gt;
</span><span class='line'>.....
</span></code></pre></td></tr></table></div></figure>


<p>Define the xml under the <code>/etc/libvirt/qemu/</code> folder:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@pc121:/etc/libvirt/qemu# virsh define ./Ubuntu1404-Newly-Installed-with-Update.xml 
</span><span class='line'>Domain Ubuntu1404-Newly-Installed-with-Update defined from ./Ubuntu1404-Newly-Installed-with-Update.xml
</span></code></pre></td></tr></table></div></figure>


<p>Install the guest tool and use it for editing the virtual machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install libguestfs-tools
</span><span class='line'>$ sudo virt-edit -d Ubuntu1404-Newly-Installed-with-Update /etc/network/interfaces
</span></code></pre></td></tr></table></div></figure>


<p>After change the network configuration, we could start the machine via <code>virsh start Ubuntu1404-Newly-Installed-with-Update</code>, it will have the newly edited ip address.</p>

<p>If we use different host machine, then change the following definition in xml file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/libvirt/qemu/xxxx.xml
</span><span class='line'>&lt;devices&gt;
</span><span class='line'>    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
</span><span class='line'>.......
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/6">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/4">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/25/tips-on-deleteing-neutron-subnet-and-router/">Tips on Deleteing Neutron Subnet and Router</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/25/san-jie-dian-da-jian-openstack-juno-4/">ä¸‰èŠ‚ç‚¹æ­å»ºOpenStack Juno(4)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/25/san-jie-dian-da-jian-openstack-juno-3/">ä¸‰èŠ‚ç‚¹æ­å»ºOpenStack Juno(3)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/25/lxcize-the-kvm-machine/">LXCize the KVM Machine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/24/san-jie-dian-da-jian-openstack-juno-2/">ä¸‰èŠ‚ç‚¹æ­å»ºOpenStack Juno(2)</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
