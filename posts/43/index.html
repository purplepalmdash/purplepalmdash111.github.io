
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="We will continue to deploy our tasks on heroku. In this article we will finish the data retriving and database insertion. Honcho Install and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/posts/43">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//fonts.googleapis.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/11/write-python-weather-app-on-heroku-7/">Write Python Weather APP on Heroku(7)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-11T13:44:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>1:44 pm</span></time>
        
         | <a href="/blog/2014/05/11/write-python-weather-app-on-heroku-7/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We will continue to deploy our tasks on heroku. In this article we will finish the data retriving and database insertion.</p>

<h3>Honcho</h3>

<p>Install and Configuration of Honcho:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip install honcho
</span><span class='line'># Regenerate requirement.txt and upload it onto heroku
</span><span class='line'>$ mv Procfile ProcfileHoncho
</span><span class='line'># Edit the new Procfile: 
</span><span class='line'>$ vim Procfile
</span><span class='line'>web: honcho -f ProcfileHoncho start
</span></code></pre></td></tr></table></div></figure>


<p>In local, we can also use following command for swiftly verifying our code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Because our user belongs to root group, so set following variable firstly
</span><span class='line'>$ export C_FORCE_ROOT=1
</span><span class='line'>$ foreman start
</span></code></pre></td></tr></table></div></figure>


<p>Now you can visit <a href="http://localhost:5000">http://localhost:5000</a> for viewing the result.</p>

<h3>task.py</h3>

<p>Following is the script for tasks.py:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env python
</span><span class='line'># -*- coding: utf-8 -*-
</span><span class='line'># Set default encoding: utf-8
</span><span class='line'>import sys;
</span><span class='line'>reload(sys);
</span><span class='line'># Setting the utf-8 format
</span><span class='line'>sys.setdefaultencoding("utf8")
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>import logging
</span><span class='line'>import string
</span><span class='line'>from celery import Celery
</span><span class='line'>from celery.task import periodic_task
</span><span class='line'>from datetime import datetime,timedelta
</span><span class='line'>from os import environ
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># For retrieving temperature/humidity
</span><span class='line'>import pywapi
</span><span class='line'>import urllib2
</span><span class='line'>from urllib2 import ProxyHandler
</span><span class='line'>import re
</span><span class='line'>from BeautifulSoup import BeautifulSoup
</span><span class='line'>
</span><span class='line'># For using database(Postgresql)
</span><span class='line'># from flash.ext.sqlalchemy import SQLAlchemy
</span><span class='line'>from sqlalchemy import create_engine
</span><span class='line'>from sqlalchemy import MetaData, Column, Table, ForeignKey
</span><span class='line'>from sqlalchemy import Integer, String, DateTime
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># redis configuration for celery
</span><span class='line'>### Local, should be change to remote when deploying to heroku
</span><span class='line'>REDIS_URL = environ.get('REDISTOGO_URL', 'redis://localhost')
</span><span class='line'>
</span><span class='line'>celery = Celery('tasks', broker=REDIS_URL)
</span><span class='line'>
</span><span class='line'># Fetch 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># Define Periodic Tasks
</span><span class='line'># @periodic_task(run_every=timedelta(minutes=60))
</span><span class='line'># Funciton for fetching data and store it in Postgres
</span><span class='line'>def fetch_and_store_data():
</span><span class='line'>    # Fetching the weather information from Yahoo. 
</span><span class='line'>    Yahoo_Result = pywapi.get_weather_from_yahoo('CHXX0099')
</span><span class='line'>    Current_Temp = string.lower(Yahoo_Result['condition']['temp'])
</span><span class='line'>    Current_Humi = string.lower(Yahoo_Result['atmosphere']['humidity'])
</span><span class='line'>    Tomorrow_Forecast = Yahoo_Result['forecasts'][0]
</span><span class='line'>    Twenty_Four_Hours = Yahoo_Result['forecasts'][1]
</span><span class='line'>    Fourty_Eight_Hours = Yahoo_Result['forecasts'][2]
</span><span class='line'>    Seventy_Two_Hours = Yahoo_Result['forecasts'][3]
</span><span class='line'>    # !!! comment proxy related for deploying to heroku !!! #
</span><span class='line'>    proxy = urllib2.ProxyHandler({'http': '192.11.236.225:8000'})
</span><span class='line'>    opener = urllib2.build_opener(proxy)
</span><span class='line'>    urllib2.install_opener(opener)
</span><span class='line'>    page = urllib2.urlopen("http://www.pm25.in/nanjing")
</span><span class='line'>    soup = BeautifulSoup(page)                      #
</span><span class='line'>    # Find the detailed table from the soup.        #
</span><span class='line'>    table = soup.find('table', {'id':'detail-data'})#
</span><span class='line'>    # Fetch the XuanWuHu, if not, use MaiGaoQiao ins#tead. 
</span><span class='line'>    rows = table.findAll('tr')                      #
</span><span class='line'>    for subrows in rows:                            #
</span><span class='line'>        if "玄武湖" in subrows.text:                #
</span><span class='line'>            XuanwuLake = subrows                    #
</span><span class='line'>        else:                                       #
</span><span class='line'>            if "迈皋桥" in subrows.text:            #
</span><span class='line'>                XuanwuLake = subrows                #
</span><span class='line'>    XuanwuLake_subitem = XuanwuLake.findAll('td')   #
</span><span class='line'>    # Here we will get an array, fetch out the text #for the content from this array.
</span><span class='line'>    # Fetched origin data, different from cnpm25.cn #
</span><span class='line'>    pm_25_orig = XuanwuLake_subitem[4].text         #
</span><span class='line'>    pm_10_orig = XuanwuLake_subitem[5].text
</span><span class='line'>    # Open the Database
</span><span class='line'>    engine = create_engine('postgresql+psycopg2://Trusty:@localhost:5432/mylocaldb',echo=True)
</span><span class='line'>    metadata=MetaData(bind=engine)
</span><span class='line'>    
</span><span class='line'>    # Definition of the weather table
</span><span class='line'>    weather_table=Table('weather',metadata,
</span><span class='line'>      Column('Insert_Time', DateTime(timezone=True),primary_key=True),
</span><span class='line'>      Column('Temperature', Integer),
</span><span class='line'>      Column('Humidity', Integer),
</span><span class='line'>      Column('PmTen', Integer),
</span><span class='line'>      Column('PmTwoFive', Integer),
</span><span class='line'>    )
</span><span class='line'>
</span><span class='line'>    # Create the table in mylocaldb
</span><span class='line'>    metadata.create_all(checkfirst=True)
</span><span class='line'>
</span><span class='line'>    # Record Insertion
</span><span class='line'>    # First generate an insertion sentense:
</span><span class='line'>    ins = weather_table.insert()
</span><span class='line'>    # Really insert into the Database
</span><span class='line'>    # ins = weather_table.insert().values(Insert_Time=datetime.datetime.utcnow(), Temperature=25, Humidity=75, PmTen=100, PmTwoFive=55)   # Example
</span><span class='line'>    ins = weather_table.insert().values(Insert_Time=datetime.utcnow(), Temperature=Current_Temp, Humidity=Current_Humi, PmTen=int(pm_10_orig), PmTwoFive=int(pm_25_orig))
</span><span class='line'>    # Connect to engine and execute.
</span><span class='line'>    conn = engine.connect()
</span><span class='line'>    result = conn.execute(ins)
</span><span class='line'>
</span><span class='line'>    #return Current_Temp
</span><span class='line'>    return pm_25_orig
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>@periodic_task(run_every=timedelta(seconds=10))
</span><span class='line'>def print_fib():
</span><span class='line'>    #logging.info(fib(30))
</span><span class='line'>    logging.info("This could be viewed in logging!")
</span></code></pre></td></tr></table></div></figure>


<p>Notice, this version only works in local.<br/>
For updating the real database on heroku, we have to do some modification on redis server and remove the proxy server, these are the works we need to done in next chapter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/10/celery-and-rabbitmq-on-archlinux/">Celery and RabbitMQ on ArchLinux</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-10T22:19:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:19 pm</span></time>
        
         | <a href="/blog/2014/05/10/celery-and-rabbitmq-on-archlinux/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Installation</h3>

<p>Install and run rabbitmq server via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ yaourt rabbitmq
</span><span class='line'>$ rabbitmq-server
</span></code></pre></td></tr></table></div></figure>


<p>Install celery in python virtual enviroment:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ workon venv2
</span><span class='line'>(venv2) $ pip install celery
</span></code></pre></td></tr></table></div></figure>


<h3>Run Simple Tasks</h3>

<p>Following python file, named &ldquo;tasks.py&rdquo; defines two tasks:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from celery import Celery
</span><span class='line'>
</span><span class='line'>app = Celery('tasks', backend='amqp', broker='amqp://')
</span><span class='line'>
</span><span class='line'>@app.task(ignore_result=True)
</span><span class='line'>def print_hello():
</span><span class='line'>    print 'hello there'
</span><span class='line'>
</span><span class='line'>@app.task
</span><span class='line'>def gen_prime(x):
</span><span class='line'>    multiples = []
</span><span class='line'>    results = []
</span><span class='line'>    for i in xrange(2, x+1):
</span><span class='line'>        if i not in multiples:
</span><span class='line'>            results.append(i)
</span><span class='line'>            for j in xrange(i*i, x+1, i):
</span><span class='line'>                multiples.append(j)
</span><span class='line'>    return results
</span></code></pre></td></tr></table></div></figure>


<p>Run it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>celery worker -A tasks &
</span></code></pre></td></tr></table></div></figure>


<p>Now in another terminal you can use python interractive window for:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from tasks import print_hello
</span><span class='line'>from tasks import gen_prime
</span><span class='line'>print_hello()
</span><span class='line'>primes = gen_prime(1000)
</span><span class='line'>primes = gen_prime(50000)
</span><span class='line'># CTRL+C will stop it. 
</span><span class='line'># Access the background worker
</span><span class='line'>primes = gen_prime.delay(50000)
</span><span class='line'># by the worker executing now, because we configured the backend for application
</span><span class='line'>primes.ready()
</span><span class='line'>False
</span><span class='line'>...
</span><span class='line'>True
</span><span class='line'>print primes.get()
</span></code></pre></td></tr></table></div></figure>


<h3>Periodic Tasks</h3>

<p>Add following lines into the tasks.py:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from celery.task import periodic_task
</span><span class='line'>from datetime import timedelta
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>@periodic_task(run_every=timedelta(minutes=1))
</span><span class='line'>def print_minutes():
</span><span class='line'>    print 'Hello, 1 minute reached'
</span><span class='line'>
</span><span class='line'>@periodic_task(run_every=timedelta(seconds=3))
</span><span class='line'>def every_3_seconds():
</span><span class='line'>    print("Running periodic task!")
</span></code></pre></td></tr></table></div></figure>


<p>Now start the tasks.py via following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ celery -A tasks worker --loglevel=info --beat
</span></code></pre></td></tr></table></div></figure>


<p>You will see Celery output &ldquo;Running periodic tasks!&rdquo; every 3 seconds, while every 1 minutes the &ldquo;Hello, 1 minute reached&rdquo; will be printed out.</p>

<h3>To Be Thought</h3>

<p>How to mirgrate it with our heroku web app ?  <br/>
The periodic_task is good for fetching pages/datas and generate the result, then store the results into the database.</p>

<p>But the webapp should response to user&rsquo;s http request, this will be the main task.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/10/write-python-weather-app-on-heroku-6/">Write Python Weather APP on Heroku(6)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-10T16:46:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:46 pm</span></time>
        
         | <a href="/blog/2014/05/10/write-python-weather-app-on-heroku-6/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Risk</h3>

<p>On Google App Engine it&rsquo;s very convinient to setup a crontab task, while in heroku setting up a crontab task will occupy the material, thus will use another dyno, each dyno will cost $30/month. For avoiding this, we will re-design our Weather App.   <br/>
Following is the detailed explanation on heroku&rsquo;s dyno:  <br/>
Heroku allows you to run one free dyno (or actually they give you 720 free dyno hours per month, which corresponds to one dyno constantly running). This means that if you choose to run one web dyno and one worker dyno (celery in this case), you&rsquo;ll be charged for 720 dyno hours. However, if you have a very small project, or your&rsquo;re working on a project that hasn&rsquo;t been released yet, you can avoid this cost.  <br/>
A heroku dyno is like a process, and in this process you can actually spawn new processes, as long as you stay within the limit of 512 mb ram (the process also only has one CPU core). Heroku suggests that you use foreman when you run your application on your local machine, but you can actually use foreman on heroku, in order to run multiple processes in a single dyno.  <br/>
On Heroku, we don’t have physical machines; in fact there isn’t the concept of “machine” at all. Instead, Heroku has Dynos, which are described as “lightweight containers” for UNIX processes. From their documentation:</p>

<p>[A Dyno] can run any command available in its default environment combined with your app’s slug</p>

<h3>Solution</h3>

<p>Celery<a href="www.celeryproject.org">www.celeryproject.org</a>  <br/>
or  <br/>
Honcho<a href="https://github.com/nickstenning/honcho">https://github.com/nickstenning/honcho</a>  <br/>
We will try Honcho first, because it&rsquo;s based on python, so won&rsquo;t affect our code format.</p>

<h4>Celery Way</h4>

<p>Install redis and celery:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pip install redis celery
</span></code></pre></td></tr></table></div></figure>


<p>Remember to use <code>pip freeze</code> to update the requirement.txt file.   <br/>
We should also enable the RedisToGo plugin, install it via CLI:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku addons:add rediscloud
</span></code></pre></td></tr></table></div></figure>


<p>If you don&rsquo;t have a credit card, then your installation of plugin will be fail. We will register an account on <a href="www.redislabs.com/">www.redislabs.com</a>, then we will continue our setting.  ]</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>heroku config:set REDISCLOUD_URL="http://Resouce_Name:Redis_Passwod@pub-redis-xxxx.xxx.xxx..garantiadata.com:1xxx3"
</span></code></pre></td></tr></table></div></figure>


<p>Your heroku app will restart, then we can test this redis database via following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku run python
</span><span class='line'>Running `python` attached to terminal... up, run.8246
</span><span class='line'>Python 2.7.6 (default, Jan 16 2014, 02:39:37) 
</span><span class='line'>[GCC 4.4.3] on linux2
</span><span class='line'>Type "help", "copyright", "credits" or "license" for more information.
</span><span class='line'>&gt;&gt;&gt; import os
</span><span class='line'>&gt;&gt;&gt; import urlparse
</span><span class='line'>&gt;&gt;&gt; import redis
</span><span class='line'>&gt;&gt;&gt; url = urlparse.urlparse(os.environ.get('REDISCLOUD_URL'))
</span><span class='line'>&gt;&gt;&gt; r = redis.Redis(host=url.hostname, port=url.port, password=url.password)
</span><span class='line'>&gt;&gt;&gt; r.set('foo','bar')
</span><span class='line'>True
</span><span class='line'>&gt;&gt;&gt; r.get('foo')
</span><span class='line'>'bar'
</span></code></pre></td></tr></table></div></figure>


<p>An Article of using celery is right after this article, so we end this article and in next one we will re-design the web app to fit the celery way.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/10/write-python-weather-app-on-heroku-5/">Write Python Weather APP on Heroku(5)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-10T09:02:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:02 am</span></time>
        
         | <a href="/blog/2014/05/10/write-python-weather-app-on-heroku-5/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In fact this is a migration from sqlite3 to postgresql.</p>

<h3>View the historical sqlite3</h3>

<p>We will refer to our own design of database. First fetch the data file, this is a sqlite3 file, so we use sqlite3 to view its structure.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sqlite3  
</span><span class='line'>SQLite version 3.8.4.3 2014-04-03 16:53:12
</span><span class='line'>Enter ".help" for usage hints.
</span><span class='line'>Connected to a transient in-memory database.
</span><span class='line'>Use ".open FILENAME" to reopen on a persistent database.
</span><span class='line'>sqlite&gt; .open ./weather.db
</span><span class='line'>sqlite&gt; .tables
</span><span class='line'>foo
</span><span class='line'>sqlite&gt; .schema foo
</span><span class='line'>CREATE TABLE foo (d_temper integer, d_humi integer, d_pm10 integer, d_pm25 real, d_time timestamp);
</span></code></pre></td></tr></table></div></figure>


<p>Although sqlite3 is supported on heroku, we&rsquo;d better use heroku&rsquo;s suggestion, to use postgre for storing out database.</p>

<h3>Create Database In Postgres</h3>

<h4>Datatime selection:</h4>

<p>Postgres provides a very fantanstic way for handling the datatime, it supports the timezone, comparing to GAE&rsquo;s database, this feature will let us get the current time based on timezone. So we did the following tests:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># CREATE TABLE my_tbl (
</span><span class='line'>mylocaldb(# my_timestamp TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
</span><span class='line'>mylocaldb(# CHECK(EXTRACT(TIMEZONE FROM my_timestamp) = '0')
</span><span class='line'>mylocaldb(# );
</span><span class='line'>CREATE TABLE
</span><span class='line'>mylocaldb=# \dt my_tbl
</span><span class='line'>        List of relations
</span><span class='line'> Schema |  Name  | Type  | Owner 
</span><span class='line'>--------+--------+-------+-------
</span><span class='line'> public | my_tbl | table | Trusty
</span><span class='line'>(1 row)
</span></code></pre></td></tr></table></div></figure>


<p>When we want to insert the datatime into table &lsquo;my_tbl&rsquo;, simply do following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mylocaldb=# SET timezone = 'UTC';
</span><span class='line'>SET
</span><span class='line'>mylocaldb=# INSERT INTO my_tbl (my_timestamp) VALUES (NOW());
</span><span class='line'>INSERT 0 1
</span></code></pre></td></tr></table></div></figure>


<p>And for querying out the inserted records, we do following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mylocaldb=# select * from public.my_tbl
</span><span class='line'>;
</span><span class='line'>         my_timestamp          
</span><span class='line'>-------------------------------
</span><span class='line'> 2014-05-10 01:39:52.87532+00
</span><span class='line'> 2014-05-10 01:42:44.130269+00
</span><span class='line'>(2 rows)
</span><span class='line'>
</span><span class='line'>mylocaldb=# SET timezone='Asia/Shanghai';
</span><span class='line'>SET
</span><span class='line'>mylocaldb=# select * from public.my_tbl
</span><span class='line'>mylocaldb-# ;
</span><span class='line'>         my_timestamp          
</span><span class='line'>-------------------------------
</span><span class='line'> 2014-05-10 09:39:52.87532+08
</span><span class='line'> 2014-05-10 09:42:44.130269+08
</span><span class='line'>(2 rows)
</span><span class='line'>
</span><span class='line'>mylocaldb=# SET timezone='America/Los_Angeles';
</span><span class='line'>SET
</span><span class='line'>mylocaldb=# select * from public.my_tbl;
</span><span class='line'>         my_timestamp          
</span><span class='line'>-------------------------------
</span><span class='line'> 2014-05-09 18:39:52.87532-07
</span><span class='line'> 2014-05-09 18:42:44.130269-07
</span><span class='line'>(2 rows)
</span></code></pre></td></tr></table></div></figure>


<p>We can see the output formats depends on our &ldquo;timezone&rdquo; value.</p>

<h4>Select Other Data Formats</h4>

<p>We listed following table for describing the Data we inserted:  <br/>
Timestamp       integer     integer    integer    integer  <br/>
Insert_Time     Temperature Humidity   PMTen       PMTwoFive</p>

<p>Thus the sql sentense is as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mylocaldb=# CREATE TABLE weather (
</span><span class='line'>mylocaldb(# my_timestamp TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
</span><span class='line'>mylocaldb(# Temperature ^C
</span><span class='line'>mylocaldb=# CREATE TABLE weather (
</span><span class='line'>mylocaldb(# Insert_Time TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
</span><span class='line'>mylocaldb(# Temperature integer,
</span><span class='line'>mylocaldb(# Humidity integer,
</span><span class='line'>mylocaldb(# PMTen integer,
</span><span class='line'>mylocaldb(# PMTwoFive integer,
</span><span class='line'>mylocaldb(#  CHECK(EXTRACT(TIMEZONE FROM Insert_Time) = '0'));
</span></code></pre></td></tr></table></div></figure>


<p>Check the tables:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mylocaldb=# \dt
</span><span class='line'>        List of relations
</span><span class='line'> Schema |  Name   | Type  | Owner 
</span><span class='line'>--------+---------+-------+-------
</span><span class='line'> public | my_tbl  | table | Trusty
</span><span class='line'> public | user    | table | Trusty
</span><span class='line'> public | weather | table | Trusty
</span><span class='line'>(3 rows)
</span></code></pre></td></tr></table></div></figure>


<p>Insert one record:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mylocaldb=# INSERT INTO weather (Insert_Time, Temperature, Humidity, PMTen, PMTwoFive) VALUES(NOW(), 25, 80, 150, 75);
</span><span class='line'>INSERT 0 1
</span></code></pre></td></tr></table></div></figure>


<p>Displaying the inserted record:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mylocaldb=# SET timezone='Asia/Shanghai';
</span><span class='line'>SET
</span><span class='line'>mylocaldb=# select * from public.weather;
</span><span class='line'>          insert_time          | temperature | humidity | pmten | pmtwofive 
</span><span class='line'>-------------------------------+-------------+----------+-------+-----------
</span><span class='line'> 2014-05-10 10:38:27.276043+08 |          25 |       80 |   150 |        75
</span><span class='line'>(1 row)
</span></code></pre></td></tr></table></div></figure>


<h4>Database Operation</h4>

<p>We need to create just once database, So this function should be Check_Or_Create().   <br/>
We need to insert records, so Insert_Record() should be written.  <br/>
Other Operation, modification or delete shouldn&rsquo;t care at the very beginning.  <br/>
We will use a new file for recording all of the function.</p>

<p>The code for Create and Insert record into weather table is listed as following:</p>

<figure class='code'><figcaption><span>database.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">ForeignKey</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">DateTime</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">datetime</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Create the engine for connecting the local database</span>
</span><span class='line'><span class="c"># How to connect the remote engine, heroku postgres? </span>
</span><span class='line'><span class="c"># Yes, it&#39;s possible. The DATABASE_URL environment variable provided by heroku fits perfectly as argument for create_engine. Behind the scene, it&#39;s a postgresql database, which is perfectly handled by sqlalchemy.</span>
</span><span class='line'><span class="c"># </span>
</span><span class='line'><span class="c"># The way to do it may vary depending on the framework you use, but there shouldn&#39;t be any difficulty.</span>
</span><span class='line'>
</span><span class='line'><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;postgresql+psycopg2://Trusty:@localhost:5432/mylocaldb&#39;</span><span class="p">,</span><span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="n">metadata</span><span class="o">=</span><span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Definition of the weather table</span>
</span><span class='line'><span class="n">weather_table</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;weather&#39;</span><span class="p">,</span><span class="n">metadata</span><span class="p">,</span>
</span><span class='line'>  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;Insert_Time&#39;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;Temperature&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;Humidity&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;PmTen&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;PmTwoFive&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Create the table in mylocaldb</span>
</span><span class='line'><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># The actual SQL Language</span>
</span><span class='line'><span class="c">#CREATE TABLE weather (</span>
</span><span class='line'><span class="c"># &quot;Insert_Time&quot; TIMESTAMP WITH TIME ZONE NOT NULL, </span>
</span><span class='line'><span class="c"># &quot;Temperature&quot; INTEGER, </span>
</span><span class='line'><span class="c"># &quot;Humidity&quot; INTEGER, </span>
</span><span class='line'><span class="c"># &quot;PmTen&quot; INTEGER, </span>
</span><span class='line'><span class="c"># &quot;PmTwoFive&quot; INTEGER, </span>
</span><span class='line'><span class="c"># PRIMARY KEY (&quot;Insert_Time&quot;)</span>
</span><span class='line'><span class="c">#)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># mylocaldb=# select * from public.weather;</span>
</span><span class='line'><span class="c">#  Insert_Time | Temperature | Humidity | PmTen | PmTwoFive </span>
</span><span class='line'><span class="c"># -------------+-------------+----------+-------+-----------</span>
</span><span class='line'><span class="c"># (0 rows)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Record Insertion</span>
</span><span class='line'><span class="c"># First generate an insertion sentense:</span>
</span><span class='line'><span class="n">ins</span> <span class="o">=</span> <span class="n">weather_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
</span><span class='line'><span class="c">#&gt;&gt;&gt; str(ins)</span>
</span><span class='line'><span class="c">#&#39;INSERT INTO weather (&quot;Insert_Time&quot;, &quot;Temperature&quot;, &quot;Humidity&quot;, &quot;PmTen&quot;, &quot;PmTwoFive&quot;) VALUES (%(Insert_Time)s, %(Temperature)s, %(Humidity)s, %(PmTen)s, %(PmTwoFive)s)&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ins</span> <span class="o">=</span> <span class="n">weather_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">Insert_Time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span> <span class="n">Temperature</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">Humidity</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">PmTen</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">PmTwoFive</span><span class="o">=</span><span class="mi">55</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">#&gt;&gt;&gt; str(ins)</span>
</span><span class='line'><span class="c">#&#39;INSERT INTO weather (&quot;Insert_Time&quot;, &quot;Temperature&quot;, &quot;Humidity&quot;, &quot;PmTen&quot;, &quot;PmTwoFive&quot;) VALUES (%(Insert_Time)s, %(Temperature)s, %(Humidity)s, %(PmTen)s, %(PmTwoFive)s)&#39;</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#&gt;&gt;&gt; ins.compile().params</span>
</span><span class='line'><span class="c">#{&#39;PmTen&#39;: 100, &#39;PmTwoFive&#39;: 55, &#39;Temperature&#39;: 25, &#39;Insert_Time&#39;: datetime.datetime(2014, 5, 10, 5, 58, 21, 677234), &#39;Humidity&#39;: 75}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Connect to engine and execute. </span>
</span><span class='line'><span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class='line'><span class="c"># &gt;&gt;&gt; conn</span>
</span><span class='line'><span class="c"># &lt;sqlalchemy.engine.base.Connection object at 0x2715890&gt;</span>
</span><span class='line'><span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>
</span><span class='line'><span class="c"># View result in psql</span>
</span><span class='line'><span class="c"># mylocaldb=# select * from public.weather;</span>
</span><span class='line'><span class="c">#           Insert_Time          | Temperature | Humidity | PmTen | PmTwoFive </span>
</span><span class='line'><span class="c"># -------------------------------+-------------+----------+-------+-----------</span>
</span><span class='line'><span class="c">#  2014-05-10 05:58:21.677234+08 |          25 |       75 |   100 |        55</span>
</span></code></pre></td></tr></table></div></figure>


<p>The critical functions has been pointed out in the above python file. Now we will consider how to run these functions at background. This will lead to next topic, &ldquo;Run multiple process in a single Heroku dyno&rdquo;.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/09/write-python-weather-app-on-heroku-4/">Write Python Weather APP on Heroku(4)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-09T22:50:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:50 pm</span></time>
        
         | <a href="/blog/2014/05/09/write-python-weather-app-on-heroku-4/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Local Database Sync</h3>

<p>First fetch the remote database to localdb via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku pg:pull DATABASE_URL mylocaldb --app  python-weather-app
</span></code></pre></td></tr></table></div></figure>


<p>This command will pull down your database down and create a copy version locally. You can easily view all of the database via psql mylocaldb.</p>

<p>As root, edit following files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># pwd
</span><span class='line'>/var/lib/postgres/data
</span><span class='line'># vim postgresql.conf
</span><span class='line'>listen_addresses = 'localhost'        # what IP address(es) to listen on;
</span><span class='line'>                  # comma-separated list of addresses;
</span><span class='line'>                  # defaults to 'localhost'; use '*' for all
</span><span class='line'>                  # (change requires restart)
</span><span class='line'>port = 5432               # (change requires restart)
</span><span class='line'># vim pb_hba.conf
</span><span class='line'># IPv4 local connections:
</span><span class='line'>host    all             all             127.0.0.1/32            trust
</span><span class='line'>host    all             all             127.0.0.1/32            md5
</span></code></pre></td></tr></table></div></figure>


<p>After editing, save the file and restart the postgresql service.</p>

<h3>Connecting to LocalDatabase</h3>

<p>Following shows how to add/query the records. Now your environment could be totally debugged locally.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; import psycopg2
</span><span class='line'>&gt;&gt;&gt; psycopg2.connect(database="mylocaldb",user="Trusty",password="",host="127.0.0.1",port="5432")
</span><span class='line'>&lt;connection object at 0x30f0cd0; dsn: 'dbname=mylocaldb user=Trusty password=xx host=127.0.0.1 port=5432', closed: 0&gt;
</span><span class='line'>&gt;&gt;&gt; db_conn = 'postgresql+psycopg2://Trusty:@localhost/mylocaldb'
</span><span class='line'>&gt;&gt;&gt; app = Flask(__name__) 
</span><span class='line'>&gt;&gt;&gt; app.config['SQLALCHEMY_DATABASE_URI'] = db_conn
</span><span class='line'>&gt;&gt;&gt; db = SQLAlchemy(app)
</span><span class='line'>&gt;&gt;&gt; db.create_all()
</span><span class='line'>&gt;&gt;&gt; class User(db.Model):
</span><span class='line'>...     id = db.Column(db.Integer, primary_key=True)
</span><span class='line'>...     name = db.Column(db.String(80))
</span><span class='line'>...     email = db.Column(db.String(120), unique=True)
</span><span class='line'>...     def __init__(self, name, email):
</span><span class='line'>...         self.name = name
</span><span class='line'>...         self.email = email
</span><span class='line'>...     def __repr__(self):
</span><span class='line'>...         return '&lt;Name %r&gt;' % self.name
</span><span class='line'>... 
</span><span class='line'>&gt;&gt;&gt; user = User('John Doe', 'john.doe@example.com')
</span><span class='line'>&gt;&gt;&gt; all_users=User.query.all()
</span><span class='line'>&gt;&gt;&gt; print all_users
</span><span class='line'>[&lt;Name u'John Doe'&gt;]
</span><span class='line'>&gt;&gt;&gt; user1 = User('Jim Green', 'jim.green@english.com')
</span><span class='line'>&gt;&gt;&gt; db.session.add(user1)
</span><span class='line'>&gt;&gt;&gt; db.session.commit()
</span></code></pre></td></tr></table></div></figure>


<p>In genhtml.py we need to do corresponding changes in order to enable the local database.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/09/write-python-weather-app-on-heroku-3/">Write Python Weather APP on Heroku(3)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-09T19:12:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:12 pm</span></time>
        
         | <a href="/blog/2014/05/09/write-python-weather-app-on-heroku-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Database Introduction</h3>

<h4>Heroku Postgres Installation</h4>

<p>Before using postgres, we have to install this add-ons, we call this step &ldquo;attach Heroku POSTGRES to heroku application&rdquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku addons
</span><span class='line'>python-weather-app has no add-ons.
</span><span class='line'>$ heroku addons:add heroku-postgresql:dev
</span><span class='line'>Adding heroku-postgresql:dev on python-weather-app... done, v7 (free)
</span><span class='line'>Attached as HEROKU_POSTGRESQL_OLIVE_URL
</span><span class='line'>Database has been created and is available
</span><span class='line'> ! This database is empty. If upgrading, you can transfer
</span><span class='line'> ! data from another database with pgbackups:restore.
</span><span class='line'>Use `heroku addons:docs heroku-postgresql` to view documentation.
</span><span class='line'>$ heroku addons | grep POSTGRES
</span><span class='line'>heroku-postgresql:dev  HEROKU_POSTGRESQL_OLIVE
</span></code></pre></td></tr></table></div></figure>


<p>If you want to refer the documentation of heroku postgres, simply use following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku addons:docs heroku-postgresql
</span><span class='line'>Opening heroku-postgresql docs... done
</span></code></pre></td></tr></table></div></figure>


<p>A new browser window will be opened and you can view the help here.  <br/>
View the configuration of heroku postgres via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku pg:info
</span><span class='line'>=== HEROKU_POSTGRESQL_OLIVE_URL (DATABASE_URL)
</span><span class='line'>Plan:        Dev
</span><span class='line'>Status:      Available
</span><span class='line'>Connections: 0
</span><span class='line'>PG Version:  9.3.4
</span><span class='line'>Created:     2014-05-09 11:25 UTC
</span><span class='line'>Data Size:   6.4 MB
</span><span class='line'>Tables:      0
</span><span class='line'>Rows:        0/10000 (In compliance)
</span><span class='line'>Fork/Follow: Unsupported
</span><span class='line'>Rollback:    Unsupported
</span></code></pre></td></tr></table></div></figure>


<p>10000 rows means, if we use 24 rows per day, then around 1 year this database will be fulfilled. But anyway, at the very beginning developing, we won&rsquo;t consider the latter problem.  <br/>
After you installed the postgre for around 5 minutes, you can use following commands for displaying your database:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku pg:ps
</span><span class='line'> pid | state | source | running_for | waiting | query 
</span><span class='line'>-----+-------+--------+-------------+---------+-------
</span><span class='line'>(0 rows)
</span></code></pre></td></tr></table></div></figure>


<p>Now you can connect to pg via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku pg:psql
</span><span class='line'>---&gt; Connecting to HEROKU_POSTGRESQL_OLIVE_URL (DATABASE_URL)
</span><span class='line'>psql (9.3.4)
</span><span class='line'>SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>d47ena4men35jn=&gt; 
</span></code></pre></td></tr></table></div></figure>


<p>What for next?</p>

<h4>Local Postgres Installation</h4>

<p>Install postgres via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacamn -S postgre
</span><span class='line'>$ sudo -i -u postgres
</span><span class='line'>[postgres@DashArch ~]$ initdb --locale en_US.UTF-8 -E UTF8 -D '/var/lib/postgres/data'
</span><span class='line'># In another terminal, enable and start the service
</span><span class='line'>$ sudo systemctl start postgresql
</span><span class='line'>$ sudo systemctl enable postgresql
</span></code></pre></td></tr></table></div></figure>


<p>Now add current user into the postgres user:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[postgres@DashArch ~]$ createuser --interactive
</span><span class='line'>Enter name of role to add: Trusty
</span><span class='line'>Shall the new role be a superuser? (y/n) y
</span><span class='line'># Now 'Trusty' as postgres user, can create the weatherData database. 
</span><span class='line'>$ createdb weatherData
</span></code></pre></td></tr></table></div></figure>


<p>Basic user of postgres:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ psql -d weatherData   
</span><span class='line'>psql (9.3.4)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>weatherData=# \help
</span><span class='line'>......
</span><span class='line'>weatherData=# \q
</span><span class='line'>$ 
</span></code></pre></td></tr></table></div></figure>


<h4>Connect Database In Python(Local Way)</h4>

<p>Install the python packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip install psycopg2
</span><span class='line'>$ pip freeze 
</span><span class='line'># Add the psycopg2 related line into the requirements.txt
</span></code></pre></td></tr></table></div></figure>


<p>A simple example on how to connect Database and view the content of the database:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Trusty@~]$ sudo -u postgres createuser jim
</span><span class='line'>[Trusty@~]$ sudo -u postgres createdb testdb -O jim
</span><span class='line'>[Trusty@~/code/herokuWeatherApp]$ source venv/bin/activate
</span><span class='line'>(venv)[Trusty@~/code/herokuWeatherApp]$ python
</span><span class='line'>Python 2.7.6 (default, Feb 26 2014, 12:07:17) 
</span><span class='line'>[GCC 4.8.2 20140206 (prerelease)] on linux2
</span><span class='line'>Type "help", "copyright", "credits" or "license" for more information.
</span><span class='line'>&gt;&gt;&gt; import psycopg2
</span><span class='line'>&gt;&gt;&gt; import sys
</span><span class='line'>&gt;&gt;&gt; con = None
</span><span class='line'>&gt;&gt;&gt; con = psycopg2.connect(database='testdb', user='jim')
</span><span class='line'>&gt;&gt;&gt; cur = con.cursor()
</span><span class='line'>&gt;&gt;&gt; cur.execute('SELECT version()')   
</span><span class='line'>&gt;&gt;&gt; ver = cur.fetchone()
</span><span class='line'>&gt;&gt;&gt; print ver
</span><span class='line'>('PostgreSQL 9.3.4 on x86_64-unknown-linux-gnu, compiled by gcc (GCC) 4.8.2 20140206 (prerelease), 64-bit',)
</span><span class='line'>&gt;&gt;&gt; con.close()
</span><span class='line'>&gt;&gt;&gt; quit()
</span><span class='line'>(venv)[Trusty@~/code/herokuWeatherApp]$ 
</span></code></pre></td></tr></table></div></figure>


<h4>Connect Heroku Postgres</h4>

<p>Now commit our modifications into heroku, and verify to see if we can really do some magic things with postgres:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git add .
</span><span class='line'>$ git commit -m "commit for postgres"
</span><span class='line'>$ git push heroku master
</span></code></pre></td></tr></table></div></figure>


<p>Install a new library:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip install flask-sqlalchemy
</span><span class='line'>$ pip freeze  # grep the line and add it into the requirement.txt
</span></code></pre></td></tr></table></div></figure>


<p>Promoting the URL to DATABASE_URL:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku pg:promote HEROKU_POSTGRESQL_OLIVE_URL
</span><span class='line'>Promoting HEROKU_POSTGRESQL_OLIVE_URL (DATABASE_URL) to DATABASE_URL... done
</span></code></pre></td></tr></table></div></figure>


<p>Then Add the following lines into genhtml.py:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from flask.ext.sqlalchemy import SQLAlchemy
</span><span class='line'>app.config['SQLALCHEMY_DATABASE_URI'] = os.environ['DATABASE_URL']
</span><span class='line'>db = SQLAlchemy(app)
</span><span class='line'>
</span><span class='line'>##############FenGe_Line####################
</span><span class='line'>class User(db.Model):
</span><span class='line'>    id = db.Column(db.Integer, primary_key=True)
</span><span class='line'>    name = db.Column(db.String(80))
</span><span class='line'>    email = db.Column(db.String(120), unique=True)
</span><span class='line'>
</span><span class='line'>    def __init__(self, name, email):
</span><span class='line'>        self.name = name
</span><span class='line'>        self.email = email
</span><span class='line'>
</span><span class='line'>    def __repr__(self):
</span><span class='line'>        return '&lt;Name %r&gt;' % self.name
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>Commit again and begin for verifying the database via CLI:  <br/>
Create a python interactive command window via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; from genhtml import db
</span><span class='line'>&gt;&gt;&gt; db.create_all()
</span><span class='line'>&gt;&gt;&gt; from genhtml import User
</span><span class='line'>&gt;&gt;&gt; user = User('John Doe', 'john.doe@example.com')
</span><span class='line'>&gt;&gt;&gt; db.session.add(user)
</span><span class='line'>&gt;&gt;&gt; db.session.commit()
</span><span class='line'>&gt;&gt;&gt; all_users =User.query.all()
</span><span class='line'>&gt;&gt;&gt; print all_users
</span><span class='line'>[&lt;Name u'John Doe'&gt;]
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can see 1 record has been inserted into the database:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Trusty@~/code/herokuWeatherApp]$ heroku pg:info
</span><span class='line'>=== HEROKU_POSTGRESQL_OLIVE_URL (DATABASE_URL)
</span><span class='line'>Plan:        Dev
</span><span class='line'>Status:      Available
</span><span class='line'>Connections: 2
</span><span class='line'>PG Version:  9.3.4
</span><span class='line'>Created:     2014-05-09 11:25 UTC
</span><span class='line'>Data Size:   6.5 MB
</span><span class='line'>Tables:      1
</span><span class='line'>Rows:        1/10000 (In compliance)
</span><span class='line'>Fork/Follow: Unsupported
</span><span class='line'>Rollback:    Unsupported
</span></code></pre></td></tr></table></div></figure>


<p>How to see the inserted data?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku pg:psql
</span><span class='line'>---&gt; Connecting to HEROKU_POSTGRESQL_OLIVE_URL (DATABASE_URL)
</span><span class='line'>psql (9.3.4)
</span><span class='line'>SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>d47ena4men35jn=&gt; select current_database();
</span><span class='line'> current_database 
</span><span class='line'>------------------
</span><span class='line'> d47ena4men35jn
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>d47ena4men35jn=&gt; \dt
</span><span class='line'>           List of relations
</span><span class='line'> Schema | Name | Type  |     Owner      
</span><span class='line'>--------+------+-------+----------------
</span><span class='line'> public | user | table | yjusdsrpwpplxp
</span><span class='line'>(1 row)
</span><span class='line'>
</span><span class='line'>d47ena4men35jn=&gt; \d user;
</span><span class='line'>                                 Table "public.user"
</span><span class='line'> Column |          Type          |                     Modifiers                     
</span><span class='line'>--------+------------------------+---------------------------------------------------
</span><span class='line'> id     | integer                | not null default nextval('user_id_seq'::regclass)
</span><span class='line'> name   | character varying(80)  | 
</span><span class='line'> email  | character varying(120) | 
</span><span class='line'>Indexes:
</span><span class='line'>    "user_pkey" PRIMARY KEY, btree (id)
</span><span class='line'>    "user_email_key" UNIQUE CONSTRAINT, btree (email)
</span><span class='line'>
</span><span class='line'>d47ena4men35jn=&gt; SELECT * FROM public.user;
</span><span class='line'> id |   name   |        email         
</span><span class='line'>----+----------+----------------------
</span><span class='line'>  1 | John Doe | john.doe@example.com
</span><span class='line'>(1 row)
</span></code></pre></td></tr></table></div></figure>


<p>We can use python&rsquo;s interface for add/delete records, drop tables, etc.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/09/write-python-weather-app-on-heroku-2/">Write Python Weather APP on Heroku(2)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-09T15:19:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:19 pm</span></time>
        
         | <a href="/blog/2014/05/09/write-python-weather-app-on-heroku-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Get Current Weather Data</h3>

<p>Now we begin to change our APP to a real funny staff. First we change the hello.py and begin to write our own &ldquo;genhtml.py&rdquo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mv hello.py genhtml.py
</span><span class='line'>$ cat Procfile
</span><span class='line'>web: gunicorn genhtml:app
</span></code></pre></td></tr></table></div></figure>


<p>We know there is an python library which we could install from pip named &ldquo;pywapi&rdquo;, simply install it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(venv2) $ pip install pywapi
</span></code></pre></td></tr></table></div></figure>


<p>If your pip&rsquo;s version is 1.5.1, then notice you have to use following command for installing the pywapi:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(venv2) $ pip install pywapi --allow-external pywapi --allow-unverified pywapi
</span><span class='line'>Downloading/unpacking pywapi
</span><span class='line'>  pywapi is potentially insecure and unverifiable.
</span><span class='line'>  Downloading pywapi-0.3.8.tar.gz
</span><span class='line'>  Running setup.py (path:/home/Trusty/code/herokuWeatherApp/venv/build/pywapi/setup.py) egg_info for package pywapi
</span><span class='line'>    
</span><span class='line'>Installing collected packages: pywapi
</span><span class='line'>  Running setup.py install for pywapi
</span><span class='line'>    
</span><span class='line'>Successfully installed pywapi
</span><span class='line'>Cleaning up...
</span></code></pre></td></tr></table></div></figure>


<p>Now change the genhtml.py to following content:</p>

<figure class='code'><figcaption><span>genhtml.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">pywapi</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">string</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Generate the Nanjing Weather Data</span>
</span><span class='line'><span class="k">def</span> <span class="nf">genhtml</span><span class="p">():</span>
</span><span class='line'>    <span class="n">Yahoo_Result</span> <span class="o">=</span> <span class="n">pywapi</span><span class="o">.</span><span class="n">get_weather_from_yahoo</span><span class="p">(</span><span class="s">&#39;CHXX0099&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">Current_Temp</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">Yahoo_Result</span><span class="p">[</span><span class="s">&#39;condition&#39;</span><span class="p">][</span><span class="s">&#39;temp&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">Current_Humi</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">Yahoo_Result</span><span class="p">[</span><span class="s">&#39;atmosphere&#39;</span><span class="p">][</span><span class="s">&#39;humidity&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">Tomorrow_Forecast</span> <span class="o">=</span> <span class="n">Yahoo_Result</span><span class="p">[</span><span class="s">&#39;forecasts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">Twenty_Four_Hours</span> <span class="o">=</span> <span class="n">Yahoo_Result</span><span class="p">[</span><span class="s">&#39;forecasts&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>    <span class="n">Fourty_Eight_Hours</span> <span class="o">=</span> <span class="n">Yahoo_Result</span><span class="p">[</span><span class="s">&#39;forecasts&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>    <span class="n">Seventy_Two_Hours</span> <span class="o">=</span> <span class="n">Yahoo_Result</span><span class="p">[</span><span class="s">&#39;forecasts&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Current_Temp</span>
</span></code></pre></td></tr></table></div></figure>


<p>After modification, we use &ldquo;foreman start&rdquo; for previewing the result, we can see the webpage returns the current temperature of Nanjing, its value is 25, as in following picture:  <br/>
<img src="/images/current_temp.jpg" alt="/images/current_temp.jpg" /></p>

<p>This shows the pywapi could be work together with other components, we will continue for next step.</p>

<h3>Deployment On Heroku</h3>

<p>You need to change the requirement.txt file like following:</p>

<figure class='code'><figcaption><span>genhtml.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="err">$</span> <span class="n">cat</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</span><span class='line'><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="nb">all</span><span class="o">-</span><span class="n">external</span>
</span><span class='line'><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">unverified</span> <span class="n">pywapi</span>
</span><span class='line'><span class="n">Flask</span><span class="o">==</span><span class="mf">0.10</span><span class="o">.</span><span class="mi">1</span>
</span><span class='line'><span class="n">Jinja2</span><span class="o">==</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">2</span>
</span><span class='line'><span class="n">MarkupSafe</span><span class="o">==</span><span class="mf">0.23</span>
</span><span class='line'><span class="n">Werkzeug</span><span class="o">==</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">4</span>
</span><span class='line'><span class="n">gunicorn</span><span class="o">==</span><span class="mf">18.0</span>
</span><span class='line'><span class="n">itsdangerous</span><span class="o">==</span><span class="mf">0.24</span>
</span><span class='line'><span class="n">pywapi</span><span class="o">==</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">8</span>
</span><span class='line'><span class="n">wsgiref</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then run &ldquo;git push heroku master&rdquo;, open your browser and visit <a href="http://python-weather-app.herokuapp.com/">http://python-weather-app.herokuapp.com/</a>, the output the same as in local.</p>

<p>By now, we have created a very simple app on getting the current temperature of nanjing, next chapter we will use database for timely record the data.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/09/write-python-weather-app-on-heroku/">Write Python Weather APP on Heroku</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-09T14:40:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:40 pm</span></time>
        
         | <a href="/blog/2014/05/09/write-python-weather-app-on-heroku/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Accounting Setting</h3>

<p>First you should have heroku accounting, then create an app on heroku, write down its repository information, mine is listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Your app, python-weather-app, has been created.    
</span><span class='line'>App URL:    
</span><span class='line'>http://python-weather-app.herokuapp.com/   
</span><span class='line'>Git URL:    
</span><span class='line'>git@heroku.com:python-weather-app.git      
</span><span class='line'>Use the following code to set up your app for local development:    
</span></code></pre></td></tr></table></div></figure>


<p>git clone git@heroku.com:python-weather-app.git -o heroku</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Suggested next steps    
</span><span class='line'> Get started with Heroku.   
</span><span class='line'> Add some collaborators.    
</span><span class='line'> Check out some of our great add-ons.
</span></code></pre></td></tr></table></div></figure>


<p>Before you continue, make sure you have install heroku tools:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ yaourt -S heroku-toolbelt
</span></code></pre></td></tr></table></div></figure>


<h3>Create HelloWorld App</h3>

<p>Use github for recording all of the source code.<br/>
Create a repository on github, mine is at &ldquo;git@github.com:kkkttt/herokuWeatherApp.git&rdquo;, then:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pwd
</span><span class='line'>/home/Trusty/code/herokuWeatherApp
</span><span class='line'>$ touch README.md
</span><span class='line'>$ git init
</span><span class='line'>$ git add README.md
</span><span class='line'>$ git commit -m "first commit"
</span><span class='line'>$ git remote add origin git@github.com:kkkttt/herokuWeatherApp.git
</span><span class='line'>$ git push -u origin master
</span></code></pre></td></tr></table></div></figure>


<p>First login with heroku:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku login
</span><span class='line'>Enter your Heroku credentials.
</span><span class='line'>Email: xxxxxx@gmail.com
</span><span class='line'>Password (typing will be hidden): 
</span><span class='line'>Authentication successful.
</span></code></pre></td></tr></table></div></figure>


<p>Now create the folder which holds WeatherApp and create the venv, later we will use virtual environment for working:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virtualenv2 venv
</span><span class='line'>New python executable in venv/bin/python2
</span><span class='line'>Also creating executable in venv/bin/python
</span><span class='line'>Installing setuptools, pip...done.
</span><span class='line'>$ source venv/bin/activate
</span><span class='line'>(venv) $ pip install Flask gunicorn
</span></code></pre></td></tr></table></div></figure>


<p>Now we write a very simple python file, name it &ldquo;hello.py&rdquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import os
</span><span class='line'>from flask import Flask
</span><span class='line'>
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>
</span><span class='line'>@app.route('/')
</span><span class='line'>def hello():
</span><span class='line'>    return 'Hello World!'
</span></code></pre></td></tr></table></div></figure>


<p>Create a Procfile in the root directory which holds our own App:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat Procfile 
</span><span class='line'>web: gunicorn hello:app
</span></code></pre></td></tr></table></div></figure>


<p>Use foreman for preview the web app:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ foreman start
</span><span class='line'>14:53:37 web.1  | started with pid 30946
</span><span class='line'>14:53:37 web.1  | 2014-05-09 14:53:37 [30946] [INFO] Starting gunicorn 18.0
</span><span class='line'>14:53:37 web.1  | 2014-05-09 14:53:37 [30946] [INFO] Listening at: http://0.0.0.0:5000 (30946)
</span><span class='line'>....
</span></code></pre></td></tr></table></div></figure>


<p>Open your browser and visit &ldquo;<a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a>&rdquo; and you can see &ldquo;Hello World&rdquo; is in browser.  <br/>
Now make the requirement file in the root folder:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip freeze&gt;requirements.txt
</span><span class='line'>(venv)$ cat requirements.txt 
</span><span class='line'>Flask==0.10.1
</span><span class='line'>Jinja2==2.7.2
</span><span class='line'>MarkupSafe==0.23
</span><span class='line'>Werkzeug==0.9.4
</span><span class='line'>gunicorn==18.0
</span><span class='line'>itsdangerous==0.24
</span><span class='line'>wsgiref==0.1.2
</span></code></pre></td></tr></table></div></figure>


<h3>Deploy It To Heroku</h3>

<p>We have to ignore the temp files, so we add following into our .gitignores file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat .gitignore
</span><span class='line'>*~
</span><span class='line'>*.pyc
</span><span class='line'>venv/
</span></code></pre></td></tr></table></div></figure>


<p>We add the app into the heroku:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku git:remote -a python-weather-app
</span><span class='line'>Git remote heroku added
</span><span class='line'>(venv)$ git remote -v
</span><span class='line'>heroku    git@heroku.com:python-weather-app.git (fetch)
</span><span class='line'>heroku    git@heroku.com:python-weather-app.git (push)
</span><span class='line'>origin    git@github.com:kkkttt/herokuWeatherApp.git (fetch)
</span><span class='line'>origin    git@github.com:kkkttt/herokuWeatherApp.git (push)
</span></code></pre></td></tr></table></div></figure>


<p>Deploy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git push heroku master
</span></code></pre></td></tr></table></div></figure>


<p>Now open your browser and visit &ldquo;<a href="http://python-weather-app.herokuapp.com/">http://python-weather-app.herokuapp.com/</a>&rdquo; you will see the webpage displays &ldquo;Hello World!&rdquo;.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/08/wake-on-lan/">Wake on LAN</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-08T15:08:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:08 pm</span></time>
        
         | <a href="/blog/2014/05/08/wake-on-lan/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>See if your equipment support &ldquo;Wake On LAN&rdquo; feature:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ethtool enp0s25 | grep "Wake"
</span><span class='line'>Cannot get wake-on-lan settings: Operation not permitted
</span></code></pre></td></tr></table></div></figure>


<p>If you got this feature, then install wol:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pacman -S wol
</span></code></pre></td></tr></table></div></figure>


<p>Record the mac address of your equipment which you want to wake up, in a living machine, if you want to wake it, simply use following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># wol -i HOSTNAME_OR_IP MACADDRESS
</span></code></pre></td></tr></table></div></figure>


<p>The next consideration is, how to keep a wake-up equipment 24-hours, I suggest you use BeagleBone or Raspberry PI, or you can research how to use arduino and write your own applications.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/08/use-tunnel-for-acrossing-something/">Use Tunnel for Acrossing Something</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-08T07:53:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:53 am</span></time>
        
         | <a href="/blog/2014/05/08/use-tunnel-for-acrossing-something/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Network Envorinment Introduction</h3>

<p>The network envoriment in daily working envoriment is very bad, thus I have to think for a solution, which could improve my network speed. <br/>
Following picture describes the network topology of the daily working.  <br/>
<img src="/images/CompanyNetwork1.jpg" alt="/images/CompanyNetwork1.jpg" /></p>

<p>From the picture we can see, several users shared a very narrow path, and this path have to go through chinese firewall, this firewall is ghastly, because it will filter some sensitive website which is not welcomed by CN gov.</p>

<h3>Our VPN Introduction</h3>

<p>There are very wide VPN(Virtual Private Network) between CN and US, the US networking don&rsquo;t have to pass through the firewall.   <br/>
Another big surprise is created by the time difference, when chinese are working, lots of american people are out of office.  <br/>
<img src="/images/CompanyNetwork2.jpg" alt="/images/CompanyNetwork2.jpg" /></p>

<p>Surely we can make full use of our whole company&rsquo;s network condition.</p>

<h3>Solution 1: SSH Forwarding</h3>

<p>First we will find a server which could forward ssh, just like in the picture. <br/>
<img src="/images/CompanyNetwork3.jpg" alt="/images/CompanyNetwork3.jpg" /></p>

<p>Then we can use following command for setup a ssh tunnel, which could forwarding our network flow to us proxy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -C  -L YourMachine:Port:USProxy:USProxy_Port YouAccount@ForwardingServer
</span></code></pre></td></tr></table></div></figure>


<p>Then in your browser or your application, use <a href="http://YourMachine:Port">http://YourMachine:Port</a> as a proxy.</p>

<h3>Solution 2: TCP Tunnel Forwarding</h3>

<p>Not every server can open ssh forwarding for you. For example, in following server, tcp forwarding is forbidden:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/ssh/sshd_config
</span><span class='line'># Port forwarding
</span><span class='line'>AllowTcpForwarding no
</span></code></pre></td></tr></table></div></figure>


<p>Thus we have to setup our own tcp tunnel manually.</p>

<h4>Netcat Way</h4>

<p>Use following way you can use netcat for creating a very simple tunnel, which could forwarding all of your flow to US proxy, these operation have to be done on server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /tmp/fifo
</span><span class='line'>$ nc -lvvp -k 2323 0&lt;/tmp/fifo | nc -k USproxy USProxy_Port 1&gt;fifo
</span></code></pre></td></tr></table></div></figure>


<p>Then set the local proxy to <a href="http://server_ip:2323,">http://server_ip:2323,</a> then you can reached the proxy.</p>

<h4>Tunnel Way</h4>

<p>Netcat way is OK, but the netcat version is very old on US Server, it can&rsquo;t support &lsquo;-k&rsquo; option, for &lsquo;-k&rsquo; option is only supported by openbsd-netcat, and because the server is too old(It&rsquo;s Sun OS 5.10, or solaris? ), so we have to find other ways.   <br/>
Luckily I find a small tool, which could fit for our requirement.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget http://www.cri.ensmp.fr/~coelho/tunnel.c
</span><span class='line'>$ gcc -o tunnel tunnel.c -lsocket
</span></code></pre></td></tr></table></div></figure>


<p>This compiling will complain &lsquo;herror&rsquo; is not supported, thus we have to comment them, or change them from &lsquo;herror&rsquo; to &lsquo;printf&rsquo;, anyway, the error happens seldomly.  <br/>
Use following command for setting up a tunnel in server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./tunnel -Lr server_ip:1080 proxy:80
</span></code></pre></td></tr></table></div></figure>


<p>Then in your own PC, set proxy to <a href="http://server_ip:1080,">http://server_ip:1080,</a> you can reach the internet through your own tunnel, which will guide your traffic from VPN to US, then to Internet.</p>

<h3>Make Tunnel Invisible</h3>

<p>Normally system administrator won&rsquo;t like tunnel on server, maybe they will scan the server and find out the port occupation. So we have to do some modification to tunnel.c. <br/>
First, change the name of the executable file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mv tunnel.c autrace.c
</span><span class='line'>$ gcc -o autrace autrace.c -lsocket
</span></code></pre></td></tr></table></div></figure>


<p>So now, you can run your tunnel program via &lsquo;./autrace -Lr localhost:1080 proxy:80&rsquo;.</p>

<p>But this is not so safe, administrator will also find the port, then they will track this port, and find your tricks, so we have to hidden the port words. <br/>
In autrace.c, do following changes in corresponding lines:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//  Around line 128, change the ip/port into your own. 
</span><span class='line'>
</span><span class='line'>/* default connexion. */
</span><span class='line'>#define LHOST "138.138.138.138" /* this really means 127.0.0.1, thus no network! */
</span><span class='line'>#define LPORT "4444"
</span><span class='line'>/* DHOST: &lt;same as chosen LHOST&gt; */
</span><span class='line'>//#define DPORT "23"        /* telnet port */
</span><span class='line'>#define DHOST "139.139.139.139"
</span><span class='line'>#define DPORT "8888"
</span><span class='line'>
</span><span class='line'>// Around line 1023, this is actually a bug.  
</span><span class='line'> dhosts = getenv("DHOST"); 1023
</span></code></pre></td></tr></table></div></figure>


<p>Now you can run command like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./autracce -s
</span></code></pre></td></tr></table></div></figure>


<h3>Make Tunnel Only Serve for you</h3>

<p>We have to forbidden other user use our tunnel, because <a href="http://server_ip:port">http://server_ip:port</a> is open to all of the person in VPN.  <br/>
We add following ACL rule in the autrace.c:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// in main(), around line 935
</span><span class='line'>  /* Initialize the parameter for ACL(Access Control List) */
</span><span class='line'>  struct sockaddr_in sa;
</span><span class='line'>  inet_pton(AF_INET, "Your_IP_Address", &(sa.sin_addr));
</span><span class='line'>  allow_address = ntohl(sa.sin_addr.s_addr);
</span><span class='line'>
</span><span class='line'>// in main(), around line 1187
</span><span class='line'>      /* In here, we will do filter, filter specified ip address */
</span><span class='line'>      /* Compare the allowed ip address with the incomming's ip address */
</span><span class='line'>      if( allow_address != (ntohl(client_addr.sin_addr.s_addr)))
</span><span class='line'>      {
</span><span class='line'>        fprintf(stderr, "Sorry, you are not welcomed!\n");
</span><span class='line'>        /* No more receive/send any data */
</span><span class='line'>        shutdown(client_socket, 2);
</span><span class='line'>      }
</span></code></pre></td></tr></table></div></figure>


<p>The code will check the incoming client&rsquo;s ip address, and comparing it to our pre-defined ip address(Your_IP_Address), if they are not equal, our server will directly close the socket, so the client will receive refuse information.</p>

<p>Now you have a very safe and reliable path will will let you reach the internet via wide VPN and swift US network, enjoy it.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/44">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/42">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/05/29/yang-cheng-man-bu-er/">羊城漫步(二)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/28/yang-cheng-man-bu-yi/">羊城漫步(一)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/18/working-tips-on-ansible-cobbler-3/">Working Tips on Ansible-cobbler(3)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/12/tips-on-maas-2-dot-0/">Tips on Maas 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/11/setup-lxd-on-ubuntu1604/">Setup LXD on Ubuntu1604</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>









<div style="display:none">
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2101056" charset="utf-8"></script>
</div>





</body>
</html>
