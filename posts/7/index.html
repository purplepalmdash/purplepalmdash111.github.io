
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="Add Specified Machine We could add the specified name of the machine: 1
$ juju add-machine MaasOpenContrail6.maas While the name of MaasOpenContrail6 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/posts/7">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.useso.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/26/juju-tips/">Juju Tips</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-26T11:43:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:43 am</span></time>
        
         | <a href="/blog/2015/03/26/juju-tips/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Add Specified Machine</h3>

<p>We could add the specified name of the machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju add-machine MaasOpenContrail6.maas
</span></code></pre></td></tr></table></div></figure>


<p>While the name of <code>MaasOpenContrail6.maas</code> is the  name which we could get from the MAAS webUI.</p>

<h3>Get/Set Constraints</h3>

<p>We could dynamically set constraints for adding/removing new machines or unit, get/set it via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju get-constraints
</span><span class='line'>mem=3072M
</span><span class='line'>$ juju set-constraints "mem=1024M"
</span><span class='line'>$ juju get-constraints
</span><span class='line'>mem=1024M
</span></code></pre></td></tr></table></div></figure>


<h3>Tags</h3>

<p>Sometimes we need to add tags to specified maas units, the following webpage is for reference:   <br/>
<a href="http://en.community.dell.com/techcenter/os-applications/w/wiki/7432.using-tags-with-maas-and-juju-in-ubuntu-server-14-04-lts">http://en.community.dell.com/techcenter/os-applications/w/wiki/7432.using-tags-with-maas-and-juju-in-ubuntu-server-14-04-lts</a>  <br/>
<a href="https://maas.ubuntu.com/docs/tags.html">https://maas.ubuntu.com/docs/tags.html</a></p>

<h3>Remove specified service</h3>

<p>Get the status of the specified service via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju status neutron-api
</span><span class='line'>services:
</span><span class='line'>  neutron-api:
</span><span class='line'>    charm: cs:trusty/neutron-api-9
</span><span class='line'>    exposed: false
</span><span class='line'>    life: dying
</span><span class='line'>    units:
</span><span class='line'>      neutron-api/0:
</span><span class='line'>        agent-state: error
</span><span class='line'>        agent-state-info: 'hook failed: "install"'
</span><span class='line'>        agent-version: 1.21.3.1
</span><span class='line'>        life: dying
</span><span class='line'>        machine: "6"
</span><span class='line'>        public-address: MaasOpenContrail7.maas
</span><span class='line'>networks:
</span><span class='line'>  maas-eth0:
</span><span class='line'>    provider-id: maas-eth0
</span><span class='line'>    cidr: 10.17.17.0/24
</span></code></pre></td></tr></table></div></figure>


<p>Resolved this service&rsquo;s located units first:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Trusty@MassController:~/Code/deploy$ juju resolved neutron-api/0
</span></code></pre></td></tr></table></div></figure>


<p>Now remove the service via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Trusty@MassController:~/Code/deploy$ juju remove-service neutron-api
</span></code></pre></td></tr></table></div></figure>


<p>Sometimes you need to type in resolved the unit for several times.  <br/>
Finally, if your machine runs into error state, you could destroy it forcely via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju destroy-machine x --force
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/24/deploy-maas-11/">Deploy MAAS(11)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-24T09:14:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:14 am</span></time>
        
         | <a href="/blog/2015/03/24/deploy-maas-11/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since the deployment meets some problem, I have to consider doing some tricks in the MAAS controller, to let the deployment much more easier and time-saving, following is the steps for setting up such environment.</p>

<h3>Resize Maas Controller Disk</h3>

<p>Since the Mass Controller machine only have 40G size harddisk, it will be not enough if we enable the repository cache for guest machines, thus we have to resize the disk.  <br/>
First shutdown the virtual machine.   <br/>
Resize the qcow2 file via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># virsh dumpxml MassController | grep qcow2
</span><span class='line'>      &lt;driver name='qemu' type='qcow2' cache='none'/&gt;
</span><span class='line'>      &lt;source file='/home/juju/img/MassController.qcow2'/&gt;
</span><span class='line'># qemu-img resize /home/juju/img/MassController.qcow2 +40GB
</span><span class='line'>Image resized.
</span><span class='line'># qemu-img info /home/juju/img/MassController.qcow2
</span><span class='line'>image: /home/juju/img/MassController.qcow2
</span><span class='line'>file format: qcow2
</span><span class='line'>virtual size: 80G (85899345920 bytes)
</span><span class='line'>disk size: 9.4G
</span><span class='line'>cluster_size: 65536
</span><span class='line'># virsh start MassController
</span></code></pre></td></tr></table></div></figure>


<p>Now use a liveCD for startup the machine, this will bootup the machine into a iso booted environment.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget http://downloads.sourceforge.net/gparted/gparted-live-0.21.0-1-i586.iso
</span></code></pre></td></tr></table></div></figure>


<p>Bootup the machine and resize like following:  <br/>
<img src="/images/2015_03_24_10_28_21_791x423.jpg" alt="/images/2015_03_24_10_28_21_791x423.jpg" /></p>

<h3>squid-deb-proxy</h3>

<p>In Mass Controller machine, install following packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install squid-deb-proxy avahi-utils
</span><span class='line'>$ sudo start squid-deb-proxy
</span></code></pre></td></tr></table></div></figure>


<p>Every client should install following package:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install squid-deb-proxy-client
</span></code></pre></td></tr></table></div></figure>


<p>Don&rsquo;t install squid-deb-proxy, because it will cause maas to be removed.</p>

<p>In fact MAAS manages its own squid, named maas-proxy, which could be examined via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ps -ef | grep squid
</span><span class='line'>proxy      763     1  0 Mar23 ?        00:00:07 /usr/sbin/squid3 -N -f /etc/maas/maas-proxy.conf
</span><span class='line'>Trusty      3892  3861  0 00:13 pts/5    00:00:00 grep --color=auto squid
</span></code></pre></td></tr></table></div></figure>


<p>This may cause all of the packages, or images be cached in squid, but it will be very helpful if we want to speedup the installation speed. <br/>
configure the squide&rsquo;s cache directory size via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/maas/maas-proxy.conf
</span><span class='line'>
</span><span class='line'>cache_dir ufs /var/spool/squid 100 16 256
</span><span class='line'>By default, the cache_dir directory may be commented.
</span><span class='line'>
</span><span class='line'>/var/spool/squid – This is the directory folder where squid will use to swap cache your server web files
</span><span class='line'>100 – The amount of disk space to use in MB for your caching directory
</span><span class='line'>16 – the first-level subdirectories which will be created in your cache directory
</span><span class='line'>256 – The number of second-level subdirectories which will be created under each first level directory
</span></code></pre></td></tr></table></div></figure>


<p>
We should add following configuration under the configure.yaml of the .juju/:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>maas-server: http://10.17.17.200/MAAS
</span><span class='line'>http-proxy: http://10.17.17.200:8000
</span><span class='line'>#https-proxy: http://10.17.17.200:3128
</span><span class='line'>no-proxy: localhost,10.17.17.0/24
</span><span class='line'>apt-http-proxy: http://10.17.17.200:8000
</span><span class='line'>#apt-https-proxy: http://10.17.17.200:3128
</span><span class='line'>apt-ftp-proxy: http://10.17.17.200:8000
</span><span class='line'>type: maas
</span></code></pre></td></tr></table></div></figure>


<p>After configuration, the bootstrap and add-machine will succesfully deployed.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/23/using-juju-for-deploying-opencontrail/">Using Juju for Deploying OpenContrail</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-23T11:37:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>11:37 am</span></time>
        
         | <a href="/blog/2015/03/23/using-juju-for-deploying-opencontrail/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Preparation</h3>

<p>First we have to create 4 images which will hold our own opearating system.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> 1016  qemu-img create -f qcow2 OpenContrail0.qcow2 40G
</span><span class='line'> 1017  qemu-img create -f qcow2 OpenContrail1.qcow2 40G
</span><span class='line'> 1018  qemu-img create -f qcow2 OpenContrail3.qcow2 40G
</span><span class='line'> 1019  qemu-img create -f qcow2 OpenContrail2.qcow2 40G
</span><span class='line'> 1020  ls
</span><span class='line'> 1021  history
</span><span class='line'># pwd
</span><span class='line'>/home/juju/img/OpenContrail
</span><span class='line'># qemu-img create -f qcow2 OpenContrail0.qcow2 40G
</span><span class='line'># qemu-img create -f qcow2 OpenContrail1.qcow2 40G
</span><span class='line'># qemu-img create -f qcow2 OpenContrail3.qcow2 40G
</span><span class='line'># qemu-img create -f qcow2 OpenContrail2.qcow2 40G
</span><span class='line'># ls
</span><span class='line'>OpenContrail0.qcow2  OpenContrail1.qcow2  OpenContrail2.qcow2  OpenContrail3.qcow2
</span></code></pre></td></tr></table></div></figure>


<p>Second, we create the four nodes in the virt-manager, each of them have 3G Memory, and have the cpu copied. Their network deployed to the newly added isolated network. <br/>
<img src="/images/2015_03_23_11_55_12_711x170.jpg" alt="/images/2015_03_23_11_55_12_711x170.jpg" />  <br/>
After commission, the status should be &ldquo;ready&rdquo;.</p>

<h3>Juju</h3>

<p>Copy the new environment named OpenContrail:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.juju/environments.yaml 
</span><span class='line'># This file has been generated by juju quickstart v2.0.1
</span><span class='line'># at 2015-03-19 06:36:40 UTC.
</span><span class='line'>
</span><span class='line'>default: maas
</span><span class='line'>environments:
</span><span class='line'>  maas:
</span><span class='line'>    admin-secret: xxxx
</span><span class='line'>    default-series: trusty
</span><span class='line'>    maas-oauth: u8HmYg24sUxerux4N8:kcYJ8mJdePBSe4DfxD:H4qFjEpLP86Lw6xnxjHG5qrHY3abPYzZ
</span><span class='line'>    maas-server: http://10.17.17.200/MAAS
</span><span class='line'>    type: maas
</span><span class='line'>  OpenContrail:
</span><span class='line'>    admin-secret: xxxx
</span><span class='line'>    default-series: trusty
</span><span class='line'>    maas-oauth: u8HmYg24sUxerux4N8:kcYJ8mJdePBSe4DfxD:H4qFjEpLP86Lw6xnxjHG5qrHY3abPYzZ
</span><span class='line'>    maas-server: http://10.17.17.200/MAAS
</span><span class='line'>    type: maas
</span></code></pre></td></tr></table></div></figure>


<p>
Then <code>juju switch</code> and examine you are currently operate at OpenContrail via <code>juju switch -l</code>, the result should be OpenContrail. <br/>
Bootstrap the environment via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju bootstrap --metadata-source ~/.juju/metadata --upload-tools -v --show-log --constraints="mem=3G"
</span></code></pre></td></tr></table></div></figure>


<p>
Use <code>juju show-log</code> will display the logs for juju.</p>

<p>Deploy from local repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export JUJU_REPOSITORY=/home/Trusty/Code/deployOpenContrail/contrail-deployer/charms
</span><span class='line'>$ juju deploy --to 0 juju-gui
</span><span class='line'>$ juju deploy --to lxc:0 mysql
</span><span class='line'>$ juju deploy --to lxc:0 keystone
</span><span class='line'>$ juju deploy --to lxc:0 nova-cloud-controller
</span><span class='line'>$ juju deploy --to lxc:0 glance
</span><span class='line'>$ juju deploy --to lxc:0 rabbitmq-server
</span><span class='line'>$ juju deploy --to lxc:0 openstack-Trustyboard
</span><span class='line'>$ juju deploy --to lxc:0 cinder 
</span><span class='line'>$ juju deploy --to lxc:0 neutron-api
</span><span class='line'>$ juju deploy --to lxc:0 quantum-gateway
</span></code></pre></td></tr></table></div></figure>


<h3>HomeWorking</h3>

<p>First I created the local charm repository, and then start deploying.   <br/>
Problem is lxc template download is too time-wasting, thus I have to manually download the images and let it run as if the cache image is available.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@MassOpenContrail2:/var/cache/lxc/cloud-trusty# du -hs *
</span><span class='line'>178M    ubuntu-14.04-server-cloudimg-amd64-root.tar.gz
</span><span class='line'>root@MassOpenContrail2:/var/cache/lxc/cloud-trusty# pwd
</span><span class='line'>/var/cache/lxc/cloud-trusty
</span></code></pre></td></tr></table></div></figure>


<p>Use local repository for deploying other version&rsquo;s container, then run a cassandra:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>juju deploy --to lxc:0 --repository=/home/Trusty/Code/deployOpenContrail/contrail-deployer/src/charms local:precise/cassandra
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/23/deploy-local-service-using-juju/">Deploy Local Service Using Juju</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-23T09:11:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>9:11 am</span></time>
        
         | <a href="/blog/2015/03/23/deploy-local-service-using-juju/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since the OpenContrail deploy is using local deployment, that means, directly deploy to local machine. But the lab lack of the environment of the local ubuntu based machine, so I want to deploy a service to local first, then transform the whole project from local deployment to MAAS deployment. <br/>
In a Ubuntu14.04 machine, do following steps.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo add-apt-repository ppa:juju/stable 
</span><span class='line'>$ sudo vim /etc/apt/source.list
</span><span class='line'># This is for juju
</span><span class='line'>deb http://ppa.launchpad.net/juju/stable/ubuntu trusty main 
</span><span class='line'>deb-src http://ppa.launchpad.net/juju/stable/ubuntu trusty main 
</span><span class='line'>$ sudo apt-get install juju juju-core juju-local juju-quickstart
</span><span class='line'>$ sudo apt-get install charm-tools
</span><span class='line'>$ sudo apt-get install uvtool-libvirt uvtool
</span></code></pre></td></tr></table></div></figure>


<p>Configure the juju for using local:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/juju/plugins.git ~/.juju-plugins
</span><span class='line'>$ vim ~/.zshrc
</span><span class='line'># Add juju_plugins to global path
</span><span class='line'>PATH=$PATH:$HOME/.juju-plugin
</span><span class='line'>$ source ~/.zshrc
</span><span class='line'>$ juju init
</span><span class='line'>$ vim ~/.juju/environments.yaml
</span><span class='line'>local:
</span><span class='line'> type: local
</span><span class='line'>
</span><span class='line'> # &lt;Commented Section&gt;
</span><span class='line'>
</span><span class='line'> # The default series to deploy the state-server and charms on.
</span><span class='line'> #
</span><span class='line'> default-series: precise
</span><span class='line'> #
</span><span class='line'> ## ** add these lines to support KVM and LXC deployment **
</span><span class='line'> lxc-use-clone: true
</span><span class='line'> container: kvm
</span></code></pre></td></tr></table></div></figure>


<p>Start the machine via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju bootstrap --debug
</span></code></pre></td></tr></table></div></figure>


<p>Add the machines via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Trusty@~]$  juju set-constraints mem=512M
</span><span class='line'>[Trusty@~]$  juju add-machine --constraints "root-disk=16G mem=1G"
</span><span class='line'>created machine 1
</span><span class='line'>[Trusty@~]$ juju status
</span><span class='line'>environment: local
</span><span class='line'>machines:
</span><span class='line'>  "0":
</span><span class='line'>    agent-state: started
</span><span class='line'>    agent-version: 1.21.3.1
</span><span class='line'>    dns-name: localhost
</span><span class='line'>    instance-id: localhost
</span><span class='line'>    series: trusty
</span><span class='line'>    state-server-member-status: has-vote
</span><span class='line'>  "1":
</span><span class='line'>    instance-id: pending
</span><span class='line'>    series: precise
</span><span class='line'>services: {}
</span></code></pre></td></tr></table></div></figure>


<p>After a long wait, it will boot a machine which have 1G and 1 Core, and let it running.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/19/deploy-maas-10/">Deploy MAAS(10)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-19T10:17:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:17 am</span></time>
        
         | <a href="/blog/2015/03/19/deploy-maas-10/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Continue to deploy OpenContrail based on OpenStack.    <br/>
First we install the bzr for fetching back the charms:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install bzr
</span></code></pre></td></tr></table></div></figure>


<p>Clone the repository to local Mass Controller Machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bzr branch lp:~robert-ayres/+junk/contrail-deployer
</span></code></pre></td></tr></table></div></figure>


<p>Install juju-deployer for deploying:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install juju-deployer
</span></code></pre></td></tr></table></div></figure>


<p>Change the memory size.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/18/migration-of-opencontril/">Migration of OpenContril</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-18T11:38:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:38 am</span></time>
        
         | <a href="/blog/2015/03/18/migration-of-opencontril/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This article is not for opencontril itself, but for migration of the existing environment to local machines.</p>

<h3>Environment</h3>

<p>Machine configuration is listed as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.10.233 u12-control
</span><span class='line'>192.168.10.234 u12-compute1
</span><span class='line'>192.168.10.235 u12-compute2
</span><span class='line'>
</span><span class='line'>192.168.1.79   s179
</span></code></pre></td></tr></table></div></figure>


<p>The control node and 2 compute nodes are running in machine s179, the tasks for me to do is for moving them from s179 to 2 physical machine.</p>

<h3>Use Remote KVM Server</h3>

<p>First we copy our ssh-key to the remote s179 machine, so next time we won&rsquo;t enter any passwd for accessing the remote libvirtd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh-copy-id root@192.168.1.79
</span></code></pre></td></tr></table></div></figure>


<p>In our own machine, we listed remote&rsquo;s machines via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virsh -c qemu+ssh://root@192.168.1.79/system list --all
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> 14    u14-ui                         running
</span><span class='line'> 16    u14-compute2                   running
</span><span class='line'> 22    u14-compute1                   running
</span><span class='line'> 39    de1-contro                     running
</span><span class='line'> -     centos6.4-management-01        shut off
</span><span class='line'> -     centos6.4-management-02        shut off
</span></code></pre></td></tr></table></div></figure>


<p>Add connection via: <code>File-&gt; Add New Connection</code>, then configure like following:   <br/>
<img src="/images/2015_03_18_11_53_11_380x432.jpg" alt="/images/2015_03_18_11_53_11_380x432.jpg" /></p>

<h3>Migration(Static)</h3>

<p>First scp the image file to to destination machine, this will take a while. <br/>
Dump the xml via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virsh dumpxml xxxxx&gt;xxxx.xml
</span></code></pre></td></tr></table></div></figure>


<p>Scp the xml file to destination machine and move to <code>/etc/libvirt/qemu/</code>, change the priviledge of the file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo chmod 777 /home/clouder/iso/Ubuntu1404-Newly-Installed-with-Update.img
</span></code></pre></td></tr></table></div></figure>


<p>   <br/>
Edit the corresponding configuration in the xml file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/libvirt/qemu/xxxx.xml
</span><span class='line'>.....
</span><span class='line'>&lt;source file='/home/clouder/iso/Ubuntu1404-Newly-Installed-with-Update.img'/&gt;
</span><span class='line'>.....
</span></code></pre></td></tr></table></div></figure>


<p>Define the xml under the <code>/etc/libvirt/qemu/</code> folder:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@pc121:/etc/libvirt/qemu# virsh define ./Ubuntu1404-Newly-Installed-with-Update.xml 
</span><span class='line'>Domain Ubuntu1404-Newly-Installed-with-Update defined from ./Ubuntu1404-Newly-Installed-with-Update.xml
</span></code></pre></td></tr></table></div></figure>


<p>Install the guest tool and use it for editing the virtual machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install libguestfs-tools
</span><span class='line'>$ sudo virt-edit -d Ubuntu1404-Newly-Installed-with-Update /etc/network/interfaces
</span></code></pre></td></tr></table></div></figure>


<p>After change the network configuration, we could start the machine via <code>virsh start Ubuntu1404-Newly-Installed-with-Update</code>, it will have the newly edited ip address.</p>

<p>If we use different host machine, then change the following definition in xml file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /etc/libvirt/qemu/xxxx.xml
</span><span class='line'>&lt;devices&gt;
</span><span class='line'>    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
</span><span class='line'>.......
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/17/deploy-maas-9/">Deploy MAAS(9)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-17T17:44:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:44 pm</span></time>
        
         | <a href="/blog/2015/03/17/deploy-maas-9/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Use Local Charms</h3>

<p>Retrieve the charms via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install charm-tools
</span><span class='line'>$ cat autocharms.sh
</span><span class='line'>juju charm get nova-cloud-controller /home/Trusty/charms/trusty
</span><span class='line'>juju charm get keystone /home/Trusty/charms/trusty
</span><span class='line'>juju charm get glance  /home/Trusty/charms/trusty
</span><span class='line'>juju charm get cinder /home/Trusty/charms/trusty
</span><span class='line'>juju charm get rabbitmq-server /home/Trusty/charms/trusty
</span><span class='line'>juju charm get openstack-Trustyboard /home/Trusty/charms/trusty
</span><span class='line'>juju charm get nova-compute /home/Trusty/charms/trusty
</span><span class='line'># juju charm get nova-compute /home/Trusty/charms/trusty
</span><span class='line'>$ du -hs /home/Trusty/charms/trusty/*
</span><span class='line'>1.5M    /home/Trusty/charms/trusty/cinder
</span><span class='line'>1.6M    /home/Trusty/charms/trusty/glance
</span><span class='line'>1.7M    /home/Trusty/charms/trusty/keystone
</span><span class='line'>824K    /home/Trusty/charms/trusty/mysql
</span><span class='line'>1.9M    /home/Trusty/charms/trusty/nova-cloud-controller
</span><span class='line'>1.6M    /home/Trusty/charms/trusty/nova-compute
</span><span class='line'>1.2M    /home/Trusty/charms/trusty/openstack-Trustyboard
</span><span class='line'>1.2M    /home/Trusty/charms/trusty/rabbitmq-server
</span></code></pre></td></tr></table></div></figure>


<p>Deploy via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>juju deploy --to lxc:1 --repository=/home/Trusty/charms/ local:trusty/mysql
</span><span class='line'>juju deploy --to lxc:1 --repository=/home/Trusty/charms/ local:trusty/keystone
</span><span class='line'>juju deploy --to lxc:1 --repository=/home/Trusty/charms/ local:trusty/nova-cloud-controller
</span><span class='line'>juju deploy --to lxc:1 --repository=/home/Trusty/charms/ local:trusty/glance
</span><span class='line'>juju deploy --to lxc:1 --repository=/home/Trusty/charms/ local:trusty/rabbitmq-server
</span><span class='line'>juju deploy --to lxc:1 --repository=/home/Trusty/charms/ local:trusty/openstack-Trustyboard
</span><span class='line'>juju deploy --to lxc:1 --repository=/home/Trusty/charms/ local:trusty/cinder 
</span></code></pre></td></tr></table></div></figure>


<h3>Backup</h3>

<p>Backup the existing environment via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju backup create --filename backupOpenStack.tgz
</span><span class='line'>$ ls -l *.tgz
</span><span class='line'>-rw-r--r-- 1 Trusty Trusty  25595066 Mar 17 17:23 juju-backup-20150317-1723.tgz
</span></code></pre></td></tr></table></div></figure>


<p>The store method will be covered later.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/17/deploy-maas-8/">Deploy MAAS(8)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-17T14:27:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:27 pm</span></time>
        
         | <a href="/blog/2015/03/17/deploy-maas-8/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This part is for deploying OpenStack using Juju and let it run in single node.</p>

<h3>Environment Preparation</h3>

<p>2 virtual machines created using virt-manager, each of them has 2 core, 3Gigabyte Memory, around 60G Disk space.</p>

<h3>Deploy</h3>

<p>The most of the nodes are deployed in container.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju deploy --to 0 juju-gui
</span><span class='line'>$ juju deploy --to lxc:0 mysql
</span><span class='line'>$ juju deploy --to lxc:0 keystone
</span><span class='line'>$ juju deploy --to lxc:0 nova-cloud-controller
</span><span class='line'>$ juju deploy --to lxc:0 glance
</span><span class='line'>$ juju deploy --to lxc:0 rabbitmq-server
</span><span class='line'>$ juju deploy --to lxc:0 openstack-Trustyboard
</span><span class='line'>$ juju deploy --to lxc:0 cinder 
</span></code></pre></td></tr></table></div></figure>


<p>The compute node is deployed in a machine which enable the nested virtualization.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju deploy nova-compute
</span></code></pre></td></tr></table></div></figure>


<p>Add each other&rsquo;s relationship:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju add-relation mysql keystone
</span><span class='line'>$ juju add-relation nova-cloud-controller mysql
</span><span class='line'>$ juju add-relation nova-cloud-controller rabbitmq-server
</span><span class='line'>$ juju add-relation nova-cloud-controller glance
</span><span class='line'>$ juju add-relation nova-cloud-controller keystone
</span><span class='line'>$ juju add-relation nova-compute nova-cloud-controller
</span><span class='line'>$ juju add-relation nova-compute mysql
</span><span class='line'>$ juju add-relation nova-compute rabbitmq-server:amqp
</span><span class='line'>$ juju add-relation nova-compute glance
</span><span class='line'>$ juju add-relation glance mysql
</span><span class='line'>$ juju add-relation glance keystone
</span><span class='line'>$ juju add-relation glance cinder
</span><span class='line'>$ juju add-relation mysql cinder
</span><span class='line'>$ juju add-relation cinder rabbitmq-server
</span><span class='line'>$ juju add-relation cinder nova-cloud-controller
</span><span class='line'>$ juju add-relation cinder keystone
</span><span class='line'>$ juju add-relation openstack-Trustyboard keystone
</span></code></pre></td></tr></table></div></figure>


<p>Then change the password of keystone via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju set keystone admin-password="helloworld"
</span></code></pre></td></tr></table></div></figure>


<p>Detect the ipaddress of the openstack-Trustyboards via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju status openstack-Trustyboard
</span><span class='line'>$ http://ip_address_of_Trustyboard/horizon
</span></code></pre></td></tr></table></div></figure>


<p>The final result is listed like:  <br/>
<img src="/images/2015_03_17_14_35_25_1037x646.jpg" alt="/images/2015_03_17_14_35_25_1037x646.jpg" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/17/deploy-maas-7/">Deploy MAAS(7)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-17T09:55:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:55 am</span></time>
        
         | <a href="/blog/2015/03/17/deploy-maas-7/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This will record the complete steps for deploying MAAS in a newly installed machine.</p>

<h3>Installation</h3>

<p>The start point should be at Ubuntu14.04.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo add-apt-repository  ppa:maas-maintainers/maas-test
</span><span class='line'>$ sudo vim /etc/apt/sources.list
</span><span class='line'># Add maas repository
</span><span class='line'>deb http://ppa.launchpad.net/maas-maintainers/testing/ubuntu trusty main
</span><span class='line'>deb-src http://ppa.launchpad.net/maas-maintainers/testing/ubuntu trusty main
</span><span class='line'>$ sudo add-apt-repository ppa:juju/stable
</span><span class='line'>$ sudo vim /etc/apt/sources.list
</span><span class='line'># Add juju repository
</span><span class='line'>deb http://ppa.launchpad.net/juju/stable/ubuntu trusty main 
</span><span class='line'>deb-src http://ppa.launchpad.net/juju/stable/ubuntu trusty main 
</span><span class='line'>$ sudo apt-get update && sudo apt-get upgrade
</span><span class='line'>$ sudo apt-get install maas-test maas-dhcp maas-dns juju juju-core juju-local juju-quickstart firefox git
</span></code></pre></td></tr></table></div></figure>


<p>Tips: for enable the vncserver on Ubuntu, do following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install tightvncserver lxde
</span><span class='line'>$ vncserver
</span><span class='line'>$ vim ~/.vnc/xstartup
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>xrdb $HOME/.Xresources
</span><span class='line'>xsetroot -solid grey
</span><span class='line'>#x-terminal-emulator -geometry 80x24+10+10 -ls -title "$VNCDESKTOP Desktop" &
</span><span class='line'>#x-window-manager &
</span><span class='line'># Fix to make GNOME work
</span><span class='line'>export XKL_XMODMAP_DISABLE=1
</span><span class='line'># /etc/X11/Xsession
</span><span class='line'>startlxde &
</span><span class='line'>$ vncserver -kill :1 && vncserver
</span></code></pre></td></tr></table></div></figure>


<p>The MAAS Controller relies on a google&rsquo;s theme which is blocked by GFW, so we have to use proxychains for acrossing it, please notice these operation could be done on host machine, or Maas Controller itself..</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/rofl0r/proxychains-ng.git 
</span><span class='line'>$ ./configure --prefix=/usr && make && make install
</span><span class='line'>$ sudo cp src/proxychain4.conf /etc
</span><span class='line'>$ sudo vim /etc/proxychains4.conf
</span><span class='line'>$ sudo apt-get install midori
</span><span class='line'>$ proxychains4 midori 10.17.17.202/MAAS
</span></code></pre></td></tr></table></div></figure>


<p>Configure the MAAS Controller via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo maas-region-admin createadmin
</span><span class='line'>[sudo] password for Trusty: 
</span><span class='line'>Username: root
</span><span class='line'>Password: 
</span><span class='line'>Again: 
</span><span class='line'>Email: root@localhost
</span></code></pre></td></tr></table></div></figure>


<p>This enabled the admin username/password, refresh the <code>10.17.17.202/MAAS</code> you could login to the MAAS Controller.</p>

<h3>Configuration</h3>

<h4>Image Configuration</h4>

<p>First download the images fromt the official repository via(On MaasController):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install simplestreams ubuntu-cloudimage-keyring apache2
</span><span class='line'>$ sudo bash
</span><span class='line'># proxychains4 sstream-mirror --keyring=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg http://maas.ubuntu.com/images/ephemeral-v2/daily/ /var/www/html/maas/images/ephemeral-v2/daily 'arch=amd64' 'subarch~(generic|hwe-t)' 'release~(trusty|precise)' --max=1
</span><span class='line'>^C
</span><span class='line'>$ pwd
</span><span class='line'>/var/www/html/maas/images
</span><span class='line'>$ sudo mv ephemeral-v2/ ephemeral-v2.back
</span><span class='line'>[sudo] password for Trusty: 
</span><span class='line'>$ sudo tar xjf /home/Trusty/ephemeral-v2.tar.bz2 -C ./
</span></code></pre></td></tr></table></div></figure>


<p>Then Change the configuration in browser of opened <code>http://10.17.17.202/MAAS</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Click Configuration Button, and update the Ubuntu -&gt; Main archive (required) from: 
</span><span class='line'>http://archive.ubuntu.com/ubuntu 
</span><span class='line'>to: 
</span><span class='line'>http://mirrors.aliyun.com/ubuntu/ 
</span><span class='line'>This repository enable the installed system for retrieving the install packages, use aliyun we could get much more faster speed.
</span><span class='line'>
</span><span class='line'>Change the Boot Images -&gt; Sync URL (required) from: 
</span><span class='line'>http://maas.ubuntu.com/images/ephemeral-v2/releases/ 
</span><span class='line'>to 
</span><span class='line'>http://10.17.17.202/maas/images/ephemeral-v2/daily/ 
</span><span class='line'>This will enable the Boot Images Sync URLs, use local repository will greatly improve the bootup speed.
</span></code></pre></td></tr></table></div></figure>


<h4>Network Configuration</h4>

<p>Since the midori&rsquo;s effect is not good, install qupzilla:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install qupzilla
</span><span class='line'>$ proxychains4 quazilla http://10.17.17.202/MAAS
</span></code></pre></td></tr></table></div></figure>


<p>Under <code>Cluster-&gt;Interfaces-&gt;eth0-&gt;Edit</code>, change it to <code>Management(DNS and DHCP)</code>, and then modify following items:  <br/>
<img src="/images/2015_03_17_11_17_28_411x358.jpg" alt="/images/2015_03_17_11_17_28_411x358.jpg" /></p>

<p>MAAS ssh key should be generated via following steps:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Trusty@MassController:~$ sudo mkdir /home/maas
</span><span class='line'>[sudo] password for Trusty: 
</span><span class='line'>Trusty@MassController:~$ sudo chown maas:maas /home/maas/
</span><span class='line'>Trusty@MassController:~$ sudo chsh maas
</span><span class='line'>Changing the login shell for maas
</span><span class='line'>Enter the new value, or press ENTER for the default
</span><span class='line'>        Login Shell [/bin/false]: /bin/bash
</span><span class='line'>Trusty@MassController:~$ sudo su - maas
</span><span class='line'>maas@MassController:~$ ssh-keygen 
</span><span class='line'>Generating public/private rsa key pair.
</span></code></pre></td></tr></table></div></figure>


<p>
Copy the generated key to <a href="http://10.17.17.202/MAAS/account/prefs/sshkey/add/">http://10.17.17.202/MAAS/account/prefs/sshkey/add/</a>    And remember the api-key, for later we will use it for generating nodes information.   <br/>
Enable the remote control of your host&rsquo;s libvirt:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install libvirt-bin
</span><span class='line'>maas@MassController:~$ ssh-copy-id root@10.17.17.1
</span><span class='line'>maas@MassController:~$ virsh -c qemu+ssh://root@10.17.17.1/system list  --all
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> 2     MaasController                 running
</span><span class='line'> -     Ubuntu1404Maas                 shut off
</span><span class='line'> -     Ubuntu203                      shut off
</span></code></pre></td></tr></table></div></figure>


<p>Also we have to configure the network under <a href="http://10.17.17.202/MAAS/networks/maas-eth0/edit/">http://10.17.17.202/MAAS/networks/maas-eth0/edit/</a>:  <br/>
<img src="/images/2015_03_17_11_34_31_478x283.jpg" alt="/images/2015_03_17_11_34_31_478x283.jpg" /></p>

<p>Also we should manually edit the MaasController&rsquo;s network configuration via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/network/interfaces
</span><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'># The primary network interface
</span><span class='line'>auto eth0
</span><span class='line'># iface eth0 inet dhcp
</span><span class='line'>iface eth0 inet static                                                                                                                        
</span><span class='line'>        address 10.17.17.202                                                                                                                  
</span><span class='line'>        netmask 255.255.255.0                                                                                                                 
</span><span class='line'>        network 10.17.17.0                                                                                                                    
</span><span class='line'>        broadcast 10.17.17.255                                                                                                                
</span><span class='line'>        gateway 10.17.17.1                                                                                                                    
</span><span class='line'>        # dns-* options are implemented by the resolvconf package, if installed                                                               
</span><span class='line'>        dns-nameservers 114.114.114.114 127.0.0.1 10.17.17.202
</span></code></pre></td></tr></table></div></figure>


<p>Restart and the network configuration is OK, notice only we set 127.0.0.1 as the dns server, we could enable the local FQDN.</p>

<h3>Add Nodes</h3>

<p>Create the vm in virt-manager, its start-up is via PXE, and with 3G Mem, 60G space, 2-Core which copies the Host CPU.  <br/>
Then in browser edit like following:   <br/>
<img src="/images/2015_03_17_11_47_59_511x576.jpg" alt="/images/2015_03_17_11_47_59_511x576.jpg" />  <br/>
Then in the <code>Nodes</code>, select the node, and commision selected node.After commission, the status will be changed to ready. <br/>
<img src="/images/2015_03_17_11_54_29_589x157.jpg" alt="/images/2015_03_17_11_54_29_589x157.jpg" /></p>

<h3>Juju Configuration</h3>

<p>Use following command for quickstart juju:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju-quickstart -i
</span></code></pre></td></tr></table></div></figure>


<p>The configuration image is listed as:  <br/>
<img src="/images/2015_03_17_11_57_47_559x457.jpg" alt="/images/2015_03_17_11_57_47_559x457.jpg" /></p>

<p>Generate the local tools:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir .juju/metadata
</span><span class='line'>Trusty@MassController:~$ juju metadata generate-tools -d ~/.juju/metadata
</span></code></pre></td></tr></table></div></figure>


<p>Then start the node via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju bootstrap --metadata-source ~/.juju/metadata --upload-tools -v --show-log --constraints="mem=3G"
</span></code></pre></td></tr></table></div></figure>


<p>After it success, the juju and MAAS environment is ready for use.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/16/deploy-maas-6/">Deploy MAAS(6)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-16T17:43:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:43 pm</span></time>
        
         | <a href="/blog/2015/03/16/deploy-maas-6/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>More Nodes</h3>

<p>I imported 2 3-G mem size nodes. 2 Nodes were created manually.  <br/>
First we should set the constraint via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju bootstrap --metadata-source ~/.juju/metadata --upload-tools -v --show-log --constraints="mem=3G"
</span></code></pre></td></tr></table></div></figure>


<p>   <br/>
Then we can verify and imported these machines via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju get-constraints
</span><span class='line'>$ juju add-machine
</span><span class='line'>$ juju status
</span><span class='line'>$ juju deploy --to 1 mysql
</span></code></pre></td></tr></table></div></figure>


<h3>Deploy OpenStack</h3>

<p>In first node, do following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju deploy --to 0 juju-gui
</span><span class='line'>$ juju deploy --to lxc:0 mysql && juju deploy --to lxc:0 keystone && juju deploy --to lxc:0 nova-cloud-controller && juju deploy --to lxc:0 glance && juju deploy --to lxc:0 rabbitmq-server && juju deploy --to lxc:0 openstack-Trustyboard && juju deploy --to lxc:0 cinder
</span></code></pre></td></tr></table></div></figure>


<p>Then deploy the nova-compute node via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ juju deploy nova-compute
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/8">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/6">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/18/use-virtualenv-for-downloading-pip-packages/">Use VirtualEnv for Downloading PIP Packages</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/18/wh-worktips-3/">WH Worktips(3)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/18/wh-worktips-2/">WH Worktips(2)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/17/wh-worktips-1/">WH Worktips(1)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/16/xenserver-tips/">XenServer Tips</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
