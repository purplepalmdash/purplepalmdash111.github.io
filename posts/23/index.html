
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="Background I tried to use 192.168.1 network for debugging, but after I change back from 10.0.0. to 192.168.1. the router got no interface for luci &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/posts/23">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//fonts.googleapis.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/12/recover-my-openwrt-configuration/">Recover My OpenWRT Configuration</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-12T10:00:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:00 am</span></time>
        
         | <a href="/blog/2014/12/12/recover-my-openwrt-configuration/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Background</h3>

<p>I tried to use <code>192.168.1</code> network for debugging, but after I change back from <code>10.0.0.</code> to <code>192.168.1.</code> the router got no interface for luci and http. So following is the steps for recovering from the fail router.</p>

<h3>Solution</h3>

<p>First I tried to recover the luci and uhttpd, but after a while I think maybe I could swith to a newer version.  <br/>
The newest version currently is &ldquo; &lsquo;Barrier Breaker&rsquo; &rdquo;, its version number is 14.07.  <br/>
My router is Mercury 4530R, which have the following configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CPU  Ram Flash   Network USB Serial  JTag    
</span><span class='line'>Atheros   128MiB  8MiB    4LAN + 2WIFI    Yes Yes ?    
</span></code></pre></td></tr></table></div></figure>


<p>LUCI upgrade failed:  <br/>
<img src="/images/flasherror.jpg" alt="/images/flasherror.jpg" /></p>

<p>The reason:  <br/>
<img src="/images/flasherrorreason.jpg" alt="/images/flasherrorreason.jpg" /></p>

<p>Because in early 2012 Autumn, the official supporting for 4530R is not release, so we modified the machineID, to let 4530R to use TP-Link&rsquo;s patched images, this will display our system as for 4310, but not for 4530R.</p>

<h4>Sysupgrade in CLI</h4>

<p>First check the free memory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@OpenWrt:~# free
</span><span class='line'>             total         used         free       shared      buffers
</span><span class='line'>Mem:        126788        26636       100152            0         1780
</span><span class='line'>-/+ buffers:              24856       101932
</span><span class='line'>Swap:            0            0            0
</span></code></pre></td></tr></table></div></figure>


<p>Download the sysupgrade file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /tmp
</span><span class='line'># wget http://downloads.openwrt.org/barrier_breaker/14.07/ar71xx/generic/openwrt-ar71xx-generic-mw4530r-v1-squashfs-sysupgrade.bin
</span><span class='line'># ls -l openwrt-ar71xx-generic-mw4530r-v1-squashfs-sysupgrade.bin 
</span><span class='line'>-rw-r--r--    1 root     root       3342340 Jun 22 17:28 openwrt-ar71xx-generic-mw4530r-v1-squashfs-sysupgrade.bin
</span></code></pre></td></tr></table></div></figure>


<p>Problem when checking:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># sysupgrade -v openwrt-ar71xx-generic-mw4530r-v1-squashfs-sysupgrade.bin 
</span><span class='line'>Invalid image, hardware ID mismatch, hw:43100001 image:45300001.
</span><span class='line'>Image check 'platform_check_image' failed.
</span></code></pre></td></tr></table></div></figure>


<p>
Ignore the Image check:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@OpenWrt:/tmp# sysupgrade -F openwrt-ar71xx-generic-mw4530r-v1-squashfs-sysupgrade.bin 
</span><span class='line'>Invalid image, hardware ID mismatch, hw:43100001 image:45300001.
</span><span class='line'>Image check 'platform_check_image' failed but --force given - will update anyway!
</span><span class='line'>Saving config files...
</span><span class='line'>Sending TERM to remaining processes ... uhttpd dnsmasq smbd nmbd ntpd hotplug2 syslogd klogd hotplug2 ubusd netifd 
</span><span class='line'>Sending KILL to remaining processes ... uhttpd 
</span><span class='line'>Switching to ramdisk...
</span><span class='line'>Performing system upgrade...
</span><span class='line'>Unlocking firmware ...
</span><span class='line'>
</span><span class='line'>Writing from &lt;stdin&gt; to firmware ...     
</span><span class='line'>Appending jffs2 data from /tmp/sysupgrade.tgz to firmware...TRX header not found
</span><span class='line'>Error fixing up TRX header
</span><span class='line'>    
</span><span class='line'>Upgrade completed
</span><span class='line'>Rebooting system...
</span></code></pre></td></tr></table></div></figure>


<p>After a while, your router is flashed to the new system.</p>

<h4>More Happily Play with FlashDisk</h4>

<p>Cause 8M Flash is not enough for playing lots of things, I plug-in a 2G FlashDisk into the usb port as the external disk.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh root@192.168.1.1
</span><span class='line'>root@OpenWrt:~# export http_proxy=http://1xx.xx.xxx.xxx:2xxxx
</span><span class='line'>root@OpenWrt:~# df -h
</span><span class='line'>Filesystem                Size      Used Available Use% Mounted on
</span><span class='line'>rootfs                    4.6M    292.0K      4.3M   6% /
</span><span class='line'>/dev/root                 2.3M      2.3M         0 100% /rom
</span><span class='line'>tmpfs                    61.7M    588.0K     61.1M   1% /tmp
</span><span class='line'>/dev/mtdblock3            4.6M    292.0K      4.3M   6% /overlay
</span><span class='line'>overlayfs:/overlay        4.6M    292.0K      4.3M   6% /
</span><span class='line'>tmpfs                   512.0K         0    512.0K   0% /dev
</span><span class='line'>root@OpenWrt:~# opkg update
</span><span class='line'>......
</span><span class='line'>root@OpenWrt:~# opkg install block-mount kmod-usb-storage fdisk kmod-fs-ext4 kmod-usb-storage-extras kmod-scsi-generic
</span><span class='line'>......
</span><span class='line'>root@OpenWrt:~# df -h
</span><span class='line'>Filesystem                Size      Used Available Use% Mounted on
</span><span class='line'>rootfs                    4.6M    836.0K      3.8M  18% /
</span></code></pre></td></tr></table></div></figure>


<p>Now format the flash-disk and plug it into the usb port. Reboot the router and now via <code>fdisk -l</code> you will see the plugged-in flashdisk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Device    Boot Start       End  Blocks  Id System
</span><span class='line'>/dev/sda1       2048   3948543 1973248  83 Linux
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>Transfer Filesystem to External Disk</h4>

<p>The steps is listed as: <br/>
pivot overlay:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@OpenWrt:~# mkdir /mnt/sda1
</span><span class='line'>root@OpenWrt:~# mount /dev/sda1 /mnt/sda1/
</span><span class='line'>root@OpenWrt:~# tar -C /overlay -cvf - . | tar -C /mnt/sda1 -xf -
</span><span class='line'>root@OpenWrt:~# ls /mnt/sda1/
</span><span class='line'>etc         lib         lost+found  mnt         sbin        usr
</span></code></pre></td></tr></table></div></figure>


<p>pivot root:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p /tmp/cproot
</span><span class='line'>mount --bind / /tmp/cproot
</span><span class='line'>tar -C /tmp/cproot -cvf - . | tar -C /mnt/sda1 -xf -
</span><span class='line'>umount /tmp/cproot
</span></code></pre></td></tr></table></div></figure>


<p>Configuration file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ block detect
</span><span class='line'>config 'mount'
</span><span class='line'>        option  target  '/mnt/sda1'
</span><span class='line'>        option  uuid    'f6857dac-a12a-49c9-b567-f05a61100bd7'
</span><span class='line'>        option  enabled '0'
</span><span class='line'>
</span><span class='line'>$ cat /etc/config/fstab
</span><span class='line'>config global
</span><span class='line'>        option anon_swap '0'
</span><span class='line'>        option anon_mount '0'
</span><span class='line'>        option auto_swap '1'
</span><span class='line'>        option auto_mount '1'
</span><span class='line'>        option delay_root '5'
</span><span class='line'>        option check_fs '0'
</span><span class='line'>
</span><span class='line'>config mount
</span><span class='line'>        option target '/overlay'
</span><span class='line'>        option  uuid    'f6857dac-a12a-49c9-b567-f05a61100bd7'
</span><span class='line'>        option enabled '1'
</span><span class='line'>        option fstype 'ext4'
</span></code></pre></td></tr></table></div></figure>


<p>Now reboot the router and you got a 2G based storage router:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@OpenWrt:~# df -h
</span><span class='line'>Filesystem                Size      Used Available Use% Mounted on
</span><span class='line'>rootfs                    1.8G     12.6M      1.7G   1% /
</span></code></pre></td></tr></table></div></figure>


<p>You could play happily in this router.  <br/>
<img src="/images/4530Rrouter.jpg" alt="/images/4530Rrouter.jpg" /></p>

<h3>Further Optimization</h3>

<p>Includes:  <br/>
1. Fixed ip address configurations.   <br/>
2. Port forwarding. Router-> Port Forwarding.  <br/>
3. SSH Server Replacement, from dropbear to opensshd.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># opkg update
</span><span class='line'># opkg install openssh-server
</span><span class='line'># uci set dropbear.@dropbear[0].Port=2222
</span><span class='line'># uci commit dropbear
</span><span class='line'># /etc/init.d/dropbear restart
</span><span class='line'># /etc/init.d/sshd enable
</span><span class='line'># /etc/init.d/sshd start
</span><span class='line'># /etc/init.d/dropbear disable
</span><span class='line'># /etc/init.d/dropbear stop
</span><span class='line'># ssh-keygen
</span><span class='line'># opkg install openssh-client
</span></code></pre></td></tr></table></div></figure>


<p>4. Time sync.    <br/>
With the previous installed sshd, you could add yourself to remote server&rsquo;s trusted users. then add files of <code>time.sh</code> for syncing time. <br/>
Refers to local link <code>/blog/2014/02/11/write-local-ntp-sync-server/</code>  <br/>
5. Sharing the mouse between Yosemite and ArchLinux, change the configuration files.</p>

<p>Finally we got all of these done:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@OpenWrt:~/.ssh# uptime
</span><span class='line'> 12:45:31 up 6 min,  load average: 0.22, 0.14, 0.06
</span><span class='line'>root@OpenWrt:~/.ssh# date
</span><span class='line'>Fri Dec 12 12:45:33 CST 2014
</span><span class='line'>root@OpenWrt:~/.ssh# uname -a
</span><span class='line'>Linux OpenWrt 3.10.49 #3 Wed Oct 1 14:00:51 CEST 2014 mips GNU/Linux
</span></code></pre></td></tr></table></div></figure>


<p>Enable ssh WAN access:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>uci add firewall rule
</span><span class='line'>uci set firewall.@rule[-1].src=wan
</span><span class='line'>uci set firewall.@rule[-1].target=ACCEPT
</span><span class='line'>uci set firewall.@rule[-1].proto=tcp
</span><span class='line'>uci set firewall.@rule[-1].dest_port=22
</span><span class='line'>uci commit firewall
</span><span class='line'>/etc/init.d/firewall restart
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/11/ba-wan-panamax/">把玩Panamax</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-11T14:14:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:14 pm</span></time>
        
         | <a href="/blog/2014/12/11/ba-wan-panamax/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>前提条件</h3>

<p>在MAC上把玩Panamax前，需要安装Virtualbox, Vagrant, 而后, 用下列命令安装Panamax:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew install http://download.panamax.io/installer/brew/panamax.rb
</span><span class='line'>$ panamax init
</span></code></pre></td></tr></table></div></figure>


<p>这将开始下载CoreOS镜像，需要等一段时间。</p>

<p>In fact the panamax could also be installed on ArchLinux rather than only in Ubuntu, simply run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://download.panamax.io/installer/ubuntu.sh | bash
</span></code></pre></td></tr></table></div></figure>


<h3>Trouble Shooting</h3>

<h4>Init failed</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ panamix init
</span><span class='line'>A different VM with name panamax-vm has been created already. Please re-install or delete panamax-vm VM and try again.
</span></code></pre></td></tr></table></div></figure>


<p>Use following command for listing all of the virtualmachines:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>VBoxManage list vms
</span></code></pre></td></tr></table></div></figure>


<p>Didn&rsquo;t found the panamax related infos.  <br/>
Finally solve the problem via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Trusty@~/.vagrant.d]$ pwd
</span><span class='line'>/home/Trusty/.vagrant.d
</span><span class='line'>[Trusty@~/.vagrant.d]$ mv plugins.json plugins.json.back
</span><span class='line'>[Trusty@~/.vagrant.d]$ mv gems gems.back
</span></code></pre></td></tr></table></div></figure>


<h4>Frozen String</h4>

<p>The error code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/opt/vagrant/embedded/gems/gems/vagrant-1.7.0/lib/vagrant/util/subprocess.rb:28:in `encode!': can't modify frozen String (RuntimeError)
</span></code></pre></td></tr></table></div></figure>


<p>Is it because I upgraded to the latest vagrant?</p>

<p>I couldnot roll back to vagrant1.6, so I upgraded to the vagrant-git, its version is 1.7.1, from the yaourt repository, thus I could get the installation continue.</p>

<h3>OpenSuse Way</h3>

<p>First remove the installed virtualbox:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ zypper remove virtualbox
</span><span class='line'>$ zypper in libvncserver0 LibVNCServer-devel
</span></code></pre></td></tr></table></div></figure>


<p>Install the 4.3 version of virtualbox:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget http://download.opensuse.org/repositories/home:/Warhammer40k:/stuff/openSUSE_13.1/x86_64/VirtualBox-custom-4.3-4.3.20-1.1.x86_64.rpm
</span><span class='line'>$ rpm -ivh VirtualBox-custom-4.3-4.3.20-1.1.x86_64.rpm
</span></code></pre></td></tr></table></div></figure>


<p>Now doing the same as we noticed above.   <br/>
But the <code>panamax init</code> got following error messages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>==&gt; panamax-vm: Clearing any previously set network interfaces...
</span><span class='line'>There was an error while executing `VBoxManage`, a CLI used by Vagrant
</span><span class='line'>for controlling VirtualBox. The command and stderr is shown below.
</span><span class='line'>
</span><span class='line'>Command: ["hostonlyif", "create"]
</span><span class='line'>
</span><span class='line'>Stderr: 0%...
</span><span class='line'>Progress state: NS_ERROR_FAILURE
</span><span class='line'>VBoxManage: error: Failed to create the host-only adapter
</span><span class='line'>VBoxManage: error: VBoxNetAdpCtl: Error while adding new interface: failed to open /dev/vboxnetctl: No such file or directory
</span><span class='line'>VBoxManage: error: Details: code NS_ERROR_FAILURE (0x80004005), component HostNetworkInterface, interface IHostNetworkInterface
</span><span class='line'>VBoxManage: error: Context: "int handleCreate(HandlerArg*, int, int*)" at line 66 of file VBoxManageHostonly.cpp
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/10/re-write-weatherapp/">Re-Write WeatherAPP</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-10T11:17:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:17 am</span></time>
        
         | <a href="/blog/2014/12/10/re-write-weatherapp/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Background</h3>

<h3>Building the Environment</h3>

<p>First clone the Vagrant Repo from:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pwd
</span><span class='line'>/media/y/Vagrant/CoreOS
</span><span class='line'>$ git clone https://github.com/coreos/coreos-vagrant.git
</span><span class='line'>$ cd coreos-vagrant
</span><span class='line'>$ cp config.rb.sample config.rb
</span><span class='line'>$ cp user-data.sample user-data
</span></code></pre></td></tr></table></div></figure>


<h4>Cluster Setting</h4>

<p>Edit the config.rb, for configurating the instance and the official CoreOS channel:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Size of the CoreOS cluster created by Vagrant
</span><span class='line'>$num_instances=3
</span><span class='line'># Official CoreOS channel from which updates should be downloaded
</span><span class='line'>$update_channel='stable'
</span></code></pre></td></tr></table></div></figure>


<p>Now start the vagrant and view its status:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant up
</span><span class='line'>$ vagrant status
</span><span class='line'>Current machine states:
</span><span class='line'>
</span><span class='line'>core-01                   running (virtualbox)
</span><span class='line'>core-02                   running (virtualbox)
</span><span class='line'>core-03                   running (virtualbox)
</span><span class='line'>$ vagrant ssh core-1
</span></code></pre></td></tr></table></div></figure>


<p>After you login to the coreOS, you could view the status of this virtual machine. Each of the machine have 1 Core, 1G ram, 20G harddisk.</p>

<h3>Single Machine</h3>

<p>Just comment the following lines of the config.rb:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># $num_instances=3
</span></code></pre></td></tr></table></div></figure>


<p>This will bring one instance of vagrant based CoreOS machine.</p>

<h3>NodeJS</h3>

<p>I want to write my APPs using NodeJS, thus I want to setup the NodeJS dev environment on CoreOS based Docker. Following are the steps:  <br/>
First configure the proxy of docker:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mkdir /etc/systemd/system/docker.service.d
</span><span class='line'>$ sudo vim http-proxy.conf
</span><span class='line'>[Service]
</span><span class='line'>Environment="HTTP_PROXY=http://proxy.example.com:8080"
</span><span class='line'>To apply the change, reload the unit and restart docker:
</span><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl restart docker
</span></code></pre></td></tr></table></div></figure>


<p>Now you could use docker for pulling back some container and run.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker search base
</span><span class='line'>$ docker pull base
</span><span class='line'>$ docker images
</span><span class='line'>$ docker run base /bin/bash -c "ls /"
</span><span class='line'>$ docker run base /bin/bash -c "cat /etc/issue"
</span></code></pre></td></tr></table></div></figure>


<p>
Since the network is not good, I created the droplet on DigitalOcean, and installed CoreOS.</p>

<h3>Dockerized</h3>

<p><a href="http://blogs.aws.amazon.com/application-management/post/Tx1ZLAHMVBEDCOC/Dockerizing-a-Python-Web-App">http://blogs.aws.amazon.com/application-management/post/Tx1ZLAHMVBEDCOC/Dockerizing-a-Python-Web-App</a>   <br/>
Steps is listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone git@github.com:awslabs/eb-py-flask-signup.git
</span><span class='line'>$ cd eb-py-flask-signup
</span><span class='line'>$ git checkout master
</span><span class='line'>$ vim Dockerfile
</span><span class='line'>FROM ubuntu:14.04
</span><span class='line'>
</span><span class='line'># Install Python Setuptools
</span><span class='line'>RUN apt-get install -y python-setuptools
</span><span class='line'>
</span><span class='line'># Install pip
</span><span class='line'>RUN easy_install pip
</span><span class='line'>
</span><span class='line'># Add and install Python modules
</span><span class='line'>ADD requirements.txt /src/requirements.txt
</span><span class='line'>RUN cd /src; pip install -r requirements.txt
</span><span class='line'>
</span><span class='line'># Bundle app source
</span><span class='line'>ADD . /src
</span><span class='line'>
</span><span class='line'># Expose
</span><span class='line'>EXPOSE  5000
</span><span class='line'>
</span><span class='line'># Run
</span><span class='line'>CMD ["python", "/src/application.py"]
</span><span class='line'>$ docker build -t eb-py-sample .
</span><span class='line'>$ docker run -d \
</span><span class='line'>     -e APP_CONFIG=application.config.example \
</span><span class='line'>     -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
</span><span class='line'>     -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
</span><span class='line'>     -p 8080:5000 \
</span><span class='line'>     eb-py-sample
</span></code></pre></td></tr></table></div></figure>


<p>Then open <a href="http://localhost:8000">http://localhost:8000</a> to see your own app.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/06/tips-on-30days30skills-5/">Tips on 30Days30Skills(5)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-06T16:26:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:26 pm</span></time>
        
         | <a href="/blog/2014/12/06/tips-on-30days30skills-5/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since the RESTful API is a little bit hard for setup, I ignore the Day10 and Day11, jump to Day 12, OpenCV.</p>

<h3>Day 12 - OpenCV</h3>

<h4>Get the jar file</h4>

<p>First download the opencv from:
<a href="http://sourceforge.net/projects/opencvlibrary/files/latest/download">http://sourceforge.net/projects/opencvlibrary/files/latest/download</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ unzip *.zip
</span><span class='line'>$ cd opencv-2.4.10
</span><span class='line'>$ cmake -G "Unix Makefiles" -D CMAKE_CXX_COMPILER=/usr/bin/g++ -D CMAKE_C_COMPILER=/usr/bin/gcc -D WITH_CUDA=ON .. 
</span><span class='line'>$ make -j4 && make install
</span></code></pre></td></tr></table></div></figure>


<p>Trouble shooting when generating openCV jar file:  <br/>
Correct output should be:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>--   Java:
</span><span class='line'>--     ant:                         /bin/ant (ver 1.9.4)
</span><span class='line'>--     JNI:                         /usr/lib/jvm/java-7-openjdk/include /usr/lib/jvm/java-7-openjdk/include/linux /usr/lib/jvm/java-7-openjdk/include
</span><span class='line'>--     Java tests:                  YES
</span></code></pre></td></tr></table></div></figure>


<p>Add JNi</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export JAVA_HOME=/usr/lib/jvm/java-7-openjdk/
</span></code></pre></td></tr></table></div></figure>


<p>Then build with following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cmake -G "Unix Makefiles" -D CMAKE_CXX_COMPILER=/usr/bin/g++ -D CMAKE_C_COMPILER=/usr/bin/gcc -D WITH_CUDA=ON -D BUILD_SHARED_LIBS=OFF -D BUILD_NEW_PYTHON_SUPPORT=NO .. && make
</span></code></pre></td></tr></table></div></figure>


<p>For MACOS, you should install:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew install ant
</span><span class='line'>$ export JAVA_HOME=`/usr/libexec/java_home -v 1.6`
</span></code></pre></td></tr></table></div></figure>


<p>Then re-compile and now you could get the jar file under build/bin/.</p>

<h4>Development on OpenCV</h4>

<p>Using eclipse LUNA.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(venv)[Trusty@~/code/30days/Day12OpenCV/opencv-2.4.10/build/bin]$ pwd
</span><span class='line'>/home/Trusty/code/30days/Day12OpenCV/opencv-2.4.10/build/bin
</span><span class='line'>(venv)[Trusty@~/code/30days/Day12OpenCV/opencv-2.4.10/build/bin]$ ls *.jar
</span><span class='line'>opencv-2410.jar
</span></code></pre></td></tr></table></div></figure>


<p>Add the new User Libraries:</p>

<p><img src="/images/addjavalib.jpg" alt="/images/addjavalib.jpg" /></p>

<p>The detailed configuration steps could be refered to the <a href="http://segmentfault.com/a/1190000000358809">http://segmentfault.com/a/1190000000358809</a>,  After configuration your User Libraries should be looked like this:  <br/>
<img src="/images/javalib2.jpg" alt="/images/javalib2.jpg" /></p>

<p>Add User Libraries thus you could see the configuration of the lib is looked like:  <br/>
<img src="/images/libconfiguration.jpg" alt="/images/libconfiguration.jpg" /></p>

<p>Code is like following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">facedetection</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.opencv.core.Core</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.opencv.core.Mat</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.opencv.core.MatOfRect</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.opencv.core.Point</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.opencv.core.Rect</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.opencv.core.Scalar</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.opencv.highgui.Highgui</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.opencv.objdetect.CascadeClassifier</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyFaceDetectionClass</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="n">Core</span><span class="o">.</span><span class="na">NATIVE_LIBRARY_NAME</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;\nRunning FaceDetector&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">CascadeClassifier</span> <span class="n">faceDetector</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">CascadeClassifier</span><span class="o">(</span><span class="n">MyFaceDetectionClass</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="s">&quot;haarcascade_frontalface_alt.xml&quot;</span><span class="o">).</span><span class="na">getPath</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Mat</span> <span class="n">image</span> <span class="o">=</span> <span class="n">Highgui</span>
</span><span class='line'>                <span class="o">.</span><span class="na">imread</span><span class="o">(</span><span class="n">MyFaceDetectionClass</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="s">&quot;shekhar.JPG&quot;</span><span class="o">).</span><span class="na">getPath</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">MatOfRect</span> <span class="n">faceDetections</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MatOfRect</span><span class="o">();</span>
</span><span class='line'>        <span class="n">faceDetector</span><span class="o">.</span><span class="na">detectMultiScale</span><span class="o">(</span><span class="n">image</span><span class="o">,</span> <span class="n">faceDetections</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Detected %s faces&quot;</span><span class="o">,</span> <span class="n">faceDetections</span><span class="o">.</span><span class="na">toArray</span><span class="o">().</span><span class="na">length</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">Rect</span> <span class="n">rect</span> <span class="o">:</span> <span class="n">faceDetections</span><span class="o">.</span><span class="na">toArray</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Core</span><span class="o">.</span><span class="na">rectangle</span><span class="o">(</span><span class="n">image</span><span class="o">,</span> <span class="k">new</span> <span class="nf">Point</span><span class="o">(</span><span class="n">rect</span><span class="o">.</span><span class="na">x</span><span class="o">,</span> <span class="n">rect</span><span class="o">.</span><span class="na">y</span><span class="o">),</span> <span class="k">new</span> <span class="nf">Point</span><span class="o">(</span><span class="n">rect</span><span class="o">.</span><span class="na">x</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="na">width</span><span class="o">,</span> <span class="n">rect</span><span class="o">.</span><span class="na">y</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="na">height</span><span class="o">),</span>
</span><span class='line'>                    <span class="k">new</span> <span class="nf">Scalar</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">255</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ouput.png&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Writing %s&quot;</span><span class="o">,</span> <span class="n">filename</span><span class="o">));</span>
</span><span class='line'>        <span class="n">Highgui</span><span class="o">.</span><span class="na">imwrite</span><span class="o">(</span><span class="n">filename</span><span class="o">,</span> <span class="n">image</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you should place the xml file and the JPG file under the java class, after doing this, run the application, then you will got the png file generate with face detected.</p>

<h3>Day 13 - Dropwizard</h3>

<p>First you should install mondb in ArchLinux:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">$</span> <span class="n">sudo</span> <span class="n">pacman</span> <span class="o">-</span><span class="n">S</span> <span class="n">mongodb</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then in eclipse, create a new Maven project with the template of &ldquo;maven-archetype-quickstart&rdquo;, with the following configuration of Artifact Id and Group id.  <br/>
<img src="/images/blogjava.jpg" alt="/images/blogjava.jpg" /></p>

<p>The default pom.xml should be modified,</p>

<p>Since the network environment is not stable, I created a vncserver at the VPS, and use VPS for developing.  <br/>
In vps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">eclipse</span>
</span><span class='line'><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">mongodb</span>
</span></code></pre></td></tr></table></div></figure>


<p>then install the maven from: <a href="http://download.eclipse.org/technology/m2e/releases/1.3">http://download.eclipse.org/technology/m2e/releases/1.3</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/06/use-vccw-for-deploying-wp/">Use VCCW for Deploying WP</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-06T12:13:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:13 pm</span></time>
        
         | <a href="/blog/2014/12/06/use-vccw-for-deploying-wp/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For deploying differenet versions of Wordpress, I searched various kinds of solutions, includeing docker and vagrant, finally I found VCCW(A Wordpress development environment) is what I want, because I could freely changes the WP versions, so following is the guideline for installing and configurating the whole virtualmachine.</p>

<h3>Install</h3>

<p>The installation steps are listed as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant plugin install vagrant-hostsupdater
</span><span class='line'>$ wget https://github.com/miya0001/vccw/archive/1.9.1.tar.gz
</span><span class='line'>$ tar xzvf 1.9.1.tar.gz
</span><span class='line'>$ cd vccw-1.9.1
</span><span class='line'>$ vagrant up
</span></code></pre></td></tr></table></div></figure>


<p>This will start downloading and configrating the VM, it will cost sometimes. So just drink a coffee and get back.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant plugin install vagrant-omnibus && vagrant plugin install vagrant-hostsupdater &&  vagrant plugin install vagrant-proxyconf
</span></code></pre></td></tr></table></div></figure>


<p>Configure proxy and chef?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim Vagrantfile
</span><span class='line'>Vagrant.configure(2) do |config|
</span><span class='line'>  config.proxy.http     = "http://1xx.xx.xx:xxx:2xxx"
</span><span class='line'>  config.proxy.https    = "http://1xx.xx.xx:xxx:2xxx"
</span><span class='line'>  config.proxy.no_proxy = "localhost,127.0.0.1,.example.com"
</span><span class='line'>
</span><span class='line'>config.omnibus.chef_version = :latest
</span><span class='line'>$ VAGRANT_APT_HTTP_PROXY="http://1xx.xx.xx.xxx:2xxxx vagrant up
</span><span class='line'>$ VAGRANT_APT_HTTP_PROXY="http://1xx.xx.xx.xxx:2xxxx vagrant provision
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vagrant halt
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/04/trouble-shooting-on-wicd-wireless-connection/">Trouble Shooting on Wicd Wireless Connection</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-04T20:46:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:46 pm</span></time>
        
         | <a href="/blog/2014/12/04/trouble-shooting-on-wicd-wireless-connection/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Problem</h3>

<p>Could see the SSID, but could not connect to it.</p>

<h3>Trouble Shooting</h3>

<p>First check the log in <code>/var/log/wicd</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@TrustyArch wicd]# cat wicd.log
</span><span class='line'>2014/12/04 20:32:02 :: DHCP connection successful
</span><span class='line'>2014/12/04 20:32:02 :: not verifying
</span><span class='line'>2014/12/04 20:32:02 :: Connecting thread exiting.
</span><span class='line'>2014/12/04 20:32:03 :: Sending connection attempt result success
</span><span class='line'>2014/12/04 20:34:20 :: trying to load backend external
</span><span class='line'>2014/12/04 20:34:20 :: trying to load backend ioctl
</span><span class='line'>2014/12/04 20:34:20 :: WARNING: python-iwscan not found, falling back to using iwlist scan.
</span><span class='line'>2014/12/04 20:34:20 :: WARNING: python-wpactrl not found, falling back to using wpa_cli.
</span></code></pre></td></tr></table></div></figure>


<p>I think it&rsquo;s because the dhcpcd still alive, so manually kill this process via <code>pkill dhcpcd</code>, then re-connect again.  <br/>
Trouble Solved.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/04/flask-and-angularjs-blog-tips/">Flask&amp;AngularJS Blog Tips</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-04T15:32:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:32 pm</span></time>
        
         | <a href="/blog/2014/12/04/flask-and-angularjs-blog-tips/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Background</h3>

<p>For setup the local blog which used for recording some articles, and provide the RESTful APIs for remote usage.   <br/>
The tutorial is located at:  <br/>
<a href="http://blog.john.mayonvolcanosoftware.com/building-a-blog-using-flask-and-angularjs-part-1/">http://blog.john.mayonvolcanosoftware.com/building-a-blog-using-flask-and-angularjs-part-1/</a></p>

<h3>Installation of Packages</h3>

<p>First preapare the environment using virtualenv2:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virtualenv2 flask_blog
</span><span class='line'>$ source flask_blog/bin/activate
</span></code></pre></td></tr></table></div></figure>


<p>Now write a requirements.txt file, under the current folder, the content is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Flask==0.10.1
</span><span class='line'>Flask-Bcrypt==0.6.0
</span><span class='line'>Flask-HTTPAuth==2.2.1
</span><span class='line'>Flask-RESTful==0.2.12
</span><span class='line'>Flask-SQLAlchemy==1.0
</span><span class='line'>Flask-WTF==0.10.0
</span><span class='line'>Jinja2==2.7.3
</span><span class='line'>MarkupSafe==0.23
</span><span class='line'>SQLAlchemy==0.9.7
</span><span class='line'>SQLAlchemy-Utils==0.26.9
</span><span class='line'>WTForms==2.0.1
</span><span class='line'>WTForms-Alchemy==0.12.8
</span><span class='line'>WTForms-Components==0.9.5
</span><span class='line'>Werkzeug==0.9.6
</span><span class='line'>aniso8601==0.83
</span><span class='line'>decorator==3.4.0
</span><span class='line'>infinity==1.3
</span><span class='line'>intervals==0.3.1
</span><span class='line'>itsdangerous==0.24
</span><span class='line'>marshmallow==0.7.0
</span><span class='line'>py-bcrypt==0.4
</span><span class='line'>pytz==2014.4
</span><span class='line'>six==1.7.3
</span><span class='line'>validators==0.6.0
</span><span class='line'>wsgiref==0.1.2
</span></code></pre></td></tr></table></div></figure>


<p>Use <code>pip install -r requirements.txt</code> for installing all of the packages.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/03/use-docker-for-deploying-wp/">Use Docker for Deploying WP</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-03T19:33:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>7:33 pm</span></time>
        
         | <a href="/blog/2014/12/03/use-docker-for-deploying-wp/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Just for swiftly deploy WP and test the RESTful API, I did following operations and runs a WP temporately.</p>

<h3>PULL</h3>

<p>Pull following containers:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker pull mysql
</span><span class='line'>$ docker pull wordpress
</span><span class='line'>$ sudo docker images
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
</span><span class='line'>&lt;none&gt;              &lt;none&gt;              480ac552cd39        About an hour ago   192.8 MB
</span><span class='line'>mysql               latest              98840bbb442c        39 hours ago        235.5 MB
</span><span class='line'>wordpress           latest              9f51af77fd96        8 days ago          470.5 MB
</span></code></pre></td></tr></table></div></figure>


<h3>Configuration</h3>

<p>Explanation for following commands, <code>--name</code> is the name for our container, <code>-p 8038:80</code> is mapping the host machine&rsquo;s 8038 port to container <code>wordpress_1</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run --name mysql_1 -e MYSQL_ROOT_PASSWORD=xxxx -d mysql
</span><span class='line'>$ docker run --name wordpress_1 --link mysql_1:mysql -p 8038:80 -d wordpress
</span></code></pre></td></tr></table></div></figure>


<p>Now open your browser to <code>http://localhost:8038</code> and you got the wordpress installation window.</p>

<h3>WP</h3>

<p>After we installed WP, we could install JSON REST API from:  <br/>
<a href="https://wordpress.org/plugins/json-rest-api/">https://wordpress.org/plugins/json-rest-api/</a>  <br/>
After installation, we could test the REST API via curl:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>TBD
</span></code></pre></td></tr></table></div></figure>


<h3>View Docker status</h3>

<p>First we should grab the docker&rsquo;s PID via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker  inspect  --format ""  mysql_1 
</span><span class='line'>28254
</span><span class='line'>$ docker  inspect  --format ""  wordpress_1
</span><span class='line'>28754
</span></code></pre></td></tr></table></div></figure>


<p>Then we could nsenter the docker container and view its status:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo nsenter --target 28254 --mount --uts --ipc --net --pid -- /bin/bash
</span><span class='line'>$ sudo nsenter --target 28754 --mount --uts --ipc --net --pid -- /bin/bash
</span></code></pre></td></tr></table></div></figure>


<p>In the &lsquo;attached&rsquo; environment we could inspect the status for corresponding services.</p>

<h3>Stop docker contains</h3>

<p>via <code>docker stop</code> we could simply stop the docker container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Trusty@~/code/30days/Docker]$ sudo docker ps
</span><span class='line'>CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS                  NAMES
</span><span class='line'>0995854e2144        wordpress:latest    "/entrypoint.sh apac   About an hour ago   Up About an hour    0.0.0.0:8038-&gt;80/tcp   wordpress_1         
</span><span class='line'>99d257ad6e24        mysql:latest        "/entrypoint.sh mysq   About an hour ago   Up About an hour    3306/tcp               mysql_1             
</span><span class='line'>[Trusty@~/code/30days/Docker]$ docker stop 0995854e2144
</span><span class='line'>0995854e2144
</span><span class='line'>[Trusty@~/code/30days/Docker]$ docker stop 99d257ad6e24
</span><span class='line'>99d257ad6e24
</span><span class='line'>[Trusty@~/code/30days/Docker]$ sudo docker ps
</span><span class='line'>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/03/yong-flaskda-jian-ni-zi-ji-de-restful-api/">用Flask搭建你自己的Restful API</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-03T16:35:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>4:35 pm</span></time>
        
         | <a href="/blog/2014/12/03/yong-flaskda-jian-ni-zi-ji-de-restful-api/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>背景</h3>

<p>最近在过一个《30天学习30种新技术》，过到第10天用Phonegap开发APP的时候，发现作者提供的API不可用，所以费心研究了一下Restful API, 顺利构建出了环境写完了那个APP，下面是一些摘要。  <br/>
我用的Tutorial来自这里：  <br/>
<a href="http://blog.miguelgrinberg.com/post/designing-a-restful-api-with-python-and-flask">http://blog.miguelgrinberg.com/post/designing-a-restful-api-with-python-and-flask</a>   <br/>
开发环境是ArchLinux.</p>

<h3>Hello Flask</h3>

<p>原Tutorial中给出的是一个关于todo-list的实现，我们从最简单的"Hello Flask"开始：  <br/>
首先安装python虚拟环境和flask，注意因为Arch默认的python版本是3，所以这里我们使用了virtualenv2来创建python虚拟运行环境。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir todo-api
</span><span class='line'>$ cd todo-api
</span><span class='line'>$ virtualenv2 flask
</span><span class='line'>$ source flask/bin/activate
</span><span class='line'>(flask) $ pip install flask
</span></code></pre></td></tr></table></div></figure>


<p>在当前目录下建立<code>app.py</code>文件， 输入以下内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c">#!flask/bin/python</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;Hello, Flask!&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在改变文件属性，运行之:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="err">$</span> <span class="n">chmod</span> <span class="n">a</span><span class="o">+</span><span class="n">x</span> <span class="n">app</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="err">$</span> <span class="o">./</span><span class="n">app</span><span class="o">.</span><span class="n">py</span>
</span></code></pre></td></tr></table></div></figure>


<p>打开浏览器访问<code>http://127.0.0.1:5000</code>,，我们可以看到Hello Flask已经出现在浏览器里了。</p>

<h3>实现最简单的Restful API</h3>

<p>Flask本身支持很多插件，可以用于实现Restful API，由于我们这里只是做DEMO使用，需求比较简单，我们抛弃那些繁琐的插件，手动来写。  <br/>
这里我们也不会引入数据库等内容，我们将task任务列表直接保存在内存中，所以一旦断电这些数据就将消失。在实际的生产环境中，我们是需要引入不同的数据库来存储这些数据的。   <br/>
在上面生成的<code>app.py</code>中添加以下内容:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c">#!flask/bin/python</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">u&#39;Buy groceries&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;done&#39;</span><span class="p">:</span> <span class="bp">False</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">u&#39;Learn Python&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;done&#39;</span><span class="p">:</span> <span class="bp">False</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在打开终端，用curl就可以访问到我们新添加的API了:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>curl -i http://127.0.0.1:5000/todo/api/v1.0/tasks
</span><span class='line'>HTTP/1.0 <span class="m">200</span> OK
</span><span class='line'>Content-Type: application/json
</span><span class='line'>Content-Length: 316
</span><span class='line'>Server: Werkzeug/0.9.6 Python/2.7.8
</span><span class='line'>Date: Wed, <span class="m">03</span> Dec <span class="m">2014</span> 08:59:55 GMT
</span><span class='line'>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;tasks&quot;</span>: <span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;done&quot;</span>: <span class="nb">false</span>,
</span><span class='line'>      <span class="s2">&quot;id&quot;</span>: 1,
</span><span class='line'>      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>
</span><span class='line'>    <span class="o">}</span>,
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;done&quot;</span>: <span class="nb">false</span>,
</span><span class='line'>      <span class="s2">&quot;id&quot;</span>: 2,
</span><span class='line'>      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'><span class="o">}</span>%
</span></code></pre></td></tr></table></div></figure>


<p>第一个Restful的API就这样创建成功了。</p>

<h3>添加第二个RESTful API</h3>

<p>我们接着来添加第二个RESTful API, 加入下列代码到已有的<code>app.py</code>中:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
</span><span class='line'>    <span class="n">task</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在用curl来测试，结果应该是这样的:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="p">(</span><span class="n">flask</span><span class="p">)[</span><span class="n">Trusty</span><span class="err">@</span><span class="o">~/</span><span class="n">code</span><span class="o">/</span><span class="mi">30</span><span class="n">days</span><span class="o">/</span><span class="n">todo</span><span class="o">-</span><span class="n">api</span><span class="p">]</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="mi">2</span>
</span><span class='line'><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">151</span>
</span><span class='line'><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">6</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">8</span>
</span><span class='line'><span class="n">Date</span><span class="p">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mo">03</span> <span class="n">Dec</span> <span class="mi">2014</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">25</span> <span class="n">GMT</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;Need to find a good Python tutorial on the web&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;done&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Learn Python&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="o">%</span>                                                                                                                                                   <span class="p">(</span><span class="n">flask</span><span class="p">)[</span><span class="n">Trusty</span><span class="err">@</span><span class="o">~/</span><span class="n">code</span><span class="o">/</span><span class="mi">30</span><span class="n">days</span><span class="o">/</span><span class="n">todo</span><span class="o">-</span><span class="n">api</span><span class="p">]</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="mi">3</span>
</span><span class='line'><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">404</span> <span class="n">NOT</span> <span class="n">FOUND</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">233</span>
</span><span class='line'><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">6</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">8</span>
</span><span class='line'><span class="n">Date</span><span class="p">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mo">03</span> <span class="n">Dec</span> <span class="mi">2014</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">27</span> <span class="n">GMT</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="err">!</span><span class="n">DOCTYPE</span> <span class="n">HTML</span> <span class="n">PUBLIC</span> <span class="s">&quot;-//W3C//DTD HTML 3.2 Final//EN&quot;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="mi">404</span> <span class="n">Not</span> <span class="n">Found</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Not</span> <span class="n">Found</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">The</span> <span class="n">requested</span> <span class="n">URL</span> <span class="n">was</span> <span class="ow">not</span> <span class="n">found</span> <span class="n">on</span> <span class="n">the</span> <span class="n">server</span><span class="o">.</span>  <span class="n">If</span> <span class="n">you</span> <span class="n">entered</span> <span class="n">the</span> <span class="n">URL</span> <span class="n">manually</span> <span class="n">please</span> <span class="n">check</span> <span class="n">your</span> <span class="n">spelling</span> <span class="ow">and</span> <span class="k">try</span> <span class="n">again</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于我们引用了abort方法，所以当我们给出的task id错误时，将弹出404错误。</p>

<h3>错误提示JSON化</h3>

<p>通过引入<code>make_response</code>模块我们可以把404返回错误JSON化，添加以下代码到app.py中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;Not found&#39;</span><span class="p">}),</span> <span class="mi">404</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在访问一个不存在的task id将返回如下结果：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="p">(</span><span class="n">flask</span><span class="p">)[</span><span class="n">Trusty</span><span class="err">@</span><span class="o">~/</span><span class="n">code</span><span class="o">/</span><span class="mi">30</span><span class="n">days</span><span class="o">/</span><span class="n">todo</span><span class="o">-</span><span class="n">api</span><span class="p">]</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="mi">3</span>
</span><span class='line'><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">404</span> <span class="n">NOT</span> <span class="n">FOUND</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">26</span>
</span><span class='line'><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">6</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">8</span>
</span><span class='line'><span class="n">Date</span><span class="p">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mo">03</span> <span class="n">Dec</span> <span class="mi">2014</span> <span class="mi">09</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">50</span> <span class="n">GMT</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="s">&quot;Not found&quot;</span>
</span><span class='line'><span class="p">}</span><span class="o">%</span>
</span></code></pre></td></tr></table></div></figure>


<h3>实现POST方法</h3>

<p>添加以下代码以实现POST方法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">create_task</span><span class="p">():</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</span><span class='line'>    <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
</span><span class='line'>        <span class="s">&#39;done&#39;</span><span class="p">:</span> <span class="bp">False</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">}),</span> <span class="mi">201</span>
</span></code></pre></td></tr></table></div></figure>


<p>用curl测试的结果如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="p">(</span><span class="n">flask</span><span class="p">)[</span><span class="n">Trusty</span><span class="err">@</span><span class="o">~/</span><span class="n">code</span><span class="o">/</span><span class="mi">30</span><span class="n">days</span><span class="o">/</span><span class="n">todo</span><span class="o">-</span><span class="n">api</span><span class="p">]</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">H</span> <span class="s">&quot;Content-Type: application/json&quot;</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">-</span><span class="n">d</span> <span class="s">&#39;{&quot;title&quot;:&quot;Read a book&quot;}&#39;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>
</span><span class='line'><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">201</span> <span class="n">CREATED</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">104</span>
</span><span class='line'><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">6</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">8</span>
</span><span class='line'><span class="n">Date</span><span class="p">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mo">03</span> <span class="n">Dec</span> <span class="mi">2014</span> <span class="mi">09</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">55</span> <span class="n">GMT</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;done&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Read a book&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="o">%</span>
</span><span class='line'> <span class="p">(</span><span class="n">flask</span><span class="p">)[</span><span class="n">Trusty</span><span class="err">@</span><span class="o">~/</span><span class="n">code</span><span class="o">/</span><span class="mi">30</span><span class="n">days</span><span class="o">/</span><span class="n">todo</span><span class="o">-</span><span class="n">api</span><span class="p">]</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>
</span><span class='line'><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">423</span>
</span><span class='line'><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">6</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">8</span>
</span><span class='line'><span class="n">Date</span><span class="p">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mo">03</span> <span class="n">Dec</span> <span class="mi">2014</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mi">24</span> <span class="n">GMT</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s">&quot;tasks&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;done&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Buy groceries&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;Need to find a good Python tutorial on the web&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;done&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Learn Python&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;done&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Read a book&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span><span class="o">%</span>
</span></code></pre></td></tr></table></div></figure>


<p>从上面的测试中我们可以看到一个新的任务被添加到了task列表中。</p>

<h3>最后两个RESTful API</h3>

<p>最后的两个RESTful API代码如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;PUT&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">update_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
</span><span class='line'>    <span class="n">task</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">unicode</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">unicode</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;done&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;done&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</span><span class='line'>    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;title&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;description&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;done&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;done&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;DELETE&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">delete_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
</span><span class='line'>    <span class="n">task</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>测试代码如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">H</span> <span class="s">&quot;Content-Type: application/json&quot;</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="o">-</span><span class="n">d</span> <span class="s">&#39;{&quot;done&quot;:true}&#39;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行上面的命令可以将第2条记录里的done字段由false改成true.</p>

<h3>改进接口</h3>

<p>加入以下代码后，我们调用tasks方法将不再返回id,而是返回URIs，这样取回来就能用了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
</span><span class='line'>    <span class="n">new_task</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="n">new_task</span><span class="p">[</span><span class="s">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&#39;get_task&#39;</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="n">new_task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">new_task</span>
</span></code></pre></td></tr></table></div></figure>


<p>同时我们重写以下方法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;tasks&#39;</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span><span class="n">make_public_task</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)})</span>
</span></code></pre></td></tr></table></div></figure>


<p>测试结果如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>
</span><span class='line'><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">406</span>
</span><span class='line'><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">6</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">8</span>
</span><span class='line'><span class="n">Date</span><span class="p">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mo">03</span> <span class="n">Dec</span> <span class="mi">2014</span> <span class="mi">09</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">12</span> <span class="n">GMT</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s">&quot;tasks&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;done&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Buy groceries&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;uri&quot;</span><span class="p">:</span> <span class="s">&quot;http://127.0.0.1:5000/todo/api/v1.0/tasks/1&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;Need to find a good Python tutorial on the web&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;done&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Learn Python&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;uri&quot;</span><span class="p">:</span> <span class="s">&quot;http://127.0.0.1:5000/todo/api/v1.0/tasks/2&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span><span class="o">%</span>
</span></code></pre></td></tr></table></div></figure>


<h3>加密RESTful网络接口</h3>

<p>好了，我们的RESTful接口搭建完毕了，但是由于接口对所有人都是开放的，为了考虑安全因素，我们会采用简单加密。   <br/>
首先安装flask-httpauth模块:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="err">$</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">flask</span><span class="o">-</span><span class="n">httpauth</span>
</span></code></pre></td></tr></table></div></figure>


<p>而后添加以下代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">flask.ext.httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
</span><span class='line'><span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@auth.get_password</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_password</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s">&#39;miguel&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&#39;python&#39;</span>
</span><span class='line'>    <span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@auth.error_handler</span>
</span><span class='line'><span class="k">def</span> <span class="nf">unauthorized</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;Unauthorized access&#39;</span><span class="p">}),</span> <span class="mi">401</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>加密路由实现如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="nd">@auth.login_required</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>测试结果如下, 未通过授权时:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>
</span><span class='line'><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">401</span> <span class="n">UNAUTHORIZED</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">36</span>
</span><span class='line'><span class="n">WWW</span><span class="o">-</span><span class="n">Authenticate</span><span class="p">:</span> <span class="n">Basic</span> <span class="n">realm</span><span class="o">=</span><span class="s">&quot;Authentication Required&quot;</span>
</span><span class='line'><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">6</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">8</span>
</span><span class='line'><span class="n">Date</span><span class="p">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mo">03</span> <span class="n">Dec</span> <span class="mi">2014</span> <span class="mi">09</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mo">02</span> <span class="n">GMT</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="s">&quot;Unauthorized access&quot;</span>
</span><span class='line'><span class="p">}</span><span class="o">%</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过授权时:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="n">miguel</span><span class="p">:</span><span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>
</span><span class='line'><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">406</span>
</span><span class='line'><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">6</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">8</span>
</span><span class='line'><span class="n">Date</span><span class="p">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mo">03</span> <span class="n">Dec</span> <span class="mi">2014</span> <span class="mi">09</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">24</span> <span class="n">GMT</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s">&quot;tasks&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;done&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Buy groceries&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;uri&quot;</span><span class="p">:</span> <span class="s">&quot;http://localhost:5000/todo/api/v1.0/tasks/1&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="o">.....</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以把出错时返回的错误号从401改变为403,这样返回的就是forbidden错误。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/03/enable-timestamp-in-new-octopress-theme/">Enable Timestamp in New Octopress Theme</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-03T10:40:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>10:40 am</span></time>
        
         | <a href="/blog/2014/12/03/enable-timestamp-in-new-octopress-theme/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>After installing the flattern theme of octopress, I found the post date missed. Following is the steps for catching it back.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake install['flatten']
</span></code></pre></td></tr></table></div></figure>


<p>Modify the following file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat .themes/flatten/source/_includes/post/date.html
</span></code></pre></td></tr></table></div></figure>


<p>Then in <code>.themes/flatten/source/_layouts/post.html</code>, modify the following lines:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;p class="meta"&gt;
</span><span class='line'>//.....//
</span><span class='line'>&lt;/p&gt;
</span></code></pre></td></tr></table></div></figure>


<p>After modification, you would see the time is displayed before the comment numbers.  <br/>
Notice, the modification is not visible in codeblocks because the embedded symbol could not be resolved thus will cause build error, so the detailed code would be only fetched from my github repository but remains blank codeblocks here in this article.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/24">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/22">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/12/27/on-virtualbox-virtualized-cs-env/">On Virtualbox Virtualized CS Env</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/26/cloudstack-dev-env-setup/">CloudStack Dev Env Setup</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/25/ji-cheng-elastistordao-cloudstackzhong/">集成elastistor到CloudStack中</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/23/elastistoryu-cloudstackji-cheng/">ElastiStor与CloudStack集成</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/22/cloudmonkey-issue/">CloudMonkey Issue</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
