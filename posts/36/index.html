
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="Trouble Shooting Unfortuately the qemu based pysical disk can&rsquo;t bootup the machine correctly, so I re-intall the sytem on USB-Disk from the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/posts/36">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//fonts.googleapis.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/22/moving-from-working-pc-to-own-usb-disk-based-3/">Moving From Working PC to Own USB-Disk Based 3</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-22T15:06:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>3:06 pm</span></time>
        
         | <a href="/blog/2014/05/22/moving-from-working-pc-to-own-usb-disk-based-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Trouble Shooting</h3>

<p>Unfortuately the qemu based pysical disk can&rsquo;t bootup the machine correctly, so I re-intall the sytem on USB-Disk from the scratch. This time the problem appears as another: It can startup the machine, but failed to boot-up in qemu.   <br/>
So I have to changed to use VirtualBox for booting the system.   <br/>
Get the disk id via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ls -l /dev/disk/by-id
</span><span class='line'>lrwxrwxrwx 1 root root  9 May 22 14:45 usb-ATA_ST980811AS_xxxxxxxx-0:0 -&gt; ../../sdb
</span></code></pre></td></tr></table></div></figure>


<p>Then use VirtualBox&rsquo;s Internal command for creating the vmdk file, this vmdk file actually contains the physical disk.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ VBoxManage internalcommands createrawvmdk -filename ./rawusb1.vmdk -rawdisk /dev/disk/by-id/usb-ATA_ST980811AS_XXXXXXXXXXX-0:0
</span><span class='line'>RAW host disk access VMDK file ./rawusb1.vmdk created successfully.
</span><span class='line'>$ sudo chown -R Trusty *
</span></code></pre></td></tr></table></div></figure>


<p>Now create a new virtual machine in virtualbox, use the newly created rawusb1.vmdk, bootup and you got the physical disk based virtual machine running.</p>

<h3>Continue Install System</h3>

<h4>Python related environment</h4>

<p>Install virtualenvironment via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo pacman -S python2-virtualenv python-virtualenv python-virtualenvwrapper
</span></code></pre></td></tr></table></div></figure>


<p>In company machine, use pip freeze for getting all of the packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ workon venv2
</span><span class='line'>$ pip freeze&gt;requirement.txt
</span></code></pre></td></tr></table></div></figure>


<p>In usb-disk based machine, install from the requirement.txt</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir .virtualenvs
</span><span class='line'># Add following lines into the .bashrc
</span><span class='line'>export WORKON_HOME=~/.virtualenvs
</span><span class='line'>source /usr/bin/virtualenvwrapper.sh
</span><span class='line'>$ mkvirtualenv -p /usr/bin/python2.7 venv
</span><span class='line'>$ pip install -r requirements.txt
</span></code></pre></td></tr></table></div></figure>


<p>After we update the installation, the package is the same as in computer machine.</p>

<h4>ZSH</h4>

<p>Install zsh and use it for replacing default bash:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S zsh
</span><span class='line'>$ chsh -s $(which zsh)
</span></code></pre></td></tr></table></div></figure>


<p>Now we can download the .zshrc from the company machine to usb disk based system.</p>

<h4>Configure GIT Under Proxy</h4>

<p>Setting the proxy and set it for git using proxy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(venv)[Trusty@localhost ~]$ gcc -o connect connect.c 
</span><span class='line'>(venv)[Trusty@localhost ~]$ sudo mv connect /usr/bin/
</span><span class='line'>(venv)[Trusty@localhost ~]$ sudo chmod 777 /usr/bin/connect 
</span><span class='line'>(venv)[Trusty@localhost ~]$ sudo vim /usr/bin/myproxy
</span><span class='line'>(venv)[Trusty@localhost ~]$ sudo chmod 777 /usr/bin/myproxy
</span><span class='line'>(venv)[Trusty@localhost ~]$ cat /usr/bin/myproxy 
</span><span class='line'>/usr/bin/connect -H 1xx.xxx.xxx.xxx:2xxxx $@
</span><span class='line'>(venv)[Trusty@localhost ~]$ git config --global core.gitproxy "/usr/bin/myproxy for *.*"
</span><span class='line'>(venv)[Trusty@localhost ~]$ git config --global user.name "feixxxx"
</span><span class='line'>(venv)[Trusty@localhost ~]$ git config --global user.email "feixxxx@gmail.com"
</span></code></pre></td></tr></table></div></figure>


<h4>BlueTooth</h4>

<p>Install blueman:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S patch automake autoconf libtool 
</span><span class='line'>$ yaourt blueman
</span><span class='line'># choose blueman-bzr
</span><span class='line'>$ sudo pacman -S bluez-utils bluez-libs python2-pybluez
</span><span class='line'>$ yaourt -S bluez4
</span><span class='line'>$ yaourt pulseaudio-bluez4
</span></code></pre></td></tr></table></div></figure>


<p>Configure bluetooth:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo systemctl start bluetooth
</span><span class='line'>$ sudo systemctl enable bluetooth
</span><span class='line'>$ cat /etc/bluetooth/audio.conf
</span><span class='line'>
</span><span class='line'>[General]
</span><span class='line'>Enable=Socket
</span><span class='line'>
</span><span class='line'>[A2DP]
</span><span class='line'>SBCSources=1
</span><span class='line'>$ 
</span></code></pre></td></tr></table></div></figure>


<p>Later bluemanager will be added into the awesome startup application.  <br/>
The configuration is pretty complex, this is the start-point for settingup the bluetooth, later we will configure the bluetooth headset.</p>

<h4>Tray items</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S udiskie wicd wicd-gtk
</span></code></pre></td></tr></table></div></figure>


<h4>Awesome Customization</h4>

<p>Download the themes from github:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S hddtemp vicious
</span><span class='line'>$ git clone https://github.com/Morley93/awesome-themes-3.5.git
</span></code></pre></td></tr></table></div></figure>


<p>Still have some problems. Need update.  <br/>
Then get the customized awesome configuration file. Be sure to use the default, because later you can customize yourself.</p>

<p>Solve wicd error:  <br/>
Error:  Could not connect to wicd&rsquo;s D-Bus interface</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -R wicd wicd-gtk
</span><span class='line'>$ sudo rm -rf /etc/wicd /var/log/wicd /etc/dbus-1/system.d/wicd*
</span><span class='line'>$ sudo pacman -S wicd wicd-gtk
</span><span class='line'>$ sudo pacman -Syu systemd-sysvcompat
</span><span class='line'>$ sudo gpasswd -a Trusty users
</span><span class='line'>$ sudo systemctl enable wicd
</span><span class='line'>$ sudo systemctl start wicd
</span></code></pre></td></tr></table></div></figure>


<p>Now your wicd is OK for see.</p>

<p>udiskie2 problem, cannot start because lack of PyYAML:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S python2-pip
</span><span class='line'>$ sudo pip2 install PyYAML
</span></code></pre></td></tr></table></div></figure>


<p>Now seems all of your tray icons will be OK.</p>

<h4>System Tools</h4>

<p>Install the mlocate so we can use updatedb:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S mlocate
</span><span class='line'>$ sudo updatedb
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/21/moving-from-working-pc-to-own-usb-disk-based-2/">Moving From Working PC to Own USB-Disk Based 2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-21T16:08:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>4:08 pm</span></time>
        
         | <a href="/blog/2014/05/21/moving-from-working-pc-to-own-usb-disk-based-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Install Software</h3>

<h4>Internet</h4>

<p>Chromium, we need this browser absolutesly:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S chromium
</span><span class='line'>Select 1/8
</span></code></pre></td></tr></table></div></figure>


<p>Oh, we forget install X, so first we will install X:</p>

<h4>X Window</h4>

<p>Install xorg first:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S xorg xorg-xinit
</span></code></pre></td></tr></table></div></figure>


<p>Awesome Window Manager;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S awesome
</span></code></pre></td></tr></table></div></figure>


<p>Edit the .xinitrc file, add following lines:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>exec awesome
</span></code></pre></td></tr></table></div></figure>


<p>Necessary video driver:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S xf86-video-intel xf86-video-ati
</span></code></pre></td></tr></table></div></figure>


<h4>Continue Internet</h4>

<p>Firefox, another browser, pidgin, for chatting, thunderbird for email, wget for downloading:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo pacman -S firefox pidgin thunderbird wget
</span></code></pre></td></tr></table></div></figure>


<h4>Office</h4>

<p>Libreoffice,need download 253MB, so take a break:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S libreoffice
</span><span class='line'># choose Enter-&gt; 25-&gt; Enter
</span></code></pre></td></tr></table></div></figure>


<h4>Terminals</h4>

<p>Install xterm first, initial term:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S xterm
</span></code></pre></td></tr></table></div></figure>


<p>xfce4-terminal will be installed in next chapter<code>Vncserver</code>.   <br/>
gnome-terminal is a good option:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S gnome-terminal
</span></code></pre></td></tr></table></div></figure>


<h4>Vncserver</h4>

<p>Install tigervnc</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S tigervnc
</span></code></pre></td></tr></table></div></figure>


<p>Use xfce4 for remote vnc(For many users may not familiar with awesome desktop):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S xfce4 
</span><span class='line'># choose (default=all)
</span></code></pre></td></tr></table></div></figure>


<p>Configure vncserver:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.vnc/xstartup 
</span><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>export XKL_XMODMAP_DISABLE=1
</span><span class='line'>exec startxfce4
</span></code></pre></td></tr></table></div></figure>


<p>With VNC, you can start up the X and let the chromium sync up its bookmarks.</p>

<h4>Documents</h4>

<p>Install evince for viewing pdf and other documents:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S evince
</span></code></pre></td></tr></table></div></figure>


<p>Install gimp for processing pictures:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S gimp
</span></code></pre></td></tr></table></div></figure>


<h4>Video/Fun</h4>

<p>Install smplayer:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo pacman -S smplayer
</span></code></pre></td></tr></table></div></figure>


<p>Without ALSA, you can do nothing, so install it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo pacman -S alsa-utils
</span></code></pre></td></tr></table></div></figure>


<h4>Development</h4>

<p>Install gvim and eclipse:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S gvim eclipse
</span></code></pre></td></tr></table></div></figure>


<p>Git and Subversion:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S git subversion
</span></code></pre></td></tr></table></div></figure>


<p>Wireshark and Tcpdump:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S wireshark-gtk tcpdump
</span></code></pre></td></tr></table></div></figure>


<p>ddd and gdb for debugging:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S ddd gdb
</span></code></pre></td></tr></table></div></figure>


<p>meld for comparing files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S meld
</span></code></pre></td></tr></table></div></figure>


<h4>Virtualization</h4>

<p>Install qemu and virtualbox:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo pacman -S virtualbox qemu
</span></code></pre></td></tr></table></div></figure>


<h4>Chinese Localization</h4>

<p>Install fonts for chinese:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S wqy-bitmapfont wqy-microhei wqy-microhei-lite wqy-zenhei
</span></code></pre></td></tr></table></div></figure>


<p>Install fcitx input method:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S fcitx fcitx-libpinyin fcitx-configtool fcitx-qt4 fcitx-qt5
</span></code></pre></td></tr></table></div></figure>


<p>Configuration will be wrote later.</p>

<h4>System Tools</h4>

<p>rox for file browser:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S rox
</span></code></pre></td></tr></table></div></figure>


<p>gpicview for picture viewer:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S gpicview
</span></code></pre></td></tr></table></div></figure>


<p>Conky for viewing the tasks:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pacman -S conky
</span></code></pre></td></tr></table></div></figure>


<p>.conky file will be downloaded from the github(Later I will upload).
.xinitrc file will be uploaded to github.</p>

<p>Now step2 is OK, we will use usd-disk for rebooting.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/21/moving-from-working-pc-to-own-usb-disk-based/">Moving From Working PC to Own USB-Disk Based</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-21T15:13:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>3:13 pm</span></time>
        
         | <a href="/blog/2014/05/21/moving-from-working-pc-to-own-usb-disk-based/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Background</h3>

<p>Since I want to hava a usb-based OS which could easily be taken by hand, I took this series for resarching how to finish this aim.</p>

<h3>Preparation</h3>

<p>ArchLinux iso file, USB-3.0 HardDisk, 80GB, later I will use a bigger one.</p>

<h4>Qemu Script</h4>

<p>I use qemu firstly to install the system. following is the configuraton file for qemu-i386:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>USERID=$(whoami)
</span><span class='line'>
</span><span class='line'># Get name of newly created TAP device; see https://bbs.archlinux.org/viewtopic.php?pid=1285079#p1285079
</span><span class='line'>precreationg=$(/usr/bin/ip tuntap list | /usr/bin/cut -d: -f1 | /usr/bin/sort)
</span><span class='line'>sudo /usr/bin/ip tuntap add user $USERID mode tap
</span><span class='line'>postcreation=$(/usr/bin/ip tuntap list | /usr/bin/cut -d: -f1 | /usr/bin/sort)
</span><span class='line'>IFACE=$(comm -13 &lt;(echo "$precreationg") &lt;(echo "$postcreation"))
</span><span class='line'>
</span><span class='line'># This line creates a random MAC address. The downside is the DHCP server will assign a different IP address each time
</span><span class='line'>printf -v macaddr "52:54:%02x:%02x:%02x:%02x" $(( $RANDOM & 0xff)) $(( $RANDOM & 0xff )) $(( $RANDOM & 0xff)) $(( $RANDOM & 0xff ))
</span><span class='line'># Instead, uncomment and edit this line to set a static MAC address. The benefit is that the DHCP server will assign the same IP address.
</span><span class='line'># macaddr='52:54:be:36:42:a9'
</span><span class='line'>  
</span><span class='line'>qemu-system-i386 -net nic,macaddr=$macaddr -net tap,ifname="$IFACE" $*
</span><span class='line'>  
</span><span class='line'>sudo ip link set dev $IFACE down &&gt; /dev/null
</span><span class='line'>sudo ip tuntap del $IFACE mode tap &&gt; /dev/null 
</span></code></pre></td></tr></table></div></figure>


<p>Run the virtual machine like following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./run-qemu-i386 -hda /dev/sdc -m 1024 -boot d -cdrom  ./archlinux-2014.05.01
</span></code></pre></td></tr></table></div></figure>


<h4>Installation Of ArchLinux</h4>

<p>When your iso bootup, you will enter command-line, use following command for start the ssh :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># passwd root
</span><span class='line'># systemctl start sshd
</span><span class='line'># ifconfig 
</span><span class='line'># ssh root@10.0.0.240
</span></code></pre></td></tr></table></div></figure>


<p>Partition disk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># fdisk /dev/sda
</span><span class='line'>Command (m for help): p
</span><span class='line'>Disk /dev/sda: 74.5 GiB, 80026361856 bytes, 156301488 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0xc001c001
</span><span class='line'>
</span><span class='line'>Device    Boot Start       End   Blocks  Id System
</span><span class='line'>/dev/sda1       2048 156301487 78149720  83 Linux
</span><span class='line'>
</span><span class='line'>Command (m for help): d
</span><span class='line'>
</span><span class='line'>Selected partition 1
</span><span class='line'>Partition 1 has been deleted.
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>
</span><span class='line'>Partition type:
</span><span class='line'>   p   primary (0 primary, 0 extended, 4 free)
</span><span class='line'>   e   extended
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (1-4, default 1): 1
</span><span class='line'>First sector (2048-156301487, default 2048): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2048-156301487, default 156301487): +1G
</span><span class='line'>
</span><span class='line'>Created a new partition 1 of type 'Linux' and of size 1 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): t
</span><span class='line'>Hex code (type L to list all codes): 82
</span><span class='line'>Changed type of partition 'Linux' to 'Linux swap / Solaris'.
</span><span class='line'>
</span><span class='line'>Command (m for help): n
</span><span class='line'>
</span><span class='line'>Partition type:
</span><span class='line'>   p   primary (1 primary, 0 extended, 3 free)
</span><span class='line'>   e   extended
</span><span class='line'>Select (default p): p
</span><span class='line'>Partition number (2-4, default 2): 
</span><span class='line'>First sector (2099200-156301487, default 2099200): 
</span><span class='line'>Last sector, +sectors or +size{K,M,G,T,P} (2099200-156301487, default 156301487): 
</span><span class='line'>
</span><span class='line'>Created a new partition 2 of type 'Linux' and of size 73.5 GiB.
</span><span class='line'>
</span><span class='line'>Command (m for help): w
</span><span class='line'>The partition table has been altered.
</span><span class='line'>Calling ioctl() to re-read partition table.
</span><span class='line'>Syncing disks.
</span><span class='line'>
</span><span class='line'>root@archiso ~ # fdisk -l /dev/sda
</span><span class='line'>
</span><span class='line'>Disk /dev/sda: 74.5 GiB, 80026361856 bytes, 156301488 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0xc001c001
</span><span class='line'>
</span><span class='line'>Device    Boot     Start       End   Blocks  Id System
</span><span class='line'>/dev/sda1           2048   2099199  1048576  82 Linux swap / Solaris
</span><span class='line'>/dev/sda2        2099200 156301487 77101144  83 Linux
</span></code></pre></td></tr></table></div></figure>


<p>Now your partition is ok, make filesystems.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mkfs.ext4 /dev/sda2                                                             
</span><span class='line'>root@archiso ~ # mkswap /dev/sda1
</span><span class='line'>root@archiso ~ # swapon /dev/sda1
</span></code></pre></td></tr></table></div></figure>


<p>Now begin to install system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mount /dev/sda2 /mnt
</span><span class='line'># pacstrap /mnt base
</span></code></pre></td></tr></table></div></figure>


<p>Configuraion:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># genfstab -p /mnt &gt;&gt; /mnt/etc/fstab
</span><span class='line'># arch-chroot /mnt
</span><span class='line'>sh-4.3# cat /etc/hostname 
</span><span class='line'>FreeArch
</span><span class='line'>
</span><span class='line'>sh-4.3# ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</span><span class='line'># Uncomment the items in /etc/locale.gen, and run: 
</span><span class='line'>sh-4.3# locale-gen
</span><span class='line'>Generating locales...
</span><span class='line'>  en_US.UTF-8... done
</span><span class='line'>  en_US.ISO-8859-1... done
</span><span class='line'>  zh_CN.GB18030... done
</span><span class='line'>  zh_CN.GBK... done
</span><span class='line'>  zh_CN.UTF-8... done
</span><span class='line'>  zh_CN.GB2312... done
</span><span class='line'>  zh_TW.EUC-TW... done
</span><span class='line'>  zh_TW.UTF-8... done
</span><span class='line'>  zh_TW.BIG5... done
</span><span class='line'>Generation complete.
</span><span class='line'>
</span><span class='line'>sh-4.3# mkinitcpio -p linux
</span><span class='line'>sh-4.3# passwd root
</span></code></pre></td></tr></table></div></figure>


<p>Network Configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sh-4.3# ip link
</span><span class='line'>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default 
</span><span class='line'>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span class='line'>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
</span><span class='line'>    link/ether 52:54:94:b5:12:24 brd ff:ff:ff:ff:ff:ff
</span><span class='line'>sh-4.3# pacman -S dhcpcd
</span><span class='line'>sh-4.3# systemctl enable dhcpcd@ens3
</span><span class='line'>ln -s '/usr/lib/systemd/system/dhcpcd@.service' '/etc/systemd/system/multi-user.target.wants/dhcpcd@ens3.service'
</span></code></pre></td></tr></table></div></figure>


<p>BootLoad Configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># pacman -S grub
</span><span class='line'># grub-install --target=i386-pc --recheck --debug /dev/sda
</span><span class='line'># grub-mkconfig -o /boot/grub/grub.cfg
</span></code></pre></td></tr></table></div></figure>


<p>Umount and reboot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>umount -R /mnt
</span></code></pre></td></tr></table></div></figure>


<h3>Configuration Of System</h3>

<p>Install openssh firstly, and net-tools for getting the ipaddress using ifconfig:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pacman -S openssh
</span><span class='line'>systemctl enable sshd
</span><span class='line'>systemctl start sshd
</span><span class='line'>pacman -S net-tools
</span></code></pre></td></tr></table></div></figure>


<p>Now you can use terminal for getting to the qemu-based machine, and sshd service should be enabled always.</p>

<p>Quickly setup an account, because using root is a bad idea.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># useradd -m -g root -G audio -s /bin/bash Trusty
</span><span class='line'># pacman -S sudo
</span><span class='line'># visudo
</span><span class='line'>##
</span><span class='line'>## User privilege specification
</span><span class='line'>##
</span><span class='line'>root ALL=(ALL) ALL
</span><span class='line'>Trusty ALL=(ALL) NOPASSWD: ALL
</span><span class='line'>## Locale settings
</span><span class='line'># Defaults env_keep += "LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET"
</span><span class='line'>Defaults env_keep += "http_proxy https_proxy ftp_proxy ftps_proxy"
</span></code></pre></td></tr></table></div></figure>


<p>Now you can use the newly added username &ldquo;Trusty&rdquo; for login.</p>

<p>Install yaourt, add following lines into the file /etc/pacman.conf:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[archlinuxfr]
</span><span class='line'>SigLevel = Never
</span><span class='line'>Server = http://repo.archlinux.fr/$arch
</span></code></pre></td></tr></table></div></figure>


<p>Then update and install yaourt:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo pacman -Syu && sudo pacman -S yaourt
</span></code></pre></td></tr></table></div></figure>


<p>Next chapter we will begin to install softwares.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/19/using-harddisk-for-booting-raspberrypi/">Using HardDisk for Booting RaspberryPI</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-19T20:21:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:21 pm</span></time>
        
         | <a href="/blog/2014/05/19/using-harddisk-for-booting-raspberrypi/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>准备</h3>

<p>RaspberryPI, SD卡（4G以上), 移动硬盘，操作系统镜像文件，最好有一个外接供电带电路隔离的USB HUB。 鼠标、键盘等。</p>

<h3>用SD卡启动</h3>

<p>将SD卡插入电脑，将镜像文件写入到SD卡后，将写好的SD卡插入RaspberryPI，加电开机。各种配置（譬如显存大小，是否启动到X等等）完成之后，进入到Linux桌面。</p>

<h3>准备硬盘</h3>

<p>将硬盘插入USB口，如果之前有分好区的，可以略过这一节，直接到<code>拷贝至硬盘</code>一节。   <br/>
在RaspberryPI系统里(wheezy or archLinux)，搜索gparted, 这个工具可以在图形化界面下对硬盘进行分区。  <br/>
命令行下你可以通过下列命令查看已挂载的存储设备信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@alarmpi ~]# fdisk -l
</span><span class='line'>
</span><span class='line'>Disk /dev/mmcblk0: 7.3 GiB, 7822376960 bytes, 15278080 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0x00047c7a
</span><span class='line'>
</span><span class='line'>Device         Boot     Start       End  Blocks  Id System
</span><span class='line'>/dev/mmcblk0p1           8192    122879   57344   c W95 FAT32 (LBA)
</span><span class='line'>/dev/mmcblk0p2         122880  15278079 7577600  83 Linux
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Disk /dev/sda: 465.8 GiB, 500105740288 bytes, 976769024 sectors
</span><span class='line'>Units: sectors of 1 * 512 = 512 bytes
</span><span class='line'>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class='line'>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class='line'>Disklabel type: dos
</span><span class='line'>Disk identifier: 0x0004f23a
</span><span class='line'>
</span><span class='line'>Device    Boot     Start       End    Blocks  Id System
</span><span class='line'>/dev/sda1           2048   1050623    524288  82 Linux swap / Solaris
</span><span class='line'>/dev/sda2        1050624 126879743  62914560  83 Linux
</span><span class='line'>/dev/sda3      126879744 546310143 209715200   7 HPFS/NTFS/exFAT
</span><span class='line'>/dev/sda4      546310144 976769023 215229440   5 Extended
</span><span class='line'>/dev/sda5      546312192 588255231  20971520  83 Linux
</span><span class='line'>/dev/sda6      588257280 976769023 194255872  83 Linux
</span></code></pre></td></tr></table></div></figure>


<p>上面的代码中可以看到，我的RaspberryPI上挂载的硬盘大小是500G。分成了若干个区。</p>

<h3>拷贝文件系统到硬盘分区</h3>

<p>分区决定于你自己，用gparted或者别的分区工具都可以分好，记得选择Linux ext4为文件系统。  <br/>
这里我选择<code>/dev/sda5</code>作为我的根分区，所以在终端上，执行下列命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkfs.ext4 /dev/sda5
</span><span class='line'>$ sudo mount /dev/sda5 /mnt
</span><span class='line'>$ cd /mnt
</span><span class='line'>$ tar cjvf /mnt/rootfs.tar.bz2 /
</span></code></pre></td></tr></table></div></figure>


<p>备份完毕后，解压：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ tar xjvf /mnt/rootfs.tar.bz2 -C /mnt/
</span></code></pre></td></tr></table></div></figure>


<p>这里用tar备份文件系统时主要是为了防止系统中某些可能的链接/设备文件的丢失，干脆先压缩后再解压，一劳永逸，代价是时间会花多一点。用rsync是既保险又快速的方法，如果你系统上安装了rsync，试下下面的命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rsync -rv --exclude=/mnt / /mnt
</span></code></pre></td></tr></table></div></figure>


<p>总之，这一步的目的是把SD卡上的文件系统完整复制到硬盘分区上。</p>

<h3>修改启动选项</h3>

<p>修改SD的boot分区上内容，文件<code>cmdline.txt</code>以使得其适配硬盘启动：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /boot
</span><span class='line'>$ cp cmdline.txt cmdline.txt.SD
</span><span class='line'>$ &gt;cmdline.txt
</span><span class='line'>$ echo "smsc95xx.turbo_mode=N dwc_otg.lpm_enable=0 console=ttyAMA0,115200 kgdboc=ttyAMA0,115200 console=tty1 root=/dev/sda5 rootfstype=ext4 elevator=noop rootwait"&gt;cmdline.txt
</span></code></pre></td></tr></table></div></figure>


<p>上面命令的作用是把<code>root=</code>参数从<code>root=/dev/mmcblk0p2</code>换到<code>root=/dev/sda5</code>，你的硬盘分区可能不是sda5，这取决于你在上两步中采用了哪块分区。例如sda(1?2?3?4?)，这里的数值和你在上两步中应该保持一致。  <br/>
如果你的移动硬盘上创建了交换分区，即swap分区，记得在<code>/etc/fstab</code>文件中加入相应的条目，下面是的系统上，用sda1作为swap分区时的配置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/fstab
</span><span class='line'># 
</span><span class='line'># /etc/fstab: static file system information
</span><span class='line'>#
</span><span class='line'># &lt;file system&gt; &lt;dir&gt; &lt;type&gt;    &lt;options&gt; &lt;dump&gt;    &lt;pass&gt;
</span><span class='line'>/dev/mmcblk0p1  /boot           vfat    defaults        0       0
</span><span class='line'>/dev/sda1     none        swap    defaults        0       0
</span></code></pre></td></tr></table></div></figure>


<p>为了确保写入成功，在操作的最后，麻烦运行一下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo sync
</span></code></pre></td></tr></table></div></figure>


<p>这可以保证所有的外接设备上的数据被安全写入。</p>

<p>没有问题的话，现在重新启动RaspberryPI，你的文件系统就应该跑在硬盘上了。</p>

<p>如果有失败的话，把SD卡插入电脑，把cmdline.txt文件恢复成cmdline.txt.SD文件即可。</p>

<h3>特别强调</h3>

<p>特别强调的一点，彻底从硬盘启动是不可能的！！！也就是说，你依然需要插入一张SD卡在RaspberryPI的槽中。因为RaspberryPI每次都是从固定地址读取启动代码的。   <br/>
上述做法的好处是避免了频繁读写SD卡，延长了SD卡的使用寿命。    <br/>
缺点是： USB硬盘的速度，最多也就是USB2.0的极速。 SD卡，CLASS10的速度可能要超过USB2.0的速度。某些时候会慢一点，但是秒杀CLASS4的卡是没问题的。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/14/node-dot-js-quick-start/">Node.js Quick Start</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-14T19:53:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:53 pm</span></time>
        
         | <a href="/blog/2014/05/14/node-dot-js-quick-start/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Installation</h3>

<p>Via following command</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ yaourt -S nodejs
</span></code></pre></td></tr></table></div></figure>


<h3>Quick Start</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ node
</span><span class='line'>&gt; console.log("Hello!")
</span><span class='line'>Hello!
</span><span class='line'>undefined
</span></code></pre></td></tr></table></div></figure>


<p>Hit twice &ldquo;Ctrl+c&rdquo; you will get out of the terminal.   <br/>
A simple example is like:</p>

<figure class='code'><figcaption><span>server.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="o">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">});</span>
</span><span class='line'>      <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
</span><span class='line'><span class="nx">$</span> <span class="nx">node</span> <span class="nx">server</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span> <span class="nx">curl</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:8888</span>
</span><span class='line'><span class="nx">Hello</span> <span class="nx">World</span><span class="o">%</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/13/write-python-weather-app-on-heroku-12/">Write Python Weather APP on Heroku(12)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-13T21:17:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:17 pm</span></time>
        
         | <a href="/blog/2014/05/13/write-python-weather-app-on-heroku-12/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Final Effect</h3>

<p>Following is the final effect of our own app:</p>

<p><img src="/images/effect_1.jpg" alt="/images/effect_1.jpg" /></p>

<p><img src="/images/effect_2.jpg" alt="/images/effect_2.jpg" /></p>

<p><img src="/images/effect_3.jpg" alt="/images/effect_3.jpg" /></p>

<p>There are lots to be finalize and optimized, but currently It could be ful-fill our requirements which retriving the data and generate the flot.   <br/>
The next series I will try to write some ruby or node.js programs which did the same functionalities, to compare the differencies between app developement.   <br/>
Also to write a web-proxy is a work full of challenge, this will be took as next consideration of developing apps on heroku .</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/13/write-python-weather-app-on-heroku-11/">Write Python Weather APP on Heroku(11)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-13T21:00:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:00 pm</span></time>
        
         | <a href="/blog/2014/05/13/write-python-weather-app-on-heroku-11/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Draw Flot Picture</h3>

<p>Since the article is mainly on writing apps, I don&rsquo;t want to spend much time on how to use javascript or flot for drawing picture.  <br/>
Simply checkout the code on github, you will see the code which is used for retrieving the data and start drawing plot pictures.</p>

<h3>Fetching 24-hours Data</h3>

<p>Fetching 24 latest records from the postgres database, and then add them into the chart, chart then has been sent to simplejson which used for updating the flot picture locally .</p>

<figure class='code'><figcaption><span>genhtm.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/ajax/24hours/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c"># ajax updateing for 24-hour data</span>
</span><span class='line'><span class="k">def</span> <span class="nf">TwentyFourHours</span><span class="p">():</span>
</span><span class='line'>    <span class="c"># Here we will visit postgres for retrieving back the last 24 hours&#39; data</span>
</span><span class='line'>    <span class="c"># Local version</span>
</span><span class='line'>    <span class="c"># engine = create_engine(&#39;postgresql+psycopg2://Trusty:@localhost:5432/mylocaldb&#39;, echo=True)</span>
</span><span class='line'>    <span class="c"># Heroku Version</span>
</span><span class='line'>    <span class="n">db_conn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db_conn</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># Engine selection</span>
</span><span class='line'>    <span class="n">metadata</span><span class="o">=</span><span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span class='line'>    <span class="n">weather_table</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;weather&#39;</span><span class="p">,</span><span class="n">metadata</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;Insert_Time&#39;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;Temperature&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;Humidity&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;PmTen&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;PmTwoFive&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">weather_table</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">weather_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">Insert_Time</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
</span><span class='line'>    <span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>    <span class="n">chart</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span class='line'>        <span class="c"># row[0], datetime; </span>
</span><span class='line'>        <span class="c"># row[1], Temperature;</span>
</span><span class='line'>        <span class="c"># row[2], Humidity;</span>
</span><span class='line'>        <span class="c"># row[3], PM10;</span>
</span><span class='line'>        <span class="c"># row[4], PM2.5; </span>
</span><span class='line'>
</span><span class='line'>        <span class="c">###  append row[x] into the char ###</span>
</span><span class='line'>        <span class="c"># chart.append({</span>
</span><span class='line'>        <span class="n">chart</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;label&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span> <span class="o">=</span> <span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M&quot;</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>            <span class="s">&quot;humi_value&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span class='line'>            <span class="s">&quot;pm25_value&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span><span class='line'>            <span class="s">&quot;pm10_value&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span class='line'>            <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">jsonStr</span> <span class="o">=</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span class='line'>        <span class="c"># This is char, will be used in script.js</span>
</span><span class='line'>        <span class="s">&quot;chart&quot;</span> <span class="p">:{</span>
</span><span class='line'>            <span class="c"># tooltip is used by the jQuery chart:</span>
</span><span class='line'>            <span class="s">&quot;tooltip&quot;</span>   <span class="p">:</span> <span class="s">&quot;Temperature at %1: %2 degree&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="c"># humi_tooltip is used for jQuery chart for humidity:</span>
</span><span class='line'>            <span class="s">&quot;humi_tooltip&quot;</span> <span class="p">:</span> <span class="s">&quot;Humidity at %1: %2 \%&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;pm25_tooltip&quot;</span> <span class="p">:</span> <span class="s">&quot;PM2.5 at %1: %2 ug/m(3)&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;pm10_tooltip&quot;</span> <span class="p">:</span> <span class="s">&quot;PM10 at %1: %2 ug/m(3)&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;data&quot;</span>      <span class="p">:</span> <span class="n">chart</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>        <span class="c"># This is &quot;downtime&quot; will be used in script.js</span>
</span><span class='line'>             <span class="s">&quot;downtime&quot;</span>  <span class="p">:</span> <span class="n">getDowntime</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonStr</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The periodic task which runs in <code>tasks.py</code> will fetching the data from the python api and the webpage, then insert them into the postgres database, so here in 24-hours' function we just get them out and fill in the flot picture.</p>

<h3>Daily Data</h3>

<p>Daily data shall be generated via calculating them at the mid-night, that is, at the beginning of a brand new day, we will calculate out the last day&rsquo;s average data.  <br/>
The code is implemented in <code>tasks.py</code> as a crontab task, the code is listed as following:</p>

<figure class='code'><figcaption><span>tasks.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c"># Every Day we will run a periodly work which will calculate </span>
</span><span class='line'><span class="c"># the average temperature/humidity/pm2.5/pm10 task, and store</span>
</span><span class='line'><span class="c"># it into the daily database, thus we have to define new Database</span>
</span><span class='line'><span class="c"># here and insert data into.</span>
</span><span class='line'><span class="c"># Beijing is locate at east 8 zone, thus 16:12 + 8 hour = 24:12</span>
</span><span class='line'><span class="c"># At every mid-night(24:12) it will caculate the average value for</span>
</span><span class='line'><span class="c"># the past 24 hours. </span>
</span><span class='line'><span class="nd">@periodic_task</span><span class="p">(</span><span class="n">run_every</span><span class="o">=</span><span class="n">crontab</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>
</span><span class='line'><span class="k">def</span> <span class="nf">OneDayHandler</span><span class="p">():</span>
</span><span class='line'>    <span class="c"># First Get the last 24 hours&#39; data set</span>
</span><span class='line'>    <span class="c"># Local Engine</span>
</span><span class='line'>    <span class="c"># engine = create_engine(&#39;postgresql+psycopg2://Trusty:@localhost:5432/mylocaldb&#39;,echo=True)</span>
</span><span class='line'>    <span class="c"># Heroku Engine</span>
</span><span class='line'>    <span class="n">db_conn</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db_conn</span><span class="p">)</span>
</span><span class='line'>    <span class="n">metadata</span><span class="o">=</span><span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># Definition of the weather table</span>
</span><span class='line'>    <span class="n">weather_table</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;weather&#39;</span><span class="p">,</span><span class="n">metadata</span><span class="p">,</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;Insert_Time&#39;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;Temperature&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;Humidity&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;PmTen&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;PmTwoFive&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="c"># Get last 24 records, If we suppose there are truely 24 records in last 24 hours, we can enable this sentense. But sometimes, this will be wrong. </span>
</span><span class='line'>    <span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">weather_table</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">weather_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">Insert_Time</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
</span><span class='line'>    <span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class='line'>    <span class="n">results</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Temperature</span>
</span><span class='line'>    <span class="n">totTemperature</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">avgTemperature</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="c"># Humidity</span>
</span><span class='line'>    <span class="n">totHumidity</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">avgHumidity</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="c"># PM2.5</span>
</span><span class='line'>    <span class="n">totPm25</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">avgPm25</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="c"># PM10</span>
</span><span class='line'>    <span class="n">totPm10</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">avgPm10</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">records_number</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span class='line'>        <span class="n">totTemperature</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="n">totHumidity</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>        <span class="n">totPm25</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span><span class='line'>        <span class="n">totPm10</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span class='line'>        <span class="n">records_number</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">records_number</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="n">avgTemperature</span> <span class="o">=</span> <span class="n">totTemperature</span><span class="o">/</span><span class="n">records_number</span>
</span><span class='line'>        <span class="n">avgHumidity</span> <span class="o">=</span> <span class="n">totHumidity</span><span class="o">/</span><span class="n">records_number</span>
</span><span class='line'>        <span class="n">avgPm25</span> <span class="o">=</span> <span class="n">totPm25</span><span class="o">/</span><span class="n">records_number</span>
</span><span class='line'>        <span class="n">avgPm10</span> <span class="o">=</span> <span class="n">totPm10</span><span class="o">/</span><span class="n">records_number</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Definition of the avg_eather table</span>
</span><span class='line'>    <span class="n">avg_metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span class='line'>    <span class="n">avg_weather_table</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;avg_weather&#39;</span><span class="p">,</span><span class="n">avg_metadata</span><span class="p">,</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;avg_Insert_Time&#39;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;avg_Temperature&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;avg_Humidity&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;avg_PmTen&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>      <span class="n">Column</span><span class="p">(</span><span class="s">&#39;avg_PmTwoFive&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="c"># Create table in db</span>
</span><span class='line'>    <span class="n">avg_metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># Create insert sentense</span>
</span><span class='line'>    <span class="n">avg_ins</span> <span class="o">=</span> <span class="n">avg_weather_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
</span><span class='line'>    <span class="c"># Really insert</span>
</span><span class='line'>    <span class="n">avg_ins</span> <span class="o">=</span> <span class="n">avg_weather_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">avg_Insert_Time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span> <span class="n">avg_Temperature</span> <span class="o">=</span> <span class="n">avgTemperature</span><span class="p">,</span> <span class="n">avg_Humidity</span> <span class="o">=</span> <span class="n">avgHumidity</span><span class="p">,</span> <span class="n">avg_PmTen</span> <span class="o">=</span> <span class="n">avgPm10</span><span class="p">,</span> <span class="n">avg_PmTwoFive</span> <span class="o">=</span> <span class="n">av</span>
</span><span class='line'><span class="n">gPm25</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># Connect to engine and execute</span>
</span><span class='line'>    <span class="n">avg_conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class='line'>    <span class="n">avg_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">avg_ins</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>We defined a new table named avg_weather, and at the mid-night we will retrieve the latest 24 records, calculating their average value, then insert them into the aver_weather table.</p>

<h3>Displaying Daily Data</h3>

<p>The main procedure is mainly like in 24-hours datas, but notice we are select from avg_weather, and we only select 7 items.   <br/>
30-days data is very simple, change the day from 7 to 30, then you can see the monthly data.</p>

<h3>Write Testing Interface</h3>

<p>We hope we can manually test the functions via web. So we added following testing APIs in genhtml.py:</p>

<figure class='code'><figcaption><span>genhtml.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/test/fetch/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">fetch</span><span class="p">():</span>
</span><span class='line'>    <span class="n">fetch_and_store_data</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;Fetching Test Done!!!&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/test/gen/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">generateOneDay</span><span class="p">():</span>
</span><span class='line'>    <span class="n">OneDayHandler</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;Generate Test Done!!!&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we visit <a href="http://Your_app_address/test/fetch,">http://Your_app_address/test/fetch,</a> the program will fetch back the data.  And for <a href="http://Your_app_address/test/gen,">http://Your_app_address/test/gen,</a> the daily average data will be generated.</p>

<p>Next Chapter is the last one. We simply paste the screenshots of the APP.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/13/write-python-weather-app-on-heroku-10/">Write Python Weather APP on Heroku(10)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-13T20:06:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:06 pm</span></time>
        
         | <a href="/blog/2014/05/13/write-python-weather-app-on-heroku-10/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Use Template In Flask</h3>

<p>To use template in flask, we should put the static file under the <code>templates</code> folder under the root directory. Our index page should looks like following:   <br/>
<img src="/images/frontpage.jpg" alt="/images/frontpage.jpg" /></p>

<p>So our html file shall wrote like following:</p>

<figure class='code'><figcaption><span>index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;title&gt;</span><span class="nt">&lt;/title&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/assets/css/styles.css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!--[if IE]&gt;&lt;script src=&quot;assets/js/excanvas.min.js&quot;&gt;&lt;/script&gt;&lt;![endif]--&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;page&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;header&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;h1&gt;</span><span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>        <span class="nt">&lt;h2&gt;</span>Nanjing Weather/PM Statistics<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;periodDropDown&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;left&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;currentPeriod&quot;</span><span class="nt">&gt;</span>Last 24 hours<span class="nt">&lt;/span&gt;</span>
</span><span class='line'>            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;arrow&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>
</span><span class='line'>          <span class="nt">&lt;ul&gt;</span>
</span><span class='line'>              <span class="nt">&lt;li</span> <span class="na">data-action=</span><span class="s">&quot;24hours&quot;</span><span class="nt">&gt;</span>Last 24 hours<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>                <span class="nt">&lt;li</span> <span class="na">data-action=</span><span class="s">&quot;7days&quot;</span><span class="nt">&gt;</span>Last 7 Days<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>                <span class="nt">&lt;li</span> <span class="na">data-action=</span><span class="s">&quot;30days&quot;</span><span class="nt">&gt;</span>Last 30 Days<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;temperature section&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h3&gt;</span>Temperature<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;plot&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;preloader&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;humidity section&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h3&gt;</span>Humidity<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;humi_plot&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;preloader&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;pm2.5 section&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h3&gt;</span>PM2.5<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;pm25_plot&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;preloader&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;pm10 section&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h3&gt;</span>PM10<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;pm10_plot&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;preloader&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;footer&quot;</span><span class="nt">&gt;</span>
</span><span class='line'> <span class="ni">&amp;copy;</span> . Powered by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;kkkttt.github.io&quot;</span><span class="nt">&gt;</span>Dash<span class="nt">&lt;/a&gt;</span> UTC: 
</span><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/assets/js/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/assets/js/script.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/assets/js/jquery.flot.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>
To use CSS file to make sure the vision effect, to use css in flask, put your files into the directory</code>static` under the root directory. Just like following :</p>

<figure class='code'><figcaption><span>run.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>tree static
</span><span class='line'>static
</span><span class='line'>└── assets
</span><span class='line'>    ├── css
</span><span class='line'>    │   └── styles.css
</span><span class='line'>    ├── img
</span><span class='line'>    │   ├── bg_tile.jpg
</span><span class='line'>    │   ├── bg_vert.jpg
</span><span class='line'>    │   ├── preloader.gif
</span><span class='line'>    │   └── sprite.png
</span><span class='line'>    └── js
</span><span class='line'>        ├── jquery.flot.min.js
</span><span class='line'>        ├── jquery.min.js
</span><span class='line'>        └── script.js
</span></code></pre></td></tr></table></div></figure>


<h3>Rendering Html</h3>

<p>In genhtml.py, we define the function which rendering the html template like following:</p>

<figure class='code'><figcaption><span>genhtml.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c"># @app.route(&#39;/index&#39;)</span>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c"># Generate the index page, for debugging now</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span><span class='line'>    <span class="c"># Use template for rendering the content</span>
</span><span class='line'>    <span class="n">Current_Year</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y::%H:%M &quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">Current_UTC</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;NanJing Weather and PM2.5/10 Statistics&quot;</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">Current_Year</span><span class="p">,</span> <span class="n">utctime</span><span class="o">=</span><span class="n">Current_UTC</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now open your first page, you will see the rendered effect. But the flot div remains empty, next chapter we will introduce the javascript which used for draw the flot picture and AJAX which used for updating the content.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/12/write-python-weather-app-on-heroku-9/">Write Python Weather APP on Heroku(9)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-12T10:48:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:48 am</span></time>
        
         | <a href="/blog/2014/05/12/write-python-weather-app-on-heroku-9/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Understanding the flask and Jinja</h3>

<h4>Flask Example</h4>

<p>hello1.py is listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from flask import Flask
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>
</span><span class='line'>@app.route("/")
</span><span class='line'>def index():
</span><span class='line'>    return 'Index Page'
</span><span class='line'>
</span><span class='line'>@app.route('/hello')
</span><span class='line'>def hello():
</span><span class='line'>    return "Hello World!"
</span><span class='line'>
</span><span class='line'>@app.route('/hello1')
</span><span class='line'>def hello1():
</span><span class='line'>    return "Hello World 1!"
</span><span class='line'>
</span><span class='line'>if __name__ == "__main__":
</span><span class='line'>    app.run()
</span></code></pre></td></tr></table></div></figure>


<p>Run this via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python hello1.py
</span></code></pre></td></tr></table></div></figure>


<p>Then use your browser for visiting <a href="http://localhost:5000,">http://localhost:5000,</a> <a href="http://localhost:5000/hello,">http://localhost:5000/hello,</a> <a href="http://localhost:5000/hello1.">http://localhost:5000/hello1.</a> You will view different output result.</p>

<h4>Jinja Example</h4>

<p>The sample.py is listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Load the jinja library's namespace into the current module.
</span><span class='line'>import jinja2
</span><span class='line'>
</span><span class='line'># In this case, we will load templates off the filesystem.
</span><span class='line'># This means we must construct a FileSystemLoader object.
</span><span class='line'># 
</span><span class='line'># The search path can be used to make finding templates by
</span><span class='line'>#   relative paths much easier.  In this case, we are using
</span><span class='line'>#   absolute paths and thus set it to the filesystem root.
</span><span class='line'>templateLoader = jinja2.FileSystemLoader( searchpath="/" )
</span><span class='line'>
</span><span class='line'># An environment provides the data necessary to read and
</span><span class='line'>#   parse our templates.  We pass in the loader object here.
</span><span class='line'>templateEnv = jinja2.Environment( loader=templateLoader )
</span><span class='line'>
</span><span class='line'># This constant string specifies the template file we will use.
</span><span class='line'>TEMPLATE_FILE = "//home/Trusty/code/python/heroku/Jinja2/example1.jinja"
</span><span class='line'>
</span><span class='line'># Read the template file using the environment object.
</span><span class='line'># This also constructs our Template object.
</span><span class='line'>template = templateEnv.get_template( TEMPLATE_FILE )
</span><span class='line'>
</span><span class='line'># Specify any input variables to the template as a dictionary.
</span><span class='line'>templateVars = { "title" : "Test Example",
</span><span class='line'>                 "description" : "A simple inquiry of function." }
</span><span class='line'>
</span><span class='line'># Finally, process the template to produce our final text.
</span><span class='line'>outputText = template.render( templateVars )
</span><span class='line'>print outputText
</span></code></pre></td></tr></table></div></figure>


<p>Create the example1.jinja at the corresponding directory, contains following content:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!doctype html&gt;
</span><span class='line'>&lt;html lang="en"&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>  &lt;meta charset="UTF-8" /&gt;
</span><span class='line'>
</span><span class='line'>  &lt;title&gt;&lt;/title&gt;
</span><span class='line'>  &lt;meta name="description" content="" /&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>
</span><span class='line'>&lt;body&gt;
</span><span class='line'>
</span><span class='line'>&lt;div id="content"&gt;
</span><span class='line'>  &lt;p&gt;Why, hello there!&lt;/p&gt;
</span><span class='line'>&lt;/div&gt;
</span><span class='line'>
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Then the result will viewed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!doctype html&gt;
</span><span class='line'>&lt;html lang="en"&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>  &lt;meta charset="UTF-8" /&gt;
</span><span class='line'>
</span><span class='line'>  &lt;title&gt;Test Example&lt;/title&gt;
</span><span class='line'>  &lt;meta name="description" content="A simple inquiry of function." /&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>
</span><span class='line'>&lt;body&gt;
</span><span class='line'>
</span><span class='line'>&lt;div id="content"&gt;
</span><span class='line'>  &lt;p&gt;Why, hello there!&lt;/p&gt;
</span><span class='line'>&lt;/div&gt;
</span><span class='line'>
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<h3>Rendering Template Returning</h3>

<p>First create the template file under the directory &lsquo;templates&rsquo;, this is the default position for flask for searching the template files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir templates
</span><span class='line'>$ cat layout.html
</span><span class='line'>&lt;style type="text/css"&gt;
</span><span class='line'>.metanav
</span><span class='line'>{
</span><span class='line'>    background-color: yellow;
</span><span class='line'>}
</span><span class='line'>&lt;/style&gt;
</span><span class='line'>&lt;div class="page"&gt;
</span><span class='line'>  &lt;h1&gt;Flaskr&lt;/h1&gt;
</span><span class='line'>  &lt;div class="metanav"&gt;
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>&lt;/div&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Then in the genhtml.py, we add the following lines for let the template system to rendering our pages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from flask import render_template
</span><span class='line'>@app.route('/index')
</span><span class='line'># Generate the index page, for debugging now
</span><span class='line'>def index():
</span><span class='line'>    # Use template for rendering the content
</span><span class='line'>    rand_list= [0, 1, 2, 3, 4, 5]
</span><span class='line'>    return render_template('layout.html', a_random_string="Heey, what's up!", a_random_list=rand_list)
</span></code></pre></td></tr></table></div></figure>


<p>Now browser you <a href="http://localhost:5000/index,">http://localhost:5000/index,</a> you can see the template rendered result.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/11/write-python-weather-app-on-heroku-8/">Write Python Weather APP on Heroku(8)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-11T15:23:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:23 pm</span></time>
        
         | <a href="/blog/2014/05/11/write-python-weather-app-on-heroku-8/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Deploy on Heroku</h3>

<p>The deployed version is listed as following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env python
</span><span class='line'># -*- coding: utf-8 -*-
</span><span class='line'># Set default encoding: utf-8
</span><span class='line'>import sys;
</span><span class='line'>reload(sys);
</span><span class='line'># Setting the utf-8 format
</span><span class='line'>sys.setdefaultencoding("utf8")
</span><span class='line'>
</span><span class='line'>import os
</span><span class='line'>import logging
</span><span class='line'>import string
</span><span class='line'>from celery import Celery
</span><span class='line'>from celery.task import periodic_task
</span><span class='line'>from datetime import datetime,timedelta
</span><span class='line'>from os import environ
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># For retrieving temperature/humidity
</span><span class='line'>import pywapi
</span><span class='line'>import urllib2
</span><span class='line'>from urllib2 import ProxyHandler
</span><span class='line'>import re
</span><span class='line'>from BeautifulSoup import BeautifulSoup
</span><span class='line'>
</span><span class='line'># For using database(Postgresql)
</span><span class='line'># from flash.ext.sqlalchemy import SQLAlchemy
</span><span class='line'>from sqlalchemy import create_engine
</span><span class='line'>from sqlalchemy import MetaData, Column, Table, ForeignKey
</span><span class='line'>from sqlalchemy import Integer, String, DateTime
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># redis configuration for celery
</span><span class='line'>### Local, should be change to remote when deploying to heroku
</span><span class='line'># REDIS_URL = environ.get('REDISTOGO_URL', 'redis://localhost')
</span><span class='line'>### Heroku Ways
</span><span class='line'>REDIS_URL = environ.get('REDISCLOUD_URL')
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>celery = Celery('tasks', broker=REDIS_URL)
</span><span class='line'>
</span><span class='line'># Fetch 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># Define Periodic Tasks
</span><span class='line'>@periodic_task(run_every=timedelta(minutes=60))
</span><span class='line'># Funciton for fetching data and store it in Postgres
</span><span class='line'>def fetch_and_store_data():
</span><span class='line'>    # Fetching the weather information from Yahoo. 
</span><span class='line'>    Yahoo_Result = pywapi.get_weather_from_yahoo('CHXX0099')
</span><span class='line'>    Current_Temp = string.lower(Yahoo_Result['condition']['temp'])
</span><span class='line'>    Current_Humi = string.lower(Yahoo_Result['atmosphere']['humidity'])
</span><span class='line'>    Tomorrow_Forecast = Yahoo_Result['forecasts'][0]
</span><span class='line'>    Twenty_Four_Hours = Yahoo_Result['forecasts'][1]
</span><span class='line'>    Fourty_Eight_Hours = Yahoo_Result['forecasts'][2]
</span><span class='line'>    Seventy_Two_Hours = Yahoo_Result['forecasts'][3]
</span><span class='line'>    # !!! comment proxy related for deploying to heroku !!! #
</span><span class='line'>    # proxy = urllib2.ProxyHandler({'http': '1xx.x.xx.xxx:2xxx'})
</span><span class='line'>    # opener = urllib2.build_opener(proxy)
</span><span class='line'>    # urllib2.install_opener(opener)
</span><span class='line'>    # !!! comment out end #
</span><span class='line'>    page = urllib2.urlopen("http://www.pm25.in/nanjing")
</span><span class='line'>    soup = BeautifulSoup(page)                      #
</span><span class='line'>    # Find the detailed table from the soup.        #
</span><span class='line'>    table = soup.find('table', {'id':'detail-data'})#
</span><span class='line'>    # Fetch the XuanWuHu, if not, use MaiGaoQiao ins#tead. 
</span><span class='line'>    rows = table.findAll('tr')                      #
</span><span class='line'>    for subrows in rows:                            #
</span><span class='line'>        if "玄武湖" in subrows.text:                #
</span><span class='line'>            XuanwuLake = subrows                    #
</span><span class='line'>        else:                                       #
</span><span class='line'>            if "迈皋桥" in subrows.text:            #
</span><span class='line'>                XuanwuLake = subrows                #
</span><span class='line'>    XuanwuLake_subitem = XuanwuLake.findAll('td')   #
</span><span class='line'>    # Here we will get an array, fetch out the text #for the content from this array.
</span><span class='line'>    # Fetched origin data, different from cnpm25.cn #
</span><span class='line'>    pm_25_orig = XuanwuLake_subitem[4].text         #
</span><span class='line'>    pm_10_orig = XuanwuLake_subitem[5].text
</span><span class='line'>    # Open the Database
</span><span class='line'>    # Local Engine
</span><span class='line'>    # engine = create_engine('postgresql+psycopg2://Trusty:@localhost:5432/mylocaldb',echo=True)
</span><span class='line'>    # Heroku Engine
</span><span class='line'>    db_conn = environ['DATABASE_URL']
</span><span class='line'>    engine = create_engine(db_conn)
</span><span class='line'>
</span><span class='line'>    metadata=MetaData(bind=engine)
</span><span class='line'>    
</span><span class='line'>    # Definition of the weather table
</span><span class='line'>    weather_table=Table('weather',metadata,
</span><span class='line'>      Column('Insert_Time', DateTime(timezone=True),primary_key=True),
</span><span class='line'>      Column('Temperature', Integer),
</span><span class='line'>      Column('Humidity', Integer),
</span><span class='line'>      Column('PmTen', Integer),
</span><span class='line'>      Column('PmTwoFive', Integer),
</span><span class='line'>    )
</span><span class='line'>
</span><span class='line'>    # Create the table in mylocaldb
</span><span class='line'>    metadata.create_all(checkfirst=True)
</span><span class='line'>
</span><span class='line'>    # Record Insertion
</span><span class='line'>    # First generate an insertion sentense:
</span><span class='line'>    ins = weather_table.insert()
</span><span class='line'>    # Really insert into the Database
</span><span class='line'>    # ins = weather_table.insert().values(Insert_Time=datetime.datetime.utcnow(), Temperature=25, Humidity=75, PmTen=100, PmTwoFive=55)   # Example
</span><span class='line'>    ins = weather_table.insert().values(Insert_Time=datetime.utcnow(), Temperature=Current_Temp, Humidity=Current_Humi, PmTen=int(pm_10_orig), PmTwoFive=int(pm_25_orig))
</span><span class='line'>    # Connect to engine and execute.
</span><span class='line'>    conn = engine.connect()
</span><span class='line'>    result = conn.execute(ins)
</span><span class='line'>
</span><span class='line'>    #return Current_Temp
</span><span class='line'>    return pm_25_orig
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># Every 3 minutes we will see debug information, from heroku log
</span><span class='line'># @periodic_task(run_every=timedelta(minutes=3))
</span><span class='line'># @periodic_task(run_every=timedelta(seconds=3))
</span><span class='line'># def print_fib():
</span><span class='line'>#     #logging.info(fib(30))
</span><span class='line'>#     logging.info("This could be viewed in logging!")
</span></code></pre></td></tr></table></div></figure>


<p>This version use remote service, and it will handle the fetching/updating every 60 minutes.</p>

<h3>Prevent Heroku from Sleeping</h3>

<p>Register a service at <a href="https://uptimerobot.com/">https://uptimerobot.com/</a>, it will automatically ping or get http(s) service from your web apps.</p>

<p>Until now, almost all of the back-end has been set up. We can fetch the data and periodly insert into the database, and our web app will continue to run(Never sleep).  <br/>
Tomorrow we will try to write a beautiful front-end for our webapp.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/37">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/35">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/03/tips-on-veewee-and-vagrant/">Tips on Veewee and Vagrant</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/30/rtl-sdr-steps/">Rtl-sdr Steps</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/30/integrate-freenas/">Integrate FreeNAS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/28/elastistor-data/">Elastistor Data</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/28/re-scan-xenserver-nics/">Re-Scan XenServer NICs</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
