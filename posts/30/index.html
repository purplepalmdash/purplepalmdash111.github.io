
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dash</title>
  <meta name="author" content="Dash">

  
  <meta name="description" content="Using Sysfs The easiest way to do general purpose I/O(gpio) on BBB is through the terminal and shell command. sysfs is the virtual file system which &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://purplepalmdash.github.io/posts/30">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/purplepalmdash/atom.xml" rel="alternate" title="Dash" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//fonts.googleapis.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Dash</a></h1>
  
    <h2>Get busy living, or get busy dying.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/purplepalmdash/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:purplepalmdash.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/13/ebc-exercises-on-bbb-control-led/">EBC Exercises on BBB - Control LED</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-13T16:09:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:09 pm</span></time>
        
         | <a href="/blog/2014/11/13/ebc-exercises-on-bbb-control-led/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Using Sysfs</h3>

<p>The easiest way to do general purpose I/O(gpio) on BBB is through the terminal and shell command.  sysfs is the virtual file system which exposes the drivers for the hardware so you can directly use them.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /sys/class/leds
</span><span class='line'># ls
</span><span class='line'># beaglebone:green:usr0  beaglebone:green:usr1  beaglebone:green:usr2  beaglebone:green:usr3
</span><span class='line'># cd beaglebone\:green\:usr0
</span><span class='line'># cat trigger 
</span><span class='line'>none nand-disk mmc0 mmc1 timer oneshot [heartbeat] backlight gpio cpu0 default-on transient 
</span></code></pre></td></tr></table></div></figure>


<p>If you want to disable the heartbeat:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># echo none &gt; trigger
</span><span class='line'># cat trigger 
</span><span class='line'>[none] nand-disk mmc0 mmc1 timer oneshot heartbeat backlight gpio cpu0 default-on transient 
</span></code></pre></td></tr></table></div></figure>


<p>Turn on/off the led via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># echo 1 &gt; brightness
</span><span class='line'># echo 0 &gt; brightness
</span></code></pre></td></tr></table></div></figure>


<p>More trigger options via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># echo timer&gt;trigger 
</span><span class='line'># cat trigger 
</span><span class='line'>none nand-disk mmc0 mmc1 [timer] oneshot heartbeat backlight gpio cpu0 default-on transient 
</span></code></pre></td></tr></table></div></figure>


<p>Set the deplay frequency:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 100&gt;delay_on
</span><span class='line'>echo 900&gt;delay_off
</span></code></pre></td></tr></table></div></figure>


<h3>Adding Own LED</h3>

<p>Add the connection of LED.   <br/>
P9 Pin1 &ndash;> 220 ohm  &ndash;> LED Negative Pin
P9 Pin 12 -> Led Positive Pin</p>

<p>Pin 12 in the table is shown in table as GPIO1_28. Bank of 32 each, so find the gpio number via:      <br/>
1*32+28=60.</p>

<p>We have to turn this pin on.</p>

<h4>Turn it ON</h4>

<p>export/unexport, turn on/off of the LED via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /sys/class/gpio/
</span><span class='line'>$ echo 60 &gt; export
</span><span class='line'>$ cd gpio60/
</span><span class='line'>$ echo out &gt; direction
</span><span class='line'>$ echo 1 &gt; value
</span><span class='line'>$ echo 0 &gt; value
</span><span class='line'>$ cd ..
</span><span class='line'>$ ls
</span><span class='line'>export  gpio60  gpiochip0  gpiochip32  gpiochip64  gpiochip96  unexport
</span><span class='line'>$ echo 60 &gt; unexport
</span><span class='line'>$ ls -F
</span><span class='line'>export  gpiochip0@  gpiochip32@  gpiochip64@  gpiochip96@  unexport
</span></code></pre></td></tr></table></div></figure>


<h3>Add Own Key</h3>

<p>Connection for the key:  <br/>
P9 Pin 3(3.3V) &ndash;>220 ohm &ndash;> Key 1  <br/>
P9 Pin 42 &ndash;> Key 2  <br/>
Pin 42 is GPIO0_7, then the actual gpio number is Just 7.</p>

<h4>Read Value</h4>

<p>export/unexport, read value via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /sys/class/gpio/
</span><span class='line'># echo 7 &gt; export
</span><span class='line'># cd gpio7/
</span><span class='line'># echo in &gt; direction
</span><span class='line'># cat value
</span><span class='line'># cat value 
</span><span class='line'>0
</span><span class='line'>Hold down the button and see the result: 
</span><span class='line'># cat value 
</span><span class='line'>1
</span></code></pre></td></tr></table></div></figure>


<p>
The script for reading the gpio value:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ./readgpio.sh 7
</span><span class='line'>sh: echo: I/O error
</span><span class='line'>trap: SIGINT: bad trap
</span><span class='line'>__________________________|^^^^^^^^^^^^^^^^^^^^^^^|__________|^^^^^^^^^^|___
</span><span class='line'>___|^^^^^^^|______|^^^^^^^|______|^^^^^^^|______|^^^^^^^|______|^^^^^^^|______|^^^^
</span><span class='line'>^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|____|^^^^^^^^|____|^^|__|^^|_|^^^^^^|___|^^
</span><span class='line'>|__|^|__|^|__|^|__|^^|___|^|_|^|___|^|_|^|_|^|_|^^|_|^|_|^|_|^^|_|^^^^^^^^^^^^^|______|^^^^^^^^^^^^^^^
</span><span class='line'>^^^^^^^^^^^^^^^^^^^^^^^^|____|^^^^^^^^^^^|_____|^^^^^^^^^^^^^^|____|^^^^^^^^^^
</span><span class='line'>^^^|___|^^^^^^^^^^^^|____|^^^^^^^^^^^^|__|^^^^^^^^^^|__|^^^^^^^^|__|^^^^^^^|___|^^^^
</span><span class='line'>^|_____|^^^^^|____|^^^^^^^^^^^^^^^^^^^^^^^|___|^^^^^^^^^^^^^^^^^|___|^^^^^^^^^^^
</span><span class='line'>|_^C
</span></code></pre></td></tr></table></div></figure>


<p>This seems like a little game.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/13/ebc-exercises-on-bbb/">EBC Exercises on BBB</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-13T09:29:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:29 am</span></time>
        
         | <a href="/blog/2014/11/13/ebc-exercises-on-bbb/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Tips on Building Kenrel</h3>

<p>Via following commands you could build the 3.8 kernel for BBB:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone git://github.com/RobertCNelson/linux-dev.git
</span><span class='line'>$ cd linux-dev
</span><span class='line'>$ git checkout origin/am33x-v3.8 -b am33x-v3.8
</span><span class='line'>$ time git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git
</span><span class='line'>$ cp system.sh.sample system.sh
</span><span class='line'>$ diff system.sh*
</span><span class='line'>15c15
</span><span class='line'>&lt; CC=arm-linux-gnueabi-
</span><span class='line'>---
</span><span class='line'>&gt; #CC=arm-linux-gnueabi-
</span><span class='line'>21c21
</span><span class='line'>&lt; LINUX_GIT=~/BeagleBoard/linux-stable/
</span><span class='line'>---
</span><span class='line'>&gt; #LINUX_GIT=/home/user/linux-stable/
</span><span class='line'>31c31
</span><span class='line'>&lt; ZRELADDR=0x80008000
</span><span class='line'>---
</span><span class='line'>&gt; #ZRELADDR=0x80008000
</span><span class='line'>$ ./build_kernel.sh
</span></code></pre></td></tr></table></div></figure>


<h3>U-boot Cross-compile</h3>

<p>Download the U-boot and cross-compile it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># git clone git://git.denx.de/u-boot.git
</span><span class='line'># cd u-boot/
</span><span class='line'># git checkout v2013.07 -b tmp
</span><span class='line'># wget https://raw.github.com/eewiki/u-boot-patches/master/v2013.07/0001-am335x_evm-uEnv.txt-bootz-n-fixes.patch
</span><span class='line'># patch -p1 &lt; 0001-am335x_evm-uEnv.txt-bootz-n-fixes.patch
</span><span class='line'># setpogo # For setting my cross-compiler to arm-linux-gnueabi-
</span><span class='line'># export ARCH=arm
</span><span class='line'># export CROSS_COMPILE=arm-linux-gnueabi-
</span><span class='line'># make
</span></code></pre></td></tr></table></div></figure>


<p>After building you will get MLO and u-boot.img.</p>

<h3>Test on NFS</h3>

<p>Prepare the NFS File System.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir dtbs
</span><span class='line'>tar xzvf 3.8.13-bone53-dtbs.tar.gz -C ./dtbs
</span><span class='line'>cp dtbs/am335x-boneblack.dtb /srv/tftp/
</span><span class='line'>cp 3.8.13-bone53.zImage /srv/tftp/
</span><span class='line'>mkimage -A arm -O linux -T kernel -C none -a 0x80008000 -e 0x80008000 -n "Linux" -d /srv/tftp/3.8.13-bone53.zImage  /srv/tftp/uImage
</span><span class='line'>tar xJvf ubuntu-14.04-console-armhf-2014-08-13.tar.xz -C /srv/nfs4/
</span><span class='line'>cd /srv/nfs4/ubuntu-14.04-console-armhf-2014-08-13
</span><span class='line'>tar xvf armhf-rootfs-ubuntu-trusty.tar -C ../Ubuntu_fs/
</span><span class='line'>chmod 777 -R Ubuntu_fs/
</span></code></pre></td></tr></table></div></figure>


<p>Then boot the system from U-boot Via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setenv ipaddr 192.168.1.16
</span><span class='line'>setenv serverip 192.168.1.221
</span><span class='line'>tftpboot ${fdtaddr} am335x-boneblack.dtb
</span><span class='line'>tftpboot ${kloadaddr} uImage
</span><span class='line'>setenv bootargs console=ttyO0,115200n8 root=/dev/nfs rootfstype=nfs rw nfsroot=192.168.1.221:/srv/nfs4/Ubuntu_fs ip=192.168.1.1 
</span><span class='line'>bootm ${kloadaddr} - ${fdtaddr}
</span></code></pre></td></tr></table></div></figure>


<p>Now boot the BBB and we got the ssh enabled, via ssh ubuntu@192.168.1.1, password is temppwd.</p>

<p>Sometimes you will meet sudo problem, just chown and chmod is OK</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chmod 4755 some_related_file
</span><span class='line'># chown root some_related_file
</span></code></pre></td></tr></table></div></figure>


<p>
Since NFS gonna the write priviledge error, go back for SD card.</p>

<h3>SD Card</h3>

<p>FileSystem Preparation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export DISK=/dev/mmcblk0
</span><span class='line'>$ dd if=/dev/zero of=${DISK} bs=1M count=10
</span><span class='line'>$ dd if=./u-boot/MLO of=${DISK} count=1 seek=1 conv=notrunc bs=128k
</span><span class='line'>$ dd if=./u-boot/u-boot.img of=${DISK} count=2 seek=1 conv=notrunc bs=384k
</span><span class='line'> sfdisk --in-order --Linux --unit M ${DISK} &lt;&lt;-__EOF__
</span><span class='line'>1,,0x83,*
</span><span class='line'>__EOF__
</span><span class='line'>$ mkfs.ext4 /dev/mmcblk0p1 -L rootfs
</span></code></pre></td></tr></table></div></figure>


<p>Copy the Operating system into the sd card partition 1, later we will use /mnt for mounting the partition 1:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mount /dev/mmcblk0p1 /mnt
</span><span class='line'># cd ubuntu-14.04.1-console-armhf-2014-10-29
</span><span class='line'># tar xvf armhf-rootfs-ubuntu-trusty.tar -C /mnt/
</span><span class='line'># sync
</span></code></pre></td></tr></table></div></figure>


<p>Now install the kernel image into the ubuntu system. Imagine your SD is mount to /mnt/</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp /media/y/embedded/BBB/EBC/3.8Kernel/linux-dev/deploy/3.8.13-bone53.zImage /mnt/boot/vmlinuz-3.8.13-bone53
</span><span class='line'>tar xzvf /media/y/embedded/BBB/EBC/3.8Kernel/linux-dev/deploy/3.8.13-bone53-dtbs.tar.gz -C /mnt/boot/dtbs/
</span></code></pre></td></tr></table></div></figure>


<p>Now create the following uEnv.txt located in /mnt/boot/ and /mnt/:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>##This will work with: Angstrom's 2013.06.20 u-boot.
</span><span class='line'> 
</span><span class='line'>loadaddr=0x82000000
</span><span class='line'>fdtaddr=0x88000000
</span><span class='line'>rdaddr=0x88080000
</span><span class='line'> 
</span><span class='line'>initrd_high=0xffffffff
</span><span class='line'>fdt_high=0xffffffff
</span><span class='line'>
</span><span class='line'>console=ttyO0,115200n8
</span><span class='line'>mmcroot=/dev/mmcblk0p1 ro
</span><span class='line'> 
</span><span class='line'>loadximage=load mmc 0:1 ${loadaddr} /boot/vmlinuz-3.8.13-bone53
</span><span class='line'>loadxfdt=load mmc 0:1 ${fdtaddr} /boot/dtbs/3.8.13-bone53/am335x-boneblack.dtb
</span><span class='line'>loadxrd=load mmc 0:1 ${rdaddr} /boot/initrd.img-${uname_r}; setenv rdsize ${filesize}
</span><span class='line'>loaduEnvtxt=load mmc 0:1 ${loadaddr} /boot/uEnv.txt ; env import -t ${loadaddr} ${filesize};
</span><span class='line'>loadall=run loaduEnvtxt; run loadximage; run loadxfdt;
</span><span class='line'> 
</span><span class='line'>mmcargs=setenv bootargs console=tty0 console=${console} ${optargs} ${cape_disable} ${cape_enable} root=${mmcroot} rootfstype=${mmcrootfstype} ${cmdline}
</span><span class='line'> 
</span><span class='line'>uenvcmd=run loadall; run mmcargs; bootz ${loadaddr} - ${fdtaddr};
</span><span class='line'>optargs="debug"
</span></code></pre></td></tr></table></div></figure>


<p>Enable the dhcp, /mnt/etc/network/interfaces:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'> 
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet dhcp
</span></code></pre></td></tr></table></div></figure>


<p>Enable the serial port:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /mnt/etc/init/serial.conf
</span><span class='line'>start on stopped rc RUNLEVEL=[2345]
</span><span class='line'>stop on runlevel [!2345]
</span><span class='line'> 
</span><span class='line'>respawn
</span><span class='line'>exec /sbin/getty 115200 ttyO0
</span></code></pre></td></tr></table></div></figure>


<p>Now restart and you got the 3.8 kernel enabled, so next time if you want to change the kernel, simply change the uEnv.txt file is OK.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ubuntu@arm:/boot$ uname -a
</span><span class='line'>Linux arm 3.8.13-bone53 #1 SMP Tue Nov 11 18:40:19 CST 2014 armv7l armv7l armv7l GNU/Linux
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/12/server-performance/">Server Performance</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-12T12:28:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:28 pm</span></time>
        
         | <a href="/blog/2014/11/12/server-performance/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Get the UnixBench and run</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://byte-unixbench.googlecode.com/files/UnixBench5.1.3.tgz
</span><span class='line'>tar xvf UnixBench5.1.3.tgz 
</span><span class='line'>cd UnixBench
</span><span class='line'>./Run
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>Result:</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/10/openwrt-on-bbb-3/">OpenWRT on BBB(3)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-10T11:40:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:40 am</span></time>
        
         | <a href="/blog/2014/11/10/openwrt-on-bbb-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Building Guideline</h3>

<p>I found a openwrt-bbb  repository on github, so just download it and build:   <br/>
<a href="https://github.com/nc543/openwrt-bbb/wiki">https://github.com/nc543/openwrt-bbb/wiki</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/nc543/openwrt-bbb.git
</span><span class='line'>$ cd openwrt-bbb
</span><span class='line'>$ make
</span></code></pre></td></tr></table></div></figure>


<p>When building you will meet the openssl download error, simply change the version from 1.0.1i to 1.0.1h or other version is OK.   <br/>
I change this because in recent days the download page of openssl.org is not stable, so the download procedure will directly download the tar files from openwrt.org, while on openwrt.org it holds the 1.0.1h version rather than 1.0.1i version. If you could get 1.0.1i version from openssl.org, then you needn&rsquo;t do these changes.</p>

<h3>Verification</h3>

<p>As the author said, directly use dd for copying the files into the SD card, but I failed.</p>

<h4>SD Card</h4>

<p>Use following command for write the image to the SD card:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo dd if=bin/omap/openwrt-omap-combined-vfat-ext4.img of=/dev/sdb
</span><span class='line'>$ sync
</span></code></pre></td></tr></table></div></figure>


<p>Then we have to do following operation in order to change the bootup sequence and parameters:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mount /dev/mmcblk0p1 /mnt
</span><span class='line'>$ cp openwrt-omap-zImage /mnt/
</span><span class='line'>$ cp dtbs/am335x-boneblack.dtb /mnt/dtbs/
</span><span class='line'>$ vim uEnv.txt
</span><span class='line'>kernel_file=zImage
</span><span class='line'>fdtfile=am335x-boneblack.dtb
</span><span class='line'>
</span><span class='line'>loadzimage=load mmc ${mmcdev}:${mmcpart} ${loadaddr} ${kernel_file}
</span><span class='line'>loadfdt=load mmc ${mmcdev}:${mmcpart} ${fdtaddr} /dtbs/${fdtfile}
</span><span class='line'>
</span><span class='line'>console=ttyO0,115200n8
</span><span class='line'>mmcroot=/dev/mmcblk0p2 ro
</span><span class='line'>mmcrootfstype=ext4 rootwait
</span><span class='line'>
</span><span class='line'>mmcargs=setenv bootargs console=${console} root=${mmcroot} rootfstype=${mmcrootfstype} ${optargs}
</span><span class='line'>
</span><span class='line'>uenvcmd=run loadzimage; run loadfdt; run mmcargs; bootz ${loadaddr} - ${fdtaddr}
</span><span class='line'>
</span><span class='line'>optargs="debug init=/etc/preinit"
</span></code></pre></td></tr></table></div></figure>


<p>With above modification you could directly use the SD card for booting the BBB and use OpenWRT!</p>

<h4>NFS</h4>

<p>Create NFS via following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@TrustyArch omap]# pwd
</span><span class='line'>/media/y/embedded/BBB/OpenWRT/openwrt-bbb/bin/omap
</span><span class='line'>[root@TrustyArch omap]# cp openwrt-omap-zImage /srv/tftp/
</span><span class='line'>[root@TrustyArch omap]# cp dtbs/am335x-boneblack.dtb /srv/tftp/
</span><span class='line'>[root@TrustyArch omap]# mkimage -A arm -O linux -T kernel -C none -a 0x80008000 -e 0x80008000 -n "Linux" -d /srv/tftp/openwrt-omap-zImage /srv/tftp/uImage
</span><span class='line'>[root@TrustyArch omap]# rm -rf /srv/nfs4/BBBrootfs/
</span><span class='line'>[root@TrustyArch omap]# mkdir -p /srv/nfs4/BBBrootfs
</span><span class='line'>[root@TrustyArch omap]# tar xzvf openwrt-omap-Default-rootfs.tar.gz -C /srv/nfs4/BBBrootfs/
</span></code></pre></td></tr></table></div></figure>


<p>Wow, start from NFS got failed for:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[    1.262675] VFS: Cannot open root device "nfs" or unknown-block(0,255): error -6
</span><span class='line'>[    1.270603] Please append a correct "root=" boot option; here are the available partitions:
</span><span class='line'>[    1.279456] b300         1875968 mmcblk0  driver: mmcblk
</span><span class='line'>[    1.285084]   b301           72261 mmcblk0p1 00000000-01
</span><span class='line'>[    1.290680]   b302         1799280 mmcblk0p2 00000000-02
</span><span class='line'>[    1.296300] b310            1024 mmcblk0boot1  (driver?)
</span><span class='line'>[    1.301895] b308            1024 mmcblk0boot0  (driver?)
</span><span class='line'>[    1.307513] Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,255)
</span></code></pre></td></tr></table></div></figure>


<p>Later I will investigate this problem.</p>

<h3>Re-Compile Kernel</h3>

<p>First we enable the kernel .config support, so later we could directly output its .config for newer version:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ make menuconfig
</span><span class='line'>General setup
</span><span class='line'>[*] Kernel .config support
</span><span class='line'>[*] Enable access to .config through /proc/config.gz
</span></code></pre></td></tr></table></div></figure>


<p>Enable the nfs support:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Device Driver
</span><span class='line'>[*] Block devices
</span><span class='line'>[*] Network block device support
</span><span class='line'>Networking options
</span><span class='line'>[*] IP: kernel level autoconfiguration
</span><span class='line'>[*]   IP: DHCP support
</span><span class='line'>[*]   IP: BOOTP support
</span><span class='line'>[*]
</span><span class='line'>File Systems
</span><span class='line'>[*] Netwrok File Systems
</span></code></pre></td></tr></table></div></figure>


<p>The detailed NFS client configuration is listed as following image:  <br/>
<img src="/images/nfsconfiguration.jpg" alt="/images/nfsconfiguration.jpg" /></p>

<p>Save the configuration and re-compile the kernel:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ make V=99 -j4
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/10/enable-bluetooth-headset-on-archlinux/">Enable Bluetooth Headset on ArchLinux</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-10T09:33:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:33 am</span></time>
        
         | <a href="/blog/2014/11/10/enable-bluetooth-headset-on-archlinux/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since my operating system upgraded, I have to re-set my bluetooth headset. I use A2DP via Bluez5/Pulseaudio.</p>

<h3>Installation</h3>

<p>First install following packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># pacman -S pulseaudio-alsa bluez bluez-libs bluez-utils
</span></code></pre></td></tr></table></div></figure>


<p>Then start the service via systemd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># systemctl start bluetooth
</span></code></pre></td></tr></table></div></figure>


<h3>Configuration</h3>

<p>I use an expect script for automatically connect to my MW600 and play:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/usr/bin/expect</span>
</span><span class='line'>
</span><span class='line'><span class="c"># This script is for automatically scan my bluetooth headset, which is Sony-Errison mw-600</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Timeout should be very short in local</span>
</span><span class='line'><span class="c"># set timeout 3</span>
</span><span class='line'>
</span><span class='line'>spawn ssh Trusty@localhost -Y
</span><span class='line'>expect <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;yes/no&quot;</span> <span class="o">{</span>
</span><span class='line'>                    send <span class="s2">&quot;yes\n&quot;</span>
</span><span class='line'>                                exp_continue
</span><span class='line'>                                    <span class="o">}</span>
</span><span class='line'>            <span class="s2">&quot;assword&quot;</span> <span class="o">{</span>
</span><span class='line'>                        send <span class="s2">&quot;xxxxxxx!\n&quot;</span>
</span><span class='line'>                                <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>expect <span class="err">$</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Now we are in the controlled session, run bluetooth related commands.</span>
</span><span class='line'>send <span class="s2">&quot;bluetoothctl\r&quot;</span>
</span><span class='line'>expect <span class="c">#</span>
</span><span class='line'>send <span class="s2">&quot;power on\r&quot;</span>
</span><span class='line'>expect <span class="s2">&quot;yes&quot;</span>
</span><span class='line'>send <span class="s2">&quot;agent on\r&quot;</span>
</span><span class='line'>expect <span class="c">#</span>
</span><span class='line'>send <span class="s2">&quot;default-agent\r&quot;</span>
</span><span class='line'>expect <span class="c">#</span>
</span><span class='line'>send <span class="s2">&quot;connect 8C:64:22:5F:FF:BD\r&quot;</span>
</span><span class='line'>expect <span class="s2">&quot;connection successful&quot;</span>
</span><span class='line'><span class="c"># Now exit the bluetoothctl</span>
</span><span class='line'>send <span class="s2">&quot;exit\r&quot;</span>
</span><span class='line'>expect <span class="err">$</span>
</span><span class='line'>
</span><span class='line'><span class="c"># After execute the command in this ssh session, simply exit. </span>
</span><span class='line'>send <span class="s2">&quot;exit\r&quot;</span>
</span><span class='line'>expect <span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Everytime I want to use bluetooth headset, just run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> <span class="nv">$ </span>/home/Trusty/auto/autobluetooth.sh <span class="o">&amp;&amp;</span> pavucontrol <span class="p">&amp;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Flash Content</h3>

<p>Install following package for let alsa use pulseaudio:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo pacman -S pulseaudio-alsa
</span></code></pre></td></tr></table></div></figure>


<p>Restart opera(or other browser which calls flash), now your sound will be played via bluetooth.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/09/wei-bbbbian-yi-nei-he-he-linux/">为BBB编译内核和Linux</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-09T10:13:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:13 am</span></time>
        
         | <a href="/blog/2014/11/09/wei-bbbbian-yi-nei-he-he-linux/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>因为原文是英文的缘故，所以这里就直接用中文翻译，并把编译时的步骤和注意事项记载下来。    <br/>
主要参考了:   <br/>
<a href="https://eewiki.net/display/linuxonarm/BeagleBone+Black">https://eewiki.net/display/linuxonarm/BeagleBone+Black</a>    <br/>
All of the files and folder are located under <code>$BBB/201411</code> folder.</p>

<h3>交叉编译链准备</h3>

<p>下载、设置交叉编译链:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget -c https://releases.linaro.org/14.09/components/toolchain/binaries/gcc-linaro-arm-linux-gnueabihf-4.9-2014.09_linux.tar.xz
</span><span class='line'>tar xf gcc-linaro-arm-linux-gnueabihf-4.9-2014.09_linux.tar.xz
</span><span class='line'>export CC=`pwd`/gcc-linaro-arm-linux-gnueabihf-4.9-2014.09_linux/bin/arm-linux-gnueabihf-
</span></code></pre></td></tr></table></div></figure>


<p>测试交叉编译链:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ${CC}gcc --version
</span><span class='line'>arm-linux-gnueabihf-gcc (crosstool-NG linaro-1.13.1-4.9-2014.09 - Linaro GCC 4.9-2014.09) 4.9.2 20140904 (prerelease)
</span><span class='line'>Copyright (C) 2014 Free Software Foundation, Inc.
</span><span class='line'>This is free software; see the source for copying conditions.  There is NO
</span><span class='line'>warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</span></code></pre></td></tr></table></div></figure>


<h3>编译U-Boot</h3>

<p>下载U-Boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git://git.denx.de/u-boot.git
</span><span class='line'>cd u-boot/
</span><span class='line'>git checkout v2014.10 -b tmp
</span></code></pre></td></tr></table></div></figure>


<p>下载、加载补丁:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget -c https://raw.githubusercontent.com/eewiki/u-boot-patches/master/v2014.10/0001-am335x_evm-uEnv.txt-bootz-n-fixes.patch
</span><span class='line'>patch -p1 &lt; 0001-am335x_evm-uEnv.txt-bootz-n-fixes.patch
</span></code></pre></td></tr></table></div></figure>


<p>编译U-Boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># make ARCH=arm CROSS_COMPILE=${CC} distclean && make ARCH=arm CROSS_COMPILE=${CC} am335x_evm_defconfig && make ARCH=arm CROSS_COMPILE=${CC}
</span></code></pre></td></tr></table></div></figure>


<h3>编译内核</h3>

<p>下面的步骤将编译出内核和内核模块，编译完成后全部被拷贝到deploy文件夹中。</p>

<h4>主线内核</h4>

<p>编译前准备， 在Ubuntu 12.04，安装下列包:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install bc build-essential device-tree-compiler fakeroot lzma lzop man-db u-boot-tools libncurses5-dev ia32-libs wget
</span></code></pre></td></tr></table></div></figure>


<p>下载:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/RobertCNelson/bb-kernel.git
</span><span class='line'>$ cd bb-kernel/
</span></code></pre></td></tr></table></div></figure>


<p>切换到v3.8.x分支(支持全面):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git checkout origin/am33x-v3.8 -b tmp
</span></code></pre></td></tr></table></div></figure>


<p>切换到v3.17.x分支(SGX， 更好的usb和Ethernet支持), SGX，硬件加速。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git checkout origin/am33x-v3.17 -b tmp
</span></code></pre></td></tr></table></div></figure>


<p>编译：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./build_kernel.sh
</span></code></pre></td></tr></table></div></figure>


<h4>TI内核</h4>

<p>完整编译步骤如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/RobertCNelson/ti-linux-kernel-dev/
</span><span class='line'>cd ti-linux-kernel-dev/
</span><span class='line'>git checkout origin/ti-linux-3.14.y -b tmp
</span><span class='line'>./build_kernel.sh
</span></code></pre></td></tr></table></div></figure>


<h3>准备文件系统</h3>

<h4>Ubuntu</h4>

<p>下载并解压Ubuntu文件系统:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget -c https://rcn-ee.net/deb/minfs/trusty/ubuntu-14.04-minimal-armhf-2014-07-07.tar.xz
</span><span class='line'>tar xf ubuntu-14.04-minimal-armhf-2014-07-07.tar.xz
</span></code></pre></td></tr></table></div></figure>


<h3>写入存储卡</h3>

<h4>分区准备</h4>

<p>准备的TF卡容量为8G， 使用lsblk可以用于查看device id。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ lsblk
</span><span class='line'>NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
</span><span class='line'>mmcblk0     179:0    0   7.4G  0 disk 
</span><span class='line'>├─mmcblk0p1 179:1    0    48M  0 part 
</span><span class='line'>└─mmcblk0p2 179:2    0   7.4G  0 part 
</span></code></pre></td></tr></table></div></figure>


<p>备份好TF卡上文件内容后，对其重新进行分区，这里使用fdisk移除掉所有分区后重新分成一个区，而后格式化为ext4分区。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># export DISK=/dev/mmcblk0
</span><span class='line'># sudo dd if=/dev/zero of=${DISK} bs=1M count=10
</span><span class='line'># sudo dd if=./u-boot/MLO of=${DISK} count=1 seek=1 conv=notrunc bs=128k
</span><span class='line'># sudo dd if=./u-boot/u-boot.img of=${DISK} count=2 seek=1 conv=notrunc bs=384k
</span><span class='line'># sudo sfdisk --in-order --Linux --unit M ${DISK} &lt;&lt;-__EOF__
</span><span class='line'>1,,0x83,*
</span><span class='line'>__EOF__
</span><span class='line'># sudo mkfs.ext4 /dev/mmcblk0p1 -L rootfs
</span></code></pre></td></tr></table></div></figure>


<p>现在查看lsblk的结果应该是这样:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mmcblk0     179:0    0   7.4G  0 disk 
</span><span class='line'>└─mmcblk0p1 179:1    0   7.4G  0 part 
</span></code></pre></td></tr></table></div></figure>


<h4>写入</h4>

<p>我们将使用eMMC自有的BootLoader, 所以在/media/rootfs中使用下列内容到uEnv.txtt：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>##This will work with: Angstrom's 2013.06.20 u-boot.
</span><span class='line'> 
</span><span class='line'>loadaddr=0x82000000
</span><span class='line'>fdtaddr=0x88000000
</span><span class='line'>rdaddr=0x88080000
</span><span class='line'> 
</span><span class='line'>initrd_high=0xffffffff
</span><span class='line'>fdt_high=0xffffffff
</span><span class='line'> 
</span><span class='line'>loadximage=load mmc 0:1 ${loadaddr} /boot/vmlinuz-${uname_r}
</span><span class='line'>loadxfdt=load mmc 0:1 ${fdtaddr} /boot/dtbs/${uname_r}/${fdtfile}
</span><span class='line'>loadxrd=load mmc 0:1 ${rdaddr} /boot/initrd.img-${uname_r}; setenv rdsize ${filesize}
</span><span class='line'>loaduEnvtxt=load mmc 0:1 ${loadaddr} /boot/uEnv.txt ; env import -t ${loadaddr} ${filesize};
</span><span class='line'>loadall=run loaduEnvtxt; run loadximage; run loadxfdt;
</span><span class='line'> 
</span><span class='line'>mmcargs=setenv bootargs console=tty0 console=${console} ${optargs} ${cape_disable} ${cape_enable} root=${mmcroot} rootfstype=${mmcrootfstype} ${cmdline}
</span><span class='line'> 
</span><span class='line'>uenvcmd=run loadall; run mmcargs; bootz ${loadaddr} - ${fdtaddr};
</span></code></pre></td></tr></table></div></figure>


<p>解压缩下载好的rootfs文件到SD卡分区：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ tar xvf armhf-rootfs-ubuntu-trusty.tar -C /media/rootfs/
</span><span class='line'>$ sync
</span></code></pre></td></tr></table></div></figure>


<p>拷贝kernel到SD卡分区:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cp /media/y/embedded/BBB/201411/deploy/3.14.23-ti-r32.zImage ./vmlinuz-3.14.23-ti-r32
</span></code></pre></td></tr></table></div></figure>


<p>拷贝Kernel Device Tree二进制文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tar xvf /media/y/embedded/BBB/201411/deploy/3.14.23-ti-r32-dtbs.tar.gz -C /media/rootfs/boot/dtbs/${kernel_version}/
</span></code></pre></td></tr></table></div></figure>


<p>拷贝内核模块:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># tar xfv /media/y/embedded/BBB/201411/deploy/3.14.23-ti-r32-modules.tar.gz -C /media/rootfs/
</span></code></pre></td></tr></table></div></figure>


<p>配置fstab文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo sh -c "echo '/dev/mmcblk0p1  /  auto  errors=remount-ro  0  1' &gt;&gt; /media/rootfs/etc/fstab"
</span></code></pre></td></tr></table></div></figure>


<p>配置网络：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vim /media/rootfs/etc/network/interfaces
</span><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'> 
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet dhcp
</span></code></pre></td></tr></table></div></figure>


<p>配置串口登录：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo vim /media/rootfs/etc/init/serial.conf
</span><span class='line'>start on stopped rc RUNLEVEL=[2345]
</span><span class='line'>stop on runlevel [!2345]
</span><span class='line'> 
</span><span class='line'>respawn
</span><span class='line'>exec /sbin/getty 115200 ttyO0
</span></code></pre></td></tr></table></div></figure>


<p>进入U-boot后更改一下配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>U-Boot# setenv mmcroot /dev/mmcblk0p1 ro
</span><span class='line'>U-Boot# boot
</span></code></pre></td></tr></table></div></figure>


<p>默认用户名，密码分别是: root/temppwd   <br/>
进入系统以后查看系统信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ubuntu@arm:~$ uname -a 
</span><span class='line'>Linux arm 3.14.23-ti-r32 #1 SMP PREEMPT Sun Nov 9 04:19:25 UTC 2014 armv7l armv7l armv7l GNU/Linux
</span><span class='line'>ubuntu@arm:~$ cat /etc/issue
</span><span class='line'>Ubuntu 14.04 LTS \n \l
</span><span class='line'>
</span><span class='line'>default username:password is [ubuntu:temppwd]
</span><span class='line'>ubuntu@arm:~$ ifconfig
</span><span class='line'>eth0      Link encap:Ethernet  HWaddr 90:59:af:65:d9:8c  
</span><span class='line'>          inet addr:10.0.0.122  Bcast:10.0.0.255  Mask:255.255.255.0
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/08/install-new-image-to-sd-card-for-bbb/">Install New Image to Sd Card for BBB</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-08T16:37:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:37 pm</span></time>
        
         | <a href="/blog/2014/11/08/install-new-image-to-sd-card-for-bbb/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Mainly for installing the OpenWRT system on the BBB, following is the steps:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># zImage
</span><span class='line'>cp /media/y/embedded/BBB/svnco/trunk/bin/omap/openwrt-omap-zImage ./zImage
</span><span class='line'># dtb file
</span><span class='line'>cp /media/y/embedded/BBB/svnco/trunk/bin/omap/dtbs/am335x-boneblack.dtb ./dtbs/
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/08/setting-nfs-server-on-ubuntu-container/">Setting NFS Server on Ubuntu Container</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-08T10:17:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:17 am</span></time>
        
         | <a href="/blog/2014/11/08/setting-nfs-server-on-ubuntu-container/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since there are some strange problems in my ArchLinux(Physical Machine), its nfs server will be ignored by the embedded board, while my joggler which runs ubuntu12.04 acts OK. So I try to find a sufficient way for dealing with this issue.</p>

<h3>Container Configuration</h3>

<p>I&rsquo;ve installed <code>Ubuntu_Container</code> which holds 12.04 in my physical machine. So the nfs server would be configured in this container.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get update
</span><span class='line'>$ sudo apt-get install nfs-kernel-server portmap nfs-common
</span></code></pre></td></tr></table></div></figure>


<p>Then edit the /srv/nfs4, and export its configuration in /etc/exports:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/srv/nfs4 *(rw,sync,no_root_squash,no_subtree_check)
</span></code></pre></td></tr></table></div></figure>


<p>Everytime you want to start the nfs service, just type:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ /etc/init.d/nfs-kernel-server restart
</span><span class='line'>$ /etc/init.d/portmap restart
</span></code></pre></td></tr></table></div></figure>


<h3>Test</h3>

<p>Client run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo mount -t nfs 1xx.xx.xx.xx:/srv/nfs4/ /mnt
</span></code></pre></td></tr></table></div></figure>


<h3>Trouble-Shooting</h3>

<p>The correct parameter for mounting the nfs server is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setenv bootargs console=ttyO0,115200n8 root=/dev/nfs rw nfsroot=192.168.1.221:/srv/nfs4/BBBrootfs ip=192.168.1.1
</span></code></pre></td></tr></table></div></figure>


<p>Then you won&rsquo;t have other problems, even the physical machine could also use the nfs filesystem.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/06/automatically-filter-spambot-on-digitalocean/">Automatically Filter SpamBot on DigitalOcean</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-06T15:41:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:41 pm</span></time>
        
         | <a href="/blog/2014/11/06/automatically-filter-spambot-on-digitalocean/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Setup iptables</h3>

<p>Install iptables-persistent, so that the iptables rules will be saved even reboot the machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get update
</span><span class='line'># apt-get install iptables-persistent
</span></code></pre></td></tr></table></div></figure>


<h3>Script for manually add iptables</h3>

<p>Use following scritp for manually add iptables items:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="c"># This script runs once per hour, Directly remove the ips which post comments</span>
</span><span class='line'><span class="c"># more than 4 times per hour. And who comments less than 3 times we should sent</span>
</span><span class='line'><span class="c"># its ip to old ips file. The old ips files will be used for analyse once per day</span>
</span><span class='line'><span class="c"># The run frequency is controlled by  crontab.   </span>
</span><span class='line'>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="c"># Before Start, empty the deathSentence</span>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'>&gt;/var/log/apache2/deathSentence
</span><span class='line'>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="c"># First cat the file and try to found the bot ip list</span>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="c"># Pipe 1: The one who called POST method should be monitored</span>
</span><span class='line'><span class="c"># Pipe 2: Get the ip address who called POST method.</span>
</span><span class='line'><span class="c"># Pipe 3: Sort the ip addresses. </span>
</span><span class='line'><span class="c"># Pipe 4: Calculate the repeated times. First column, times; Second column, ip address.</span>
</span><span class='line'><span class="c"># Pipe 5: Sort via first column(times) numerically(Not textly!) .</span>
</span><span class='line'><span class="c"># Pipe 6: If the Call POST time bigger than 4 in one hour, catch it!</span>
</span><span class='line'><span class="c"># Pipe 7: Yes we caught this thief! Get its ipaddr.</span>
</span><span class='line'><span class="c"># Write these thieves into the death sentence</span>
</span><span class='line'>cat /var/log/apache2/other_vhosts_access.log <span class="p">|</span> grep <span class="s2">&quot;POST&quot;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq --count <span class="p">|</span> sort -n <span class="p">|</span> awk <span class="s1">&#39;$1&gt;4&#39;</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">&#39;print $2&#39;</span><span class="o">}</span>&gt;/var/log/apache2/deathSentence
</span><span class='line'><span class="c"># Those who comments but equal or more than 4 times will be append to wishList</span>
</span><span class='line'>cat /var/log/apache2/other_vhosts_access.log <span class="p">|</span> grep <span class="s2">&quot;POST&quot;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq --count <span class="p">|</span> sort -n <span class="p">|</span> awk <span class="s1">&#39;$1&lt;5&#39;</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">&#39;print $2&#39;</span><span class="o">}</span>&gt;&gt;/var/log/apache2/wishList
</span><span class='line'>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="c"># Second we add this bot ip list into the netfilter</span>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="k">for</span> i in <span class="sb">`</span>cat /var/log/apache2/deathSentence<span class="sb">`</span>
</span><span class='line'><span class="k">do</span>
</span><span class='line'>  <span class="c">#echo $i</span>
</span><span class='line'>  iptables -A INPUT -s <span class="nv">$i</span> -j DROP
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="c"># Finally empty the other_vhosts_access.log</span>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'>&gt;/var/log/apache2/other_vhosts_access.log
</span></code></pre></td></tr></table></div></figure>


<p>Oh, also add myself into the blacklist, so un-lock me:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>iptables -A INPUT -s 1xx.x.x.x -j ACCEPT
</span></code></pre></td></tr></table></div></figure>


<p>Since those wishList should also be cared, wrote following scripts for judge, every 4 hours will be make a decision.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="c"># This script runs once 4 hours, used for processing the /var/log/apache2/wishList</span>
</span><span class='line'><span class="c"># ip address lists. Those bad guys who were in wishList, if their total appear times</span>
</span><span class='line'><span class="c"># bigger than 4 times, will be added to iptable&#39;s drop rules.</span>
</span><span class='line'>&gt;/var/log/apache2/deathSentence_4hour
</span><span class='line'>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="c"># Read the ip list and store those bad guys into deathSentence_4hour</span>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'>cat /var/log/apache2/wishList <span class="p">|</span> sort <span class="p">|</span> uniq --count <span class="p">|</span> sort -n <span class="p">|</span> awk <span class="s1">&#39;$1&gt;4&#39;</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">&#39;$print $2&#39;</span><span class="o">}</span>&gt;/var/log/apache2/deathSentence_4hour
</span><span class='line'>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="c"># Now you got the bad guys, add them into iptables</span>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="k">for</span> i in <span class="sb">`</span>cat /var/log/apache2/deathSentence_4hour<span class="sb">`</span>
</span><span class='line'><span class="k">do</span>
</span><span class='line'>        <span class="c">#echo $i</span>
</span><span class='line'>        iptables -A INPUT -s <span class="nv">$i</span> -j DROP
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'><span class="c"># Finally empty the wishList</span>
</span><span class='line'><span class="c">######################################################</span>
</span><span class='line'>&gt;/var/log/apache2/wishList
</span></code></pre></td></tr></table></div></figure>


<h3>Crontab It!</h3>

<p>Run <code>auto_add_bot_ip.sh</code> at every minute 0 of 1 hour, then run <code>auto_judge_wishlist.sh</code> at every minute 10 of every 4 hours.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># m h  dom mon dow   command</span>
</span><span class='line'><span class="m">0</span> */1 * * * /root/code/auto_add_bot_ip.sh
</span><span class='line'><span class="m">10</span> */4 * * * /root/code/auto_judge_wishlist.sh
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/06/manually-delete-spam-comments-for-wp/">Manually Delete Spam Comments for WP</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-06T12:21:00+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:21 pm</span></time>
        
         | <a href="/blog/2014/11/06/manually-delete-spam-comments-for-wp/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Login to mysql commandline via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mysql -uroot -p
</span><span class='line'>mysql&gt; use wordpress
</span><span class='line'>.........
</span><span class='line'>Database changed
</span></code></pre></td></tr></table></div></figure>


<p>Display the COLUMNS of wp_comments:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; SHOW COLUMNS FROM wp_comments;
</span><span class='line'>+----------------------+---------------------+------+-----+---------------------+----------------+
</span><span class='line'>| Field                | Type                | Null | Key | Default             | Extra          |
</span><span class='line'>+----------------------+---------------------+------+-----+---------------------+----------------+
</span><span class='line'>| comment_ID           | bigint(20) unsigned | NO   | PRI | NULL                | auto_increment |
</span><span class='line'>| comment_post_ID      | bigint(20) unsigned | NO   | MUL | 0                   |                |
</span><span class='line'>| comment_author       | tinytext            | NO   |     | NULL                |                |
</span><span class='line'>| comment_author_email | varchar(100)        | NO   | MUL |                     |                |
</span><span class='line'>| comment_author_url   | varchar(200)        | NO   |     |                     |                |
</span><span class='line'>| comment_author_IP    | varchar(100)        | NO   |     |                     |                |
</span><span class='line'>| comment_date         | datetime            | NO   |     | 0000-00-00 00:00:00 |                |
</span><span class='line'>| comment_date_gmt     | datetime            | NO   | MUL | 0000-00-00 00:00:00 |                |
</span><span class='line'>| comment_content      | text                | NO   |     | NULL                |                |
</span><span class='line'>| comment_karma        | int(11)             | NO   |     | 0                   |                |
</span><span class='line'>| comment_approved     | varchar(20)         | NO   | MUL | 1                   |                |
</span><span class='line'>| comment_agent        | varchar(255)        | NO   |     |                     |                |
</span><span class='line'>| comment_type         | varchar(20)         | NO   |     |                     |                |
</span><span class='line'>| comment_parent       | bigint(20) unsigned | NO   | MUL | 0                   |                |
</span><span class='line'>| user_id              | bigint(20) unsigned | NO   |     | 0                   |                |
</span><span class='line'>| comment_mail_notify  | tinyint(4)          | NO   |     | 0                   |                |
</span><span class='line'>+----------------------+---------------------+------+-----+---------------------+----------------+
</span><span class='line'>16 rows in set (0.00 sec)
</span></code></pre></td></tr></table></div></figure>


<p>If you want to display the last 30 minutes' comments:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; SELECT * FROM wp_comments WHERE comment_date  BETWEEN TIMESTAMPADD(MINUTE, -30, NOW()) AND NOW();
</span></code></pre></td></tr></table></div></figure>


<p>Delete last 30 minutes' comments:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; DELETE FROM wp_comments WHERE comment_date  BETWEEN TIMESTAMPADD(MINUTE, -30, NOW()) AND NOW();
</span><span class='line'>Query OK, 536 rows affected (0.18 sec)
</span></code></pre></td></tr></table></div></figure>


<p>Select and Delete 10 day&rsquo;s comments:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; select * from wp_comments where datediff(now(), comment_date)&lt;10;
</span><span class='line'>mysql&gt; delete from wp_comments where datediff(now(), comment_date)&lt;10;
</span><span class='line'>Query OK, 31029 rows affected (1.34 sec)
</span></code></pre></td></tr></table></div></figure>


<p>Disable postfix on startup:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># update-rc.d postfix disable
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/31">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/29">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/03/11/tips-on-w5100/">Tips on W5100</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/10/pei-zhi-qemude-vdewang-luo/">配置Qemu的VDE网络</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/07/tips-on-v-usb-and-arduino-5/">Tips on V-USB and Arduino(5)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/07/tips-on-v-usb-and-arduino-4/">Tips on V-USB and Arduino(4)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/05/ba-wan-ebuddy-3/">把玩ebuddy(3)</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Dash -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dashsagittariussglory';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
