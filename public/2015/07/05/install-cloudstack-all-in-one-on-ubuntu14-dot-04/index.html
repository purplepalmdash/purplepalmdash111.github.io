<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Install CloudStack All-In-One On Ubuntu14.04 &middot; Dash</title>

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/poole.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde-a.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/custom-additions.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/highlight/googlecode.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124">
  <link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel="icon">

  
  
  
  

  <meta name="description" content="Get busy living, or get busy dying.">
  <meta name="keywords" content="unix,virtualization,embedded,linux">
  <link rel="author" href="http://plus.google.com/106572959364703833986">
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-42175003-1', 'auto');
      ga('send', 'pageview');
  </script>

</head>
<body class="theme-base-0c">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <img src="https://www.gravatar.com/avatar/49381c0004d32c0a4296b92dff0c0ae5?s=200" alt="gravatar">
      <h1><a href="http://purplepalmdash.github.io/">Get busy living, or get busy dying.</a></h1>
      <a href="http://purplepalmdash.github.io/"><p>Dash</p></a>
    </div>

    <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/">First Page</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/post/">All Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/linux/">Linux</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/embedded/">Embedded System</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/virtualization">Virtualization</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/purplepalmdash"><i class="fa fa-github-square fa-3x"></i></a>
      
      <a href="https://cn.linkedin.com/in/yang-feipeng-1b909319"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://plus.google.com/u/0/106572959364703833986"><i class="fa fa-google-plus-square fa-3x"></i></a>
      <a href="https://www.facebook.com/yang.feipeng"><i class="fa fa-facebook-square fa-3x"></i></a>
      <a href="https://twitter.com/dashwillfly"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      <a href="" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
      </li>
    </ul>

    

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>Install CloudStack All-In-One On Ubuntu14.04</h1>
    <span class="post-date">Jul 5, 2015  &middot; <a href="http://purplepalmdash.github.io/2015/07/05/install-cloudstack-all-in-one-on-ubuntu14-dot-04/#disqus_thread">Comments</a>
    
    <br/>
    
          <a class="a_cat" href="http://purplepalmdash.github.io/categories/virtualization">Virtualization</a>
      
      

    
    </span>
      <div id="_toc" class="toc">
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#preparation-for-packages">Preparation For Packages</a></li>
<li><a href="#installation-steps">Installation Steps</a>
<ul>
<li><a href="#system-preparation">System Preparation</a></li>
<li><a href="#server-configuration">Server Configuration</a></li>
<li><a href="#cloudstack-installation">CloudStack Installation</a></li>
<li><a href="#nfs-storage-preparation">NFS Storage Preparation</a></li>
<li><a href="#cloudstack-agent-installation">Cloudstack Agent Installation</a></li>
<li><a href="#configure-firewall">Configure FireWall</a></li>
</ul></li>
<li><a href="#cloudstack">Cloudstack</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
      </div>
    

<p>Refers to:<br />
<a href="http://www.greenhills.co.uk/2015/02/23/cloudstack-4.4-single-server-on-ubuntu-14.04.1-with-kvm.html">http://www.greenhills.co.uk/2015/02/23/cloudstack-4.4-single-server-on-ubuntu-14.04.1-with-kvm.html</a></p>

<h3 id="preparation-for-packages">Preparation For Packages</h3>

<p>Install reprepro:</p>

<pre><code># apt-get install -y reprepro
</code></pre>

<pre><code># mkdir -p /srv/reprepro
root@DebServer:/srv/reprepro# ls
conf  db  dists  incoming  indices  lists  logs  pool  project  tmp
root@DebServer:/srv/reprepro# ls conf/
distributions  incomming  updates  uploaders
root@DebServer:/srv/reprepro# cat conf/distributions 
Origin: Alveonet
Label: Alveonet
Suite: trusty
Codename: trusty
Version: 14.04
Architectures: i386 amd64 source
Components: main cloudstack43 cloudstack44 cloudstack45 cloudstack
Description: Alveonet specific (or backported) packages
#SignWith: dash1982
DebOverride: ../indices/override.trusty.main
UDebOverride: ../indices/override.tursy.main.debian-installer
DscOverride: ../indices/override.trusty.main.src
DebIndices: Packages Release . .gz .bz2
UDebIndices: Packages . .gz .bz2
DscIndices: Sources Release .gz .bz2
Contents: . .gz .bz2
Update: - cloudstack45 cloudstack43 cloudstack44
Log: packages.alveonet.org.log
root@DebServer:/srv/reprepro# cat conf/incomming 
Name: default
IncomingDir: incoming
TempDir: tmp
Allow: trusty trusty-backports
Cleanup: on_deny on_error
root@DebServer:/srv/reprepro# cat conf/updates 
Name: cloudstack44
Method: http://cloudstack.apt-get.eu/ubuntu
#VerifyRelease: 86C278E3
Suite: trusty
Architectures: amd64
GetInRelease: no
#Components: 4.3&gt;main
Components: 4.4&gt;cloudstack44

# Name: cloudstack44
# Method: http://cloudstack.apt-get.eu/ubuntu
# #VerifyRelease: 86C278E3
# Suite: trusty
# Architectures: amd64
# GetInRelease: no
# #Components: 4.3&gt;main
# Components: 4.4&gt;main


Name: cloudstack45
Method: http://cloudstack.apt-get.eu/ubuntu
#VerifyRelease: 86C278E3
Suite: trusty
Architectures: amd64
GetInRelease: no
#Components: 4.3&gt;main
Components: 4.5&gt;cloudstack45


Name: cloudstack43
Method: http://cloudstack.apt-get.eu/ubuntu
#VerifyRelease: 86C278E3
Suite: trusty
Architectures: amd64
GetInRelease: no
#Components: 4.3&gt;main
Components: 4.3&gt;cloudstack43
root@DebServer:/srv/reprepro# cat conf/uploaders 
allow * by unsigned



# reprepro -Vb /srv/reprepro export
# reprepro update

</code></pre>

<p>By doing this you could make a local reprepro created repository.</p>

<p>TBD</p>

<h3 id="installation-steps">Installation Steps</h3>

<h4 id="system-preparation">System Preparation</h4>

<p>First install Ubuntu14.04, I use Cobbler Server&rsquo;s PXE Installation.</p>

<p>Change the Root Permit login under <code>/etc/ssh/sshd_config</code> and restart the ssh service.</p>

<p>Change the IP Address to 10.10.10.2 via:</p>

<pre><code>root@Ubuntu-14:~# cat /etc/network/interfaces
# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto eth0
iface eth0 inet static
address 10.10.10.2
netmask 255.255.255.0
gateway 10.10.10.1
dns-nameservers 180.76.76.76
</code></pre>

<p>Relogin to the system, and begin to install the packages.</p>

<pre><code># vi /etc/apt/source.list
deb http://192.168.1.111 amd64/
deb http://192.168.1.111/reprepro/      trusty  cloudstack44
# apt-get update &amp;&amp; apt-get install vim
</code></pre>

<p>I use 192.168.1.111 because I cached all of the required packages in this server, thus it could speed-up the deployment.</p>

<h4 id="server-configuration">Server Configuration</h4>

<p>Configure the Server&rsquo;s hostname:</p>

<pre><code>root@Ubuntu-14:~# cat /etc/hostname 
CS
root@Ubuntu-14:~# cat /etc/hosts
127.0.0.1       localhost
10.10.0.2       CS
127.0.1.1       CS.CSDomain     CS

root@Ubuntu-14:~# reboot
# hostname --fqdn
CS
</code></pre>

<p>Now configure the NTP via:</p>

<pre><code># apt-get purge ntp
# apt-get install openntpd
</code></pre>

<p>Configure the Network:</p>

<pre><code># apt-get install bridge-utils
# cat /etc/network/interfaces
    
    # The loopback network interface
    auto lo
    iface lo inet loopback
    
    # The primary network interface
    auto eth0
    iface eth0 inet manual
    
    
    auto cloudbr0
    iface cloudbr0 inet static
            address 10.10.10.2
            netmask 255.255.255.0
            gateway 10.10.10.1
            dns-nameservers 180.76.76.76
            bridge-ports eth0
            bridge_fd 5
            bridge_stp off
            bridge_maxwait 1
    
    # Private network
    auto cloudbr1
    iface cloudbr1 inet manual
            bridge_ports none
            bridge_fd 5
            bridge_stp off
            bridge_maxwait 1
# reboot
</code></pre>

<p>Now the Network Bridge is configured.</p>

<h4 id="cloudstack-installation">CloudStack Installation</h4>

<p>Since all of the packages are cached into LAN environment, simply type following command for installing:</p>

<pre><code># apt-get install cloudstack-management
</code></pre>

<p>Then Install the database server:</p>

<pre><code># apt-get install mysql-server
# vim /etc/mysql/conf.d/cloudstack.cnf
[mysqld]
innodb_rollback_on_timeout=1
innodb_lock_wait_timeout=600
max_connections=350
log-bin=mysql-bin
binlog-format = 'ROW'
root@CS:~# service mysql restart
root@CS:~# cloudstack-setup-databases cloud:engine@localhost --deploy-as=root:engine -e file -m mymskey44 -k mydbkey00
</code></pre>

<h4 id="nfs-storage-preparation">NFS Storage Preparation</h4>

<p>Add export directory:</p>

<pre><code># mkdir -p /export/primary /export/secondary
# apt-get install nfs-kernel-server
# vim /etc/exports
/export  *(rw,async,no_root_squash,no_subtree_check)
# cp /etc/default/nfs-common /etc/default/nfs-common.orig
# sed -i '/NEED_STATD=/ a NEED_STATD=yes' /etc/default/nfs-common
# sed -i '/STATDOPTS=/ a STATDOPTS=&quot;--port 662 --outgoing-port 2020&quot;' /etc/default/nfs-common
# diff -du /etc/default/nfs-common.orig /etc/default/nfs-common

root@CS:~# cat /etc/modprobe.d/lockd.conf 
options lockd nlm_udpport=32769 nlm_tcpport=32803
root@CS:~# service nfs-kernel-server restart
root@CS:~# showmount -e 127.0.0.1
Export list for 127.0.0.1:
/export *
</code></pre>

<p>Mount it via:</p>

<pre><code>root@CS:~# mkdir -p /mnt/primary /mnt/secondary
root@CS:~# tail -2 /etc/fstab
10.10.10.2:/export/primary   /mnt/primary    nfs rsize=8192,wsize=8192,timeo=14,intr,vers=3,noauto  0   2
10.10.10.2:/export/secondary /mnt/secondary  nfs rsize=8192,wsize=8192,timeo=14,intr,vers=3,noauto  0   2
root@CS:~# mount /mnt/primary/
root@CS:~# mount /mnt/secondary/
root@CS:~# mount | tail -2
10.10.10.2:/export/primary on /mnt/primary type nfs (rw,rsize=8192,wsize=8192,timeo=14,intr,vers=3,addr=10.10.10.2)
10.10.10.2:/export/secondary on /mnt/secondary type nfs (rw,rsize=8192,wsize=8192,timeo=14,intr,vers=3,addr=10.10.10.2)
</code></pre>

<h4 id="cloudstack-agent-installation">Cloudstack Agent Installation</h4>

<p>Install it via:</p>

<pre><code>root@CS:~# apt-get install cloudstack-agent
root@CS:~# cp /etc/libvirt/libvirtd.conf /etc/libvirt/libvirtd.conf.orig
root@CS:~# sed -i '/#listen_tls = 0/ a listen_tls = 0' /etc/libvirt/libvirtd.conf
root@CS:~# sed -i '/#listen_tcp = 1/ a listen_tcp = 1' /etc/libvirt/libvirtd.conf
root@CS:~# sed -i '/#tcp_port = &quot;16509&quot;/ a tcp_port = &quot;16509&quot;' /etc/libvirt/libvirtd.conf
root@CS:~# sed -i '/#auth_tcp = &quot;sasl&quot;/ a auth_tcp = &quot;none&quot;' /etc/libvirt/libvirtd.conf
root@CS:~# diff -du /etc/libvirt/libvirtd.conf.orig /etc/libvirt/libvirtd.conf
root@CS:~# cp /etc/default/libvirt-bin /etc/default/libvirt-bin.orig
root@CS:~# sed -i -e 's/libvirtd_opts=&quot;-d&quot;/libvirtd_opts=&quot;-d -l&quot;/' /etc/default/libvirt-bin
root@CS:~# service libvirt-bin restart
root@CS:~# cp /etc/libvirt/qemu.conf /etc/libvirt/qemu.conf.orig
root@CS:~# sed -i '/#vnc_listen = &quot;0.0.0.0&quot;/ a vnc_listen = &quot;0.0.0.0&quot;' /etc/libvirt/qemu.conf
root@CS:~# diff -du /etc/libvirt/qemu.conf.orig /etc/libvirt/qemu.conf
root@CS:~# service libvirt-bin restart
root@CS:~# ln -s /etc/apparmor.d/usr.sbin.libvirtd /etc/apparmor.d/disable/
root@CS:~# ln -s /etc/apparmor.d/usr.lib.libvirt.virt-aa-helper /etc/apparmor.d/disable/
root@CS:~# apparmor_parser -R /etc/apparmor.d/usr.sbin.libvirtd
root@CS:~# apparmor_parser -R /etc/apparmor.d/usr.lib.libvirt.virt-aa-helper
root@CS:~# service libvirt-bin restart
</code></pre>

<h4 id="configure-firewall">Configure FireWall</h4>

<p>Open the following ports:</p>

<pre><code>root@CS:~# ufw allow proto tcp from any to any port 22
Rules updated
Rules updated (v6)
root@CS:~# ufw allow proto tcp from any to any port 1798
Rules updated
Rules updated (v6)
root@CS:~# ufw allow proto tcp from any to any port 16509
Rules updated
Rules updated (v6)
root@CS:~# ufw allow proto tcp from any to any port 5900:6100
Rules updated
Rules updated (v6)
root@CS:~# ufw allow proto tcp from any to any port 49152:49216
Rules updated
Rules updated (v6)
</code></pre>

<p>Now restart and verify the NFS working.</p>

<pre><code>root@CS:~# rpcinfo -u 10.10.10.2 mount
program 100005 version 1 ready and waiting
program 100005 version 2 ready and waiting
program 100005 version 3 ready and waiting
root@CS:~# showmount -e 10.10.10.2
Export list for 10.10.10.2:
/export *
root@CS:~# mount /mnt/primary/
root@CS:~# mount /mnt/secondary/
</code></pre>

<p>Added the System Template:</p>

<pre><code>root@CS:~# /usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /mnt/secondary -u http://192.168.1.111/systemvm64template-4.4.1-7-kvm.qcow2.bz2  -h kvm -F
......
Successfully installed system VM template  to /mnt/secondary/template/tmpl/1/3/
</code></pre>

<h3 id="cloudstack">Cloudstack</h3>

<p>First manually start the services:</p>

<pre><code>service cloudstack-management status
service cloudstack-agent status
service tomcat6 status

service cloudstack-management stop
service tomcat6 stop
service cloudstack-agent stop
ps -efl | grep java

service cloudstack-management start
service cloudstack-management status
service cloudstack-agent start
service cloudstack-agent status
</code></pre>

<p>Now setup the UI via visiting <code>http://10.10.10.2:8080/client</code>, usename/password: admin/password:</p>

<pre><code>Choose &quot;Continue with basic installation&quot;. This will start a wizard that will walk through the configuration. You will need to adjust the network values for your environment, and make sure you use appropiate, free, ranges.

Add a new zone named &quot;zone1&quot;, DNS1 10.10.10.1 and Internal DNS 10.10.10.1.
Add a new pod named &quot;pod1&quot;, gateway 10.10.10.1, netmask 255.255.255.0, IP range 10.10.10.160-10.10.10.169.
Add a guest network, gateway 10.10.10.1, netmask 255.255.255.0, IP range 10.10.10.170-192.168.77.230.
Add a cluster named cluster1, Hypervisor KVM.
Add a host. Host Name &quot;CS&quot;, user root, passsword for the root linux user.
Add primary storage: name primary1, protocol NFS, Scope Cluster, server 10.10.10.10, path /export/primary.
Add secondary storage: NFS server 10.10.10.10, path /export/secondary.
Hit Launch and pray.
This should go through a sequence of setup.
</code></pre>

<p>Now you could enjoy the cloudstack all-in-one</p>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "dashsagittariussglory";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "dashsagittariussglory";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="http://purplepalmdash.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

