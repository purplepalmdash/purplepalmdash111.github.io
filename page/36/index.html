<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
	<meta name="generator" content="Hugo 0.17-DEV" />
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Dash &middot; Dash</title>

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/poole.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde-a.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/custom-additions.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/highlight/googlecode.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124">
  <link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel="icon">

  
  
  
  <link href="http://purplepalmdash.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Dash &middot; Dash" />

  <meta name="description" content="Get busy living, or get busy dying.">
  <meta name="keywords" content="unix,virtualization,embedded,linux">
  <link rel="author" href="http://plus.google.com/106572959364703833986">
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-42175003-1', 'auto');
      ga('send', 'pageview');
  </script>

</head>
<body class="theme-base-0c">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <img src="https://www.gravatar.com/avatar/49381c0004d32c0a4296b92dff0c0ae5?s=200" alt="gravatar">
      <h1><a href="http://purplepalmdash.github.io/">Get busy living, or get busy dying.</a></h1>
      <a href="http://purplepalmdash.github.io/"><p>Dash</p></a>
    </div>

    <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/">First Page</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/post/">All Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/linux/">Linux</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/embedded/">Embedded System</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/virtualization">Virtualization</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/purplepalmdash"><i class="fa fa-github-square fa-3x"></i></a>
      
      <a href="https://cn.linkedin.com/in/yang-feipeng-1b909319"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://plus.google.com/u/0/106572959364703833986"><i class="fa fa-google-plus-square fa-3x"></i></a>
      <a href="https://www.facebook.com/yang.feipeng"><i class="fa fa-facebook-square fa-3x"></i></a>
      <a href="https://twitter.com/dashwillfly"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      <a href="http://purplepalmdash.github.io/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
      </li>
    </ul>

    

  </div>
</div>


<div class="content container">
  <div class="posts">
    
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/2015/06/18/wh-worktips-3/">WH Worktips(3)</a>
      </h1>
      <span class="post-date">Jun 18, 2015  &middot; <a href="http://purplepalmdash.github.io/2015/06/18/wh-worktips-3/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/virtualization">virtualization</a>
        
      </span>
      
      

<h3 id="prepare-packages">Prepare Packages</h3>

<h4 id="system-pacakges">System Pacakges</h4>

<p>Since CentOS6.5 already deprecated, we need to use <code>http://vault.centos.org/6.5/</code> for download the packages.<br />
Or we could remove all of the repo definition files except the cobbler deployed one.</p>

<p>We need python-pip for usage. Download it via yum firstly to the directory.</p>

<p>Download the following packages, these packages may have problems because I downloaded them from the latest repository.</p>

<pre><code>$ yum install yum-plugin-downloadonly
$ yum install --downloadonly --downloaddir=/root/Code/repo/ python-pip
$ yum install --downloadonly --downloaddir=/root/Code/repo/ nethogs
$ yum reinstall --downloadonly --downloaddir=/root/Code/repo/ java7
$ yum reinstall --downloadonly --downloaddir=/root/Code/repo/ mysql-devel
$ yum install --downloadonly --downloaddir=/root/Code/repo/ java-1.7.0-openjdk-devel
$ yum install --downloadonly --downloaddir=/root/Code/repo/ mysql-server
$ yum install --downloadonly --downloaddir=/root/Code/repo/ mysql-devel
[root@z_WHServer repo]# ls
python-pip-1.3.1-4.el6.noarch.rpm
....
</code></pre>

<h4 id="cloudstack-packages">Cloudstack Packages</h4>

<p>Download all of the cloudstack packages from <code>http://cloudstack.apt-get.eu/rhel/4.4/</code>, and put them into a directory, run <code>createrepo</code> for generating the repodata.</p>

<h4 id="pip-packages">PIP Packages</h4>

<p>Manually create the offline installation resources.</p>

<h3 id="deployment">Deployment</h3>

<pre><code>#  ansible-playbook -i /root/Code/Ansible/hosts --limit=node112 ./cloudstack.yml --tags=base
#  ansible-playbook -i /root/Code/Ansible/hosts --limit=node112 ./cloudstack.yml --tags=mysql
#  ansible-playbook -i /root/Code/Ansible/hosts --limit=node112 ./cloudstack.yml --tags=mysql3306
#  ansible-playbook -i /root/Code/Ansible/hosts --limit=node112 ./cloudstack.yml --tags=csmanagement -vvvv
</code></pre>

<p>There may be some problems in deployment in <code>/etc/hosts</code>, so manually add itself to the hostname:<br />
!!! node112 !!!</p>

<pre><code>[root@node112 yum.repos.d]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.47.58.112    node112
</code></pre>

<p>From now on, you could visit the management server via:</p>

<p><a href="http://10.47.58.112:8080/client/">http://10.47.58.112:8080/client/</a></p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/2015/06/18/wh-worktips-2/">WH Worktips(2)</a>
      </h1>
      <span class="post-date">Jun 18, 2015  &middot; <a href="http://purplepalmdash.github.io/2015/06/18/wh-worktips-2/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/virtualization">virtualization</a>
        
      </span>
      
      

<h3 id="cobbler-web">Cobbler Web</h3>

<p>Visit the following website:</p>

<p><a href="http://10.47.58.2/cobbler_web">http://10.47.58.2/cobbler_web</a></p>

<p>You will see:</p>

<p><img src="/images/2015_06_18_10_21_45_755x413.jpg" alt="/images/2015_06_18_10_21_45_755x413.jpg" /></p>

<h3 id="added-more-profiles">Added More Profiles</h3>

<p>The default kickstart configuration file could found under:<br />
<code>/var/lib/cobbler/kickstarts/sample_end.ks</code>, copy it to your own.</p>

<pre><code>$ cp /var/lib/cobbler/kickstarts/sample_end.ks CentOS65Desktop.cfg
$ vim CentOS65Desktop.cfg
# Allow anaconda to partition the system as needed
# autopart
# 1G Swap and remains others to be ext4
part swap --fstype=&quot;swap&quot; --size=1024
part / --asprimary --fstype=&quot;ext4&quot; --grow --size=1
.......
%packages
# Added from here
@additional-devel
@basic-desktop
@chinese-support
@desktop-platform
@development
@fonts
@general-desktop
@input-methods
@x11
git
-ibus-table-cangjie
-ibus-table-erbi
-ibus-table-wubi
# End of added
$SNIPPET('func_install_if_enabled')
%end

</code></pre>

<p>More configurations could be customized.</p>

<h3 id="fixed-ip-address-via-dhcp">Fixed IP Address Via DHCP</h3>

<p>By adding the configuration in dhcp configuration:</p>

<pre><code>$ sudo vim /etc/cobbler/dhcp.template
     max-lease-time             43200;      
     next-server                $next_server; 

     host ns111 {
         next-server $next_server;
         hardware ethernet 52:54:00:e0:cc:18;
         fixed-address 10.47.58.111;
     }


     class &quot;pxeclients&quot; {
$ sudo cobbler sync
</code></pre>

<p>Now restart the deployed node, you will easily see the node.</p>

<h3 id="specify-fixed-ip-for-host">Specify Fixed IP For Host</h3>

<p>Add the configration of the node112, then this machine will start with our specified parameters:</p>

<pre><code># cobbler system add --name=node112 --profile=CentOS6.5-Desktop --mac=52:54:00:92:8c:4d --interface=eth0 --ip-address=10.47.58.112 --hostname=node112 --gateway=10.47.58.1 --dns-name=node112
</code></pre>

<p>Now bootup the machine, then this computer will have the fixed IP address.</p>

<p><img src="/images/2015_06_18_11_38_48_794x263.jpg" alt="/images/2015_06_18_11_38_48_794x263.jpg" /></p>

<h3 id="use-ansible-for-administrate-the-added-nodes">Use Ansible For Administrate The Added Nodes</h3>

<p>Install ansible via:</p>

<pre><code># yum install -y ansible sshpass
# vim /etc/hosts
10.47.58.112    node112

# mkdir -p ~/Code/Ansible
# cd ~/Code/Ansible
# vim ansible.cfg
    [defaults]
    hostfile=/root/Code/Ansible/hosts

# vim hosts
    [node112]
    10.47.58.112

# vim ssh-addkey.yml
    ---
    - hosts: all
      sudo: yes
      gather_facts: no
      remote_user: root
    
      tasks:
    
      - name: install ssh key
        authorized_key: user=root
                        key=&quot;{{ lookup('file', '/root/.ssh/id_rsa.pub') }}&quot; 
                        state=present

# ssh-keyscan 10.47.58.112&gt;&gt;/root/.ssh/known_hosts
# ansible-playbook ssh-addkey.yml --ask-pass
</code></pre>

<p>Now the node112 is under controlled by you.<br />
Take refers to:<br />
<a href="https://sysadmincasts.com/episodes/45-learning-ansible-with-vagrant-part-2-4">https://sysadmincasts.com/episodes/45-learning-ansible-with-vagrant-part-2-4</a></p>

<p>Test via:</p>

<pre><code>[root@z_WHServer Ansible]# ansible all -m shell -a &quot;uptime&quot;
10.47.58.112 | success | rc=0 &gt;&gt;
 06:18:59 up  1:32,  2 users,  load average: 0.00, 0.00, 0.00
</code></pre>

<p>In following parts we will try to deploy Cloudstack using playbook.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/2015/06/17/wh-worktips-1/">WH Worktips(1)</a>
      </h1>
      <span class="post-date">Jun 17, 2015  &middot; <a href="http://purplepalmdash.github.io/2015/06/17/wh-worktips-1/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/virtualization">Virtualization</a>
        
      </span>
      
      

<h3 id="preparation">Preparation</h3>

<p>Hardware: 2G Memory, 1-Core, the Cobbler Server, which runs CentOS6.6.<br />
Network: Use a 10.47.58.0/24(Its name is WHNetwork), no dhcp server in this network.</p>

<h3 id="cobbler-server-preparation">Cobbler Server Preparation</h3>

<p>First Change its IP address to 10.47.58.2, gateway to 10.47.58.1.</p>

<pre><code>[root@z_WHServer ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0 
DEVICE=eth0
TYPE=Ethernet
UUID=a6e5b56f-661f-4128-ab8c-c575a9623245
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=none
IPADDR=10.47.58.2
GATEWAY=10.47.58.1
......

[root@z_WHServer ~]# cat /etc/sysconfig/network
NETWORKING=yes
HOSTNAME=z_WHServer
# vim /etc/selinux/config
    #SELINUX=enforcing
    SELINUX=disabled 
# reboot
</code></pre>

<p>Install and configure Cobbler Server via:</p>

<pre><code># yum -y update &amp;&amp; yum install -y cobbler cobbler-web
# reboot
# openssl passwd -1                                                                                                     │
Password:                                                                                                                                 │
Verifying - Password:                                                                                                                     │
igaowugoauwgoueougo
# vim /etc/cobbler/settings
    default_password_crypted: &quot;agowuoguwoawoguwoe&quot;
    # default, localhost
    server: 10.47.58.2
    # default, localhost
    next_server: 10.47.58.2
    manage_dhcp: 1
</code></pre>

<p>Edit the dhcp template:</p>

<pre><code># vim /etc/cobbler/dhcp.template
####  subnet 192.168.1.0 netmask 255.255.255.0 {
####       option routers             192.168.1.5;
####       option domain-name-servers 192.168.1.1;
####       option subnet-mask         255.255.255.0;
####       range dynamic-bootp        192.168.1.100 192.168.1.254;
####       default-lease-time         21600;
####       max-lease-time             43200;
####       next-server                $next_server;
subnet 10.47.58.0 netmask 255.255.255.0 {
     option routers             10.47.58.1; 
     range dynamic-bootp        10.47.58.3 10.47.58.254;
     option domain-name-servers 114.114.114.114, 180.76.76.76;     
     option subnet-mask         255.255.255.0;         
     filename                   &quot;/pxelinux.0&quot;;       
     default-lease-time         21600;           
     max-lease-time             43200;      
     next-server                $next_server; 

     class &quot;pxeclients&quot; {
</code></pre>

<p>Check via:</p>

<pre><code>[root@z_WHServer ~]# service cobblerd start
Starting cobbler daemon:                                   [  OK  ]
[root@z_WHServer ~]# chkconfig cobblerd on
[root@z_WHServer ~]# chkconfig httpd on
[root@z_WHServer ~]# service cobblerd status
cobblerd (pid 5421) is running...
</code></pre>

<p>Reboot and Check via:</p>

<pre><code># cobbler check
</code></pre>

<p>You will get lots of the errors, first solve the dhcpd issue, notice the following dhcpd configuration file is temporarily used.</p>

<pre><code># yum install -y dhcp
# vim /etc/dhcp/dhcpd.conf
#
# DHCP Server Configuration file.
#   see /usr/share/doc/dhcp*/dhcpd.conf.sample
#   see 'man 5 dhcpd.conf'
#
# create new
# specify domain name
option domain-name &quot;server.world&quot;;
# specify name server's hostname or IP address
option domain-name-servers dlp.server.world;
# default lease time
default-lease-time 600;
# max lease time
max-lease-time 7200;
# this DHCP server to be declared valid
authoritative;
# specify network address and subnet mask
subnet 10.47.58.0 netmask 255.255.255.0 {
    # specify the range of lease IP address
    range dynamic-bootp 10.47.58.200 10.47.58.254;
    # specify broadcast address
    option broadcast-address 10.47.58.255;
    # specify default gateway
    option routers 10.47.58.1;
}
# service dhcpd start
# chkconfig dhcpd on
# chkconfig xinetd on
# reboot
</code></pre>

<p>Get loaders to download the loaders to <code>/var/lib/cobbler/loaders</code>:<br />
!!! Notice, this step maybe failed because of networking issues!!!!</p>

<pre><code>$ cobbler get-loaders
</code></pre>

<p>Change xinted:</p>

<pre><code># cat  /etc/xinetd.d/rsync 
# default: off
# description: The rsync server is a good addition to an ftp server, as it \
#       allows crc checksumming etc.
service rsync
{
        disable = no

</code></pre>

<p>Edit iptables:</p>

<pre><code>$ sudo vim /etc/sysconfig/iptables
:OUTPUT ACCEPT [0:0]
-A INPUT -p udp -m multiport --dports 69,80,443,25151 -j ACCEPT 
-A INPUT -p tcp -m multiport --dports 69,80,443,25151 -j ACCEPT 
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
$ sudo reboot
</code></pre>

<p>Install packages:</p>

<pre><code># yum install -y debmirror pykickstart cman
# cobbler check
# cobbler sync
</code></pre>

<h3 id="import-systems">Import Systems</h3>

<p>Import 2 DVD iso via:</p>

<pre><code># mount -o loop -t iso9660 CentOS-6.5-x86_64-bin-DVD1.iso  /mnt1/
# cobbler import --name=CentOS-6.5 --arch=x86_64 --path=/mnt1
# mount -o loop -t iso9660 CentOS-6.5-x86_64-bin-DVD2.iso  /mnt2
# rsync -a '/mnt2/' /var/www/cobbler/ks_mirror/CentOS-6.5-x86_64/ --exclude-from=/etc/cobbler/rsync.exclude --progress
# COMPSXML=$(ls /var/www/cobbler/ks_mirror/CentOS-6.5-x86_64/repodata/*comps*.xml)
# createrepo -c cache -s sha --update --groupfile ${COMPSXML} /var/www/cobbler/ks_mirror/CentOS-6.5-x86_64/ 
</code></pre>

<p>Verify it via:</p>

<pre><code>[root@z_WHServer repodata]# cobbler distro list
   CentOS-6.5-x86_64
[root@z_WHServer repodata]# cobbler profile list
   CentOS-6.5-x86_64
[root@z_WHServer repodata]# cobbler distro report --name=CentOS-6.5-x86_64
Name                           : CentOS-6.5-x86_64
Architecture                   : x86_64
TFTP Boot Files                : {}
Breed                          : redhat
Comment                        : 
Fetchable Files                : {}
Initrd                         : /var/www/cobbler/ks_mirror/CentOS-6.5-x86_64/images/pxeboot/initrd.img
Kernel                         : /var/www/cobbler/ks_mirror/CentOS-6.5-x86_64/images/pxeboot/vmlinuz
</code></pre>

<p>Check if your tftp working:</p>

<pre><code># yum install tftp-server
# vim /etc/xinetd.d/tftp
# /sbin/chkconfig tftp on
# service xinetd start
# netstat -anp | grep 69
# tftp 10.47.58.2
get pxelinux.0
</code></pre>

<p>If successful, the pxelinux.0 will downloaded to your directory.</p>

<h3 id="install-new-systems">Install New Systems</h3>

<p>Use a machine, configure to the same network, then start from pxe.</p>

<h3 id="customize-the-ks-file">Customize the KS file</h3>

<p>Generate kickstart configuration file via:</p>

<pre><code># system-config-kickstart 
</code></pre>

<p>Add a new profile via:</p>

<pre><code>[root@z_WHServer kickstarts]# cobbler profile add --name=CentOS6.5-Desktop --kickstart=/var/lib/cobbler/kickstarts/CentOS-6.5-x86_64/C
sktop.cfg --distro=CentOS-6.5-x86_64
[root@z_WHServer kickstarts]# cobbler profile list
   CentOS-6.5-x86_64
   CentOS6.5-Desktop
</code></pre>

<h3 id="cobbler-web-interface">Cobbler Web Interface</h3>

<pre><code>$ htdigest /etc/cobbler/users.digest &quot;Cobbler&quot; cobbler 
Which will prompt you for a new password. 
Once you have updated the password remember to run
$ cobbler sync
</code></pre>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/2015/06/16/xenserver-tips/">XenServer Tips</a>
      </h1>
      <span class="post-date">Jun 16, 2015  &middot; <a href="http://purplepalmdash.github.io/2015/06/16/xenserver-tips/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/virtualization">Virtualization</a>
        
      </span>
      
      

<p>Recently I want to research desktop virtualization on Xen, so this blog records all of the tips for Xen Hypervisor related info.</p>

<h3 id="nested-virtualization">Nested Virtualization</h3>

<p>I place 4 core(Copy Host Configuration on CPU parameter), but the XenServer refuse to start, by using a none-hosted-configuration CPU configuration, it will fail on starting the machine, So I choose to install xen hypervisor on Ubuntu14.04.</p>

<h3 id="ubuntu-and-xen">Ubuntu and Xen</h3>

<p>Install via:</p>

<pre><code>$ sudo apt-get install xen-hypervisor-amd64
$ sudo reboot
</code></pre>

<p>The Ubuntu will automatically choose xen for startup, so verify it via:</p>

<pre><code>$ sudo xl list
Name                                        ID   Mem VCPUs      State   Time(s)
Domain-0                                     0  7832     4     r-----      72.8
</code></pre>

<h3 id="networking">Networking</h3>

<p>Since the network is pretty complicated on my own machine, I decide to use openVSwitch for managing my own networking.</p>

<pre><code>$ sudo apt-get install -y openvswitch-switch
</code></pre>

<p>Configuration of the networking:</p>

<pre><code>$ cat /etc/network/interfaces
###########################################
## By using openVswitch, we enabled the following
###########################################
allow-hotplug ovsbr0
iface ovsbr0 inet static
address 192.168.0.119
netmask 255.255.0.0
gateway 192.168.0.176
dns-nameservers 114.114.114.114
dns-nameservers 180.76.76.76

$ sudo ovs-vsctl add-br ovsbr0
$ sudo ovs-vsctl set Bridge ovsbr0 stp_enable=false other_config:stp-max-age=6 other_config:stp-forward-delay=4
$ sudo ovs-vsctl list Bridge
$ sudo ovs-vsctl add-port ovsbr0 eth0
</code></pre>

<p>Disable the netfilter on all bridges:</p>

<pre><code>$ sudo vi /etc/sysctl.conf

net.bridge.bridge-nf-call-ip6tables = 0
net.bridge.bridge-nf-call-iptables = 0
net.bridge.bridge-nf-call-arptables = 0

$ sudo sysctl -p /etc/sysctl.conf
# Note: These settings are created in /proc/sys/net. The bridge folder only appears to be created after first creating a bridge with the ''brctl' command.
</code></pre>

<h3 id="administrator-tools">Administrator Tools</h3>

<pre><code>$ sudo apt-get install virt-manager
$ sudo apt-get install xen-tools
</code></pre>

<h3 id="connect-with-virt-manager">Connect with virt-manager</h3>

<p>Change following parameters and re-connect again.</p>

<pre><code># vim /etc/xen/xend-config.sxp 
     xend-unix-server yes
     xend-unix-path /var/lib/xend/xend-socket
# service libvirt-bin restart
libvirt-bin stop/waiting
libvirt-bin start/running, process 5345
# service xen restart
 * Restarting Xen daemons                                                                                                             ^[[A                                                                                                                           [ OK ]
# service xendomains restart

</code></pre>

<pre><code>$ sudo virt-install --connect=xen:/// --name u14.04 --ram 1024 --disk u14.04.img,size=4 --location http://ftp.ubuntu.com/ubuntu/dists/trusty/main/installer-amd64/


# http://ftp.ubuntu.com/ubuntu/dists/trusty/main/installer-amd64/
</code></pre>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/2015/06/15/tips-on-ansible-for-deploying-cloudstack/">Tips on Ansible for deploying CloudStack</a>
      </h1>
      <span class="post-date">Jun 15, 2015  &middot; <a href="http://purplepalmdash.github.io/2015/06/15/tips-on-ansible-for-deploying-cloudstack/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/virtualization">virtualization</a>
        
      </span>
      
      

<h3 id="background">Background</h3>

<p>Use two nodes, both running CentOS6.6, the Ansible Node have 1-G memory, while the csmanger(CloudStack Manager) Node have 4-G memory.</p>

<p>Install the epel on Cloudstack manager for installing ansible.</p>

<pre><code>$ wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
$ yum install -y ansible sshpass
</code></pre>

<h3 id="get-nodes">Get Nodes</h3>

<p>Create the definition of the ansible characters:</p>

<pre><code>[root@CentOS66Base ~]# mkdir -p ~/Code/Ansible
[root@CentOS66Base ~]# cd Code/Ansible/
[root@CentOS66Base Ansible]# vim ansible.cfg
[defaults]
hostfile=/root/Code/Ansible/hosts
[root@CentOS66Base Ansible]# vim hosts
[acs-manager]
10.55.55.72
[root@CentOS66Base Ansible]# cat /etc/hosts
.......
10.55.55.72 acs-manager
[root@CentOS66Base Ansible]# ping acs-manager
PING acs-manager (10.55.55.72) 56(84) bytes of data.
64 bytes from acs-manager (10.55.55.72): icmp_seq=1 ttl=64 time=1.16 ms
</code></pre>

<p>Add the ssh certification:</p>

<pre><code>[root@CentOS66Base Ansible]# ssh-keyscan acs-manager&gt;&gt;/root/.ssh/known_hosts 
# acs-manager SSH-2.0-OpenSSH_5.3
</code></pre>

<p>Generate the <code>id_rsa.pub</code> locally:</p>

<pre><code>[root@CentOS66Base Ansible]# ssh-keygen -t rsa -b 2048
......
[root@CentOS66Base Ansible]# ls -l -h /root/.ssh/id_rsa.pub 
-rw-r--r--. 1 root root 399 Jun 14 23:59 /root/.ssh/id_rsa.pub
</code></pre>

<p>Write key installation yml file:</p>

<pre><code>[root@CentOS66Base Ansible]# vim ssh-addkey.yml
---
- hosts: all
  sudo: yes
  gather_facts: no
  remote_user: root

  tasks:

  - name: install ssh key
    authorized_key: user=root
                    key=&quot;{{ lookup('file', '/root/.ssh/id_rsa.pub') }}&quot; 
                    state=present
</code></pre>

<p>!!! Be sure to disable the selinux on the acs-manager machine, then install the sshkey via:</p>

<pre><code>root@CentOS66Base Ansible]# ansible-playbook ssh-addkey.yml --ask-pass
SSH password: 

PLAY [all] ******************************************************************** 

TASK: [install ssh key] ******************************************************* 
changed: [10.55.55.72]

PLAY RECAP ******************************************************************** 
10.55.55.72                : ok=1    changed=1    unreachable=0    failed=0   
</code></pre>

<h3 id="prepare-the-secondary-storage">Prepare the secondary storage</h3>

<pre><code>$ sudo apt-get install nfs-kernel-server
$ cd /srv 
$ mkdir nfs4
$ ls
nfs4
$ sudo chown nobody:nogroup /srv/nfs4 
$ sudo vim /etc/exports
# Share access to all networks
/srv/nfs4       *(rw,sync,no_subtree_check)
$ sudo /etc/init.d/nfs-kernel-server start
</code></pre>

<h3 id="start-deploying">Start deploying</h3>

<p>Deployment sequences:</p>

<pre><code>$ ansible-playbook -i /root/Code/Ansible/hosts  --limit=acs-manager ./cloudstack.yml --tags=base
$ ansible-playbook -i /root/Code/Ansible/hosts  --limit=acs-manager ./cloudstack.yml --tags=mysql
$ ansible-playbook -i /root/Code/Ansible/hosts  --limit=acs-manager ./cloudstack.yml --tags=mysql3306
$ ansible-playbook -i /root/Code/Ansible/hosts  --limit=acs-manager ./cloudstack.yml --tags=csmanagement
</code></pre>

<h3 id="trouble-shooting">Trouble Shooting</h3>

<p>Too slow connection:</p>

<pre><code>Use Redsocks. 
By pass 
iptables -t nat -I OUTPUT -d 192.168.0.0/16 -j RETURN
</code></pre>

<p>CloudMonkey setup:</p>

<pre><code>The host name of this computer does not resolve to an IP address.

[root@acs-manager ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.55.55.72     acs-manager

</code></pre>

<p>After deployment, visit:</p>

<p><a href="http://xxx.xx.x.xxx:8080/client">http://xxx.xx.x.xxx:8080/client</a></p>

      
    </div>
    
    
    
    <ul class="pagination">
        
        <li>
            <a href="/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
        </li>
        
        <li
        >
        <a href="/page/35/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
        </li>
        
        <li
        ><a href="/">1</a></li>
        
        <li
        ><a href="/page/2/">2</a></li>
        
        <li
        ><a href="/page/3/">3</a></li>
        
        <li
        ><a href="/page/4/">4</a></li>
        
        <li
        ><a href="/page/5/">5</a></li>
        
        <li
        ><a href="/page/6/">6</a></li>
        
        <li
        ><a href="/page/7/">7</a></li>
        
        <li
        ><a href="/page/8/">8</a></li>
        
        <li
        ><a href="/page/9/">9</a></li>
        
        <li
        ><a href="/page/10/">10</a></li>
        
        <li
        ><a href="/page/11/">11</a></li>
        
        <li
        ><a href="/page/12/">12</a></li>
        
        <li
        ><a href="/page/13/">13</a></li>
        
        <li
        ><a href="/page/14/">14</a></li>
        
        <li
        ><a href="/page/15/">15</a></li>
        
        <li
        ><a href="/page/16/">16</a></li>
        
        <li
        ><a href="/page/17/">17</a></li>
        
        <li
        ><a href="/page/18/">18</a></li>
        
        <li
        ><a href="/page/19/">19</a></li>
        
        <li
        ><a href="/page/20/">20</a></li>
        
        <li
        ><a href="/page/21/">21</a></li>
        
        <li
        ><a href="/page/22/">22</a></li>
        
        <li
        ><a href="/page/23/">23</a></li>
        
        <li
        ><a href="/page/24/">24</a></li>
        
        <li
        ><a href="/page/25/">25</a></li>
        
        <li
        ><a href="/page/26/">26</a></li>
        
        <li
        ><a href="/page/27/">27</a></li>
        
        <li
        ><a href="/page/28/">28</a></li>
        
        <li
        ><a href="/page/29/">29</a></li>
        
        <li
        ><a href="/page/30/">30</a></li>
        
        <li
        ><a href="/page/31/">31</a></li>
        
        <li
        ><a href="/page/32/">32</a></li>
        
        <li
        ><a href="/page/33/">33</a></li>
        
        <li
        ><a href="/page/34/">34</a></li>
        
        <li
        ><a href="/page/35/">35</a></li>
        
        <li
        class="active"><a href="/page/36/">36</a></li>
        
        <li
        ><a href="/page/37/">37</a></li>
        
        <li
        ><a href="/page/38/">38</a></li>
        
        <li
        ><a href="/page/39/">39</a></li>
        
        <li
        ><a href="/page/40/">40</a></li>
        
        <li
        ><a href="/page/41/">41</a></li>
        
        <li
        ><a href="/page/42/">42</a></li>
        
        <li
        ><a href="/page/43/">43</a></li>
        
        <li
        ><a href="/page/44/">44</a></li>
        
        <li
        ><a href="/page/45/">45</a></li>
        
        <li
        ><a href="/page/46/">46</a></li>
        
        <li
        ><a href="/page/47/">47</a></li>
        
        <li
        ><a href="/page/48/">48</a></li>
        
        <li
        ><a href="/page/49/">49</a></li>
        
        <li
        ><a href="/page/50/">50</a></li>
        
        <li
        ><a href="/page/51/">51</a></li>
        
        <li
        ><a href="/page/52/">52</a></li>
        
        <li
        ><a href="/page/53/">53</a></li>
        
        <li
        ><a href="/page/54/">54</a></li>
        
        <li
        ><a href="/page/55/">55</a></li>
        
        <li
        ><a href="/page/56/">56</a></li>
        
        <li
        ><a href="/page/57/">57</a></li>
        
        <li
        ><a href="/page/58/">58</a></li>
        
        <li
        ><a href="/page/59/">59</a></li>
        
        <li
        ><a href="/page/60/">60</a></li>
        
        <li
        ><a href="/page/61/">61</a></li>
        
        <li
        ><a href="/page/62/">62</a></li>
        
        <li
        ><a href="/page/63/">63</a></li>
        
        <li
        ><a href="/page/64/">64</a></li>
        
        <li
        ><a href="/page/65/">65</a></li>
        
        <li
        ><a href="/page/66/">66</a></li>
        
        <li
        ><a href="/page/67/">67</a></li>
        
        <li
        ><a href="/page/68/">68</a></li>
        
        <li
        ><a href="/page/69/">69</a></li>
        
        <li
        ><a href="/page/70/">70</a></li>
        
        <li
        ><a href="/page/71/">71</a></li>
        
        <li
        ><a href="/page/72/">72</a></li>
        
        <li
        ><a href="/page/73/">73</a></li>
        
        <li
        ><a href="/page/74/">74</a></li>
        
        <li
        ><a href="/page/75/">75</a></li>
        
        <li
        ><a href="/page/76/">76</a></li>
        
        <li
        ><a href="/page/77/">77</a></li>
        
        <li
        ><a href="/page/78/">78</a></li>
        
        <li
        ><a href="/page/79/">79</a></li>
        
        <li
        ><a href="/page/80/">80</a></li>
        
        <li
        ><a href="/page/81/">81</a></li>
        
        <li
        ><a href="/page/82/">82</a></li>
        
        <li
        ><a href="/page/83/">83</a></li>
        
        <li
        ><a href="/page/84/">84</a></li>
        
        <li
        ><a href="/page/85/">85</a></li>
        
        <li
        ><a href="/page/86/">86</a></li>
        
        <li
        ><a href="/page/87/">87</a></li>
        
        <li
        ><a href="/page/88/">88</a></li>
        
        <li
        ><a href="/page/89/">89</a></li>
        
        <li
        ><a href="/page/90/">90</a></li>
        
        <li
        ><a href="/page/91/">91</a></li>
        
        <li
        ><a href="/page/92/">92</a></li>
        
        <li
        ><a href="/page/93/">93</a></li>
        
        <li
        ><a href="/page/94/">94</a></li>
        
        <li
        ><a href="/page/95/">95</a></li>
        
        <li
        ><a href="/page/96/">96</a></li>
        
        <li
        ><a href="/page/97/">97</a></li>
        
        <li
        ><a href="/page/98/">98</a></li>
        
        <li
        ><a href="/page/99/">99</a></li>
        
        <li
        ><a href="/page/100/">100</a></li>
        
        <li
        ><a href="/page/101/">101</a></li>
        
        <li
        ><a href="/page/102/">102</a></li>
        
        <li
        ><a href="/page/103/">103</a></li>
        
        <li
        ><a href="/page/104/">104</a></li>
        
        <li
        ><a href="/page/105/">105</a></li>
        
        <li
        ><a href="/page/106/">106</a></li>
        
        <li
        ><a href="/page/107/">107</a></li>
        
        <li
        ><a href="/page/108/">108</a></li>
        
        <li
        ><a href="/page/109/">109</a></li>
        
        <li
        ><a href="/page/110/">110</a></li>
        
        <li
        ><a href="/page/111/">111</a></li>
        
        <li
        ><a href="/page/112/">112</a></li>
        
        <li
        ><a href="/page/113/">113</a></li>
        
        <li
        ><a href="/page/114/">114</a></li>
        
        <li
        ><a href="/page/115/">115</a></li>
        
        <li
        ><a href="/page/116/">116</a></li>
        
        <li
        ><a href="/page/117/">117</a></li>
        
        <li
        ><a href="/page/118/">118</a></li>
        
        <li
        ><a href="/page/119/">119</a></li>
        
        <li
        ><a href="/page/120/">120</a></li>
        
        <li
        ><a href="/page/121/">121</a></li>
        
        <li
        ><a href="/page/122/">122</a></li>
        
        <li
        ><a href="/page/123/">123</a></li>
        
        <li
        ><a href="/page/124/">124</a></li>
        
        <li
        ><a href="/page/125/">125</a></li>
        
        <li
        ><a href="/page/126/">126</a></li>
        
        <li
        ><a href="/page/127/">127</a></li>
        
        <li
        ><a href="/page/128/">128</a></li>
        
        <li
        ><a href="/page/129/">129</a></li>
        
        <li
        ><a href="/page/130/">130</a></li>
        
        <li
        ><a href="/page/131/">131</a></li>
        
        <li
        ><a href="/page/132/">132</a></li>
        
        <li
        ><a href="/page/133/">133</a></li>
        
        <li
        >
        <a href="/page/37/" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
        </li>
        
        <li>
            <a href="/page/133/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
        </li>
        
    </ul>
    
  </div>
</div>


<script type="text/javascript">
var disqus_shortname = "dashsagittariussglory";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

<script src="http://purplepalmdash.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

