<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
	<meta name="generator" content="Hugo 0.32-DEV" />
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Dash &middot; Dash</title>

  
  <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/poole.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde-a.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/custom-additions.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/highlight/googlecode.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/8.5/styles/docco.min.css">
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="/js/html2canvas.js"></script>
  <script type='text/javascript'>
  function genPostShot() { 
          var rightNow = new Date();
          var imageName = rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");
          imageName += '.jpg'
          html2canvas(document.getElementsByClassName('post'), {
              background :'#FFFFFF',
              onrendered: function(canvas) {
  		
          	$('#test').attr('href', canvas.toDataURL("image/jpeg"));
          	$('#test').attr('download',imageName);
          	$('#test')[0].click();
              }
          });
  }; 
  
  </script>
  <script src="//cdn.bootcss.com/highlight.js/8.5/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124">
  <link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel="icon">

  
  
  
  <link href="http://purplepalmdash.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Dash &middot; Dash" />

  <meta name="description" content="Get busy living, or get busy dying.">
  <meta name="keywords" content="unix,virtualization,embedded,linux">
  
  
</head>
<body class="theme-base-0c">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <img src="http://purplepalmdash.github.io/images/mylogo.jpeg" alt="gravatar">
      <h1><a href="http://purplepalmdash.github.io/">Get busy living, or get busy dying.</a></h1>
      <a href="http://purplepalmdash.github.io/"><p>Dash</p></a>
    </div>

    <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/">First Page</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/post/">All Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/linux/">Linux</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/embedded/">Embedded System</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/virtualization">Virtualization</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/purplepalmdash"><i class="fa fa-github-square fa-3x"></i></a>
      
      <a href="https://cn.linkedin.com/in/yang-feipeng-1b909319"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://plus.google.com/u/0/106572959364703833986"><i class="fa fa-google-plus-square fa-3x"></i></a>
      <a href="https://www.facebook.com/yang.feipeng"><i class="fa fa-facebook-square fa-3x"></i></a>
      <a href="https://twitter.com/dashwillfly"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      <a href="http://purplepalmdash.github.io/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
      </li>
    </ul>

    

  </div>
</div>


<div class="content container">
  <div class="posts">
    
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2017/03/07/android-mount/">Android Mount</a>
      </h1>
      <span class="post-date">Mar 7, 2017 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/linux">Linux</a>
        
      </span>
      
      <p>The steps in Ubuntu includes:</p>

<pre><code>$ sudo pacman -S pcmanfm mtpfs gvfs-mtp gvfs-gphoto2 libmtp
</code></pre>

<p>Edit the fuse configuration via:</p>

<pre><code>$ sudo vim /etc/fuse.conf
user_allow_other
</code></pre>

<p>Mount the equipment to ~/mnt:</p>

<pre><code>$ mkdir -p ~/mnt
$ mtpfs -o allow_other ~/mnt
</code></pre>

<p>Now open pcmanfm you will see the attached new android equipment.</p>

<p>Or now if you insert the android phone, the pcmanfm will automatically mount
the equipment&rsquo;s file system.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2017/03/03/linux-tips7/">Linux Tips(7)</a>
      </h1>
      <span class="post-date">Mar 3, 2017 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/linux">Linux</a>
        
      </span>
      
      

<h3 id="1-cloudstack-issue">1. CloudStack Issue</h3>

<p>On ubuntu1404/1604, the template should enable HVM.<br />
Its partition size should less than the primary storage size.<br />
Password reset issue: Ubuntu1604, failed.</p>

<p>Ubuntu14.04 startup too slow, because of ntp, remove it <code>sudo update-rc.d -f ntp remove
</code></p>

<h3 id="2-ubuntu16-04-cloudstack-pass-issue">2. Ubuntu16.04 cloudstack-pass issue</h3>

<p>The reset-password script is located as
<code>/etc/init.d/cloud-set-guest-password</code>, then we could do following
configurations:</p>

<p>Remove the services via:</p>

<pre><code># update-rc.d -f cloud-set-guest-password remove
# cp /etc/init.d/cloud-setup-guest-password /usr/bin/
# chmod 777 /usr/bin/cloud-setup-guest-password
</code></pre>

<p>Before because you set <code>update-rc.d cloud-set-guest-password defaults 98</code>, so
first you should remove it.</p>

<p>Then Create a systemd service as <code>/lib/systemd/system/cloudpassword.service</code>:</p>

<pre><code>[Unit]
Description=cloudpass container

[Service]
Type=idle
Restart=always
ExecStart=/usr/bin/cloud-set-guest-password
ExecStop=/usr/bin/echo hello

[Install]
WantedBy=multi-user.target

</code></pre>

<p>Enable the service via:</p>

<pre><code># systemctl enable cloudpassword
</code></pre>

<p>After the network is online:</p>

<pre><code># systemctl enable systemd-networkd-wait-online.service
</code></pre>

<p>The steps could refers to another article.</p>

<h3 id="3-xenserver-timezone">3. XenServer Timezone</h3>

<p>Switch to UTC time:</p>

<pre><code># cp /usr/share/zoneinfo/UTC /etc/localtime
</code></pre>

<h3 id="4-gitbook-serve-ports">4. Gitbook serve ports</h3>

<p>Listening on other ports:</p>

<pre><code>$ gitbook --port 14001 serve
</code></pre>

<h3 id="5-quickstart-for-shadowsocks">5. Quickstart For ShadowSocks</h3>

<p>Install and configuration steps are listed as following(Ubuntu16.04):</p>

<pre><code># apt-get install python-pip
# pip install --upgrade pip
# pip install shadowsocks
# touch /etc/shadowsocks.json
{
&quot;server&quot;:&quot;1xx.xxx.xxx.xxx&quot;,
&quot;server_port&quot;:19175,
&quot;local_address&quot;:&quot;127.0.0.1&quot;,
&quot;local_port&quot;:1080,
&quot;password&quot;:&quot;XXXXXXXXXXXXXXXXXXXXXXx&quot;,
&quot;timeout&quot;:300,
&quot;method&quot;:&quot;aes-256-cfb&quot;,
&quot;fast_open&quot;:false
}
# vim /etc/rc.local
ssserver -c /etc/shadowsocks.json -d start
</code></pre>

<p>Now you could continue to configure your shadowsocks client side.</p>

<h3 id="6-mariadb-in-docker">6. MariaDB In Docker</h3>

<p>Connect to existing <code>docker-composed</code> mariadb instance via following command:</p>

<pre><code>sudo docker run -it -v /var/download/sbt/lili:/var/lib/mysql --link mariadb:mymariadb --net lilimarleen_default mariadb:latest /bin/bash
root@5d7eadc81b9e:/# mysql -h172.18.0.3 -P3306 -uroot -pexample
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 35
Server version: 10.1.20-MariaDB-1~jessie mariadb.org binary distribution

Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]&gt; \q
Bye
</code></pre>

<p><code>-v</code> is for using local volume for restoring aims.<br />
<code>--link</code> is for linking to existing instance.<br />
<code>-net</code> could be get via <code>docker net list</code>.</p>

<h3 id="7-cdn-speedup">7. cdn speedup</h3>

<p>For speed-up my blog, I changed the fonts/css from the template&rsquo;s default
location to <code>http://www.bootcdn.cn/?</code>, this cdn&rsquo;s speed is pretty good, the
speed has been greatly improved.</p>

<h3 id="8-git-diff">8. git diff</h3>

<p>First use <code>git log</code> for getting all of the commit history, then you could get
the md5 for each commitment, <code>git diff md51 md52</code> you could easily get the
differences.</p>

<h3 id="9-qemu-issue">9. qemu issue</h3>

<p>When meeting <code>guest has not initialize the display (yet)</code>, do following:</p>

<pre><code>$ sudo qemu-system-x86_64 -net nic -net user,hostfwd=tcp::2222-:22 -hda ./test.qcow2 -boot d -cdrom /mnt/CentOS-7-x86_64-Everything-1611.iso -m 2048 --enable-kvm -vga virtio
</code></pre>

<p><code>-vga virtio</code> solves this issue.</p>

<h3 id="10-bashrc-execution">10. bashrc execution</h3>

<p>Run <code>bashrc</code> at ArchLinux:</p>

<pre><code>$ vim ~/.bash_profile
if [ -f ~/.bashrc ]; then
  . ~/.bashrc
fi
$ vim ~/.bashrc
</code></pre>

<p>Then all of the items in <code>.bashrc</code> could be executed.</p>

<h3 id="11-shared-bash-history">11. Shared bash history</h3>

<p>Add following lines in to <code>~/.bashrc</code>:</p>

<pre><code>HISTSIZE=9000
HISTFILESIZE=$HISTSIZE
HISTCONTROL=ignorespace:ignoredups

history() {
  _bash_history_sync
  builtin history &quot;$@&quot;
}

_bash_history_sync() {
  builtin history -a         #1
  HISTFILESIZE=$HISTSIZE     #2
  builtin history -c         #3
  builtin history -r         #4
}

PROMPT_COMMAND=_bash_history_sync
</code></pre>

<h3 id="12-archlinux-virtual-network-start-failed">12. ArchLinux virtual network start failed</h3>

<p>Issue:</p>

<pre><code>when I start a virtual network named 'default' (created by libvirt), it occur that:
&quot;Error starting network 'default': internal error: Failed to initialize a valid firewall backend&quot;.
</code></pre>

<p>Solution:</p>

<pre><code>$ sudo pacman -S  ebtables dnsmasq
$ sudo systemctl restart libvirtd
</code></pre>

<p>then you could get your libvirtd networking work properly.</p>

<h3 id="13-network-manager-configuration">13. Network Manager Configuration</h3>

<p><a href="https://fedoraproject.org/wiki/Networking/Bridging">https://fedoraproject.org/wiki/Networking/Bridging</a></p>

<h3 id="14-enable-vncserver-in-firewalld">14. Enable vncserver in firewalld</h3>

<p>Manually enable the vnc-server service, then you could use vncviewer for
connecting the vnc server in ArchLinux:</p>

<pre><code># firewall-cmd --zone=public --add-service=vnc-server
</code></pre>

<p>Related commands:</p>

<p>List services:</p>

<pre><code># firewall-cmd --zone=public --list-services
</code></pre>

<p>Get all of the listed services:</p>

<pre><code># firewall-cmd --get-services
</code></pre>

<p>Get all of the zones:</p>

<pre><code># firewall-cmd --get-active-zones
# firewall-cmd --get-zones
# firewall-cmd --get-default-zone
</code></pre>

<h3 id="15-execute-mysql-command">15. Execute mysql command</h3>

<p>Execute like following:</p>

<pre><code>mysql -u $user -p$passsword -Bse &quot;command1;command2;....;commandn&quot;
</code></pre>

<h3 id="16-generate-the-md5-encrypted-passwd">16. Generate the md5 encrypted passwd</h3>

<p>Generate md5 encrypted passwd using passlib:</p>

<pre><code>$ sudo pip2 install passlib
$ python2 -c &quot;from passlib.hash import sha512_crypt; import getpass; print sha512_crypt.encrypt(getpass.getpass())&quot;
</code></pre>

<h3 id="17-quickly-setup-nginx">17. Quickly setup nginx</h3>

<p>In archlinux, do following:</p>

<pre><code>$ sudo pacman -S nginx
$ sudo vim /etc/nginx/nginx.conf
        location / {
            root   /media/sdb;
            index  index.html index.htm;
	    autoindex on;
        }
$ sudo systemctl enable nginx
$ sudo systemctl start nginx
</code></pre>

<p>Then you could see the nginx running on your server.</p>

<h3 id="18-minikube-quickstart-on-archlinux">18. minikube quickstart on archlinux</h3>

<p>Install and running minikube via:</p>

<pre><code>$ yaourt minikube
$ wget https://github.com/dhiltgen/docker-machine-kvm/releases/download/v0.7.0/docker-machine-driver-kvm
$ sudo mv docker-machine-driver-kvm /usr/local/bin
$ sudo chmod 777 /usr/local/bin/*
$ sudo minikube start --vm-driver kvm
$ curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.5.3/bin/linux/amd64/kubectl &amp;&amp; chmod +x kubectl &amp;&amp; sudo mv kubectl /usr/local/bin/
</code></pre>

<p>Then  you could begin using minikube.</p>

<h3 id="19-golang-building">19. Golang building</h3>

<p>When using hugo for building, the travis-ci complains:</p>

<pre><code>enc.SetIndent undefined
</code></pre>

<p>Solved via edit the <code>.travis.yml</code> file</p>

<pre><code>go:
-    - 1.6
+    - 1.7
</code></pre>

<p>Dependency on golang 1.7 solves the problem.</p>

<h3 id="20-auto-start-default-gw">20. Auto start default gw</h3>

<p>Start the default network for virsh via:</p>

<pre><code>$ sudo virsh net-start default
</code></pre>

<h3 id="21-archlinux-fonts">21. ArchLinux fonts</h3>

<p>Install fonts via:</p>

<pre><code>$ sudo  pacman -S adobe-source-han-sans-cn-fonts adobe-source-han-sans-tw-fonts
</code></pre>

<p>And mac fonts via:</p>

<pre><code>$ yaourt ttf-mac-fonts
</code></pre>

<h3 id="22-detect-windows">22. Detect Windows</h3>

<p>Detect Windows via:</p>

<pre><code>$ sudo apt-get install os-prober
$ sudo os-prober
$ sudo update-grub
</code></pre>

<h3 id="23-upgrade-shadowsocks">23. Upgrade Shadowsocks</h3>

<p>UPgrade the shadowsocks, so you could get more powerful tools..</p>

<pre><code>$  pip install --upgrade pi
$ sudo pip install --upgrade shadowsocks
</code></pre>

<h3 id="24-vagrant-ssh">24. vagrant ssh</h3>

<p>The configuration of vagrant ssh could be viewd via:</p>

<pre><code>$ vagrant ssh-config
</code></pre>

<h3 id="25-k8s-iptables-issue">25. k8s iptables issue</h3>

<p>Add this service named <code>iptableslast.service</code>, enable and start the service,
then system will run iptables once for setup the rules.</p>

<pre><code>[Unit]
Description=iptables last rule

[Service]
Type=idle
Restart=on-failure
ExecStart=/sbin/iptables -P FORWARD ACCEPT
ExecStop=/usr/bin/echo hello

[Install]
WantedBy=multi-user.target

</code></pre>

<h3 id="26-install-vagrant-plugins-specified-version">26. Install vagrant plugins(specified version)</h3>

<p>Specified the version of plugins:</p>

<pre><code>vagrant plugin install --plugin-version  0.0.37 vagrant-libvirt
</code></pre>

<h3 id="27-nested-kvm-in-centos7">27. nested kvm in CentOS7</h3>

<p>Enable it via following commands:</p>

<pre><code>[root@dlp ~]# vi /etc/modprobe.d/kvm-nested.conf
# create new
options kvm_intel nested=1
[root@dlp ~]# modprobe -r kvm_intel # unload
[root@dlp ~]# modprobe kvm_intel # reload again
[root@dlp ~]# cat /sys/module/kvm_intel/parameters/nested 
Y# just enabled
</code></pre>

<h3 id="28-vagrant-libvirt-issue">28. vagrant-libvirt issue</h3>

<p>The eth1 won&rsquo;t be startup, so manually execute <code>service network restart</code> in
CentOS7.</p>

<h3 id="29-save-load-docker-images">29. Save/Load Docker images</h3>

<p><a href="https://gist.github.com/hydra1983/22b2bed38b4f5f56caa87c830c96378d">https://gist.github.com/hydra1983/22b2bed38b4f5f56caa87c830c96378d</a></p>

<p>Commandline:</p>

<pre><code>$ ./docker_images.sh save_images
$ ./docker_images.sh load_images
</code></pre>

<h3 id="30-yum-download-src-rpms">30. yum download src rpms</h3>

<p>yum download the packages src via:</p>

<pre><code># yum install yum-utils
# yumdownloader --source mypkg
</code></pre>

<h3 id="30-quickstart-vps-centos6">30. Quickstart VPS(CentOS6)</h3>

<p>Lizcat, since the centos 6 won&rsquo;t support docker well, switches to Ubuntu</p>

<pre><code># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
# yum install -y python-pip wget
</code></pre>

<h3 id="31-downgrade-packages-in-archlinux">31, Downgrade packages in archlinux</h3>

<p>via <code>yaourt downgrade</code>, then downgrade the package name.</p>

<h3 id="32-issues-for-gzlib">32. Issues for Gzlib</h3>

<p>clearing the cookie, then you could login, or you won&rsquo;t be logined into the
system.</p>

<h3 id="33-install-haroopad">33. Install haroopad</h3>

<p>Via following steps:</p>

<pre><code>解压haroopad-v0.13.1-x64.tar.gz
cd /usr/local/src
sudo mkdir haroopad
sudo tar -zxvf haroopad-v0.13.1-x64.tar.gz -C haroopad

之后会出现如下内容
control.tar.gz
data.tar.gz
debian-binary

解压 data.tar.gz，并将其子目录下边的内容拷贝到 “/” 目录下
tar zxvf data.tar.gz
sudo cp -r ./usr /

解压control.tar.gz，并赋予755权限
tar zxf control.tar.gz
chmod 755 postinst
sudo ./postinst
</code></pre>

<h3 id="34-hostname-without-restart">34. hostname without restart</h3>

<p>Simply try <code>hostname YourNewHostName</code>, it could immediately change your
hostname, without a restart.</p>

<h3 id="35-make-partition-larger-than-2t">35. Make partition larger than 2T</h3>

<p>Your should use parted rather than fdisk, cause parted could support gpt mode.</p>

<pre><code># parted /dev/sdb     #使用parted来对GPT磁盘操作，进入交互式模式
(parted) mklabel gpt   # 将MBR磁盘格式化为GPT
(parted) mkpart primary ext4 0% 100%    将所有容量分为一个主分区
(parted) p    #打印当前分区
(parted) q    #退出
</code></pre>

<h3 id="36-oracle-db-installation-issue">36. Oracle DB Installation issue</h3>

<p>On pdksh missing.</p>

<pre><code>Solution

Solution for 11.2.0.3 64-bit (x86-64)

If you have downloaded the 11.2.0.3 media from My Oracle Support (MOS) and extracted the software to &lt;path&gt;/database, do the following:

Change directory to &lt;path&gt;/database/stage/cvu/cv/admin
Backup cvu_config cp cvu_config backup_cvu_config
Edit cvu_config and change the following line CV_ASSUME_DISTID=OEL4 to CV_ASSUME_DISTID=OEL6
Save the updated cvu_config file
Install the 11.2.0.3 software using:
&lt;path&gt;/database/runInstaller
cd &lt;path&gt;/database
./runInstaller
OUI should now perform the OEL6 prerequisite checks (which are identical to the RHEL6 prerequisite checks) and no longer report that packages elfutils-libelf-devel-0.97 and pdksh-5.2.14 are missing
</code></pre>

<h3 id="37-ansible-jinja-issue">37. Ansible jinja issue</h3>

<p>Changed from</p>

<pre><code>  register: check_powershell5
  when: &quot;{{ ansible_PSVersionTable.Major|int &lt; 5 }}&quot;
  tags: win_powershell
</code></pre>

<p>to</p>

<pre><code>  register: check_powershell5
  when: ansible_PSVersionTable.Major|int &lt; 5 
  tags: win_powershell
</code></pre>

<p>could solve the jinjia problem, <code>when statements should not include jinja2
templating delimiters such as {{ }} or {% %}.</code></p>

<h3 id="38-docker-dm-basesize">38. Docker dm.basesize</h3>

<p>For building larger docker image, you have to enable <code>dm.basesize</code>, however
the docker&rsquo;s new version have to specify more parameters, the example is
listed as:</p>

<pre><code>ExecStart=/usr/bin/dockerd -s devicemapper --storage-opt dm.basesize=50G --registry-mirror=http://1a653205.m.daocloud.io -H fd://
</code></pre>

<h3 id="39-samba-issue">39. Samba issue</h3>

<p>Add samba user and set its username/passwd via:</p>

<pre><code># useradd xxx
# smbpasswd -a xxx
</code></pre>

<h3 id="40-customized-ssh-key-for-vagrant">40. Customized ssh key for vagrant</h3>

<p>Add following definition into the vagrantfile:</p>

<pre><code>config.ssh.private_key_path = &quot;/home/joseph/.ssh/id_rsa&quot;
</code></pre>

<h3 id="41-manually-setup-runner">41. Manually setup runner</h3>

<p>When the runner is not set, do enable this manually for project:</p>

<p><img src="/images/2017_06_22_14_33_16_645x420.jpg" alt="/images/2017_06_22_14_33_16_645x420.jpg" /></p>

<h3 id="42-tar-without-folder-prefix">42. tar without folder prefix</h3>

<p>You could do via following ways:</p>

<pre><code>cd src/
tar czf ${topdir}/SOURCES/${PKGNAME}.tar.gz $1
cd ..
</code></pre>

<p>Or:</p>

<pre><code>tar czf ${topdir}/SOURCES/${PKGNAME}.tar.gz -C src/ .
</code></pre>

<h3 id="43-7zip-split-files">43. 7zip split files</h3>

<p>Using following command:</p>

<pre><code># 7z a -tzip -v1024m secondnode
</code></pre>

<p>Recover:</p>

<pre><code># 7z e xxx.zip.001
</code></pre>

<h3 id="44-rhel-download">44. rhel download</h3>

<p><a href="http://linuxfly.org/post/659/">http://linuxfly.org/post/659/</a></p>

<h3 id="45-performance">45. performance</h3>

<p>hald introduction:</p>

<p><a href="https://systembash.com/disabling-the-hald-addon-storage-service-on-centosredhat/">https://systembash.com/disabling-the-hald-addon-storage-service-on-centosredhat/</a></p>

<pre><code>The hald – Hardware Access Layer Daemon – runs several processes in order to keep track of what hardware is installed on your system. This includes polling USB Drives and ‘hot-swap’ devices to check for changes along with a host of other tasks.

You might see it running on your system as follows:

2474 ? S 0:00 \_ hald-runner
2481 ? S 0:00 \_ hald-addon-acpi: listening on acpid socket /var/run/acpid.socket
2487 ? S 0:00 \_ hald-addon-keyboard: listening on /dev/input/event0
2495 ? S 41:47 \_ hald-addon-storage: polling /dev/hdc

If your system is static and the devices do not change, you can actually disable this service using a policy entry.

Create a file in your policy directory, for example /etc/hal/fdi/policy/99-custom.fdi. Add the text:
</code></pre>

<p>Solved(completely disable hald):</p>

<pre><code>https://zhuqy.wordpress.com/2011/04/07/disable-the-hald-addon-storage-completely/

&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;deviceinfo version=&quot;0.2&quot;&gt;
	&lt;device&gt;
		&lt;match key=&quot;storage.removable&quot; bool=&quot;true&quot;&gt;
			&lt;remove key=&quot;info.addons&quot; type=&quot;strlist&quot;&gt;hald-addon-storage&lt;/remove&gt;
		&lt;/match&gt;
	&lt;/device&gt;
&lt;/deviceinfo&gt;
</code></pre>

<h3 id="46-vagrant-and-ansible">46. vagrant and ansible</h3>

<p>After created vagrant, use ansible the following way:</p>

<pre><code>$ ansible --private-key=~/.vagrant.d/insecure_private_key -u vagrant ...
</code></pre>

<p>for testing module ping/command, etc.</p>

<h3 id="47-clean-deb-pkgs">47. clean deb pkgs</h3>

<p>via <code>apt-get clean</code>, then you could get the clean directory.</p>

<h3 id="48-shipyard-related">48. shipyard related</h3>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-deploy-wordpress-with-shipyard-on-ubuntu-14-04">https://www.digitalocean.com/community/tutorials/how-to-deploy-wordpress-with-shipyard-on-ubuntu-14-04</a></p>

<p>Startup:</p>

<p><a href="https://juejin.im/entry/588940fc2f301e0069b2397d">https://juejin.im/entry/588940fc2f301e0069b2397d</a></p>

<h3 id="49-cowsay-fortune">49. Cowsay fortune</h3>

<p>Add following items in your <code>~/.zshrc</code>, then cowsay will always say blablabla:</p>

<pre><code>if [ -x /usr/bin/cowsay -a -x /usr/bin/fortune ]; then
    fortune | cowsay
fi
</code></pre>

<h3 id="50-edraw">50. EDRAW</h3>

<p>Good software for drawing pictures.</p>

<h3 id="51-graphviz">51. graphviz</h3>

<p><a href="http://dockone.io/article/2495">http://dockone.io/article/2495</a></p>

<h3 id="52-memory-checking">52. Memory Checking</h3>

<p><a href="http://blog.csdn.net/beckdon/article/details/36174925">http://blog.csdn.net/beckdon/article/details/36174925</a></p>

<p>use <code>last reboot</code> for checking the reboot reason.</p>

<p>use <code>cat /var/log/messages | more</code> for knowing the detailed reason.</p>

<h3 id="53-virsh-net-autostart">53. virsh net-autostart</h3>

<p>Previously I found my virsh network default won&rsquo;t startup automatically, so I
add one tips in <code>~/.config/awesome/rc.lua</code>, but yesterday I found one tip for
adding the default network auto-start:</p>

<pre><code>$ sudo virsh net-autostart default
</code></pre>

<p>So from now on my default networking for libvirt will start automatically
every time.</p>

<h3 id="54-capture-with-filename-in-xclip">54. Capture with filename in xclip</h3>

<p>I changed my <code>mycapscr</code> to following, so I could save 3 seconds for each
screenshot.</p>

<pre><code>scrot -s '%Y_%m_%d_%H_%M_%S_$wx$h.jpg' -e 'mv $f ~/capscr/'
ls -lt ~/capscr | sed -n 2p | awk {'print $9'} | xclip -r

</code></pre>

<h3 id="55-convert-from-vagrant-to-kvm">55. Convert from vagrant to kvm</h3>

<p>First you have to find the vmdk files of vagrant, then convert it from vmdk to
qcow2:</p>

<pre><code>$ sudo qemu-img convert -f vmdk -O qcow2 box-disk001.vmdk gitlab.qcow2
</code></pre>

<p>The <code>gitlab.qcow2</code> is the one you want, enjoy it.</p>

<h3 id="56-quickstart-for-dce">56. QuickStart For DCE</h3>

<p>Install your own dce:</p>

<pre><code># gzip -dc dce-2.6.0.tar.gz | docker load
# bash -c &quot;$(docker run --rm daocloud.io/daocloud/dce:2.6.0 install)&quot;

</code></pre>

<h3 id="57-vimdiff-horizon">57. vimdiff horizon</h3>

<p>Press ctrl+w, then J</p>

<h3 id="58-apt-get-specify-version">58. apt-get specify version</h3>

<p>First you should use <code>apt-cache policy xxxx</code> to get all of the possible
version of this software, then, you specify the version in following command
like:</p>

<pre><code># sudo apt-get install gparted=0.16.1-1
</code></pre>

<h3 id="59-qemu-kvm-location-in-centos">59. qemu-kvm location in centos</h3>

<p>In <code>/usr/libexec/qemu-kvm</code>.</p>

<h3 id="60-setup-hostname">60. Setup hostname</h3>

<p>via <code>nmtui</code> in centos7 you could setup the hostname in centos7.</p>

<h3 id="61-libvirt-static-ip">61. libvirt static IP</h3>

<p>Via <code>virsh net-dumpxml&gt;abc.xml ; vim abc.xml; virsh net-define abc.xml</code>, you
could edit your xml like following:</p>

<pre><code>&lt;ip address=&quot;192.168.122.1&quot; netmask=&quot;255.255.255.0&quot;&gt;
  &lt;dhcp&gt;
    &lt;range start=&quot;192.168.122.100&quot; end=&quot;192.168.122.254&quot; /&gt;
    &lt;host mac=&quot;00:16:3e:77:e2:ed&quot; name=&quot;foo.example.com&quot; ip=&quot;192.168.122.10&quot; /&gt;
    &lt;host mac=&quot;00:16:3e:3e:a9:1a&quot; name=&quot;bar.example.com&quot; ip=&quot;192.168.122.11&quot; /&gt;
  &lt;/dhcp&gt;
&lt;/ip&gt;
</code></pre>

<h3 id="62-chromium-passwd-generator">62. chromium passwd generator</h3>

<p><img src="/images/2017_08_23_14_11_10_622x322.jpg" alt="/images/2017_08_23_14_11_10_622x322.jpg" /></p>

<h3 id="64-rancheros-set-registry">64. rancheros set registry</h3>

<p>Set the parameter of docker via following command:</p>

<pre><code>$ sudo ros config get rancher.docker.insecure_registry
$ sudo ros config set rancher.docker.insecure_registry [&quot;192.168.124.211:8088&quot;]
</code></pre>

<p>more detailed parameters could be found at:</p>

<p><a href="http://rancher.com/docs/os/v1.0/en/configuration/docker/">http://rancher.com/docs/os/v1.0/en/configuration/docker/</a></p>

<h3 id="65-canary-build-test">65. canary build/test</h3>

<pre><code>In software testing, a canary is a push of programming code changes to a small group of end users who are unaware that they are receiving new code. Because the canary is only distributed to a small number of users, its impact is relatively small and changes can be reversed quickly should the new code prove to be buggy. Canary tests, which are often automated, are run after testing in a sandbox environment has been completed.
</code></pre>

<p>Real meaning:</p>

<p>煤矿工人过去带着金丝雀下井。这种鸟对危险气体的敏感度超过人。如果金丝雀死了，矿工便知道井下有危险气体，需要撤离。」</p>

<p>原来 Canary build 是这个意思</p>

<h3 id="66-docker-cp">66. docker cp</h3>

<p>Directly copy from container to host via:</p>

<pre><code># docker cp 0a63783b716a:/root/d  /tmp/
</code></pre>

<h3 id="67-xrdp-display-error">67. xrdp display error</h3>

<p>When some window displayed error, using 24-bit color.</p>

<h3 id="68-e-sata-and-udev">68. e-sata and udev</h3>

<p>For using e-sata and udiskie, you have to change the following for using
properly:</p>

<pre><code>➜  rules.d pwd
/etc/udev/rules.d
➜  rules.d cat 99-udisks2.rules
# UDISKS_FILESYSTEM_SHARED
# ==1: mount filesystem to a shared directory (/media/VolumeName)
# ==0: mount filesystem to a private directory (/run/media/$USER/VolumeName)
# See udisks(8)
ENV{ID_FS_USAGE}==&quot;filesystem|other|crypto&quot;, ENV{UDISKS_FILESYSTEM_SHARED}=&quot;1&quot;
</code></pre>

<p>Thus your disk will be mounted under in <code>/media</code> rather than in
<code>/run/media/xxx</code>, this means your directoy will be seemed as <code>shared</code>, so your
libvirt daemon will access it properly.</p>

<h3 id="69-dashboard-issue">69. dashboard issue</h3>

<p>dashbaord v1.6.2 has a bug that you could not get heapster info.</p>

<pre><code>t is solved. This is a cluster issue. In 1.6.2 dashboard was building wrong path to heapster and there was always the same error that health check to heapster was failing because dashboard could not access it.
</code></pre>

<h3 id="70-write-bat-issues">70. Write bat issues</h3>

<p>Change new line from unix to windows:</p>

<pre><code># unix2dos xxxx
</code></pre>

<p>Change filename from UTF-8 to GBK:</p>

<pre><code># convmv -f zh_CN.UTF-8 -t  GBK -r --notest ./
</code></pre>

<p>Change file content from UTF-8 to GBK:</p>

<pre><code># enca -L zh_CN -x GBK *
</code></pre>

<p>Refers to :</p>

<p><a href="http://blog.csdn.net/a280606790/article/details/8504133">http://blog.csdn.net/a280606790/article/details/8504133</a></p>

<h3 id="71-gitlab-change-ip">71. gitlab change ip</h3>

<p>When changing ip in gitlab server, do following steps:</p>

<pre><code>The correct place in an Omnibus install is:

/etc/gitlab/gitlab.rb
    external_url 'http://gitlab.example.com'
Finally, you'll need to execute sudo gitlab-ctl reconfigure and sudo gitlab-ctl restart so the changes apply.
</code></pre>

<h3 id="72-changing-ip-using-bat">72. Changing IP using bat</h3>

<p>Read from the file, and generate the bat file with each person&rsquo;s own ip
address setting.</p>

<pre><code>#!/bin/sh
while read line
do
	#echo $line
	NAME=`echo $line|awk {'print $1'}`
#	echo $NAME
	IP=`echo $line|awk {'print $4'}`
#	echo $IP
	ORG=`echo $line|awk {'print $2'}`
#	echo $ORG
        echo -n 'netsh interface ipv4 delete dnsservers &quot;本地连接&quot; all'&gt;${NAME}_${ORG}.bat
	echo 'netsh interface ipv4 set address name=&quot;本地连接&quot; static 192.168.103.'${IP} '255.255.255.0 192.168.103.1'&gt;&gt;${NAME}_${ORG}.bat
done&lt;inhuajing.txt
</code></pre>

<h3 id="73-windows-uptime">73. Windows uptime</h3>

<p>View windows uptime via:</p>

<p><code>systeminfo</code></p>

<h3 id="74-timezone-change-in-centos">74. Timezone change in CentOS</h3>

<p>Via following commands:</p>

<pre><code># timedatectl set-timezone America/Chicago
Verify new settings by typing the following two commands:
# date
# ls -l /etc/localtime
</code></pre>

<h3 id="75-forwarding-to-vm-traffic">75. Forwarding to vm traffic</h3>

<p>In host machine, do following, then you could forwarding the traffic from host
machine 2222 to vm(192.168.122.203)&rsquo;s 22 port.</p>

<pre><code>$sudo iptables -t nat -A PREROUTING -p tcp --dport 2222 -j DNAT --to-destination 192.168.122.203:22
$sudo iptables -t nat -A POSTROUTING -p tcp --dport 22 -d 192.168.122.203 -j SNAT --to 192.168.122.1
</code></pre>

<h3 id="76-install-htpasswd">76. Install htpasswd</h3>

<p>Install htpasswd in archlinux via <code>yaourt apache-tools</code>.</p>

<h3 id="77-write-back-to-write-through">77. Write back to Write Through</h3>

<p>Via following command:</p>

<p><img src="/images/2017_10_18_16_05_30_1283x314.jpg" alt="/images/2017_10_18_16_05_30_1283x314.jpg" /></p>

<h3 id="78-archlinux-offline">78. archlinux offline</h3>

<p><a href="https://bbs.archlinux.org/viewtopic.php?id=229502">https://bbs.archlinux.org/viewtopic.php?id=229502</a></p>

<h3 id="79-git">79. git</h3>

<p>git file too large</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2017/03/02/migration-docker-based-wordpress/">Migration Docker Based WordPress</a>
      </h1>
      <span class="post-date">Mar 2, 2017 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/linux">Linux</a>
        
      </span>
      
      

<h3 id="aim">AIM</h3>

<p>For last 3 days I was busy designing the website for a company, I run
everything in docker, and finish the design very fast. Now I want to migrate
it from the old vps to a new vps, following records all of the steps.</p>

<h3 id="data-volume-migration">Data Volume Migration</h3>

<p>Examine the data volume via following commands:</p>

<pre><code># docker volume ls | grep db
local               makeclean_db_data
# docker volume ls | grep html
local               makeclean_html
</code></pre>

<p>Get the volume mount point:</p>

<pre><code># docker volume inspect makeclean_html | grep -i mountpoint
        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/makeclean_html/_data&quot;,
# docker volume inspect makeclean_db_data | grep -i mountpoint
        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/makeclean_db_data/_data&quot;,
</code></pre>

<p>Now zip all of the data volume:</p>

<pre><code># tar czf db_data.tar.gz /var/lib/docker/volumes/makeclean_db_data/_data
# tar czf html.tar.gz /var/lib/docker/volumes/makeclean_html/_data
</code></pre>

<p>Copy the 2 gz files to your new vps.</p>

<h3 id="adjust">Adjust</h3>

<p>Start the docker-compose like the steps in last article, then manually stop
the docker instance, replace the data volume using the 2 gz files, start the
docker instance again.</p>

<p>Now you will be leading the old domain name, we need to change the options of
wordpress database, we create a new mysql docker instance for changing the
wordpress database:</p>

<pre><code># docker run -it --link wordpress_db_1:mysql --net wordpress_default mysql:5.7 /bin/bash
root@95f633180461:/#
</code></pre>

<p>In this newly created docker instance you could use mysql client tools for
changing wordpress options(<code>172.19.0.2</code> is your mysql server):</p>

<pre><code># mysql -h172.19.0.2 -P3306 -uroot -pwordpress
</code></pre>

<p>Mysql adjust commands ls listed as following:</p>

<pre><code>use wordpress;
UPDATE wp_options SET option_value = replace(option_value, 'xxx.xxx.222.222:8000','localhost:8000') ;
UPDATE wp_posts SET post_content = replace(post_content, 'xxx.xxx.222.222:8000','localhost:8000') ;
UPDATE wp_comments SET comment_content = replace(comment_content, 'xxx.xxx.222.222:8000', 'localhost:8000') ;
UPDATE wp_comments SET comment_author_url = replace(comment_author_url, 'xxx.xxx.222.222:8000', 'localhost:8000') ;
\q
</code></pre>

<p>Now restart the docker instance, you will get the wordpress running in new
vps.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2017/02/27/dockerizedwordpressquickstart/">DockerizedWordpressQuickStart</a>
      </h1>
      <span class="post-date">Feb 27, 2017 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/linux">Linux</a>
        
      </span>
      
      

<h3 id="aim">AIM</h3>

<p>Recently I want to setup a wordpress based website and quickly adjust the
content, since the time is so limted, I choose docker for development and
finish the task soonly, this article records all of the detailed steps.</p>

<h3 id="docker-compose-the-wordpress">Docker-compose the wordpress</h3>

<p>We use docker-compose for composing the wordpress based apps, the commands
listed as following:</p>

<pre><code>$ mkdir -p ~/code/wordpress
$ vim docker-compose.yml
</code></pre>

<p>The <code>docker-compose.yml</code> file is listed as following:</p>

<pre><code>version: '2'

services:
   db:
     image: mysql:5.7
     volumes:
       - db_data:/var/lib/mysql
     restart: always
     environment:
       MYSQL_ROOT_PASSWORD: wordpress
       MYSQL_DATABASE: wordpress
       MYSQL_USER: wordpress
       MYSQL_PASSWORD: wordpress

   wordpress:
     depends_on:
       - db
     image: wordpress:latest
     volumes:
       - html:/var/www/html
     ports:
       - &quot;8000:80&quot;
     restart: always
     environment:
       WORDPRESS_DB_HOST: db:3306
       WORDPRESS_DB_PASSWORD: wordpress
volumes:
    db_data:
    html:
</code></pre>

<p>Now use following commands for startup the wordpress or delete all of the
content:</p>

<pre><code>#### Startup the website
$ sudo docker-compose up -d

#### Down the wordpress
$ sudo docker-compose down
</code></pre>

<p>Now pick up your browser for visting <code>http://YourIPAddress:8000</code> you could get
the wordpress installed and run.</p>

<p><img src="/images/2017_02_27_16_31_18_400x737.jpg" alt="/images/2017_02_27_16_31_18_400x737.jpg" /></p>

<p><img src="/images/2017_02_27_16_32_29_562x517.jpg" alt="/images/2017_02_27_16_32_29_562x517.jpg" /></p>

<h3 id="customize-the-website">Customize the website</h3>

<p>We want to use the <code>makeclean</code> template for setting up our website(because I
am setting up a clean corporation website for my friends). Download it
directly from internet:</p>

<pre><code>$ wget http://dlw.press/themes/corporate/makeclean.zip
$ mkdir -p ~/code/wordpress/makeclean
$ cp makeclean.zip ~/code/wordpress/makeclean
$ cd ~/code/wordpress/makeclean &amp;&amp; unzip makeclean.zip
</code></pre>

<p>Inspect the volumes and install the <code>makeclean</code> template:</p>

<pre><code>$ sudo  docker volume ls | grep html
local               makeclean_html
$ sudo docker volume inspect makeclean_html 
[
    {
        &quot;Name&quot;: &quot;makeclean_html&quot;,
        &quot;Driver&quot;: &quot;local&quot;,
        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/makeclean_html/_data&quot;,
        &quot;Labels&quot;: null
    }
]
</code></pre>

<p>Now copy the <code>makeclean</code> template into the docker volume:</p>

<pre><code># cp -r ~/code/wordpress/makeclean/ /var/lib/docker/volumes/makeclean_html/_data/wp-content/themes/
</code></pre>

<p>Now Open themes, you could see the <code>Make Clean</code> template has been installed:</p>

<p><img src="/images/2017_02_27_16_34_01_924x426.jpg" alt="/images/2017_02_27_16_34_01_924x426.jpg" /></p>

<p>Click <code>Enable</code> you could startup the template, then click <code>Begin installing
plugins</code> for installing the plugins:</p>

<p><img src="/images/2017_02_27_16_35_11_473x313.jpg" alt="/images/2017_02_27_16_35_11_473x313.jpg" /></p>

<p>Install the following plugins:</p>

<p><img src="/images/2017_02_27_16_35_45_475x385.jpg" alt="/images/2017_02_27_16_35_45_475x385.jpg" /></p>

<p>Press <code>One Click Demo Data</code> for enable the demo:</p>

<p><img src="/images/2017_02_27_16_36_49_502x137.jpg" alt="/images/2017_02_27_16_36_49_502x137.jpg" /></p>

<p>Click <code>02 Home2</code> and check all of the options and begin install, you should
take for a while for waiting all of the datas being downloaded into local
directory:</p>

<p><img src="/images/2017_02_27_16_38_13_797x659.jpg" alt="/images/2017_02_27_16_38_13_797x659.jpg" /></p>

<p>Be sure to activate the <code>Envato Toolkit</code> plugins.</p>

<p>Now refresh the website&rsquo;s first page you will see the good-looking website has
been set.</p>

<p><img src="/images/2017_02_27_16_41_36_1221x786.jpg" alt="/images/2017_02_27_16_41_36_1221x786.jpg" /></p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2017/02/23/%E7%94%A8git%E5%92%8Cdocker%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/">用Git和Docker快速部署应用程序</a>
      </h1>
      <span class="post-date">Feb 23, 2017 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/linux">Linux</a>
        
      </span>
      
      

<h3 id="参考资料">参考资料</h3>

<p>《Docker基础与实战》第八章 (韩) 李在弘。</p>

<h3 id="环境">环境</h3>

<p>本机, ArchLinux.<br />
服务器, DigitalOcean, Ubuntu14.04.<br />
之所以选择DO的主机，是因为它位于墙外，不会有防火墙的阻挡，每次都能编译成功。</p>

<h3 id="本机配置">本机配置</h3>

<h4 id="git">Git</h4>

<p>ArchLinux上安装<code>sudo pacman -S git</code>， 之后可以配置global:</p>

<pre><code>$ git config --global user.name xxxx
$ git config --global user.email xxxx@gamil.com
</code></pre>

<h4 id="app-js">app.js</h4>

<p>用Node.js编写一个简单的Web服务器，返回<code>Hello Docker</code>:</p>

<pre><code>var express = require('express');
var app = express();

app.get(['/', '/index.html'], function (req, res) {
  res.send('Hello Docker1');
});

app.listen(80);
</code></pre>

<h4 id="package-json">package.json</h4>

<p>用于描述运行该程序的依赖关系:</p>

<pre><code>{
  &quot;name&quot;: &quot;exampleapp&quot;,
  &quot;description&quot;: &quot;Hello Docker&quot;,
  &quot;version&quot;: &quot;0.0.1&quot;,
  &quot;dependencies&quot;: {
    &quot;express&quot;: &quot;4.4.x&quot;
  }
}
</code></pre>

<h4 id="dockerfile">Dockerfile</h4>

<p>用于运行该APP的Docker容器定义如下:</p>

<pre><code>FROM ubuntu:14.04

RUN apt-get update
RUN apt-get install -y nodejs npm

ADD app.js /var/www/app.js
ADD package.json /var/www/package.json

WORKDIR /var/www
RUN npm install

CMD nodejs app.js
</code></pre>

<h3 id="do服务器配置">DO服务器配置</h3>

<h4 id="git配置">Git配置</h4>

<p>需要安装Docker， Docker的安装方法不再重复，安装git, 安装方法也不再重复.</p>

<p>创建服务器端的git仓库:</p>

<pre><code>$ cd ~
$ git init exampleapp
$ cd exampleapp
$ git config receive.denycurrentbranch ignore
</code></pre>

<p>配置成<code>receive.denycurrentbranch ignore</code>是为了便于从开发者PC接收推送的源代码.</p>

<h4 id="git-hook配置">Git Hook配置</h4>

<p>在<code>~/exampleapp/.git/hooks</code>目录下，创建一个<code>post-receive</code>文件，内容如下:</p>

<pre><code>#!/bin/bash

APP_NAME=exampleapp
APP_DIR=$HOME/$APP_NAME
REVISION=$(expr substr $(git rev-parse --verify HEAD) 1 7)

GIT_WORK_TREE=$APP_DIR git checkout -f

cd $APP_DIR
docker build --tag $APP_NAME:$REVISION .
docker stop $APP_NAME
docker rm $APP_NAME
docker run -d --name $APP_NAME -p 8068:80 $APP_NAME:$REVISION
</code></pre>

<p>保存并设置可执行权限:</p>

<pre><code>$ chmod +x ~/exampleapp/.git/hooks/post-receive
</code></pre>

<h3 id="更新流程">更新流程</h3>

<p>在开发机的目录下，添加remote分支:</p>

<pre><code>$ git remote add origin dash@xxx.xxx.xxx.x:exampleapp
</code></pre>

<p>如果你的DO上主机使用别的端口，例如8894端口，则编辑ssh的配置，为主机指定端口即可:</p>

<pre><code>$ vim ~/.ssh/config
host 1xx.xx.xx.xxx
port 8894
</code></pre>

<p>此时每次提交的代码都会触发DO上主机的自动化构建过程，且自动侦听8068端口。</p>

<h3 id="自动推送到服务器">自动推送到服务器</h3>

<p>只需要更改<code>post-receive</code>文件即可实现自动推送流程:</p>

<pre><code>#!/bin/bash

APP_NAME=exampleapp
APP_DIR=$HOME/$APP_NAME
REVISION=$(expr substr $(git rev-parse --verify HEAD) 1 7)

+++ REGISTRY=192.168.0.40:5000
+++ APP_SERVERS=(
+++   &quot;pyrasis@192.168.0.101&quot;
+++   &quot;pyrasis@192.168.0.102&quot;
+++ )

GIT_WORK_TREE=$APP_DIR git checkout -f

cd $APP_DIR
docker build --tag $APP_NAME:$REVISION .
docker tag $APP_NAME:$REVISION $REGISTRY/$APP_NAME:$REVISION
docker push $REGISTRY/$APP_NAME:$REVISION

+++ SSH=&quot;ssh -o StrictHostKeyChecking=no&quot;
+++ for SERVER in ${APP_SERVERS[@]}
+++ do
+++   $SSH $SERVER docker pull $REGISTRY/$APP_NAME:$REVISION
+++   $SSH $SERVER docker stop $APP_NAME
+++   $SSH $SERVER docker rm $APP_NAME
+++   $SSH $SERVER docker run -d --name $APP_NAME \
+++     -p 80:80 $REGISTRY/$APP_NAME:$REVISION
+++ done
</code></pre>

<p>上面的代码需要事先实现中转机(即运行git的机器)与目标服务器的ssh免登录设置。</p>

      
    </div>
    
    

<ul class="pagination">
    
    <li>
        <a href="/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
    </li>
    
    <li
    >
    <a href="/page/12/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
    </li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/">1</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/2/">2</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/3/">3</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="disabled"><span aria-hidden="true">&hellip;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/12/">12</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    class="active"><a href="/page/13/">13</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/14/">14</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="disabled"><span aria-hidden="true">&hellip;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/155/">155</a></li>
    
    
    <li
    >
    <a href="/page/14/" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
    </li>
    
    <li>
        <a href="/page/155/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
    </li>
    
</ul>

  </div>
</div>


<script src="http://purplepalmdash.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

