<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
	<meta name="generator" content="Hugo 0.31-DEV" />
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Dash &middot; Dash</title>

  
  <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/poole.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/hyde-a.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/custom-additions.css?ref=abc124">
  <link rel="stylesheet" href="http://purplepalmdash.github.io/css/highlight/googlecode.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/8.5/styles/docco.min.css">
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="/js/html2canvas.js"></script>
  <script type='text/javascript'>
  function genPostShot() { 
          var rightNow = new Date();
          var imageName = rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");
          imageName += '.jpg'
          html2canvas(document.getElementsByClassName('post'), {
              background :'#FFFFFF',
              onrendered: function(canvas) {
  		
          	$('#test').attr('href', canvas.toDataURL("image/jpeg"));
          	$('#test').attr('download',imageName);
          	$('#test')[0].click();
              }
          });
  }; 
  
  </script>
  <script src="//cdn.bootcss.com/highlight.js/8.5/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124">
  <link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel="icon">

  
  
  
  <link href="http://purplepalmdash.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Dash &middot; Dash" />

  <meta name="description" content="Get busy living, or get busy dying.">
  <meta name="keywords" content="unix,virtualization,embedded,linux">
  
  
</head>
<body class="theme-base-0c">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <img src="http://purplepalmdash.github.io/images/mylogo.jpeg" alt="gravatar">
      <h1><a href="http://purplepalmdash.github.io/">Get busy living, or get busy dying.</a></h1>
      <a href="http://purplepalmdash.github.io/"><p>Dash</p></a>
    </div>

    <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/">First Page</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/post/">All Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/linux/">Linux</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/embedded/">Embedded System</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/virtualization">Virtualization</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/purplepalmdash"><i class="fa fa-github-square fa-3x"></i></a>
      
      <a href="https://cn.linkedin.com/in/yang-feipeng-1b909319"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://plus.google.com/u/0/106572959364703833986"><i class="fa fa-google-plus-square fa-3x"></i></a>
      <a href="https://www.facebook.com/yang.feipeng"><i class="fa fa-facebook-square fa-3x"></i></a>
      <a href="https://twitter.com/dashwillfly"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      <a href="http://purplepalmdash.github.io/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
      </li>
    </ul>

    

  </div>
</div>


<div class="content container">
  <div class="posts">
    
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2016/11/06/climbingmaofengmountain/">ClimbingMaoFengMountain</a>
      </h1>
      <span class="post-date">Nov 6, 2016 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/life">Life</a>
        
      </span>
      
      <p>近期广州雾霾实在是有点醇厚，所以周末的第一选择当然是进山避霾啦！</p>

<p>今天定它个小目标，快速穿越帽峰山脉。</p>

<p>帽峰山是广州周边我非常喜欢的一座山，距市区有点距离(40公里？)，配套设施好、
人流量适中、植被茂密、空气清新。这一年多来去了好几次，每次都有新发现。今天
走的是一条穿越的线路，20公里，白山村-&gt;山顶-&gt;古庙出口。</p>

<p>早上游泳的缘故，出发得晚，11点多才开始走白山村道，果然没有雾霾，蓝天白云：</p>

<p><img src="/images/2016_11_06_20_39_56_1122x837.jpg" alt="/images/2016_11_06_20_39_56_1122x837.jpg" /></p>

<p>水厂后面的山峰郁郁葱葱，深山有好水:</p>

<p><img src="/images/2016_11_06_20_42_05_1124x841.jpg" alt="/images/2016_11_06_20_42_05_1124x841.jpg" /></p>

<p>沿途有村民营业的大量取水点，自备矿泉水桶过来装，2元/桶。拉回城应该随便就能卖到20
块一桶吧? 发家致富的路子，窝也只能指点到这了:</p>

<p><img src="/images/2016_11_06_20_43_50_801x596.jpg" alt="/images/2016_11_06_20_43_50_801x596.jpg" /></p>

<p>锄禾日当午, 要珍惜盘中餐啊，看下图，向我学习:</p>

<p><img src="/images/2016_11_06_20_46_38_1122x837.jpg" alt="/images/2016_11_06_20_46_38_1122x837.jpg" /></p>

<p>惭愧，走了一个小时就饿了，果断吃饭，考虑一会要在山里跑，吃素淡点就不点鱼了。喜欢
吃鱼的朋友到了帽峰山可以点鱼吃，铜锣湾水库水质不错，出品的鱼很美味:</p>

<p><img src="/images/2016_11_06_20_57_40_660x355.jpg" alt="/images/2016_11_06_20_57_40_660x355.jpg" /></p>

<p>这位一直围着桌子喵喵叫的小兄弟, 窝那么富有爱心当然不会忘了你:</p>

<p><img src="/images/2016_11_06_21_20_34_434x659.jpg" alt="/images/2016_11_06_21_20_34_434x659.jpg" /></p>

<p>山间风景:</p>

<p><img src="/images/2016_11_06_21_23_48_427x408.jpg" alt="/images/2016_11_06_21_23_48_427x408.jpg" /></p>

<p>15分钟到顶，开始沿着山脊往帽峰山顶广场穿行:</p>

<p><img src="/images/2016_11_06_21_26_07_973x721.jpg" alt="/images/2016_11_06_21_26_07_973x721.jpg" /></p>

<p>速度有点快，1小时不到抵达帽峰山顶广场:</p>

<p><img src="/images/2016_11_06_21_27_16_974x716.jpg" alt="/images/2016_11_06_21_27_16_974x716.jpg" /></p>

<p>山顶俯瞰林海, 空气没得说，怎样都是负氧离子饱和:</p>

<p><img src="/images/2016_11_06_21_27_57_975x726.jpg" alt="/images/2016_11_06_21_27_57_975x726.jpg" /></p>

<p>北国早已寒冷如咧，可这帽峰山里风景, 依然青翠如夏:</p>

<p><img src="/images/2016_11_06_21_31_29_522x516.jpg" alt="/images/2016_11_06_21_31_29_522x516.jpg" /></p>

<p>下午3点40,自古庙出口下到山底，结束愉快的帽峰山一日之旅。<br />
如此算来，从白山村到杨伙寮，经箫神顶到帽峰山顶景区后经古庙下山,可以在三个小时内完成。</p>

<p>压轴奉上帽峰山脉一景. Life is short, play more.</p>

<p><img src="/images/2016_11_06_21_35_42_1125x836.jpg" alt="/images/2016_11_06_21_35_42_1125x836.jpg" /></p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2016/11/05/%E4%B8%BAblog%E6%B7%BB%E5%8A%A0%E4%BF%9D%E5%AD%98%E4%B8%BA%E5%9B%BE%E7%89%87%E5%8A%9F%E8%83%BD/">为Blog添加保存为图片功能</a>
      </h1>
      <span class="post-date">Nov 5, 2016 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/linux">Linux</a>
        
      </span>
      
      

<h3 id="背景">背景</h3>

<p>众所周知疼讯其实一直是一个很封闭傻逼的企业，早年QZONE的代码就层层加密，
惟恐互联网爬虫爬到它上面取内容。进入到移动互联网时代，就更加变本加厉，盆友
圈里的诸多内容，恐怕诸位都是没办法弄出来的。</p>

<p>早年曾在Blog上添加过<code>分享到朋友圈</code>或<code>分享到微信好友</code>按钮，由于<code>github.io</code>未
被疼讯认可，共享出来的链接通常只有自己能看到，这又是一个拿用户当SB的典型
案例。</p>

<p>还好，对于用户上传图片，疼讯是没法限制的。所以有了以下的开发。</p>

<h3 id="功能参考">功能参考</h3>

<p>在博文里添加按钮<code>一键保存为图片</code>,即可将该篇文章生成为长图片。</p>

<p><img src="/images/2016_11_05_18_38_31_637x390.jpg" alt="/images/2016_11_05_18_38_31_637x390.jpg" /></p>

<p>参考设计： 锤子便签。顺便吐槽一下锤子便签，添加了关键词过滤，关键词嘛，这也是
党国拿来折腾屁民的一个傻逼玩意，例如有一首歌是这么唱的:</p>

<pre><code>我爱北京关键词，
关键词上太阳升。。
伟大得领袖关键词，
带领我们向前进…
</code></pre>

<p>╮〔╯ε╰〕╭   &mdash;太多的关键词，容易让写博文的人心情不好。</p>

<h3 id="可选方案">可选方案</h3>

<p>A. wkhtmltoimage.<br />
这个转换起来是全屏转换，所以最初想到的是对网页做再加工，抠取出其中含有内容的一部分。
好处是，真的是所见即所得。</p>

<pre><code>$ wkhtmltoimage http://www.google.com google.jpg
</code></pre>

<p>B. html2canvas.<br />
这种方案直接在html页面上做文章，添加按钮后直接用画布来生成对象。缺点是有些格式显示出来
有少量阴影。</p>

<p>暂时基于方案B实现。</p>

<h3 id="code">Code</h3>

<p>参考资料:<br />
<a href="https://www.youtube.com/watch?v=-d2FeFiBvEo">https://www.youtube.com/watch?v=-d2FeFiBvEo</a><br />
<a href="https://html2canvas.hertzen.com/">https://html2canvas.hertzen.com/</a></p>

<p>因为本博客基于hugo构建，直接修改hugo使用的主题即可添加html2canvas。</p>

<p>目录结构:</p>

<pre><code>$ ls  
config.toml  content  id_rsa.enc  scripts  static  themes
$ themes/hyde-a
$ ls
archetypes  images  layouts  LICENSE  README.md  static  theme.toml
</code></pre>

<p>下载<code>html2canvas.js</code>到主题的<code>static/js</code>目录:</p>

<pre><code>$ cd static/js
$ wget
https://github.com/niklasvh/html2canvas/releases/download/0.4.1/html2canvas.js
</code></pre>

<p>在主题的<code>./layouts/partials/head.html</code>文件中添加所需要的js文件及javascript代码
, (+代表新添加代码):</p>

<pre><code class="language-javascript">  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css&quot;&gt;
+  &lt;script type=&quot;text/javascript&quot; src=&quot;//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&quot;&gt;&lt;/script&gt;
+  &lt;script type=&quot;text/javascript&quot; src=&quot;/js/html2canvas.js&quot;&gt;&lt;/script&gt;
+  &lt;script type='text/javascript'&gt;//&lt;![CDATA[
+  function genPostShot() { 
+          var rightNow = new Date();
+          var imageName = rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,&quot;&quot;);
+          imageName += '.jpg'
+          html2canvas(document.getElementsByClassName('post'), {
+              onrendered: function(canvas) {
+  		// Click them for download
+          	$('#test').attr('href', canvas.toDataURL(&quot;image/jpeg&quot;));
+          	$('#test').attr('download',imageName);
+          	$('#test')[0].click();
+              }
+          });
+  }; 
+  //]]&gt;
+  &lt;/script&gt;
  &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js&quot;&gt;&lt;/script&gt;
</code></pre>

<p>简单解释一下这几行代码：<br />
1. 取当时UTC时间作为下载jpg文件名。<br />
2. 在当前页面中根据div的class名称找到<code>post</code>字段，构建一个画布。<br />
3. 将画布内容输出为jpeg文件，触发浏览器的一个下载动作。</p>

<p><strong>注意</strong>: <code>#test</code>为在html文件中添加的一个不可见链接.</p>

<p>接下来修改每个博文用到的模板文件(layourts/post/single.html):</p>

<pre><code>{{ partial &quot;head.html&quot; . }}
&lt;div class=&quot;content container&quot;&gt;
  &lt;div class=&quot;post&quot;&gt;
    &lt;h1&gt;{{ .Title }}&lt;/h1&gt;
+    &lt;p align=&quot;right&quot;&gt;
+    &lt;a href=&quot;javascript:genPostShot()&quot;&gt;
+	    TurnToJPG --&gt; &lt;i class=&quot;fa fa-camera-retro fa-2x&quot;&gt;&lt;/i&gt;
+    &lt;/a&gt;
+    &lt;a id=&quot;test&quot;&gt;&lt;/a&gt;
+    &lt;/p&gt;
+    &lt;hr&gt;
    &lt;span class=&quot;post-date&quot;&gt;{{ .Date.Format &quot;Jan 2, 2006&quot; }} {{ if .Site.DisqusShortname }} &amp;middot; &lt;a href=&quot;{{ .Permalink }}#disqus_thread&quot;&gt;Comments&lt;/a&gt;{{ end }}
</code></pre>

<p>简单解释一下上述添加的代码:</p>

<p>添加一个超链接，指向上文定义的javascript函数<code>genPostShot()</code>.</p>

<p>保存修改，提交到上游仓库，重新生成整个静态网站，现在每个博文里都含有保存图片按钮。</p>

<h3 id="效果">效果</h3>

<p>譬如，点击<a href="http://purplepalmdash.github.io/2013/11/17/run-in-winter/">http://purplepalmdash.github.io/2013/11/17/run-in-winter/</a></p>

<p>效果如下:</p>

<p><img src="/images/2016_11_05_18_56_04_638x402.jpg" alt="/images/2016_11_05_18_56_04_638x402.jpg" /></p>

<p>点击按钮，下载为文件201611051057.jpg(当前UTC时间戳），效果如下:</p>

<p><img src="/images/2016_11_05_18_58_11_250x375.jpg" alt="/images/2016_11_05_18_58_11_250x375.jpg" /></p>

<p>打完，收工，以后在盆友圈想怎么咆哮就可以怎么咆哮了。</p>

<h3 id="trouble-shooting">Trouble-Shooting</h3>

<p>之所以加这么个条目是因为，在未定义背景的网页里，有时候截出来的图是黑色背景的，修正：</p>

<p>修改<code>./static/js/html2canvas.js</code>文件:</p>

<pre><code>sTransparent = function(backgroundColor) {
  return (backgroundColor === &quot;transparent&quot; || backgroundColor === &quot;rgba(0, 0,
0, 0)&quot;);
};
</code></pre>

<p>改为:</p>

<pre><code>_html2canvas.Util.isTransparent = function(backgroundColor) {
  return (backgroundColor === &quot;transparent&quot; || backgroundColor === &quot;rgba(0, 0,
0, 0)&quot; || backgroundColor === undefined);
};
</code></pre>

<p>之后我们在<code>./layouts/partials/head.html</code>中，添加这一行:</p>

<pre><code>          html2canvas(document.getElementsByClassName('post'), {
+              background :'#FFFFFF',
              onrendered: function(canvas) {
</code></pre>

<p>现在生成的图片背景就是白色的了。</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2016/11/04/setuparegistryproxycachefordocker/">SetupARegistryProxyCacheForDocker</a>
      </h1>
      <span class="post-date">Nov 4, 2016 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/linux">Linux</a>
        
      </span>
      
      

<h3 id="准备">准备</h3>

<p>首先需要准备以下Docker image:</p>

<pre><code>$ sudo docker pull registry:latest
$ sudo docker pull registry:2
</code></pre>

<p>在<code>/etc/hosts</code>里加一条记录，接下来我们将用这条记录生成签名(注意修改IP地址和域名）:</p>

<pre><code># echo '192.168.0.121    xxx.xxx.xxx.com'&gt;&gt;/etc/hosts
</code></pre>

<p>准备所需要的自签名文件(用于tls连接)</p>

<pre><code>mkdir -p certs &amp;&amp; openssl req   -newkey rsa:4096 -nodes -sha256 -keyout
certs/domain.key   -x509 -days 365 -out certs/domain.crt
Generating a 4096 bit RSA private key
....................................................................................................++
......++
writing new private key to 'certs/domain.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Guangdong
Locality Name (eg, city) []:Guangzhou
Organization Name (eg, company) [Internet Widgits Pty Ltd]:DashCom
Organizational Unit Name (eg, section) []:IT
Common Name (e.g. server FQDN or YOUR name) []:xxx.xxx.xxx.com
Email Address []:xxxxxx@gmail.com
</code></pre>

<h3 id="启动容器">启动容器</h3>

<p>首先拷贝出默认的registry容器的配置文件:</p>

<pre><code>$ sudo mkdir -p /data
$ sudo chmod 777 -R /data
$ sudo docker run -it --rm --entrypoint cat registry:2 \
/etc/docker/registry/config.yml &gt; /data/config.yml
</code></pre>

<p>修改默认文件，添加<code>proxy</code>字段等，我的配置如下:</p>

<pre><code>version: 0.1
log:
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: :5000
  tls:
    certificate: /var/lib/registry/domain.crt
    key: /var/lib/registry/domain.key
  headers:
    X-Content-Type-Options: [nosniff]
proxy:
  remoteurl: https://registry-1.docker.io
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3
</code></pre>

<p>将上一步生成的<code>domain.crt</code>和<code>domain.key</code>文件也拷贝到/data文件夹下.</p>

<p>现在运行容器:</p>

<pre><code>$ sudo docker run -d --restart=always -p 5000:5000 --name v2-mirror  -v
/data:/var/lib/registry registry:2 /var/lib/registry/config.yml
</code></pre>

<p>运行完这条命令后，可以用<code>sudo netstat -anp| grep 5000</code>来检查registry服务是否被启动。</p>

<h3 id="使用registry服务">使用Registry服务</h3>

<p>在客户机上，需要做以下设置, 这里我写成脚本的方式，具体的调整需要根据实际情况:</p>

<pre><code>echo '192.168.0.121    xxx.xxx.xxx.com'&gt;&gt;/etc/hosts
apt-get install -y wget
mkdir -p /etc/docker/certs.d/xxx.xxx.xx.com:5000/
wget -O /etc/docker/certs.d/xxx.xxx.xxx.com:5000/ca.crt http://192.168.0.121/domain.crt
sed -i 's#fd://#fd:// --registry-mirror https://xxx.xxx.xxx.com:5000#' /lib/systemd/system/docker.service
systemctl daemon-reload
systemctl restart docker
</code></pre>

<p>这里的<code>http://192.168.0.121/domain.crt</code>是我把domain.crt文件放在一个web服务器上了，可以
直接拷贝现成的，改名即可。</p>

<p>现在测试：</p>

<pre><code># curl -I https://xxx.xxx.xxx.com:5000/v2 --cacert \ 
/etc/docker/certs.d/xxx.xxx.xxx.com\:5000/ca.crt 

HTTP/1.1 301 Moved Permanently
Docker-Distribution-Api-Version: registry/2.0
Location: /v2/
Date: Fri, 04 Nov 2016 09:42:41 GMT
Content-Type: text/plain; charset=utf-8
</code></pre>

<p>检查镜像:</p>

<pre><code># curl  https://xxx.xxx.xxx.com:5000/v2/_catalog --cacert \
/etc/docker/certs.d/xxx.xxx.xxx.com\:5000/ca.crt 
{&quot;&quot;:[&quot;&quot;]}
</code></pre>

<p>docker pull一个镜像:</p>

<pre><code># docker pull busybox:latest
</code></pre>

<p>现在检查:</p>

<pre><code># curl  https://xxx.xxx.xxx.com:5000/v2/_catalog --cacert \
/etc/docker/certs.d/xxx.xxx.xxx.com\:5000/ca.crt 
{&quot;repositories&quot;:[&quot;library/busybox&quot;,&quot;library/ubuntu&quot;]}
</code></pre>

<p>可以看到，library/busybox这个镜像已经被缓存在了本地registry仓库中。</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2016/11/03/dockerspeedup/">DockerSpeedUp</a>
      </h1>
      <span class="post-date">Nov 3, 2016 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/linux">Linux</a>
        
      </span>
      
      

<h3 id="docker-registry">Docker Registry</h3>

<p>因为众所周知的原因，在国内下载Docker镜像会很慢，所以我们更改docker的配置，让它使用
daocloud的加速服务:</p>

<p>ArchLinux下，编辑以下文件，或者你可以通过<code>sudo systemctl edit docker.service</code>来配置以下
文件:</p>

<pre><code># vim /etc/systemd/system/docker.service.d/override.conf 
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --registry-mirror=http://1a653205.m.daocloud.io -H fd://
</code></pre>

<p>现在重新加载服务并重新启动<code>docker.service</code>：</p>

<pre><code># systemctl daemon-reload
# systemctl restart docker.service
</code></pre>

<p>从此以后，每一次docker pull都会使用到daocloud提供的加速服务。</p>

<h3 id="本地私有registry">本地私有registry</h3>

<p>首先pull下来如下镜像(这两个其实是一个镜像):</p>

<pre><code># docker pull registry:latest
# docker pull registry:2
</code></pre>

<p>运行registry实例(注意更改volumn映射):</p>

<pre><code># docker run -d -p 5000:5000 --restart=always --name registry -v
/root/DockerRegistry:/var/lib/registry registry:2
</code></pre>

<p>检查实例运行情况:</p>

<pre><code>➜  ~ sudo docker ps
CONTAINER ID        IMAGE                            COMMAND                  CREATED
STATUS              PORTS                    NAMES
b16b27933709        registry:2                       &quot;/entrypoint.sh /etc/&quot;   7 hours
ago         Up 2 hours          0.0.0.0:5000-&gt;5000/tcp   registry
</code></pre>

<p>为了让这个服务每次都启动，我们来编写一个systemd服务:</p>

<pre><code># vim /usr/lib/systemd/system/DockerRegistry.service 
[Unit]
Description=DockerRegistry container
Requires=docker.service
After=docker.service

[Service]
Restart=always
ExecStart=/usr/bin/docker start -a registry
ExecStop=/usr/bin/docker stop -t 2 registry

[Install]
WantedBy=multi-user.target
</code></pre>

<p>现在使能该服务:</p>

<pre><code># systemctl enable DockerRegistry.service
Created symlink /etc/systemd/system/multi-user.target.wants/DockerRegistry.service →
/usr/lib/systemd/system/DockerRegistry.service.
</code></pre>

<h3 id="本地私有registry使用方法">本地私有Registry使用方法</h3>

<p>将获取到的image tag到私有registry(tag):</p>

<pre><code># docker tag ubuntu:16.04 localhost:5000/ubuntu:16.04
</code></pre>

<p>将获取到的image push到私有registry(push):</p>

<pre><code># docker push localhost:5000/ubuntu:16.04
</code></pre>

<h3 id="在agent机器上启用本地registry仓库">在agent机器上启用本地registry仓库</h3>

<p>在systemd类型的机器上，例如Ubuntu16.04上，使用以下命令，添加<code>192.168.177.11:5000</code>这个私有仓库：</p>

<pre><code># sed -i 's#fd://#fd:// --registry-mirror http://192.168.177.11:5000
--insecure-registry 192.168.177.11:5000#' /lib/systemd/system/docker.service
# systemctl daemon-reload
# systemctl restart docker
</code></pre>

<p>添加完毕后，检查docker运行参数:</p>

<pre><code># ps -ef | grep docker
root      4253     1  2 21:48 ?        00:00:00 /usr/bin/dockerd -H fd://
--registry-mirror http://192.168.177.11:5000 --insecure-registry
192.168.177.11:5000
root      4260  4253  0 21:48 ?        00:00:00 docker-containerd -l
unix:///var/run/docker/libcontainerd/docker-containerd.sock --shim
docker-containerd-shim --metrics-interval=0 --start-timeout 2m --state-dir
/var/run/docker/libcontainerd/containerd --runtime docker-runc
</code></pre>

<p>pull一个已经被放入仓库里的镜像，速度非常快:</p>

<pre><code># docker pull 192.168.177.11:5000/fedora:latest
latest: Pulling from fedora
41b563eedcb0: Pull complete 
Digest:
sha256:cc4323bf2ee99b414600605e42d1888c4c1b0a08f5793a379c1238af4a44315d
Status: Downloaded newer image for 192.168.177.11:5000/fedora:latest
</code></pre>

<p>检查安装的镜像:</p>

<pre><code>$ sudo docker run -it 192.168.177.11:5000/fedora /bin/bash
[root@810f44567c87 /]# cat /etc/redhat-release 
Fedora release 24 (Twenty Four)
</code></pre>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://purplepalmdash.github.io/blog/2016/10/24/vrmonitoringviacollectd/">VRMonitoringViaCollectd</a>
      </h1>
      <span class="post-date">Oct 24, 2016 
      
      <br/>
      <a class="a_cat" href="http://purplepalmdash.github.io/categories/linux">Linux</a>
        
      </span>
      
      

<h3 id="environment">Environment</h3>

<p>The VR&rsquo;s information is listed as following:</p>

<p><img src="/images/2016_10_24_16_35_58_501x547.jpg" alt="/images/2016_10_24_16_35_58_501x547.jpg" /><br />
Now login the VR in CloudStack Agent Node via:</p>

<pre><code># ssh -i /root/.ssh/id_rsa.cloud -p3922 169.254.0.129
</code></pre>

<p>Modify its <code>/etc/apt/sources.list</code> like following:</p>

<pre><code># cat /etc/apt/sources.list
# 

# deb cdrom:[Debian GNU/Linux 7.8.0 _Wheezy_ - Official amd64 NETINST Binary-1
20150110-14:41]/ wheezy main

#deb cdrom:[Debian GNU/Linux 7.8.0 _Wheezy_ - Official amd64 NETINST Binary-1
20150110-14:41]/ wheezy main


deb http://mirrors.aliyun.com/debian wheezy main
deb-src http://mirrors.aliyun.com/debian wheezy main

deb http://mirrors.aliyun.com/ wheezy/updates main
deb-src http://mirrors.aliyun.com/ wheezy/updates main

# wheezy-updates, previously known as 'volatile'
deb http://mirrors.aliyun.com/debian wheezy-updates main
deb-src http://mirrors.aliyun.com/debian wheezy-updates main
deb http://mirrors.aliyun.com/debian/ wheezy-backports main
</code></pre>

<p>Then <code>apt-get update &amp;&amp; apt-get install -y collectd</code>, for installing collectd.</p>

<h3 id="collectd">Collectd</h3>

<p>Configuration of collectd:</p>

<pre><code>$ touch /var/log/collectd.log
$ vim /etc/collectd/collectd.conf
Hostname &quot;WeiLan&quot;
LoadPlugin logfile
#LoadPlugin syslog

&lt;Plugin logfile&gt;
	LogLevel &quot;info&quot;
	File &quot;/var/log/collectd.log&quot;
	Timestamp true
	PrintSeverity false
&lt;/Plugin&gt;

#&lt;Plugin syslog&gt;
#	LogLevel info
#&lt;/Plugin&gt;

..... 

LoadPlugin conntrack
LoadPlugin uptime 
#LoadPlugin df
LoadPlugin write_graphite

&lt;Plugin write_graphite&gt;
	&lt;Carbon&gt;
		Host &quot;192.168.1.79&quot;
		Port &quot;2003&quot;
		Prefix &quot;collectd&quot;
		Postfix &quot;collectd&quot;
		StoreRates false
		AlwaysAppendDS false
		EscapeCharacter &quot;_&quot;
	&lt;/Carbon&gt;
&lt;/Plugin&gt;

</code></pre>

<p>Start the collectd service via:</p>

<pre><code># service collectd restart
</code></pre>

      
    </div>
    
    

<ul class="pagination">
    
    <li>
        <a href="/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
    </li>
    
    <li
    >
    <a href="/page/20/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
    </li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/">1</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/2/">2</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/3/">3</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="disabled"><span aria-hidden="true">&hellip;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/20/">20</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    class="active"><a href="/page/21/">21</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/22/">22</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="disabled"><span aria-hidden="true">&hellip;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/page/153/">153</a></li>
    
    
    <li
    >
    <a href="/page/22/" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
    </li>
    
    <li>
        <a href="/page/153/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
    </li>
    
</ul>

  </div>
</div>


<script src="http://purplepalmdash.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

